<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › cris › arch-v10 › drivers › eeprom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>eeprom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*!*****************************************************************************</span>
<span class="cm">*!</span>
<span class="cm">*!  Implements an interface for i2c compatible eeproms to run under Linux.</span>
<span class="cm">*!  Supports 2k, 8k(?) and 16k. Uses adaptive timing adjustments by</span>
<span class="cm">*!  Johan.Adolfsson@axis.com</span>
<span class="cm">*!</span>
<span class="cm">*!  Probing results:</span>
<span class="cm">*!    8k or not is detected (the assumes 2k or 16k)</span>
<span class="cm">*!    2k or 16k detected using test reads and writes.</span>
<span class="cm">*!</span>
<span class="cm">*!------------------------------------------------------------------------</span>
<span class="cm">*!  HISTORY</span>
<span class="cm">*!</span>
<span class="cm">*!  DATE          NAME              CHANGES</span>
<span class="cm">*!  ----          ----              -------</span>
<span class="cm">*!  Aug  28 1999  Edgar Iglesias    Initial Version</span>
<span class="cm">*!  Aug  31 1999  Edgar Iglesias    Allow simultaneous users.</span>
<span class="cm">*!  Sep  03 1999  Edgar Iglesias    Updated probe.</span>
<span class="cm">*!  Sep  03 1999  Edgar Iglesias    Added bail-out stuff if we get interrupted</span>
<span class="cm">*!                                  in the spin-lock.</span>
<span class="cm">*!</span>
<span class="cm">*!        (c) 1999 Axis Communications AB, Lund, Sweden</span>
<span class="cm">*!*****************************************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &quot;i2c.h&quot;</span>

<span class="cp">#define D(x)</span>

<span class="cm">/* If we should use adaptive timing or not: */</span>
<span class="cm">/* #define EEPROM_ADAPTIVE_TIMING */</span>

<span class="cp">#define EEPROM_MAJOR_NR 122  </span><span class="cm">/* use a LOCAL/EXPERIMENTAL major for now */</span><span class="cp"></span>
<span class="cp">#define EEPROM_MINOR_NR 0</span>

<span class="cm">/* Empirical sane initial value of the delay, the value will be adapted to</span>
<span class="cm"> * what the chip needs when using EEPROM_ADAPTIVE_TIMING.</span>
<span class="cm"> */</span>
<span class="cp">#define INITIAL_WRITEDELAY_US 4000</span>
<span class="cp">#define MAX_WRITEDELAY_US 10000 </span><span class="cm">/* 10 ms according to spec for 2KB EEPROM */</span><span class="cp"></span>

<span class="cm">/* This one defines how many times to try when eeprom fails. */</span>
<span class="cp">#define EEPROM_RETRIES 10</span>

<span class="cp">#define EEPROM_2KB (2 * 1024)</span>
<span class="cm">/*#define EEPROM_4KB (4 * 1024)*/</span> <span class="cm">/* Exists but not used in Axis products */</span>
<span class="cp">#define EEPROM_8KB (8 * 1024 - 1 ) </span><span class="cm">/* Last byte has write protection bit */</span><span class="cp"></span>
<span class="cp">#define EEPROM_16KB (16 * 1024)</span>

<span class="cp">#define i2c_delay(x) udelay(x)</span>

<span class="cm">/*</span>
<span class="cm"> *  This structure describes the attached eeprom chip.</span>
<span class="cm"> *  The values are probed for.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">eeprom_type</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sequential_write_pagesize</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">select_cmd</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usec_delay_writecycles</span><span class="p">;</span> <span class="cm">/* Min time between write cycles</span>
<span class="cm">					   (up to 10ms for some models) */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usec_delay_step</span><span class="p">;</span> <span class="cm">/* For adaptive algorithm */</span>
  <span class="kt">int</span> <span class="n">adapt_state</span><span class="p">;</span> <span class="cm">/* 1 = To high , 0 = Even, -1 = To low */</span>
  
  <span class="cm">/* this one is to keep the read/write operations atomic */</span>
  <span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">retry_cnt_addr</span><span class="p">;</span> <span class="cm">/* Used to keep track of number of retries for</span>
<span class="cm">                         adaptive timing adjustments */</span>
  <span class="kt">int</span> <span class="n">retry_cnt_read</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">eeprom_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="n">loff_t</span>  <span class="n">eeprom_lseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orig</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="n">eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
                            <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span>  <span class="n">eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
                             <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eeprom_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">eeprom_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">read_from_eeprom</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eeprom_write_buf</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eeprom_read_buf</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">eeprom_disable_write_protect</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">eeprom_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;eeprom&quot;</span><span class="p">;</span>

<span class="cm">/* chip description */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">eeprom_type</span> <span class="n">eeprom</span><span class="p">;</span>

<span class="cm">/* This is the exported file-operations structure for this device. */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">eeprom_fops</span> <span class="o">=</span>
<span class="p">{</span>
  <span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">eeprom_lseek</span><span class="p">,</span>
  <span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">eeprom_read</span><span class="p">,</span>
  <span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">eeprom_write</span><span class="p">,</span>
  <span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">eeprom_open</span><span class="p">,</span>
  <span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">eeprom_close</span>
<span class="p">};</span>

<span class="cm">/* eeprom init call. Probes for different eeprom models. */</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">eeprom_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ETRAX_I2C_EEPROM_PROBE</span>
<span class="cp">#define EETEXT &quot;Found&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define EETEXT &quot;Assuming&quot;</span>
<span class="cp">#endif</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">register_chrdev</span><span class="p">(</span><span class="n">EEPROM_MAJOR_NR</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom_fops</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: unable to get major %d for eeprom device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">eeprom_name</span><span class="p">,</span> <span class="n">EEPROM_MAJOR_NR</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;EEPROM char device v0.3, (c) 2000 Axis Communications AB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   *  Note: Most of this probing method was taken from the printserver (5470e)</span>
<span class="cm">   *        codebase. It did not contain a way of finding the 16kB chips</span>
<span class="cm">   *        (M24128 or variants). The method used here might not work</span>
<span class="cm">   *        for all models. If you encounter problems the easiest way</span>
<span class="cm">   *        is probably to define your model within #ifdef&#39;s, and hard-</span>
<span class="cm">   *        code it.</span>
<span class="cm">   */</span>

  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">=</span> <span class="n">INITIAL_WRITEDELAY_US</span><span class="p">;</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
<span class="cp">#ifdef CONFIG_ETRAX_I2C_EEPROM_PROBE</span>
  <span class="n">i2c_start</span><span class="p">();</span>
  <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
  <span class="p">{</span>
    <span class="cm">/* It&#39;s not 8k.. */</span>
    <span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf_2k_start</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    
    <span class="cm">/* Im not sure this will work... :) */</span>
    <span class="cm">/* assume 2kB, if failure go for 16kB */</span>
    <span class="cm">/* Test with 16kB settings.. */</span>
    <span class="cm">/* If it&#39;s a 2kB EEPROM and we address it outside it&#39;s range</span>
<span class="cm">     * it will mirror the address space:</span>
<span class="cm">     * 1. We read two locations (that are mirrored), </span>
<span class="cm">     *    if the content differs * it&#39;s a 16kB EEPROM.</span>
<span class="cm">     * 2. if it doesn&#39;t differ - write different value to one of the locations,</span>
<span class="cm">     *    check the other - if content still is the same it&#39;s a 2k EEPROM,</span>
<span class="cm">     *    restore original data.</span>
<span class="cm">     */</span>
<span class="cp">#define LOC1 8</span>
<span class="cp">#define LOC2 (0x1fb) </span><span class="cm">/*1fb, 3ed, 5df, 7d1 */</span><span class="cp"></span>

   <span class="cm">/* 2k settings */</span>  
    <span class="n">i2c_stop</span><span class="p">();</span>
    <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
    <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>   
    <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_read_buf</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_2k_start</span><span class="p">,</span> <span class="mi">16</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">16</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;2k start: &#39;%16.16s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf_2k_start</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Failed to read in 2k mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>  
    <span class="p">}</span>
    
    <span class="cm">/* 16k settings */</span>
    <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_16KB</span><span class="p">;</span>
    <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>   
    <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">loc1</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">loc2</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_read_buf</span><span class="p">(</span><span class="n">LOC2</span><span class="p">,</span> <span class="n">loc2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_read_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;0 loc1: (%i) &#39;%4.4s&#39; loc2 (%i) &#39;%4.4s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                   <span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">LOC2</span><span class="p">,</span> <span class="n">loc2</span><span class="p">));</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">          if (memcmp(loc1, loc2, 4) != 0 )</span>
<span class="c">          {</span>
<span class="c">            /* It&#39;s 16k */</span>
<span class="c">            printk(KERN_INFO &quot;%s: 16k detected in step 1\n&quot;, eeprom_name);</span>
<span class="c">            eeprom.size = EEPROM_16KB;     </span>
<span class="c">            success = 1;</span>
<span class="c">          }</span>
<span class="c">          else</span>
<span class="cp">#endif</span>
          <span class="p">{</span>
            <span class="cm">/* Do step 2 check */</span>
            <span class="cm">/* Invert value */</span>
            <span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eeprom_write_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="cm">/* If 2k EEPROM this write will actually write 10 bytes</span>
<span class="cm">               * from pos 0</span>
<span class="cm">               */</span>
              <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;1 loc1: (%i) &#39;%4.4s&#39; loc2 (%i) &#39;%4.4s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                       <span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">LOC2</span><span class="p">,</span> <span class="n">loc2</span><span class="p">));</span>
              <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_read_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;2 loc1: (%i) &#39;%4.4s&#39; tmp &#39;%4.4s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                         <span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: read and write differs! Not 16kB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                         <span class="n">eeprom_name</span><span class="p">);</span>
                  <span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                  
                  <span class="k">if</span> <span class="p">(</span><span class="n">eeprom_write_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                  <span class="p">{</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">else</span>
                  <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Restore 2k failed during probe,&quot;</span>
                           <span class="s">&quot; EEPROM might be corrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
                    
                  <span class="p">}</span>
                  <span class="n">i2c_stop</span><span class="p">();</span>
                  <span class="cm">/* Go to 2k mode and write original data */</span>
                  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
                  <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>   
                  <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
                  <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_write_buf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf_2k_start</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
                  <span class="p">{</span>
                  <span class="p">}</span>
                  <span class="k">else</span>
                  <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Failed to write back 2k start!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">eeprom_name</span><span class="p">);</span>
                  <span class="p">}</span>
                  
                  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
                <span class="p">}</span>
              <span class="p">}</span>
                
              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
              <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">eeprom_read_buf</span><span class="p">(</span><span class="n">LOC2</span><span class="p">,</span> <span class="n">loc2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;0 loc1: (%i) &#39;%4.4s&#39; loc2 (%i) &#39;%4.4s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                           <span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="n">LOC2</span><span class="p">,</span> <span class="n">loc2</span><span class="p">));</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">loc1</span><span class="p">,</span> <span class="n">loc2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
                  <span class="p">{</span>
                    <span class="cm">/* Data the same, must be mirrored -&gt; 2k */</span>
                    <span class="cm">/* Restore data */</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: 2k detected in step 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
                    <span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">eeprom_write_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">{</span>
                      <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Restore 2k failed during probe,&quot;</span>
                             <span class="s">&quot; EEPROM might be corrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
                      
                    <span class="p">}</span>
                    
                    <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>     
                  <span class="p">}</span>
                  <span class="k">else</span>
                  <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: 16k detected in step 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">eeprom_name</span><span class="p">);</span>
                    <span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">loc1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                    <span class="cm">/* Data differs, assume 16k */</span>
                    <span class="cm">/* Restore data */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">eeprom_write_buf</span><span class="p">(</span><span class="n">LOC1</span><span class="p">,</span> <span class="n">loc1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">{</span>
                      <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                      <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Restore 16k failed during probe,&quot;</span>
                             <span class="s">&quot; EEPROM might be corrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
                    <span class="p">}</span>
                    
                    <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_16KB</span><span class="p">;</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="cm">/* read LOC1 */</span>
        <span class="p">}</span> <span class="cm">/* address LOC1 */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Probing failed!, using 2KB!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
          <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>               
        <span class="p">}</span>
      <span class="p">}</span> <span class="cm">/* read */</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="cm">/* No 8k */</span>
      <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">i2c_start</span><span class="p">();</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x81</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/* It&#39;s a 8kB */</span>
        <span class="n">i2c_inbyte</span><span class="p">();</span>
        <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_8KB</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">i2c_stop</span><span class="p">();</span>
<span class="cp">#elif defined(CONFIG_ETRAX_I2C_EEPROM_16KB)</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_16KB</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_ETRAX_I2C_EEPROM_8KB)</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_8KB</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_ETRAX_I2C_EEPROM_2KB)</span>
  <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">EEPROM_2KB</span><span class="p">;</span>
<span class="cp">#endif</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="k">case</span> <span class="p">(</span><span class="n">EEPROM_2KB</span><span class="p">)</span>:
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span> <span class="n">EETEXT</span> <span class="s">&quot; i2c compatible 2kB eeprom.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="p">(</span><span class="n">EEPROM_8KB</span><span class="p">)</span>:
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span> <span class="n">EETEXT</span> <span class="s">&quot; i2c compatible 8kB eeprom.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="p">(</span><span class="n">EEPROM_16KB</span><span class="p">)</span>:
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: &quot;</span> <span class="n">EETEXT</span> <span class="s">&quot; i2c compatible 16kB eeprom.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">=</span> <span class="mh">0xA0</span><span class="p">;</span>     
     <span class="k">break</span><span class="p">;</span>
   <span class="nl">default:</span>
     <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Did not find a supported eeprom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
     <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  

  <span class="n">eeprom_disable_write_protect</span><span class="p">();</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Opens the device. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EEPROM_MINOR_NR</span><span class="p">)</span>
     <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">imajor</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EEPROM_MAJOR_NR</span><span class="p">)</span>
     <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* OK */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* No EEprom found */</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Changes the current file position. */</span>

<span class="k">static</span> <span class="n">loff_t</span> <span class="nf">eeprom_lseek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">orig</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> *  orig 0: position from begning of eeprom</span>
<span class="cm"> *  orig 1: relative from current position</span>
<span class="cm"> *  orig 2: position from last eeprom address</span>
<span class="cm"> */</span>
  
  <span class="k">switch</span> <span class="p">(</span><span class="n">orig</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="k">case</span> <span class="mi">0</span>:
     <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="mi">1</span>:
     <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
   <span class="k">case</span> <span class="mi">2</span>:
     <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
     <span class="k">break</span><span class="p">;</span>
   <span class="nl">default:</span>
     <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* truncate position */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">&gt;=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Reads data from eeprom. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_read_buf</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">eeprom_read</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/* Reads data from eeprom. */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">read</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>

  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">page</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>  <span class="cm">/* Address i 0 - (size-1) */</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

  <span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
  
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">eeprom_address</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Read failed to address the eeprom: &quot;</span>
           <span class="s">&quot;0x%08X (%i) page: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
    <span class="n">i2c_stop</span><span class="p">();</span>
    
    <span class="cm">/* don&#39;t forget to wake them up */</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* truncate count */</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* stop dummy write op and initiate the read op */</span>
  <span class="n">i2c_start</span><span class="p">();</span>

  <span class="cm">/* special case for small eeproms */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">EEPROM_16KB</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* go on with the actual read */</span>
  <span class="n">read</span> <span class="o">=</span> <span class="n">read_from_eeprom</span><span class="p">(</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="n">off</span> <span class="o">+=</span> <span class="n">read</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Writes data to eeprom. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_write_buf</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">eeprom_write</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Writes data to eeprom. */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">eeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
                            <span class="n">loff_t</span> <span class="o">*</span><span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">written</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* bail out if we get interrupted */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_RETRIES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">restart</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>
   
    
    <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">written</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="cm">/* address the eeprom */</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">eeprom_address</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Write failed to address the eeprom: &quot;</span>
               <span class="s">&quot;0x%08X (%i) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
        <span class="n">i2c_stop</span><span class="p">();</span>
        
        <span class="cm">/* don&#39;t forget to wake them up */</span>
        <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#ifdef EEPROM_ADAPTIVE_TIMING      </span>
      <span class="cm">/* Adaptive algorithm to adjust timing */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">retry_cnt_addr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="cm">/* To Low now */</span>
        <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;D=%i d=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">++</span><span class="p">;</span>
          <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">+=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/* To Low before */</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">+=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="cm">/* To High before (toggle dir) */</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">+=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
              <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">--</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="cm">/* To High (or good) now */</span>
        <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;D=%i d=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">));</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* To High before */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">--</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">&gt;</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">-=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/* To Low before (toggle dir) */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">&gt;</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span> <span class="o">-=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
          <span class="p">{</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">--</span><span class="p">;</span>
          <span class="p">}</span>
          
          <span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">eeprom</span><span class="p">.</span><span class="n">adapt_state</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
          <span class="cm">/* Restart adaption */</span>
          <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;#Restart</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
          <span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_step</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* EEPROM_ADAPTIVE_TIMING */</span><span class="cp"></span>
      <span class="cm">/* write until we hit a page boundary or count */</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">i2c_outbyte</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">written</span><span class="p">]);</span>        
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
        <span class="p">{</span>
          <span class="n">restart</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: write error, retrying. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
          <span class="n">i2c_stop</span><span class="p">();</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">written</span><span class="o">++</span><span class="p">;</span>
        <span class="n">p</span><span class="o">++</span><span class="p">;</span>        
      <span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">written</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="n">p</span> <span class="o">%</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">sequential_write_pagesize</span> <span class="p">));</span>

      <span class="cm">/* end write cycle */</span>
      <span class="n">i2c_stop</span><span class="p">();</span>
      <span class="n">i2c_delay</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">usec_delay_writecycles</span><span class="p">);</span>
    <span class="p">}</span> <span class="cm">/* while */</span>
  <span class="p">}</span> <span class="cm">/* for  */</span>

  <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">written</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">){</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">off</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">written</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Closes the device. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span> <span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* do nothing for now */</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets the current address of the eeprom. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">eeprom_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

  <span class="n">page</span>   <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
  <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>  <span class="n">addr</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* start a dummy write for addressing */</span>
    <span class="n">i2c_start</span><span class="p">();</span>

    <span class="k">if</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">EEPROM_16KB</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="p">);</span> 
      <span class="n">i2c_getack</span><span class="p">();</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span><span class="n">page</span><span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">page</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">);</span> 
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="cm">/* retry */</span>
      <span class="n">i2c_stop</span><span class="p">();</span>
      <span class="cm">/* Must have a delay here.. 500 works, &gt;50, 100-&gt;works 5th time*/</span>
      <span class="n">i2c_delay</span><span class="p">(</span><span class="n">MAX_WRITEDELAY_US</span> <span class="o">/</span> <span class="n">EEPROM_RETRIES</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
      <span class="cm">/* The chip needs up to 10 ms from write stop to next start */</span>
     
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
      
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
      <span class="p">{</span>
        <span class="cm">/* retry */</span>
        <span class="n">i2c_stop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">else</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>    

  
  <span class="n">eeprom</span><span class="p">.</span><span class="n">retry_cnt_addr</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">retry_cnt_addr</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">retry_cnt_addr</span> <span class="o">==</span> <span class="n">EEPROM_RETRIES</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* failed */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reads from current address. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_from_eeprom</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>    
    <span class="k">if</span><span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">EEPROM_16KB</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">i2c_outbyte</span><span class="p">(</span> <span class="n">eeprom</span><span class="p">.</span><span class="n">select_cmd</span> <span class="o">|</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">EEPROM_RETRIES</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: failed to read from eeprom</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom_name</span><span class="p">);</span>
    <span class="n">i2c_stop</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">))</span>
  <span class="p">{</span>    
    <span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">i2c_inbyte</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">read</span><span class="o">++</span><span class="p">]))</span>
    <span class="p">{</span>
      <span class="n">i2c_stop</span><span class="p">();</span>

      <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     *  make sure we don&#39;t ack last byte or you will get very strange</span>
<span class="cm">     *  results!</span>
<span class="cm">     */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">i2c_sendack</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* stop the operation */</span>
  <span class="n">i2c_stop</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disables write protection if applicable. */</span>

<span class="cp">#define DBP_SAVE(x)</span>
<span class="cp">#define ax_printf printk</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">eeprom_disable_write_protect</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Disable write protect */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">EEPROM_8KB</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="cm">/* Step 1 Set WEL = 1 (write 00000010 to address 1FFFh */</span>
    <span class="n">i2c_start</span><span class="p">();</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x02</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_stop</span><span class="p">();</span>

    <span class="n">i2c_delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

    <span class="cm">/* Step 2 Set RWEL = 1 (write 00000110 to address 1FFFh */</span>
    <span class="n">i2c_start</span><span class="p">();</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 55</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 52</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x06</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 53</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_stop</span><span class="p">();</span>
    
    <span class="cm">/* Step 3 Set BP1, BP0, and/or WPEN bits (write 00000110 to address 1FFFh */</span>
    <span class="n">i2c_start</span><span class="p">();</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xbe</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 56</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 57</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_outbyte</span><span class="p">(</span><span class="mh">0x06</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">i2c_getack</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">DBP_SAVE</span><span class="p">(</span><span class="n">ax_printf</span><span class="p">(</span><span class="s">&quot;Get ack returns false 58</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">i2c_stop</span><span class="p">();</span>
    
    <span class="cm">/* Write protect disabled */</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">eeprom_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
