<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › cris › include › arch-v32 › arch › uaccess.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>uaccess.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Authors:    Hans-Peter Nilsson (hp@axis.com)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _CRIS_ARCH_UACCESS_H</span>
<span class="cp">#define _CRIS_ARCH_UACCESS_H</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t tell gcc that we are accessing memory, but this is OK</span>
<span class="cm"> * because we do not write to any memory gcc knows about, so there</span>
<span class="cm"> * are no aliasing issues.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that PC at a fault is the address *at* the faulting</span>
<span class="cm"> * instruction for CRISv32.</span>
<span class="cm"> */</span>
<span class="cp">#define __put_user_asm(x, addr, err, op)			\</span>
<span class="cp">	__asm__ __volatile__(					\</span>
<span class="cp">		&quot;2:	&quot;op&quot; %1,[%2]\n&quot;				\</span>
<span class="cp">		&quot;4:\n&quot;						\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;		\</span>
<span class="cp">		&quot;3:	move.d %3,%0\n&quot;				\</span>
<span class="cp">		&quot;	jump 4b\n&quot;				\</span>
<span class="cp">		&quot;	nop\n&quot;					\</span>
<span class="cp">		&quot;	.previous\n&quot;				\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;		\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;				\</span>
<span class="cp">		&quot;	.previous\n&quot;				\</span>
<span class="cp">		: &quot;=r&quot; (err)					\</span>
<span class="cp">		: &quot;r&quot; (x), &quot;r&quot; (addr), &quot;g&quot; (-EFAULT), &quot;0&quot; (err))</span>

<span class="cp">#define __put_user_asm_64(x, addr, err) do {			\</span>
<span class="cp">	int dummy_for_put_user_asm_64_;				\</span>
<span class="cp">	__asm__ __volatile__(					\</span>
<span class="cp">		&quot;2:	move.d %M2,[%1+]\n&quot;			\</span>
<span class="cp">		&quot;4:	move.d %H2,[%1]\n&quot;			\</span>
<span class="cp">		&quot;5:\n&quot;						\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;		\</span>
<span class="cp">		&quot;3:	move.d %4,%0\n&quot;				\</span>
<span class="cp">		&quot;	jump 5b\n&quot;				\</span>
<span class="cp">		&quot;	.previous\n&quot;				\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;		\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;				\</span>
<span class="cp">		&quot;	.dword 4b,3b\n&quot;				\</span>
<span class="cp">		&quot;	.previous\n&quot;				\</span>
<span class="cp">		: &quot;=r&quot; (err), &quot;=b&quot; (dummy_for_put_user_asm_64_)	\</span>
<span class="cp">		: &quot;r&quot; (x), &quot;1&quot; (addr), &quot;g&quot; (-EFAULT),		\</span>
<span class="cp">		  &quot;0&quot; (err));					\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/* See comment before __put_user_asm.  */</span>

<span class="cp">#define __get_user_asm(x, addr, err, op)		\</span>
<span class="cp">	__asm__ __volatile__(				\</span>
<span class="cp">		&quot;2:	&quot;op&quot; [%2],%1\n&quot;			\</span>
<span class="cp">		&quot;4:\n&quot;					\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;	\</span>
<span class="cp">		&quot;3:	move.d %3,%0\n&quot;			\</span>
<span class="cp">		&quot;	jump 4b\n&quot;			\</span>
<span class="cp">		&quot;	moveq 0,%1\n&quot;			\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;	\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;			\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		: &quot;=r&quot; (err), &quot;=r&quot; (x)			\</span>
<span class="cp">		: &quot;r&quot; (addr), &quot;g&quot; (-EFAULT), &quot;0&quot; (err))</span>

<span class="cp">#define __get_user_asm_64(x, addr, err) do {		\</span>
<span class="cp">	int dummy_for_get_user_asm_64_;			\</span>
<span class="cp">	__asm__ __volatile__(				\</span>
<span class="cp">		&quot;2:	move.d [%2+],%M1\n&quot;		\</span>
<span class="cp">		&quot;4:	move.d [%2],%H1\n&quot;		\</span>
<span class="cp">		&quot;5:\n&quot;					\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;	\</span>
<span class="cp">		&quot;3:	move.d %4,%0\n&quot;			\</span>
<span class="cp">		&quot;	jump 5b\n&quot;			\</span>
<span class="cp">		&quot;	moveq 0,%1\n&quot;			\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;	\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;			\</span>
<span class="cp">		&quot;	.dword 4b,3b\n&quot;			\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		: &quot;=r&quot; (err), &quot;=r&quot; (x),			\</span>
<span class="cp">		  &quot;=b&quot; (dummy_for_get_user_asm_64_)	\</span>
<span class="cp">		: &quot;2&quot; (addr), &quot;g&quot; (-EFAULT), &quot;0&quot; (err));\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Copy a null terminated string from userspace.</span>
<span class="cm"> *</span>
<span class="cm"> * Must return:</span>
<span class="cm"> * -EFAULT		for an exception</span>
<span class="cm"> * count		if we hit the buffer limit</span>
<span class="cm"> * bytes copied		if we hit a null byte</span>
<span class="cm"> * (without the null byte)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">__do_strncpy_from_user</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Currently, in 2.4.0-test9, most ports use a simple byte-copy loop.</span>
<span class="cm">	 *  So do we.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  This code is deduced from:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	char tmp2;</span>
<span class="cm">	 *	long tmp1, tmp3;</span>
<span class="cm">	 *	tmp1 = count;</span>
<span class="cm">	 *	while ((*dst++ = (tmp2 = *src++)) != 0</span>
<span class="cm">	 *	       &amp;&amp; --tmp1)</span>
<span class="cm">	 *	  ;</span>
<span class="cm">	 *</span>
<span class="cm">	 *	res = count - tmp1;</span>
<span class="cm">	 *</span>
<span class="cm">	 *  with tweaks.</span>
<span class="cm">	 */</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;	move.d %3,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:	move.b [%2+],$acr</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:	beq 6f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	move.b $acr,[%1+]</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;	subq 1,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	bne 1b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	move.b [%2+],$acr</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;6:	sub.d %3,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	neg.d %0,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	move.d %7,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	jump 3b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	nop</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="cm">/* The address for a fault at the first move is trivial.</span>
<span class="cm">		   The address for a fault at the second move is that of</span>
<span class="cm">		   the preceding branch insn, since the move insn is in</span>
<span class="cm">		   its delay-slot.  Just so you don&#39;t get confused...  */</span>
		<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.dword 5b,4b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.dword 2b,4b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.previous&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;=b&quot;</span> <span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="s">&quot;=b&quot;</span> <span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;3&quot;</span> <span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="s">&quot;2&quot;</span> <span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s">&quot;g&quot;</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;acr&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* A few copy asms to build up the more complex ones from.</span>

<span class="cm">   Note again, a post-increment is performed regardless of whether a bus</span>
<span class="cm">   fault occurred in that instruction, and PC for a faulted insn is the</span>
<span class="cm">   address for the insn, or for the preceding branch when in a delay-slot.  */</span>

<span class="cp">#define __asm_copy_user_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;1:\n&quot;					\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;	\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;	\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		: &quot;=b&quot; (to), &quot;=b&quot; (from), &quot;=r&quot; (ret)	\</span>
<span class="cp">		: &quot;0&quot; (to), &quot;1&quot; (from), &quot;2&quot; (ret)	\</span>
<span class="cp">		: &quot;acr&quot;, &quot;memory&quot;)</span>

<span class="cp">#define __asm_copy_from_user_1(to, from, ret) \</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,	\</span>
<span class="cp">		&quot;2:	move.b [%1+],$acr\n&quot;	\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,	\</span>
<span class="cp">		&quot;3:	addq 1,%2\n&quot;		\</span>
<span class="cp">		&quot;	jump 1b\n&quot;		\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,	\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_2x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,		\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;2:	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;3:	addq 2,%2\n&quot;			\</span>
<span class="cp">		&quot;	jump 1b\n&quot;			\</span>
<span class="cp">		&quot;	clear.w [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_2(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_2x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_3(to, from, ret)		\</span>
<span class="cp">	__asm_copy_from_user_2x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;4:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;5:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_4x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,		\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;2:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;3:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	jump 1b\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_4(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_4x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_5(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_4x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;4:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;5:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_6x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_4x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;4:	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;5:	addq 2,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.w [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_6(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_6x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_7(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_6x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;6:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;7:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_8x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_4x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;4:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;5:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_8(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_8x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_9(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_8x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;6:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;7:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_10x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_8x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;6:	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;7:	addq 2,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.w [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_10(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_10x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_11(to, from, ret)		\</span>
<span class="cp">	__asm_copy_from_user_10x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;8:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;9:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_12x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_8x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;6:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;7:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_12(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_12x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_13(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_12x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;8:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;9:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_14x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_12x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;8:	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;9:	addq 2,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.w [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_14(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_14x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_15(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_14x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;10:	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;11:	addq 1,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.b [%0+]\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 10b,11b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_16x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_12x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;8:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;9:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_16(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_16x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_20x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_16x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;10:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;11:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 10b,11b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_20(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_20x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_from_user_24x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_from_user_20x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;12:	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;13:	addq 4,%2\n&quot;			\</span>
<span class="cp">		&quot;	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 12b,13b\n&quot;)</span>

<span class="cp">#define __asm_copy_from_user_24(to, from, ret) \</span>
<span class="cp">	__asm_copy_from_user_24x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cm">/* And now, the to-user ones.  */</span>

<span class="cp">#define __asm_copy_to_user_1(to, from, ret)	\</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;	\</span>
<span class="cp">		&quot;2:	move.b $acr,[%0+]\n&quot;,	\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;		\</span>
<span class="cp">		&quot;	addq 1,%2\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_2x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,		\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;2:	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;			\</span>
<span class="cp">		&quot;	addq 2,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_2(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_2x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_3(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_2x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;4:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;5:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_4x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_user_cont(to, from, ret,		\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;2:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;			\</span>
<span class="cp">		&quot;	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_4(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_4x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_5(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_4x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;4:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;5:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_6x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_4x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;4:	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;5:	addq 2,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_6(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_6x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_7(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_6x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;6:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;7:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_8x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_4x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;4:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;5:	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_8(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_8x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_9(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_8x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;6:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;7:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_10x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_8x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;6:	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;7:	addq 2,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_10(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_10x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_11(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_10x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;8:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;9:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_12x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_8x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;6:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;7:	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_12(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_12x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_13(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_12x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;8:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;9:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_14x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_12x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.w [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;8:	move.w $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;9:	addq 2,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_14(to, from, ret)	\</span>
<span class="cp">	__asm_copy_to_user_14x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_15(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_14x_cont(to, from, ret,	\</span>
<span class="cp">		&quot;	move.b [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;10:	move.b $acr,[%0+]\n&quot;,		\</span>
<span class="cp">		&quot;11:	addq 1,%2\n&quot;,			\</span>
<span class="cp">		&quot;	.dword 10b,11b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_16x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_12x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;8:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;9:	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_16(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_16x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_20x_cont(to, from, ret, COPY, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_copy_to_user_16x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;10:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;11:	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 10b,11b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_20(to, from, ret) \</span>
<span class="cp">	__asm_copy_to_user_20x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_copy_to_user_24x_cont(to, from, ret, COPY, FIXUP, TENTRY)	\</span>
<span class="cp">	__asm_copy_to_user_20x_cont(to, from, ret,	\</span>
<span class="cp">			COPY				\</span>
<span class="cp">		&quot;	move.d [%1+],$acr\n&quot;		\</span>
<span class="cp">		&quot;12:	move.d $acr,[%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;13:	addq 4,%2\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 12b,13b\n&quot;)</span>

<span class="cp">#define __asm_copy_to_user_24(to, from, ret)	\</span>
<span class="cp">	__asm_copy_to_user_24x_cont(to, from, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cm">/* Define a few clearing asms with exception handlers.  */</span>

<span class="cm">/* This frame-asm is like the __asm_copy_user_cont one, but has one less</span>
<span class="cm">   input.  */</span>

<span class="cp">#define __asm_clear(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm__ __volatile__ (				\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;1:\n&quot;					\</span>
<span class="cp">		&quot;	.section .fixup,\&quot;ax\&quot;\n&quot;	\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;	.previous\n&quot;			\</span>
<span class="cp">		&quot;	.section __ex_table,\&quot;a\&quot;\n&quot;	\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.previous&quot;			\</span>
<span class="cp">		: &quot;=b&quot; (to), &quot;=r&quot; (ret)			\</span>
<span class="cp">		: &quot;0&quot; (to), &quot;1&quot; (ret)			\</span>
<span class="cp">		: &quot;memory&quot;)</span>

<span class="cp">#define __asm_clear_1(to, ret) \</span>
<span class="cp">	__asm_clear(to, ret,			\</span>
<span class="cp">		&quot;2:	clear.b [%0+]\n&quot;,	\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;		\</span>
<span class="cp">		&quot;	addq 1,%1\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_clear_2(to, ret) \</span>
<span class="cp">	__asm_clear(to, ret,			\</span>
<span class="cp">		&quot;2:	clear.w [%0+]\n&quot;,	\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;		\</span>
<span class="cp">		&quot;	addq 2,%1\n&quot;,		\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_clear_3(to, ret) \</span>
<span class="cp">     __asm_clear(to, ret,			\</span>
<span class="cp">		 &quot;2:	clear.w [%0+]\n&quot;	\</span>
<span class="cp">		 &quot;3:	clear.b [%0+]\n&quot;,	\</span>
<span class="cp">		 &quot;4:	addq 2,%1\n&quot;		\</span>
<span class="cp">		 &quot;5:	jump 1b\n&quot;		\</span>
<span class="cp">		 &quot;	addq 1,%1\n&quot;,		\</span>
<span class="cp">		 &quot;	.dword 2b,4b\n&quot;		\</span>
<span class="cp">		 &quot;	.dword 3b,5b\n&quot;)</span>

<span class="cp">#define __asm_clear_4x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear(to, ret,				\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;2:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;3:	jump 1b\n&quot;			\</span>
<span class="cp">		&quot;	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 2b,3b\n&quot;)</span>

<span class="cp">#define __asm_clear_4(to, ret) \</span>
<span class="cp">	__asm_clear_4x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_clear_8x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear_4x_cont(to, ret,			\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;4:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;5:	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 4b,5b\n&quot;)</span>

<span class="cp">#define __asm_clear_8(to, ret) \</span>
<span class="cp">	__asm_clear_8x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_clear_12x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear_8x_cont(to, ret,			\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;6:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;7:	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 6b,7b\n&quot;)</span>

<span class="cp">#define __asm_clear_12(to, ret) \</span>
<span class="cp">	__asm_clear_12x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_clear_16x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear_12x_cont(to, ret,			\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;8:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;9:	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 8b,9b\n&quot;)</span>

<span class="cp">#define __asm_clear_16(to, ret) \</span>
<span class="cp">	__asm_clear_16x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_clear_20x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear_16x_cont(to, ret,			\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;10:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;11:	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 10b,11b\n&quot;)</span>

<span class="cp">#define __asm_clear_20(to, ret) \</span>
<span class="cp">	__asm_clear_20x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cp">#define __asm_clear_24x_cont(to, ret, CLEAR, FIXUP, TENTRY) \</span>
<span class="cp">	__asm_clear_20x_cont(to, ret,			\</span>
<span class="cp">			CLEAR				\</span>
<span class="cp">		&quot;12:	clear.d [%0+]\n&quot;,		\</span>
<span class="cp">			FIXUP				\</span>
<span class="cp">		&quot;13:	addq 4,%1\n&quot;,			\</span>
<span class="cp">			TENTRY				\</span>
<span class="cp">		&quot;	.dword 12b,13b\n&quot;)</span>

<span class="cp">#define __asm_clear_24(to, ret) \</span>
<span class="cp">	__asm_clear_24x_cont(to, ret, &quot;&quot;, &quot;&quot;, &quot;&quot;)</span>

<span class="cm">/*</span>
<span class="cm"> * Return the size of a string (including the ending 0)</span>
<span class="cm"> *</span>
<span class="cm"> * Return length of string in userspace including terminating 0</span>
<span class="cm"> * or 0 for error.  Return a value greater than N if too long.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">strnlen_user</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">res</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This code is deduced from:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	tmp1 = n;</span>
<span class="cm">	 *	while (tmp1-- &gt; 0 &amp;&amp; *s++)</span>
<span class="cm">	 *	  ;</span>
<span class="cm">	 *</span>
<span class="cm">	 *	res = n - tmp1;</span>
<span class="cm">	 *</span>
<span class="cm">	 *  (with tweaks).</span>
<span class="cm">	 */</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;	move.d %1,$acr</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	cmpq 0,$acr</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;0:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	ble 1f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	subq 1,$acr</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;4:	test.b [%0+]</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	bne 0b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	cmpq 0,$acr</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	move.d %1,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	sub.d $acr,%0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.section .fixup,</span><span class="se">\&quot;</span><span class="s">ax</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>

		<span class="s">&quot;3:	jump 2b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	clear.d %0</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.dword 4b,3b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.previous</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">tmp1</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;acr&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
