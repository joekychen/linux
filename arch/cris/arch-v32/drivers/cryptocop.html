<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › cris › arch-v32 › drivers › cryptocop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cryptocop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Stream co-processor driver for the ETRAX FS</span>
<span class="cm"> *</span>
<span class="cm"> *    Copyright (C) 2003-2007  Axis Communications AB</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;dma.h&gt;</span>
<span class="cp">#include &lt;hwregs/dma.h&gt;</span>
<span class="cp">#include &lt;hwregs/reg_map.h&gt;</span>
<span class="cp">#include &lt;hwregs/reg_rdwr.h&gt;</span>
<span class="cp">#include &lt;hwregs/intr_vect_defs.h&gt;</span>

<span class="cp">#include &lt;hwregs/strcop.h&gt;</span>
<span class="cp">#include &lt;hwregs/strcop_defs.h&gt;</span>
<span class="cp">#include &lt;cryptocop.h&gt;</span>

<span class="cp">#ifdef CONFIG_ETRAXFS</span>
<span class="cp">#define IN_DMA 9</span>
<span class="cp">#define OUT_DMA 8</span>
<span class="cp">#define IN_DMA_INST regi_dma9</span>
<span class="cp">#define OUT_DMA_INST regi_dma8</span>
<span class="cp">#define DMA_IRQ DMA9_INTR_VECT</span>
<span class="cp">#else</span>
<span class="cp">#define IN_DMA 3</span>
<span class="cp">#define OUT_DMA 2</span>
<span class="cp">#define IN_DMA_INST regi_dma3</span>
<span class="cp">#define OUT_DMA_INST regi_dma2</span>
<span class="cp">#define DMA_IRQ DMA3_INTR_VECT</span>
<span class="cp">#endif</span>

<span class="cp">#define DESCR_ALLOC_PAD  (31)</span>

<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">free_buf</span><span class="p">;</span> <span class="cm">/* If non-null will be kfreed in free_cdesc() */</span>
	<span class="n">dma_descr_data</span> <span class="o">*</span><span class="n">dma_descr</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dma_descr_buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_descr_data</span><span class="p">)</span> <span class="o">+</span> <span class="n">DESCR_ALLOC_PAD</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from_pool</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* If 1 &#39;allocated&#39; from the descriptor pool. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">{</span>
	<span class="kt">void</span>                        <span class="o">*</span><span class="n">alloc_ptr</span><span class="p">;</span>
	<span class="n">cryptocop_session_id</span>        <span class="n">sid</span><span class="p">;</span>

	<span class="n">dma_descr_context</span>           <span class="n">ctx_out</span><span class="p">;</span>
	<span class="n">dma_descr_context</span>           <span class="n">ctx_in</span><span class="p">;</span>

	<span class="cm">/* DMA descriptors allocated by driver. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>   <span class="o">*</span><span class="n">cdesc_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>   <span class="o">*</span><span class="n">cdesc_in</span><span class="p">;</span>

	<span class="cm">/* Strcop config to use. */</span>
	<span class="n">cryptocop_3des_mode</span>         <span class="n">tdes_mode</span><span class="p">;</span>
	<span class="n">cryptocop_csum_type</span>         <span class="n">csum_mode</span><span class="p">;</span>

	<span class="cm">/* DMA descrs provided by consumer. */</span>
	<span class="n">dma_descr_data</span>              <span class="o">*</span><span class="n">ddesc_out</span><span class="p">;</span>
	<span class="n">dma_descr_data</span>              <span class="o">*</span><span class="n">ddesc_in</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="p">{</span>
	<span class="n">cryptocop_tfrm_id</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocklength</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_ix</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span> <span class="o">*</span><span class="n">tcfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">tctx</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">previous_src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">current_src</span><span class="p">;</span>

	<span class="cm">/* Values to use in metadata out. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hash_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hash_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ciph_conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cbcmode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">decrypt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">requires_padding</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">strict_block_length</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">done</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">consumed</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">produced</span><span class="p">;</span>

	<span class="cm">/* Pad (input) descriptors to put in the DMA out list when the transform</span>
<span class="cm">	 * output is put on the DMA in list. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">pad_descs</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">prev_src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">curr_src</span><span class="p">;</span>

	<span class="cm">/* Mapping to HW. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">unit_no</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">cryptocop_private</span><span class="p">{</span>
	<span class="n">cryptocop_session_id</span> <span class="n">sid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Session list. */</span>

<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span><span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span> <span class="n">init</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dec_key</span><span class="p">[</span><span class="n">CRYPTOCOP_MAX_KEY_LENGTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dec_key_set</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">cryptocop_session</span><span class="p">{</span>
	<span class="n">cryptocop_session_id</span> <span class="n">sid</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">tfrm_ctx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Priority levels for jobs sent to the cryptocop.  Checksum operations from</span>
<span class="cm">   kernel have highest priority since TCPIP stack processing must not</span>
<span class="cm">   be a bottleneck. */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">cryptocop_prio_kernel_csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">cryptocop_prio_kernel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">cryptocop_prio_user</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">cryptocop_prio_no_prios</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">}</span> <span class="n">cryptocop_queue_priority</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">cryptocop_prio_queue</span><span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">jobs</span><span class="p">;</span>
	<span class="n">cryptocop_queue_priority</span> <span class="n">prio</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">cryptocop_queue_priority</span> <span class="n">prio</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">oper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">*</span><span class="n">iop</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ioctl_job_cb_ctx</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">processed</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">cryptocop_sessions</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">spinlock_t</span> <span class="n">cryptocop_sessions_lock</span><span class="p">;</span>

<span class="cm">/* Next Session ID to assign. */</span>
<span class="k">static</span> <span class="n">cryptocop_session_id</span> <span class="n">next_sid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Pad for checksum. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">csum_zero_pad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">};</span>

<span class="cm">/* Trash buffer for mem2mem operations. */</span>
<span class="cp">#define MEM2MEM_DISCARD_BUF_LENGTH  (512)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mem2mem_discard_buf</span><span class="p">[</span><span class="n">MEM2MEM_DISCARD_BUF_LENGTH</span><span class="p">];</span>

<span class="cm">/* Descriptor pool. */</span>
<span class="cm">/* FIXME Tweak this value. */</span>
<span class="cp">#define CRYPTOCOP_DESCRIPTOR_POOL_SIZE   (100)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="n">descr_pool</span><span class="p">[</span><span class="n">CRYPTOCOP_DESCRIPTOR_POOL_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">descr_pool_free_list</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">descr_pool_no_free</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">descr_pool_lock</span><span class="p">;</span>

<span class="cm">/* Lock to stop cryptocop to start processing of a new operation. The holder</span>
<span class="cm">   of this lock MUST call cryptocop_start_job() after it is unlocked. */</span>
<span class="n">spinlock_t</span> <span class="n">cryptocop_process_lock</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_prio_queue</span> <span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">cryptocop_prio_no_prios</span><span class="p">];</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">cryptocop_job_queue_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span> <span class="o">*</span><span class="n">cryptocop_running_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">running_job_lock</span><span class="p">;</span>

<span class="cm">/* The interrupt handler appends completed jobs to this list. The scehduled</span>
<span class="cm"> * tasklet removes them upon sending the response to the crypto consumer. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">cryptocop_completed_jobs</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">cryptocop_completed_jobs_lock</span><span class="p">;</span>

<span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">cryptocop_ioc_process_wq</span><span class="p">);</span>


<span class="cm">/** Local functions. **/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cryptocop_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cryptocop_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">cryptocop_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cryptocop_start_job</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cryptocop_job_queue_insert</span><span class="p">(</span><span class="n">cryptocop_queue_priority</span> <span class="n">prio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cryptocop_job_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_prio_job</span> <span class="o">**</span><span class="n">pj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cryptocop_job_queue_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cryptocop_job_queue_close</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">create_md5_pad</span><span class="p">(</span><span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">hashed_length</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pad</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">pad_length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">create_sha1_pad</span><span class="p">(</span><span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">hashed_length</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pad</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">pad_length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">transform_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_transform_init</span> <span class="o">*</span><span class="n">tinit</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">get_session</span><span class="p">(</span><span class="n">cryptocop_session_id</span> <span class="n">sid</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">get_transform_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span> <span class="n">cryptocop_tfrm_id</span> <span class="n">tid</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">delete_internal_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">*</span><span class="n">iop</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">get_aes_decrypt_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dec_key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylength</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">init_stream_coprocessor</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="n">exit_stream_coprocessor</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*#define LDEBUG*/</span>
<span class="cp">#ifdef LDEBUG</span>
<span class="cp">#define DEBUG(s) s</span>
<span class="cp">#define DEBUG_API(s) s</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_cryptocop_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">cop</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_dma_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">*</span><span class="n">iop</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_strcop_crypto_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span> <span class="o">*</span><span class="n">cop</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_lock_status</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">print_user_dma_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_list_operation</span> <span class="o">*</span><span class="n">dma_op</span><span class="p">);</span>
<span class="cp">#define assert(s) do{if (!(s)) panic(#s);} while(0);</span>
<span class="cp">#else</span>
<span class="cp">#define DEBUG(s)</span>
<span class="cp">#define DEBUG_API(s)</span>
<span class="cp">#define assert(s)</span>
<span class="cp">#endif</span>


<span class="cm">/* Transform constants. */</span>
<span class="cp">#define DES_BLOCK_LENGTH   (8)</span>
<span class="cp">#define AES_BLOCK_LENGTH   (16)</span>
<span class="cp">#define MD5_BLOCK_LENGTH   (64)</span>
<span class="cp">#define SHA1_BLOCK_LENGTH  (64)</span>
<span class="cp">#define CSUM_BLOCK_LENGTH  (2)</span>
<span class="cp">#define MD5_STATE_LENGTH   (16)</span>
<span class="cp">#define SHA1_STATE_LENGTH  (20)</span>

<span class="cm">/* The device number. */</span>
<span class="cp">#define CRYPTOCOP_MAJOR    (254)</span>
<span class="cp">#define CRYPTOCOP_MINOR    (0)</span>



<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cryptocop_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">cryptocop_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cryptocop_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">cryptocop_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_cdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;free_cdesc: cdesc 0x%p, from_pool=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdesc</span><span class="p">,</span> <span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">from_pool</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">free_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">from_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">descr_pool_free_list</span><span class="p">;</span>
		<span class="n">descr_pool_free_list</span> <span class="o">=</span> <span class="n">cdesc</span><span class="p">;</span>
		<span class="o">++</span><span class="n">descr_pool_no_free</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cdesc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="nf">alloc_cdesc</span><span class="p">(</span><span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">use_pool</span> <span class="o">=</span> <span class="p">(</span><span class="n">alloc_flag</span> <span class="o">&amp;</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cdesc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">descr_pool_free_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;alloc_cdesc: pool is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdesc</span> <span class="o">=</span> <span class="n">descr_pool_free_list</span><span class="p">;</span>
		<span class="n">descr_pool_free_list</span> <span class="o">=</span> <span class="n">descr_pool_free_list</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="o">--</span><span class="n">descr_pool_no_free</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">from_pool</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cdesc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_desc</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdesc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;alloc_cdesc: kmalloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">from_pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_descr_data</span><span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">cdesc</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_desc</span><span class="p">,</span> <span class="n">dma_descr_buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">DESCR_ALLOC_PAD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0000001F</span><span class="p">);</span>

	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">free_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">in_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;alloc_cdesc: return 0x%p, cdesc-&gt;dma_descr=0x%p, from_pool=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cdesc</span><span class="p">,</span> <span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">,</span> <span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">from_pool</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">cdesc</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_descr_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_descr_chain: entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cd</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_descr_data</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cd</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cd</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_descr_chain: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* Create a pad descriptor for the transform.</span>
<span class="cm"> * Return -1 for error, 0 if pad created. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_pad_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">pad_desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>        <span class="o">*</span><span class="n">cdesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>                              <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_meta_out</span>           <span class="n">mo</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">src_none</span>
	<span class="p">};</span>
	<span class="kt">char</span>                             <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="kt">size_t</span>                           <span class="n">plen</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_pad_descriptor: start.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="cm">/* Setup pad descriptor. */</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_pad_descriptor: setting up padding.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">cdesc</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdesc</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_pad_descriptor: alloc pad desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">src_md5</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">create_md5_pad</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">consumed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_pad_descriptor: create_md5_pad_failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">free_buf</span> <span class="o">=</span> <span class="n">pad</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashconf</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">hash_conf</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">src_sha1</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">create_sha1_pad</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">consumed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_pad_descriptor: create_sha1_pad_failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">free_buf</span> <span class="o">=</span> <span class="n">pad</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashconf</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">hash_conf</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">hash_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">src_csum</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">%</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">blocklength</span><span class="p">){</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">csum_zero_pad</span><span class="p">;</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">cdesc</span><span class="p">;</span> <span class="cm">/* Use any pointer. */</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Since this is a pad output is pushed.  EOP is ok here since the padded unit is the only one active. */</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pad</span><span class="p">);</span>
	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>

	<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span><span class="p">,</span> <span class="n">mo</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pad_desc</span> <span class="o">=</span> <span class="n">cdesc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error_cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdesc</span><span class="p">)</span> <span class="n">free_cdesc</span><span class="p">(</span><span class="n">cdesc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_key_dl_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">kd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">key_desc</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">strcop_meta_out</span>     <span class="n">mo</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_key_dl_desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_key_dl_desc: failed descriptor allocation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Download key. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">cryptocop_alg_aes</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTOCOP_DECRYPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Precook the AES decrypt key. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dec_key_set</span><span class="p">){</span>
			<span class="n">get_aes_decrypt_key</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dec_key</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">keylen</span><span class="p">);</span>
			<span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dec_key_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">dec_key</span><span class="p">);</span>
		<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">keylen</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
		<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">keylen</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Setup metadata. */</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">dlkey</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">keylen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">64</span>:
		<span class="n">mo</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">mo</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192</span>:
		<span class="n">mo</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">mo</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mo</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">mo</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">mo</span><span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
	<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span><span class="p">,</span> <span class="n">mo</span><span class="p">);</span>

	<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">kd</span> <span class="o">=</span> <span class="n">key_desc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_cipher_iv_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">iv_desc</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">strcop_meta_out</span>     <span class="n">mo</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_cipher_iv_desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iv_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup_cipher_iv_desc: failed CBC IV descriptor allocation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Download IV. */</span>
	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">iv</span><span class="p">);</span>
	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">blocklength</span><span class="p">;</span>

	<span class="cm">/* Setup metadata. */</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">mo</span><span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">ciphconf</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">ciph_conf</span><span class="p">;</span>
	<span class="n">mo</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">cbcmode</span><span class="p">;</span>

	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span><span class="p">,</span> <span class="n">mo</span><span class="p">);</span>

	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">iv_desc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Map the ouput length of the transform to operation output starting on the inject index. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_input_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                        <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="n">head</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">outdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">size_t</span>                     <span class="n">iov_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span>                     <span class="n">out_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>                        <span class="n">outiov_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_meta_in</span>      <span class="n">mi</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="kt">size_t</span>                     <span class="n">out_length</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">produced</span><span class="p">;</span>
	<span class="kt">int</span>                        <span class="n">rem_length</span><span class="p">;</span>
	<span class="kt">int</span>                        <span class="n">dlength</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">out_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">produced</span> <span class="o">+</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">inject_ix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">produced</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_input_descriptors: operation outdata too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Traverse the out iovec until the result inject index is reached. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">outiov_ix</span> <span class="o">&lt;</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">out_ix</span> <span class="o">+</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">inject_ix</span><span class="p">)){</span>
		<span class="n">out_ix</span> <span class="o">+=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="n">outiov_ix</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outiov_ix</span> <span class="o">&gt;=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_input_descriptors: operation outdata too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iov_offset</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">inject_ix</span> <span class="o">-</span> <span class="n">out_ix</span><span class="p">;</span>
	<span class="n">mi</span><span class="p">.</span><span class="n">dmasel</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">;</span>

	<span class="cm">/* Setup the output descriptors. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">out_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">outiov_ix</span> <span class="o">&lt;</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_input_descriptors: alloc_cdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outdesc</span> <span class="o">=</span> <span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rem_length</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">-</span> <span class="n">iov_offset</span><span class="p">;</span>
		<span class="n">dlength</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_length</span> <span class="o">&lt;</span> <span class="n">rem_length</span><span class="p">)</span> <span class="o">?</span> <span class="n">out_length</span> <span class="o">:</span> <span class="n">rem_length</span><span class="p">;</span>

		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_input_descriptors:</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;outiov_ix=%d, rem_length=%d, dlength=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;iov_offset=%d, outdata[outiov_ix].iov_len=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;outcount=%d, outiov_ix=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">outiov_ix</span><span class="p">,</span> <span class="n">rem_length</span><span class="p">,</span> <span class="n">dlength</span><span class="p">,</span> <span class="n">iov_offset</span><span class="p">,</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_len</span><span class="p">,</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">,</span> <span class="n">outiov_ix</span><span class="p">));</span>

		<span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="n">iov_offset</span><span class="p">);</span>
		<span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">dlength</span><span class="p">;</span>
		<span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_in</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>

		<span class="n">out_length</span> <span class="o">-=</span> <span class="n">dlength</span><span class="p">;</span>
		<span class="n">iov_offset</span> <span class="o">+=</span> <span class="n">dlength</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iov_offset</span> <span class="o">&gt;=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">outiov_ix</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iov_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">++</span><span class="n">outiov_ix</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_input_descriptors: not enough room for output, %d remained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out_length</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set sync in last descriptor. */</span>
	<span class="n">mi</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_in</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>

	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error_cleanup:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outdesc</span> <span class="o">=</span> <span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_cdesc</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">head</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">outdesc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_output_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iniov_ix</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iniov_offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">desc_len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span> <span class="o">*</span><span class="n">meta_out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">desc_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">cdesc</span><span class="p">;</span>
		<span class="kt">int</span>                        <span class="n">rem_length</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="o">*</span><span class="n">iniov_ix</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">-</span> <span class="o">*</span><span class="n">iniov_offset</span><span class="p">;</span>
		<span class="kt">int</span>                        <span class="n">dlength</span> <span class="o">=</span> <span class="p">(</span><span class="n">desc_len</span> <span class="o">&lt;</span> <span class="n">rem_length</span><span class="p">)</span> <span class="o">?</span> <span class="n">desc_len</span> <span class="o">:</span> <span class="n">rem_length</span><span class="p">;</span>

		<span class="n">cdesc</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdesc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_output_descriptors: alloc_cdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cdesc</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span> <span class="o">=</span> <span class="n">cdesc</span><span class="p">;</span>

		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">free_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="o">*</span><span class="n">iniov_ix</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">+</span> <span class="o">*</span><span class="n">iniov_offset</span><span class="p">);</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">dlength</span><span class="p">;</span>

		<span class="n">assert</span><span class="p">(</span><span class="n">desc_len</span> <span class="o">&gt;=</span> <span class="n">dlength</span><span class="p">);</span>
		<span class="n">desc_len</span> <span class="o">-=</span> <span class="n">dlength</span><span class="p">;</span>
		<span class="o">*</span><span class="n">iniov_offset</span> <span class="o">+=</span> <span class="n">dlength</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iniov_offset</span> <span class="o">&gt;=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="o">*</span><span class="n">iniov_ix</span><span class="p">].</span><span class="n">iov_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">iniov_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">iniov_ix</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iniov_ix</span> <span class="o">&gt;</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">incount</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_output_descriptors: not enough indata in operation.&quot;</span><span class="p">));</span>
				<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">meta_out</span><span class="p">));</span>
	<span class="p">}</span> <span class="cm">/* while (desc_len != 0) */</span>
	<span class="cm">/* Last DMA descriptor gets a &#39;wait&#39; bit to signal expected change in metadata. */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* This will set extraneous WAIT in some situations, e.g. when padding hashes and checksums. */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">append_input_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">current_in_cdesc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">**</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">tc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors, tc=0x%p, unit_no=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">tcfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>                        <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">idescs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors: pushing output, consumed %d produced %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">consumed</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">produced</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors: append pad descriptors to DMA out list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append descriptor 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span><span class="p">));</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span><span class="p">;</span>
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">pad_descs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">current_out_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Setup and append output descriptors to DMA in list. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">src_dma</span><span class="p">){</span>
			<span class="cm">/* mem2mem.  Setup DMA in descriptors to discard all input prior to the requested mem2mem data. */</span>
			<span class="k">struct</span> <span class="n">strcop_meta_in</span> <span class="n">mi</span> <span class="o">=</span> <span class="p">{.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">dmasel</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">};</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start_ix</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">start_ix</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">start_ix</span><span class="p">){</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">desclen</span> <span class="o">=</span> <span class="n">start_ix</span> <span class="o">&lt;</span> <span class="n">MEM2MEM_DISCARD_BUF_LENGTH</span> <span class="o">?</span> <span class="n">start_ix</span> <span class="o">:</span> <span class="n">MEM2MEM_DISCARD_BUF_LENGTH</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">){</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors: alloc_cdesc mem2mem discard failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">mem2mem_discard_buf</span><span class="p">);</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">desclen</span><span class="p">;</span>
				<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_in</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
				<span class="n">start_ix</span> <span class="o">-=</span> <span class="n">desclen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mi</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_in</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">failed</span> <span class="o">=</span> <span class="n">create_input_descriptors</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idescs</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors: output descriptor setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append_input_descriptors: append output descriptors to DMA in list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">idescs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;append descriptor 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idescs</span><span class="p">));</span>
			<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">idescs</span><span class="p">;</span>
			<span class="n">idescs</span> <span class="o">=</span> <span class="n">idescs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">current_in_cdesc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_setup_dma_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">**</span><span class="n">int_op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">tctx</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="n">digest_ctx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">previous_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">requires_padding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">strict_block_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prev_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">curr_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="n">cipher_ctx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">previous_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">requires_padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">strict_block_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prev_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">curr_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="n">csum_ctx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">previous_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">requires_padding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">strict_block_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hash_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">consumed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prev_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">curr_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_csum</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span> <span class="o">*</span><span class="n">tcfg</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">indata_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* iovec accounting. */</span>
	<span class="kt">int</span> <span class="n">iniov_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iniov_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Operation descriptor cfg traversal pointer. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_desc</span> <span class="o">*</span><span class="n">odsc</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* List heads for allocated descriptors. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="n">out_cdesc_head</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="n">in_cdesc_head</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">current_out_cdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">out_cdesc_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">current_in_cdesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_cdesc_head</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span> <span class="o">*</span><span class="n">output_tc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span>                      <span class="o">*</span><span class="n">iop_alloc_ptr</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">operation</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">int_op</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">print_cryptocop_operation</span><span class="p">(</span><span class="n">operation</span><span class="p">));</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: no session found for operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iop_alloc_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">DESCR_ALLOC_PAD</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop_alloc_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list:  kmalloc cryptocop_int_operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">iop_alloc_ptr</span> <span class="o">+</span> <span class="n">DESCR_ALLOC_PAD</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">,</span> <span class="n">ctx_out</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0000001F</span><span class="p">)</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">,</span> <span class="n">ctx_out</span><span class="p">));</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">memset</span><span class="p">((</span><span class="o">*</span><span class="n">int_op</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">)));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">alloc_ptr</span> <span class="o">=</span> <span class="n">iop_alloc_ptr</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: *int_op=0x%p, alloc_ptr=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">int_op</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">alloc_ptr</span><span class="p">));</span>

	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tdes_mode</span> <span class="o">=</span> <span class="n">cryptocop_3des_ede</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">csum_mode</span> <span class="o">=</span> <span class="n">cryptocop_csum_le</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ddesc_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ddesc_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Scan operation-&gt;tfrm_op.tfrm_cfg for bad configuration and set up the local contexts. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tcfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: no configured transforms in operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tcfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tctx</span> <span class="o">=</span> <span class="n">get_transform_ctx</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: no transform id %d in session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">inject_ix</span> <span class="o">&gt;</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: transform id %d inject_ix (%d) &gt; operation-&gt;tfrm_op.outlen(%d)&quot;</span><span class="p">,</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">inject_ix</span><span class="p">,</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_alg_mem2mem</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: multiple ciphers in operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* mem2mem is handled as a NULL cipher. */</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="n">tcfg</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_alg_des</span>:
		<span class="k">case</span> <span class="n">cryptocop_alg_3des</span>:
		<span class="k">case</span> <span class="n">cryptocop_alg_aes</span>:
			<span class="cm">/* cipher */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: multiple ciphers in operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="n">tcfg</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTOCOP_DECRYPT</span><span class="p">){</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">cipher_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">cryptocop_cipher_mode_ecb</span>:
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_cipher_mode_cbc</span>:
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher_ctx, bad cipher mode==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">cipher_mode</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher_ctx, set CBC mode==%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span><span class="p">));</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span><span class="p">){</span>
			<span class="k">case</span> <span class="n">cryptocop_alg_des</span>:
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_des</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="n">DES_BLOCK_LENGTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_alg_3des</span>:
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_des</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="n">DES_BLOCK_LENGTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_alg_aes</span>:
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_aes</span><span class="p">;</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="n">AES_BLOCK_LENGTH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: impossible algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tdes_mode</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tdes_mode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_alg_md5</span>:
		<span class="k">case</span> <span class="n">cryptocop_alg_sha1</span>:
			<span class="cm">/* digest */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: multiple digests in operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">digest_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="n">tcfg</span><span class="p">;</span>
			<span class="n">digest_ctx</span><span class="p">.</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="p">;</span>
			<span class="n">digest_ctx</span><span class="p">.</span><span class="n">hash_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Don&#39;t use explicit IV in this API. */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span><span class="p">){</span>
			<span class="k">case</span> <span class="n">cryptocop_alg_md5</span>:
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="n">MD5_BLOCK_LENGTH</span><span class="p">;</span>
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_md5</span><span class="p">;</span>
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">hash_conf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 1 =&gt; MD-5 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_alg_sha1</span>:
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">=</span> <span class="n">SHA1_BLOCK_LENGTH</span><span class="p">;</span>
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">=</span> <span class="n">src_sha1</span><span class="p">;</span>
				<span class="n">digest_ctx</span><span class="p">.</span><span class="n">hash_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0 =&gt; SHA-1 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">panic</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: impossible digest algorithm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_alg_csum</span>:
			<span class="cm">/* digest */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: multiple checksums in operation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">csum_mode</span> <span class="o">=</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">csum_mode</span><span class="p">;</span>
			<span class="n">csum_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">=</span> <span class="n">tcfg</span><span class="p">;</span>
			<span class="n">csum_ctx</span><span class="p">.</span><span class="n">tctx</span> <span class="o">=</span> <span class="n">tctx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* no algorithm. */</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: invalid algorithm %d specified in tfrm %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tcfg</span> <span class="o">=</span> <span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Download key if a cipher is used. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span> <span class="o">!=</span> <span class="n">cryptocop_alg_mem2mem</span><span class="p">)){</span>
		<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">key_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">failed</span> <span class="o">=</span> <span class="n">setup_key_dl_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key_desc</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: setup key dl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">current_out_cdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">key_desc</span><span class="p">;</span>
		<span class="n">current_out_cdesc</span> <span class="o">=</span> <span class="n">key_desc</span><span class="p">;</span>
		<span class="n">indata_ix</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">-</span> <span class="n">key_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* Download explicit IV if a cipher is used and CBC mode and explicit IV selected. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tctx</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">cipher_mode</span> <span class="o">==</span> <span class="n">cryptocop_cipher_mode_cbc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTOCOP_EXPLICIT_IV</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span>  <span class="o">*</span><span class="n">iv_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: setup cipher CBC IV descriptor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

			<span class="n">failed</span> <span class="o">=</span> <span class="n">setup_cipher_iv_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iv_desc</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: CBC IV descriptor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">current_out_cdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">iv_desc</span><span class="p">;</span>
			<span class="n">current_out_cdesc</span> <span class="o">=</span> <span class="n">iv_desc</span><span class="p">;</span>
			<span class="n">indata_ix</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">-</span> <span class="n">iv_desc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Process descriptors. */</span>
	<span class="n">odsc</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">odsc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cryptocop_desc_cfg</span>   <span class="o">*</span><span class="n">dcfg</span> <span class="o">=</span> <span class="n">odsc</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">strcop_meta_out</span>      <span class="n">meta_out</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
		<span class="kt">size_t</span>                      <span class="n">desc_len</span> <span class="o">=</span> <span class="n">odsc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="kt">int</span>                         <span class="n">active_count</span><span class="p">,</span> <span class="n">eop_needed_count</span><span class="p">;</span>

		<span class="n">output_tc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: parsing an operation descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">dcfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cryptocop_tfrm_ctx</span>  <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: parsing an operation descriptor configuration.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="cm">/* Get the local context for the transform and mark it as the output unit if it produces output. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)){</span>
				<span class="n">tc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">digest_ctx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)){</span>
				<span class="n">tc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher_ctx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)){</span>
				<span class="n">tc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csum_ctx</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: invalid transform %d specified in descriptor.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: completed transform %d reused.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">start_ix</span> <span class="o">=</span> <span class="n">indata_ix</span><span class="p">;</span>
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tc</span><span class="o">-&gt;</span><span class="n">previous_src</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span><span class="p">;</span>
			<span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="p">;</span>
			<span class="cm">/* Map source unit id to DMA source config. */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">){</span>
			<span class="k">case</span> <span class="n">cryptocop_source_dma</span>:
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_dma</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_source_des</span>:
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_des</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_source_3des</span>:
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_des</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_source_aes</span>:
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">=</span> <span class="n">src_aes</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">cryptocop_source_md5</span>:
			<span class="k">case</span> <span class="n">cryptocop_source_sha1</span>:
			<span class="k">case</span> <span class="n">cryptocop_source_csum</span>:
			<span class="k">case</span> <span class="n">cryptocop_source_none</span>:
			<span class="nl">default:</span>
				<span class="cm">/* We do not allow using accumulating style units (SHA-1, MD5, checksum) as sources to other units.</span>
<span class="cm">				 */</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: bad unit source configured %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">));</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">!=</span> <span class="n">src_dma</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Find the unit we are sourcing from. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span><span class="p">){</span>
					<span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">digest_ctx</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span><span class="p">){</span>
					<span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cipher_ctx</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span><span class="p">){</span>
					<span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csum_ctx</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">==</span> <span class="n">tc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span> <span class="o">!=</span> <span class="n">src_dma</span><span class="p">)){</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: unit %d configured to source from itself.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">));</span>
					<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Detect source switch. */</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: tc-&gt;active=%d tc-&gt;unit_no=%d tc-&gt;current_src=%d tc-&gt;previous_src=%d, tc-&gt;curr_src=0x%p, tc-&gt;prev_srv=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">previous_src</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">current_src</span> <span class="o">!=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">previous_src</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Only allow source switch when both the old source unit and the new one have</span>
<span class="cm">				 * no pending data to process (i.e. the consumed length must be a multiple of the</span>
<span class="cm">				 * transform blocklength). */</span>
				<span class="cm">/* Note: if the src == NULL we are actually sourcing from DMA out. */</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">%</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="o">-&gt;</span><span class="n">blocklength</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">((</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">%</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">blocklength</span><span class="p">)))</span>
				<span class="p">{</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: can only disconnect from or connect to a unit on a multiple of the blocklength, old: cons=%d, prod=%d, block=%d, new: cons=%d prod=%d, block=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="o">-&gt;</span><span class="n">produced</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">prev_src</span><span class="o">-&gt;</span><span class="n">blocklength</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">consumed</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">produced</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span> <span class="o">?</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">blocklength</span> <span class="o">:</span> <span class="n">INT_MIN</span><span class="p">));</span>
					<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Detect unit deactivation. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Length check of this is handled below. */</span>
				<span class="n">tc</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dcfg</span> <span class="o">=</span> <span class="n">dcfg</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* while (dcfg) */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: parsing operation descriptor configuration complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">curr_src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher source from inactive unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">curr_src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: digest source from inactive unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">curr_src</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher source from inactive unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">curr_src</span><span class="o">-&gt;</span><span class="n">unit_no</span><span class="p">));</span>
			<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Update consumed and produced lengths.</span>

<span class="cm">		   The consumed length accounting here is actually cheating.  If a unit source from DMA (or any</span>
<span class="cm">		   other unit that process data in blocks of one octet) it is correct, but if it source from a</span>
<span class="cm">		   block processing unit, i.e. a cipher, it will be temporarily incorrect at some times.  However</span>
<span class="cm">		   since it is only allowed--by the HW--to change source to or from a block processing unit at times where that</span>
<span class="cm">		   unit has processed an exact multiple of its block length the end result will be correct.</span>
<span class="cm">		   Beware that if the source change restriction change this code will need to be (much) reworked.</span>
<span class="cm">		*/</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: desc-&gt;length=%d, desc_len=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">odsc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">desc_len</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">csum_ctx</span><span class="p">.</span><span class="n">consumed</span> <span class="o">+=</span> <span class="n">desc_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">csum_ctx</span><span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: csum_ctx producing: consumed=%d, produced=%d, blocklength=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">consumed</span><span class="p">,</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">produced</span><span class="p">,</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">blocklength</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">digest_ctx</span><span class="p">.</span><span class="n">consumed</span> <span class="o">+=</span> <span class="n">desc_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">src_md5</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">digest_ctx</span><span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">MD5_STATE_LENGTH</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">digest_ctx</span><span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">SHA1_STATE_LENGTH</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: digest_ctx producing: consumed=%d, produced=%d, blocklength=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">consumed</span><span class="p">,</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">produced</span><span class="p">,</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">blocklength</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ciphers are allowed only to source from DMA out.  That is filtered above. */</span>
			<span class="n">assert</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">current_src</span> <span class="o">==</span> <span class="n">src_dma</span><span class="p">);</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">consumed</span> <span class="o">+=</span> <span class="n">desc_len</span><span class="p">;</span>
			<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">produced</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span> <span class="o">*</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">consumed</span> <span class="o">/</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CRYPTOCOP_EXPLICIT_IV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">produced</span><span class="p">){</span>
				<span class="n">cipher_ctx</span><span class="p">.</span><span class="n">produced</span> <span class="o">-=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span><span class="p">;</span> <span class="cm">/* Compensate for CBC iv. */</span>
			<span class="p">}</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher_ctx producing: consumed=%d, produced=%d, blocklength=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">consumed</span><span class="p">,</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">produced</span><span class="p">,</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">blocklength</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Setup the DMA out descriptors. */</span>
		<span class="cm">/* Configure the metadata. */</span>
		<span class="n">active_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">eop_needed_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">active_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">src_dma</span><span class="p">){</span>
				<span class="cm">/* mem2mem */</span>
				<span class="n">meta_out</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">meta_out</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">current_src</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">ciphconf</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">decrypt</span><span class="p">;</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;set ciphsel=%d ciphconf=%d cbcmode=%d decrypt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">ciphsel</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">ciphconf</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">cbcmode</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">decrypt</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="o">++</span><span class="n">eop_needed_count</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">active_count</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">current_src</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">hashconf</span> <span class="o">=</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">hash_conf</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">hashmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Explicit mode is not used here. */</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;set hashsel=%d hashconf=%d hashmode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">hashsel</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">hashconf</span><span class="p">,</span> <span class="n">meta_out</span><span class="p">.</span><span class="n">hashmode</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">assert</span><span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="n">create_pad_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">digest_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: failed digest pad creation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">hashsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">active_count</span><span class="p">;</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">current_src</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">assert</span><span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">failed</span> <span class="o">=</span> <span class="n">create_pad_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csum_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: failed csum pad creation.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">meta_out</span><span class="p">.</span><span class="n">csumsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: %d eop needed, %d active units</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eop_needed_count</span><span class="p">,</span> <span class="n">active_count</span><span class="p">));</span>
		<span class="cm">/* Setup DMA out descriptors for the indata. */</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="n">create_output_descriptors</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iniov_ix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iniov_offset</span><span class="p">,</span> <span class="n">desc_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">meta_out</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: create_output_descriptors %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Setup out EOP.  If there are active units that are not done here they cannot get an EOP</span>
<span class="cm">		 * so we ust setup a zero length descriptor to DMA to signal EOP only to done units.</span>
<span class="cm">		 * If there is a pad descriptor EOP for the padded unit will be EOPed by it.</span>
<span class="cm">		 */</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">active_count</span> <span class="o">&gt;=</span> <span class="n">eop_needed_count</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">((</span><span class="n">eop_needed_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eop_needed_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eop_needed_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This means that the bulk operation (cipeher/m2m) is terminated. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">active_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Use zero length EOP descriptor. */</span>
				<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">alloc_cdesc</span><span class="p">(</span><span class="n">alloc_flag</span><span class="p">);</span>
				<span class="k">struct</span> <span class="n">strcop_meta_out</span>    <span class="n">ed_mo</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: alloc EOP descriptor for cipher</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
					<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">assert</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">unit_no</span> <span class="o">==</span> <span class="n">src_dma</span><span class="p">){</span>
					<span class="cm">/* mem2mem */</span>
					<span class="n">ed_mo</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">src_none</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ed_mo</span><span class="p">.</span><span class="n">ciphsel</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">current_src</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ed_mo</span><span class="p">.</span><span class="n">ciphconf</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">ciph_conf</span><span class="p">;</span>
				<span class="n">ed_mo</span><span class="p">.</span><span class="n">cbcmode</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">cbcmode</span><span class="p">;</span>
				<span class="n">ed_mo</span><span class="p">.</span><span class="n">decrypt</span> <span class="o">=</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">decrypt</span><span class="p">;</span>

				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">free_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ed</span><span class="p">);</span> <span class="cm">/* Use any valid physical address for zero length descriptor. */</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">after</span> <span class="o">=</span> <span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
				<span class="n">ed</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">md</span> <span class="o">=</span> <span class="n">REG_TYPE_CONV</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">strcop_meta_out</span><span class="p">,</span> <span class="n">ed_mo</span><span class="p">);</span>
				<span class="n">current_out_cdesc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
				<span class="n">current_out_cdesc</span> <span class="o">=</span> <span class="n">ed</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Set EOP in the current out descriptor since the only active module is</span>
<span class="cm">				 * the one needing the EOP. */</span>

				<span class="n">current_out_cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">out_eop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">indata_ix</span> <span class="o">+=</span> <span class="n">odsc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">odsc</span> <span class="o">=</span> <span class="n">odsc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* while (odsc) */</span> <span class="cm">/* Process descriptors. */</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: done parsing operation descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">||</span> <span class="o">!</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: cipher operation not terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">||</span> <span class="o">!</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: digest operation not terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">tcfg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">active</span> <span class="o">||</span> <span class="o">!</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">done</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: csum operation not terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">failed</span> <span class="o">=</span> <span class="n">append_input_descriptors</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_in_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cipher_ctx</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: append_input_descriptors cipher_ctx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">failed</span> <span class="o">=</span> <span class="n">append_input_descriptors</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_in_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digest_ctx</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: append_input_descriptors cipher_ctx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">failed</span> <span class="o">=</span> <span class="n">append_input_descriptors</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_in_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_out_cdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csum_ctx</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: append_input_descriptors cipher_ctx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: int_op=0x%p, *int_op=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">int_op</span><span class="p">,</span> <span class="o">*</span><span class="n">int_op</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_out</span> <span class="o">=</span> <span class="n">out_cdesc_head</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_in</span> <span class="o">=</span> <span class="n">in_cdesc_head</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: out_cdesc_head=0x%p in_cdesc_head=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="p">));</span>

	<span class="n">setup_descr_chain</span><span class="p">(</span><span class="n">out_cdesc_head</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">setup_descr_chain</span><span class="p">(</span><span class="n">in_cdesc_head</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/* Last but not least: mark the last DMA in descriptor for a INTR and EOL and the the</span>
<span class="cm">	 * last DMA out descriptor for EOL.</span>
<span class="cm">	 */</span>
	<span class="n">current_in_cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_in_cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_out_cdesc</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Setup DMA contexts. */</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">store_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">dis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">md0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">md1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">md2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">md3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">md4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_descr_data</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data_buf</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span> <span class="cm">/* Already physical address. */</span>

	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">store_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">dis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">md0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">md1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">md2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">md3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">md4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_descr_data</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data_buf</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span> <span class="cm">/* Already physical address. */</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_cleanup:</span>
	<span class="p">{</span>
		<span class="cm">/* Free all allocated resources. */</span>
		<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">tmp_cdesc</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">){</span>
			<span class="n">tmp_cdesc</span> <span class="o">=</span> <span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free_cdesc</span><span class="p">(</span><span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">);</span>
			<span class="n">digest_ctx</span><span class="p">.</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="n">tmp_cdesc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">){</span>
			<span class="n">tmp_cdesc</span> <span class="o">=</span> <span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free_cdesc</span><span class="p">(</span><span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span><span class="p">);</span>
			<span class="n">csum_ctx</span><span class="p">.</span><span class="n">pad_descs</span> <span class="o">=</span> <span class="n">tmp_cdesc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">assert</span><span class="p">(</span><span class="n">cipher_ctx</span><span class="p">.</span><span class="n">pad_descs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* The ciphers are never padded. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">int_op</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">delete_internal_operation</span><span class="p">(</span><span class="o">*</span><span class="n">int_op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: done with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">failed</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_internal_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">*</span><span class="n">iop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>                      <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">alloc_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cd</span> <span class="o">=</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;delete_internal_operation: iop=0x%p, alloc_ptr=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="p">,</span> <span class="n">ptr</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_cdesc</span><span class="p">(</span><span class="n">cd</span><span class="p">);</span>
		<span class="n">cd</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cd</span> <span class="o">=</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_cdesc</span><span class="p">(</span><span class="n">cd</span><span class="p">);</span>
		<span class="n">cd</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MD5_MIN_PAD_LENGTH (9)</span>
<span class="cp">#define MD5_PAD_LENGTH_FIELD_LENGTH (8)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_md5_pad</span><span class="p">(</span><span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">hashed_length</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pad</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">pad_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span>                  <span class="n">padlen</span> <span class="o">=</span> <span class="n">MD5_BLOCK_LENGTH</span> <span class="o">-</span> <span class="p">(</span><span class="n">hashed_length</span> <span class="o">%</span> <span class="n">MD5_BLOCK_LENGTH</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span>  <span class="n">bit_length</span> <span class="o">=</span> <span class="n">hashed_length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padlen</span> <span class="o">&lt;</span> <span class="n">MD5_MIN_PAD_LENGTH</span><span class="p">)</span> <span class="n">padlen</span> <span class="o">+=</span> <span class="n">MD5_BLOCK_LENGTH</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">padlen</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_md5_pad: hashed_length=%lld bits == %lld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit_length</span><span class="p">,</span> <span class="n">hashed_length</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">padlen</span> <span class="o">-</span> <span class="n">MD5_PAD_LENGTH_FIELD_LENGTH</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bit_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit_length</span> <span class="o">%</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">bit_length</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pad_length</span> <span class="o">=</span> <span class="n">padlen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SHA1_MIN_PAD_LENGTH (9)</span>
<span class="cp">#define SHA1_PAD_LENGTH_FIELD_LENGTH (8)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_sha1_pad</span><span class="p">(</span><span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">hashed_length</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pad</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">pad_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span>                  <span class="n">padlen</span> <span class="o">=</span> <span class="n">SHA1_BLOCK_LENGTH</span> <span class="o">-</span> <span class="p">(</span><span class="n">hashed_length</span> <span class="o">%</span> <span class="n">SHA1_BLOCK_LENGTH</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span>  <span class="n">bit_length</span> <span class="o">=</span> <span class="n">hashed_length</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padlen</span> <span class="o">&lt;</span> <span class="n">SHA1_MIN_PAD_LENGTH</span><span class="p">)</span> <span class="n">padlen</span> <span class="o">+=</span> <span class="n">SHA1_BLOCK_LENGTH</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">padlen</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create_sha1_pad: hashed_length=%lld bits == %lld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit_length</span><span class="p">,</span> <span class="n">hashed_length</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">padlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bit_length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit_length</span> <span class="o">%</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">bit_length</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pad_length</span> <span class="o">=</span> <span class="n">padlen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">transform_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_transform_init</span> <span class="o">*</span><span class="n">tinit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_csum</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">csum_mode</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_csum_le</span>:
		<span class="k">case</span> <span class="n">cryptocop_csum_be</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: Bad mode set for csum transform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_mem2mem</span>:
	<span class="k">case</span> <span class="n">cryptocop_alg_md5</span>:
	<span class="k">case</span> <span class="n">cryptocop_alg_sha1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: non-zero keylength, %d, for a digest/csum algorithm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* This check is a bit strict. */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_des</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: keylen %d invalid for DES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_3des</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">192</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: keylen %d invalid for 3DES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_aes</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">192</span> <span class="o">&amp;&amp;</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: keylen %d invalid for AES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_no_alg</span>:
	<span class="nl">default:</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;transform_ok: no such algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">cryptocop_alg_des</span>:
	<span class="k">case</span> <span class="n">cryptocop_alg_3des</span>:
	<span class="k">case</span> <span class="n">cryptocop_alg_aes</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">tinit</span><span class="o">-&gt;</span><span class="n">cipher_mode</span> <span class="o">!=</span> <span class="n">cryptocop_cipher_mode_ecb</span> <span class="o">&amp;&amp;</span> <span class="n">tinit</span><span class="o">-&gt;</span><span class="n">cipher_mode</span> <span class="o">!=</span> <span class="n">cryptocop_cipher_mode_cbc</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		 <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cryptocop_new_session</span><span class="p">(</span><span class="n">cryptocop_session_id</span> <span class="o">*</span><span class="n">sid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_transform_init</span> <span class="o">*</span><span class="n">tinit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alloc_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span>         <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="o">*</span><span class="n">tfrm_in</span> <span class="o">=</span> <span class="n">tinit</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="o">*</span><span class="n">tmp_in</span><span class="p">;</span>
	<span class="kt">int</span>                              <span class="n">no_tfrms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>                              <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>                <span class="n">flags</span><span class="p">;</span>

	<span class="n">init_stream_coprocessor</span><span class="p">();</span> <span class="cm">/* For safety if we are called early */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tfrm_in</span><span class="p">){</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="o">++</span><span class="n">no_tfrms</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">transform_ok</span><span class="p">(</span><span class="n">tfrm_in</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_new_session, bad transform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tfrm_in</span> <span class="o">=</span> <span class="n">tfrm_in</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">no_tfrms</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_new_session, no transforms specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_session</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_new_session, kmalloc cryptocop_session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">no_tfrms</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_new_session, kmalloc cryptocop_transform_ctx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tfrm_in</span> <span class="o">=</span> <span class="n">tinit</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">no_tfrms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">tmp_in</span> <span class="o">=</span> <span class="n">tfrm_in</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp_in</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_in</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">tfrm_in</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_new_session, duplicate transform ids</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp_in</span> <span class="o">=</span> <span class="n">tmp_in</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">,</span> <span class="n">tfrm_in</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_transform_init</span><span class="p">));</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dec_key_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tfrm_in</span> <span class="o">=</span> <span class="n">tfrm_in</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">next_sid</span><span class="p">;</span>
	<span class="n">next_sid</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* TODO If we are really paranoid we should do duplicate check to handle sid wraparound.</span>
<span class="cm">	 *      OTOH 2^64 is a really large number of session. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">next_sid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">next_sid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Prepend to session list. */</span>
	<span class="n">sess</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cryptocop_sessions</span><span class="p">;</span>
	<span class="n">cryptocop_sessions</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cryptocop_free_session</span><span class="p">(</span><span class="n">cryptocop_session_id</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span>    <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span>          <span class="o">*</span><span class="n">sess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span>          <span class="o">*</span><span class="n">psess</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>                 <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>                               <span class="n">i</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">remove_list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span>                  <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span>         <span class="o">*</span><span class="n">pj</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_free_session: sid=%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sid</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cryptocop_sessions</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sess</span> <span class="o">&amp;&amp;</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">sid</span><span class="p">){</span>
		<span class="n">psess</span> <span class="o">=</span> <span class="n">sess</span><span class="p">;</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sess</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psess</span><span class="p">){</span>
			<span class="n">psess</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cryptocop_sessions</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Remove queued jobs. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cryptocop_prio_no_prios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">))){</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">==</span> <span class="n">sid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">list_move_tail</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remove_list</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remove_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>  <span class="cm">/* EAGAIN is not ideal for job/session terminated but it&#39;s the best choice I know of. */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_free_session: pj=0x%p, pj-&gt;oper=0x%p, pj-&gt;iop=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pj</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">));</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>
		<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tc</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">;</span>
	<span class="cm">/* Erase keying data. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tc</span><span class="p">){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_free_session: memset keys, tfrm id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tid</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CRYPTOCOP_MAX_KEY_LENGTH</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">dec_key</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">CRYPTOCOP_MAX_KEY_LENGTH</span><span class="p">);</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sess</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="nf">get_session</span><span class="p">(</span><span class="n">cryptocop_session_id</span> <span class="n">sid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span>    <span class="o">*</span><span class="n">sess</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>           <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sess</span> <span class="o">=</span> <span class="n">cryptocop_sessions</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sess</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sess</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">sid</span><span class="p">)){</span>
		<span class="n">sess</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="nf">get_transform_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_session</span> <span class="o">*</span><span class="n">sess</span><span class="p">,</span> <span class="n">cryptocop_tfrm_id</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">sess</span><span class="o">-&gt;</span><span class="n">tfrm_ctx</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_transform_ctx, sess=0x%p, tid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sess</span><span class="p">,</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">sess</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tc</span> <span class="o">&amp;&amp;</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tid</span> <span class="o">!=</span> <span class="n">tid</span><span class="p">){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;tc=0x%p, tc-&gt;next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">,</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;get_transform_ctx, returning tc=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">tc</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* The AES s-transform matrix (s-box). */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">aes_sbox</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">99</span><span class="p">,</span>  <span class="mi">124</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>   <span class="mi">103</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span>  <span class="mi">254</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span>
	<span class="mi">202</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span>  <span class="mi">71</span><span class="p">,</span>  <span class="mi">240</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span>
	<span class="mi">183</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>  <span class="mi">54</span><span class="p">,</span>  <span class="mi">63</span><span class="p">,</span>  <span class="mi">247</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span>  <span class="mi">165</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span>  <span class="mi">21</span><span class="p">,</span>
	<span class="mi">4</span><span class="p">,</span>   <span class="mi">199</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>  <span class="mi">195</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span>  <span class="mi">150</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>   <span class="mi">154</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>   <span class="mi">18</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>  <span class="mi">178</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span>
	<span class="mi">9</span><span class="p">,</span>   <span class="mi">131</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span>  <span class="mi">26</span><span class="p">,</span>  <span class="mi">27</span><span class="p">,</span>  <span class="mi">110</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span>  <span class="mi">160</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span>  <span class="mi">59</span><span class="p">,</span>  <span class="mi">214</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span>  <span class="mi">227</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>  <span class="mi">132</span><span class="p">,</span>
	<span class="mi">83</span><span class="p">,</span>  <span class="mi">209</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>   <span class="mi">237</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>  <span class="mi">252</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span>  <span class="mi">106</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>  <span class="mi">74</span><span class="p">,</span>  <span class="mi">76</span><span class="p">,</span>  <span class="mi">88</span><span class="p">,</span>  <span class="mi">207</span><span class="p">,</span>
	<span class="mi">208</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span>  <span class="mi">77</span><span class="p">,</span>  <span class="mi">51</span><span class="p">,</span>  <span class="mi">133</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span>  <span class="mi">249</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>   <span class="mi">127</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">159</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span>
	<span class="mi">81</span><span class="p">,</span>  <span class="mi">163</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>  <span class="mi">143</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span>  <span class="mi">245</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>  <span class="mi">255</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span>
	<span class="mi">205</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  <span class="mi">19</span><span class="p">,</span>  <span class="mi">236</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>  <span class="mi">151</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span>  <span class="mi">23</span><span class="p">,</span>  <span class="mi">196</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span>  <span class="mi">100</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span>  <span class="mi">25</span><span class="p">,</span>  <span class="mi">115</span><span class="p">,</span>
	<span class="mi">96</span><span class="p">,</span>  <span class="mi">129</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span>  <span class="mi">220</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span>  <span class="mi">42</span><span class="p">,</span>  <span class="mi">144</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>  <span class="mi">238</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>  <span class="mi">222</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>  <span class="mi">11</span><span class="p">,</span>  <span class="mi">219</span><span class="p">,</span>
	<span class="mi">224</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span>  <span class="mi">58</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">73</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>   <span class="mi">36</span><span class="p">,</span>  <span class="mi">92</span><span class="p">,</span>  <span class="mi">194</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span>  <span class="mi">145</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span>
	<span class="mi">231</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>  <span class="mi">109</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span>  <span class="mi">169</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span>  <span class="mi">244</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
	<span class="mi">186</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>  <span class="mi">46</span><span class="p">,</span>  <span class="mi">28</span><span class="p">,</span>  <span class="mi">166</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">116</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">189</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span>
	<span class="mi">112</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span>  <span class="mi">181</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>   <span class="mi">246</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>  <span class="mi">97</span><span class="p">,</span>  <span class="mi">53</span><span class="p">,</span>  <span class="mi">87</span><span class="p">,</span>  <span class="mi">185</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span>  <span class="mi">158</span><span class="p">,</span>
	<span class="mi">225</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>  <span class="mi">105</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">135</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span>  <span class="mi">40</span><span class="p">,</span>  <span class="mi">223</span><span class="p">,</span>
	<span class="mi">140</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span>  <span class="mi">191</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span>  <span class="mi">104</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span>  <span class="mi">153</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">176</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span>  <span class="mi">187</span><span class="p">,</span> <span class="mi">22</span>
<span class="p">};</span>

<span class="cm">/* AES has a 32 bit word round constants for each round in the</span>
<span class="cm"> * key schedule.  round_constant[i] is really Rcon[i+1] in FIPS187.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">round_constant</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x01000000</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">,</span> <span class="mh">0x08000000</span><span class="p">,</span>
	<span class="mh">0x10000000</span><span class="p">,</span> <span class="mh">0x20000000</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span>
	<span class="mh">0x1B000000</span><span class="p">,</span> <span class="mh">0x36000000</span><span class="p">,</span> <span class="mh">0x6C000000</span>
<span class="p">};</span>

<span class="cm">/* Apply the s-box to each of the four occtets in w. */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">aes_ks_subword</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_sbox</span><span class="p">[</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
	<span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_sbox</span><span class="p">[</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
	<span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_sbox</span><span class="p">[</span><span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
	<span class="n">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">aes_sbox</span><span class="p">[</span><span class="n">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]];</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* The encrypt (forward) Rijndael key schedule algorithm pseudo code:</span>
<span class="cm"> * (Note that AES words are 32 bit long)</span>
<span class="cm"> *</span>
<span class="cm"> * KeyExpansion(byte key[4*Nk], word w[Nb*(Nr+1)], Nk){</span>
<span class="cm"> * word temp</span>
<span class="cm"> * i = 0</span>
<span class="cm"> * while (i &lt; Nk) {</span>
<span class="cm"> *   w[i] = word(key[4*i, 4*i + 1, 4*i + 2, 4*i + 3])</span>
<span class="cm"> *   i = i + 1</span>
<span class="cm"> * }</span>
<span class="cm"> * i = Nk</span>
<span class="cm"> *</span>
<span class="cm"> * while (i &lt; (Nb * (Nr + 1))) {</span>
<span class="cm"> *   temp = w[i - 1]</span>
<span class="cm"> *   if ((i mod Nk) == 0) {</span>
<span class="cm"> *     temp = SubWord(RotWord(temp)) xor Rcon[i/Nk]</span>
<span class="cm"> *   }</span>
<span class="cm"> *   else if ((Nk &gt; 6) &amp;&amp; ((i mod Nk) == 4)) {</span>
<span class="cm"> *     temp = SubWord(temp)</span>
<span class="cm"> *   }</span>
<span class="cm"> *   w[i] = w[i - Nk] xor temp</span>
<span class="cm"> * }</span>
<span class="cm"> * RotWord(t) does a 8 bit cyclic shift left on a 32 bit word.</span>
<span class="cm"> * SubWord(t) applies the AES s-box individually to each octet</span>
<span class="cm"> * in a 32 bit word.</span>
<span class="cm"> *</span>
<span class="cm"> * For AES Nk can have the values 4, 6, and 8 (corresponding to</span>
<span class="cm"> * values for Nr of 10, 12, and 14).  Nb is always 4.</span>
<span class="cm"> *</span>
<span class="cm"> * To construct w[i], w[i - 1] and w[i - Nk] must be</span>
<span class="cm"> * available.  Consequently we must keep a state of the last Nk words</span>
<span class="cm"> * to be able to create the last round keys.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_aes_decrypt_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dec_key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span>  <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keylength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">w_ring</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* nk is max 8, use elements 0..(nk - 1) as a ringbuffer */</span>
	<span class="n">u8</span>  <span class="n">w_last_ix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">nr</span><span class="p">,</span> <span class="n">nk</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keylength</span><span class="p">){</span>
	<span class="k">case</span> <span class="mi">128</span>:
		<span class="n">nk</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192</span>:
		<span class="n">nk</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">256</span>:
		<span class="n">nk</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;stream co-processor: bad aes key length in get_aes_decrypt_key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="cm">/* Need to do host byte order correction here since key is byte oriented and the</span>
<span class="cm">	 * kx algorithm is word (u32) oriented. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nk</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">nk</span><span class="p">;</span>
	<span class="n">w_last_ix</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">nr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">w_ring</span><span class="p">[</span><span class="n">w_last_ix</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">nk</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* RotWord(temp) */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">aes_ks_subword</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">^=</span> <span class="n">round_constant</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">nk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">nk</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">nk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">aes_ks_subword</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">w_last_ix</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_last_ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">nk</span><span class="p">;</span> <span class="cm">/* This is the same as (i-Nk) mod Nk */</span>
		<span class="n">temp</span> <span class="o">^=</span> <span class="n">w_ring</span><span class="p">[</span><span class="n">w_last_ix</span><span class="p">];</span>
		<span class="n">w_ring</span><span class="p">[</span><span class="n">w_last_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

		<span class="cm">/* We need the round keys for round Nr+1 and Nr+2 (round key</span>
<span class="cm">		 * Nr+2 is the round key beyond the last one used when</span>
<span class="cm">		 * encrypting).  Rounds are numbered starting from 0, Nr=10</span>
<span class="cm">		 * implies 11 rounds are used in encryption/decryption.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">nr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Need to do host byte order correction here, the key</span>
<span class="cm">			 * is byte oriented. */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">dec_key</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">dec_key</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/**** Job/operation management. ****/</span>

<span class="kt">int</span> <span class="nf">cryptocop_job_queue_insert_csum</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cryptocop_job_queue_insert</span><span class="p">(</span><span class="n">cryptocop_prio_kernel_csum</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cryptocop_job_queue_insert_crypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cryptocop_job_queue_insert</span><span class="p">(</span><span class="n">cryptocop_prio_kernel</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cryptocop_job_queue_insert_user_job</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cryptocop_job_queue_insert</span><span class="p">(</span><span class="n">cryptocop_prio_user</span><span class="p">,</span> <span class="n">operation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_job_queue_insert</span><span class="p">(</span><span class="n">cryptocop_queue_priority</span> <span class="n">prio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                           <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span>     <span class="o">*</span><span class="n">pj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>             <span class="n">flags</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_insert(%d, 0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prio</span><span class="p">,</span> <span class="n">operation</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">operation</span> <span class="o">||</span> <span class="o">!</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_insert oper=0x%p, NULL operation or callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">cryptocop_job_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_insert: job setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">pj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">prio</span><span class="p">].</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Make sure a job is running */</span>
	<span class="n">cryptocop_start_job</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cryptocop_do_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">);</span>
<span class="n">DECLARE_TASKLET</span> <span class="p">(</span><span class="n">cryptocop_tasklet</span><span class="p">,</span> <span class="n">cryptocop_do_tasklet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryptocop_do_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>             <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span>    <span class="o">*</span><span class="n">pj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>                <span class="n">flags</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_do_tasklet: entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs</span><span class="p">)){</span>
			<span class="n">node</span> <span class="o">=</span> <span class="n">cryptocop_completed_jobs</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pj</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">assert</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="cm">/* Notify consumer of operation completeness. */</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_do_tasklet: callback 0x%p, data 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>

			<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Job is completed. */</span>
			<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>
			<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pj</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_do_tasklet: exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">dma_done_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span> <span class="o">*</span><span class="n">done_job</span><span class="p">;</span>
	<span class="n">reg_dma_rw_ack_intr</span> <span class="n">ack_intr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_ack_intr</span><span class="p">,</span> <span class="n">ack_intr</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop DMA done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryptocop_running_job</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;stream co-processor got interrupt when not busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">done_job</span> <span class="o">=</span> <span class="n">cryptocop_running_job</span><span class="p">;</span>
	<span class="n">cryptocop_running_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">);</span>

	<span class="cm">/* Start processing a job. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_process_lock</span><span class="p">)){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop irq handler, not starting a job</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cryptocop_start_job</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_process_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">done_job</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Job is completed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">done_job</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">fast_callback</span><span class="p">){</span>
		<span class="cm">/* This operation wants callback from interrupt. */</span>
		<span class="n">done_job</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">done_job</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">done_job</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>
		<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">done_job</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">done_job</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">done_job</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cryptocop_completed_jobs</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop leave irq handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Setup interrupts and DMA channels. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_cryptocop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>          <span class="n">flags</span><span class="p">;</span>
	<span class="n">reg_dma_rw_cfg</span>         <span class="n">dma_cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span>
	<span class="n">reg_dma_rw_intr_mask</span>   <span class="n">intr_mask_in</span> <span class="o">=</span> <span class="p">{.</span><span class="n">data</span> <span class="o">=</span> <span class="n">regk_dma_yes</span><span class="p">};</span> <span class="cm">/* Only want descriptor interrupts from the DMA in channel. */</span>
	<span class="n">reg_dma_rw_ack_intr</span>    <span class="n">ack_intr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,.</span><span class="n">in_eop</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">reg_strcop_rw_cfg</span>      <span class="n">strcop_cfg</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ipend</span> <span class="o">=</span> <span class="n">regk_strcop_little</span><span class="p">,</span>
		<span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ignore_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">DMA_IRQ</span><span class="p">,</span> <span class="n">dma_done_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&quot;stream co-processor DMA&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;request_irq stream co-processor irq dma9&quot;</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">crisv32_request_dma</span><span class="p">(</span><span class="n">OUT_DMA</span><span class="p">,</span> <span class="s">&quot;strcop&quot;</span><span class="p">,</span> <span class="n">DMA_PANIC_ON_ERROR</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">dma_strp</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">crisv32_request_dma</span><span class="p">(</span><span class="n">IN_DMA</span><span class="p">,</span> <span class="s">&quot;strcop&quot;</span><span class="p">,</span> <span class="n">DMA_PANIC_ON_ERROR</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">dma_strp</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset and enable the cryptocop. */</span>
	<span class="n">strcop_cfg</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">strcop</span><span class="p">,</span> <span class="n">regi_strcop</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">strcop_cfg</span><span class="p">);</span>
	<span class="n">strcop_cfg</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">strcop</span><span class="p">,</span> <span class="n">regi_strcop</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">strcop_cfg</span><span class="p">);</span>

	<span class="cm">/* Enable DMAs. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_cfg</span><span class="p">);</span> <span class="cm">/* input DMA */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_cfg</span><span class="p">);</span> <span class="cm">/* output DMA */</span>

	<span class="cm">/* Set up wordsize = 4 for DMAs. */</span>
	<span class="n">DMA_WR_CMD</span><span class="p">(</span><span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">regk_dma_set_w_size4</span><span class="p">);</span>
	<span class="n">DMA_WR_CMD</span><span class="p">(</span><span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">regk_dma_set_w_size4</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_intr_mask</span><span class="p">,</span> <span class="n">intr_mask_in</span><span class="p">);</span>

	<span class="cm">/* Clear intr ack. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_ack_intr</span><span class="p">,</span> <span class="n">ack_intr</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free used cryptocop hw resources (interrupt and DMA channels). */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_cryptocop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>          <span class="n">flags</span><span class="p">;</span>
	<span class="n">reg_dma_rw_cfg</span>         <span class="n">dma_cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">reg_dma_rw_intr_mask</span>   <span class="n">intr_mask_in</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">reg_dma_rw_ack_intr</span>    <span class="n">ack_intr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,.</span><span class="n">in_eop</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear intr ack. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_ack_intr</span><span class="p">,</span> <span class="n">ack_intr</span><span class="p">);</span>

	<span class="cm">/* Disable DMAs. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_cfg</span><span class="p">);</span> <span class="cm">/* input DMA */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_cfg</span><span class="p">);</span> <span class="cm">/* output DMA */</span>

	<span class="cm">/* Disable interrupts. */</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_intr_mask</span><span class="p">,</span> <span class="n">intr_mask_in</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">DMA_IRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">crisv32_free_dma</span><span class="p">(</span><span class="n">OUT_DMA</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">crisv32_free_dma</span><span class="p">(</span><span class="n">IN_DMA</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Init job queue. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_job_queue_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cryptocop_prio_no_prios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prio</span> <span class="o">=</span> <span class="p">(</span><span class="n">cryptocop_queue_priority</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryptocop_job_queue_close</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>               <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span>      <span class="o">*</span><span class="n">pj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>              <span class="n">process_flags</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>                            <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* FIXME: This is as yet untested code. */</span>

	<span class="cm">/* Stop strcop from getting an operation to process while we are closing the</span>
<span class="cm">	   module. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_process_lock</span><span class="p">,</span> <span class="n">process_flags</span><span class="p">);</span>

	<span class="cm">/* Empty the job queue. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cryptocop_prio_no_prios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">))){</span>
			<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

				<span class="cm">/* Call callback to notify consumer of job removal. */</span>
				<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_close: callback 0x%p, data 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>
				<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span> <span class="cm">/* Job is terminated without completion. */</span>
				<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>

				<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">pj</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_process_lock</span><span class="p">,</span> <span class="n">process_flags</span><span class="p">);</span>

	<span class="cm">/* Remove the running job, if any. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryptocop_running_job</span><span class="p">){</span>
		<span class="n">reg_strcop_rw_cfg</span> <span class="n">rw_cfg</span><span class="p">;</span>
		<span class="n">reg_dma_rw_cfg</span>    <span class="n">dma_out_cfg</span><span class="p">,</span> <span class="n">dma_in_cfg</span><span class="p">;</span>

		<span class="cm">/* Stop DMA. */</span>
		<span class="n">dma_out_cfg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">);</span>
		<span class="n">dma_out_cfg</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="n">regk_dma_no</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_out_cfg</span><span class="p">);</span>

		<span class="n">dma_in_cfg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">);</span>
		<span class="n">dma_in_cfg</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="n">regk_dma_no</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">dma_in_cfg</span><span class="p">);</span>

		<span class="cm">/* Disble the cryptocop. */</span>
		<span class="n">rw_cfg</span> <span class="o">=</span> <span class="n">REG_RD</span><span class="p">(</span><span class="n">strcop</span><span class="p">,</span> <span class="n">regi_strcop</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">);</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_WR</span><span class="p">(</span><span class="n">strcop</span><span class="p">,</span> <span class="n">regi_strcop</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">);</span>

		<span class="n">pj</span> <span class="o">=</span> <span class="n">cryptocop_running_job</span><span class="p">;</span>
		<span class="n">cryptocop_running_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Call callback to notify consumer of job removal. */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_close: callback 0x%p, data 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span> <span class="cm">/* Job is terminated without completion. */</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>

		<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pj</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Remove completed jobs, if any. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cryptocop_completed_jobs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="cm">/* Call callback to notify consumer of job removal. */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_close: callback 0x%p, data 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span> <span class="cm">/* Job is terminated without completion. */</span>
		<span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="p">,</span> <span class="n">pj</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">);</span>

		<span class="n">delete_internal_operation</span><span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">pj</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cryptocop_start_job</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                          <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_prio_job</span>    <span class="o">*</span><span class="n">pj</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>            <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span>            <span class="n">running_job_flags</span><span class="p">;</span>
	<span class="n">reg_strcop_rw_cfg</span>            <span class="n">rw_cfg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">ignore_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_start_job: entering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">running_job_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cryptocop_running_job</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="cm">/* Already running. */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_start_job: already running, exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">running_job_flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Check the queues in priority order. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">cryptocop_prio_kernel_csum</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">cryptocop_prio_no_prios</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">cryptocop_prio_no_prios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">running_job_flags</span><span class="p">);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_start_job: no jobs to run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* No jobs to run */</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;starting job for prio %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>

	<span class="cm">/* TODO: Do not starve lower priority jobs.  Let in a lower</span>
<span class="cm">	 * prio job for every N-th processed higher prio job or some</span>
<span class="cm">	 * other scheduling policy.  This could reasonably be</span>
<span class="cm">	 * tweakable since the optimal balance would depend on the</span>
<span class="cm">	 * type of load on the system. */</span>

	<span class="cm">/* Pull the DMA lists from the job and start the DMA client. */</span>
	<span class="n">pj</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">cryptocop_job_queues</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">jobs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cryptocop_running_job</span> <span class="o">=</span> <span class="n">pj</span><span class="p">;</span>

	<span class="cm">/* Set config register (3DES and CSUM modes). */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">tdes_mode</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_eee</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_eed</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_ede</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_edd</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_dee</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_ded</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_dde</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_e</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_3des_ddd</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td1</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td2</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">td3</span> <span class="o">=</span> <span class="n">regk_strcop_d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: bad 3DES mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">csum_mode</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">cryptocop_csum_le</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">ipend</span> <span class="o">=</span> <span class="n">regk_strcop_little</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">cryptocop_csum_be</span>:
		<span class="n">rw_cfg</span><span class="p">.</span><span class="n">ipend</span> <span class="o">=</span> <span class="n">regk_strcop_big</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_setup_dma_list: bad checksum mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">REG_WR</span><span class="p">(</span><span class="n">strcop</span><span class="p">,</span> <span class="n">regi_strcop</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">,</span> <span class="n">rw_cfg</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_start_job: starting DMA, new cryptocop_running_job=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;ctx_in: 0x%p, phys: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;ctx_out: 0x%p, phys: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">pj</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">),</span>
		     <span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">)));</span>

	<span class="cm">/* Start input DMA. */</span>
	<span class="n">flush_dma_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">);</span>
	<span class="n">DMA_START_CONTEXT</span><span class="p">(</span><span class="n">IN_DMA_INST</span><span class="p">,</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">));</span>

	<span class="cm">/* Start output DMA. */</span>
	<span class="n">DMA_START_CONTEXT</span><span class="p">(</span><span class="n">OUT_DMA_INST</span><span class="p">,</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pj</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">,</span> <span class="n">running_job_flags</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_start_job: exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_job_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_prio_job</span> <span class="o">**</span><span class="n">pj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">alloc_flag</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">?</span> <span class="n">GFP_ATOMIC</span> <span class="o">:</span> <span class="n">GFP_KERNEL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iop_alloc_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pj</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_prio_job</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">pj</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup: operation=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="p">));</span>

	<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">oper</span> <span class="o">=</span> <span class="n">operation</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup, cb=0x%p cb_data=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">oper</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">use_dmalists</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">print_user_dma_lists</span><span class="p">(</span><span class="o">&amp;</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">inlist</span> <span class="o">||</span> <span class="o">!</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">outlist</span> <span class="o">||</span> <span class="o">!</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">out_data_buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">in_data_buf</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup: bad indata (use_dmalists)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iop_alloc_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">DESCR_ALLOC_PAD</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">),</span> <span class="n">alloc_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iop_alloc_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup: kmalloc cryptocop_int_operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">iop_alloc_ptr</span> <span class="o">+</span> <span class="n">DESCR_ALLOC_PAD</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">,</span> <span class="n">ctx_out</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0000001F</span><span class="p">)</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">,</span> <span class="n">ctx_out</span><span class="p">));</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">memset</span><span class="p">((</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span><span class="p">)));</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">alloc_ptr</span> <span class="o">=</span> <span class="n">iop_alloc_ptr</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">tdes_mode</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">tdes_mode</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">csum_mode</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">csum_mode</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ddesc_out</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">outlist</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ddesc_in</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">inlist</span><span class="p">;</span>

		<span class="cm">/* Setup DMA contexts. */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">outlist</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data_buf</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">out_data_buf</span><span class="p">;</span>

		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">eol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">inlist</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data_buf</span> <span class="o">=</span> <span class="n">operation</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">.</span><span class="n">in_data_buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cryptocop_setup_dma_list</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">,</span> <span class="n">alloc_flag</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup: cryptocop_setup_dma_list failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">pj</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">print_dma_descriptors</span><span class="p">((</span><span class="o">*</span><span class="n">pj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iop</span><span class="p">));</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_setup, DMA list setup successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="n">CRYPTOCOP_MINOR</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span> <span class="o">*</span><span class="n">dev_next</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="p">){</span>
		<span class="n">dev_next</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">CRYPTOCOP_SESSION_ID_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">cryptocop_free_session</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_ioctl_close_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span>  <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span>  <span class="o">*</span><span class="n">prev_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_session_op</span>  <span class="o">*</span><span class="n">sess_op</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_session_op</span>  <span class="n">sop</span><span class="p">;</span>
	<span class="kt">int</span>                       <span class="n">err</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_close_session</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">sess_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sop</span><span class="p">,</span> <span class="n">sess_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">sop</span><span class="p">.</span><span class="n">ses_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prev_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_dev</span><span class="p">){</span>
			<span class="n">prev_dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cryptocop_free_session</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_close_session: session %lld not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">ses_id</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ioctl_process_job_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="n">cb_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ioctl_job_cb_ctx</span> <span class="o">*</span><span class="n">jc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ioctl_job_cb_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">cb_data</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ioctl_process_job_callback: op=0x%p, cb_data=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">cb_data</span><span class="p">));</span>

	<span class="n">jc</span><span class="o">-&gt;</span><span class="n">processed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_ioc_process_wq</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define CRYPTOCOP_IOCTL_CIPHER_TID  (1)</span>
<span class="cp">#define CRYPTOCOP_IOCTL_DIGEST_TID  (2)</span>
<span class="cp">#define CRYPTOCOP_IOCTL_CSUM_TID    (3)</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">first_cfg_change_ix</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span> <span class="o">*</span><span class="n">crp_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_cipher</span><span class="p">)</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_digest</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span> <span class="o">&lt;</span> <span class="n">ch_ix</span><span class="p">))</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_csum</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">&lt;</span> <span class="n">ch_ix</span><span class="p">))</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;first_cfg_change_ix: ix=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch_ix</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ch_ix</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">next_cfg_change_ix</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span> <span class="o">*</span><span class="n">crp_op</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tmp_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_cipher</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_start</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ch_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">cipher_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_digest</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">digest_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ix</span> <span class="o">&lt;</span> <span class="n">ch_ix</span><span class="p">)</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">tmp_ix</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">do_csum</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">&gt;</span> <span class="n">ix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp_ix</span> <span class="o">=</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">crp_op</span><span class="o">-&gt;</span><span class="n">csum_len</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_ix</span> <span class="o">&lt;</span> <span class="n">ch_ix</span><span class="p">)</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">tmp_ix</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_ix</span> <span class="o">==</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="n">ch_ix</span> <span class="o">=</span> <span class="n">ix</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;next_cfg_change_ix prev ix=%d, next ix=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ch_ix</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ch_ix</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Map map_length bytes from the pages starting on *pageix and *pageoffset to iovecs starting on *iovix.</span>
<span class="cm"> * Return -1 for ok, 0 for fail. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">map_pages_to_iovec</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iovlen</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iovix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nopages</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pageix</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pageoffset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">map_length</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmplen</span><span class="p">;</span>

	<span class="n">assert</span><span class="p">(</span><span class="n">iov</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">iovix</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">pages</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">pageix</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">pageoffset</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;map_pages_to_iovec, map_length=%d, iovlen=%d, *iovix=%d, nopages=%d, *pageix=%d, *pageoffset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map_length</span><span class="p">,</span> <span class="n">iovlen</span><span class="p">,</span> <span class="o">*</span><span class="n">iovix</span><span class="p">,</span> <span class="n">nopages</span><span class="p">,</span> <span class="o">*</span><span class="n">pageix</span><span class="p">,</span> <span class="o">*</span><span class="n">pageoffset</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">map_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;map_pages_to_iovec, map_length=%d, iovlen=%d, *iovix=%d, nopages=%d, *pageix=%d, *pageoffset=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map_length</span><span class="p">,</span> <span class="n">iovlen</span><span class="p">,</span> <span class="o">*</span><span class="n">iovix</span><span class="p">,</span> <span class="n">nopages</span><span class="p">,</span> <span class="o">*</span><span class="n">pageix</span><span class="p">,</span> <span class="o">*</span><span class="n">pageoffset</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iovix</span> <span class="o">&gt;=</span> <span class="n">iovlen</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;map_page_to_iovec: *iovix=%d &gt;= iovlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">iovix</span><span class="p">,</span> <span class="n">iovlen</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pageix</span> <span class="o">&gt;=</span> <span class="n">nopages</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;map_page_to_iovec: *pageix=%d &gt;= nopages=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pageix</span><span class="p">,</span> <span class="n">nopages</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iov</span><span class="p">[</span><span class="o">*</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="o">*</span><span class="n">pageix</span><span class="p">])</span> <span class="o">+</span> <span class="o">*</span><span class="n">pageoffset</span><span class="p">;</span>
		<span class="n">tmplen</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="o">*</span><span class="n">pageoffset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmplen</span> <span class="o">&lt;</span> <span class="n">map_length</span><span class="p">){</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pageoffset</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pageix</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmplen</span> <span class="o">=</span> <span class="n">map_length</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">pageoffset</span><span class="p">)</span> <span class="o">+=</span> <span class="n">map_length</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;mapping %d bytes from page %d (or %d) to iovec %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmplen</span><span class="p">,</span> <span class="o">*</span><span class="n">pageix</span><span class="p">,</span> <span class="o">*</span><span class="n">pageix</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">iovix</span><span class="p">));</span>
		<span class="n">iov</span><span class="p">[</span><span class="o">*</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">tmplen</span><span class="p">;</span>
		<span class="n">map_length</span> <span class="o">-=</span> <span class="n">tmplen</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">iovix</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;map_page_to_iovec, exit, *iovix=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">iovix</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_ioctl_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>                             <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span>        <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_crypto_op</span>         <span class="o">*</span><span class="n">crp_oper</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_crypto_op</span>         <span class="n">oper</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span>                             <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_operation</span>      <span class="o">*</span><span class="n">cop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ioctl_job_cb_ctx</span>         <span class="o">*</span><span class="n">jc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">page</span>                     <span class="o">**</span><span class="n">inpages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span>                     <span class="o">**</span><span class="n">outpages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>                             <span class="n">noinpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>                             <span class="n">nooutpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cryptocop_desc</span>           <span class="n">descs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span> <span class="cm">/* Max 5 descriptors are needed, there are three transforms that</span>
<span class="cm">						   * can get connected/disconnected on different places in the indata. */</span>
	<span class="k">struct</span> <span class="n">cryptocop_desc_cfg</span>       <span class="n">dcfgs</span><span class="p">[</span><span class="mi">5</span><span class="o">*</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span>                             <span class="n">desc_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>                             <span class="n">dcfg_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span>       <span class="n">ciph_tcfg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span>       <span class="n">digest_tcfg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span>       <span class="n">csum_tcfg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>                   <span class="o">*</span><span class="n">digest_result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span>                             <span class="n">digest_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>                             <span class="n">cblocklen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>                   <span class="n">csum_result</span><span class="p">[</span><span class="n">CSUM_BLOCK_LENGTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cryptocop_session</span>        <span class="o">*</span><span class="n">sess</span><span class="p">;</span>

	<span class="kt">int</span>    <span class="n">iovlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">iovix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">pageix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">pageoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">size_t</span> <span class="n">prev_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">next_ix</span><span class="p">;</span>

	<span class="kt">int</span>    <span class="n">cipher_active</span><span class="p">,</span> <span class="n">digest_active</span><span class="p">,</span> <span class="n">csum_active</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">end_digest</span><span class="p">,</span> <span class="n">end_csum</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">digest_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">cipher_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">csum_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">crp_oper</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span><span class="p">))){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: !access_ok crp_oper!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oper</span><span class="p">,</span> <span class="n">crp_oper</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: copy_from_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">print_strcop_crypto_op</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oper</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">!=</span> <span class="n">oper</span><span class="p">.</span><span class="n">ses_id</span><span class="p">)</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: session %lld not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">ses_id</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check buffers. */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">indata</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: user buffers wrapped around, bad user!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: !access_ok out data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">indata</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: !access_ok in data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cop</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">jc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ioctl_job_cb_ctx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">jc</span><span class="o">-&gt;</span><span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">cb_data</span> <span class="o">=</span> <span class="n">jc</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">cb</span> <span class="o">=</span> <span class="n">ioctl_process_job_callback</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">use_dmalists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">in_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">fast_callback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">incount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">inlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sess</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">ses_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sess</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: bad session id.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>                    <span class="n">cipher_outlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span>  <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">get_transform_ctx</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">CRYPTOCOP_IOCTL_CIPHER_TID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: no cipher transform in session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CIPHER_TID</span><span class="p">;</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">inject_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: bad cipher length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cblocklen</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">cryptocop_alg_aes</span> <span class="o">?</span> <span class="n">AES_BLOCK_LENGTH</span> <span class="o">:</span> <span class="n">DES_BLOCK_LENGTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span> <span class="o">%</span> <span class="n">cblocklen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: cipher inlength not multiple of block length.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cipher_outlen</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">cipher_mode</span> <span class="o">==</span> <span class="n">cryptocop_cipher_mode_cbc</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_explicit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTOCOP_EXPLICIT_IV</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">iv</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_iv</span><span class="p">,</span> <span class="n">cblocklen</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cipher_outlen</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span> <span class="o">-</span> <span class="n">cblocklen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_explicit</span><span class="p">){</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: explicit_iv when not CBC mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span> <span class="o">!=</span> <span class="n">cipher_outlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: cipher_outlen incorrect, should be %d not %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cipher_outlen</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">decrypt</span><span class="p">){</span>
			<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTOCOP_DECRYPT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CRYPTOCOP_ENCRYPT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ciph_tcfg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_digest</span><span class="p">){</span>
		<span class="k">struct</span> <span class="n">cryptocop_transform_ctx</span> <span class="o">*</span><span class="n">tc</span> <span class="o">=</span> <span class="n">get_transform_ctx</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">CRYPTOCOP_IOCTL_DIGEST_TID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: no digest transform in session.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">digest_length</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">alg</span> <span class="o">==</span> <span class="n">cryptocop_alg_md5</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">digest_result</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">digest_length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">digest_result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc digest_result</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">memset</span><span class="p">(</span><span class="n">digest_result</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">digest_length</span><span class="p">));</span>

		<span class="n">digest_tcfg</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_DIGEST_TID</span><span class="p">;</span>
		<span class="n">digest_tcfg</span><span class="p">.</span><span class="n">inject_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">inject_ix</span> <span class="o">+=</span> <span class="n">digest_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">digest_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: bad digest length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">digest_tcfg</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">digest_tcfg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_csum</span><span class="p">){</span>
		<span class="n">csum_tcfg</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CSUM_TID</span><span class="p">;</span>
		<span class="n">csum_tcfg</span><span class="p">.</span><span class="n">inject_ix</span> <span class="o">=</span> <span class="n">digest_length</span><span class="p">;</span>
		<span class="n">ciph_tcfg</span><span class="p">.</span><span class="n">inject_ix</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">csum_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: bad csum length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">csum_tcfg</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csum_tcfg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prev_ix</span> <span class="o">=</span> <span class="n">first_cfg_change_ix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oper</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">&gt;</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: length mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">nooutpages</span> <span class="o">=</span> <span class="n">noinpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: inlen=%d, cipher_outlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">));</span>

	<span class="cm">/* Map user pages for in and out data of the operation. */</span>
	<span class="n">noinpages</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">prev_ix</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prev_ix</span> <span class="o">+</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: noinpages=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">noinpages</span><span class="p">));</span>
	<span class="n">inpages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">noinpages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inpages</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc inpages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">nooutpages</span> <span class="o">=</span> <span class="n">noinpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span><span class="p">){</span>
		<span class="n">nooutpages</span> <span class="o">=</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: nooutpages=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nooutpages</span><span class="p">));</span>
		<span class="n">outpages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">nooutpages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span><span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outpages</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc outpages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">nooutpages</span> <span class="o">=</span> <span class="n">noinpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Acquire the mm page semaphore. */</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span>
			     <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">prev_ix</span><span class="p">),</span>
			     <span class="n">noinpages</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span>  <span class="cm">/* read access only for in data */</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="cm">/* no force */</span>
			     <span class="n">inpages</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="n">nooutpages</span> <span class="o">=</span> <span class="n">noinpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: get_user_pages indata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">noinpages</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span><span class="p">){</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">get_user_pages</span><span class="p">(</span><span class="n">current</span><span class="p">,</span>
				     <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span><span class="p">,</span>
				     <span class="n">nooutpages</span><span class="p">,</span>
				     <span class="mi">1</span><span class="p">,</span> <span class="cm">/* write access for out data */</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="cm">/* no force */</span>
				     <span class="n">outpages</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nooutpages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: get_user_pages outdata</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nooutpages</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add 6 to nooutpages to make room for possibly inserted buffers for storing digest and</span>
<span class="cm">	 * csum output and splits when units are (dis-)connected. */</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">noinpages</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="mi">6</span> <span class="o">+</span> <span class="n">nooutpages</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span> <span class="o">||</span> <span class="o">!</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: kmalloc iovecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">inlen</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span> <span class="o">-</span> <span class="n">prev_ix</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span><span class="p">)</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">+=</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_digest</span><span class="p">)</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">+=</span> <span class="n">digest_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_csum</span><span class="p">)</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Setup the in iovecs. */</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">incount</span> <span class="o">=</span> <span class="n">noinpages</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noinpages</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
		<span class="kt">size_t</span> <span class="n">tmplen</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">inlen</span><span class="p">;</span>

		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">prev_ix</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">inpages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">prev_ix</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
		<span class="n">tmplen</span> <span class="o">-=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">noinpages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">tmplen</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span> <span class="o">?</span> <span class="n">tmplen</span> <span class="o">:</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">inpages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">tmplen</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">inlen</span> <span class="o">-</span> <span class="n">prev_ix</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">page_address</span><span class="p">(</span><span class="n">inpages</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)(</span><span class="n">oper</span><span class="p">.</span><span class="n">indata</span> <span class="o">+</span> <span class="n">prev_ix</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iovlen</span> <span class="o">=</span> <span class="n">nooutpages</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">pageoffset</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span> <span class="o">?</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_outdata</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">next_ix</span> <span class="o">=</span> <span class="n">next_cfg_change_ix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oper</span><span class="p">,</span> <span class="n">prev_ix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">==</span> <span class="n">next_ix</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: length configuration broken.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  <span class="cm">/* This should be impossible barring bugs. */</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">!=</span> <span class="n">next_ix</span><span class="p">){</span>
		<span class="n">end_digest</span> <span class="o">=</span> <span class="n">end_csum</span> <span class="o">=</span> <span class="n">cipher_active</span> <span class="o">=</span> <span class="n">digest_active</span> <span class="o">=</span> <span class="n">csum_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">next_ix</span> <span class="o">-</span> <span class="n">prev_ix</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">&lt;</span> <span class="n">next_ix</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CIPHER_TID</span><span class="p">;</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">cryptocop_source_dma</span><span class="p">;</span>
			<span class="n">cipher_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">next_ix</span> <span class="o">==</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">cipher_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_len</span><span class="p">)){</span>
				<span class="n">cipher_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span><span class="p">;</span>
			<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">];</span>
			<span class="o">++</span><span class="n">dcfg_ix</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_digest</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">&lt;</span> <span class="n">next_ix</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">digest_len</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">digest_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_DIGEST_TID</span><span class="p">;</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">cryptocop_source_dma</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_ix</span> <span class="o">==</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">digest_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">digest_len</span><span class="p">)){</span>
				<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">digest_done</span><span class="p">);</span>
				<span class="n">digest_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span><span class="p">;</span>
			<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">];</span>
			<span class="o">++</span><span class="n">dcfg_ix</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_csum</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">&lt;</span> <span class="n">next_ix</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_ix</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">csum_len</span><span class="p">))){</span>
			<span class="n">csum_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CSUM_TID</span><span class="p">;</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">cryptocop_source_dma</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_ix</span> <span class="o">==</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">csum_start</span> <span class="o">+</span> <span class="n">oper</span><span class="p">.</span><span class="n">csum_len</span><span class="p">)){</span>
				<span class="n">csum_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span><span class="p">;</span>
			<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dcfgs</span><span class="p">[</span><span class="n">dcfg_ix</span><span class="p">];</span>
			<span class="o">++</span><span class="n">dcfg_ix</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">cfg</span><span class="p">){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: data segment %d (%d to %d) had no active transforms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc_ix</span><span class="p">,</span> <span class="n">prev_ix</span><span class="p">,</span> <span class="n">next_ix</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">++</span><span class="n">desc_ix</span><span class="p">;</span>
		<span class="n">prev_ix</span> <span class="o">=</span> <span class="n">next_ix</span><span class="p">;</span>
		<span class="n">next_ix</span> <span class="o">=</span> <span class="n">next_cfg_change_ix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oper</span><span class="p">,</span> <span class="n">prev_ix</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc_ix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">descs</span><span class="p">[</span><span class="n">desc_ix</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">descs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_digest</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: mapping %d byte digest output to iovec %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">digest_length</span><span class="p">,</span> <span class="n">iovix</span><span class="p">));</span>
		<span class="cm">/* Add outdata iovec, length == &lt;length of type of digest&gt; */</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">digest_result</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">digest_length</span><span class="p">;</span>
		<span class="o">++</span><span class="n">iovix</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_csum</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add outdata iovec, length == 2, the length of csum. */</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: mapping 2 byte csum output to iovec %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iovix</span><span class="p">));</span>
		<span class="cm">/* Add outdata iovec, length == &lt;length of type of digest&gt; */</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">csum_result</span><span class="p">;</span>
		<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">iovix</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">++</span><span class="n">iovix</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_pages_to_iovec</span><span class="p">(</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">,</span> <span class="n">iovlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iovix</span><span class="p">,</span> <span class="n">outpages</span><span class="p">,</span> <span class="n">nooutpages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pageix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pageoffset</span><span class="p">,</span> <span class="n">oper</span><span class="p">.</span><span class="n">cipher_outlen</span><span class="p">)){</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: failed to map pages to iovec.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="cm">/* This should be impossible barring bugs. */</span>
			<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: setting cop-&gt;tfrm_op.outcount %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iovix</span><span class="p">));</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span> <span class="o">=</span> <span class="n">iovix</span><span class="p">;</span>
	<span class="n">assert</span><span class="p">(</span><span class="n">iovix</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">nooutpages</span> <span class="o">+</span> <span class="mi">6</span><span class="p">));</span>

	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">oper</span><span class="p">.</span><span class="n">ses_id</span><span class="p">;</span>
	<span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">descs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: inserting job, cb_data=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cb_data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cryptocop_job_queue_insert_user_job</span><span class="p">(</span><span class="n">cop</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: insert job %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: begin wait for result</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">cryptocop_ioc_process_wq</span><span class="p">,</span> <span class="p">(</span><span class="n">jc</span><span class="o">-&gt;</span><span class="n">processed</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: end wait for result</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jc</span><span class="o">-&gt;</span><span class="n">processed</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cryptocop_ioctl_process: job not processed at completion</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Job process done.  Cipher output should already be correct in job so no post processing of outdata. */</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: operation_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_digest</span><span class="p">){</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: copy %d bytes digest to user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">digest_length</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">crp_oper</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span><span class="p">,</span> <span class="n">digest</span><span class="p">),</span> <span class="n">digest_result</span><span class="p">,</span> <span class="n">digest_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: copy_to_user, digest length %d, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">digest_length</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oper</span><span class="p">.</span><span class="n">do_csum</span><span class="p">){</span>
			<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: copy 2 bytes checksum to user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">crp_oper</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span><span class="p">,</span> <span class="n">csum</span><span class="p">),</span> <span class="n">csum_result</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">){</span>
				<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: copy_to_user, csum, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">));</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error_cleanup</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: returning err = operation_status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">error_cleanup:</span>
	<span class="cm">/* Release page caches. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">noinpages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">inpages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nooutpages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="kt">int</span> <span class="n">spdl_err</span><span class="p">;</span>
		<span class="cm">/* Mark output pages dirty. */</span>
		<span class="n">spdl_err</span> <span class="o">=</span> <span class="n">set_page_dirty_lock</span><span class="p">(</span><span class="n">outpages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">spdl_err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_process: set_page_dirty_lock returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spdl_err</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nooutpages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">outpages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">digest_result</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">inpages</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">outpages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cop</span><span class="p">){</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cop</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">jc</span><span class="p">);</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">print_lock_status</span><span class="p">());</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cryptocop_ioctl_create_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cryptocop_session_id</span>             <span class="n">sid</span><span class="p">;</span>
	<span class="kt">int</span>                              <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_private</span>         <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_session_op</span>         <span class="o">*</span><span class="n">sess_op</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strcop_session_op</span>         <span class="n">sop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="o">*</span><span class="n">tis</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="n">ti_cipher</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="n">ti_digest</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">cryptocop_transform_init</span>  <span class="n">ti_csum</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">sess_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sop</span><span class="p">,</span> <span class="n">sess_op</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_session_op</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">cryptocop_cipher_none</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">keylen</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_create_session, sess_op:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">cipher:%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;</span><span class="se">\t</span><span class="s">cipher_mode:%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;</span><span class="se">\t</span><span class="s">digest:%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;</span><span class="se">\t</span><span class="s">csum:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sop</span><span class="p">.</span><span class="n">cipher</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sop</span><span class="p">.</span><span class="n">cmode</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sop</span><span class="p">.</span><span class="n">digest</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sop</span><span class="p">.</span><span class="n">csum</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">cryptocop_cipher_none</span><span class="p">){</span>
		<span class="cm">/* Init the cipher. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">cipher</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_cipher_des</span>:
			<span class="n">ti_cipher</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_des</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_cipher_3des</span>:
			<span class="n">ti_cipher</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_3des</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_cipher_aes</span>:
			<span class="n">ti_cipher</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_aes</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, bad cipher algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">cipher</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setting cipher transform %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ti_cipher</span><span class="p">.</span><span class="n">alg</span><span class="p">));</span>
		<span class="n">copy_from_user</span><span class="p">(</span><span class="n">ti_cipher</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">keylen</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">ti_cipher</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">sop</span><span class="p">.</span><span class="n">keylen</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">cmode</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_cipher_mode_cbc</span>:
		<span class="k">case</span> <span class="n">cryptocop_cipher_mode_ecb</span>:
			<span class="n">ti_cipher</span><span class="p">.</span><span class="n">cipher_mode</span> <span class="o">=</span> <span class="n">sop</span><span class="p">.</span><span class="n">cmode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, bad cipher mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">cmode</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl_create_session: setting CBC mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ti_cipher</span><span class="p">.</span><span class="n">cipher_mode</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">des3_mode</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_3des_eee</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_eed</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_ede</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_edd</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_dee</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_ded</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_dde</span>:
		<span class="k">case</span> <span class="n">cryptocop_3des_ddd</span>:
			<span class="n">ti_cipher</span><span class="p">.</span><span class="n">tdes_mode</span> <span class="o">=</span> <span class="n">sop</span><span class="p">.</span><span class="n">des3_mode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, bad 3DES mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">des3_mode</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ti_cipher</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CIPHER_TID</span><span class="p">;</span>
		<span class="n">ti_cipher</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">tis</span><span class="p">;</span>
		<span class="n">tis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ti_cipher</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* if (sop.cipher != cryptocop_cipher_none) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">digest</span> <span class="o">!=</span> <span class="n">cryptocop_digest_none</span><span class="p">){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setting digest transform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">digest</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_digest_md5</span>:
			<span class="n">ti_digest</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_md5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">cryptocop_digest_sha1</span>:
			<span class="n">ti_digest</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_sha1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, bad digest algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">digest</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ti_digest</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_DIGEST_TID</span><span class="p">;</span>
		<span class="n">ti_digest</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">tis</span><span class="p">;</span>
		<span class="n">tis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ti_digest</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* if (sop.digest != cryptocop_digest_none) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">csum</span> <span class="o">!=</span> <span class="n">cryptocop_csum_none</span><span class="p">){</span>
		<span class="n">DEBUG</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;setting csum transform</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sop</span><span class="p">.</span><span class="n">csum</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">cryptocop_csum_le</span>:
		<span class="k">case</span> <span class="n">cryptocop_csum_be</span>:
			<span class="n">ti_csum</span><span class="p">.</span><span class="n">csum_mode</span> <span class="o">=</span> <span class="n">sop</span><span class="p">.</span><span class="n">csum</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, bad checksum algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sop</span><span class="p">.</span><span class="n">csum</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ti_csum</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cryptocop_alg_csum</span><span class="p">;</span>
		<span class="n">ti_csum</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">CRYPTOCOP_IOCTL_CSUM_TID</span><span class="p">;</span>
		<span class="n">ti_csum</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">tis</span><span class="p">;</span>
		<span class="n">tis</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ti_csum</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* (sop.csum != cryptocop_csum_none) */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_private</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">){</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, alloc dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cryptocop_new_session</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="n">tis</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">DEBUG</span><span class="p">({</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;create session, cryptocop_new_session %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);});</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sess_op</span><span class="o">-&gt;</span><span class="n">ses_id</span> <span class="o">=</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">cryptocop_ioctl_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ETRAXCRYPTOCOP_IOCTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl: wrong type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CRYPTOCOP_IO_MAXNR</span><span class="p">){</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Access check of the argument.  Some commands, e.g. create session and process op,</span>
<span class="cm">	   needs additional checks.  Those are handled in the command handling functions. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_READ</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_WRITE</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CRYPTOCOP_IO_CREATE_SESSION</span>:
		<span class="k">return</span> <span class="n">cryptocop_ioctl_create_session</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CRYPTOCOP_IO_CLOSE_SESSION</span>:
		<span class="k">return</span> <span class="n">cryptocop_ioctl_close_session</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CRYPTOCOP_IO_PROCESS_OP</span>:
		<span class="k">return</span> <span class="n">cryptocop_ioctl_process</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">DEBUG_API</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_ioctl: unknown command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">cryptocop_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
       <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
       <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

       <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_mutex</span><span class="p">);</span>
       <span class="n">ret</span> <span class="o">=</span> <span class="n">cryptocop_ioctl_unlocked</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
       <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_mutex</span><span class="p">);</span>

       <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef LDEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_dma_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_int_operation</span> <span class="o">*</span><span class="n">iop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cdesc_out</span> <span class="o">=</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_dma_desc</span> <span class="o">*</span><span class="n">cdesc_in</span> <span class="o">=</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="p">;</span>
	<span class="kt">int</span>                       <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_dma_descriptors start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;iop:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">sid: 0x%lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">cdesc_out: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_out</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">cdesc_in: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">cdesc_in</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">ddesc_out: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ddesc_out</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">ddesc_in: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ddesc_in</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">iop-&gt;ctx_out: 0x%p phys: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;</span><span class="se">\t</span><span class="s">saved_data: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;</span><span class="se">\t</span><span class="s">saved_data_buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_out</span><span class="p">.</span><span class="n">saved_data_buf</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">iop-&gt;ctx_in: 0x%p phys: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;</span><span class="se">\t</span><span class="s">saved_data: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;</span><span class="se">\t</span><span class="s">saved_data_buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data</span><span class="p">,</span>
	       <span class="n">iop</span><span class="o">-&gt;</span><span class="n">ctx_in</span><span class="p">.</span><span class="n">saved_data_buf</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cdesc_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_descr_data</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cdesc_out %d, desc=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">virt_to_phys(desc): 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">));</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">after: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">md: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flags:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">wait:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">eol:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">outeop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">ineop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">intr:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">out_eop</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">in_eop</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="n">cdesc_out</span> <span class="o">=</span> <span class="n">cdesc_out</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cdesc_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_descr_data</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cdesc_in %d, desc=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">virt_to_phys(desc): 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">));</span>
		<span class="n">td</span> <span class="o">=</span> <span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">dma_descr</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">after: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">md: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flags:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">wait:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">eol:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">outeop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">ineop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">intr:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">out_eop</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">in_eop</span><span class="p">,</span>
		       <span class="n">td</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="n">cdesc_in</span> <span class="o">=</span> <span class="n">cdesc_in</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_dma_descriptors end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_strcop_crypto_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">strcop_crypto_op</span> <span class="o">*</span><span class="n">cop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_strcop_crypto_op, 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="p">);</span>

	<span class="cm">/* Indata. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;indata=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;inlen=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;do_cipher=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;decrypt=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;cipher_explicit=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;cipher_start=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;cipher_len=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;outdata=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;outlen=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">indata</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">inlen</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">do_cipher</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">decrypt</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cipher_explicit</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cipher_start</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cipher_len</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cipher_outdata</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">cipher_outlen</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;do_digest=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;digest_start=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;digest_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">do_digest</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">digest_start</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">digest_len</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;do_csum=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;csum_start=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;csum_len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">do_csum</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">csum_start</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">csum_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_cryptocop_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_operation</span> <span class="o">*</span><span class="n">cop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cryptocop_desc</span>      <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_tfrm_cfg</span>  <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cryptocop_desc_cfg</span>  <span class="o">*</span><span class="n">dc</span><span class="p">;</span>
	<span class="kt">int</span>                        <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_cryptocop_operation, cop=0x%p</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sid: %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;operation_status=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;use_dmalists=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;in_interrupt=%d</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;fast_callback=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">operation_status</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">use_dmalists</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">in_interrupt</span><span class="p">,</span>
	       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">fast_callback</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">use_dmalists</span><span class="p">){</span>
		<span class="n">print_user_dma_lists</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cop</span><span class="o">-&gt;</span><span class="n">list_op</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cop-&gt;tfrm_op</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;tfrm_cfg=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;desc=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;indata=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;incount=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;inlen=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;outdata=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;outcount=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;outlen=%d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">desc</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">incount</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">inlen</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">,</span>
		       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outlen</span><span class="p">);</span>

		<span class="n">tc</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">tfrm_cfg</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tc</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;tfrm_cfg, 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;tid=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;flags=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;inject_ix=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tc</span><span class="p">,</span>
			       <span class="n">tc</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
			       <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			       <span class="n">tc</span><span class="o">-&gt;</span><span class="n">inject_ix</span><span class="p">,</span>
			       <span class="n">tc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="n">tc</span> <span class="o">=</span> <span class="n">tc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">desc</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">d</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">======================desc, 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;length=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;cfg=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">d</span><span class="p">,</span>
			       <span class="n">d</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			       <span class="n">d</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">,</span>
			       <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="n">dc</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dc</span><span class="p">){</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;=========desc_cfg, 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;tid=%d</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;src=%d</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;last=%d</span><span class="se">\n</span><span class="s">&quot;</span>
				       <span class="s">&quot;next=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dc</span><span class="p">,</span>
				       <span class="n">dc</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
				       <span class="n">dc</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
				       <span class="n">dc</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">,</span>
				       <span class="n">dc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
				<span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">====iniov</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">incount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;indata[%d]</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;base=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span>
			       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">indata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">====outiov</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;outdata[%d]</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;base=0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span>
			       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_base</span><span class="p">,</span>
			       <span class="n">cop</span><span class="o">-&gt;</span><span class="n">tfrm_op</span><span class="p">.</span><span class="n">outdata</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;------------end print_cryptocop_operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_user_dma_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">cryptocop_dma_list_operation</span> <span class="o">*</span><span class="n">dma_op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_descr_data</span> <span class="o">*</span><span class="n">dd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;print_user_dma_lists, dma_op=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_op</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;out_data_buf = 0x%p, phys_to_virt(out_data_buf) = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">out_data_buf</span><span class="p">,</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">out_data_buf</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;in_data_buf = 0x%p, phys_to_virt(in_data_buf) = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">in_data_buf</span><span class="p">,</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">in_data_buf</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;##############outlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">outlist</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;#%d phys_to_virt(desc) 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">after: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">md: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flags:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">wait:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">eol:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">outeop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">ineop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">intr:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">out_eop</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">in_eop</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">)</span>
			<span class="n">dd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dd</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;##############inlist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dd</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dma_op</span><span class="o">-&gt;</span><span class="n">inlist</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;#%d phys_to_virt(desc) 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">buf: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">after: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">md: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">next: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">after</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">md</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flags:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">wait:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">eol:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">outeop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">ineop:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;</span><span class="se">\t</span><span class="s">intr:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">out_eop</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">in_eop</span><span class="p">,</span>
		       <span class="n">dd</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">eol</span><span class="p">)</span>
			<span class="n">dd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dd</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_lock_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;**********************print_lock_status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_completed_jobs_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_job_queue_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;descr_pool_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_sessions_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="n">cryptocop_sessions_lock</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;running_job_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="n">running_job_lock</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cryptocop_process_lock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spin_is_locked</span><span class="p">(</span><span class="n">cryptocop_process_lock</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* LDEBUG */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cryptocop_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;ETRAX FS stream co-processor&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_stream_coprocessor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ETRAX FS stream co-processor driver v0.01, (c) 2003 Axis Communications AB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="n">CRYPTOCOP_MAJOR</span><span class="p">,</span> <span class="n">cryptocop_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cryptocop_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;stream co-processor: could not get major number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">init_cryptocop</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">CRYPTOCOP_MAJOR</span><span class="p">,</span> <span class="n">cryptocop_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cryptocop_job_queue_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_cryptocop</span><span class="p">();</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">CRYPTOCOP_MAJOR</span><span class="p">,</span> <span class="n">cryptocop_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Init the descriptor pool. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CRYPTOCOP_DESCRIPTOR_POOL_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">descr_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">from_pool</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">descr_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">descr_pool</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">descr_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">from_pool</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">descr_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">descr_pool_free_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">descr_pool</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">descr_pool_no_free</span> <span class="o">=</span> <span class="n">CRYPTOCOP_DESCRIPTOR_POOL_SIZE</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_completed_jobs_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_job_queue_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descr_pool_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_sessions_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">running_job_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cryptocop_process_lock</span><span class="p">);</span>

	<span class="n">cryptocop_sessions</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">next_sid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cryptocop_running_job</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;stream co-processor: init done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_stream_coprocessor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_cryptocop</span><span class="p">();</span>
	<span class="n">cryptocop_job_queue_close</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_stream_coprocessor</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_stream_coprocessor</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
