<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › cris › arch-v32 › mm › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Set up paging and the MMU.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2003, Axis Communications AB.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:   Bjorn Wesen &lt;bjornw@axis.com&gt;</span>
<span class="cm"> *            Tobias Anderberg &lt;tobiasa@axis.com&gt;, CRISv32 port.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;asm/mmu.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;arch/hwregs/asm/mmu_defs_asm.h&gt;</span>
<span class="cp">#include &lt;arch/hwregs/supp_reg.h&gt;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">tlb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The kernel is already mapped with linear mapping at kseg_c so there&#39;s no</span>
<span class="cm"> * need to map it with a page table. However, head.S also temporarily mapped it</span>
<span class="cm"> * at kseg_4 thus the ksegs are set up again. Also clear the TLB and do various</span>
<span class="cm"> * other paging stuff.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">cris_mmu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_kbase_hi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmu_kbase_lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mmu_page_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the current pgd table points to something sane, even if it</span>
<span class="cm">	 * is most probably not used until the next switch_mm.</span>
<span class="cm">	 */</span>
	<span class="n">per_cpu</span><span class="p">(</span><span class="n">current_pgd</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">())</span> <span class="o">=</span> <span class="n">init_mm</span><span class="p">.</span><span class="n">pgd</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">{</span>
		<span class="n">pgd_t</span> <span class="o">**</span><span class="n">pgd</span><span class="p">;</span>
		<span class="n">pgd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pgd_t</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">current_pgd</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
		<span class="n">SUPP_BANK_SEL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_TLB_PGD</span><span class="p">,</span> <span class="n">pgd</span><span class="p">);</span>
		<span class="n">SUPP_BANK_SEL</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_TLB_PGD</span><span class="p">,</span> <span class="n">pgd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Initialise the TLB. Function found in tlb.c. */</span>
	<span class="n">tlb_init</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable exceptions and initialize the kernel segments.</span>
<span class="cm">	 * See head.S for differences between ARTPEC-3 and ETRAX FS.</span>
<span class="cm">	 */</span>
	<span class="n">mmu_config</span> <span class="o">=</span> <span class="p">(</span> <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">we</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>        <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>       <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>        <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span>       <span class="o">|</span>
<span class="cp">#ifdef CONFIG_CRIS_MACH_ARTPEC3</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_f</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_e</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_d</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#else</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_f</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_e</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_d</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
<span class="cp">#endif</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_c</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_b</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#ifndef CONFIG_ETRAX_VCS_SIM</span>
                       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_a</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
<span class="cp">#else</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_a</span><span class="p">,</span> <span class="n">linear</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_9</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_8</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_7</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_6</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_5</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_4</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_3</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_2</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>   <span class="o">|</span>
		       <span class="n">REG_STATE</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_cfg</span><span class="p">,</span> <span class="n">seg_0</span><span class="p">,</span> <span class="n">page</span><span class="p">));</span>

	<span class="cm">/* See head.S for differences between ARTPEC-3 and ETRAX FS. */</span>
	<span class="n">mmu_kbase_hi</span> <span class="o">=</span> <span class="p">(</span> <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_f</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#ifdef CONFIG_CRIS_MACH_ARTPEC3</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_e</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_d</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#else</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_e</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_d</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
                         <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_c</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_b</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#ifndef CONFIG_ETRAX_VCS_SIM</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_a</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#else</span>
                         <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_a</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_9</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_hi</span><span class="p">,</span> <span class="n">base_8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">));</span>

	<span class="n">mmu_kbase_lo</span> <span class="o">=</span> <span class="p">(</span> <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_7</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_5</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_2</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_kbase_lo</span><span class="p">,</span> <span class="n">base_0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">));</span>

	<span class="n">mmu_page_id</span> <span class="o">=</span> <span class="n">REG_FIELD</span><span class="p">(</span><span class="n">mmu</span><span class="p">,</span> <span class="n">rw_mm_tlb_hi</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Update the instruction MMU. */</span>
	<span class="n">SUPP_BANK_SEL</span><span class="p">(</span><span class="n">BANK_IM</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_CFG</span><span class="p">,</span> <span class="n">mmu_config</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_KBASE_HI</span><span class="p">,</span> <span class="n">mmu_kbase_hi</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_KBASE_LO</span><span class="p">,</span> <span class="n">mmu_kbase_lo</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_TLB_HI</span><span class="p">,</span> <span class="n">mmu_page_id</span><span class="p">);</span>

	<span class="cm">/* Update the data MMU. */</span>
	<span class="n">SUPP_BANK_SEL</span><span class="p">(</span><span class="n">BANK_DM</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_CFG</span><span class="p">,</span> <span class="n">mmu_config</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_KBASE_HI</span><span class="p">,</span> <span class="n">mmu_kbase_hi</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_KBASE_LO</span><span class="p">,</span> <span class="n">mmu_kbase_lo</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_MM_TLB_HI</span><span class="p">,</span> <span class="n">mmu_page_id</span><span class="p">);</span>

	<span class="n">SPEC_REG_WR</span><span class="p">(</span><span class="n">SPEC_REG_PID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MMU has been enabled ever since head.S but just to make it</span>
<span class="cm">	 * totally obvious enable it here as well.</span>
<span class="cm">	 */</span>
	<span class="n">SUPP_BANK_SEL</span><span class="p">(</span><span class="n">BANK_GC</span><span class="p">);</span>
	<span class="n">SUPP_REG_WR</span><span class="p">(</span><span class="n">RW_GC_CFG</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span> <span class="cm">/* IMMU, DMMU, ICache, DCache on */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">paging_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">zones_size</span><span class="p">[</span><span class="n">MAX_NR_ZONES</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Setting up paging and the MMU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear out the init_mm.pgd that will contain the kernel&#39;s mappings. */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PTRS_PER_PGD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">swapper_pg_dir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">__pgd</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">cris_mmu_init</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the bad page table and bad page to point to a couple of</span>
<span class="cm">	 * allocated pages.</span>
<span class="cm">	 */</span>
	<span class="n">empty_zero_page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">alloc_bootmem_pages</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">empty_zero_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* All pages are DMA&#39;able in Etrax, so put all in the DMA&#39;able zone. */</span>
	<span class="n">zones_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">high_memory</span> <span class="o">-</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_ZONES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">zones_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use free_area_init_node instead of free_area_init, because it is</span>
<span class="cm">	 * designed for systems where the DRAM starts at an address</span>
<span class="cm">	 * substantially higher than 0, like us (we start at PAGE_OFFSET). This</span>
<span class="cm">	 * saves space in the mem_map page array.</span>
<span class="cm">	 */</span>
	<span class="n">free_area_init_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">zones_size</span><span class="p">,</span> <span class="n">PAGE_OFFSET</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mem_map</span> <span class="o">=</span> <span class="n">contig_page_data</span><span class="p">.</span><span class="n">node_mem_map</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
