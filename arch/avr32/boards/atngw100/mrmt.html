<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › avr32 › boards › atngw100 › mrmt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mrmt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Board-specific setup code for Remote Media Terminal 1 (RMT1)</span>
<span class="cm"> * add-on board for the ATNGW100 Network Gateway</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Mediama Technologies</span>
<span class="cm"> * Based on ATNGW100 Network Gateway (Copyright (C) Atmel)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/gpio_keys.h&gt;</span>
<span class="cp">#include &lt;linux/atmel_serial.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/spi/ads7846.h&gt;</span>

<span class="cp">#include &lt;video/atmel_lcdc.h&gt;</span>
<span class="cp">#include &lt;sound/atmel-ac97c.h&gt;</span>

<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cp">#include &lt;mach/at32ap700x.h&gt;</span>
<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/init.h&gt;</span>
<span class="cp">#include &lt;mach/portmux.h&gt;</span>

<span class="cm">/* Define board-specifoic GPIO assignments */</span>
<span class="cp">#define PIN_LCD_BL	GPIO_PIN_PA(28)</span>
<span class="cp">#define PWM_CH_BL	0	</span><span class="cm">/* Must match with GPIO pin definition */</span><span class="cp"></span>
<span class="cp">#define PIN_LCD_DISP	GPIO_PIN_PA(31)</span>
<span class="cp">#define	PIN_AC97_RST_N	GPIO_PIN_PA(30)</span>
<span class="cp">#define PB_EXTINT_BASE	25</span>
<span class="cp">#define TS_IRQ		0</span>
<span class="cp">#define PIN_TS_EXTINT	GPIO_PIN_PB(PB_EXTINT_BASE+TS_IRQ)</span>
<span class="cp">#define PIN_PB_LEFT	GPIO_PIN_PB(11)</span>
<span class="cp">#define PIN_PB_RIGHT	GPIO_PIN_PB(12)</span>
<span class="cp">#define PIN_PWR_SW_N	GPIO_PIN_PB(14)</span>
<span class="cp">#define PIN_PWR_ON	GPIO_PIN_PB(13)</span>
<span class="cp">#define PIN_ZB_RST_N	GPIO_PIN_PA(21)</span>
<span class="cp">#define PIN_BT_RST	GPIO_PIN_PA(22)</span>
<span class="cp">#define PIN_LED_SYS	GPIO_PIN_PA(16)</span>
<span class="cp">#define PIN_LED_A	GPIO_PIN_PA(19)</span>
<span class="cp">#define PIN_LED_B	GPIO_PIN_PE(19)</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_LCD_LQ043T3DX0X</span>
<span class="cm">/* Sharp LQ043T3DX0x (or compatible) panel */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">__initdata</span> <span class="n">lcd_fb_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;480x272 @ 59.94Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mf">59.94</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">272</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="mi">9000</span><span class="p">),</span>

		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">41</span><span class="p">,</span>		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="n">__initdata</span> <span class="n">lcd_fb_default_monspecs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">manufacturer</span>		<span class="o">=</span> <span class="s">&quot;SHA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">monitor</span>		<span class="o">=</span> <span class="s">&quot;LQ043T3DX02&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">modedb</span>			<span class="o">=</span> <span class="n">lcd_fb_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">modedb_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcd_fb_modes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">hfmin</span>			<span class="o">=</span> <span class="mi">14915</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfmax</span>			<span class="o">=</span> <span class="mi">17638</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmin</span>			<span class="o">=</span> <span class="mi">53</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmax</span>			<span class="o">=</span> <span class="mi">61</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dclkmax</span>		<span class="o">=</span> <span class="mi">9260000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="n">__initdata</span> <span class="n">rmt_lcdc_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">default_bpp</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_dmacon</span>		<span class="o">=</span> <span class="n">ATMEL_LCDC_DMAEN</span> <span class="o">|</span> <span class="n">ATMEL_LCDC_DMA2DEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_lcdcon2</span>	<span class="o">=</span> <span class="p">(</span><span class="n">ATMEL_LCDC_DISTYPE_TFT</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_CLKMOD_ALWAYSACTIVE</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_INVCLK_NORMAL</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_MEMOR_BIG</span><span class="p">),</span>
	<span class="p">.</span><span class="n">lcd_wiring_mode</span>	<span class="o">=</span> <span class="n">ATMEL_LCDC_WIRING_RGB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_monspecs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcd_fb_default_monspecs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">guard_time</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_LCD_KWH043GM08</span>
<span class="cm">/* Sharp KWH043GM08-Fxx (or compatible) panel */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_videomode</span> <span class="n">__initdata</span> <span class="n">lcd_fb_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;480x272 @ 59.94Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mf">59.94</span><span class="p">,</span>
		<span class="p">.</span><span class="n">xres</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">,</span>		<span class="p">.</span><span class="n">yres</span>		<span class="o">=</span> <span class="mi">272</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixclock</span>	<span class="o">=</span> <span class="n">KHZ2PICOS</span><span class="p">(</span><span class="mi">9000</span><span class="p">),</span>

		<span class="p">.</span><span class="n">left_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>		<span class="p">.</span><span class="n">right_margin</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">upper_margin</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>		<span class="p">.</span><span class="n">lower_margin</span>	<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_len</span>	<span class="o">=</span> <span class="mi">41</span><span class="p">,</span>		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vmode</span>		<span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="n">__initdata</span> <span class="n">lcd_fb_default_monspecs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">manufacturer</span>		<span class="o">=</span> <span class="s">&quot;FOR&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">monitor</span>		<span class="o">=</span> <span class="s">&quot;KWH043GM08&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">modedb</span>			<span class="o">=</span> <span class="n">lcd_fb_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">modedb_len</span>		<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lcd_fb_modes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">hfmin</span>			<span class="o">=</span> <span class="mi">14915</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hfmax</span>			<span class="o">=</span> <span class="mi">17638</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmin</span>			<span class="o">=</span> <span class="mi">53</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vfmax</span>			<span class="o">=</span> <span class="mi">61</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dclkmax</span>		<span class="o">=</span> <span class="mi">9260000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="n">__initdata</span> <span class="n">rmt_lcdc_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">default_bpp</span>		<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_dmacon</span>		<span class="o">=</span> <span class="n">ATMEL_LCDC_DMAEN</span> <span class="o">|</span> <span class="n">ATMEL_LCDC_DMA2DEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_lcdcon2</span>	<span class="o">=</span> <span class="p">(</span><span class="n">ATMEL_LCDC_DISTYPE_TFT</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_CLKMOD_ALWAYSACTIVE</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_INVCLK_INVERTED</span>
				   <span class="o">|</span> <span class="n">ATMEL_LCDC_MEMOR_BIG</span><span class="p">),</span>
	<span class="p">.</span><span class="n">lcd_wiring_mode</span>	<span class="o">=</span> <span class="n">ATMEL_LCDC_WIRING_RGB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_monspecs</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">lcd_fb_default_monspecs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">guard_time</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_AC97</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97c_platform_data</span> <span class="n">__initdata</span> <span class="n">ac97c0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset_pin</span>		<span class="o">=</span> <span class="n">PIN_AC97_RST_N</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_UCB1400_TS</span>
<span class="cm">/* NOTE: IRQ assignment relies on kernel module parameter */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">rmt_ts_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ucb1400_ts&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_BL_PWM</span>
<span class="cm">/* PWM LEDs: LCD Backlight, etc */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led</span> <span class="n">rmt_pwm_led</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* here the &quot;gpio&quot; is actually a PWM channel */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;backlight&quot;</span><span class="p">,</span>	<span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">PWM_CH_BL</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gpio_led_platform_data</span> <span class="n">rmt_pwm_led_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_leds</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rmt_pwm_led</span><span class="p">),</span>
	<span class="p">.</span><span class="n">leds</span>		<span class="o">=</span> <span class="n">rmt_pwm_led</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">rmt_pwm_led_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;leds-atmel-pwm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rmt_pwm_led_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_ADS7846_TS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ads7846_pendown_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span> <span class="n">PIN_TS_EXTINT</span> <span class="p">);</span>	<span class="cm">/* PENIRQ.*/</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ads7846_platform_data</span> <span class="n">ads_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">model</span>				<span class="o">=</span> <span class="mi">7846</span><span class="p">,</span>
	<span class="p">.</span><span class="n">keep_vref_on</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Use external VREF pin */</span>
	<span class="p">.</span><span class="n">vref_delay_usecs</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vref_mv</span>			<span class="o">=</span> <span class="mi">3300</span><span class="p">,</span>	<span class="cm">/* VREF = 3.3V */</span>
	<span class="p">.</span><span class="n">settle_delay_usecs</span>		<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">penirq_recheck_delay_usecs</span>	<span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
	<span class="p">.</span><span class="n">x_plate_ohms</span>			<span class="o">=</span> <span class="mi">750</span><span class="p">,</span>
	<span class="p">.</span><span class="n">y_plate_ohms</span>			<span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pressure_max</span>			<span class="o">=</span> <span class="mi">4096</span><span class="p">,</span>
	<span class="p">.</span><span class="n">debounce_max</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">debounce_rep</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">debounce_tol</span>			<span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_pendown_state</span>		<span class="o">=</span> <span class="n">ads7846_pendown_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">filter</span>				<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">filter_init</span>			<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="n">spi01_board_info</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">modalias</span>	<span class="o">=</span> <span class="s">&quot;ads7846&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_speed_hz</span>	<span class="o">=</span> <span class="mi">31250</span><span class="o">*</span><span class="mi">26</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus_num</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_select</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">platform_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ads_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">AT32_EXTINT</span><span class="p">(</span><span class="n">TS_IRQ</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* GPIO Keys: left, right, power, etc */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpio_keys_button</span> <span class="n">rmt_gpio_keys_buttons</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_POWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">PIN_PWR_SW_N</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;power button&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_LEFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">PIN_PB_LEFT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;left button&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">EV_KEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">KEY_RIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gpio</span>		<span class="o">=</span> <span class="n">PIN_PB_RIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">active_low</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>		<span class="o">=</span> <span class="s">&quot;right button&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpio_keys_platform_data</span> <span class="n">rmt_gpio_keys_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nbuttons</span> <span class="o">=</span>	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rmt_gpio_keys_buttons</span><span class="p">),</span>
	<span class="p">.</span><span class="n">buttons</span> <span class="o">=</span>	<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">rmt_gpio_keys_buttons</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">rmt_gpio_keys</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;gpio-keys&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span> <span class="o">=</span>		<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rmt_gpio_keys_data</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_RTC_I2C</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">__initdata</span> <span class="n">mrmt1_i2c_rtc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;s35390a&quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">),</span>
	<span class="p">.</span><span class="n">irq</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mrmt_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PWR_ON=0 will force power off */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span> <span class="n">PIN_PWR_ON</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mrmt1_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gpio_set_value</span><span class="p">(</span> <span class="n">PIN_PWR_ON</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>	<span class="cm">/* Ensure PWR_ON is enabled */</span>

	<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">mrmt_power_off</span><span class="p">;</span>

	<span class="cm">/* Setup USARTS (other than console) */</span>
	<span class="n">at32_map_usart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* USART 2: /dev/ttyS1, RMT1:DB9M */</span>
	<span class="n">at32_map_usart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ATMEL_USART_RTS</span> <span class="o">|</span> <span class="n">ATMEL_USART_CTS</span><span class="p">);</span>
			<span class="cm">/* USART 3: /dev/ttyS2, RMT1:Wireless, w/ RTS/CTS */</span>
	<span class="n">at32_add_device_usart</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">at32_add_device_usart</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Select GPIO Key pins */</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_PWR_SW_N</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_PB_LEFT</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_PB_RIGHT</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmt_gpio_keys</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_RTC_I2C</span>
	<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mrmt1_i2c_rtc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_BOARD_MRMT_LCD_DISABLE</span>
	<span class="cm">/* User &quot;alternate&quot; LCDC inferface on Port E &amp; D */</span>
	<span class="cm">/* NB: exclude LCDC_CC pin, as NGW100 reserves it for other use */</span>
	<span class="n">at32_add_device_lcdc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmt_lcdc_data</span><span class="p">,</span>
		<span class="n">fbmem_start</span><span class="p">,</span> <span class="n">fbmem_size</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ATMEL_LCDC_ALT_24BIT</span> <span class="o">|</span> <span class="n">ATMEL_LCDC_PE_DVAL</span> <span class="p">)</span> <span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_AC97</span>
	<span class="n">at32_add_device_ac97c</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97c0_data</span><span class="p">,</span> <span class="n">AC97C_BOTH</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_ADS7846_TS</span>
	<span class="cm">/* Select the Touchscreen interrupt pin mode */</span>
	<span class="n">at32_select_periph</span><span class="p">(</span> <span class="n">GPIO_PIOB_BASE</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PB_EXTINT_BASE</span><span class="o">+</span><span class="n">TS_IRQ</span><span class="p">),</span>
			<span class="n">GPIO_PERIPH_A</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">AT32_EXTINT</span><span class="p">(</span><span class="n">TS_IRQ</span><span class="p">),</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">);</span>
	<span class="n">at32_spi_setup_slaves</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">spi01_board_info</span><span class="p">,</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spi01_board_info</span><span class="p">));</span>
	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">spi01_board_info</span><span class="p">,</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">spi01_board_info</span><span class="p">));</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_UCB1400_TS</span>
	<span class="cm">/* Select the Touchscreen interrupt pin mode */</span>
	<span class="n">at32_select_periph</span><span class="p">(</span> <span class="n">GPIO_PIOB_BASE</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PB_EXTINT_BASE</span><span class="o">+</span><span class="n">TS_IRQ</span><span class="p">),</span>
			<span class="n">GPIO_PERIPH_A</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmt_ts_device</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_LCD_DISP</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_LCD_DISP</span><span class="p">,</span> <span class="s">&quot;LCD_DISP&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_LCD_DISP</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>	<span class="cm">/* LCD DISP */</span>
<span class="cp">#ifdef CONFIG_BOARD_MRMT_LCD_DISABLE</span>
	<span class="cm">/* Keep Backlight and DISP off */</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="s">&quot;LCD_BL&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>		<span class="cm">/* Backlight */</span>
<span class="cp">#else</span>
	<span class="n">gpio_set_value</span><span class="p">(</span> <span class="n">PIN_LCD_DISP</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>	<span class="cm">/* DISP asserted first */</span>
<span class="cp">#ifdef CONFIG_BOARD_MRMT_BL_PWM</span>
	<span class="cm">/* Use PWM for Backlight controls */</span>
	<span class="n">at32_add_device_pwm</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PWM_CH_BL</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmt_pwm_led_dev</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cm">/* Backlight always on */</span>
	<span class="n">udelay</span><span class="p">(</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="s">&quot;LCD_BL&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_LCD_BL</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="cm">/* Make sure BT and Zigbee modules in reset */</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_BT_RST</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_BT_RST</span><span class="p">,</span> <span class="s">&quot;BT_RST&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_BT_RST</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="cm">/* BT Module in Reset */</span>

	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_ZB_RST_N</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_ZB_RST_N</span><span class="p">,</span> <span class="s">&quot;ZB_RST_N&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_ZB_RST_N</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
	<span class="cm">/* XBee Module in Reset */</span>

<span class="cp">#ifdef CONFIG_BOARD_MRMT_WIRELESS_ZB</span>
	<span class="n">udelay</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">);</span>
	<span class="cm">/* Unreset the XBee Module */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span> <span class="n">PIN_ZB_RST_N</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_BOARD_MRMT_WIRELESS_BT</span>
	<span class="n">udelay</span><span class="p">(</span> <span class="mi">1000</span> <span class="p">);</span>
	<span class="cm">/* Unreset the BT Module */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span> <span class="n">PIN_BT_RST</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">mrmt1_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mrmt1_early_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* To maintain power-on signal in case boot loader did not already */</span>
	<span class="n">at32_select_gpio</span><span class="p">(</span> <span class="n">PIN_PWR_ON</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span> <span class="p">);</span>
	<span class="n">gpio_request</span><span class="p">(</span> <span class="n">PIN_PWR_ON</span><span class="p">,</span> <span class="s">&quot;PIN_PWR_ON&quot;</span> <span class="p">);</span>
	<span class="n">gpio_direction_output</span><span class="p">(</span> <span class="n">PIN_PWR_ON</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">mrmt1_early_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
