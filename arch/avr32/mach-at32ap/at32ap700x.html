<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › avr32 › mach-at32ap › at32ap700x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>at32ap700x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2005-2006 Atmel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dw_dmac.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/usb/atmel_usba_udc.h&gt;</span>

<span class="cp">#include &lt;mach/atmel-mci.h&gt;</span>
<span class="cp">#include &lt;linux/atmel-mci.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;mach/at32ap700x.h&gt;</span>
<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/hmatrix.h&gt;</span>
<span class="cp">#include &lt;mach/portmux.h&gt;</span>
<span class="cp">#include &lt;mach/sram.h&gt;</span>

<span class="cp">#include &lt;sound/atmel-abdac.h&gt;</span>
<span class="cp">#include &lt;sound/atmel-ac97c.h&gt;</span>

<span class="cp">#include &lt;video/atmel_lcdc.h&gt;</span>

<span class="cp">#include &quot;clock.h&quot;</span>
<span class="cp">#include &quot;pio.h&quot;</span>
<span class="cp">#include &quot;pm.h&quot;</span>


<span class="cp">#define PBMEM(base)					\</span>
<span class="cp">	{						\</span>
<span class="cp">		.start		= base,			\</span>
<span class="cp">		.end		= base + 0x3ff,		\</span>
<span class="cp">		.flags		= IORESOURCE_MEM,	\</span>
<span class="cp">	}</span>
<span class="cp">#define IRQ(num)					\</span>
<span class="cp">	{						\</span>
<span class="cp">		.start		= num,			\</span>
<span class="cp">		.end		= num,			\</span>
<span class="cp">		.flags		= IORESOURCE_IRQ,	\</span>
<span class="cp">	}</span>
<span class="cp">#define NAMED_IRQ(num, _name)				\</span>
<span class="cp">	{						\</span>
<span class="cp">		.start		= num,			\</span>
<span class="cp">		.end		= num,			\</span>
<span class="cp">		.name		= _name,		\</span>
<span class="cp">		.flags		= IORESOURCE_IRQ,	\</span>
<span class="cp">	}</span>

<span class="cm">/* REVISIT these assume *every* device supports DMA, but several</span>
<span class="cm"> * don&#39;t ... tc, smc, pio, rtc, watchdog, pwm, ps2, and more.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFINE_DEV(_name, _id)					\</span>
<span class="cp">static u64 _name##_id##_dma_mask = DMA_BIT_MASK(32);		\</span>
<span class="cp">static struct platform_device _name##_id##_device = {		\</span>
<span class="cp">	.name		= #_name,				\</span>
<span class="cp">	.id		= _id,					\</span>
<span class="cp">	.dev		= {					\</span>
<span class="cp">		.dma_mask = &amp;_name##_id##_dma_mask,		\</span>
<span class="cp">		.coherent_dma_mask = DMA_BIT_MASK(32),		\</span>
<span class="cp">	},							\</span>
<span class="cp">	.resource	= _name##_id##_resource,		\</span>
<span class="cp">	.num_resources	= ARRAY_SIZE(_name##_id##_resource),	\</span>
<span class="cp">}</span>
<span class="cp">#define DEFINE_DEV_DATA(_name, _id)				\</span>
<span class="cp">static u64 _name##_id##_dma_mask = DMA_BIT_MASK(32);		\</span>
<span class="cp">static struct platform_device _name##_id##_device = {		\</span>
<span class="cp">	.name		= #_name,				\</span>
<span class="cp">	.id		= _id,					\</span>
<span class="cp">	.dev		= {					\</span>
<span class="cp">		.dma_mask = &amp;_name##_id##_dma_mask,		\</span>
<span class="cp">		.platform_data	= &amp;_name##_id##_data,		\</span>
<span class="cp">		.coherent_dma_mask = DMA_BIT_MASK(32),		\</span>
<span class="cp">	},							\</span>
<span class="cp">	.resource	= _name##_id##_resource,		\</span>
<span class="cp">	.num_resources	= ARRAY_SIZE(_name##_id##_resource),	\</span>
<span class="cp">}</span>

<span class="cp">#define select_peripheral(port, pin_mask, periph, flags)	\</span>
<span class="cp">	at32_select_periph(GPIO_##port##_BASE, pin_mask,	\</span>
<span class="cp">			   GPIO_##periph, flags)</span>

<span class="cp">#define DEV_CLK(_name, devname, bus, _index)			\</span>
<span class="cp">static struct clk devname##_##_name = {				\</span>
<span class="cp">	.name		= #_name,				\</span>
<span class="cp">	.dev		= &amp;devname##_device.dev,		\</span>
<span class="cp">	.parent		= &amp;bus##_clk,				\</span>
<span class="cp">	.mode		= bus##_clk_mode,			\</span>
<span class="cp">	.get_rate	= bus##_clk_get_rate,			\</span>
<span class="cp">	.index		= _index,				\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pm_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">osc_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">at32_board_osc_rates</span><span class="p">[</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pll_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span><span class="p">,</span> <span class="n">mul</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PLLDIV</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mul</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PLLMUL</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">+</span> <span class="n">div</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">*=</span> <span class="n">mul</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">pll_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="o">*</span><span class="n">pll_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mul</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mul_best_fit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div_min</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div_max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div_best_fit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pll_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate_error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate_error_prev</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Rate must be between 80 MHz and 200 Mhz. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">80000000UL</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">200000000UL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">PM_BF</span><span class="p">(</span><span class="n">PLLOPT</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* PLL input frequency must be between 6 MHz and 32 MHz. */</span>
	<span class="n">div_min</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">32000000UL</span><span class="p">);</span>
	<span class="n">div_max</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="mi">6000000UL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div_max</span> <span class="o">&lt;</span> <span class="n">div_min</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">div</span> <span class="o">=</span> <span class="n">div_min</span><span class="p">;</span> <span class="n">div</span> <span class="o">&lt;=</span> <span class="n">div_max</span><span class="p">;</span> <span class="n">div</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll_in</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">div</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">mul</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">+</span> <span class="n">pll_in</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pll_in</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mul</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">actual</span> <span class="o">=</span> <span class="n">pll_in</span> <span class="o">*</span> <span class="n">mul</span><span class="p">;</span>
		<span class="n">rate_error</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">actual</span> <span class="o">-</span> <span class="n">rate</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate_error</span> <span class="o">&lt;</span> <span class="n">rate_error_prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mul_best_fit</span> <span class="o">=</span> <span class="n">mul</span><span class="p">;</span>
			<span class="n">div_best_fit</span> <span class="o">=</span> <span class="n">div</span><span class="p">;</span>
			<span class="n">rate_error_prev</span> <span class="o">=</span> <span class="n">rate_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate_error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">div_best_fit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BF</span><span class="p">(</span><span class="n">PLLMUL</span><span class="p">,</span> <span class="n">mul_best_fit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BF</span><span class="p">(</span><span class="n">PLLDIV</span><span class="p">,</span> <span class="n">div_best_fit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BF</span><span class="p">(</span><span class="n">PLLCOUNT</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">osc1</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLOSC</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pll_ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pll0_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pll_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pll1_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PLLMUL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PLLDIV</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;clk %s: failed to enable, rate not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLEN</span><span class="p">);</span>
		<span class="n">pm_writel</span><span class="p">(</span><span class="n">PLL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

		<span class="cm">/* Wait for PLL lock. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">ISR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">LOCK1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">LOCK1</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;clk %s: timeout waiting for lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLEN</span><span class="p">);</span>
		<span class="n">pm_writel</span><span class="p">(</span><span class="n">PLL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pll1_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pll_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">pll1_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">actual_rate</span><span class="p">;</span>

	<span class="n">actual_rate</span> <span class="o">=</span> <span class="n">pll_set_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apply</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">actual_rate</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;clk %s: new rate %lu (actual rate %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">actual_rate</span><span class="p">);</span>
		<span class="n">pm_writel</span><span class="p">(</span><span class="n">PLL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">actual_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pll1_set_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL1</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLEN</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLOSC</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">osc1</span><span class="p">)</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLOSC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pm_writel</span><span class="p">(</span><span class="n">PLL1</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The AT32AP7000 has five primary clock sources: One 32kHz</span>
<span class="cm"> * oscillator, two crystal oscillators and two PLLs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc32k</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;osc32k&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">osc_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;osc0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">osc_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">osc1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;osc1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">osc_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">pll0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pll0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pll0_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">pll1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pll1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pll1_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pll1_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">pll1_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">pll1_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The main clock can be either osc0 or pll0.  The boot loader may</span>
<span class="cm"> * have chosen one for us, so we don&#39;t really know which one until we</span>
<span class="cm"> * have a look at the SM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">main_clock</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronous clocks are generated from the main clock. The clocks</span>
<span class="cm"> * must satisfy the constraint</span>
<span class="cm"> *   fCPU &gt;= fHSB &gt;= fPB</span>
<span class="cm"> * i.e. each clock must not be faster than its parent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">bus_clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">main_clock</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">main_clock</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpu_clk_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CPU_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">CPU_MASK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cpu_clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cksel</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cksel</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksel</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">CPUDIV</span><span class="p">))</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">CPUSEL</span><span class="p">,</span> <span class="n">cksel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bus_clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">cpu_clk_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_rate</span><span class="p">,</span> <span class="n">child_div</span><span class="p">,</span> <span class="n">actual_rate</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">parent_rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">HSBDIV</span><span class="p">))</span>
		<span class="n">child_div</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">HSBSEL</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">child_div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">parent_rate</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">child_div</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">actual_rate</span> <span class="o">=</span> <span class="n">parent_rate</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">CPUDIV</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpusel</span><span class="p">;</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_rate</span> <span class="o">+</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="n">child_div</span><span class="p">)</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">child_div</span><span class="p">;</span>
		<span class="n">cpusel</span> <span class="o">=</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">fls</span><span class="p">(</span><span class="n">div</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">CPUDIV</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_BFINS</span><span class="p">(</span><span class="n">CPUSEL</span><span class="p">,</span> <span class="n">cpusel</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="n">actual_rate</span> <span class="o">=</span> <span class="n">parent_rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">cpusel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;clk %s: new rate %lu (actual rate %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">actual_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apply</span><span class="p">)</span>
		<span class="n">pm_writel</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">actual_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hsb_clk_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">HSB_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">HSB_MASK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">hsb_clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cksel</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cksel</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksel</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">HSBDIV</span><span class="p">))</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">HSBSEL</span><span class="p">,</span> <span class="n">cksel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bus_clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pba_clk_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PBA_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">PBA_MASK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pba_clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cksel</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cksel</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksel</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PBADIV</span><span class="p">))</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PBASEL</span><span class="p">,</span> <span class="n">cksel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bus_clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pbb_clk_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">PBB_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">PBB_MASK</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pbb_clk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cksel</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cksel</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">CKSEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksel</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PBBDIV</span><span class="p">))</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">PBBSEL</span><span class="p">,</span> <span class="n">cksel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bus_clk_get_rate</span><span class="p">(</span><span class="n">clk</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">cpu_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">cpu_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">cpu_clk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">hsb_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hsb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">hsb_clk_get_rate</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">pba_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pba&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">hsb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pba_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">pbb_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pbb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">hsb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Generic Clock operations</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">genclk_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">CEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">CEN</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">genclk_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">DIVEN</span><span class="p">))</span>
		<span class="n">div</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">PM_BFEXT</span><span class="p">(</span><span class="n">DIV</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">genclk_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apply</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parent_rate</span><span class="p">,</span> <span class="n">actual_rate</span><span class="p">,</span> <span class="n">div</span><span class="p">;</span>

	<span class="n">parent_rate</span> <span class="o">=</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">parent_rate</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">actual_rate</span> <span class="o">=</span> <span class="n">parent_rate</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">DIVEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent_rate</span> <span class="o">+</span> <span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rate</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">control</span> <span class="o">=</span> <span class="n">PM_BFINS</span><span class="p">(</span><span class="n">DIV</span><span class="p">,</span> <span class="n">div</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">|</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">DIVEN</span><span class="p">);</span>
		<span class="n">actual_rate</span> <span class="o">=</span> <span class="n">parent_rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk %s: new rate %lu (actual rate %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">actual_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apply</span><span class="p">)</span>
		<span class="n">pm_writel</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">actual_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">genclk_set_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk %s: new parent %s (was %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">clk</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">osc1</span> <span class="o">||</span> <span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pll1</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">OSCSEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">osc0</span> <span class="o">||</span> <span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pll0</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">OSCSEL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pll0</span> <span class="o">||</span> <span class="n">parent</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pll1</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLSEL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLSEL</span><span class="p">);</span>

	<span class="n">pm_writel</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">control</span><span class="p">);</span>
	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">genclk_init_parent</span><span class="p">(</span><span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">pm_readl</span><span class="p">(</span><span class="n">GCCTRL</span><span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">OSCSEL</span><span class="p">))</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLSEL</span><span class="p">))</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pll1</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">osc1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLSEL</span><span class="p">))</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">pll0</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">;</span>

	<span class="n">clk</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dw_dma_platform_data</span> <span class="n">dw_dmac0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">nr_channels</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">dw_dmac0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xff200000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">dw_dmac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">hclk</span><span class="p">,</span> <span class="n">dw_dmac0</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  System peripherals</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_pm0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfff00000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfff0007f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32ap700x_rtc0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfff00080</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfff000af</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_wdt0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfff000b0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfff000cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_eic0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfff00100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfff0013f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">at32_pm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">at32ap700x_rtc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">at32_wdt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">at32_eic</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Peripheral clock for PM, RTC, WDT and EIC. PM will ensure that this</span>
<span class="cm"> * is always running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">at32_pm_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">at32_pm0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">intc0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff00400</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at32_intc0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;intc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">intc0_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intc0_resource</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">at32_intc0</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">ebi_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ebi&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">hsb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">hsb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">hramc_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hramc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">hsb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">hsb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">sdramc_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sdramc_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">smc0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff03400</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">smc0</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">smc0</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">pdc_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pdc&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">hclk</span><span class="p">,</span> <span class="n">pdc</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">pdc</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">pico_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pico&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cpu_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">cpu_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">cpu_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * HMATRIX</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">struct</span> <span class="n">clk</span> <span class="n">at32_hmatrix_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hmatrix_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">users</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Set bits in the HMATRIX Special Function Register (SFR) used by the</span>
<span class="cm"> * External Bus Interface (EBI). This can be used to enable special</span>
<span class="cm"> * features like CompactFlash support, NAND Flash support, etc. on</span>
<span class="cm"> * certain chipselects.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_ebi_sfr_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hmatrix_sfr_set_bits</span><span class="p">(</span><span class="n">HMATRIX_SLAVE_EBI</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Timer/Counter (TC)</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_tcb0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff00c00</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at32_tcb0_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tcb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">at32_tcb0_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at32_tcb0_resource</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">t0_clk</span><span class="p">,</span> <span class="n">at32_tcb0</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_tcb1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff01000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">at32_tcb1_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;atmel_tcb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource</span>	<span class="o">=</span> <span class="n">at32_tcb1_resource</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_resources</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at32_tcb1_resource</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">t0_clk</span><span class="p">,</span> <span class="n">at32_tcb1</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  PIO</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pio0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe02800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">pio0</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pio1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe02c00</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">pio1</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pio2_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe03000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">pio2</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pio3_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe03400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">pio3</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">pio4_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe03800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">mck</span><span class="p">,</span> <span class="n">pio4</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">system_device_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_pm0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_intc0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32ap700x_rtc0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_wdt0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_eic0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdc_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dw_dmac0_device</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_tcb0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at32_tcb1_device</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio0_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio1_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio2_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio3_device</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio4_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">system_device_init</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  PSIF</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_psif0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xffe03c00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xffe03cff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_psif0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pba_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pba_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pba_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_psif1_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xffe03d00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xffe03dff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">18</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_psif1_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pba_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pba_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pba_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">at32_add_device_psif</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_psif&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span> <span class="cm">/* CLOCK &amp; DATA */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_psif0_resource</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_psif0_resource</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err_add_resources</span><span class="p">;</span>
		<span class="n">atmel_psif0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span> <span class="cm">/* CLOCK &amp; DATA */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_psif1_resource</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_psif1_resource</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err_add_resources</span><span class="p">;</span>
		<span class="n">atmel_psif1_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">err_add_resources:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  USART</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">atmel_usart0_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_usart0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe00c00</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">atmel_usart</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">usart</span><span class="p">,</span> <span class="n">atmel_usart0</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">atmel_usart1_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_usart1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe01000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">atmel_usart</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">usart</span><span class="p">,</span> <span class="n">atmel_usart1</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">atmel_usart2_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_usart2_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe01400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">atmel_usart</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">usart</span><span class="p">,</span> <span class="n">atmel_usart2</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="n">atmel_usart3_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">use_dma_tx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">use_dma_rx</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_usart3_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe01800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">atmel_usart</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">usart</span><span class="p">,</span> <span class="n">atmel_usart3</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart0_pins</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span> <span class="cm">/* RXD &amp; TXD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_RTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CLK</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart1_pins</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span> <span class="cm">/* RXD &amp; TXD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_RTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CLK</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart2_pins</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">);</span> <span class="cm">/* RXD &amp; TXD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_RTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CLK</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">configure_usart3_pins</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span> <span class="cm">/* RXD &amp; TXD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_RTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CTS</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_USART_CLK</span><span class="p">)</span>	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__initdata</span> <span class="n">at32_usarts</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at32_map_usart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_usart0_device</span><span class="p">;</span>
		<span class="n">configure_usart0_pins</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_usart1_device</span><span class="p">;</span>
		<span class="n">configure_usart1_pins</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_usart2_device</span><span class="p">;</span>
		<span class="n">configure_usart2_pins</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_usart3_device</span><span class="p">;</span>
		<span class="n">configure_usart3_pins</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PXSEG</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="n">P4SEG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Addresses in the P4 segment are permanently mapped 1:1 */</span>
		<span class="k">struct</span> <span class="n">atmel_uart_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">at32_usarts</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">at32_add_device_usart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">at32_usarts</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">at32_usarts</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">at32_setup_serial_console</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usart_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_default_console_device</span> <span class="o">=</span> <span class="n">at32_usarts</span><span class="p">[</span><span class="n">usart_id</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  Ethernet</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>

<span class="cp">#ifdef CONFIG_CPU_AT32AP7000</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="n">macb0_data</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">macb0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff01800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">macb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">hclk</span><span class="p">,</span> <span class="n">macb0</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">macb0</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="n">macb1_data</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">macb1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff01c00</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">26</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">macb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">hclk</span><span class="p">,</span> <span class="n">macb1</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">macb1</span><span class="p">,</span> <span class="n">pbb</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_eth</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">macb_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macb0_device</span><span class="p">;</span>

		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* TXD0 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* TXD1 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* TXEN */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* TXCK */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>	<span class="cm">/* RXD0 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* RXD1 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* RXER */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* RXDV */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* MDC  */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>	<span class="cm">/* MDIO */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_rmii</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* COL  */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* CRS  */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* TXER */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* TXD2 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* TXD3 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>	<span class="cm">/* RXD2 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>	<span class="cm">/* RXD3 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* RXCK */</span>
<span class="cp">#ifndef CONFIG_BOARD_MIMC200</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>	<span class="cm">/* SPD  */</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOC</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macb1_device</span><span class="p">;</span>

		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* TXD0 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* TXD1 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>	<span class="cm">/* TXEN */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>	<span class="cm">/* TXCK */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* RXD0 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>	<span class="cm">/* RXD1 */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* RXER */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* RXDV */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* MDC  */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* MDIO */</span>

<span class="cp">#ifndef CONFIG_BOARD_MIMC200</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_rmii</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* SPD  */</span>
<span class="cp">#endif</span>

		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOD</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">is_rmii</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>	<span class="cm">/* COL  */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* CRS  */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">);</span>	<span class="cm">/* TXER */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">);</span>	<span class="cm">/* TXD2 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>	<span class="cm">/* TXD3 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>	<span class="cm">/* RXD2 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>	<span class="cm">/* RXD3 */</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* RXCK */</span>

			<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOC</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">macb_platform_data</span><span class="p">));</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SPI</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_spi0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe00000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">atmel_spi</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">spi_clk</span><span class="p">,</span> <span class="n">atmel_spi0</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_spi1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe00400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">atmel_spi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">spi_clk</span><span class="p">,</span> <span class="n">atmel_spi1</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">at32_spi_setup_slaves</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Manage the chipselects as GPIOs, normally using the same pins</span>
<span class="cm">	 * the SPI controller expects; but boards can use other pins.</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">__initdata</span> <span class="n">spi_pins</span><span class="p">[][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">GPIO_PIN_PA</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">GPIO_PIN_PA</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
		  <span class="n">GPIO_PIN_PA</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">GPIO_PIN_PA</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">GPIO_PIN_PB</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">GPIO_PIN_PB</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
		  <span class="n">GPIO_PIN_PB</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">GPIO_PIN_PA</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* There are only 2 SPI controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_num</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">,</span> <span class="n">b</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">bus_num</span> <span class="o">=</span> <span class="n">bus_num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">chip_select</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">controller_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pin</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pin</span> <span class="o">=</span> <span class="n">spi_pins</span><span class="p">[</span><span class="n">bus_num</span><span class="p">][</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">chip_select</span><span class="p">];</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">controller_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pin</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">AT32_GPIOF_OUTPUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SPI_CS_HIGH</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">AT32_GPIOF_HIGH</span><span class="p">;</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_spi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">spi_board_info</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_spi0_device</span><span class="p">;</span>
		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* MOSI &amp; SCK */</span>

		<span class="cm">/* pullup MISO so a level is always defined */</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">at32_spi_setup_slaves</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_spi1_device</span><span class="p">;</span>
		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* MOSI */</span>

		<span class="cm">/* pullup MISO so a level is always defined */</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="n">AT32_GPIOF_PULLUP</span><span class="p">);</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">at32_spi_setup_slaves</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spi_register_board_info</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  TWI</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_twi0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe00800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_twi0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;twi_pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pba_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pba_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pba_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">at32_add_device_twi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_twi&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_twi0_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_twi0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_add_resources</span><span class="p">;</span>

	<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* SDA &amp; SDL */</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">atmel_twi0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
		<span class="n">i2c_register_board_info</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">err_add_resources:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * MMC</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_mci0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff02400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">28</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_mci0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mci_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_mci</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mci_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mci_dma_data</span>	        <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">pioa_mask</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">piob_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Must have at least one usable slot */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_width</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_mci&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_mci0_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_mci0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">slave</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mci_dma_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slave</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">slave</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">.</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dw_dmac0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">slave</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">.</span><span class="n">cfg_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWC_CFGH_SRC_PER</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">DWC_CFGH_DST_PER</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">slave</span><span class="o">-&gt;</span><span class="n">sdata</span><span class="p">.</span><span class="n">cfg_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC_CFGL_HS_DST_POL</span>
				<span class="o">|</span> <span class="n">DWC_CFGL_HS_SRC_POL</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_slave</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mci_platform_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>

	<span class="cm">/* CLK line is common to both slots */</span>
	<span class="n">pioa_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">pioa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>		<span class="cm">/* DATA1 */</span>
		<span class="n">pioa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>		<span class="cm">/* DATA2 */</span>
		<span class="n">pioa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">;</span>		<span class="cm">/* DATA3 */</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pioa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>		<span class="cm">/* CMD	 */</span>
		<span class="n">pioa_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>		<span class="cm">/* DATA0 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">))</span>
			<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">))</span>
			<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Slot is unused */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pioa_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">piob_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">piob_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* DATA1 */</span>
		<span class="n">piob_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">9</span><span class="p">;</span>		<span class="cm">/* DATA2 */</span>
		<span class="n">piob_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>		<span class="cm">/* DATA3 */</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">piob_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">6</span><span class="p">;</span>		<span class="cm">/* CMD	 */</span>
		<span class="n">piob_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="mi">7</span><span class="p">;</span>		<span class="cm">/* DATA0 */</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">piob_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">))</span>
			<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">detect_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">))</span>
			<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">wp_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Slot is unused */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bus_width</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bus_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmel_mci0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">fail_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">dma_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  LCDC</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="cp">#if defined(CONFIG_CPU_AT32AP7000) || defined(CONFIG_CPU_AT32AP7002)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="n">atmel_lcdfb0_data</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_lcdfb0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0xff000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0xff000fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="cm">/* Placeholder for pre-allocated fb memory */</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0x00000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV_DATA</span><span class="p">(</span><span class="n">atmel_lcdfb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">hck1</span><span class="p">,</span> <span class="n">atmel_lcdfb0</span><span class="p">,</span> <span class="n">hsb</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_lcdfb0_pixclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;lcdc_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_lcdfb0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_lcdc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fbmem_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fbmem_len</span><span class="p">,</span>
		     <span class="n">u64</span> <span class="n">pin_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_lcdfb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_monspecs</span> <span class="o">*</span><span class="n">monspecs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_videomode</span> <span class="o">*</span><span class="n">modedb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modedb_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">portc_mask</span><span class="p">,</span> <span class="n">portd_mask</span><span class="p">,</span> <span class="n">porte_mask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do a deep copy of the fb data, monspecs and modedb. Make</span>
<span class="cm">	 * sure all allocations are done before setting up the</span>
<span class="cm">	 * portmux.</span>
<span class="cm">	 */</span>
	<span class="n">monspecs</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">default_monspecs</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_monspecs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">monspecs</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">modedb_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_videomode</span><span class="p">)</span> <span class="o">*</span> <span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">modedb_len</span><span class="p">;</span>
	<span class="n">modedb</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">modedb</span><span class="p">,</span> <span class="n">modedb_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modedb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dup_modedb</span><span class="p">;</span>
	<span class="n">monspecs</span><span class="o">-&gt;</span><span class="n">modedb</span> <span class="o">=</span> <span class="n">modedb</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_lcdfb0_device</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">==</span> <span class="mi">0ULL</span><span class="p">)</span>
			<span class="cm">/* Default to &quot;full&quot; lcdc control signals and 24bit */</span>
			<span class="n">pin_mask</span> <span class="o">=</span> <span class="n">ATMEL_LCDC_PRI_24BIT</span> <span class="o">|</span> <span class="n">ATMEL_LCDC_PRI_CONTROL</span><span class="p">;</span>

		<span class="cm">/* LCDC on port C */</span>
		<span class="n">portc_mask</span> <span class="o">=</span> <span class="n">pin_mask</span> <span class="o">&amp;</span> <span class="mh">0xfff80000</span><span class="p">;</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOC</span><span class="p">,</span> <span class="n">portc_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* LCDC on port D */</span>
		<span class="n">portd_mask</span> <span class="o">=</span> <span class="n">pin_mask</span> <span class="o">&amp;</span> <span class="mh">0x0003ffff</span><span class="p">;</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOD</span><span class="p">,</span> <span class="n">portd_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* LCDC on port E */</span>
		<span class="n">porte_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0007ffff</span><span class="p">;</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOE</span><span class="p">,</span> <span class="n">porte_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">clk_set_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmel_lcdfb0_pixclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll0</span><span class="p">);</span>
		<span class="n">clk_set_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmel_lcdfb0_pixclk</span><span class="p">,</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pll0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_invalid_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbmem_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">fbmem_start</span><span class="p">;</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">fbmem_start</span> <span class="o">+</span> <span class="n">fbmem_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_lcdfb_info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_monspecs</span> <span class="o">=</span> <span class="n">monspecs</span><span class="p">;</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">err_invalid_id:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">modedb</span><span class="p">);</span>
<span class="nl">err_dup_modedb:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">monspecs</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  PWM</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_pwm0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff01400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_pwm0_mck</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pwm_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span> <span class="nf">at32_add_device_pwm</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_pwm&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_pwm0_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_pwm0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mask</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_pdev</span><span class="p">;</span>

	<span class="n">pin_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pin_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">atmel_pwm0_mck</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">out_free_pdev:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  SSC</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc0_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe01c00</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">ssc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">ssc0</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc1_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe02000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">ssc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">ssc1</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">ssc2_resource</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xffe02400</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">DEFINE_DEV</span><span class="p">(</span><span class="n">ssc</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">DEV_CLK</span><span class="p">(</span><span class="n">pclk</span><span class="p">,</span> <span class="n">ssc2</span><span class="p">,</span> <span class="n">pba</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_ssc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc0_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>	<span class="cm">/* RF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>	<span class="cm">/* RK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* TK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* TF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>	<span class="cm">/* TD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">);</span>	<span class="cm">/* RD */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc1_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* RF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* RK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* TK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* TF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* TD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>	<span class="cm">/* RD */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOA</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssc2_device</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* TD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RD</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>	<span class="cm">/* RD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>	<span class="cm">/* TK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_TF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* TF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RF</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">);</span>	<span class="cm">/* RF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATMEL_SSC_RK</span><span class="p">)</span>
			<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>	<span class="cm">/* RK */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pin_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  USB Device Controller</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">usba0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0xff300000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0xff3fffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>		<span class="o">=</span> <span class="mh">0xfff03000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>		<span class="o">=</span> <span class="mh">0xfff033ff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">31</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">usba0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">usba0_hclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;hclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">hsb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">hsb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define EP(nam, idx, maxpkt, maxbk, dma, isoc)			\</span>
<span class="cp">	[idx] = {						\</span>
<span class="cp">		.name		= nam,				\</span>
<span class="cp">		.index		= idx,				\</span>
<span class="cp">		.fifo_size	= maxpkt,			\</span>
<span class="cp">		.nr_banks	= maxbk,			\</span>
<span class="cp">		.can_dma	= dma,				\</span>
<span class="cp">		.can_isoc	= isoc,				\</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usba_ep_data</span> <span class="n">at32_usba_ep</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep0&quot;</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep1&quot;</span><span class="p">,</span>     <span class="mi">1</span><span class="p">,</span>  <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep2&quot;</span><span class="p">,</span>     <span class="mi">2</span><span class="p">,</span>  <span class="mi">512</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep3-int&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep4-int&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep5&quot;</span><span class="p">,</span>     <span class="mi">5</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">EP</span><span class="p">(</span><span class="s">&quot;ep6&quot;</span><span class="p">,</span>     <span class="mi">6</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#undef EP</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_usba</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usba_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * pdata doesn&#39;t have room for any endpoints, so we need to</span>
<span class="cm">	 * append room for the ones we need right after it.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usba_platform_data</span> <span class="n">pdata</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">usba_ep_data</span> <span class="n">ep</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">usba_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_usba_udc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">usba0_resource</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">usba0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usba_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">;</span>
		<span class="n">usba_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin_inverted</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin_inverted</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usba_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">usba_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">.</span><span class="n">vbus_pin_inverted</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usba_data</span><span class="p">.</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">num_ep</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at32_usba_ep</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">,</span> <span class="n">at32_usba_ep</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">at32_usba_ep</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">usba_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">))</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vbus_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">usba0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">usba0_hclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">out_free_pdev:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * IDE / CompactFlash</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="cp">#if defined(CONFIG_CPU_AT32AP7000) || defined(CONFIG_CPU_AT32AP7001)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_smc_cs4_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x04000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x07ffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">),</span> <span class="cm">/* Magic IRQ will be overridden */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">at32_smc_cs5_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x20000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x23ffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="o">~</span><span class="mi">0UL</span><span class="p">),</span> <span class="cm">/* Magic IRQ will be overridden */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at32_init_ide_or_cf</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extint_pin_map</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">),</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">),</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">),</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">common_pins_initialized</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extint_pin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extint</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">extint_pin_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">extint_pin</span> <span class="o">=</span> <span class="n">extint_pin_map</span><span class="p">[</span><span class="n">extint</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">at32_smc_cs4_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at32_smc_cs4_resource</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* NCS4   -&gt; OE_N  */</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOE</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hmatrix_sfr_set_bits</span><span class="p">(</span><span class="n">HMATRIX_SLAVE_EBI</span><span class="p">,</span> <span class="n">HMATRIX_EBI_CF0_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
				<span class="n">at32_smc_cs5_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at32_smc_cs5_resource</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* NCS5   -&gt; OE_N  */</span>
		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOE</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">),</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">hmatrix_sfr_set_bits</span><span class="p">(</span><span class="n">HMATRIX_SLAVE_EBI</span><span class="p">,</span> <span class="n">HMATRIX_EBI_CF1_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common_pins_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>	<span class="cm">/* CFCE1  -&gt; CS0_N */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>	<span class="cm">/* CFCE2  -&gt; CS1_N */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* CFRNW  -&gt; DIR   */</span>
		<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>	<span class="cm">/* NWAIT  &lt;- IORDY */</span>

		<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOE</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">common_pins_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">extint_pin</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">EIM_IRQ_BASE</span> <span class="o">+</span> <span class="n">extint</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_ide</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extint</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ide_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;at32_ide&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ide_platform_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at32_init_ide_or_cf</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">extint</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_cf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extint</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cf_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;at32_cf&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cf_platform_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at32_init_ide_or_cf</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">extint</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">))</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">detect_pin</span><span class="p">,</span> <span class="n">AT32_GPIOF_DEGLITCH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">))</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">))</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">vcc_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* READY is used as extint, so we can&#39;t select it as gpio */</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * NAND Flash / SmartMedia</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">smc_cs3_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0x0c000000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0x0fffffff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="mh">0xfff03c00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">end</span>	<span class="o">=</span> <span class="mh">0xfff03fff</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_nand</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atmel_nand_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_nand&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">smc_cs3_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smc_cs3_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_nand_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">hmatrix_sfr_set_bits</span><span class="p">(</span><span class="n">HMATRIX_SLAVE_EBI</span><span class="p">,</span> <span class="n">HMATRIX_EBI_NAND_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">)</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">enable_pin</span><span class="p">,</span>
				<span class="n">AT32_GPIOF_OUTPUT</span> <span class="o">|</span> <span class="n">AT32_GPIOF_HIGH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">)</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rdy_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">)</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">det_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * AC97C</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">atmel_ac97c0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff02800</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">29</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">atmel_ac97c0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_ac97c</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ac97c_platform_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>		<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dw_dma_slave</span>		<span class="o">*</span><span class="n">rx_dws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dw_dma_slave</span>		<span class="o">*</span><span class="n">tx_dws</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ac97c_platform_data</span>	<span class="n">_data</span><span class="p">;</span>
	<span class="n">u32</span>				<span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_ac97c&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">atmel_ac97c0_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_ac97c0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_data</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ac97c_platform_data</span><span class="p">));</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_dws</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rx_dws</span><span class="p">;</span>
	<span class="n">tx_dws</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tx_dws</span><span class="p">;</span>

	<span class="cm">/* Check if DMA slave interface for capture should be configured. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97C_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_dws</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dw_dmac0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">rx_dws</span><span class="o">-&gt;</span><span class="n">cfg_hi</span> <span class="o">=</span> <span class="n">DWC_CFGH_SRC_PER</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">rx_dws</span><span class="o">-&gt;</span><span class="n">cfg_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC_CFGL_HS_DST_POL</span> <span class="o">|</span> <span class="n">DWC_CFGL_HS_SRC_POL</span><span class="p">);</span>
		<span class="n">rx_dws</span><span class="o">-&gt;</span><span class="n">src_master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rx_dws</span><span class="o">-&gt;</span><span class="n">dst_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if DMA slave interface for playback should be configured. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97C_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_dws</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dw_dmac0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">tx_dws</span><span class="o">-&gt;</span><span class="n">cfg_hi</span> <span class="o">=</span> <span class="n">DWC_CFGH_DST_PER</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">tx_dws</span><span class="o">-&gt;</span><span class="n">cfg_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC_CFGL_HS_DST_POL</span> <span class="o">|</span> <span class="n">DWC_CFGL_HS_SRC_POL</span><span class="p">);</span>
		<span class="n">tx_dws</span><span class="o">-&gt;</span><span class="n">src_master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_dws</span><span class="o">-&gt;</span><span class="n">dst_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ac97c_platform_data</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="cm">/* SDO | SYNC | SCLK | SDI */</span>
	<span class="n">pin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">))</span>
		<span class="n">at32_select_gpio</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="n">AT32_GPIOF_OUTPUT</span>
				<span class="o">|</span> <span class="n">AT32_GPIOF_HIGH</span><span class="p">);</span>

	<span class="n">atmel_ac97c0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">out_free_resources:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> * ABDAC</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">abdac0_resource</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PBMEM</span><span class="p">(</span><span class="mh">0xfff02000</span><span class="p">),</span>
	<span class="n">IRQ</span><span class="p">(</span><span class="mi">27</span><span class="p">),</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">abdac0_pclk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;pclk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parent</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">pbb_clk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">pbb_clk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">abdac0_sample_clk</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sample_clk&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">__init</span>
<span class="nf">at32_add_device_abdac</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atmel_abdac_pdata</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dw_dma_slave</span>	<span class="o">*</span><span class="n">dws</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">pin_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;atmel_abdac&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">abdac0_resource</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abdac0_resource</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="n">dws</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">dws</span><span class="p">;</span>

	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dma_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dw_dmac0_device</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cfg_hi</span> <span class="o">=</span> <span class="n">DWC_CFGH_DST_PER</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">cfg_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DWC_CFGL_HS_DST_POL</span> <span class="o">|</span> <span class="n">DWC_CFGL_HS_SRC_POL</span><span class="p">);</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">src_master</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dws</span><span class="o">-&gt;</span><span class="n">dst_master</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_abdac_pdata</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_free_resources</span><span class="p">;</span>

	<span class="n">pin_mask</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">);</span>	<span class="cm">/* DATA1 &amp; DATAN1 */</span>
	<span class="n">pin_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">);</span>	<span class="cm">/* DATA0 &amp; DATAN0 */</span>

	<span class="n">select_peripheral</span><span class="p">(</span><span class="n">PIOB</span><span class="p">,</span> <span class="n">pin_mask</span><span class="p">,</span> <span class="n">PERIPH_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">abdac0_pclk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">abdac0_sample_clk</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>

<span class="nl">out_free_resources:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------</span>
<span class="cm"> *  GCLK</span>
<span class="cm"> * -------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">gclk0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gclk0&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">gclk1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gclk1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">gclk2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gclk2&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">gclk3</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gclk3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">clk</span> <span class="n">gclk4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gclk4&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span>		<span class="o">=</span> <span class="n">genclk_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span>	<span class="o">=</span> <span class="n">genclk_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rate</span>	<span class="o">=</span> <span class="n">genclk_set_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_parent</span>	<span class="o">=</span> <span class="n">genclk_set_parent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">init_clocks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">osc32k</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">osc0</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">osc1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pll0</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pll1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">cpu_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hsb_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pba_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pbb_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">at32_pm_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">at32_intc0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">at32_hmatrix_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ebi_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">hramc_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sdramc_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">smc0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">smc0_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pdc_hclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pdc_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dw_dmac0_hclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pico_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pio0_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pio1_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pio2_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pio3_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">pio4_mck</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">at32_tcb0_t0_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">at32_tcb1_t0_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_psif0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_psif1_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_usart0_usart</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_usart1_usart</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_usart2_usart</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_usart3_usart</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_pwm0_mck</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_CPU_AT32AP7000)</span>
	<span class="o">&amp;</span><span class="n">macb0_hclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">macb0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">macb1_hclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">macb1_pclk</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">atmel_spi0_spi_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_spi1_spi_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_twi0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_mci0_pclk</span><span class="p">,</span>
<span class="cp">#if defined(CONFIG_CPU_AT32AP7000) || defined(CONFIG_CPU_AT32AP7002)</span>
	<span class="o">&amp;</span><span class="n">atmel_lcdfb0_hck1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_lcdfb0_pixclk</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="o">&amp;</span><span class="n">ssc0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ssc1_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ssc2_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">usba0_hclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">usba0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">atmel_ac97c0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">abdac0_pclk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">abdac0_sample_clk</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gclk0</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gclk1</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gclk2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gclk3</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">gclk4</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_platform</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cpu_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hsb_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pba_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pbb_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_readl</span><span class="p">(</span><span class="n">MCCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLSEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">main_clock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pll0</span><span class="p">;</span>
		<span class="n">cpu_clk</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pll0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">main_clock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">;</span>
		<span class="n">cpu_clk</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLOSC</span><span class="p">))</span>
		<span class="n">pll0</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_readl</span><span class="p">(</span><span class="n">PLL1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PM_BIT</span><span class="p">(</span><span class="n">PLLOSC</span><span class="p">))</span>
		<span class="n">pll1</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">osc1</span><span class="p">;</span>

	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gclk0</span><span class="p">);</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gclk1</span><span class="p">);</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gclk2</span><span class="p">);</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gclk3</span><span class="p">);</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gclk4</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_CPU_AT32AP7000) || defined(CONFIG_CPU_AT32AP7002)</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atmel_lcdfb0_pixclk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">genclk_init_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abdac0_sample_clk</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Build initial dynamic clock list by registering all clocks</span>
<span class="cm">	 * from the array.</span>
<span class="cm">	 * At the same time, turn on all clocks that have at least one</span>
<span class="cm">	 * user already, and turn off everything else. We only do this</span>
<span class="cm">	 * for module clocks, and even though it isn&#39;t particularly</span>
<span class="cm">	 * pretty to  check the address of the mode function, it should</span>
<span class="cm">	 * do the trick...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init_clocks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span> <span class="o">=</span> <span class="n">init_clocks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* first, register clock */</span>
		<span class="n">at32_clk_register</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cpu_clk_mode</span><span class="p">)</span>
			<span class="n">cpu_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">hsb_clk_mode</span><span class="p">)</span>
			<span class="n">hsb_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pba_clk_mode</span><span class="p">)</span>
			<span class="n">pba_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">pbb_clk_mode</span><span class="p">)</span>
			<span class="n">pbb_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clk</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_writel</span><span class="p">(</span><span class="n">CPU_MASK</span><span class="p">,</span> <span class="n">cpu_mask</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">HSB_MASK</span><span class="p">,</span> <span class="n">hsb_mask</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">PBA_MASK</span><span class="p">,</span> <span class="n">pba_mask</span><span class="p">);</span>
	<span class="n">pm_writel</span><span class="p">(</span><span class="n">PBB_MASK</span><span class="p">,</span> <span class="n">pbb_mask</span><span class="p">);</span>

	<span class="cm">/* Initialize the port muxes */</span>
	<span class="n">at32_init_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio0_device</span><span class="p">);</span>
	<span class="n">at32_init_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio1_device</span><span class="p">);</span>
	<span class="n">at32_init_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio2_device</span><span class="p">);</span>
	<span class="n">at32_init_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio3_device</span><span class="p">);</span>
	<span class="n">at32_init_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pio4_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">gen_pool</span> <span class="o">*</span><span class="n">sram_pool</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sram_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gen_pool</span> <span class="o">*</span><span class="n">pool</span><span class="p">;</span>

	<span class="cm">/* 1KiB granularity */</span>
	<span class="n">pool</span> <span class="o">=</span> <span class="n">gen_pool_create</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pool</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gen_pool_add</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mh">0x24000000</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_pool_add</span><span class="p">;</span>

	<span class="n">sram_pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pool_add:</span>
	<span class="n">gen_pool_destroy</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to create SRAM pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">core_initcall</span><span class="p">(</span><span class="n">sram_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
