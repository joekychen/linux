<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › ps3 › interrupt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>interrupt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 interrupt routines.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2006 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>

<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/udbg.h&gt;</span>
<span class="cp">#include &lt;asm/lv1call.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>

<span class="cp">#if defined(DEBUG)</span>
<span class="cp">#define DBG udbg_printf</span>
<span class="cp">#define FAIL udbg_printf</span>
<span class="cp">#else</span>
<span class="cp">#define DBG pr_devel</span>
<span class="cp">#define FAIL pr_debug</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * struct ps3_bmp - a per cpu irq status and mask bitmap structure</span>
<span class="cm"> * @status: 256 bit status bitmap indexed by plug</span>
<span class="cm"> * @unused_1: Alignment</span>
<span class="cm"> * @mask: 256 bit mask bitmap indexed by plug</span>
<span class="cm"> * @unused_2: Alignment</span>
<span class="cm"> *</span>
<span class="cm"> * The HV maintains per SMT thread mappings of HV outlet to HV plug on</span>
<span class="cm"> * behalf of the guest.  These mappings are implemented as 256 bit guest</span>
<span class="cm"> * supplied bitmaps indexed by plug number.  The addresses of the bitmaps</span>
<span class="cm"> * are registered with the HV through lv1_configure_irq_state_bitmap().</span>
<span class="cm"> * The HV requires that the 512 bits of status + mask not cross a page</span>
<span class="cm"> * boundary.  PS3_BMP_MINALIGN is used to define this minimal 64 byte</span>
<span class="cm"> * alignment.</span>
<span class="cm"> *</span>
<span class="cm"> * The HV supports 256 plugs per thread, assigned as {0..255}, for a total</span>
<span class="cm"> * of 512 plugs supported on a processor.  To simplify the logic this</span>
<span class="cm"> * implementation equates HV plug value to Linux virq value, constrains each</span>
<span class="cm"> * interrupt to have a system wide unique plug number, and limits the range</span>
<span class="cm"> * of the plug values to map into the first dword of the bitmaps.  This</span>
<span class="cm"> * gives a usable range of plug values of  {NUM_ISA_INTERRUPTS..63}.  Note</span>
<span class="cm"> * that there is no constraint on how many in this set an individual thread</span>
<span class="cm"> * can acquire.</span>
<span class="cm"> *</span>
<span class="cm"> * The mask is declared as unsigned long so we can use set/clear_bit on it.</span>
<span class="cm"> */</span>

<span class="cp">#define PS3_BMP_MINALIGN 64</span>

<span class="k">struct</span> <span class="n">ps3_bmp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">unused_1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">unused_2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ps3_private - a per cpu data structure</span>
<span class="cm"> * @bmp: ps3_bmp structure</span>
<span class="cm"> * @bmp_lock: Syncronize access to bmp.</span>
<span class="cm"> * @ipi_debug_brk_mask: Mask for debug break IPIs</span>
<span class="cm"> * @ppe_id: HV logical_ppe_id</span>
<span class="cm"> * @thread_id: HV thread_id</span>
<span class="cm"> * @ipi_mask: Mask of IPI virqs</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ps3_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_bmp</span> <span class="n">bmp</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="n">PS3_BMP_MINALIGN</span><span class="p">)));</span>
	<span class="n">spinlock_t</span> <span class="n">bmp_lock</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ppe_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">thread_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ipi_debug_brk_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ipi_mask</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_private</span><span class="p">,</span> <span class="n">ps3_private</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_chip_mask - Set an interrupt mask bit in ps3_bmp.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets ps3_bmp.mask and calls lv1_did_update_interrupt_mask().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_chip_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: thread_id %llu, virq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">lv1_did_update_interrupt_mask</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_chip_unmask - Clear an interrupt mask bit in ps3_bmp.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Clears ps3_bmp.mask and calls lv1_did_update_interrupt_mask().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_chip_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: thread_id %llu, virq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">lv1_did_update_interrupt_mask</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_chip_eoi - HV end-of-interrupt.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Calls lv1_end_of_interrupt_ext().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_chip_eoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="cm">/* non-IPIs are EOIed here. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_mask</span><span class="p">))</span>
		<span class="n">lv1_end_of_interrupt_ext</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_irq_chip - Represents the ps3_bmp as a Linux struct irq_chip.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">ps3_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ps3&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">ps3_chip_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">ps3_chip_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span> <span class="o">=</span> <span class="n">ps3_chip_eoi</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_virq_setup - virq related setup.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @outlet: The HV outlet from the various create outlet routines.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Calls irq_create_mapping() to get a virq and sets the chip data to</span>
<span class="cm"> * ps3_private data.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_virq_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">outlet</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

	<span class="cm">/* This defines the default interrupt distribution policy. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">PS3_BINDING_CPU_ANY</span><span class="p">)</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="o">*</span><span class="n">virq</span> <span class="o">=</span> <span class="n">irq_create_mapping</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">virq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: irq_create_mapping failed: outlet %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">outlet</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_create</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: outlet %lu =&gt; cpu %u, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">outlet</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="o">*</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">irq_set_chip_data</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">,</span> <span class="n">pd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: irq_set_chip_data failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_set</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">fail_set:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">);</span>
<span class="nl">fail_create:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_virq_destroy - virq related teardown.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Clears chip data and calls irq_dispose_mapping() for the virq.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_virq_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: ppe_id %llu, thread_id %llu, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">__LINE__</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d &lt;-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_irq_plug_setup - Generic outlet and virq related setup.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @outlet: The HV outlet from the various create outlet routines.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets up virq and connects the irq plug.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_irq_plug_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">outlet</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_virq_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: ps3_virq_setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_setup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">);</span>

	<span class="cm">/* Binds outlet to cpu + virq. */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_connect_irq_plug_ext</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="o">*</span><span class="n">virq</span><span class="p">,</span>
		<span class="n">outlet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_connect_irq_plug_ext failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_connect</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">fail_connect:</span>
	<span class="n">ps3_virq_destroy</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">);</span>
<span class="nl">fail_setup:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_irq_plug_setup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_irq_plug_destroy - Generic outlet and virq related teardown.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Disconnects the irq plug and tears down virq.</span>
<span class="cm"> * Do not call for system bus event interrupts setup with</span>
<span class="cm"> * ps3_sb_event_receive_port_setup().</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_irq_plug_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: ppe_id %llu, thread_id %llu, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">__LINE__</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_disconnect_irq_plug_ext</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_disconnect_irq_plug_ext failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="n">ps3_virq_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_irq_plug_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_event_receive_port_setup - Setup an event receive port.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * The virq can be used with lv1_connect_interrupt_event_receive_port() to</span>
<span class="cm"> * arrange to receive interrupts from system-bus devices, or with</span>
<span class="cm"> * ps3_send_event_locally() to signal events.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_event_receive_port_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">outlet</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_construct_event_receive_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_construct_event_receive_port failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="o">*</span><span class="n">virq</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_event_receive_port_setup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_event_receive_port_destroy - Destroy an event receive port.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * Since ps3_event_receive_port_destroy destroys the receive port outlet,</span>
<span class="cm"> * SB devices need to call disconnect_interrupt_event_receive_port() before</span>
<span class="cm"> * this.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_event_receive_port_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_destruct_event_receive_port</span><span class="p">(</span><span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_destruct_event_receive_port failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t call ps3_virq_destroy() here since ps3_smp_cleanup_cpu()</span>
<span class="cm">	 * calls from interrupt context (smp_call_function) when kexecing.</span>
<span class="cm">	 */</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_send_event_locally</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lv1_send_event_locally</span><span class="p">(</span><span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_sb_event_receive_port_setup - Setup a system bus event receive port.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @dev: The system bus device instance.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * An event irq represents a virtual device interrupt.  The interrupt_id</span>
<span class="cm"> * coresponds to the software interrupt number.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_sb_event_receive_port_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should go in system-bus.c */</span>

	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_event_receive_port_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_connect_interrupt_event_receive_port</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_connect_interrupt_event_receive_port&quot;</span>
			<span class="s">&quot; failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">ps3_event_receive_port_destroy</span><span class="p">(</span><span class="o">*</span><span class="n">virq</span><span class="p">);</span>
		<span class="o">*</span><span class="n">virq</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: interrupt_id %u, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">,</span> <span class="o">*</span><span class="n">virq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_sb_event_receive_port_setup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_sb_event_receive_port_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should go in system-bus.c */</span>

	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d: interrupt_id %u, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_disconnect_interrupt_event_receive_port</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_disconnect_interrupt_event_receive_port&quot;</span>
			<span class="s">&quot; failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_event_receive_port_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ps3_event_receive_port_destroy() destroys the IRQ plug,</span>
<span class="cm">	 * so don&#39;t call ps3_irq_plug_destroy() here.</span>
<span class="cm">	 */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_virq_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_sb_event_receive_port_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_io_irq_setup - Setup a system bus io irq.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @interrupt_id: The device interrupt id read from the system repository.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * An io irq represents a non-virtualized device interrupt.  interrupt_id</span>
<span class="cm"> * coresponds to the interrupt number of the interrupt controller.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_io_irq_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interrupt_id</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">outlet</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_construct_io_irq_outlet</span><span class="p">(</span><span class="n">interrupt_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_construct_io_irq_outlet failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_io_irq_setup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_io_irq_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">outlet</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * lv1_destruct_io_irq_outlet() will destroy the IRQ plug,</span>
<span class="cm">	 * so call ps3_irq_plug_destroy() first.</span>
<span class="cm">	 */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_destruct_io_irq_outlet</span><span class="p">(</span><span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_destruct_io_irq_outlet failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_io_irq_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_vuart_irq_setup - Setup the system virtual uart virq.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @virt_addr_bmp: The caller supplied virtual uart interrupt bitmap.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> * The system supports only a single virtual uart, so multiple calls without</span>
<span class="cm"> * freeing the interrupt will return a wrong state error.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_vuart_irq_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">virt_addr_bmp</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">outlet</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lpar_addr</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_kernel_addr</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">virt_addr_bmp</span><span class="p">));</span>

	<span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">virt_addr_bmp</span><span class="p">));</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_configure_virtual_uart_irq</span><span class="p">(</span><span class="n">lpar_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_configure_virtual_uart_irq failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_vuart_irq_setup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_vuart_irq_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_deconfigure_virtual_uart_irq</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_configure_virtual_uart_irq failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_vuart_irq_destroy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_spe_irq_setup - Setup an spe virq.</span>
<span class="cm"> * @cpu: enum ps3_cpu_binding indicating the cpu the interrupt should be</span>
<span class="cm"> * serviced on.</span>
<span class="cm"> * @spe_id: The spe_id returned from lv1_construct_logical_spe().</span>
<span class="cm"> * @class: The spe interrupt class {0,1,2}.</span>
<span class="cm"> * @virq: The assigned Linux virq.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_spe_irq_setup</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_cpu_binding</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spe_id</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">outlet</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">class</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_get_spe_irq_outlet</span><span class="p">(</span><span class="n">spe_id</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outlet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_get_spe_irq_outlet failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_setup</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">outlet</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_spe_irq_destroy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">ps3_chip_mask</span><span class="p">(</span><span class="n">irq_get_irq_data</span><span class="p">(</span><span class="n">virq</span><span class="p">));</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_irq_plug_destroy</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define PS3_INVALID_OUTLET ((irq_hw_number_t)-1)</span>
<span class="cp">#define PS3_PLUG_MAX 63</span>

<span class="cp">#if defined(DEBUG)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_64_bmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: %s %u {%04llx_%04llx_%04llx_%04llx}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">_dump_256_bmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: %s %u {%016llx:%016llx:%016llx:%016llx}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define dump_bmp(_x) _dump_bmp(_x, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_bmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_private</span><span class="o">*</span> <span class="n">pd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_dump_64_bmp</span><span class="p">(</span><span class="s">&quot;stat&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_64_bmp</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dump_mask(_x) _dump_mask(_x, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">_dump_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_dump_64_bmp</span><span class="p">(</span><span class="s">&quot;mask&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_bmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_private</span><span class="o">*</span> <span class="n">pd</span><span class="p">)</span> <span class="p">{};</span>
<span class="cp">#endif </span><span class="cm">/* defined(DEBUG) */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_host_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">,</span>
	<span class="n">irq_hw_number_t</span> <span class="n">hwirq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: hwirq %lu, virq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">,</span>
		<span class="n">virq</span><span class="p">);</span>

	<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3_irq_chip</span><span class="p">,</span> <span class="n">handle_fasteoi_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_host_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Match all */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">irq_domain_ops</span> <span class="n">ps3_host_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">ps3_host_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">ps3_host_match</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_register_ipi_debug_brk</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_debug_brk_mask</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: cpu %u, virq %u, mask %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">cpu</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_debug_brk_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_register_ipi_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_mask</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: cpu %u, virq %u, ipi_mask %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">cpu</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ps3_get_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plug</span><span class="p">;</span>

	<span class="cm">/* check for ipi break first to stop this cpu ASAP */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_debug_brk_mask</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">&amp;=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_debug_brk_mask</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;cntlzd %0,%1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">plug</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">x</span><span class="p">));</span>
	<span class="n">plug</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">plug</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: no plug found: thread_id %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">);</span>
		<span class="n">dump_bmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">dump_bmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(DEBUG)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">plug</span> <span class="o">&lt;</span> <span class="n">NUM_ISA_INTERRUPTS</span> <span class="o">||</span> <span class="n">plug</span> <span class="o">&gt;</span> <span class="n">PS3_PLUG_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dump_bmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">dump_bmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* IPIs are EOIed here. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">plug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ipi_mask</span><span class="p">))</span>
		<span class="n">lv1_end_of_interrupt_ext</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">plug</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">plug</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_init_IRQ</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">irq_domain_add_nomap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PS3_PLUG_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps3_host_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">irq_set_default_host</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ps3_private</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">ps3_private</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="n">lv1_get_logical_ppe_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">);</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp_lock</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: ppe_id %llu, thread_id %llu, bmp %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span>
			<span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">)));</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_configure_irq_state_bitmap</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ppe_id</span><span class="p">,</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">thread_id</span><span class="p">,</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">bmp</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">FAIL</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_configure_irq_state_bitmap failed:&quot;</span>
				<span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_irq</span> <span class="o">=</span> <span class="n">ps3_get_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ps3_shutdown_IRQ</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ppe_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">thread_id</span> <span class="o">=</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">lv1_get_logical_ppe_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppe_id</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_configure_irq_state_bitmap</span><span class="p">(</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_configure_irq_state_bitmap (%llu:%llu/%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">__LINE__</span><span class="p">,</span> <span class="n">ppe_id</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
