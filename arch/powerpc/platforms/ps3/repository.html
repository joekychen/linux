<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › ps3 › repository.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>repository.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 repository routines.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2006 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/lv1call.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>

<span class="k">enum</span> <span class="n">ps3_vendor_id</span> <span class="p">{</span>
	<span class="n">PS3_VENDOR_ID_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PS3_VENDOR_ID_SONY</span> <span class="o">=</span> <span class="mh">0x8000000000000000UL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ps3_lpar_id</span> <span class="p">{</span>
	<span class="n">PS3_LPAR_ID_CURRENT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PS3_LPAR_ID_PME</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define dump_field(_a, _b) _dump_field(_a, _b, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_field</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(DEBUG)</span>
	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">126</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="n">in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: %s%016llx : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define dump_node_name(_a, _b, _c, _d, _e) \</span>
<span class="cp">	_dump_node_name(_a, _b, _c, _d, _e, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_node_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpar_id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">n4</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: lpar: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">lpar_id</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n1: &quot;</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n2: &quot;</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n3: &quot;</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n4: &quot;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dump_node(_a, _b, _c, _d, _e, _f, _g) \</span>
<span class="cp">	_dump_node(_a, _b, _c, _d, _e, _f, _g, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_node</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpar_id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n4</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v2</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: lpar: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">lpar_id</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n1: &quot;</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n2: &quot;</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n3: &quot;</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">_dump_field</span><span class="p">(</span><span class="s">&quot;n4: &quot;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: v1: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: v2: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * make_first_field - Make the first field of a repository node name.</span>
<span class="cm"> * @text: Text portion of the field.</span>
<span class="cm"> * @index: Numeric index portion of the field.  Use zero for &#39;don&#39;t care&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine sets the vendor id to zero (non-vendor specific).</span>
<span class="cm"> * Returns field value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">make_first_field</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="n">u64</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PS3_VENDOR_ID_NONE</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * make_field - Make subsequent fields of a repository node name.</span>
<span class="cm"> * @text: Text portion of the field.  Use &quot;&quot; for &#39;don&#39;t care&#39;.</span>
<span class="cm"> * @index: Numeric index portion of the field.  Use zero for &#39;don&#39;t care&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns field value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">make_field</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">,</span> <span class="n">u64</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">n</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * read_node - Read a repository node from raw fields.</span>
<span class="cm"> * @n1: First field of node name.</span>
<span class="cm"> * @n2: Second field of node name.  Use zero for &#39;don&#39;t care&#39;.</span>
<span class="cm"> * @n3: Third field of node name.  Use zero for &#39;don&#39;t care&#39;.</span>
<span class="cm"> * @n4: Fourth field of node name.  Use zero for &#39;don&#39;t care&#39;.</span>
<span class="cm"> * @v1: First repository value (high word).</span>
<span class="cm"> * @v2: Second repository value (low word).  Optional parameter, use zero</span>
<span class="cm"> *      for &#39;don&#39;t care&#39;.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_node</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpar_id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n4</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">_v1</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">_v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lpar_id</span> <span class="o">==</span> <span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">lv1_get_logical_partition_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">lpar_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_read_repository_node</span><span class="p">(</span><span class="n">lpar_id</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_read_repository_node failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">dump_node_name</span><span class="p">(</span><span class="n">lpar_id</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_node</span><span class="p">(</span><span class="n">lpar_id</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_v1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">_v1</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_v2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">_v2</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_v1</span><span class="p">)</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: warning: discarding non-zero v1: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_v2</span><span class="p">)</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: warning: discarding non-zero v2: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_bus_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_str</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="n">bus_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_bus_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bus_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">bus_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_bus_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_bus_type</span> <span class="o">*</span><span class="n">bus_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_bus_num_dev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;num_dev&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_dev</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_str</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_str</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="n">dev_str</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">dev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ps3_dev_type</span> <span class="o">*</span><span class="n">dev_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_intr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_index</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_interrupt_type</span> <span class="o">*</span><span class="n">intr_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">interrupt_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;intr&quot;</span><span class="p">,</span> <span class="n">intr_index</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">intr_type</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">interrupt_id</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_reg_type</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_index</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_reg_type</span> <span class="o">*</span><span class="n">reg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="n">reg_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_reg_addr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="n">reg_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_dev_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_index</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_reg_type</span> <span class="o">*</span><span class="n">reg_type</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_reg_type</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">reg_index</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_read_dev_reg_addr</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">reg_index</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">int</span> <span class="nf">ps3_repository_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_dev</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_num_dev</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_num_dev failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: bus_type %u, bus_index %u, bus_id %llu, num_dev %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span>
		<span class="n">num_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span> <span class="o">&gt;=</span> <span class="n">num_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: no device found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_type</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_dev_type failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_id</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_dev_id failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: found: dev_type %u, dev_index %u, dev_id %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>

	<span class="o">*</span><span class="n">repo</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_find_device_by_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
				     <span class="n">u64</span> <span class="n">bus_id</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_dev</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%u: find device by id %llu:%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		 <span class="n">bus_id</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_id</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u read_bus_id(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				 <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_id</span> <span class="o">==</span> <span class="n">bus_id</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found_bus</span><span class="p">;</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u: skip, bus_id %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			 <span class="n">tmp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%u: bus not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">found_bus:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_type</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u read_bus_type(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_num_dev</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u read_bus_num_dev failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span> <span class="o">&lt;</span> <span class="n">num_dev</span><span class="p">;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_id</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
						    <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u read_dev_id(%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				 <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">==</span> <span class="n">dev_id</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found_dev</span><span class="p">;</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u: skip, dev_id %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			 <span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%u: dev not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">found_dev:</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_type</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%u read_dev_type failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%u: found: type (%u:%u) index (%u:%u) id (%llu:%llu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
		 <span class="n">tmp</span><span class="p">.</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">tmp</span><span class="p">.</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="o">*</span><span class="n">repo</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ps3_repository_find_devices</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_bus_type</span> <span class="n">bus_type</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="n">repo</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d: find bus_type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">bus_type</span><span class="p">);</span>

	<span class="n">repo</span><span class="p">.</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">bus_type</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_find_bus</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%u: bus not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_id</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_id(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			 <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">dev_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">repo</span><span class="p">.</span><span class="n">dev_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_find_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: abort at callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_find_bus</span><span class="p">(</span><span class="k">enum</span> <span class="n">ps3_bus_type</span> <span class="n">bus_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">from</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ps3_bus_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_type</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_type failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="o">*</span><span class="n">bus_index</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bus_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bus_index</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_find_interrupt</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_interrupt_type</span> <span class="n">intr_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">interrupt_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_index</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: find intr_type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">intr_type</span><span class="p">);</span>

	<span class="o">*</span><span class="n">interrupt_id</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">res_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">res_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ps3_interrupt_type</span> <span class="n">t</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_intr</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">res_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_dev_intr failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">intr_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">interrupt_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: found intr_type %u at res_index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">intr_type</span><span class="p">,</span> <span class="n">res_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_find_reg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_reg_type</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_index</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: find reg_type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">);</span>

	<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">res_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">res_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ps3_reg_type</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">a</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">l</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_reg</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">res_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_dev_reg failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">reg_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: found reg_type %u at res_index %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">reg_type</span><span class="p">,</span> <span class="n">res_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_port</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_blk_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">blk_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;blk_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_num_blocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">num_blocks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;n_blocks&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_num_regions</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_regions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;n_regs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_regions</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_region_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">region_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
	    <span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	    <span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">region_id</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_region_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">region_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
	    <span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	    <span class="n">region_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_region_start</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">region_start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
	    <span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bus&quot;</span><span class="p">,</span> <span class="n">bus_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;dev&quot;</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
	    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	    <span class="n">region_start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">blk_size</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">num_blocks</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_regions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_port</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_blk_size</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">blk_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_num_blocks</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">num_blocks</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_num_regions</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">num_regions</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_stor_dev_region</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bus_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">region_id</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">region_start</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">region_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_region_id</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">region_index</span><span class="p">,</span> <span class="n">region_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_region_start</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">region_index</span><span class="p">,</span> <span class="n">region_start</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_region_size</span><span class="p">(</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">dev_index</span><span class="p">,</span>
		<span class="n">region_index</span><span class="p">,</span> <span class="n">region_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_num_pu - Number of logical PU processors for this lpar.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_num_pu</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">num_pu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">num_pu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
			   <span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;pun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">num_pu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_pu_id - Read the logical PU id.</span>
<span class="cm"> * @pu_index: Zero based index.</span>
<span class="cm"> * @pu_id: The logical PU id.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_pu_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pu_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">pu_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;pu&quot;</span><span class="p">,</span> <span class="n">pu_index</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">pu_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_rm_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ppe_id</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">rm_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;pu&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">ppe_id</span><span class="p">,</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;rm_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">rm_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_region_total</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">region_total</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;rgntotal&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">region_total</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_mm_info - Read mm info for single pu system.</span>
<span class="cm"> * @rm_base: Real mode memory base address.</span>
<span class="cm"> * @rm_size: Real mode memory size.</span>
<span class="cm"> * @region_total: Maximum memory region size.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_mm_info</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">rm_base</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">rm_size</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">region_total</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ppe_id</span><span class="p">;</span>

	<span class="n">lv1_get_logical_ppe_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppe_id</span><span class="p">);</span>
	<span class="o">*</span><span class="n">rm_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_rm_size</span><span class="p">(</span><span class="n">ppe_id</span><span class="p">,</span> <span class="n">rm_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_read_region_total</span><span class="p">(</span><span class="n">region_total</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_highmem_region_count - Read the number of highmem regions</span>
<span class="cm"> *</span>
<span class="cm"> * Bootloaders must arrange the repository nodes such that regions are indexed</span>
<span class="cm"> * with a region_index from 0 to region_count-1.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_highmem_region_count</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">region_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">region_count</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">ps3_repository_read_highmem_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">highmem_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">highmem_base</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_highmem_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">highmem_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">highmem_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_highmem_info - Read high memory region info</span>
<span class="cm"> * @region_index: Region index, {0,..,region_count-1}.</span>
<span class="cm"> * @highmem_base: High memory base address.</span>
<span class="cm"> * @highmem_size: High memory size.</span>
<span class="cm"> *</span>
<span class="cm"> * Bootloaders that preallocate highmem regions must place the</span>
<span class="cm"> * region info into the repository at these well known nodes.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_highmem_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">highmem_base</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">highmem_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="o">*</span><span class="n">highmem_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_highmem_base</span><span class="p">(</span><span class="n">region_index</span><span class="p">,</span> <span class="n">highmem_base</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_read_highmem_size</span><span class="p">(</span><span class="n">region_index</span><span class="p">,</span> <span class="n">highmem_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_num_spu_reserved - Number of physical spus reserved.</span>
<span class="cm"> * @num_spu: Number of physical spus.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_num_spu_reserved</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_spu_reserved</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;spun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_spu_reserved</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_num_spu_resource_id - Number of spu resource reservations.</span>
<span class="cm"> * @num_resource_id: Number of spu resource ids.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_num_spu_resource_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_resource_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;spursvn&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_resource_id</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_spu_resource_id - spu resource reservation id value.</span>
<span class="cm"> * @res_index: Resource reservation index.</span>
<span class="cm"> * @resource_type: Resource reservation type.</span>
<span class="cm"> * @resource_id: Resource reservation id.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_spu_resource_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_index</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_spu_resource_type</span> <span class="o">*</span><span class="n">resource_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">resource_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;spursv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">res_index</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">resource_type</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_repository_read_boot_dat_address</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;boot_dat&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">address</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_boot_dat_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;boot_dat&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_vuart_av_port</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;vir_uart&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;avset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_vuart_sysmgr_port</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_CURRENT</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;bi&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;vir_uart&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;sysmgr&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">  * ps3_repository_read_boot_dat_info - Get address and size of cell_ext_os_area.</span>
<span class="cm">  * address: lpar address of cell_ext_os_area</span>
<span class="cm">  * @size: size of cell_ext_os_area</span>
<span class="cm">  */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_boot_dat_info</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">lpar_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_boot_dat_address</span><span class="p">(</span><span class="n">lpar_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_read_boot_dat_size</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_num_be - Number of physical BE processors in the system.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_num_be</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_be</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;ben&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_be</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_be_node_id - Read the physical BE processor node id.</span>
<span class="cm"> * @be_index: Zero based index.</span>
<span class="cm"> * @node_id: The BE processor node id.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_be_node_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">be_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">node_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;be&quot;</span><span class="p">,</span> <span class="n">be_index</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">node_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_repository_read_be_id - Read the physical BE processor id.</span>
<span class="cm"> * @node_id: The BE processor node id.</span>
<span class="cm"> * @be_id: The BE processor id.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_be_id</span><span class="p">(</span><span class="n">u64</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">be_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;be&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">node_id</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">be_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_tb_freq</span><span class="p">(</span><span class="n">u64</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tb_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;be&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">node_id</span><span class="p">,</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">tb_freq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_be_tb_freq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">be_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tb_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">node_id</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tb_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_be_node_id</span><span class="p">(</span><span class="n">be_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_read_tb_freq</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">tb_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_read_lpm_privileges</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">be_index</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">lpar</span><span class="p">,</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">rights</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">node_id</span><span class="p">;</span>

	<span class="o">*</span><span class="n">lpar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_be_node_id</span><span class="p">(</span><span class="n">be_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">read_node</span><span class="p">(</span><span class="n">PS3_LPAR_ID_PME</span><span class="p">,</span>
			    <span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;be&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">node_id</span><span class="p">,</span>
			    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;lpm&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">make_field</span><span class="p">(</span><span class="s">&quot;priv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			    <span class="n">lpar</span><span class="p">,</span> <span class="n">rights</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PS3_REPOSITORY_WRITE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_node</span><span class="p">(</span><span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n4</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">dump_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_create_repository_node</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_create_repository_node failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">delete_node</span><span class="p">(</span><span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">dump_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_delete_repository_node</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_delete_repository_node failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_node</span><span class="p">(</span><span class="n">u64</span> <span class="n">n1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n2</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">n4</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">v2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">create_node</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_write_repository_node</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n3</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_write_repository_node failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_write_highmem_region_count</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">region_count</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">write_node</span><span class="p">(</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_write_highmem_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">highmem_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write_node</span><span class="p">(</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">highmem_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_write_highmem_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">highmem_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write_node</span><span class="p">(</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">highmem_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_write_highmem_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">highmem_base</span><span class="p">,</span> <span class="n">u64</span> <span class="n">highmem_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_write_highmem_base</span><span class="p">(</span><span class="n">region_index</span><span class="p">,</span> <span class="n">highmem_base</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="n">result</span>
		<span class="o">:</span> <span class="n">ps3_repository_write_highmem_size</span><span class="p">(</span><span class="n">region_index</span><span class="p">,</span> <span class="n">highmem_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_repository_delete_highmem_base</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">delete_node</span><span class="p">(</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;base&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_repository_delete_highmem_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">delete_node</span><span class="p">(</span>
		<span class="n">make_first_field</span><span class="p">(</span><span class="s">&quot;highmem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;region&quot;</span><span class="p">,</span> <span class="n">region_index</span><span class="p">),</span>
		<span class="n">make_field</span><span class="p">(</span><span class="s">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_delete_highmem_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_delete_highmem_base</span><span class="p">(</span><span class="n">region_index</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">+=</span> <span class="n">ps3_repository_delete_highmem_size</span><span class="p">(</span><span class="n">region_index</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* defined(CONFIG_PS3_WRITE_REPOSITORY) */</span><span class="cp"></span>

<span class="cp">#if defined(DEBUG)</span>

<span class="kt">int</span> <span class="nf">ps3_repository_dump_resource_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res_index</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d: (%u:%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">res_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">res_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ps3_interrupt_type</span> <span class="n">intr_type</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interrupt_id</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_intr</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">res_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interrupt_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span>  <span class="n">LV1_NO_ENTRY</span><span class="p">)</span>
				<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_dev_intr&quot;</span>
					<span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
					<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d (%u:%u) intr_type %u, interrupt_id %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span>
			<span class="n">intr_type</span><span class="p">,</span> <span class="n">interrupt_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">res_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">res_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">res_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ps3_reg_type</span> <span class="n">reg_type</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">bus_addr</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_reg</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">res_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span>  <span class="n">LV1_NO_ENTRY</span><span class="p">)</span>
				<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_dev_reg&quot;</span>
					<span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
					<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d (%u:%u) reg_type %u, bus_addr %llxh, len %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span>
			<span class="n">reg_type</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_stor_dev_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">region_index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">port</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d: (%u:%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_info</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
		<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blk_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_blocks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_regions</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_stor_dev_info&quot;</span>
			<span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d  (%u:%u): port %llu, blk_size %llu, num_blocks &quot;</span>
		 <span class="s">&quot;%llu, num_regions %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span>
		<span class="n">port</span><span class="p">,</span> <span class="n">blk_size</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">region_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">region_index</span> <span class="o">&lt;</span> <span class="n">num_regions</span><span class="p">;</span> <span class="n">region_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">region_id</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">region_start</span><span class="p">,</span> <span class="n">region_size</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_stor_dev_region</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="n">region_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region_id</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">region_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			 <span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_stor_dev_region&quot;</span>
				  <span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				  <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d (%u:%u) region_id %u, start %lxh, size %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span>
			<span class="n">region_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">region_start</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">region_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dump_device_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="o">*</span><span class="n">repo</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d: bus_%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span> <span class="o">&lt;</span> <span class="n">num_dev</span><span class="p">;</span>
		<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_type</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_dev_type&quot;</span>
				<span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_dev_id</span><span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_dev_id&quot;</span>
				<span class="s">&quot; (%u:%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d  (%u:%u): dev_type %u, dev_id %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_index</span><span class="p">,</span>
			<span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>

		<span class="n">ps3_repository_dump_resource_info</span><span class="p">(</span><span class="n">repo</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">PS3_BUS_TYPE_STORAGE</span><span class="p">)</span>
			<span class="n">dump_stor_dev_info</span><span class="p">(</span><span class="n">repo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_repository_dump_bus_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_repository_device</span> <span class="n">repo</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">repo</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_dev</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_type</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_type(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_id</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_id(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span> <span class="o">!=</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_id</span><span class="p">)</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d bus_index != bus_id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_bus_num_dev</span><span class="p">(</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">num_dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d read_bus_num_dev(%u) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s:%d bus_%u: bus_type %u, bus_id %lu, num_dev %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_index</span><span class="p">,</span> <span class="n">repo</span><span class="p">.</span><span class="n">bus_type</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">repo</span><span class="p">.</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">num_dev</span><span class="p">);</span>

		<span class="n">dump_device_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span> <span class="n">num_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* defined(DEBUG) */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
