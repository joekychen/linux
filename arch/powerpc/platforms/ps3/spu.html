<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › ps3 › spu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>spu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 Platform spu routines.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2006 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mmzone.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>

<span class="cp">#include &lt;asm/spu.h&gt;</span>
<span class="cp">#include &lt;asm/spu_priv1.h&gt;</span>
<span class="cp">#include &lt;asm/lv1call.h&gt;</span>
<span class="cp">#include &lt;asm/ps3.h&gt;</span>

<span class="cp">#include &quot;../cell/spufs/spufs.h&quot;</span>
<span class="cp">#include &quot;platform.h&quot;</span>

<span class="cm">/* spu_management_ops */</span>

<span class="cm">/**</span>
<span class="cm"> * enum spe_type - Type of spe to create.</span>
<span class="cm"> * @spe_type_logical: Standard logical spe.</span>
<span class="cm"> *</span>
<span class="cm"> * For use with lv1_construct_logical_spe().  The current HV does not support</span>
<span class="cm"> * any types other than those listed.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">spe_type</span> <span class="p">{</span>
	<span class="n">SPE_TYPE_LOGICAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct spe_shadow - logical spe shadow register area.</span>
<span class="cm"> *</span>
<span class="cm"> * Read-only shadow of spe registers.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">spe_shadow</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">padding_0140</span><span class="p">[</span><span class="mh">0x0140</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">int_status_class0_RW</span><span class="p">;</span>       <span class="cm">/* 0x0140 */</span>
	<span class="n">u64</span> <span class="n">int_status_class1_RW</span><span class="p">;</span>       <span class="cm">/* 0x0148 */</span>
	<span class="n">u64</span> <span class="n">int_status_class2_RW</span><span class="p">;</span>       <span class="cm">/* 0x0150 */</span>
	<span class="n">u8</span> <span class="n">padding_0158</span><span class="p">[</span><span class="mh">0x0610</span><span class="o">-</span><span class="mh">0x0158</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mfc_dsisr_RW</span><span class="p">;</span>               <span class="cm">/* 0x0610 */</span>
	<span class="n">u8</span> <span class="n">padding_0618</span><span class="p">[</span><span class="mh">0x0620</span><span class="o">-</span><span class="mh">0x0618</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mfc_dar_RW</span><span class="p">;</span>                 <span class="cm">/* 0x0620 */</span>
	<span class="n">u8</span> <span class="n">padding_0628</span><span class="p">[</span><span class="mh">0x0800</span><span class="o">-</span><span class="mh">0x0628</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mfc_dsipr_R</span><span class="p">;</span>                <span class="cm">/* 0x0800 */</span>
	<span class="n">u8</span> <span class="n">padding_0808</span><span class="p">[</span><span class="mh">0x0810</span><span class="o">-</span><span class="mh">0x0808</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mfc_lscrr_R</span><span class="p">;</span>                <span class="cm">/* 0x0810 */</span>
	<span class="n">u8</span> <span class="n">padding_0818</span><span class="p">[</span><span class="mh">0x0c00</span><span class="o">-</span><span class="mh">0x0818</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">mfc_cer_R</span><span class="p">;</span>                  <span class="cm">/* 0x0c00 */</span>
	<span class="n">u8</span> <span class="n">padding_0c08</span><span class="p">[</span><span class="mh">0x0f00</span><span class="o">-</span><span class="mh">0x0c08</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">spe_execution_status</span><span class="p">;</span>       <span class="cm">/* 0x0f00 */</span>
	<span class="n">u8</span> <span class="n">padding_0f08</span><span class="p">[</span><span class="mh">0x1000</span><span class="o">-</span><span class="mh">0x0f08</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum spe_ex_state - Logical spe execution state.</span>
<span class="cm"> * @spe_ex_state_unexecutable: Uninitialized.</span>
<span class="cm"> * @spe_ex_state_executable: Enabled, not ready.</span>
<span class="cm"> * @spe_ex_state_executed: Ready for use.</span>
<span class="cm"> *</span>
<span class="cm"> * The execution state (status) of the logical spe as reported in</span>
<span class="cm"> * struct spe_shadow:spe_execution_status.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">spe_ex_state</span> <span class="p">{</span>
	<span class="n">SPE_EX_STATE_UNEXECUTABLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SPE_EX_STATE_EXECUTABLE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">SPE_EX_STATE_EXECUTED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct priv1_cache - Cached values of priv1 registers.</span>
<span class="cm"> * @masks[]: Array of cached spe interrupt masks, indexed by class.</span>
<span class="cm"> * @sr1: Cached mfc_sr1 register.</span>
<span class="cm"> * @tclass_id: Cached mfc_tclass_id register.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">priv1_cache</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">masks</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">sr1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tclass_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct spu_pdata - Platform state variables.</span>
<span class="cm"> * @spe_id: HV spe id returned by lv1_construct_logical_spe().</span>
<span class="cm"> * @resource_id: HV spe resource id returned by</span>
<span class="cm"> * 	ps3_repository_read_spe_resource_id().</span>
<span class="cm"> * @priv2_addr: lpar address of spe priv2 area returned by</span>
<span class="cm"> * 	lv1_construct_logical_spe().</span>
<span class="cm"> * @shadow_addr: lpar address of spe register shadow area returned by</span>
<span class="cm"> * 	lv1_construct_logical_spe().</span>
<span class="cm"> * @shadow: Virtual (ioremap) address of spe register shadow area.</span>
<span class="cm"> * @cache: Cached values of priv1 registers.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">spu_pdata</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">spe_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">resource_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">priv2_addr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">shadow_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">spe_shadow</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">shadow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">priv1_cache</span> <span class="n">cache</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spu_pdata</span> <span class="o">*</span><span class="nf">spu_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dump_areas(_a, _b, _c, _d, _e) \</span>
<span class="cp">	_dump_areas(_a, _b, _c, _d, _e, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_areas</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spe_id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv2</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">problem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ls</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shadow</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: spe_id:  %xh (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">spe_id</span><span class="p">,</span> <span class="n">spe_id</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: priv2:   %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">priv2</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: problem: %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">problem</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: ls:      %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">ls</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: shadow:  %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">shadow</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="n">u64</span> <span class="nf">ps3_get_spe_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_get_spe_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_vas_id</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">lv1_get_logical_ppe_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">lv1_get_virtual_address_space_id_of_ppe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">construct_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">unused</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">problem_phys</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">local_store_phys</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_construct_logical_spe</span><span class="p">(</span><span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
		<span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">get_vas_id</span><span class="p">(),</span> <span class="n">SPE_TYPE_LOGICAL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv2_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">problem_phys</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">local_store_phys</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unused</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_addr</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">);</span>
	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem_phys</span> <span class="o">=</span> <span class="n">problem_phys</span><span class="p">;</span>
	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store_phys</span> <span class="o">=</span> <span class="n">local_store_phys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_construct_logical_spe failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spu_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">priv2</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="n">__force</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * setup_areas - Map the spu regions into the address space.</span>
<span class="cm"> *</span>
<span class="cm"> * The current HV requires the spu shadow regs to be mapped with the</span>
<span class="cm"> * PTE page protection bits set as read-only (PP=3).  This implementation</span>
<span class="cm"> * uses the low level __ioremap() to bypass the page protection settings</span>
<span class="cm"> * inforced by ioremap_prot() to get the needed PTE bits set for the</span>
<span class="cm"> * shadow regs.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_areas</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">table</span> <span class="p">{</span><span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shadow_flags</span> <span class="o">=</span> <span class="n">_PAGE_NO_CACHE</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span> <span class="o">=</span> <span class="n">__ioremap</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_addr</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spe_shadow</span><span class="p">),</span>
					   <span class="n">shadow_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: ioremap shadow failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ioremap_prot</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store_phys</span><span class="p">,</span>
		<span class="n">LS_SIZE</span><span class="p">,</span> <span class="n">_PAGE_NO_CACHE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: ioremap local_store failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem_phys</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_problem</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: ioremap problem failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">priv2</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv2_addr</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_priv2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">priv2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: ioremap priv2 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_ioremap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_areas</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv2_addr</span><span class="p">,</span>
		<span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem_phys</span><span class="p">,</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store_phys</span><span class="p">,</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_addr</span><span class="p">);</span>
	<span class="n">dump_areas</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">priv2</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_ioremap:</span>
	<span class="n">spu_unmap</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_spe_irq_setup</span><span class="p">(</span><span class="n">PS3_BINDING_CPU_ANY</span><span class="p">,</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_alloc_0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_spe_irq_setup</span><span class="p">(</span><span class="n">PS3_BINDING_CPU_ANY</span><span class="p">,</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_alloc_1</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_spe_irq_setup</span><span class="p">(</span><span class="n">PS3_BINDING_CPU_ANY</span><span class="p">,</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_alloc_2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">fail_alloc_2:</span>
	<span class="n">ps3_spe_irq_destroy</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nl">fail_alloc_1:</span>
	<span class="n">ps3_spe_irq_destroy</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="nl">fail_alloc_0:</span>
	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">enable_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_enable_logical_spe</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_enable_logical_spe failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">setup_areas</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_areas</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">setup_interrupts</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_interrupts</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_interrupts:</span>
	<span class="n">spu_unmap</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>
<span class="nl">fail_areas:</span>
	<span class="n">lv1_disable_logical_spe</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">fail_enable:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_destroy_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d spu_%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_disable_logical_spe</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">ps3_spe_irq_destroy</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">ps3_spe_irq_destroy</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">ps3_spe_irq_destroy</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>

	<span class="n">spu_unmap</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_destruct_logical_spe</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">);</span>
	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ps3_create_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d spu_%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">spu</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_pdata</span><span class="p">),</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_malloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">resource_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Init cached reg values to HV defaults. */</span>

	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">sr1</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">construct_spu</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_construct</span><span class="p">;</span>

	<span class="cm">/* For now, just go ahead and enable it. */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">enable_spu</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_enable</span><span class="p">;</span>

	<span class="cm">/* Make sure the spu is in SPE_EX_STATE_EXECUTED. */</span>

	<span class="cm">/* need something better here!!! */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">in_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">spe_execution_status</span><span class="p">)</span>
		<span class="o">!=</span> <span class="n">SPE_EX_STATE_EXECUTED</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">fail_enable:</span>
<span class="nl">fail_construct:</span>
	<span class="n">ps3_destroy_spu</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>
<span class="nl">fail_malloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ps3_enumerate_spus</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_resource_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_num_spu_resource_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_resource_id</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: num_resource_id %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">num_resource_id</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For now, just create logical spus equal to the number</span>
<span class="cm">	 * of physical spus reserved for the partition.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_resource_id</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">ps3_spu_resource_type</span> <span class="n">resource_type</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resource_id</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_spu_resource_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">resource_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resource_type</span> <span class="o">==</span> <span class="n">PS3_SPU_RESOURCE_TYPE_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">resource_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:%d: Error initializing spus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">num_resource_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_init_affinity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_enable_spu - Enable SPU run control.</span>
<span class="cm"> *</span>
<span class="cm"> * An outstanding enhancement for the PS3 would be to add a guard to check</span>
<span class="cm"> * for incorrect access to the spu problem state when the spu context is</span>
<span class="cm"> * disabled.  This check could be implemented with a flag added to the spu</span>
<span class="cm"> * context that would inhibit mapping problem state pages, and a routine</span>
<span class="cm"> * to unmap spu problem state pages.  When the spu is enabled with</span>
<span class="cm"> * ps3_enable_spu() the flag would be set allowing pages to be mapped,</span>
<span class="cm"> * and when the spu is disabled with ps3_disable_spu() the flag would be</span>
<span class="cm"> * cleared and the mapped problem state pages would be unmapped.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_enable_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_disable_spu</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">runcntl_stop</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">spu_management_ops</span> <span class="n">spu_management_ps3_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enumerate_spus</span> <span class="o">=</span> <span class="n">ps3_enumerate_spus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_spu</span> <span class="o">=</span> <span class="n">ps3_create_spu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy_spu</span> <span class="o">=</span> <span class="n">ps3_destroy_spu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enable_spu</span> <span class="o">=</span> <span class="n">ps3_enable_spu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_spu</span> <span class="o">=</span> <span class="n">ps3_disable_spu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_affinity</span> <span class="o">=</span> <span class="n">ps3_init_affinity</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* spu_priv1_ops */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_mask_and</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">old_mask</span><span class="p">;</span>

	<span class="cm">/* are these serialized by caller??? */</span>
	<span class="n">old_mask</span> <span class="o">=</span> <span class="n">spu_int_mask_get</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
	<span class="n">spu_int_mask_set</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">old_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_mask_or</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">old_mask</span><span class="p">;</span>

	<span class="n">old_mask</span> <span class="o">=</span> <span class="n">spu_int_mask_get</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
	<span class="n">spu_int_mask_set</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">old_mask</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="n">u64</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">masks</span><span class="p">[</span><span class="n">class</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">lv1_set_spe_interrupt_mask</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">masks</span><span class="p">[</span><span class="n">class</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">int_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">masks</span><span class="p">[</span><span class="n">class</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_stat_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="n">u64</span> <span class="n">stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note that MFC_DSISR will be cleared when class1[MF] is set. */</span>

	<span class="n">lv1_clear_spe_interrupt_status</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span>
		<span class="n">stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">int_stat_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">lv1_get_spe_interrupt_status</span><span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpu_affinity_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No support. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mfc_dar_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">in_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">mfc_dar_RW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mfc_dsisr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">dsisr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do, cleared in int_stat_clear(). */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mfc_dsisr_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">in_be64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="o">-&gt;</span><span class="n">mfc_dsisr_RW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mfc_sdr_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mfc_sr1_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check bits allowed by HV. */</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">allowed</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">MFC_STATE1_LOCAL_STORAGE_DECODE_MASK</span>
		<span class="o">|</span> <span class="n">MFC_STATE1_PROBLEM_STATE_MASK</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">sr1</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">sr1</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">));</span>

	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">sr1</span> <span class="o">=</span> <span class="n">sr1</span><span class="p">;</span>
	<span class="n">lv1_set_spe_privilege_state_area_1_register</span><span class="p">(</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_priv1</span><span class="p">,</span> <span class="n">mfc_sr1_RW</span><span class="p">),</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">sr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mfc_sr1_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">sr1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mfc_tclass_id_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tclass_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">tclass_id</span> <span class="o">=</span> <span class="n">tclass_id</span><span class="p">;</span>
	<span class="n">lv1_set_spe_privilege_state_area_1_register</span><span class="p">(</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spe_id</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu_priv1</span><span class="p">,</span> <span class="n">mfc_tclass_id_RW</span><span class="p">),</span>
		<span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">tclass_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mfc_tclass_id_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">spu_pdata</span><span class="p">(</span><span class="n">spu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cache</span><span class="p">.</span><span class="n">tclass_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlb_invalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resource_allocation_groupID_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No support. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">resource_allocation_groupID_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No support. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resource_allocation_enable_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No support. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">resource_allocation_enable_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No support. */</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">spu_priv1_ops</span> <span class="n">spu_priv1_ps3_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">int_mask_and</span> <span class="o">=</span> <span class="n">int_mask_and</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_mask_or</span> <span class="o">=</span> <span class="n">int_mask_or</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_mask_set</span> <span class="o">=</span> <span class="n">int_mask_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_mask_get</span> <span class="o">=</span> <span class="n">int_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_stat_clear</span> <span class="o">=</span> <span class="n">int_stat_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">int_stat_get</span> <span class="o">=</span> <span class="n">int_stat_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cpu_affinity_set</span> <span class="o">=</span> <span class="n">cpu_affinity_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_dar_get</span> <span class="o">=</span> <span class="n">mfc_dar_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_dsisr_set</span> <span class="o">=</span> <span class="n">mfc_dsisr_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_dsisr_get</span> <span class="o">=</span> <span class="n">mfc_dsisr_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_sdr_setup</span> <span class="o">=</span> <span class="n">mfc_sdr_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_sr1_set</span> <span class="o">=</span> <span class="n">mfc_sr1_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_sr1_get</span> <span class="o">=</span> <span class="n">mfc_sr1_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_tclass_id_set</span> <span class="o">=</span> <span class="n">mfc_tclass_id_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mfc_tclass_id_get</span> <span class="o">=</span> <span class="n">mfc_tclass_id_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlb_invalidate</span> <span class="o">=</span> <span class="n">tlb_invalidate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource_allocation_groupID_set</span> <span class="o">=</span> <span class="n">resource_allocation_groupID_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource_allocation_groupID_get</span> <span class="o">=</span> <span class="n">resource_allocation_groupID_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource_allocation_enable_set</span> <span class="o">=</span> <span class="n">resource_allocation_enable_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resource_allocation_enable_get</span> <span class="o">=</span> <span class="n">resource_allocation_enable_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ps3_spu_set_platform</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spu_priv1_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spu_priv1_ps3_ops</span><span class="p">;</span>
	<span class="n">spu_management_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">spu_management_ps3_ops</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
