<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › ps3 › os-area.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>os-area.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 flash memory os area.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2006 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/prom.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">OS_AREA_SEGMENT_SIZE</span> <span class="o">=</span> <span class="mi">0</span><span class="n">X200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">os_area_ldr_format</span> <span class="p">{</span>
	<span class="n">HEADER_LDR_FORMAT_RAW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">HEADER_LDR_FORMAT_GZIP</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define OS_AREA_HEADER_MAGIC_NUM &quot;cell_ext_os_area&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * struct os_area_header - os area header segment.</span>
<span class="cm"> * @magic_num: Always &#39;cell_ext_os_area&#39;.</span>
<span class="cm"> * @hdr_version: Header format version number.</span>
<span class="cm"> * @db_area_offset: Starting segment number of other os database area.</span>
<span class="cm"> * @ldr_area_offset: Starting segment number of bootloader image area.</span>
<span class="cm"> * @ldr_format: HEADER_LDR_FORMAT flag.</span>
<span class="cm"> * @ldr_size: Size of bootloader image in bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the docs refer to area offsets.  These are offsets in units of</span>
<span class="cm"> * segments from the start of the os area (top of the header).  These are</span>
<span class="cm"> * better thought of as segment numbers.  The os area of the os area is</span>
<span class="cm"> * reserved for the os image.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">os_area_header</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">magic_num</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">hdr_version</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">db_area_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ldr_area_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_reserved_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ldr_format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ldr_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_reserved_2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">os_area_boot_flag</span> <span class="p">{</span>
	<span class="n">PARAM_BOOT_FLAG_GAME_OS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PARAM_BOOT_FLAG_OTHER_OS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">os_area_ctrl_button</span> <span class="p">{</span>
	<span class="n">PARAM_CTRL_BUTTON_O_IS_YES</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PARAM_CTRL_BUTTON_X_IS_YES</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct os_area_params - os area params segment.</span>
<span class="cm"> * @boot_flag: User preference of operating system, PARAM_BOOT_FLAG flag.</span>
<span class="cm"> * @num_params: Number of params in this (params) segment.</span>
<span class="cm"> * @rtc_diff: Difference in seconds between 1970 and the ps3 rtc value.</span>
<span class="cm"> * @av_multi_out: User preference of AV output, PARAM_AV_MULTI_OUT flag.</span>
<span class="cm"> * @ctrl_button: User preference of controller button config, PARAM_CTRL_BUTTON</span>
<span class="cm"> *	flag.</span>
<span class="cm"> * @static_ip_addr: User preference of static IP address.</span>
<span class="cm"> * @network_mask: User preference of static network mask.</span>
<span class="cm"> * @default_gateway: User preference of static default gateway.</span>
<span class="cm"> * @dns_primary: User preference of static primary dns server.</span>
<span class="cm"> * @dns_secondary: User preference of static secondary dns server.</span>
<span class="cm"> *</span>
<span class="cm"> * The ps3 rtc maintains a read-only value that approximates seconds since</span>
<span class="cm"> * 2000-01-01 00:00:00 UTC.</span>
<span class="cm"> *</span>
<span class="cm"> * User preference of zero for static_ip_addr means use dhcp.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">os_area_params</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">boot_flag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_reserved_1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">num_params</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_reserved_2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="cm">/* param 0 */</span>
	<span class="n">s64</span> <span class="n">rtc_diff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">av_multi_out</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_button</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">_reserved_3</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="cm">/* param 1 */</span>
	<span class="n">u8</span> <span class="n">static_ip_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">network_mask</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">default_gateway</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">_reserved_4</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="cm">/* param 2 */</span>
	<span class="n">u8</span> <span class="n">dns_primary</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">dns_secondary</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">_reserved_5</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define OS_AREA_DB_MAGIC_NUM &quot;-db-&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * struct os_area_db - Shared flash memory database.</span>
<span class="cm"> * @magic_num: Always &#39;-db-&#39;.</span>
<span class="cm"> * @version: os_area_db format version number.</span>
<span class="cm"> * @index_64: byte offset of the database id index for 64 bit variables.</span>
<span class="cm"> * @count_64: number of usable 64 bit index entries</span>
<span class="cm"> * @index_32: byte offset of the database id index for 32 bit variables.</span>
<span class="cm"> * @count_32: number of usable 32 bit index entries</span>
<span class="cm"> * @index_16: byte offset of the database id index for 16 bit variables.</span>
<span class="cm"> * @count_16: number of usable 16 bit index entries</span>
<span class="cm"> *</span>
<span class="cm"> * Flash rom storage for exclusive use by guests running in the other os lpar.</span>
<span class="cm"> * The current system configuration allocates 1K (two segments) for other os</span>
<span class="cm"> * use.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">os_area_db</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">magic_num</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">_reserved_1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index_64</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count_64</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index_32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count_32</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index_16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">count_16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_reserved_2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">_db_data</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * enum os_area_db_owner - Data owners.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">os_area_db_owner</span> <span class="p">{</span>
	<span class="n">OS_AREA_DB_OWNER_ANY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_OWNER_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_OWNER_PROTOTYPE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_OWNER_LINUX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_OWNER_PETITBOOT</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_OWNER_MAX</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">os_area_db_key</span> <span class="p">{</span>
	<span class="n">OS_AREA_DB_KEY_ANY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_KEY_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_KEY_RTC_DIFF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_KEY_VIDEO_MODE</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">OS_AREA_DB_KEY_MAX</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">owner</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="n">os_area_db_id_empty</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">OS_AREA_DB_OWNER_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">OS_AREA_DB_KEY_NONE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="n">os_area_db_id_any</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">OS_AREA_DB_OWNER_ANY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">OS_AREA_DB_KEY_ANY</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="n">os_area_db_id_rtc_diff</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">OS_AREA_DB_OWNER_LINUX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">OS_AREA_DB_KEY_RTC_DIFF</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="n">os_area_db_id_video_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">OS_AREA_DB_OWNER_LINUX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">OS_AREA_DB_KEY_VIDEO_MODE</span>
<span class="p">};</span>

<span class="cp">#define SECONDS_FROM_1970_TO_2000 946684800LL</span>

<span class="cm">/**</span>
<span class="cm"> * struct saved_params - Static working copies of data from the PS3 &#39;os area&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * The order of preference we use for the rtc_diff source:</span>
<span class="cm"> *  1) The database value.</span>
<span class="cm"> *  2) The game os value.</span>
<span class="cm"> *  3) The number of seconds from 1970 to 2000.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">saved_params</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valid</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">rtc_diff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">av_multi_out</span><span class="p">;</span>
<span class="p">}</span> <span class="k">static</span> <span class="n">saved_params</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">property</span> <span class="n">property_rtc_diff</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;linux,rtc_diff&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">),</span>
	<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">property</span> <span class="n">property_av_multi_out</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;linux,av_multi_out&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">saved_params</span><span class="p">.</span><span class="n">av_multi_out</span><span class="p">),</span>
	<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saved_params</span><span class="p">.</span><span class="n">av_multi_out</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_os_area_flash_ops</span> <span class="o">*</span><span class="n">os_area_flash_ops</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">ps3_os_area_flash_register</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_os_area_flash_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>
	<span class="n">os_area_flash_ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_os_area_flash_register</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">os_area_flash_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os_area_flash_ops</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">os_area_flash_ops</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">os_area_flash_write</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">os_area_flash_ops</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">os_area_flash_ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os_area_flash_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * os_area_set_property - Add or overwrite a saved_params value to the device tree.</span>
<span class="cm"> *</span>
<span class="cm"> * Overwrites an existing property.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">os_area_set_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">of_find_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d found %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">prom_remove_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">prom_add_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">prop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d prom_set_property failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * os_area_get_property - Get a saved_params value from the device tree.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">os_area_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">prop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">of_find_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">prop</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">prop</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d not found %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">prop</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_field</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">field</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size_of_field</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(DEBUG)</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_of_field</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">isprint</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">?</span> <span class="n">field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define dump_header(_a) _dump_header(_a, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_header</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_header</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">dump_field</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.magic_num:       &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">str</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.hdr_version:     %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">hdr_version</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.db_area_offset:  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">db_area_offset</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.ldr_area_offset: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">ldr_area_offset</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.ldr_format:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">ldr_format</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: h.ldr_size:        %xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">ldr_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dump_params(_a) _dump_params(_a, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_params</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_params</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.boot_flag:       %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">boot_flag</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.num_params:      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">num_params</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.rtc_diff         %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rtc_diff</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.av_multi_out     %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">av_multi_out</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.ctrl_button:     %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ctrl_button</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.static_ip_addr:  %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">static_ip_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">static_ip_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">static_ip_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">static_ip_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.network_mask:    %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">network_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">network_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">network_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">network_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.default_gateway: %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">default_gateway</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">default_gateway</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">default_gateway</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">default_gateway</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.dns_primary:     %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_primary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_primary</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_primary</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_primary</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: p.dns_secondary:   %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_secondary</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_secondary</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_secondary</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dns_secondary</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_header</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">,</span> <span class="n">OS_AREA_HEADER_MAGIC_NUM</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d magic_num failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr_version</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d hdr_version failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">db_area_offset</span> <span class="o">&gt;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">ldr_area_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d offsets failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_verify</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">,</span> <span class="n">OS_AREA_DB_MAGIC_NUM</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d magic_num failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d version failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">db_index</span> <span class="p">{</span>
       <span class="kt">uint8_t</span> <span class="n">owner</span><span class="o">:</span><span class="mi">5</span><span class="p">;</span>
       <span class="kt">uint8_t</span> <span class="n">key</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">db_iterator</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="n">match_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">db_index</span> <span class="o">*</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">db_index</span> <span class="o">*</span><span class="n">last_idx</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="o">*</span><span class="n">value_64</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">value_32</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">value_16</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">db_align_up</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * db_for_each_64 - Iterator for 64 bit entries.</span>
<span class="cm"> *</span>
<span class="cm"> * A NULL value for id can be used to match all entries.</span>
<span class="cm"> * OS_AREA_DB_OWNER_ANY and OS_AREA_DB_KEY_ANY can be used to match all.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_for_each_64</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="o">*</span><span class="n">match_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">db_iterator</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="nl">next:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">db</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">match_id</span> <span class="o">=</span> <span class="n">match_id</span> <span class="o">?</span> <span class="o">*</span><span class="n">match_id</span> <span class="o">:</span> <span class="n">os_area_db_id_any</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">db</span> <span class="o">+</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">index_64</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">last_idx</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">count_64</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">value_64</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">db</span> <span class="o">+</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">index_64</span>
			<span class="o">+</span> <span class="n">db_align_up</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">count_64</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">value_64</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">last_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: reached end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">match_id</span><span class="p">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="n">OS_AREA_DB_OWNER_ANY</span>
		<span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">match_id</span><span class="p">.</span><span class="n">owner</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">match_id</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">OS_AREA_DB_KEY_ANY</span>
		<span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">match_id</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_delete_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db_iterator</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">db_for_each_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: got (%d:%d) %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span><span class="p">);</span>

		<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_set_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
	<span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db_iterator</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: (%d:%d) &lt;= %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">==</span> <span class="n">OS_AREA_DB_OWNER_ANY</span>
		<span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">OS_AREA_DB_KEY_ANY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: bad id: (%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">__LINE__</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db_delete_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">i</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db_for_each_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os_area_db_id_empty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: got (%d:%d) %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span><span class="p">);</span>

		<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
		<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
		<span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: set (%d:%d) &lt;= %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">idx</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: database full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_get_64</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db_iterator</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span><span class="p">.</span><span class="n">db</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">db_for_each_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: found %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">.</span><span class="n">value_64</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db_get_rtc_diff</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="o">*</span><span class="n">rtc_diff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">db_get_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os_area_db_id_rtc_diff</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">rtc_diff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define dump_db(a) _dump_db(a, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dump_db</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">dump_field</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.magic_num:      &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">str</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.version:         %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.index_64:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_64</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.count_64:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_64</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.index_32:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_32</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.count_32:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_32</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.index_16:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_16</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d: db.count_16:        %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">os_area_db_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">HEADER_SIZE</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">,</span> <span class="n">_db_data</span><span class="p">),</span>
		<span class="n">INDEX_64_COUNT</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="n">VALUES_64_COUNT</span> <span class="o">=</span> <span class="mi">57</span><span class="p">,</span>
		<span class="n">INDEX_32_COUNT</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="n">VALUES_32_COUNT</span> <span class="o">=</span> <span class="mi">57</span><span class="p">,</span>
		<span class="n">INDEX_16_COUNT</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="n">VALUES_16_COUNT</span> <span class="o">=</span> <span class="mi">57</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">,</span> <span class="n">OS_AREA_DB_MAGIC_NUM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">magic_num</span><span class="p">));</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_64</span> <span class="o">=</span> <span class="n">HEADER_SIZE</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_64</span> <span class="o">=</span> <span class="n">VALUES_64_COUNT</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_32</span> <span class="o">=</span> <span class="n">HEADER_SIZE</span>
			<span class="o">+</span> <span class="n">INDEX_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_32</span> <span class="o">=</span> <span class="n">VALUES_32_COUNT</span><span class="p">;</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">index_16</span> <span class="o">=</span> <span class="n">HEADER_SIZE</span>
			<span class="o">+</span> <span class="n">INDEX_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">INDEX_32_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_32_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">db</span><span class="o">-&gt;</span><span class="n">count_16</span> <span class="o">=</span> <span class="n">VALUES_16_COUNT</span><span class="p">;</span>

	<span class="cm">/* Rules to check db layout. */</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">OS_AREA_SEGMENT_SIZE</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">INDEX_64_COUNT</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">VALUES_64_COUNT</span> <span class="o">&gt;</span> <span class="n">INDEX_64_COUNT</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">INDEX_32_COUNT</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">VALUES_32_COUNT</span> <span class="o">&gt;</span> <span class="n">INDEX_32_COUNT</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">INDEX_16_COUNT</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">VALUES_16_COUNT</span> <span class="o">&gt;</span> <span class="n">INDEX_16_COUNT</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">HEADER_SIZE</span>
			<span class="o">+</span> <span class="n">INDEX_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_64_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">INDEX_32_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_32_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">INDEX_16_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db_index</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">VALUES_16_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span>
			<span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_flash_db - Helper for os_area_queue_work_handler.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_flash_db</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">OS_AREA_SEGMENT_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_db</span><span class="o">*</span> <span class="n">db</span><span class="p">;</span>

	<span class="cm">/* Read in header and db from flash. */</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">os_area_flash_read</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: os_area_flash_read failed %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">count</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">db_area_offset</span> <span class="o">*</span> <span class="n">OS_AREA_SEGMENT_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">OS_AREA_SEGMENT_SIZE</span> <span class="o">||</span> <span class="n">verify_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">count</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: verify_header failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dump_header</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now got a good db offset and some maybe good db data. */</span>

	<span class="n">db</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">db_verify</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: Verify of flash database failed, formatting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dump_db</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
		<span class="n">os_area_db_init</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now got good db data. */</span>

	<span class="n">db_set_64</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">os_area_db_id_rtc_diff</span><span class="p">,</span> <span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">os_area_flash_write</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">),</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: os_area_flash_write failed %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">count</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * os_area_queue_work_handler - Asynchronous write handler.</span>
<span class="cm"> *</span>
<span class="cm"> * An asynchronous write for flash memory and the device tree.  Do not</span>
<span class="cm"> * call directly, use os_area_queue_work().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">os_area_queue_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">os_area_set_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_rtc_diff</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d of_find_node_by_path failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">update_flash_db</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Could not update FLASH ROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">os_area_queue_work</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">os_area_queue_work_handler</span><span class="p">);</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_os_area_save_params - Copy data from os area mirror to @saved_params.</span>
<span class="cm"> *</span>
<span class="cm"> * For the convenience of the guest the HV makes a copy of the os area in</span>
<span class="cm"> * flash to a high address in the boot memory region and then puts that RAM</span>
<span class="cm"> * address and the byte count into the repository for retrieval by the guest.</span>
<span class="cm"> * We copy the data we want into a static variable and allow the memory setup</span>
<span class="cm"> * by the HV to be claimed by the memblock manager.</span>
<span class="cm"> *</span>
<span class="cm"> * The os area mirror will not be available to a second stage kernel, and</span>
<span class="cm"> * the header verify will fail.  In this case, the saved_params values will</span>
<span class="cm"> * be set from flash memory or the passed in device tree in ps3_os_area_init().</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_os_area_save_params</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">lpar_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_header</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="n">db</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_boot_dat_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lpar_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d ps3_repository_read_boot_dat_info failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">os_area_header</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">lpar_addr</span><span class="p">);</span>
	<span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">os_area_params</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">lpar_addr</span>
		<span class="o">+</span> <span class="n">OS_AREA_SEGMENT_SIZE</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">verify_header</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Second stage kernels exit here. */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d verify_header failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">dump_header</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">db</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">os_area_db</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">lpar_addr</span>
		<span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">db_area_offset</span> <span class="o">*</span> <span class="n">OS_AREA_SEGMENT_SIZE</span><span class="p">);</span>

	<span class="n">dump_header</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">dump_params</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="n">dump_db</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">db_verify</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="o">||</span> <span class="n">db_get_rtc_diff</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">rtc_diff</span> <span class="o">?</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">rtc_diff</span>
			<span class="o">:</span> <span class="n">SECONDS_FROM_1970_TO_2000</span><span class="p">;</span>
	<span class="n">saved_params</span><span class="p">.</span><span class="n">av_multi_out</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">av_multi_out</span><span class="p">;</span>
	<span class="n">saved_params</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">));</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_os_area_init - Setup os area device tree properties as needed.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_os_area_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saved_params</span><span class="p">.</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Second stage kernels should have a dt entry. */</span>
		<span class="n">os_area_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_rtc_diff</span><span class="p">);</span>
		<span class="n">os_area_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_av_multi_out</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">)</span>
		<span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span> <span class="o">=</span> <span class="n">SECONDS_FROM_1970_TO_2000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">os_area_set_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_rtc_diff</span><span class="p">);</span>
		<span class="n">os_area_set_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property_av_multi_out</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s:%d of_find_node_by_path failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_os_area_get_rtc_diff - Returns the rtc diff value.</span>
<span class="cm"> */</span>

<span class="n">u64</span> <span class="nf">ps3_os_area_get_rtc_diff</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_os_area_get_rtc_diff</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_os_area_set_rtc_diff - Set the rtc diff value.</span>
<span class="cm"> *</span>
<span class="cm"> * An asynchronous write is needed to support writing updates from</span>
<span class="cm"> * the timer interrupt context.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_os_area_set_rtc_diff</span><span class="p">(</span><span class="n">u64</span> <span class="n">rtc_diff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span> <span class="o">!=</span> <span class="n">rtc_diff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_params</span><span class="p">.</span><span class="n">rtc_diff</span> <span class="o">=</span> <span class="n">rtc_diff</span><span class="p">;</span>
		<span class="n">os_area_queue_work</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_os_area_set_rtc_diff</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_os_area_get_av_multi_out - Returns the default video mode.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">ps3_param_av_multi_out</span> <span class="nf">ps3_os_area_get_av_multi_out</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">saved_params</span><span class="p">.</span><span class="n">av_multi_out</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ps3_os_area_get_av_multi_out</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
