<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › ps3 › mm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  PS3 address space management.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2006 Sony Computer Entertainment Inc.</span>
<span class="cm"> *  Copyright 2006 Sony Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/cell-regs.h&gt;</span>
<span class="cp">#include &lt;asm/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/udbg.h&gt;</span>
<span class="cp">#include &lt;asm/lv1call.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>

<span class="cp">#if defined(DEBUG)</span>
<span class="cp">#define DBG udbg_printf</span>
<span class="cp">#else</span>
<span class="cp">#define DBG pr_devel</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="p">{</span>
<span class="cp">#if defined(CONFIG_PS3_DYNAMIC_DMA)</span>
	<span class="n">USE_DYNAMIC_DMA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="n">USE_DYNAMIC_DMA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PAGE_SHIFT_4K</span> <span class="o">=</span> <span class="mi">12U</span><span class="p">,</span>
	<span class="n">PAGE_SHIFT_64K</span> <span class="o">=</span> <span class="mi">16U</span><span class="p">,</span>
	<span class="n">PAGE_SHIFT_16M</span> <span class="o">=</span> <span class="mi">24U</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">make_page_sizes</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="mi">48</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ALLOCATE_MEMORY_TRY_ALT_UNIT</span> <span class="o">=</span> <span class="mi">0</span><span class="n">X04</span><span class="p">,</span>
	<span class="n">ALLOCATE_MEMORY_ADDR_ZERO</span> <span class="o">=</span> <span class="mi">0</span><span class="n">X08</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* valid htab sizes are {18,19,20} = 256K, 512K, 1M */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HTAB_SIZE_MAX</span> <span class="o">=</span> <span class="mi">20U</span><span class="p">,</span> <span class="cm">/* HV limit of 1MB */</span>
	<span class="n">HTAB_SIZE_MIN</span> <span class="o">=</span> <span class="mi">18U</span><span class="p">,</span> <span class="cm">/* CPU limit of 256KB */</span>
<span class="p">};</span>

<span class="cm">/*============================================================================*/</span>
<span class="cm">/* virtual address space routines                                             */</span>
<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm"> * struct mem_region - memory region structure</span>
<span class="cm"> * @base: base address</span>
<span class="cm"> * @size: size in bytes</span>
<span class="cm"> * @offset: difference between base and rm.size</span>
<span class="cm"> * @destroy: flag if region should be destroyed upon shutdown</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">mem_region</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destroy</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct map - address space state variables holder</span>
<span class="cm"> * @total: total memory available as reported by HV</span>
<span class="cm"> * @vas_id - HV virtual address space id</span>
<span class="cm"> * @htab_size: htab size in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * The HV virtual address space (vas) allows for hotplug memory regions.</span>
<span class="cm"> * Memory regions can be created and destroyed in the vas at runtime.</span>
<span class="cm"> * @rm: real mode (bootmem) region</span>
<span class="cm"> * @r1: highmem region(s)</span>
<span class="cm"> *</span>
<span class="cm"> * ps3 addresses</span>
<span class="cm"> * virt_addr: a cpu &#39;translated&#39; effective address</span>
<span class="cm"> * phys_addr: an address in what Linux thinks is the physical address space</span>
<span class="cm"> * lpar_addr: an address in the HV virtual address space</span>
<span class="cm"> * bus_addr: an io controller &#39;translated&#39; address on a device bus</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">map</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vas_id</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">htab_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_region</span> <span class="n">rm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mem_region</span> <span class="n">r1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define debug_dump_map(x) _debug_dump_map(x, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__maybe_unused</span> <span class="nf">_debug_dump_map</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">map</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.total     = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.rm.size   = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.vas_id    = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vas_id</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.htab_size = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">htab_size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.r1.base   = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.r1.offset = %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.r1.size   = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">map</span> <span class="n">map</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_phys_to_lpar - translate a linux physical address to lpar address</span>
<span class="cm"> * @phys_addr: linux physical address</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">phys_addr</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span> <span class="n">phys_addr</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">total</span><span class="p">)</span>
		<span class="o">?</span> <span class="n">phys_addr</span> <span class="o">:</span> <span class="n">phys_addr</span> <span class="o">+</span> <span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_mm_phys_to_lpar</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_vas_create - create the virtual address space</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_mm_vas_create</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span> <span class="n">htab_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start_address</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">access_right</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">max_page_size</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_query_logical_partition_address_region_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">start_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">access_right</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_page_size</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_query_logical_partition_address_region_info &quot;</span>
			<span class="s">&quot;failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_page_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SHIFT_16M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: bad max_page_size %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">max_page_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">CONFIG_PS3_HTAB_SIZE</span> <span class="o">&gt;</span> <span class="n">HTAB_SIZE_MAX</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">CONFIG_PS3_HTAB_SIZE</span> <span class="o">&lt;</span> <span class="n">HTAB_SIZE_MIN</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_construct_virtual_address_space</span><span class="p">(</span><span class="n">CONFIG_PS3_HTAB_SIZE</span><span class="p">,</span>
			<span class="mi">2</span><span class="p">,</span> <span class="n">make_page_sizes</span><span class="p">(</span><span class="n">PAGE_SHIFT_16M</span><span class="p">,</span> <span class="n">PAGE_SHIFT_64K</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">vas_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">htab_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_construct_virtual_address_space failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_select_virtual_address_space</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">vas_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_select_virtual_address_space failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">htab_size</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">htab_size</span><span class="p">;</span>

	<span class="n">debug_dump_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ps3_mm_vas_create failed&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_vas_destroy -</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_mm_vas_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: map.vas_id    = %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">vas_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">vas_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_select_virtual_address_space</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_destruct_virtual_address_space</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">vas_id</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
		<span class="n">map</span><span class="p">.</span><span class="n">vas_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_region_create - create a memory region in the vas</span>
<span class="cm"> * @r: pointer to a struct mem_region to accept initialized values</span>
<span class="cm"> * @size: requested region size</span>
<span class="cm"> *</span>
<span class="cm"> * This implementation creates the region with the vas large page size.</span>
<span class="cm"> * @size is rounded down to a multiple of the vas large page size.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_mm_region_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">muid</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT_16M</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d requested  %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d actual     %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d difference %llxh (%lluMB)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: size == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">zero_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_allocate_memory</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SHIFT_16M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">ALLOCATE_MEMORY_TRY_ALT_UNIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">muid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_allocate_memory failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">zero_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">destroy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">zero_region:</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_region_destroy - destroy a memory region</span>
<span class="cm"> * @r: pointer to struct mem_region</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ps3_mm_region_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d: Not destroying high region: %llxh %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r-&gt;base = %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_release_memory</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">map</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ps3_mm_get_repository_highmem</span><span class="p">(</span><span class="k">struct</span> <span class="n">mem_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* Assume a single highmem region. */</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_highmem_info</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">zero_region</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">||</span> <span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">zero_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: Found high region in repository: %llxh %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">zero_region:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: No high region in repository.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>
<span class="cm">/* dma routines                                                               */</span>
<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_lpar_to_bus - Translate an lpar address to ioc mapped bus address.</span>
<span class="cm"> * @r: pointer to dma region structure</span>
<span class="cm"> * @lpar_addr: HV lpar address</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpar_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lpar_addr</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">lpar_addr</span> <span class="o">-=</span> <span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lpar_addr</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">lpar_addr</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">lpar_addr</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dma_dump_region(_a) _dma_dump_region(_a, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">__maybe_unused</span> <span class="nf">_dma_dump_region</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: dev        %llu:%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: page_size  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: bus_addr   %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: len        %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: offset     %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm"> * dma_chunk - A chunk of dma pages mapped by the io controller.</span>
<span class="cm"> * @region - The dma region that owns this chunk.</span>
<span class="cm"> * @lpar_addr: Starting lpar address of the area to map.</span>
<span class="cm"> * @bus_addr: Starting ioc bus address of the area to map.</span>
<span class="cm"> * @len: Length in bytes of the area to map.</span>
<span class="cm"> * @link: A struct list_head used with struct ps3_dma_region.chunk_list, the</span>
<span class="cm"> * list of all chuncks owned by the region.</span>
<span class="cm"> *</span>
<span class="cm"> * This implementation uses a very simple dma page manager</span>
<span class="cm"> * based on the dma_chunk structure.  This scheme assumes</span>
<span class="cm"> * that all drivers use very well behaved dma ops.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpar_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usage_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define dma_dump_chunk(_a) _dma_dump_chunk(_a, __func__, __LINE__)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_dma_dump_chunk</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dma_chunk</span><span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">func</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r.dev        %llu:%llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r.bus_addr   %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r.page_size  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r.len        %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: r.offset     %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: c.lpar_addr  %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: c.bus_addr   %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: c.len        %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span> <span class="nf">dma_find_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_bus</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="n">bus_addr</span><span class="o">-</span><span class="n">aligned_bus</span><span class="p">,</span>
					      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* intersection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aligned_bus</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">aligned_bus</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

		<span class="cm">/* below */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aligned_bus</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* above */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aligned_bus</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* we don&#39;t handle the multi-chunk case for now */</span>
		<span class="n">dma_dump_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="nf">dma_find_chunk_lpar</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpar_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_lpar</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">lpar_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">lpar_addr</span> <span class="o">-</span> <span class="n">aligned_lpar</span><span class="p">,</span>
					      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* intersection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">&lt;=</span> <span class="n">aligned_lpar</span> <span class="o">&amp;&amp;</span>
		    <span class="n">aligned_lpar</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aligned_lpar</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">dma_dump_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
				<span class="n">BUG</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* below */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aligned_lpar</span> <span class="o">+</span> <span class="n">aligned_len</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* above */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">aligned_lpar</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_free_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_unmap_device_dma_region</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_free_chunk</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iopage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iopage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iopage</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span> <span class="n">iopage</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">iopage</span><span class="p">;</span>
		<span class="cm">/* put INVALID entry */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_put_iopte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				       <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">r</span><span class="o">-&gt;</span><span class="n">ioid</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: bus=%#lx, lpar=%#lx, ioid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		    <span class="n">r</span><span class="o">-&gt;</span><span class="n">ioid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_put_iopte failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_map_pages - Maps dma pages into the io controller bus address space.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> * @phys_addr: Starting physical address of the area to map.</span>
<span class="cm"> * @len: Length in bytes of the area to map.</span>
<span class="cm"> * c_out: A pointer to receive an allocated struct dma_chunk for this area.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the lowest level dma mapping routine, and is the one that will</span>
<span class="cm"> * make the HV call to add the pages into the io controller address space.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_map_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">,</span>
	    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">**</span><span class="n">c_out</span><span class="p">,</span> <span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chunk</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">iopte_flag</span> <span class="o">!=</span> <span class="mh">0xf800000000000000UL</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_map_device_dma_region</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span>
					   <span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span><span class="p">,</span>
					   <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">iopte_flag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_map_device_dma_region failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>

	<span class="o">*</span><span class="n">c_out</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_map:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="nl">fail_alloc:</span>
	<span class="o">*</span><span class="n">c_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_map_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">**</span><span class="n">c_out</span><span class="p">,</span>
			      <span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iopage</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: phy=%#lx, lpar%#lx, len=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">phys_addr</span><span class="p">,</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chunk</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">region</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="cm">/* allocate IO address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* first one */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* derive from last bus addr*/</span>
		<span class="n">last</span>  <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dma_chunk</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: last bus=%#lx, len=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">last</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">last</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: check whether length exceeds region size */</span>

	<span class="cm">/* build ioptes for the area */</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: pgsize=%#x len=%#lx pages=%#x iopteflag=%#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">iopte_flag</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iopage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">iopage</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">iopage</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">iopage</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_put_iopte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				       <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">r</span><span class="o">-&gt;</span><span class="n">ioid</span><span class="p">,</span>
				       <span class="n">iopte_flag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_put_iopte failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">fail_map</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: pg=%d bus=%#lx, lpar=%#lx, ioid=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		    <span class="n">iopage</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		    <span class="n">r</span><span class="o">-&gt;</span><span class="n">ioid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* be sure that last allocated one is inserted at head */</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>

	<span class="o">*</span><span class="n">c_out</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_map:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">iopage</span><span class="o">--</span><span class="p">;</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">iopage</span><span class="p">;</span> <span class="n">iopage</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lv1_put_iopte</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
			      <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="n">c</span><span class="o">-&gt;</span><span class="n">lpar_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="n">r</span><span class="o">-&gt;</span><span class="n">ioid</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="nl">fail_alloc:</span>
	<span class="o">*</span><span class="n">c_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_region_create - Create a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the lowest level dma region create routine, and is the one that</span>
<span class="cm"> * will make the HV call to create the region.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_region_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bus_addr</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d: %llu:%llu no dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%u: len = 0x%lx, page_size = %u, offset = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">__LINE__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_allocate_device_dma_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span>
		<span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">region_type</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">bus_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_allocate_device_dma_region failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_region_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bus_addr</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_allocate_io_segment</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
					 <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					 <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_allocate_io_segment failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: len=%#lx, pg=%d, bus=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_region_free - Free a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the lowest level dma region free routine, and is the one that</span>
<span class="cm"> * will make the HV call to free the region.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_region_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d: %llu:%llu no dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">dma_sb_free_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_free_device_dma_region</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_id</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_free_device_dma_region failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_region_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">dma_ioc0_free_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lv1_release_io_segment</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: lv1_free_device_dma_region failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">ps3_result</span><span class="p">(</span><span class="n">result</span><span class="p">));</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_map_area - Map an area of memory into a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> * @virt_addr: Starting virtual address of the area to map.</span>
<span class="cm"> * @len: Length in bytes of the area to map.</span>
<span class="cm"> * @bus_addr: A pointer to return the starting ioc bus address of the area to</span>
<span class="cm"> * map.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the common dma mapping routine.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_map_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt_addr</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span>
	   <span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span> <span class="o">=</span> <span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span> <span class="o">?</span> <span class="n">__pa</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">virt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_phys</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="n">aligned_phys</span><span class="p">,</span>
					      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USE_DYNAMIC_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d virt_addr %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">virt_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d phys_addr %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">phys_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d lpar_addr %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
			<span class="n">lpar_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d len       %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d bus_addr  %llxh (%lxh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span>
		<span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">dma_find_chunk</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: reusing mapped chunk&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">dma_dump_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_map_pages</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aligned_phys</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">iopte_flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: dma_sb_map_pages failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_map_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt_addr</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span>
	     <span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span> <span class="o">=</span> <span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span> <span class="o">?</span> <span class="n">__pa</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">virt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_phys</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="n">aligned_phys</span><span class="p">,</span>
					      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: vaddr=%#lx, len=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">virt_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ph=%#lx a_ph=%#lx a_l=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">phys_addr</span><span class="p">,</span> <span class="n">aligned_phys</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">dma_find_chunk_lpar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME */</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="n">aligned_phys</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dma_ioc0_map_pages</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">aligned_phys</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span>
				    <span class="n">iopte_flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: dma_ioc0_map_pages failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="n">phys_addr</span> <span class="o">-</span> <span class="n">aligned_phys</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: va=%#lx pa=%#lx a_pa=%#lx bus=%#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	    <span class="n">virt_addr</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">aligned_phys</span><span class="p">,</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_unmap_area - Unmap an area of memory from a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> * @bus_addr: The starting ioc bus address of the area to unmap.</span>
<span class="cm"> * @len: Length in bytes of the area to unmap.</span>
<span class="cm"> *</span>
<span class="cm"> * This is the common dma unmap routine.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_unmap_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">dma_find_chunk</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_bus</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">bus_addr</span>
			<span class="o">-</span> <span class="n">aligned_bus</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: bus_addr %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: len %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: aligned_bus %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">aligned_bus</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: aligned_len %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">dma_sb_free_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioc0_unmap_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
			<span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chunk</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: start a=%#llx l=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">dma_find_chunk</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_bus</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span>
							<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aligned_len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">bus_addr</span>
						      <span class="o">-</span> <span class="n">aligned_bus</span><span class="p">,</span>
						      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: bus_addr %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: len %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: aligned_bus %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">aligned_bus</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: not found: aligned_len %lxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">aligned_len</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">usage_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">dma_ioc0_free_chunk</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">chunk_list</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_region_create_linear - Setup a linear dma mapping for a device.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine creates an HV dma region for the device and maps all available</span>
<span class="cm"> * ram into the io controller bus address space.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_region_create_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FIXME: need proper fix */</span>
		<span class="cm">/* force 16M dma pages for linear mapping */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">!=</span> <span class="n">PS3_DMA_16M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:%d: forcing 16M pages for linear map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">PS3_DMA_16M</span><span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_region_create</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Map (part of) 1st RAM chunk */</span>
		<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_map_area</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
			<span class="n">CBE_IOPTE_PP_W</span> <span class="o">|</span> <span class="n">CBE_IOPTE_PP_R</span> <span class="o">|</span> <span class="n">CBE_IOPTE_SO_RW</span> <span class="o">|</span>
			<span class="n">CBE_IOPTE_M</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Map (part of) 2nd RAM chunk */</span>
		<span class="n">virt_addr</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="n">virt_addr</span> <span class="o">+=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_map_area</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
			<span class="n">CBE_IOPTE_PP_W</span> <span class="o">|</span> <span class="n">CBE_IOPTE_PP_R</span> <span class="o">|</span> <span class="n">CBE_IOPTE_SO_RW</span> <span class="o">|</span>
			<span class="n">CBE_IOPTE_M</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_region_free_linear - Free a linear dma mapping for a device.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will unmap all mapped areas and free the HV dma region.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_region_free_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">lpar_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unmap (part of) 1st RAM chunk */</span>
		<span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lpar_addr</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_unmap_area</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unmap (part of) 2nd RAM chunk */</span>
		<span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="n">lpar_addr</span> <span class="o">+=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">lpar_addr</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_unmap_area</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dma_sb_region_free</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_sb_map_area_linear - Map an area of memory into a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> * @virt_addr: Starting virtual address of the area to map.</span>
<span class="cm"> * @len: Length in bytes of the area to map.</span>
<span class="cm"> * @bus_addr: A pointer to return the starting ioc bus address of the area to</span>
<span class="cm"> * map.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine just returns the corresponding bus address.  Actual mapping</span>
<span class="cm"> * occurs in dma_region_create_linear().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_map_area_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_addr</span> <span class="o">=</span> <span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span> <span class="o">?</span> <span class="n">__pa</span><span class="p">(</span><span class="n">virt_addr</span><span class="p">)</span>
		<span class="o">:</span> <span class="n">virt_addr</span><span class="p">;</span>
	<span class="o">*</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="n">dma_sb_lpar_to_bus</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dma_unmap_area_linear - Unmap an area of memory from a device dma region.</span>
<span class="cm"> * @r: Pointer to a struct ps3_dma_region.</span>
<span class="cm"> * @bus_addr: The starting ioc bus address of the area to unmap.</span>
<span class="cm"> * @len: Length in bytes of the area to unmap.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine does nothing.  Unmapping occurs in dma_sb_region_free_linear().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_sb_unmap_area_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span>
	<span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_dma_region_ops</span> <span class="n">ps3_dma_sb_region_ops</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">dma_sb_region_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">dma_sb_region_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">dma_sb_map_area</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap</span> <span class="o">=</span> <span class="n">dma_sb_unmap_area</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_dma_region_ops</span> <span class="n">ps3_dma_sb_region_linear_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">dma_sb_region_create_linear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">dma_sb_region_free_linear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">dma_sb_map_area_linear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap</span> <span class="o">=</span> <span class="n">dma_sb_unmap_area_linear</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ps3_dma_region_ops</span> <span class="n">ps3_dma_ioc0_region_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">dma_ioc0_region_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">dma_ioc0_region_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">dma_ioc0_map_area</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap</span> <span class="o">=</span> <span class="n">dma_ioc0_unmap_area</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ps3_dma_region_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_system_bus_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ps3_dma_page_size</span> <span class="n">page_size</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ps3_dma_region_type</span> <span class="n">region_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpar_addr</span><span class="p">;</span>

	<span class="n">lpar_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">?</span> <span class="n">ps3_mm_phys_to_lpar</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span> <span class="o">=</span> <span class="n">page_size</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">region_type</span> <span class="o">=</span> <span class="n">region_type</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">lpar_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">-=</span> <span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">total</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">page_size</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PS3_DEVICE_TYPE_SB</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span> <span class="o">=</span>  <span class="p">(</span><span class="n">USE_DYNAMIC_DMA</span><span class="p">)</span>
			<span class="o">?</span> <span class="o">&amp;</span><span class="n">ps3_dma_sb_region_ops</span>
			<span class="o">:</span> <span class="o">&amp;</span><span class="n">ps3_dma_sb_region_linear_ops</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PS3_DEVICE_TYPE_IOC0</span>:
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ps3_dma_ioc0_region_ops</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_dma_region_init</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_dma_region_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_dma_region_create</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_dma_region_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ps3_dma_region_free</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ps3_dma_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">iopte_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">iopte_flag</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ps3_dma_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ps3_dma_region</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">region_ops</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>
<span class="cm">/* system startup routines                                                    */</span>
<span class="cm">/*============================================================================*/</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_init - initialize the address space state variables</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">ps3_mm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; -&gt; %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ps3_repository_read_mm_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">total</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ps3_repository_read_mm_info() failed&quot;</span><span class="p">);</span>

	<span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">map</span><span class="p">.</span><span class="n">vas_id</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">htab_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* this implementation assumes map.rm.base is zero */</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Check if we got the highmem region from an earlier boot step */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps3_mm_get_repository_highmem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">))</span>
		<span class="n">ps3_mm_region_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* correct map.total for the real total amount of memory we use */</span>
	<span class="n">map</span><span class="p">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: No highmem region found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s:%d: Adding highmem region: %llxh %llxh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			<span class="n">map</span><span class="p">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="n">memblock_add</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">map</span><span class="p">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">map</span><span class="p">.</span><span class="n">rm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; &lt;- %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ps3_mm_shutdown - final cleanup of address space</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">ps3_mm_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ps3_mm_region_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">.</span><span class="n">r1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
