<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › pseries › cmm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cmm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Collaborative memory management interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 IBM Corporation</span>
<span class="cm"> * Author(s): Brian King (brking@linux.vnet.ibm.com),</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/oom.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;asm/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/hvcall.h&gt;</span>
<span class="cp">#include &lt;asm/mmu.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/memory.h&gt;</span>

<span class="cp">#include &quot;plpar_wrappers.h&quot;</span>

<span class="cp">#define CMM_DRIVER_VERSION	&quot;1.0.0&quot;</span>
<span class="cp">#define CMM_DEFAULT_DELAY	1</span>
<span class="cp">#define CMM_HOTPLUG_DELAY	5</span>
<span class="cp">#define CMM_DEBUG			0</span>
<span class="cp">#define CMM_DISABLE		0</span>
<span class="cp">#define CMM_OOM_KB		1024</span>
<span class="cp">#define CMM_MIN_MEM_MB		256</span>
<span class="cp">#define KB2PAGES(_p)		((_p)&gt;&gt;(PAGE_SHIFT-10))</span>
<span class="cp">#define PAGES2KB(_p)		((_p)&lt;&lt;(PAGE_SHIFT-10))</span>
<span class="cm">/*</span>
<span class="cm"> * The priority level tries to ensure that this notifier is called as</span>
<span class="cm"> * late as possible to reduce thrashing in the shared memory pool.</span>
<span class="cm"> */</span>
<span class="cp">#define CMM_MEM_HOTPLUG_PRI	1</span>
<span class="cp">#define CMM_MEM_ISOLATE_PRI	15</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">CMM_DEFAULT_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hotplug_delay</span> <span class="o">=</span> <span class="n">CMM_HOTPLUG_DELAY</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oom_kb</span> <span class="o">=</span> <span class="n">CMM_OOM_KB</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmm_debug</span> <span class="o">=</span> <span class="n">CMM_DEBUG</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmm_disabled</span> <span class="o">=</span> <span class="n">CMM_DISABLE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min_mem_mb</span> <span class="o">=</span> <span class="n">CMM_MIN_MEM_MB</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="n">cmm_dev</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Brian King &lt;brking@linux.vnet.ibm.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IBM System p Collaborative Memory Manager&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">CMM_DRIVER_VERSION</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s">&quot;Delay (in seconds) between polls to query hypervisor paging requests. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_DEFAULT_DELAY</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">hotplug_delay</span><span class="p">,</span> <span class="n">hotplug_delay</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="s">&quot;Delay (in seconds) after memory hotplug remove &quot;</span>
		 <span class="s">&quot;before loaning resumes. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_HOTPLUG_DELAY</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">oom_kb</span><span class="p">,</span> <span class="n">oom_kb</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">oom_kb</span><span class="p">,</span> <span class="s">&quot;Amount of memory in kb to free on OOM. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_OOM_KB</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">min_mem_mb</span><span class="p">,</span> <span class="n">min_mem_mb</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">min_mem_mb</span><span class="p">,</span> <span class="s">&quot;Minimum amount of memory (in MB) to not balloon. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_MIN_MEM_MB</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">cmm_debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Enable module debugging logging. Set to 1 to enable. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_DEBUG</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>

<span class="cp">#define CMM_NR_PAGES ((PAGE_SIZE - sizeof(void *) - sizeof(unsigned long)) / sizeof(unsigned long))</span>

<span class="cp">#define cmm_dbg(...) if (cmm_debug) { printk(KERN_INFO &quot;cmm: &quot;__VA_ARGS__); }</span>

<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">[</span><span class="n">CMM_NR_PAGES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loaned_pages</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loaned_pages_target</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oom_freed_pages</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">cmm_page_list</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">cmm_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">hotplug_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hotplug_occurred</span><span class="p">;</span> <span class="cm">/* protected by the hotplug mutex */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">cmm_thread_ptr</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_alloc_pages - Allocate pages and mark them as loaned</span>
<span class="cm"> * @nr:	number of pages to allocate</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of pages requested to be allocated which were not</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">cmm_alloc_pages</span><span class="p">(</span><span class="kt">long</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">pa</span><span class="p">,</span> <span class="o">*</span><span class="n">npa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Begin request for %ld pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Exit if a hotplug operation is in progress or occurred */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_occurred</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span>
				       <span class="n">__GFP_NORETRY</span> <span class="o">|</span> <span class="n">__GFP_NOMEMALLOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span> <span class="o">||</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">CMM_NR_PAGES</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Need a new page for the page list. */</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
			<span class="n">npa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span>
					<span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span>
					<span class="n">__GFP_NORETRY</span> <span class="o">|</span> <span class="n">__GFP_NOMEMALLOC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Can not allocate new page list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
			<span class="n">pa</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span> <span class="o">||</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">CMM_NR_PAGES</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">npa</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
				<span class="n">npa</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pa</span> <span class="o">=</span> <span class="n">npa</span><span class="p">;</span>
				<span class="n">cmm_page_list</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">npa</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">plpar_page_set_loaned</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">addr</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Can not set page to loaned. rc=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
			<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">loaned_pages</span><span class="o">++</span><span class="p">;</span>
		<span class="n">totalram_pages</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
		<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;End request with %ld pages unfulfilled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_free_pages - Free pages and mark them as active</span>
<span class="cm"> * @nr:	number of pages to free</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	number of pages requested to be freed which were not</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">cmm_free_pages</span><span class="p">(</span><span class="kt">long</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Begin free of %ld pages.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span> <span class="o">||</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="o">--</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cmm_page_list</span><span class="p">);</span>
			<span class="n">cmm_page_list</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">plpar_page_set_active</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">loaned_pages</span><span class="o">--</span><span class="p">;</span>
		<span class="n">nr</span><span class="o">--</span><span class="p">;</span>
		<span class="n">totalram_pages</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;End request with %ld pages unfulfilled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_oom_notify - OOM notifier</span>
<span class="cm"> * @self:	notifier block struct</span>
<span class="cm"> * @dummy:	not used</span>
<span class="cm"> * @parm:	returned - number of pages freed</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	NOTIFY_OK</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_oom_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">freed</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">KB2PAGES</span><span class="p">(</span><span class="n">oom_kb</span><span class="p">);</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;OOM processing started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="n">cmm_free_pages</span><span class="p">(</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">loaned_pages_target</span> <span class="o">=</span> <span class="n">loaned_pages</span><span class="p">;</span>
	<span class="o">*</span><span class="n">freed</span> <span class="o">+=</span> <span class="n">KB2PAGES</span><span class="p">(</span><span class="n">oom_kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">oom_freed_pages</span> <span class="o">+=</span> <span class="n">KB2PAGES</span><span class="p">(</span><span class="n">oom_kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;OOM processing complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_get_mpp - Read memory performance parameters</span>
<span class="cm"> *</span>
<span class="cm"> * Makes hcall to query the current page loan request from the hypervisor.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmm_get_mpp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hvcall_mpp_data</span> <span class="n">mpp_data</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">long</span> <span class="n">active_pages_target</span><span class="p">,</span> <span class="n">page_loan_request</span><span class="p">,</span> <span class="n">target</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">long</span> <span class="n">total_pages</span> <span class="o">=</span> <span class="n">totalram_pages</span> <span class="o">+</span> <span class="n">loaned_pages</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">long</span> <span class="n">min_mem_pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_mem_mb</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">h_get_mpp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpp_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">H_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">page_loan_request</span> <span class="o">=</span> <span class="n">div_s64</span><span class="p">((</span><span class="n">s64</span><span class="p">)</span><span class="n">mpp_data</span><span class="p">.</span><span class="n">loan_request</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">target</span> <span class="o">=</span> <span class="n">page_loan_request</span> <span class="o">+</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">long</span><span class="p">)</span><span class="n">loaned_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">total_pages</span> <span class="o">&lt;</span> <span class="n">min_mem_pages</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;</span> <span class="n">oom_freed_pages</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">-=</span> <span class="n">oom_freed_pages</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">active_pages_target</span> <span class="o">=</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="n">target</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min_mem_pages</span> <span class="o">&gt;</span> <span class="n">active_pages_target</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">total_pages</span> <span class="o">-</span> <span class="n">min_mem_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">target</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">loaned_pages_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;delta = %ld, loaned = %lu, target = %lu, oom = %lu, totalram = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">page_loan_request</span><span class="p">,</span> <span class="n">loaned_pages</span><span class="p">,</span> <span class="n">loaned_pages_target</span><span class="p">,</span>
		<span class="n">oom_freed_pages</span><span class="p">,</span> <span class="n">totalram_pages</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cmm_oom_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cmm_oom_notify</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_thread - CMM task thread</span>
<span class="cm"> * @dummy:	not used</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeleft</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">||</span> <span class="n">timeleft</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_occurred</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hotplug_occurred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
				<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Hotplug operation has occurred, &quot;</span>
						<span class="s">&quot;loaning activity suspended &quot;</span>
						<span class="s">&quot;for %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">hotplug_delay</span><span class="p">);</span>
				<span class="n">timeleft</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">hotplug_delay</span> <span class="o">*</span>
						<span class="mi">1000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">||</span> <span class="n">timeleft</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Hotplug operation in progress, activity &quot;</span>
					<span class="s">&quot;suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cmm_get_mpp</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">loaned_pages_target</span> <span class="o">&gt;</span> <span class="n">loaned_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmm_alloc_pages</span><span class="p">(</span><span class="n">loaned_pages_target</span> <span class="o">-</span> <span class="n">loaned_pages</span><span class="p">))</span>
				<span class="n">loaned_pages_target</span> <span class="o">=</span> <span class="n">loaned_pages</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">loaned_pages_target</span> <span class="o">&lt;</span> <span class="n">loaned_pages</span><span class="p">)</span>
			<span class="n">cmm_free_pages</span><span class="p">(</span><span class="n">loaned_pages</span> <span class="o">-</span> <span class="n">loaned_pages_target</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CMM_SHOW(name, format, args...)			\</span>
<span class="cp">	static ssize_t show_##name(struct device *dev,	\</span>
<span class="cp">				   struct device_attribute *attr,	\</span>
<span class="cp">				   char *buf)			\</span>
<span class="cp">	{							\</span>
<span class="cp">		return sprintf(buf, format, ##args);		\</span>
<span class="cp">	}							\</span>
<span class="cp">	static DEVICE_ATTR(name, S_IRUGO, show_##name, NULL)</span>

<span class="n">CMM_SHOW</span><span class="p">(</span><span class="n">loaned_kb</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGES2KB</span><span class="p">(</span><span class="n">loaned_pages</span><span class="p">));</span>
<span class="n">CMM_SHOW</span><span class="p">(</span><span class="n">loaned_target_kb</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGES2KB</span><span class="p">(</span><span class="n">loaned_pages_target</span><span class="p">));</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_oom_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGES2KB</span><span class="p">(</span><span class="n">oom_freed_pages</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_oom_pages</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBADMSG</span><span class="p">;</span>

	<span class="n">oom_freed_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">oom_freed_kb</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_oom_pages</span><span class="p">,</span> <span class="n">store_oom_pages</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">cmm_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_loaned_kb</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_loaned_target_kb</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_oom_freed_kb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">cmm_subsys</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_name</span> <span class="o">=</span> <span class="s">&quot;cmm&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_sysfs_register - Register with sysfs</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_sysfs_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">subsys_system_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_subsys</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmm_subsys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">subsys_unregister</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmm_attrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmm_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmm_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">subsys_unregister:</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_subsys</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_unregister_sysfs - Unregister from sysfs</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmm_unregister_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmm_attrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmm_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_subsys</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_reboot_notifier - Make sure pages are not still marked as &quot;loaned&quot;</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_reboot_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">SYS_RESTART</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">)</span>
			<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">);</span>
		<span class="n">cmm_thread_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmm_free_pages</span><span class="p">(</span><span class="n">loaned_pages</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cmm_reboot_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cmm_reboot_notifier</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_count_pages - Count the number of pages loaned in a particular range.</span>
<span class="cm"> *</span>
<span class="cm"> * @arg: memory_isolate_notify structure with address range and count</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *      0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">cmm_count_pages</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_isolate_notify</span> <span class="o">*</span><span class="n">marg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pfn_to_kaddr</span><span class="p">(</span><span class="n">marg</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">marg</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pa</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pa</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="n">marg</span><span class="o">-&gt;</span><span class="n">pages_found</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span>
				<span class="n">marg</span><span class="o">-&gt;</span><span class="n">pages_found</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_memory_isolate_cb - Handle memory isolation notifier calls</span>
<span class="cm"> * @self:	notifier block struct</span>
<span class="cm"> * @action:	action to take</span>
<span class="cm"> * @arg:	struct memory_isolate_notify data for handler</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	NOTIFY_OK or notifier error based on subfunction return value</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_memory_isolate_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">MEM_ISOLATE_COUNT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cmm_count_pages</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cmm_mem_isolate_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cmm_memory_isolate_cb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CMM_MEM_ISOLATE_PRI</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_mem_going_offline - Unloan pages where memory is to be removed</span>
<span class="cm"> * @arg: memory_notify structure with page range to be offlined</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_mem_going_offline</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memory_notify</span> <span class="o">*</span><span class="n">marg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_page</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pfn_to_kaddr</span><span class="p">(</span><span class="n">marg</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_page</span> <span class="o">=</span> <span class="n">start_page</span> <span class="o">+</span> <span class="p">(</span><span class="n">marg</span><span class="o">-&gt;</span><span class="n">nr_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="n">pa_curr</span><span class="p">,</span> <span class="o">*</span><span class="n">pa_last</span><span class="p">,</span> <span class="o">*</span><span class="n">npa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Memory going offline, searching 0x%lx (%ld pages).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">start_page</span><span class="p">,</span> <span class="n">marg</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>

	<span class="cm">/* Search the page list for pages in the range to be offlined */</span>
	<span class="n">pa_last</span> <span class="o">=</span> <span class="n">pa_curr</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa_curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start_page</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">end_page</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">plpar_page_set_active</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]));</span>
			<span class="n">free_page</span><span class="p">(</span><span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">freed</span><span class="o">++</span><span class="p">;</span>
			<span class="n">loaned_pages</span><span class="o">--</span><span class="p">;</span>
			<span class="n">totalram_pages</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">[</span><span class="o">--</span><span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pa_curr</span> <span class="o">==</span> <span class="n">pa_last</span><span class="p">)</span>
					<span class="n">pa_curr</span> <span class="o">=</span> <span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">pa_last</span> <span class="o">=</span> <span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmm_page_list</span><span class="p">);</span>
				<span class="n">cmm_page_list</span> <span class="o">=</span> <span class="n">pa_last</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pa_curr</span> <span class="o">=</span> <span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Search for page list structures in the range to be offlined */</span>
	<span class="n">pa_last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pa_curr</span> <span class="o">=</span> <span class="n">cmm_page_list</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pa_curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pa_curr</span> <span class="o">&gt;=</span> <span class="n">start_page</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pa_curr</span> <span class="o">&lt;</span> <span class="n">end_page</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">npa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cmm_page_array</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_page</span><span class="p">(</span>
					<span class="n">GFP_NOIO</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span>
					<span class="n">__GFP_NORETRY</span> <span class="o">|</span> <span class="n">__GFP_NOMEMALLOC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npa</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
				<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for list &quot;</span>
						<span class="s">&quot;management. Memory hotplug &quot;</span>
						<span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">npa</span><span class="p">,</span> <span class="n">pa_curr</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pa_curr</span> <span class="o">==</span> <span class="n">cmm_page_list</span><span class="p">)</span>
				<span class="n">cmm_page_list</span> <span class="o">=</span> <span class="n">npa</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pa_last</span><span class="p">)</span>
				<span class="n">pa_last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">npa</span><span class="p">;</span>
			<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">pa_curr</span><span class="p">);</span>
			<span class="n">freed</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pa_curr</span> <span class="o">=</span> <span class="n">npa</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pa_last</span> <span class="o">=</span> <span class="n">pa_curr</span><span class="p">;</span>
		<span class="n">pa_curr</span> <span class="o">=</span> <span class="n">pa_curr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_lock</span><span class="p">);</span>
	<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Released %ld pages in the search range.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_memory_cb - Handle memory hotplug notifier calls</span>
<span class="cm"> * @self:	notifier block struct</span>
<span class="cm"> * @action:	action to take</span>
<span class="cm"> * @arg:	struct memory_notify data for handler</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	NOTIFY_OK or notifier error based on subfunction return value</span>
<span class="cm"> *</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_memory_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEM_GOING_OFFLINE</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
		<span class="n">hotplug_occurred</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cmm_mem_going_offline</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_OFFLINE</span>:
	<span class="k">case</span> <span class="n">MEM_CANCEL_OFFLINE</span>:
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotplug_mutex</span><span class="p">);</span>
		<span class="n">cmm_dbg</span><span class="p">(</span><span class="s">&quot;Memory offline operation complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEM_GOING_ONLINE</span>:
	<span class="k">case</span> <span class="n">MEM_ONLINE</span>:
	<span class="k">case</span> <span class="n">MEM_CANCEL_ONLINE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">notifier_from_errno</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">cmm_mem_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">cmm_memory_cb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">CMM_MEM_HOTPLUG_PRI</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_init - Module initialization</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">firmware_has_feature</span><span class="p">(</span><span class="n">FW_FEATURE_CMO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">register_oom_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_oom_nb</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">register_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_reboot_nb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_oom_notifier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">cmm_sysfs_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_reboot_notifier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_nb</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">register_memory_isolate_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_isolate_nb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unregister_notifier</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmm_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmm_thread_ptr</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">cmm_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cmmthread&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unregister_notifier</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_unregister_notifier:</span>
	<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_nb</span><span class="p">);</span>
	<span class="n">unregister_memory_isolate_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_isolate_nb</span><span class="p">);</span>
	<span class="n">cmm_unregister_sysfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_dev</span><span class="p">);</span>
<span class="nl">out_reboot_notifier:</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_reboot_nb</span><span class="p">);</span>
<span class="nl">out_oom_notifier:</span>
	<span class="n">unregister_oom_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_oom_nb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_exit - Module exit</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	nothing</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">);</span>
	<span class="n">unregister_oom_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_oom_nb</span><span class="p">);</span>
	<span class="n">unregister_reboot_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_reboot_nb</span><span class="p">);</span>
	<span class="n">unregister_memory_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_nb</span><span class="p">);</span>
	<span class="n">unregister_memory_isolate_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_mem_isolate_nb</span><span class="p">);</span>
	<span class="n">cmm_free_pages</span><span class="p">(</span><span class="n">loaned_pages</span><span class="p">);</span>
	<span class="n">cmm_unregister_sysfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmm_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cmm_set_disable - Disable/Enable CMM</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 	0 on success / other on failure</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmm_set_disable</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">disable</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">disable</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cmm_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">)</span>
			<span class="n">kthread_stop</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">);</span>
		<span class="n">cmm_thread_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cmm_free_pages</span><span class="p">(</span><span class="n">loaned_pages</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable</span> <span class="o">&amp;&amp;</span> <span class="n">cmm_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmm_thread_ptr</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">cmm_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cmmthread&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cmm_thread_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmm_disabled</span> <span class="o">=</span> <span class="n">disable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="n">cmm_set_disable</span><span class="p">,</span> <span class="n">param_get_uint</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">cmm_disabled</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable</span><span class="p">,</span> <span class="s">&quot;Disable CMM. Set to 1 to disable. &quot;</span>
		 <span class="s">&quot;[Default=&quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">CMM_DISABLE</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">cmm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cmm_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
