<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › pseries › msi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>msi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2006 Jake Moilanen &lt;moilanen@austin.ibm.com&gt;, IBM Corp.</span>
<span class="cm"> * Copyright 2006-2007 Michael Ellerman, IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; version 2 of the</span>
<span class="cm"> * License.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>

<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/hw_irq.h&gt;</span>
<span class="cp">#include &lt;asm/ppc-pci.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">query_token</span><span class="p">,</span> <span class="n">change_token</span><span class="p">;</span>

<span class="cp">#define RTAS_QUERY_FN		0</span>
<span class="cp">#define RTAS_CHANGE_FN		1</span>
<span class="cp">#define RTAS_RESET_FN		2</span>
<span class="cp">#define RTAS_CHANGE_MSI_FN	3</span>
<span class="cp">#define RTAS_CHANGE_MSIX_FN	4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="nf">get_pdn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: No OF device node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdn</span> <span class="o">=</span> <span class="n">PCI_DN</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: No PCI DN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pdn</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* RTAS Helpers */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtas_change_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">,</span> <span class="n">u32</span> <span class="n">func</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_irqs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">rtas_config_addr</span><span class="p">(</span><span class="n">pdn</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">buid</span> <span class="o">=</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">buid</span><span class="p">;</span>

	<span class="n">seq_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="n">RTAS_CHANGE_MSI_FN</span> <span class="o">||</span> <span class="n">func</span> <span class="o">==</span> <span class="n">RTAS_CHANGE_MSIX_FN</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">change_token</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">BUID_HI</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span> <span class="n">BUID_LO</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span>
					<span class="n">func</span><span class="p">,</span> <span class="n">num_irqs</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">change_token</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">BUID_HI</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span> <span class="n">BUID_LO</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span>
					<span class="n">func</span><span class="p">,</span> <span class="n">num_irqs</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">);</span>

		<span class="n">seq_num</span> <span class="o">=</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rtas_busy_delay</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the RTAS call succeeded, return the number of irqs allocated.</span>
<span class="cm">	 * If not, make sure we return a negative error code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: ibm,change_msi(func=%d,num=%d), got %d rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">func</span><span class="p">,</span> <span class="n">num_irqs</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtas_disable_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">;</span>

	<span class="n">pdn</span> <span class="o">=</span> <span class="n">get_pdn</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * disabling MSI with the explicit interface also disables MSI-X</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtas_change_msi</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">RTAS_CHANGE_MSI_FN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* </span>
<span class="cm">		 * may have failed because explicit interface is not</span>
<span class="cm">		 * present</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtas_change_msi</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">RTAS_CHANGE_FN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: Setting MSIs to 0 failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtas_query_irq_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">rtas_config_addr</span><span class="p">(</span><span class="n">pdn</span><span class="o">-&gt;</span><span class="n">busno</span><span class="p">,</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">buid</span> <span class="o">=</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">buid</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">query_token</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rtas_ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			       <span class="n">BUID_HI</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span> <span class="n">BUID_LO</span><span class="p">(</span><span class="n">buid</span><span class="p">),</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rtas_busy_delay</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: error (%d) querying source number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rtas_ret</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtas_teardown_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">irq_set_msi_desc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtas_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prop_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">req_msi</span><span class="p">;</span>

	<span class="n">pdn</span> <span class="o">=</span> <span class="n">get_pdn</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>

	<span class="n">req_msi</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_msi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: No %s on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">req_msi</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: %s requests &lt; %d MSIs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">req_msi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Be paranoid */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="k">return</span> <span class="o">*</span><span class="n">req_msi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_req_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">check_req</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;ibm,req#msi&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_req_msix</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">check_req</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">,</span> <span class="s">&quot;ibm,req#msi-x&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Quota calculation */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">find_pe_total_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,pe-total-#msi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: found prop on dn %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="o">*</span><span class="n">total</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">dn</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dn</span> <span class="o">=</span> <span class="n">of_get_next_parent</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="nf">find_pe_dn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">;</span>

	<span class="cm">/* Found our PE and assume 8 at that point. */</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dn</span> <span class="o">=</span> <span class="n">eeh_find_device_pe</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* We actually want the parent */</span>
	<span class="n">dn</span> <span class="o">=</span> <span class="n">of_get_parent</span><span class="p">(</span><span class="n">dn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Hardcode of 8 for old firmwares */</span>
	<span class="o">*</span><span class="n">total</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: using PE dn %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">msi_counts</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">requestor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_devices</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quota</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spare</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">over_quota</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">count_non_bridge_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_counts</span> <span class="o">*</span><span class="n">counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: counting %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;class-code&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">class</span> <span class="o">=</span> <span class="n">p</span> <span class="o">?</span> <span class="o">*</span><span class="n">p</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PCI_CLASS_BRIDGE_PCI</span><span class="p">)</span>
		<span class="n">counts</span><span class="o">-&gt;</span><span class="n">num_devices</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">count_spare_msis</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_counts</span> <span class="o">*</span><span class="n">counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dn</span> <span class="o">==</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">requestor</span><span class="p">)</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t know if a driver will try to use MSI or MSI-X,</span>
<span class="cm">		 * so we just have to punt and use the larger of the two. */</span>
		<span class="n">req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,req#msi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
			<span class="n">req</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,req#msi-x&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&lt;</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">quota</span><span class="p">)</span>
		<span class="n">counts</span><span class="o">-&gt;</span><span class="n">spare</span> <span class="o">+=</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">quota</span> <span class="o">-</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&gt;</span> <span class="n">counts</span><span class="o">-&gt;</span><span class="n">quota</span><span class="p">)</span>
		<span class="n">counts</span><span class="o">-&gt;</span><span class="n">over_quota</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msi_quota_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">pe_dn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_counts</span> <span class="n">counts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: calc quota for %s, request %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		  <span class="n">request</span><span class="p">);</span>

	<span class="n">pe_dn</span> <span class="o">=</span> <span class="n">find_pe_total_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe_dn</span><span class="p">)</span>
		<span class="n">pe_dn</span> <span class="o">=</span> <span class="n">find_pe_dn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe_dn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;rtas_msi: couldn&#39;t find PE for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: found PE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe_dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msi_counts</span><span class="p">));</span>

	<span class="cm">/* Work out how many devices we have below this PE */</span>
	<span class="n">traverse_pci_devices</span><span class="p">(</span><span class="n">pe_dn</span><span class="p">,</span> <span class="n">count_non_bridge_devices</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">counts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">counts</span><span class="p">.</span><span class="n">num_devices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;rtas_msi: found 0 devices under PE for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">counts</span><span class="p">.</span><span class="n">quota</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">counts</span><span class="p">.</span><span class="n">num_devices</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">&lt;=</span> <span class="n">counts</span><span class="p">.</span><span class="n">quota</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* else, we have some more calculating to do */</span>
	<span class="n">counts</span><span class="p">.</span><span class="n">requestor</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">counts</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">traverse_pci_devices</span><span class="p">(</span><span class="n">pe_dn</span><span class="p">,</span> <span class="n">count_spare_msis</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">counts</span><span class="p">);</span>

	<span class="cm">/* If the quota isn&#39;t an integer multiple of the total, we can</span>
<span class="cm">	 * use the remainder as spare MSIs for anyone that wants them. */</span>
	<span class="n">counts</span><span class="p">.</span><span class="n">spare</span> <span class="o">+=</span> <span class="n">total</span> <span class="o">%</span> <span class="n">counts</span><span class="p">.</span><span class="n">num_devices</span><span class="p">;</span>

	<span class="cm">/* Divide any spare by the number of over-quota requestors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">counts</span><span class="p">.</span><span class="n">over_quota</span><span class="p">)</span>
		<span class="n">counts</span><span class="p">.</span><span class="n">quota</span> <span class="o">+=</span> <span class="n">counts</span><span class="p">.</span><span class="n">spare</span> <span class="o">/</span> <span class="n">counts</span><span class="p">.</span><span class="n">over_quota</span><span class="p">;</span>

	<span class="cm">/* And finally clamp the request to the possibly adjusted quota */</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">counts</span><span class="p">.</span><span class="n">quota</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: request clamped to quota %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">pe_dn</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtas_msi_check_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">quota</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_req_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">check_req_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">quota</span> <span class="o">=</span> <span class="n">msi_quota_for_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quota</span> <span class="o">&amp;&amp;</span> <span class="n">quota</span> <span class="o">&lt;</span> <span class="n">nvec</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">quota</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_msix_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">expected</span><span class="p">;</span>

	<span class="cm">/* There&#39;s no way for us to express to firmware that we want</span>
<span class="cm">	 * a discontiguous, or non-zero based, range of MSI-X entries.</span>
<span class="cm">	 * So we must reject such requests. */</span>

	<span class="n">expected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">msi_attrib</span><span class="p">.</span><span class="n">entry_nr</span> <span class="o">!=</span> <span class="n">expected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: bad MSI-X entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expected</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtas_setup_msi_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nvec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hwirq</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_desc</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msi_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">pdn</span> <span class="o">=</span> <span class="n">get_pdn</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSIX</span> <span class="o">&amp;&amp;</span> <span class="n">check_msix_entries</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try the new more explicit firmware interface, if that fails fall</span>
<span class="cm">	 * back to the old interface. The old interface is known to never</span>
<span class="cm">	 * return MSI-Xs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_MSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_change_msi</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">RTAS_CHANGE_MSI_FN</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: trying the old firmware call.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_change_msi</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">RTAS_CHANGE_FN</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">rtas_change_msi</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">RTAS_CHANGE_MSIX_FN</span><span class="p">,</span> <span class="n">nvec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">nvec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: rtas_change_msi() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwirq</span> <span class="o">=</span> <span class="n">rtas_query_irq_number</span><span class="p">(</span><span class="n">pdn</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwirq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: error (%d) getting hwirq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">hwirq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">virq</span> <span class="o">=</span> <span class="n">irq_create_mapping</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">virq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: Failed mapping hwirq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: allocated virq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
		<span class="n">irq_set_msi_desc</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

		<span class="cm">/* Read config space back so we can restore after reset */</span>
		<span class="n">read_msi_msg</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtas_msi_pci_irq_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No LSI -&gt; leave MSIs (if any) configured */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: no LSI, nothing to do.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No MSI -&gt; MSIs can&#39;t have been assigned by fw, leave LSI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_req_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">check_req_msix</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: no req#msi/x, nothing to do.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rtas_msi: disabling existing MSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rtas_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtas_msi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">query_token</span>  <span class="o">=</span> <span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;ibm,query-interrupt-source-number&quot;</span><span class="p">);</span>
	<span class="n">change_token</span> <span class="o">=</span> <span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;ibm,change-msi&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">query_token</span> <span class="o">==</span> <span class="n">RTAS_UNKNOWN_SERVICE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">change_token</span> <span class="o">==</span> <span class="n">RTAS_UNKNOWN_SERVICE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: no RTAS tokens, no MSI support.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rtas_msi: Registering RTAS MSI callbacks.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">setup_msi_irqs</span><span class="p">);</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">setup_msi_irqs</span> <span class="o">=</span> <span class="n">rtas_setup_msi_irqs</span><span class="p">;</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">teardown_msi_irqs</span> <span class="o">=</span> <span class="n">rtas_teardown_msi_irqs</span><span class="p">;</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">msi_check_device</span> <span class="o">=</span> <span class="n">rtas_msi_check_device</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">pci_irq_fixup</span><span class="p">);</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">pci_irq_fixup</span> <span class="o">=</span> <span class="n">rtas_msi_pci_irq_fixup</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">rtas_msi_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
