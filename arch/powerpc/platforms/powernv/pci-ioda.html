<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › powernv › pci-ioda.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pci-ioda.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Support PCI/PCIe on PowerNV platforms</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2011 Benjamin Herrenschmidt, IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/msi.h&gt;</span>

<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/ppc-pci.h&gt;</span>
<span class="cp">#include &lt;asm/opal.h&gt;</span>
<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/tce.h&gt;</span>
<span class="cp">#include &lt;asm/abs_addr.h&gt;</span>

<span class="cp">#include &quot;powernv.h&quot;</span>
<span class="cp">#include &quot;pci.h&quot;</span>

<span class="k">struct</span> <span class="n">resource_wrap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">link</span><span class="p">;</span>
	<span class="n">resource_size_t</span>		<span class="n">size</span><span class="p">;</span>
	<span class="n">resource_size_t</span>		<span class="n">align</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>		<span class="o">*</span><span class="n">dev</span><span class="p">;</span>	<span class="cm">/* Set if it&#39;s a device */</span>
	<span class="k">struct</span> <span class="n">pci_bus</span>		<span class="o">*</span><span class="n">bus</span><span class="p">;</span>	<span class="cm">/* Set if it&#39;s a bridge */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__pe_printk</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">va_format</span> <span class="o">*</span><span class="n">vaf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">pfix</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">pfix</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pfix</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pfix</span><span class="p">,</span> <span class="s">&quot;%04x:%02x     &quot;</span><span class="p">,</span>
			<span class="n">pci_domain_nr</span><span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="p">),</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci %s%s: [PE# %.3d] %pV&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">pfix</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span> <span class="n">vaf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define define_pe_printk_level(func, kern_level)		\</span>
<span class="cp">static int func(const struct pnv_ioda_pe *pe, const char *fmt, ...)	\</span>
<span class="cp">{								\</span>
<span class="cp">	struct va_format vaf;					\</span>
<span class="cp">	va_list args;						\</span>
<span class="cp">	int r;							\</span>
<span class="cp">								\</span>
<span class="cp">	va_start(args, fmt);					\</span>
<span class="cp">								\</span>
<span class="cp">	vaf.fmt = fmt;						\</span>
<span class="cp">	vaf.va = &amp;args;						\</span>
<span class="cp">								\</span>
<span class="cp">	r = __pe_printk(kern_level, pe, &amp;vaf);			\</span>
<span class="cp">	va_end(args);						\</span>
<span class="cp">								\</span>
<span class="cp">	return r;						\</span>
<span class="cp">}								\</span>

<span class="n">define_pe_printk_level</span><span class="p">(</span><span class="n">pe_err</span><span class="p">,</span> <span class="n">KERN_ERR</span><span class="p">);</span>
<span class="n">define_pe_printk_level</span><span class="p">(</span><span class="n">pe_warn</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">);</span>
<span class="n">define_pe_printk_level</span><span class="p">(</span><span class="n">pe_info</span><span class="p">,</span> <span class="n">KERN_INFO</span><span class="p">);</span>


<span class="cm">/* Calculate resource usage &amp; alignment requirement of a single</span>
<span class="cm"> * device. This will also assign all resources within the device</span>
<span class="cm"> * for a given type starting at 0 for the biggest one and then</span>
<span class="cm"> * assigning in decreasing order of size.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_calc_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="o">*</span><span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  -&gt; CDR %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Clear the resources out and mark them all unset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">))</span>
		    <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IORESOURCE_UNSET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We currently keep all memory resources together, we</span>
<span class="cm">	 * will handle prefetch &amp; 64-bit separately in the future</span>
<span class="cm">	 * but for now we stick everybody in M32</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">resource_size_t</span> <span class="n">max_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Find next biggest resource */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_UNSET</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
				<span class="n">max_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">max_no</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_size</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">align</span><span class="p">)</span>
			<span class="o">*</span><span class="n">align</span> <span class="o">=</span> <span class="n">max_size</span><span class="p">;</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">+=</span> <span class="n">max_size</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">max_size</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">max_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IORESOURCE_UNSET</span><span class="p">;</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  -&gt;     R%d %016llx..%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">max_no</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  &lt;- CDR %s size=%llx align=%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="o">*</span><span class="n">align</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocate a resource &quot;wrap&quot; for a given device or bridge and</span>
<span class="cm"> * insert it at the right position in the sorted list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_add_wrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource_wrap</span> <span class="o">*</span><span class="n">w1</span><span class="p">,</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">w</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">w</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w1</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">&lt;</span> <span class="n">align</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Offset device resources of a given type */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_offset_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					  <span class="n">resource_size_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  -&gt; ODR %s [%x] +%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  &lt;- ODR %s [%x] +%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">flags</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Offset bus resources (&amp; all children) of a given type */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_offset_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					  <span class="n">resource_size_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">cbus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  -&gt; OBR %s [%x] +%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">?</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">pci_bus_for_each_resource</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span>
		<span class="n">pnv_ioda_offset_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">pnv_ioda_offset_bus</span><span class="p">(</span><span class="n">cbus</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  &lt;- OBR %s [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">?</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This is the guts of our IODA resource allocation. This is called</span>
<span class="cm"> * recursively for each bus in the system. It calculates all the</span>
<span class="cm"> * necessary size and requirements for children and assign them</span>
<span class="cm"> * resources such that:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Each function fits in it&#39;s own contiguous set of IO/M32</span>
<span class="cm"> *     segment</span>
<span class="cm"> *</span>
<span class="cm"> *   - All segments behind a P2P bridge are contiguous and obey</span>
<span class="cm"> *     alignment constraints of those bridges</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_calc_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
					<span class="n">resource_size_t</span> <span class="o">*</span><span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">dev_size</span><span class="p">,</span> <span class="n">dev_align</span><span class="p">,</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">min_align</span><span class="p">,</span> <span class="n">min_balign</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">cbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource_wrap</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bres</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;-&gt; CBR %s [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">?</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Calculate alignment requirements based on the type</span>
<span class="cm">	 * of resource we are working on</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bres</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">min_align</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segsize</span><span class="p">;</span>
		<span class="n">min_balign</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bres</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">min_align</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segsize</span><span class="p">;</span>
		<span class="n">min_balign</span> <span class="o">=</span> <span class="mh">0x100000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Gather all our children resources ordered by alignment */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">);</span>

	<span class="cm">/*   - Busses */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pnv_ioda_calc_bus</span><span class="p">(</span><span class="n">cbus</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_align</span><span class="p">);</span>
		<span class="n">pnv_ioda_add_wrap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="n">cbus</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev_size</span><span class="p">,</span> <span class="n">dev_align</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*   - Devices */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pnv_ioda_calc_dev</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_align</span><span class="p">);</span>
		<span class="cm">/* Align them to segment size */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_align</span> <span class="o">&lt;</span> <span class="n">min_align</span><span class="p">)</span>
			<span class="n">dev_align</span> <span class="o">=</span> <span class="n">min_align</span><span class="p">;</span>
		<span class="n">pnv_ioda_add_wrap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cdev</span><span class="p">,</span> <span class="n">dev_size</span><span class="p">,</span> <span class="n">dev_align</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">empty</span><span class="p">;</span>

	<span class="cm">/* Now we can do two things: assign offsets to them within that</span>
<span class="cm">	 * level and get our total alignment &amp; size requirements. The</span>
<span class="cm">	 * assignment algorithm is going to be uber-trivial for now, we</span>
<span class="cm">	 * can try to be smarter later at filling out holes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No offset for downstream bridges */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Offset from the root */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
			<span class="cm">/* Don&#39;t hand out IO 0 */</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource_wrap</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
					<span class="n">pnv_ioda_offset_dev</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">flags</span><span class="p">,</span><span class="n">start</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
					<span class="n">pnv_ioda_offset_bus</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span><span class="n">flags</span><span class="p">,</span><span class="n">start</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">align</span><span class="p">)</span>
				<span class="o">*</span><span class="n">align</span> <span class="o">=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>

	<span class="cm">/* Align and setup bridge resources */</span>
	<span class="o">*</span><span class="n">align</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">,</span> <span class="o">*</span><span class="n">align</span><span class="p">,</span>
		       <span class="n">max_t</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">,</span> <span class="n">min_align</span><span class="p">,</span> <span class="n">min_balign</span><span class="p">));</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">,</span>
		      <span class="n">max_t</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">,</span> <span class="n">min_align</span><span class="p">,</span> <span class="n">min_balign</span><span class="p">));</span>
 <span class="nl">empty:</span>
	<span class="cm">/* Only setup P2P&#39;s, not the PHB itself */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">bres</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIXME: We should probably export and call</span>
<span class="cm">		 * pci_bridge_check_ranges() to properly re-initialize</span>
<span class="cm">		 * the PCI portion of the flags here, and to detect</span>
<span class="cm">		 * what the bridge actually supports.</span>
<span class="cm">		 */</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="n">flags</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;&lt;- CBR %s [%x] *size=%016llx *align=%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">?</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;root&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="o">*</span><span class="n">align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="nf">pnv_ioda_get_pdn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">pci_device_to_OF_node</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PCI_DN</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_pe_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pe</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">resource_size_t</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">io_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">m32_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Anything not referenced in the device-tree gets PE#0 */</span>
	<span class="n">pe</span> <span class="o">=</span> <span class="n">pdn</span> <span class="o">?</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Calculate the device min/max */</span>
	<span class="n">io_res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">m32_res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">io_res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">m32_res</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">io_res</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
	<span class="n">m32_res</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">io_res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m32_res</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup IO segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_res</span><span class="p">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">io_res</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_res</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segsize</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Trying to use IO seg #%d which is&quot;</span>
				       <span class="s">&quot; already used by PE# %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
				       <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="cm">/* XXX DO SOMETHING TO DISABLE DEVICE ? */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_map_pe_mmio_window</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span>
							 <span class="n">OPAL_IO_WINDOW_TYPE</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OPAL_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: OPAL error %d setting up mapping&quot;</span>
				       <span class="s">&quot; for IO seg# %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/* XXX DO SOMETHING TO DISABLE DEVICE ? */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segsize</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="cm">/* Setup M32 segments */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m32_res</span><span class="p">.</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">m32_res</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcibios_resource_to_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m32_res</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">region</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segsize</span><span class="p">;</span>
		<span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;=</span> <span class="n">region</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Trying to use M32 seg #%d which is&quot;</span>
				       <span class="s">&quot; already used by PE# %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
				       <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="cm">/* XXX DO SOMETHING TO DISABLE DEVICE ? */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_map_pe_mmio_window</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span>
							 <span class="n">OPAL_M32_WINDOW_TYPE</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">OPAL_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: OPAL error %d setting up mapping&quot;</span>
				       <span class="s">&quot; for M32 seg# %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/* XXX DO SOMETHING TO DISABLE DEVICE ? */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segsize</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Check if a resource still fits in the total IO or M32 range</span>
<span class="cm"> * for a given PHB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_resource_fit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">bounds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="n">bounds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
		<span class="n">bounds</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">bounds</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&lt;=</span> <span class="n">bounds</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_update_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">cbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We used to clear all device enables here. However it looks like</span>
<span class="cm">	 * clearing MEM enable causes Obsidian (IPR SCS) to go bonkers,</span>
<span class="cm">	 * and shoot fatal errors to the PHB which in turns fences itself</span>
<span class="cm">	 * and we can&#39;t recover from that ... yet. So for now, let&#39;s leave</span>
<span class="cm">	 * the enables as-is and hope for the best.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Check if bus resources fit in our IO or M32 range */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pnv_ioda_resource_fit</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Bus %d resource %d disabled, no room</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">),</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update self if it&#39;s not a PHB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span>
		<span class="n">pci_setup_bridge</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Update child devices */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if resource fits, if not, disabled it */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnv_ioda_resource_fit</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Resource %d disabled, no room</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pci_name</span><span class="p">(</span><span class="n">cdev</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Assign segments */</span>
		<span class="n">pnv_ioda_setup_pe_segments</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

		<span class="cm">/* Update HW BARs */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">PCI_ROM_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pci_update_resource</span><span class="p">(</span><span class="n">cdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update child busses */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">pnv_ioda_update_resources</span><span class="p">(</span><span class="n">cbus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_alloc_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pe</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pe</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_alloc</span><span class="p">,</span>
					<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pe</span> <span class="o">&gt;=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">IODA_INVALID_PE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_alloc</span><span class="p">));</span>

	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pe</span><span class="p">].</span><span class="n">pe_number</span> <span class="o">=</span> <span class="n">pe</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_free_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pe</span><span class="p">].</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pe</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_ioda_pe</span><span class="p">));</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_alloc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Currently those 2 are only used when MSIs are enabled, this will change</span>
<span class="cm"> * but in the meantime, we need to protect them to avoid warnings</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">__pnv_ioda_get_one_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">==</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_get_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span> <span class="o">=</span> <span class="n">__pnv_ioda_get_one_pe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
		<span class="n">pe</span> <span class="o">=</span> <span class="n">__pnv_ioda_get_one_pe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="p">)</span>
			<span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">bus_pe</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pe</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_configure_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">bcomp</span><span class="p">,</span> <span class="n">dcomp</span><span class="p">,</span> <span class="n">fcomp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rid_end</span><span class="p">,</span> <span class="n">rid</span><span class="p">;</span>

	<span class="cm">/* Bus validation ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">dcomp</span> <span class="o">=</span> <span class="n">OPAL_IGNORE_RID_DEVICE_NUMBER</span><span class="p">;</span>
		<span class="n">fcomp</span> <span class="o">=</span> <span class="n">OPAL_IGNORE_RID_FUNCTION_NUMBER</span><span class="p">;</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">subordinate</span> <span class="o">-</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">secondary</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span>  <span class="mi">1</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBusAll</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mi">2</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBus7Bits</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mi">4</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBus6Bits</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span>  <span class="mi">8</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBus5Bits</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBus4Bits</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>: <span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBus3Bits</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Number of subordinate busses %d&quot;</span>
			       <span class="s">&quot; unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">),</span> <span class="n">count</span><span class="p">);</span>
			<span class="cm">/* Do an exact match only */</span>
			<span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBusAll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rid_end</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">+</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
		<span class="n">bcomp</span> <span class="o">=</span> <span class="n">OpalPciBusAll</span><span class="p">;</span>
		<span class="n">dcomp</span> <span class="o">=</span> <span class="n">OPAL_COMPARE_RID_DEVICE_NUMBER</span><span class="p">;</span>
		<span class="n">fcomp</span> <span class="o">=</span> <span class="n">OPAL_COMPARE_RID_FUNCTION_NUMBER</span><span class="p">;</span>
		<span class="n">rid_end</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Associate PE in PELT */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_set_pe</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">,</span>
			     <span class="n">bcomp</span><span class="p">,</span> <span class="n">dcomp</span><span class="p">,</span> <span class="n">fcomp</span><span class="p">,</span> <span class="n">OPAL_MAP_PE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pe_err</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;OPAL error %ld trying to setup PELT table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">opal_pci_eeh_freeze_clear</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span>
				  <span class="n">OPAL_EEH_ACTION_CLEAR_FREEZE_ALL</span><span class="p">);</span>

	<span class="cm">/* Add to all parents PELT-V */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdn</span> <span class="o">&amp;&amp;</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">!=</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_set_peltv</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span>
						<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span> <span class="n">OPAL_ADD_PE_TO_DOMAIN</span><span class="p">);</span>
			<span class="cm">/* XXX What to do in case of error ? */</span>
		<span class="p">}</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Setup reverse map */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rid</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">;</span> <span class="n">rid</span> <span class="o">&lt;</span> <span class="n">rid_end</span><span class="p">;</span> <span class="n">rid</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_rmap</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">;</span>

	<span class="cm">/* Setup one MVTs on IODA1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PNV_PHB_IODA1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_set_mve</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">,</span>
				      <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pe_err</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;OPAL error %ld setting up MVE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">);</span>
			<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_set_mve_enable</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span>
						     <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">,</span> <span class="n">OPAL_ENABLE_MVE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pe_err</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;OPAL error %ld enabling MVE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rc</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">);</span>
				<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">PNV_PHB_IODA2</span><span class="p">)</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_link_pe_by_weight</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">lpe</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">lpe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">&lt;</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lpe</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pnv_ioda_dma_weight</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is quite simplistic. The &quot;base&quot; weight of a device</span>
<span class="cm">	 * is 10. 0 means no DMA is to be accounted for it.</span>
<span class="cm">	 */</span>

	<span class="cm">/* If it&#39;s a bridge, no DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hdr_type</span> <span class="o">!=</span> <span class="n">PCI_HEADER_TYPE_NORMAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reduce the weight of slow USB controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_SERIAL_USB_UHCI</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_SERIAL_USB_OHCI</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">PCI_CLASS_SERIAL_USB_EHCI</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Increase the weight of RAID (includes Obsidian) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_RAID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">15</span><span class="p">;</span>

	<span class="cm">/* Default */</span>
	<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_dev_PE</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pe_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Device tree node not associated properly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">!=</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* PE#0 has been pre-set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pe_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pe_num</span> <span class="o">=</span> <span class="n">pnv_ioda_alloc_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe_num</span> <span class="o">==</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Not enough PE# available, disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE: We get only one ref to the pci_dev for the pdn, not for the</span>
<span class="cm">	 * pointer in the PE data structure, both should be destroyed at the</span>
<span class="cm">	 * same time. However, this needs to be looked at more closely again</span>
<span class="cm">	 * once we actually start removing things (Hotplug, SR-IOV, ...)</span>
<span class="cm">	 *</span>
<span class="cm">	 * At some point we want to remove the PDN completely anyways</span>
<span class="cm">	 */</span>
	<span class="n">pe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pe_num</span><span class="p">];</span>
	<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">=</span> <span class="n">pe_num</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">;</span>

	<span class="n">pe_info</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;Associated device to PE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnv_ioda_configure_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* XXX What do we do here ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pe_num</span><span class="p">)</span>
			<span class="n">pnv_ioda_free_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe_num</span><span class="p">);</span>
		<span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">=</span> <span class="n">IODA_INVALID_PE</span><span class="p">;</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assign a DMA weight to the device */</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">=</span> <span class="n">pnv_ioda_dma_weight</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_weight</span> <span class="o">+=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span><span class="p">;</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_pe_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Link the PE */</span>
	<span class="n">pnv_ioda_link_pe_by_weight</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pe</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pnv_ioda_setup_same_PE</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pdn</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: No device node associated with device !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pci_dev_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">;</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">+=</span> <span class="n">pnv_ioda_dma_weight</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="n">pnv_ioda_setup_same_PE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_bus_PE</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">ppe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pe_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Bridge without a subordinate bus !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pe_num</span> <span class="o">=</span> <span class="n">pnv_ioda_alloc_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe_num</span> <span class="o">==</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Not enough PE# available, disabling bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span><span class="p">[</span><span class="n">pe_num</span><span class="p">];</span>
	<span class="n">ppe</span><span class="o">-&gt;</span><span class="n">bus_pe</span> <span class="o">=</span> <span class="n">pe</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pe_info</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;Secondary busses %d..%d associated with PE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">secondary</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnv_ioda_configure_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* XXX What do we do here ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pe_num</span><span class="p">)</span>
			<span class="n">pnv_ioda_free_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe_num</span><span class="p">);</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Associate it with all child devices */</span>
	<span class="n">pnv_ioda_setup_same_PE</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>

	<span class="cm">/* Account for one DMA PE if at least one DMA capable device exist</span>
<span class="cm">	 * below the bridge</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_weight</span> <span class="o">+=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span><span class="p">;</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_pe_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Link the PE */</span>
	<span class="n">pnv_ioda_link_pe_by_weight</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_PEs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pe</span> <span class="o">=</span> <span class="n">pnv_ioda_setup_dev_PE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Leaving the PCIe domain ... single PE# */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pcie_type</span> <span class="o">==</span> <span class="n">PCI_EXP_TYPE_PCI_BRIDGE</span><span class="p">)</span>
			<span class="n">pnv_ioda_setup_bus_PE</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="n">pnv_ioda_setup_PEs</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_pci_ioda_dma_dev_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We delay DMA setup after we have assigned all PE# */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_bus_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_iommu_table_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="n">pnv_ioda_setup_bus_dma</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_pci_ioda_setup_dma_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">segs</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">tce_mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be64</span> <span class="o">*</span><span class="n">swinvp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iommu_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int64_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* 256M DMA window, 4K TCE pages, 8 bytes TCE */</span>
<span class="cp">#define TCE32_TABLE_SIZE	((0x10000000 / 0x1000) * 8)</span>

	<span class="cm">/* XXX FIXME: Handle 64-bit only DMA devices */</span>
	<span class="cm">/* XXX FIXME: Provide 64-bit DMA facilities &amp; non-4K TCE tables etc.. */</span>
	<span class="cm">/* XXX FIXME: Allocate multi-level tables on PHB3 */</span>

	<span class="cm">/* We shouldn&#39;t already have a 32-bit DMA associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Grab a 32-bit TCE table */</span>
	<span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">pe_info</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot; Setting up 32-bit TCE table at %08x..%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">),</span> <span class="p">((</span><span class="n">base</span> <span class="o">+</span> <span class="n">segs</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* XXX Currently, we allocate one big contiguous table for the</span>
<span class="cm">	 * TCEs. We only really need one chunk per 256M of TCE space</span>
<span class="cm">	 * (ie per segment) but that&#39;s an optimization for later, it</span>
<span class="cm">	 * requires some added smarts with our get/put_tce implementation</span>
<span class="cm">	 */</span>
	<span class="n">tce_mem</span> <span class="o">=</span> <span class="n">alloc_pages_node</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
				   <span class="n">get_order</span><span class="p">(</span><span class="n">TCE32_TABLE_SIZE</span> <span class="o">*</span> <span class="n">segs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tce_mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pe_err</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot; Failed to allocate a 32-bit TCE memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">tce_mem</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TCE32_TABLE_SIZE</span> <span class="o">*</span> <span class="n">segs</span><span class="p">);</span>

	<span class="cm">/* Configure HW */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">segs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_map_pe_dma_window</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span>
					      <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span>
					      <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">__pa</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">TCE32_TABLE_SIZE</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
					      <span class="n">TCE32_TABLE_SIZE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pe_err</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot; Failed to configure 32-bit TCE table,&quot;</span>
			       <span class="s">&quot; err %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup linux iommu table */</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_table</span><span class="p">;</span>
	<span class="n">pnv_pci_setup_iommu_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">TCE32_TABLE_SIZE</span> <span class="o">*</span> <span class="n">segs</span><span class="p">,</span>
				  <span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="cm">/* OPAL variant of P7IOC SW invalidated TCEs */</span>
	<span class="n">swinvp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,opal-tce-kill&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swinvp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need a couple more fields -- an address and a data</span>
<span class="cm">		 * to or.  Since the bus is only printed out on table free</span>
<span class="cm">		 * errors, and on the first pass the data will be a relative</span>
<span class="cm">		 * bus number, print that out instead.</span>
<span class="cm">		 */</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_busno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">be64_to_cpup</span><span class="p">(</span><span class="n">swinvp</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">it_type</span> <span class="o">=</span> <span class="n">TCE_PCI_SWINV_CREATE</span> <span class="o">|</span> <span class="n">TCE_PCI_SWINV_FREE</span>
			<span class="o">|</span> <span class="n">TCE_PCI_SWINV_PAIR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iommu_init_table</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
		<span class="n">set_iommu_table_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pnv_ioda_setup_bus_dma</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pbus</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="cm">/* XXX Failure: Try to fallback to 64-bit only ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pe</span><span class="o">-&gt;</span><span class="n">tce32_seg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tce_mem</span><span class="p">)</span>
		<span class="n">__free_pages</span><span class="p">(</span><span class="n">tce_mem</span><span class="p">,</span> <span class="n">get_order</span><span class="p">(</span><span class="n">TCE32_TABLE_SIZE</span> <span class="o">*</span> <span class="n">segs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_ioda_setup_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">residual</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">segs</span><span class="p">,</span> <span class="n">tw</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>

	<span class="cm">/* If we have more PE# than segments available, hand out one</span>
<span class="cm">	 * per PE until we run out and let the rest fail. If not,</span>
<span class="cm">	 * then we assign at least one segment per PE, plus more based</span>
<span class="cm">	 * on the amount of devices under that PE</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_pe_count</span> <span class="o">&gt;</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">tce32_count</span><span class="p">)</span>
		<span class="n">residual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">residual</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">tce32_count</span> <span class="o">-</span>
			<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_pe_count</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PCI: Domain %04x has %ld available 32-bit DMA segments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">global_number</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">tce32_count</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PCI: %d PE# for a total weight of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_pe_count</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_weight</span><span class="p">);</span>

	<span class="cm">/* Walk our PE list and configure their DMA segments, hand them</span>
<span class="cm">	 * out one base segment plus any residual segments based on</span>
<span class="cm">	 * weight</span>
<span class="cm">	 */</span>
	<span class="n">remaining</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">tce32_count</span><span class="p">;</span>
	<span class="n">tw</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">dma_weight</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remaining</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pe_warn</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;No DMA32 resources available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">segs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">residual</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">segs</span> <span class="o">+=</span> <span class="p">((</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span> <span class="o">*</span> <span class="n">residual</span><span class="p">)</span>  <span class="o">+</span> <span class="p">(</span><span class="n">tw</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">tw</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">segs</span> <span class="o">&gt;</span> <span class="n">remaining</span><span class="p">)</span>
				<span class="n">segs</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pe_info</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="s">&quot;DMA weight %d, assigned %d DMA32 segments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pe</span><span class="o">-&gt;</span><span class="n">dma_weight</span><span class="p">,</span> <span class="n">segs</span><span class="p">);</span>
		<span class="n">pnv_pci_ioda_setup_dma_pe</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">segs</span><span class="p">);</span>
		<span class="n">remaining</span> <span class="o">-=</span> <span class="n">segs</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">+=</span> <span class="n">segs</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pnv_pci_ioda_msi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hwirq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_64</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">msi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnv_ioda_pe</span> <span class="o">*</span><span class="n">pe</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xive_num</span> <span class="o">=</span> <span class="n">hwirq</span> <span class="o">-</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_base</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">addr64</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr32</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* No PE assigned ? bail out ... no MSI for you ! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Check if we have an MVE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Assign XIVE to PE */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_set_xive_pe</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">,</span> <span class="n">xive_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: OPAL error %d setting XIVE %d PE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">xive_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_get_msi_64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">,</span> <span class="n">xive_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">addr64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: OPAL error %d getting 64-bit MSI data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="n">addr64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span> <span class="o">=</span> <span class="n">addr64</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_get_msi_32</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">mve_number</span><span class="p">,</span> <span class="n">xive_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">addr32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: OPAL error %d getting 32-bit MSI data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span> <span class="o">=</span> <span class="n">addr32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;%s: %s-bit MSI on hwirq %x (xive #%d),&quot;</span>
		 <span class="s">&quot; address=%x_%08x data=%x PE# %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">is_64</span> <span class="o">?</span> <span class="s">&quot;64&quot;</span> <span class="o">:</span> <span class="s">&quot;32&quot;</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">,</span> <span class="n">xive_num</span><span class="p">,</span>
		 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_hi</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">address_lo</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">pe_number</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pnv_pci_init_ioda_msis</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bmap_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span>
					     <span class="s">&quot;ibm,opal-msi-ranges&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BML Fallback */</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;msi-ranges&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_base</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_count</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">prop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bmap_size</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_count</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_map</span> <span class="o">=</span> <span class="n">zalloc_maybe_bootmem</span><span class="p">(</span><span class="n">bmap_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PCI %d: Failed to allocate MSI bitmap !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">global_number</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_setup</span> <span class="o">=</span> <span class="n">pnv_pci_ioda_msi_setup</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi32_support</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  Allocated bitmap for %d MSIs (base IRQ 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_count</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">msi_base</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pnv_pci_init_ioda_msis</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>

<span class="cm">/* This is the starting point of our IODA specific resource</span>
<span class="cm"> * allocation process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pnv_pci_ioda_fixup_phb</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">child</span><span class="p">;</span>

	<span class="cm">/* Associate PEs per functions */</span>
	<span class="n">pnv_ioda_setup_PEs</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Calculate all resources */</span>
	<span class="n">pnv_ioda_calc_bus</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">align</span><span class="p">);</span>
	<span class="n">pnv_ioda_calc_bus</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">align</span><span class="p">);</span>

	<span class="cm">/* Apply then to HW */</span>
	<span class="n">pnv_ioda_update_resources</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Setup DMA */</span>
	<span class="n">pnv_ioda_setup_dma</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="cm">/* Configure PCI Express settings */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">children</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">pcie_bus_configure_settings</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">pcie_mpss</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Prevent enabling devices for which we couldn&#39;t properly</span>
<span class="cm"> * assign a PE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pnv_pci_enable_device_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dn</span> <span class="o">*</span><span class="n">pdn</span> <span class="o">=</span> <span class="n">pnv_ioda_get_pdn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdn</span> <span class="o">||</span> <span class="n">pdn</span><span class="o">-&gt;</span><span class="n">pe_number</span> <span class="o">==</span> <span class="n">IODA_INVALID_PE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pnv_ioda_bdfn_to_pe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_rmap</span><span class="p">[(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">devfn</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pnv_pci_init_ioda1_phb</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">primary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnv_phb</span> <span class="o">*</span><span class="n">phb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">m32map_off</span><span class="p">,</span> <span class="n">iomap_off</span><span class="p">,</span> <span class="n">pemap_off</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">prop64</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phb_id</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">aux</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; Initializing IODA OPAL PHB %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">prop64</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,opal-phbid&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  Missing </span><span class="se">\&quot;</span><span class="s">ibm,opal-phbid</span><span class="se">\&quot;</span><span class="s"> property !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phb_id</span> <span class="o">=</span> <span class="n">be64_to_cpup</span><span class="p">(</span><span class="n">prop64</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  PHB-ID  : 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phb_id</span><span class="p">);</span>

	<span class="n">phb</span> <span class="o">=</span> <span class="n">alloc_bootmem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">phb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_phb</span><span class="p">));</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span> <span class="o">=</span> <span class="n">pcibios_alloc_controller</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phb</span> <span class="o">||</span> <span class="o">!</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PCI: Failed to allocate PCI controller for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* XXX Use device-tree */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">phb</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">opal_id</span> <span class="o">=</span> <span class="n">phb_id</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PNV_PHB_IODA1</span><span class="p">;</span>

	<span class="cm">/* Detect specific models for error handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,p7ioc-pciex&quot;</span><span class="p">))</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PNV_PHB_MODEL_P7IOC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">PNV_PHB_MODEL_UNKNOWN</span><span class="p">;</span>

	<span class="cm">/* We parse &quot;ranges&quot; now since we need to deduce the register base</span>
<span class="cm">	 * from the IO base</span>
<span class="cm">	 */</span>
	<span class="n">pci_process_bridge_OF_ranges</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>
	<span class="n">primary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Magic formula from Milton */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  Failed to map registers !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* XXX This is hack-a-thon. This needs to be changed so that:</span>
<span class="cm">	 *  - we obtain stuff like PE# etc... from device-tree</span>
<span class="cm">	 *  - we properly re-allocate M32 ourselves</span>
<span class="cm">	 *    (the OFW one isn&#39;t very good)</span>
<span class="cm">	 */</span>

	<span class="cm">/* Initialize more IODA stuff */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="cm">/* OFW Has already off top 64k of M32 space (MSI space) */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_size</span> <span class="o">+=</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segsize</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_size</span> <span class="o">/</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_pci_base</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">-</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_size</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io_size</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segsize</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_size</span> <span class="o">/</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_pci_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX calculate this ? */</span>

	<span class="cm">/* Allocate aux data &amp; arrays */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
	<span class="n">m32map_off</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">;</span>
	<span class="n">iomap_off</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">;</span>
	<span class="n">pemap_off</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnv_ioda_pe</span><span class="p">);</span>
	<span class="n">aux</span> <span class="o">=</span> <span class="n">alloc_bootmem</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_alloc</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segmap</span> <span class="o">=</span> <span class="n">aux</span> <span class="o">+</span> <span class="n">m32map_off</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segmap</span> <span class="o">=</span> <span class="n">aux</span> <span class="o">+</span> <span class="n">iomap_off</span><span class="p">;</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_array</span> <span class="o">=</span> <span class="n">aux</span> <span class="o">+</span> <span class="n">pemap_off</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_alloc</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">pe_list</span><span class="p">);</span>

	<span class="cm">/* Calculate how many 32-bit TCE segments we have */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">tce32_count</span> <span class="o">=</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_pci_base</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>

	<span class="cm">/* Clear unusable m64 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	rc = opal_pci_set_phb_mem_window(opal-&gt;phb_id,</span>
<span class="c">					 window_type,</span>
<span class="c">					 window_num,</span>
<span class="c">					 starting_real_address,</span>
<span class="c">					 starting_pci_address,</span>
<span class="c">					 segment_size);</span>
<span class="cp">#endif</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  %d PE&#39;s M32: 0x%x [segment=0x%x] IO: 0x%x [segment=0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">total_pe</span><span class="p">,</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_size</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">m32_segsize</span><span class="p">,</span>
		<span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_size</span><span class="p">,</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">ioda</span><span class="p">.</span><span class="n">io_segsize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; BUID     = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; PHB2_CR  = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x160</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; IO_BAR   = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x170</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; IO_BAMR  = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x178</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; IO_SAR   = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x180</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; M32_BAR  = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x190</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; M32_BAMR = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x198</span><span class="p">));</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; M32_SAR  = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in_be64</span><span class="p">(</span><span class="n">phb</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="mh">0x1a0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pnv_pci_ops</span><span class="p">;</span>

	<span class="cm">/* Setup RID -&gt; PE mapping function */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">bdfn_to_pe</span> <span class="o">=</span> <span class="n">pnv_ioda_bdfn_to_pe</span><span class="p">;</span>

	<span class="cm">/* Setup TCEs */</span>
	<span class="n">phb</span><span class="o">-&gt;</span><span class="n">dma_dev_setup</span> <span class="o">=</span> <span class="n">pnv_pci_ioda_dma_dev_setup</span><span class="p">;</span>

	<span class="cm">/* Setup MSI support */</span>
	<span class="n">pnv_pci_init_ioda_msis</span><span class="p">(</span><span class="n">phb</span><span class="p">);</span>

	<span class="cm">/* We set both PCI_PROBE_ONLY and PCI_REASSIGN_ALL_RSRC. This is an</span>
<span class="cm">	 * odd combination which essentially means that we skip all resource</span>
<span class="cm">	 * fixups and assignments in the generic code, and do it all</span>
<span class="cm">	 * ourselves here</span>
<span class="cm">	 */</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">pcibios_fixup_phb</span> <span class="o">=</span> <span class="n">pnv_pci_ioda_fixup_phb</span><span class="p">;</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">pcibios_enable_device_hook</span> <span class="o">=</span> <span class="n">pnv_pci_enable_device_hook</span><span class="p">;</span>
	<span class="n">pci_add_flags</span><span class="p">(</span><span class="n">PCI_PROBE_ONLY</span> <span class="o">|</span> <span class="n">PCI_REASSIGN_ALL_RSRC</span><span class="p">);</span>

	<span class="cm">/* Reset IODA tables to a clean state */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_pci_reset</span><span class="p">(</span><span class="n">phb_id</span><span class="p">,</span> <span class="n">OPAL_PCI_IODA_TABLE_RESET</span><span class="p">,</span> <span class="n">OPAL_ASSERT_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;  OPAL Error %ld performing IODA table reset !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">opal_pci_set_pe</span><span class="p">(</span><span class="n">phb_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">,</span> <span class="n">OPAL_MAP_PE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">pnv_pci_init_ioda_hub</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">phbn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="o">*</span><span class="n">prop64</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hub_id</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Probing IODA IO-Hub %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">prop64</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,opal-hubid&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; Missing </span><span class="se">\&quot;</span><span class="s">ibm,opal-hubid</span><span class="se">\&quot;</span><span class="s"> property !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hub_id</span> <span class="o">=</span> <span class="n">be64_to_cpup</span><span class="p">(</span><span class="n">prop64</span><span class="p">);</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot; HUB-ID : 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hub_id</span><span class="p">);</span>

	<span class="cm">/* Count child PHBs */</span>
	<span class="n">for_each_child_of_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">phbn</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Look for IODA1 PHBs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">phbn</span><span class="p">,</span> <span class="s">&quot;ibm,ioda-phb&quot;</span><span class="p">))</span>
			<span class="n">pnv_pci_init_ioda1_phb</span><span class="p">(</span><span class="n">phbn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
