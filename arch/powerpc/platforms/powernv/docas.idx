f | Makefile | g | 172B |  | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1322193195 |  | powerpc/powernv: PCI support for p7IOC under OPAL v2  This adds support for p7IOC (and possibly other IODA v1 IO Hubs) using OPAL v2 interfaces.  We completely take over resource assignment and assign them using an algorithm that hands out device BARs in a way that makes them fit in individual segments of the M32 window of the bridge, which enables us to assign individual PEs to devices and functions.  The current implementation gives out a PE per functions on PCIe, and a PE for the entire bridge for PCIe to PCI-X bridges.  This can be adjusted / fine tuned later.  We also setup DMA resources (32-bit only for now) and MSIs (both 32-bit and 64-bit MSI are supported).  The DMA allocation tries to divide the available 256M segments of the 32-bit DMA address space "fairly" among PEs. This is done using a "weight" heuristic which assigns less value to things like OHCI USB controllers than, for example SCSI RAID controllers. This algorithm will probably want some fine tuning for specific devices or device types.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | pci.c | s | 16K | 518 | Linus Torvalds | torvalds@linux-foundation.org | 1332536532 |  | Merge branch 'linux-next' of git://git.kernel.org/pub/scm/linux/kernel/git/jbarnes/pci  Pull PCI changes (including maintainer change) from Jesse Barnes:  "This pull has some good cleanups from Bjorn and Yinghai, as well as   some more code from Yinghai to better handle resource re-allocation   when enabled.    There's also a new initcall_debug feature from Arjan which will print   out quirk timing information to help identify slow quirks for fixing   or refinement (Yinghai sent in a few patches to do just that once the   new debug code landed).    Beyond that, I'm handing off PCI maintainership to Bjorn Helgaas.   He's been a core PCI and Linux contributor for some time now, and has   kindly volunteered to take over.  I just don't feel I have the time   for PCI review and work that it deserves lately (I've taken on some   other projects), and haven't been as responsive lately as I'd like, so   I approached Bjorn asking if he'd like to manage things.  He's going   to give it a try, and I'm confident he'll do at least as well as I   have in keeping the tree managed, patches flowing, and keeping things   stable."  Fix up some fairly trivial conflicts due to other cleanups (mips device resource fixup cleanups clashing with list handling cleanup, ppc iseries removal clashing with pci_probe_only cleanup etc)  * 'linux-next' of git://git.kernel.org/pub/scm/linux/kernel/git/jbarnes/pci: (112 commits)   PCI: Bjorn gets PCI hotplug too   PCI: hand PCI maintenance over to Bjorn Helgaas   unicore32/PCI: move <asm-generic/pci-bridge.h> include to asm/pci.h   sparc/PCI: convert devtree and arch-probed bus addresses to resource   powerpc/PCI: allow reallocation on PA Semi   powerpc/PCI: convert devtree bus addresses to resource   powerpc/PCI: compute I/O space bus-to-resource offset consistently   arm/PCI: don't export pci_flags   PCI: fix bridge I/O window bus-to-resource conversion   x86/PCI: add spinlock held check to 'pcibios_fwaddrmap_lookup()'   PCI / PCIe: Introduce command line option to disable ARI   PCI: make acpihp use __pci_remove_bus_device instead   PCI: export __pci_remove_bus_device   PCI: Rename pci_remove_behind_bridge to pci_stop_and_remove_behind_bridge   PCI: Rename pci_remove_bus_device to pci_stop_and_remove_bus_device   PCI: print out PCI device info along with duration   PCI: Move "pci reassigndev resource alignment" out of quirks.c   PCI: Use class for quirk for usb host controller fixup   PCI: Use class for quirk for ti816x class fixup   PCI: Use class for quirk for intel e100 interrupt fixup   ...
f | pci.h | s | 3.4K | 120 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1323241442 |  | powerpc/powernv: Display diag data on p7ioc EEH errors  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | opal-wrappers.S | g | 4.3K |  | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1323241322 |  | powerpc/powernv: Update OPAL interfaces  This adds some more interfaces for OPAL v2  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | setup.c | s | 4.1K | 165 | Danny Kukawka | danny.kukawka@bisect.de | 1330302839 |  | arch/powerpc/platforms/powernv/setup.c: included asm/xics.h twice  arch/powerpc/platforms/powernv/setup.c: included 'asm/xics.h' twice, remove the duplicate.  Signed-off-by: Danny Kukawka <danny.kukawka@bisect.de> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | opal.c | s | 8.6K | 290 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316499003 |  | powerpc/powernv: Machine check and other system interrupts  OPAL can handle various interrupt for us such as Machine Checks (it performs all sorts of recovery tasks and passes back control to us with informations about the error), Hardware Management Interrupts and Softpatch interrupts.  This wires up the mechanisms and prints out specific informations returned by HAL when a machine check occurs.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | pci-p5ioc2.c | s | 6.6K | 206 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1323241442 |  | powerpc/powernv: Display diag data on p7ioc EEH errors  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | powernv.h | s | 275B | 13 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316499004 |  | powerpc/powernv: Add support for p5ioc2 PCI-X and PCIe  This adds support for PCI-X and PCIe on the p5ioc2 IO hub using OPAL. This includes allocating & setting up TCE tables and config space access routines.  This also supports fallbacks via RTAS when OPAL is absent, using legacy TCE format pre-allocated via the device-tree (BML style)  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | smp.c | s | 4.5K | 158 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | Kconfig | g | 389B |  | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316498990 |  | powerpc/powernv: Basic support for OPAL  Add definition of OPAL interfaces along with  the wrappers to call into OPAL runtime and the early device-tree parsing hook to locate the OPAL runtime firmware.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | opal-takeover.S | g | 2.6K |  | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316498987 |  | powerpc/powernv: Add OPAL takeover from PowerVM  On machines supporting the OPAL firmware version 1, the system is initially booted under pHyp. We then use a special hypercall to verify if OPAL is available and if it is, we then trigger a "takeover" which disables pHyp and loads the OPAL runtime firmware, giving control to the kernel in hypervisor mode.  This patch add the necessary code to detect that the OPAL takeover capability is present when running under PowerVM (aka pHyp) and perform said takeover to get hypervisor control of the processor.  To perform the takeover, we must first use RTAS (within Open Firmware runtime environment) to start all processors & threads, in order to give control to OPAL on all of them. We then call the takeover hypercall on everybody, OPAL will re-enter the kernel main entry point passing it a flat device-tree.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | opal-rtc.c | s | 2.3K | 84 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316498997 |  | powerpc/powernv: Add RTC and NVRAM support plus RTAS fallbacks  Implements OPAL RTC and NVRAM support and wire all that up to the powernv platform.  We use RTAS for RTC as a fallback if available. Using RTAS for nvram is not supported yet, pending some rework/cleanup and generalization of the pSeries & CHRP code. We also use RTAS fallbacks for power off and reboot  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | pci-ioda.c | s | 35K | 1171 | Bjorn Helgaas | bhelgaas@google.com | 1330053538 |  | powerpc/PCI: replace pci_probe_only with pci_flags  We already use pci_flags, so this just sets pci_flags directly and removes the intermediate step of figuring out pci_probe_only, then using it to set pci_flags.  The PCI core provides a pci_flags definition (currently __weak), so drop the powerpc definitions in favor of that.  CC: Benjamin Herrenschmidt <benh@kernel.crashing.org> CC: linuxppc-dev@lists.ozlabs.org Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
f | opal-nvram.c | s | 1.8K | 72 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1316498997 |  | powerpc/powernv: Add RTC and NVRAM support plus RTAS fallbacks  Implements OPAL RTC and NVRAM support and wire all that up to the powernv platform.  We use RTAS for RTC as a fallback if available. Using RTAS for nvram is not supported yet, pending some rework/cleanup and generalization of the pSeries & CHRP code. We also use RTAS fallbacks for power off and reboot  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
