<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › chrp › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1995  Linus Torvalds</span>
<span class="cm"> *  Adapted from &#39;alpha&#39; version by Gary Thomas</span>
<span class="cm"> *  Modified by Cort Dougan (cort@cs.nmt.edu)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * bootup setup stuff..</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;generated/utsrelease.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/hydra.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/i8259.h&gt;</span>
<span class="cp">#include &lt;asm/mpic.h&gt;</span>
<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/xmon.h&gt;</span>

<span class="cp">#include &quot;chrp.h&quot;</span>
<span class="cp">#include &quot;gg2.h&quot;</span>

<span class="kt">void</span> <span class="n">rtas_indicator_progress</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">_chrp_type</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">_chrp_type</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">chrp_mpic</span><span class="p">;</span>

<span class="cm">/* Used for doing CHRP event-scans */</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">timer_list</span><span class="p">,</span> <span class="n">heartbeat_timer</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event_scan_interval</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loops_per_jiffy</span><span class="p">;</span>

<span class="cm">/* To be replaced by RTAS when available */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">briq_SPOR</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">smp_ops_t</span> <span class="n">chrp_smp_ops</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gg2_memtypes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;FPM&quot;</span><span class="p">,</span> <span class="s">&quot;SDRAM&quot;</span><span class="p">,</span> <span class="s">&quot;EDO&quot;</span><span class="p">,</span> <span class="s">&quot;BEDO&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gg2_cachesizes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;256 KB&quot;</span><span class="p">,</span> <span class="s">&quot;512 KB&quot;</span><span class="p">,</span> <span class="s">&quot;1 MB&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gg2_cachetypes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Asynchronous&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved&quot;</span><span class="p">,</span> <span class="s">&quot;Flow-Through Synchronous&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pipelined Synchronous&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gg2_cachemodes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Disabled&quot;</span><span class="p">,</span> <span class="s">&quot;Write-Through&quot;</span><span class="p">,</span> <span class="s">&quot;Copy-Back&quot;</span><span class="p">,</span> <span class="s">&quot;Transparent Mode&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chrp_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span>
	<span class="s">&quot;Motorola&quot;</span><span class="p">,</span>
	<span class="s">&quot;IBM or Longtrail&quot;</span><span class="p">,</span>
	<span class="s">&quot;Genesi Pegasos&quot;</span><span class="p">,</span>
	<span class="s">&quot;Total Impact Briq&quot;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">chrp_show_cpuinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdramen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;machine</span><span class="se">\t\t</span><span class="s">: CHRP %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>

	<span class="cm">/* longtrail (goldengate) stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;IBM,LongTrail&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* VLSI VAS96011/12 `Golden Gate 2&#39; */</span>
		<span class="cm">/* Memory banks */</span>
		<span class="n">sdramen</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="n">gg2_pci_config_base</span> <span class="o">+</span> <span class="n">GG2_PCI_DRAM_CTRL</span><span class="p">)</span>
			   <span class="o">&gt;&gt;</span><span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sdramen</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="n">gg2_pci_config_base</span><span class="o">+</span>
						 <span class="n">GG2_PCI_DRAM_BANK0</span><span class="o">+</span>
						 <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x1f</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;4 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1e</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;8 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x1c</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;16 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x18</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;32 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x10</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;64 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x00</span>:
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;128 MB&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">model</span> <span class="o">=</span> <span class="s">&quot;Reserved&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;memory bank %d</span><span class="se">\t</span><span class="s">: %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span>
				   <span class="n">gg2_memtypes</span><span class="p">[</span><span class="n">sdramen</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">((</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)]);</span>
		<span class="p">}</span>
		<span class="cm">/* L2 cache */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="n">gg2_pci_config_base</span><span class="o">+</span><span class="n">GG2_PCI_CC_CTRL</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;board l2</span><span class="se">\t</span><span class="s">: %s %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">gg2_cachesizes</span><span class="p">[(</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">],</span>
			   <span class="n">gg2_cachetypes</span><span class="p">[(</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">],</span>
			   <span class="n">gg2_cachemodes</span><span class="p">[</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Fixes for the National Semiconductor PC78308VUL SuperI/O</span>
<span class="cm"> *</span>
<span class="cm"> *  Some versions of Open Firmware incorrectly initialize the IRQ settings</span>
<span class="cm"> *  for keyboard and mouse</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sio_write</span><span class="p">(</span><span class="n">u8</span> <span class="n">val</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mh">0x15c</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mh">0x15d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="n">__init</span> <span class="nf">sio_read</span><span class="p">(</span><span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mh">0x15c</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x15d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sio_fixup_irq</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u8</span> <span class="n">device</span><span class="p">,</span> <span class="n">u8</span> <span class="n">level</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">level0</span><span class="p">,</span> <span class="n">type0</span><span class="p">,</span> <span class="n">active</span><span class="p">;</span>

	<span class="cm">/* select logical device */</span>
	<span class="n">sio_write</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">active</span> <span class="o">=</span> <span class="n">sio_read</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
	<span class="n">level0</span> <span class="o">=</span> <span class="n">sio_read</span><span class="p">(</span><span class="mh">0x70</span><span class="p">);</span>
	<span class="n">type0</span> <span class="o">=</span> <span class="n">sio_read</span><span class="p">(</span><span class="mh">0x71</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level0</span> <span class="o">!=</span> <span class="n">level</span> <span class="o">||</span> <span class="n">type0</span> <span class="o">!=</span> <span class="n">type</span> <span class="o">||</span> <span class="o">!</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sio: %s irq level %d, type %d, %sactive: &quot;</span>
		       <span class="s">&quot;remapping to level %d, type %d, active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">level0</span><span class="p">,</span> <span class="n">type0</span><span class="p">,</span> <span class="o">!</span><span class="n">active</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">sio_write</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">sio_write</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="n">sio_write</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;IBM,LongTrail&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* logical device 0 (KBC/Keyboard) */</span>
		<span class="n">sio_fixup_irq</span><span class="p">(</span><span class="s">&quot;keyboard&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* select logical device 1 (KBC/Mouse) */</span>
		<span class="n">sio_fixup_irq</span><span class="p">(</span><span class="s">&quot;mouse&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pegasos_set_l2cr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="cm">/* On Pegasos, enable the l2 cache if needed, as the OF forgets it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_chrp_type</span> <span class="o">!=</span> <span class="n">_CHRP_Pegasos</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Enable L2 cache if needed */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">l2cr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;l2cr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l2cr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Pegasos l2cr : no cpu l2cr property found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">l2cr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Pegasos l2cr : L2 cache was not active, &quot;</span>
				<span class="s">&quot;activating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">_set_L2CR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">_set_L2CR</span><span class="p">((</span><span class="o">*</span><span class="n">l2cr</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">briq_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">briq_SPOR</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">briq_SPOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(;;);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Per default, input/output-device points to the keyboard/screen</span>
<span class="cm"> * If no card is installed, the built-in serial port is used as a fallback.</span>
<span class="cm"> * But unfortunately, the firmware does not connect /chosen/{stdin,stdout}</span>
<span class="cm"> * the the built-in serial node. Instead, a /failsafe node is created.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">chrp_init_early</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">cmd_line</span><span class="p">,</span> <span class="s">&quot;console=&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* find the boot console from /chosen/stdout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_chosen</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="s">&quot;Pegasos2&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="cm">/* this is a Pegasos2 */</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">of_chosen</span><span class="p">,</span> <span class="s">&quot;linux,stdout-path&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * The 9pin connector is either /failsafe</span>
<span class="cm">	 * or /pci@80000000/isa@C/serial@i2F8</span>
<span class="cm">	 * The optional graphics card has also type &#39;serial&#39; in VGA mode.</span>
<span class="cm">	 */</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="s">&quot;failsafe&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">))</span>
		<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyS&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out_put:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">chrp_setup_arch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">machine</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* init to some ~sane value until calibrate_delay() runs */</span>
	<span class="n">loops_per_jiffy</span> <span class="o">=</span> <span class="mi">50000000</span><span class="o">/</span><span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span>
		<span class="n">machine</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s">&quot;Pegasos&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_chrp_type</span> <span class="o">=</span> <span class="n">_CHRP_Pegasos</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s">&quot;IBM&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_chrp_type</span> <span class="o">=</span> <span class="n">_CHRP_IBM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s">&quot;MOT&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_chrp_type</span> <span class="o">=</span> <span class="n">_CHRP_Motorola</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">machine</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s">&quot;TotalImpact,BRIQ-1&quot;</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_chrp_type</span> <span class="o">=</span> <span class="n">_CHRP_briq</span><span class="p">;</span>
		<span class="cm">/* Map the SPOR register on briq and change the restart hook */</span>
		<span class="n">briq_SPOR</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0xff0000e8</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">restart</span> <span class="o">=</span> <span class="n">briq_restart</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Let&#39;s assume it is an IBM chrp if all else fails */</span>
		<span class="n">_chrp_type</span> <span class="o">=</span> <span class="n">_CHRP_IBM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;chrp type = %x [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_chrp_type</span><span class="p">,</span> <span class="n">chrp_names</span><span class="p">[</span><span class="n">_chrp_type</span><span class="p">]);</span>

	<span class="n">rtas_initialize</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;display-character&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span> <span class="o">=</span> <span class="n">rtas_progress</span><span class="p">;</span>

	<span class="cm">/* use RTAS time-of-day routines if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;get-time-of-day&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTAS_UNKNOWN_SERVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_boot_time</span>	<span class="o">=</span> <span class="n">rtas_get_boot_time</span><span class="p">;</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_rtc_time</span>	<span class="o">=</span> <span class="n">rtas_get_rtc_time</span><span class="p">;</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">set_rtc_time</span>	<span class="o">=</span> <span class="n">rtas_set_rtc_time</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On pegasos, enable the L2 cache if not already done by OF */</span>
	<span class="n">pegasos_set_l2cr</span><span class="p">();</span>

	<span class="cm">/* Lookup PCI host bridges */</span>
	<span class="n">chrp_find_bridges</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Temporary fixes for PCI devices.</span>
<span class="cm">	 *  -- Geert</span>
<span class="cm">	 */</span>
	<span class="n">hydra_init</span><span class="p">();</span>		<span class="cm">/* Mac I/O */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Fix the Super I/O configuration</span>
<span class="cm">	 */</span>
	<span class="n">sio_init</span><span class="p">();</span>

	<span class="n">pci_create_OF_bus_map</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Print the banner, then scroll down so boot progress</span>
<span class="cm">	 * can be printed.  -- Cort</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">)</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;Linux/PPC &quot;</span><span class="n">UTS_RELEASE</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chrp_8259_cascade</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cascade_irq</span> <span class="o">=</span> <span class="n">i8259_irq</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cascade_irq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">cascade_irq</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Finds the open-pic node and sets up the mpic driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">chrp_find_openpic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isu_size</span><span class="p">,</span> <span class="n">idu_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">iranges</span><span class="p">,</span> <span class="o">*</span><span class="n">opprop</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">na</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;open-pic&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opprop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;platform-open-pic&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oplen</span><span class="p">);</span>
		<span class="n">na</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opprop</span> <span class="o">&amp;&amp;</span> <span class="n">oplen</span> <span class="o">&gt;=</span> <span class="n">na</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">opaddr</span> <span class="o">=</span> <span class="n">opprop</span><span class="p">[</span><span class="n">na</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* assume 32-bit */</span>
		<span class="n">oplen</span> <span class="o">/=</span> <span class="n">na</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">opaddr</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="n">oplen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OpenPIC at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opaddr</span><span class="p">);</span>

	<span class="n">iranges</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;interrupt-ranges&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iranges</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* non-distributed mpic */</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">/=</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first pair of cells in interrupt-ranges refers to the</span>
<span class="cm">	 * IDU; subsequent pairs refer to the ISUs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oplen</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Insufficient addresses for distributed&quot;</span>
		       <span class="s">&quot; OpenPIC (%d &lt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oplen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">oplen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isu_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">idu_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OpenPIC irqs %d..%d in IDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">idu_size</span> <span class="o">=</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">isu_size</span> <span class="o">=</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">chrp_mpic</span> <span class="o">=</span> <span class="n">mpic_alloc</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">opaddr</span><span class="p">,</span> <span class="n">MPIC_NO_RESET</span><span class="p">,</span>
			<span class="n">isu_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot; MPIC    &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chrp_mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to allocate MPIC structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iranges</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">+=</span> <span class="n">na</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OpenPIC irqs %d..%d in ISU at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iranges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">iranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">opprop</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="n">mpic_assign_isu</span><span class="p">(</span><span class="n">chrp_mpic</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">opprop</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">mpic_init</span><span class="p">(</span><span class="n">chrp_mpic</span><span class="p">);</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_irq</span> <span class="o">=</span> <span class="n">mpic_get_irq</span><span class="p">;</span>
 <span class="nl">bail:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_VT) &amp;&amp; defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_XMON)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irqaction</span> <span class="n">xmon_irqaction</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">xmon_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;XMON break&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">chrp_find_8259</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="o">*</span><span class="n">pic</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chrp_int_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cascade_irq</span><span class="p">;</span>

	<span class="cm">/* Look for cascade */</span>
	<span class="n">for_each_node_by_type</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;interrupt-controller&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;chrp,iic&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pic</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/* Ok, 8259 wasn&#39;t found. We need to handle the case where</span>
<span class="cm">	 * we have a pegasos that claims to be chrp but doesn&#39;t have</span>
<span class="cm">	 * a proper interrupt tree</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pic</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">chrp_mpic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i8259: Not found in device-tree&quot;</span>
		       <span class="s">&quot; assuming no legacy interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Look for intack. In a perfect world, we would look for it on</span>
<span class="cm">	 * the ISA bus that holds the 8259 but heh... Works that way. If</span>
<span class="cm">	 * we ever see a problem, we can try to re-use the pSeries code here.</span>
<span class="cm">	 * Also, Pegasos-type platforms don&#39;t have a proper node to start</span>
<span class="cm">	 * from anyway</span>
<span class="cm">	 */</span>
	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;pci&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span>
				<span class="s">&quot;8259-interrupt-acknowledge&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">chrp_int_ack</span> <span class="o">=</span> <span class="n">addrp</span><span class="p">[</span><span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">np</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Cannot find PCI interrupt acknowledge&quot;</span>
		       <span class="s">&quot; address, polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">i8259_init</span><span class="p">(</span><span class="n">pic</span><span class="p">,</span> <span class="n">chrp_int_ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">get_irq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_irq</span> <span class="o">=</span> <span class="n">i8259_irq</span><span class="p">;</span>
		<span class="n">irq_set_default_host</span><span class="p">(</span><span class="n">i8259_get_host</span><span class="p">());</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chrp_mpic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cascade_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">pic</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cascade_irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;i8259: failed to map cascade irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">cascade_irq</span><span class="p">,</span>
						<span class="n">chrp_8259_cascade</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">chrp_init_IRQ</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_VT) &amp;&amp; defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_XMON)</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">kbd</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">chrp_find_openpic</span><span class="p">();</span>
	<span class="n">chrp_find_8259</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="cm">/* Pegasos has no MPIC, those ops would make it crash. It might be an</span>
<span class="cm">	 * option to move setting them to after we probe the PIC though</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chrp_mpic</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">smp_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chrp_smp_ops</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_chrp_type</span> <span class="o">==</span> <span class="n">_CHRP_Pegasos</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">get_irq</span>        <span class="o">=</span> <span class="n">i8259_irq</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_VT) &amp;&amp; defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_XMON)</span>
	<span class="cm">/* see if there is a keyboard in the device tree</span>
<span class="cm">	   with a parent of type &quot;adb&quot; */</span>
	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">kbd</span><span class="p">,</span> <span class="s">&quot;keyboard&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">kbd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">type</span>
		    <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">kbd</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;adb&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">kbd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kbd</span><span class="p">)</span>
		<span class="n">setup_irq</span><span class="p">(</span><span class="n">HYDRA_INT_ADB_NMI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmon_irqaction</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">chrp_init2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_NVRAM</span>
	<span class="n">chrp_nvram_init</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">request_region</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="s">&quot;pic1&quot;</span><span class="p">);</span>
	<span class="n">request_region</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="s">&quot;pic2&quot;</span><span class="p">);</span>
	<span class="n">request_region</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="s">&quot;dma1&quot;</span><span class="p">);</span>
	<span class="n">request_region</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="s">&quot;timer&quot;</span><span class="p">);</span>
	<span class="n">request_region</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="s">&quot;dma page reg&quot;</span><span class="p">);</span>
	<span class="n">request_region</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x20</span><span class="p">,</span><span class="s">&quot;dma2&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;  Have fun!    &quot;</span><span class="p">,</span> <span class="mh">0x7777</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">chrp_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="kt">char</span> <span class="o">*</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">of_get_flat_dt_prop</span><span class="p">(</span><span class="n">of_get_flat_dt_root</span><span class="p">(),</span>
 					  <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
 		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="s">&quot;chrp&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ISA_DMA_THRESHOLD</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0L</span><span class="p">;</span>
	<span class="n">DMA_MODE_READ</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="n">DMA_MODE_WRITE</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">define_machine</span><span class="p">(</span><span class="n">chrp</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;CHRP&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">chrp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_arch</span>		<span class="o">=</span> <span class="n">chrp_setup_arch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">chrp_init2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_early</span>		<span class="o">=</span> <span class="n">chrp_init_early</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show_cpuinfo</span>		<span class="o">=</span> <span class="n">chrp_show_cpuinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_IRQ</span>		<span class="o">=</span> <span class="n">chrp_init_IRQ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart</span>		<span class="o">=</span> <span class="n">rtas_restart</span><span class="p">,</span>
	<span class="p">.</span><span class="n">power_off</span>		<span class="o">=</span> <span class="n">rtas_power_off</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt</span>			<span class="o">=</span> <span class="n">rtas_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">time_init</span>		<span class="o">=</span> <span class="n">chrp_time_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rtc_time</span>		<span class="o">=</span> <span class="n">chrp_set_rtc_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rtc_time</span>		<span class="o">=</span> <span class="n">chrp_get_rtc_time</span><span class="p">,</span>
	<span class="p">.</span><span class="n">calibrate_decr</span>		<span class="o">=</span> <span class="n">generic_calibrate_decr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phys_mem_access_prot</span>	<span class="o">=</span> <span class="n">pci_phys_mem_access_prot</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
