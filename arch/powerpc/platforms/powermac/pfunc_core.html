<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › powermac › pfunc_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pfunc_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: Properly make this race free with refcounting etc...</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: LOCKING !!!</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_pfunc.h&gt;</span>

<span class="cm">/* Debug */</span>
<span class="cp">#define LOG_PARSE(fmt...)</span>
<span class="cp">#define LOG_ERROR(fmt...)	printk(fmt)</span>
<span class="cp">#define LOG_BLOB(t,b,c)</span>

<span class="cp">#undef DEBUG</span>
<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(fmt...)		printk(fmt)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt...)</span>
<span class="cp">#endif</span>

<span class="cm">/* Command numbers */</span>
<span class="cp">#define PMF_CMD_LIST			0</span>
<span class="cp">#define PMF_CMD_WRITE_GPIO		1</span>
<span class="cp">#define PMF_CMD_READ_GPIO		2</span>
<span class="cp">#define PMF_CMD_WRITE_REG32		3</span>
<span class="cp">#define PMF_CMD_READ_REG32		4</span>
<span class="cp">#define PMF_CMD_WRITE_REG16		5</span>
<span class="cp">#define PMF_CMD_READ_REG16		6</span>
<span class="cp">#define PMF_CMD_WRITE_REG8		7</span>
<span class="cp">#define PMF_CMD_READ_REG8		8</span>
<span class="cp">#define PMF_CMD_DELAY			9</span>
<span class="cp">#define PMF_CMD_WAIT_REG32		10</span>
<span class="cp">#define PMF_CMD_WAIT_REG16		11</span>
<span class="cp">#define PMF_CMD_WAIT_REG8		12</span>
<span class="cp">#define PMF_CMD_READ_I2C		13</span>
<span class="cp">#define PMF_CMD_WRITE_I2C		14</span>
<span class="cp">#define PMF_CMD_RMW_I2C			15</span>
<span class="cp">#define PMF_CMD_GEN_I2C			16</span>
<span class="cp">#define PMF_CMD_SHIFT_BYTES_RIGHT	17</span>
<span class="cp">#define PMF_CMD_SHIFT_BYTES_LEFT	18</span>
<span class="cp">#define PMF_CMD_READ_CFG		19</span>
<span class="cp">#define PMF_CMD_WRITE_CFG		20</span>
<span class="cp">#define PMF_CMD_RMW_CFG			21</span>
<span class="cp">#define PMF_CMD_READ_I2C_SUBADDR	22</span>
<span class="cp">#define PMF_CMD_WRITE_I2C_SUBADDR	23</span>
<span class="cp">#define PMF_CMD_SET_I2C_MODE		24</span>
<span class="cp">#define PMF_CMD_RMW_I2C_SUBADDR		25</span>
<span class="cp">#define PMF_CMD_READ_REG32_MASK_SHR_XOR	26</span>
<span class="cp">#define PMF_CMD_READ_REG16_MASK_SHR_XOR	27</span>
<span class="cp">#define PMF_CMD_READ_REG8_MASK_SHR_XOR	28</span>
<span class="cp">#define PMF_CMD_WRITE_REG32_SHL_MASK	29</span>
<span class="cp">#define PMF_CMD_WRITE_REG16_SHL_MASK	30</span>
<span class="cp">#define PMF_CMD_WRITE_REG8_SHL_MASK	31</span>
<span class="cp">#define PMF_CMD_MASK_AND_COMPARE	32</span>
<span class="cp">#define PMF_CMD_COUNT			33</span>

<span class="cm">/* This structure holds the state of the parser while walking through</span>
<span class="cm"> * a function definition</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span>		<span class="o">*</span><span class="n">cmdptr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span>		<span class="o">*</span><span class="n">cmdend</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_function</span>	<span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">instdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_args</span>		<span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">error</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Debug output */</span>
<span class="c">static void print_blob(const char *title, const void *blob, int bytes)</span>
<span class="c">{</span>
<span class="c">	printk(&quot;%s&quot;, title);</span>
<span class="c">	while(bytes--) {</span>
<span class="c">		printk(&quot;%02x &quot;, *((u8 *)blob));</span>
<span class="c">		blob += 1;</span>
<span class="c">	}</span>
<span class="c">	printk(&quot;\n&quot;);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Parser helpers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">pmf_next32</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdend</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">pmf_next_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdend</span> <span class="o">-</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Individual command parsers</span>
<span class="cm"> */</span>

<span class="cp">#define PMF_PARSE_CALL(name, cmd, handlers, p...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (cmd-&gt;error) \</span>
<span class="cp">			return -ENXIO; \</span>
<span class="cp">		if (handlers == NULL) \</span>
<span class="cp">			return 0; \</span>
<span class="cp">		if (handlers-&gt;name)				      \</span>
<span class="cp">			return handlers-&gt;name(cmd-&gt;func, cmd-&gt;instdata, \</span>
<span class="cp">					      cmd-&gt;args, p);	      \</span>
<span class="cp">		return -1; \</span>
<span class="cp">	} while(0) \</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_gpio(value: %02x, mask: %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_gpio</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rshift</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">xor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_gpio(mask: %02x, rshift: %d, xor: %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">mask</span><span class="p">,</span> <span class="n">rshift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_gpio</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">rshift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg32(offset: %08x, value: %08x, mask: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg32</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg32(offset: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg32</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg16(offset: %08x, value: %04x, mask: %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg16</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg16(offset: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg16</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg8(offset: %08x, value: %02x, mask: %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg8</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg8(offset: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg8</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: delay(duration: %d us)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_wait_reg32</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: wait_reg32(offset: %08x, comp_value: %08x,mask: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">wait_reg32</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_wait_reg16</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: wait_reg16(offset: %08x, comp_value: %04x,mask: %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">wait_reg16</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_wait_reg8</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: wait_reg8(offset: %08x, comp_value: %02x,mask: %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">wait_reg8</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_i2c(bytes: %ud)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_i2c</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_i2c(bytes: %ud) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_i2c</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">blob</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_rmw_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">maskbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">valuesbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">totalbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">maskblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">valuesblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: rmw_i2c(maskbytes: %ud, valuebytes: %ud, &quot;</span>
		  <span class="s">&quot;totalbytes: %d) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span> <span class="n">totalbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   mask data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   values data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">rmw_i2c</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span> <span class="n">totalbytes</span><span class="p">,</span>
		       <span class="n">maskblob</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_cfg(offset: %x, bytes: %ud)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_cfg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_cfg(offset: %x, bytes: %ud)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_cfg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">blob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_rmw_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">maskbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">valuesbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">totalbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">maskblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">valuesblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: rmw_cfg(maskbytes: %ud, valuebytes: %ud,&quot;</span>
		  <span class="s">&quot; totalbytes: %d) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span> <span class="n">totalbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   mask data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   values data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">rmw_cfg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span>
		       <span class="n">totalbytes</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_i2c_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">subaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_i2c_sub(subaddr: %x, bytes: %ud)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">subaddr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_i2c_sub</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">subaddr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_i2c_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">subaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_i2c_sub(subaddr: %x, bytes: %ud) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">subaddr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_i2c_sub</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">subaddr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">blob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_set_i2c_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: set_i2c_mode(mode: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">set_i2c_mode</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_rmw_i2c_sub</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">subaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">maskbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">valuesbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">totalbytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">maskblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">valuesblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: rmw_i2c_sub(subaddr: %x, maskbytes: %ud, valuebytes: %ud&quot;</span>
		  <span class="s">&quot;, totalbytes: %d) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">subaddr</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span> <span class="n">totalbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   mask data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   values data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">rmw_i2c_sub</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">subaddr</span><span class="p">,</span> <span class="n">maskbytes</span><span class="p">,</span> <span class="n">valuesbytes</span><span class="p">,</span>
		       <span class="n">totalbytes</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg32_msrx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">xor</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg32_msrx(offset: %x, mask: %x, shift: %x,&quot;</span>
		  <span class="s">&quot; xor: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg32_msrx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg16_msrx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">xor</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg16_msrx(offset: %x, mask: %x, shift: %x,&quot;</span>
		  <span class="s">&quot; xor: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg16_msrx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_read_reg8_msrx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">xor</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: read_reg8_msrx(offset: %x, mask: %x, shift: %x,&quot;</span>
		  <span class="s">&quot; xor: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">read_reg8_msrx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">xor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg32_slm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg32_slm(offset: %x, shift: %x, mask: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg32_slm</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg16_slm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg16_slm(offset: %x, shift: %x, mask: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg16_slm</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_write_reg8_slm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: write_reg8_slm(offset: %x, shift: %x, mask: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">write_reg8_slm</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parser_mask_and_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">maskblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">valuesblob</span> <span class="o">=</span> <span class="n">pmf_next_blob</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: mask_and_compare(length: %ud ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   mask data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">LOG_BLOB</span><span class="p">(</span><span class="s">&quot;pmf:   values data: </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="n">PMF_PARSE_CALL</span><span class="p">(</span><span class="n">mask_and_compare</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span>
		       <span class="n">bytes</span><span class="p">,</span> <span class="n">maskblob</span><span class="p">,</span> <span class="n">valuesblob</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pmf_cmd_parser_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">h</span><span class="p">);</span>

<span class="k">static</span> <span class="n">pmf_cmd_parser_t</span> <span class="n">pmf_parsers</span><span class="p">[</span><span class="n">PMF_CMD_COUNT</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="n">pmf_parser_write_gpio</span><span class="p">,</span>
	<span class="n">pmf_parser_read_gpio</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg32</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg32</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg16</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg16</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg8</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg8</span><span class="p">,</span>
	<span class="n">pmf_parser_delay</span><span class="p">,</span>
	<span class="n">pmf_parser_wait_reg32</span><span class="p">,</span>
	<span class="n">pmf_parser_wait_reg16</span><span class="p">,</span>
	<span class="n">pmf_parser_wait_reg8</span><span class="p">,</span>
	<span class="n">pmf_parser_read_i2c</span><span class="p">,</span>
	<span class="n">pmf_parser_write_i2c</span><span class="p">,</span>
	<span class="n">pmf_parser_rmw_i2c</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* Bogus command */</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* Shift bytes right: NYI */</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* Shift bytes left: NYI */</span>
	<span class="n">pmf_parser_read_cfg</span><span class="p">,</span>
	<span class="n">pmf_parser_write_cfg</span><span class="p">,</span>
	<span class="n">pmf_parser_rmw_cfg</span><span class="p">,</span>
	<span class="n">pmf_parser_read_i2c_sub</span><span class="p">,</span>
	<span class="n">pmf_parser_write_i2c_sub</span><span class="p">,</span>
	<span class="n">pmf_parser_set_i2c_mode</span><span class="p">,</span>
	<span class="n">pmf_parser_rmw_i2c_sub</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg32_msrx</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg16_msrx</span><span class="p">,</span>
	<span class="n">pmf_parser_read_reg8_msrx</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg32_slm</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg16_slm</span><span class="p">,</span>
	<span class="n">pmf_parser_write_reg8_slm</span><span class="p">,</span>
	<span class="n">pmf_parser_mask_and_compare</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmf_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span>	<span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_handlers</span>	<span class="o">*</span><span class="n">handlers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">functions</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span>		<span class="n">ref</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">pmf_devices</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pmf_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pmf_irq_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmf_release_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_device</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmf_put_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">pmf_release_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="nf">pmf_get_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="nf">pmf_find_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmf_devices</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">==</span> <span class="n">np</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pmf_get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_parse_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">handlers</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">instdata</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ccode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">cmdptr</span>		<span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmdend</span>		<span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">func</span>       		<span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">instdata</span>		<span class="o">=</span> <span class="n">instdata</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">args</span>		<span class="o">=</span> <span class="n">args</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">error</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LOG_PARSE</span><span class="p">(</span><span class="s">&quot;pmf: func %s, %d bytes, %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		  <span class="n">handlers</span> <span class="o">?</span> <span class="s">&quot;executing&quot;</span> <span class="o">:</span> <span class="s">&quot;parsing&quot;</span><span class="p">);</span>

	<span class="cm">/* One subcommand to parse for now */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">cmdptr</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">cmdend</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get opcode */</span>
		<span class="n">ccode</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="cm">/* Check if we are hitting a command list, fetch new count */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ccode</span> <span class="o">=</span> <span class="n">pmf_next32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;pmf: parse error, not enough data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccode</span> <span class="o">&gt;=</span> <span class="n">PMF_CMD_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;pmf: command code %d unknown !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmf_parsers</span><span class="p">[</span><span class="n">ccode</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;pmf: no parser for command %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmf_parsers</span><span class="p">[</span><span class="n">ccode</span><span class="p">](</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">handlers</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;pmf: parser for command %d returned&quot;</span>
				  <span class="s">&quot; error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We are doing an initial parse pass, we need to adjust the size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handlers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">cmdptr</span> <span class="o">-</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_add_function_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">driverdata</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: Adding functions for platform-do-%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate a structure */</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq_clients</span><span class="p">);</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">driverdata</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: idx %d: flags=%08x, phandle=%08x &quot;</span>
		    <span class="s">&quot; %d bytes remaining, parsing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmf_parse_one</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">);</span>
		<span class="n">pmf_get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">bail:</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: Added %d functions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pmf_add_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">driverdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">property</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
<span class="cp">#define PP_PREFIX &quot;platform-do-&quot;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">plen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PP_PREFIX</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">;</span> <span class="n">pp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">PP_PREFIX</span><span class="p">,</span> <span class="n">plen</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">+</span> <span class="n">plen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">pmf_add_function_prop</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driverdata</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
						       <span class="n">pp</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pmf_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">pmf_handlers</span> <span class="o">*</span><span class="n">handlers</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">driverdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handlers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: registering driver for node %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pmf_find_device</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: already there !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pmf_put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: no memory !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handlers</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmf_add_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">driverdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: no functions, disposing.. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmf_devices</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_register_driver</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="nf">pmf_get_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_get_function</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmf_release_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_function</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="n">pmf_put_device</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__pmf_put_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">pmf_release_function</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pmf_put_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">__pmf_put_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_put_function</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmf_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: unregistering driver for node %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pmf_find_device</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;pmf: not such driver !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">),</span> <span class="n">link</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
		<span class="n">__pmf_put_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pmf_put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_unregister_driver</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="nf">__pmf_find_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">actor</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fname</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ph</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Look for a &quot;platform-*&quot; function reference. If we can&#39;t find</span>
<span class="cm">	 * one, then we fallback to a direct call attempt</span>
<span class="cm">	 */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="s">&quot;platform-%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">find_it</span><span class="p">;</span>
	<span class="n">ph</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ph</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">find_it</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, now try to find the actor. If we can&#39;t find it, we fail,</span>
<span class="cm">	 * there is no point in falling back there</span>
<span class="cm">	 */</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">actor</span><span class="p">);</span>
	<span class="n">actor</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="nl">find_it:</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pmf_find_device</span><span class="p">(</span><span class="n">actor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">phandle</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pmf_put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">actor</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pmf_register_irq_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pmf_irq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">__pmf_find_function</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">PMF_FLAGS_INT_GEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">pmf_get_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* guard against manipulations of list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_irq_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq_clients</span><span class="p">))</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="cm">/* guard against pmf_do_irq while changing list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq_clients</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_irq_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_register_irq_client</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmf_unregister_irq_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_irq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* guard against manipulations of list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_irq_mutex</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* guard against pmf_do_irq while changing list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq_clients</span><span class="p">))</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">irq_disable</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_irq_mutex</span><span class="p">);</span>
	<span class="n">pmf_put_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_unregister_irq_client</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">pmf_do_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_irq_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="cm">/* For now, using a spinlock over the whole function. Can be made</span>
<span class="cm">	 * to drop the lock using 2 lists if necessary</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">irq_clients</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_do_irq</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">pmf_call_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">instdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot; ** pmf_call_one(%s/%s) **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">)</span>
		<span class="n">instdata</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmf_parse_one</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">,</span> <span class="n">instdata</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">instdata</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_call_one</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pmf_do_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">phandle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fflags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pmf_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pmf_find_device</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phandle</span> <span class="o">&amp;&amp;</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span> <span class="o">&amp;&amp;</span> <span class="n">phandle</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">phandle</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">fflags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmf_get_function</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pmf_call_one</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
		<span class="n">pmf_put_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pmf_put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_do_functions</span><span class="p">);</span>


<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="nf">pmf_find_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">__pmf_find_function</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">PMF_FLAGS_ON_DEMAND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span><span class="p">)</span>
		<span class="n">func</span> <span class="o">=</span> <span class="n">pmf_get_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">func</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_find_function</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pmf_call_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">pmf_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pmf_function</span> <span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">pmf_find_function</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pmf_call_one</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">pmf_put_function</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pmf_call_function</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
