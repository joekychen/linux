f | pic.c | s | 17K | 557 | Grant Likely | grant.likely@secretlab.ca | 1335746726 |  | powerpc/irqdomain: Fix broken NR_IRQ references  The switch from using irq_map to irq_alloc_desc*() for managing irq number allocations introduced new bugs in some of the powerpc interrupt code.  Several functions rely on the value of NR_IRQS to determine the maximum irq number that could get allocated.  However, with sparse_irq and using irq_alloc_desc*() the maximum possible irq number is now specified with 'nr_irqs' which may be a number larger than NR_IRQS.  This has caused breakage on powermac when CONFIG_NR_IRQS is set to 32.  This patch removes most of the direct references to NR_IRQS in the powerpc code and replaces them with either a nr_irqs reference or by using the common for_each_irq_desc() macro.  The powerpc-specific for_each_irq() macro is removed at the same time.  Also, the Cell axon_msi driver is refactored to remove the global build assumption on the size of NR_IRQS and instead add a limit to the maximum irq number when calling irq_domain_add_nomap().  Signed-off-by: Grant Likely <grant.likely@secretlab.ca> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | pci.c | s | 37K | 1219 | Bjorn Helgaas | bhelgaas@google.com | 1330053538 |  | powerpc/PCI: make pci_probe_only default to 0  pci_probe_only is set on ppc64 to prevent resource re-allocation by the core. It's meant to be used in very specific circumstances such as when operating under a hypervisor that may prevent such re-allocation.  Instead of default to 1, we make it default to 0 and explicitly set it in the few cases where we need it.  This fixes FSL PCI which wants it clear among others.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
f | time.c | s | 8.0K | 295 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | Makefile | g | 791B |  | Lucas De Marchi | lucas.demarchi@profusion.mobi | 1301581583 |  | Fix common misspellings  Fixes generated by 'codespell' and manually reviewed.  Signed-off-by: Lucas De Marchi <lucas.demarchi@profusion.mobi>
f | nvram.c | s | 15K | 549 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | low_i2c.c | s | 36K | 1303 | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1335764237 |  | i2c/powermac: Register i2c devices from device-tree  This causes i2c-powermac to register i2c devices exposed in the device-tree, enabling new-style probing of devices.  Note that we prefix the IDs with "MAC," in order to prevent the generic drivers from matching. This is done on purpose as we only want drivers specifically tested/designed to operate on powermacs to match.  This removes the special case we had for the AMS driver, and updates the driver's match table instead.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | udbg_scc.c | s | 4.1K | 159 | Grant Likely | grant.likely@secretlab.ca | 1265729580 |  | of: add 'of_' prefix to machine_is_compatible()  machine is compatible is an OF-specific call.  It should have the of_ prefix to protect the global namespace.  Signed-off-by: Grant Likely <grant.likely@secretlab.ca> Acked-by: Michal Simek <monstr@monstr.eu>
f | feature.c | s | 80K | 2769 | Paul Gortmaker | paul.gortmaker@windriver.com | 1320103837 |  | powerpc: add export.h to files making use of EXPORT_SYMBOL  With module.h being implicitly everywhere via device.h, the absence of explicitly including something for EXPORT_SYMBOL went unnoticed. Since we are heading to fix things up and clean module.h from the device.h file, we need to explicitly include these files now.  Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
f | backlight.c | s | 5.4K | 175 | Paul Gortmaker | paul.gortmaker@windriver.com | 1320103837 |  | powerpc: add export.h to files making use of EXPORT_SYMBOL  With module.h being implicitly everywhere via device.h, the absence of explicitly including something for EXPORT_SYMBOL went unnoticed. Since we are heading to fix things up and clean module.h from the device.h file, we need to explicitly include these files now.  Signed-off-by: Paul Gortmaker <paul.gortmaker@windriver.com>
f | pfunc_core.c | s | 25K | 841 | Julia Lawall | julia@diku.dk | 1283400453 |  | powerpc/powermac/pfunc_core.c: Add of_node_put to avoid memory leak  Add a call to of_node_put in the error handling code following a call to of_find_node_by_phandle.  The semantic match that finds this problem is as follows: (http://coccinelle.lip6.fr/)  // <smpl> @r exists@ local idexpression x; expression E,E1; statement S; @@  *x = (of_find_node_by_path ||of_find_node_by_name ||of_find_node_by_phandle ||of_get_parent ||of_get_next_parent ||of_get_next_child ||of_find_compatible_node ||of_match_node )(...); ... if (x == NULL) S <... when != x = E *if (...) {   ... when != of_node_put(x)       when != if (...) { ... of_node_put(x); ... } (   return <+...x...+>; || *  return ...; ) } ...> of_node_put(x); // </smpl>  Signed-off-by: Julia Lawall <julia@diku.dk> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | cpufreq_64.c | s | 19K | 622 | Anton Blanchard | anton@samba.org | 1273130172 |  | powerpc/cpumask: Use cpu_online_mask  Change &cpu_online_map to cpu_online_mask.  Signed-off-by: Anton Blanchard <anton@samba.org> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | udbg_adb.c | s | 5.0K | 193 | Stephen Rothwell | sfr@canb.auug.org.au | 1187312526 |  | [POWERPC] Fix section mismatches in udbg_adb.c  The functions are only called from __init functions.  WARNING: vmlinux.o(.text+0x45ed0): Section mismatch: reference to .init.text:.btext_find_display (between '.udbg_adb_init_early' and '.udbg_adb_init') WARNING: vmlinux.o(.text+0x45f9c): Section mismatch: reference to .init.text:.btext_find_display (between '.udbg_adb_init' and '.udbg_adb_getc_poll') WARNING: vmlinux.o(.text+0x46000): Section mismatch: reference to .init.text:.find_via_pmu (between '.udbg_adb_init' and '.udbg_adb_getc_poll')  Signed-off-by: Stephen Rothwell <sfr@canb.auug.org.au> Signed-off-by: Paul Mackerras <paulus@samba.org>
f | smp.c | s | 24K | 866 | Grant Likely | grant.likely@secretlab.ca | 1334212668 |  | irq_domain: Move irq_virq_count into NOMAP revmap  This patch replaces the old global setting of irq_virq_count that is only used by the NOMAP mapping and instead uses a revmap_data property so that the maximum NOMAP allocation can be set per NOMAP irq_domain.  There is exactly one user of irq_virq_count in-tree right now: PS3. Also, irq_virq_count is only useful for the NOMAP mapping.  So, instead of having a single global irq_virq_count values, this change drops it entirely and added a max_irq argument to irq_domain_add_nomap(). That makes it a property of an individual nomap irq domain instead of a global system settting.  Signed-off-by: Grant Likely <grant.likely@secretlab.ca> Tested-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> Cc: Thomas Gleixner <tglx@linutronix.de> Cc: Milton Miller <miltonm@bga.com>
f | setup.c | s | 15K | 599 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | Kconfig | g | 746B |  | Milton Miller | miltonm@bga.com | 1305783065 |  | powerpc: Add kconfig for muxed smp ipi support  Compile the new smp ipi mux and demux code only if a platform will make use of it.  The new config is selected as required.  The new cause_ipi smp op is only available conditionally to point out configs where the select is required; this makes setting the op an immediate fail instead of a deferred unresolved symbol at link.  This also creates a new config for power surge powermac upgrade support that can be disabled in expert mode but is default on.  I also removed the depends / default y on CONFIG_XICS since it is selected by PSERIES.  Signed-off-by: Milton Miller <miltonm@bga.com> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | sleep.S | g | 8.0K |  | Benjamin Herrenschmidt | benh@kernel.crashing.org | 1229829676 |  | powerpc/mm: Introduce MMU features  We're soon running out of CPU features and I need to add some new ones for various MMU related bits, so this patch separates the MMU features from the CPU features.  I moved over the 32-bit MMU related ones, added base features for MMU type families, but didn't move over any 64-bit only feature yet.  Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> Acked-by: Kumar Gala <galak@kernel.crashing.org> Signed-off-by: Paul Mackerras <paulus@samba.org>
f | cpufreq_32.c | s | 18K | 606 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | pmac.h | s | 1.2K | 32 | Milton Miller | miltonm@bga.com | 1305783111 |  | powerpc/psurge: Create a irq_host for secondary cpus  Create a dummy irq_host using the generic dummy irq chip for the secondary cpus to use.  Create a direct irq mapping for the ipi and register the ipi action handler against it.  If for some unlikely reason part of this fails then don't detect the secondary cpus.  This removes another instance of NO_IRQ_IGNORE, records the ipi stats for the secondary cpus, and runs the ipi on the interrupt stack.  Signed-off-by: Milton Miller <miltonm@bga.com> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
f | bootx_init.c | s | 16K | 524 | David Howells | dhowells@redhat.com | 1332955802 |  | Disintegrate asm/system.h for PowerPC  Disintegrate asm/system.h for PowerPC.  Signed-off-by: David Howells <dhowells@redhat.com> Acked-by: Benjamin Herrenschmidt <benh@kernel.crashing.org> cc: linuxppc-dev@lists.ozlabs.org
f | cache.S | g | 7.3K |  | Jörn Engel | joern@wohnheim.fh-wedel.de | 1151688336 |  | Remove obsolete #include <linux/config.h>  Signed-off-by: Jörn Engel <joern@wohnheim.fh-wedel.de> Signed-off-by: Adrian Bunk <bunk@stusta.de>
f | pfunc_base.c | s | 10K | 336 | Thomas Gleixner | tglx@linutronix.de | 1266551552 |  | powerpc: Convert feature_lock to raw_spinlock  feature_lock needs to be a real spinlock in RT. Convert it to raw_spinlock.  Signed-off-by: Thomas Gleixner <tglx@linutronix.de> Signed-off-by: Benjamin Herrenschmidt <benh@kernel.crashing.org>
