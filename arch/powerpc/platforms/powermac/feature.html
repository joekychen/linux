<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › powermac › feature.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>feature.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1996-2001 Paul Mackerras (paulus@cs.anu.edu.au)</span>
<span class="cm"> *                          Ben. Herrenschmidt (benh@kernel.crashing.org)</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version</span>
<span class="cm"> *  2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *</span>
<span class="cm"> *   - Replace mdelay with some schedule loop if possible</span>
<span class="cm"> *   - Shorten some obfuscated delays on some routines (like modem</span>
<span class="cm"> *     power)</span>
<span class="cm"> *   - Refcount some clocks (see darwin)</span>
<span class="cm"> *   - Split split split...</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_address.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/pmu.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/errno.h&gt;</span>
<span class="cp">#include &lt;asm/ohare.h&gt;</span>
<span class="cp">#include &lt;asm/heathrow.h&gt;</span>
<span class="cp">#include &lt;asm/keylargo.h&gt;</span>
<span class="cp">#include &lt;asm/uninorth.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/dbdma.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_low_i2c.h&gt;</span>

<span class="cp">#undef DEBUG_FEATURE</span>

<span class="cp">#ifdef DEBUG_FEATURE</span>
<span class="cp">#define DBG(fmt...) printk(KERN_DEBUG fmt)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt...)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_6xx</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">powersave_lowspeed</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">powersave_nap</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">k2_skiplist</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * We use a single global lock to protect accesses. Each driver has</span>
<span class="cm"> * to take care of its own locking</span>
<span class="cm"> */</span>
<span class="n">DEFINE_RAW_SPINLOCK</span><span class="p">(</span><span class="n">feature_lock</span><span class="p">);</span>

<span class="cp">#define LOCK(flags)	raw_spin_lock_irqsave(&amp;feature_lock, flags);</span>
<span class="cp">#define UNLOCK(flags)	raw_spin_unlock_irqrestore(&amp;feature_lock, flags);</span>


<span class="cm">/*</span>
<span class="cm"> * Instance of some macio stuffs</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">macio_chip</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">MAX_MACIO_CHIPS</span><span class="p">];</span>

<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="nf">macio_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MACIO_CHIPS</span> <span class="o">&amp;&amp;</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">==</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">type</span> <span class="o">||</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">macio_find</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">macio_names</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Grand Central&quot;</span><span class="p">,</span>
	<span class="s">&quot;OHare&quot;</span><span class="p">,</span>
	<span class="s">&quot;OHareII&quot;</span><span class="p">,</span>
	<span class="s">&quot;Heathrow&quot;</span><span class="p">,</span>
	<span class="s">&quot;Gatwick&quot;</span><span class="p">,</span>
	<span class="s">&quot;Paddington&quot;</span><span class="p">,</span>
	<span class="s">&quot;Keylargo&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pangea&quot;</span><span class="p">,</span>
	<span class="s">&quot;Intrepid&quot;</span><span class="p">,</span>
	<span class="s">&quot;K2&quot;</span><span class="p">,</span>
	<span class="s">&quot;Shasta&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">uninorth_node</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">uninorth_base</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">uninorth_rev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">uninorth_maj</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">u3_ht_base</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * For each motherboard family, we have a table of functions pointers</span>
<span class="cm"> * that handle the various features.</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">feature_call</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">selector</span><span class="p">;</span>
	<span class="n">feature_call</span>	<span class="n">function</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pmac_mb_def</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span>			<span class="n">model_string</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span>			<span class="n">model_name</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">model_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">feature_table_entry</span><span class="o">*</span>	<span class="n">features</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>			<span class="n">board_flags</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pmac_mb_def</span> <span class="n">pmac_mb</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Here are the chip specific feature functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">simple_feature_tweak</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_POWER4</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_htw_scc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				 <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">chan_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">fcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">htw</span><span class="p">,</span> <span class="n">trans</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">rmask</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ch-a&quot;</span><span class="p">))</span>
		<span class="n">chan_mask</span> <span class="o">=</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ch-b&quot;</span><span class="p">))</span>
		<span class="n">chan_mask</span> <span class="o">=</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">htw</span> <span class="o">=</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_heathrow</span> <span class="o">||</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_paddington</span>
		<span class="o">||</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_gatwick</span><span class="p">);</span>
	<span class="cm">/* On these machines, the HRW_SCC_TRANS_EN_N bit mustn&#39;t be touched */</span>
	<span class="n">trans</span> <span class="o">=</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">PMAC_TYPE_YOSEMITE</span> <span class="o">&amp;&amp;</span>
		 <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">PMAC_TYPE_YIKES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ADB_PMU</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">)</span>
			<span class="n">pmu_enable_irled</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB_PMU */</span><span class="cp"></span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">);</span>
		<span class="cm">/* Check if scc cell need enabling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fcr</span> <span class="o">&amp;</span> <span class="n">OH_SCC_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">OH_SCC_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">htw</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Side effect: this will also power up the</span>
<span class="cm">				 * modem, but it&#39;s too messy to figure out on which</span>
<span class="cm">				 * ports this controls the tranceiver and on which</span>
<span class="cm">				 * it controls the modem</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">trans</span><span class="p">)</span>
					<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HRW_SCC_TRANS_EN_N</span><span class="p">;</span>
				<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rmask</span> <span class="o">=</span> <span class="n">HRW_RESET_SCC</span><span class="p">);</span>
				<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rmask</span> <span class="o">=</span> <span class="n">OH_SCC_RESET</span><span class="p">);</span>
				<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rmask</span><span class="p">;</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">)</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">OH_SCCA_IO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">)</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">OH_SCCB_IO</span><span class="p">;</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">chan_mask</span><span class="p">;</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">&amp;</span> <span class="n">PMAC_SCC_FLAG_XMON</span><span class="p">)</span>
			<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_SCC_LOCKED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCC_LOCKED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">)</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OH_SCCA_IO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">)</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OH_SCCB_IO</span><span class="p">;</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">OH_SCCA_IO</span> <span class="o">|</span> <span class="n">OH_SCCB_IO</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OH_SCC_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">htw</span> <span class="o">&amp;&amp;</span> <span class="n">trans</span><span class="p">)</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">HRW_SCC_TRANS_EN_N</span><span class="p">;</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">chan_mask</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ADB_PMU</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">)</span>
			<span class="n">pmu_enable_irled</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB_PMU */</span><span class="cp"></span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_floppy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				<span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
		<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_FLOPPY_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_mesh_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
		<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_MESH_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_ide_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* For some reason, setting the bit in set_initial_features()</span>
<span class="cm">		 * doesn&#39;t stick. I&#39;m still investigating... --BenH.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
				<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IOBUS_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
			<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IDE0_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
			<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_BAY_IDE_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_ide_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
			<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IDE0_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">,</span>
			<span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IDE1_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ohare_sleep_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_CAN_SLEEP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IOBUS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IOBUS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_modem_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				  <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">gpio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">gpio</span> <span class="o">=</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">PMAC_TYPE_YOSEMITE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">PMAC_TYPE_YIKES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SCC_TRANS_EN_N</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SCC_TRANS_EN_N</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_floppy_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				   <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
		<span class="n">HEATHROW_FCR</span><span class="p">,</span>
		<span class="n">HRW_SWIM_ENABLE</span><span class="o">|</span><span class="n">HRW_BAY_FLOPPY_ENABLE</span><span class="p">,</span>
		<span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_mesh_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				 <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Set clear mesh cell enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_MESH_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_MESH_ENABLE</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* Set/Clear termination power */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_MBCR</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_MBCR</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_MBCR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_ide_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				<span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_IDE0_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BAY_IDE_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_ide_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
			       <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_IDE0_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_IDE1_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_bmac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				 <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BMAC_IO_ENABLE</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BMAC_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BMAC_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BMAC_IO_ENABLE</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_sound_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				  <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* B&amp;W G3 and Yikes don&#39;t support that properly (the</span>
<span class="cm">	 * sound appear to never come back after beeing shut down).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_YOSEMITE</span> <span class="o">||</span>
	    <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_YIKES</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_CLK_ENABLE</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_POWER_N</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_POWER_N</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_CLK_ENABLE</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">save_mbcr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">save_dbdma</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">save_alt_dbdma</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbdma_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="o">*</span><span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save state &amp; config of DBDMA channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">((</span><span class="mh">0x8000</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdptr_hi</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cmdptr_hi</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdptr</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">intr_sel</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">intr_sel</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_sel</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">br_sel</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_sel</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">wait_sel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbdma_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="o">*</span><span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save state &amp; config of DBDMA channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="k">struct</span> <span class="n">dbdma_regs</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">chan</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">((</span><span class="mh">0x8000</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x100</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">ACTIVE</span><span class="o">|</span><span class="n">DEAD</span><span class="o">|</span><span class="n">WAKE</span><span class="o">|</span><span class="n">FLUSH</span><span class="o">|</span><span class="n">PAUSE</span><span class="o">|</span><span class="n">RUN</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACTIVE</span><span class="p">)</span>
			<span class="n">mb</span><span class="p">();</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cmdptr_hi</span><span class="p">,</span> <span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdptr_hi</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">,</span> <span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdptr</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">intr_sel</span><span class="p">,</span> <span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">intr_sel</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">br_sel</span><span class="p">,</span> <span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">br_sel</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">wait_sel</span><span class="p">,</span> <span class="n">save</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait_sel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">heathrow_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondary</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbdma_save</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_alt_dbdma</span><span class="p">);</span>
		<span class="n">save_fcr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">save_fcr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbdma_save</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_dbdma</span><span class="p">);</span>
		<span class="n">save_fcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">save_fcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">);</span>
		<span class="n">save_mbcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x34</span><span class="p">);</span>
		<span class="cm">/* Make sure sound is shut down */</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_POWER_N</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_CLK_ENABLE</span><span class="p">);</span>
		<span class="cm">/* This seems to be necessary as well or the fan</span>
<span class="cm">		 * keeps coming up and battery drains fast */</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_IOBUS_ENABLE</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_IDE0_RESET_N</span><span class="p">);</span>
		<span class="cm">/* Make sure eth is down even if module or sleep</span>
<span class="cm">		 * won&#39;t work properly */</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_BMAC_IO_ENABLE</span> <span class="o">|</span> <span class="n">HRW_BMAC_RESET</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Make sure modem is shut down */</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">,</span>
		<span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">HRW_GPIO_MODEM_RESET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SCC_TRANS_EN_N</span><span class="p">);</span>
	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">OH_SCCA_IO</span><span class="o">|</span><span class="n">OH_SCCB_IO</span><span class="o">|</span><span class="n">HRW_SCC_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Let things settle */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">heathrow_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondary</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">dbdma_restore</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_alt_dbdma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">HRW_IOBUS_ENABLE</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x3c</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="n">save_mbcr</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="mh">0x38</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">dbdma_restore</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_dbdma</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">heathrow_sleep_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span>
				 <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_CAN_SLEEP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_gatwick</span><span class="p">)</span>
			<span class="n">heathrow_sleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">heathrow_sleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">heathrow_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_gatwick</span><span class="p">)</span>
			<span class="n">heathrow_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">core99_scc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">chan_mask</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">fcr</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ch-a&quot;</span><span class="p">))</span>
		<span class="n">chan_mask</span> <span class="o">=</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ch-b&quot;</span><span class="p">))</span>
		<span class="n">chan_mask</span> <span class="o">=</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">need_reset_scc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">need_reset_irda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
		<span class="cm">/* Check if scc cell need enabling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fcr</span> <span class="o">&amp;</span> <span class="n">KL0_SCC_CELL_ENABLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_SCC_CELL_ENABLE</span><span class="p">;</span>
			<span class="n">need_reset_scc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_SCCA_ENABLE</span><span class="p">;</span>
			<span class="cm">/* Don&#39;t enable line drivers for I2S modem */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PMAC_SCC_I2S1</span><span class="p">)</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_SCC_A_INTF_ENABLE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_SCC_A_INTF_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_SCCB_ENABLE</span><span class="p">;</span>
			<span class="cm">/* Perform irda specific inits */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_SCC_B_INTF_ENABLE</span><span class="p">;</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_IRDA_ENABLE</span><span class="p">;</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_IRDA_CLK32_ENABLE</span> <span class="o">|</span> <span class="n">KL0_IRDA_CLK19_ENABLE</span><span class="p">;</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_IRDA_SOURCE1_SEL</span><span class="p">;</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL0_IRDA_FAST_CONNECT</span><span class="o">|</span><span class="n">KL0_IRDA_DEFAULT1</span><span class="o">|</span><span class="n">KL0_IRDA_DEFAULT0</span><span class="p">);</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL0_IRDA_SOURCE2_SEL</span><span class="o">|</span><span class="n">KL0_IRDA_HIGH_BAND</span><span class="p">);</span>
				<span class="n">need_reset_irda</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">fcr</span> <span class="o">|=</span> <span class="n">KL0_SCC_B_INTF_ENABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">chan_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_reset_scc</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_SCC_RESET</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_SCC_RESET</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_reset_irda</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_IRDA_RESET</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_IRDA_RESET</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">&amp;</span> <span class="n">PMAC_SCC_FLAG_XMON</span><span class="p">)</span>
			<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_SCC_LOCKED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCC_LOCKED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">fcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCA_ON</span><span class="p">)</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_SCCA_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mask</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_SCCB_ENABLE</span><span class="p">;</span>
			<span class="cm">/* Perform irda specific clears */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">param</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">==</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_IRDA_ENABLE</span><span class="p">;</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL0_IRDA_CLK32_ENABLE</span> <span class="o">|</span> <span class="n">KL0_IRDA_CLK19_ENABLE</span><span class="p">);</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL0_IRDA_FAST_CONNECT</span><span class="o">|</span><span class="n">KL0_IRDA_DEFAULT1</span><span class="o">|</span><span class="n">KL0_IRDA_DEFAULT0</span><span class="p">);</span>
				<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL0_IRDA_SOURCE1_SEL</span><span class="o">|</span><span class="n">KL0_IRDA_SOURCE2_SEL</span><span class="o">|</span><span class="n">KL0_IRDA_HIGH_BAND</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">KL0_SCCA_ENABLE</span> <span class="o">|</span> <span class="n">KL0_SCCB_ENABLE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KL0_SCC_CELL_ENABLE</span><span class="p">;</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">fcr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">chan_mask</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_modem_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">gpio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Hack for internal USB modem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">gpio</span> <span class="o">=</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
	<span class="n">gpio</span> <span class="o">|=</span> <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">gpio</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_ALT_DATA_OUT</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_ALT_DATA_OUT</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">pangea_modem_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">gpio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Hack for internal USB modem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
		    <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">gpio</span> <span class="o">=</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
	<span class="n">gpio</span> <span class="o">|=</span> <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">gpio</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_POWER</span><span class="p">,</span>
			<span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_POWER</span><span class="p">,</span>
			<span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">,</span> <span class="n">gpio</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_MODEM_RESET</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_ata100_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pbus</span><span class="p">,</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_rev</span> <span class="o">&lt;</span> <span class="mh">0x24</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">UN_BIS</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_ATA100</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">UN_BIC</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_ATA100</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_device_from_OF_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_ide_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Bus ID 0 to 2 are KeyLargo based IDE, busID 3 is U2</span>
<span class="cm">	 * based ata-100</span>
<span class="cm">	 */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_EIDE0_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	    <span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_EIDE1_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	    <span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_UIDE_ENABLE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	    <span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">core99_ata100_enable</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	    <span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_ide_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_EIDE0_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	    <span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_EIDE1_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	    <span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">simple_feature_tweak</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macio_unknown</span><span class="p">,</span>
			<span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_UIDE_RESET_N</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	    <span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_gmac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">UN_BIS</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_GMAC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">UN_BIC</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_GMAC</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_gmac_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_ETH_PHY_RESET</span><span class="p">,</span> <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_ETH_PHY_RESET</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_ETH_PHY_RESET</span><span class="p">,</span> <span class="cm">/*KEYLARGO_GPIO_OUTPUT_ENABLE | */</span>
		<span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_sound_chip_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Do a better probe code, screamer G4 desktops &amp;</span>
<span class="cm">	 * iMacs can do that too, add a recalibrate  in</span>
<span class="cm">	 * the driver as well</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_PISMO</span> <span class="o">||</span>
	    <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_TITANIUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_SOUND_POWER</span><span class="p">,</span>
				<span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span> <span class="o">|</span>
				<span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_SOUND_POWER</span><span class="p">,</span>
				<span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_SOUND_POWER</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_airport_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span><span class="o">*</span>	<span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">state</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="n">macio_find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Hint: we allow passing of macio itself for the sake of the</span>
<span class="cm">	 * sleep code</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">||</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">!=</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_AIRPORT_ON</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This code is a reproduction of OF enable-cardslot</span>
<span class="cm">		 * and init-wireless methods, slightly hacked until</span>
<span class="cm">		 * I got it working.</span>
<span class="cm">		 */</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xf</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xf</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xf</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_CARDSEL_16</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xb</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xa</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xa</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="mh">0xd</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xd</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xd</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xe</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="mh">0xe</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="mh">0x1c000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="mh">0x1a3e0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="mh">0x1a3e0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_CARDSEL_16</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_AIRPORT_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_CARDSEL_16</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_AIRPORT_4</span><span class="p">);</span>
		<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MACIO_FLAG_AIRPORT_ON</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_reset_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reset_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">cpus</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">dflt_reset_lines</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>	<span class="n">KL_GPIO_RESET_CPU0</span><span class="p">,</span>
						<span class="n">KL_GPIO_RESET_CPU1</span><span class="p">,</span>
						<span class="n">KL_GPIO_RESET_CPU2</span><span class="p">,</span>
						<span class="n">KL_GPIO_RESET_CPU3</span> <span class="p">};</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">cpus</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/cpus&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">np</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rst</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;soft-reset&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reset_io</span> <span class="o">=</span> <span class="o">*</span><span class="n">rst</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">reset_io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reset_io</span> <span class="o">=</span> <span class="n">dflt_reset_lines</span><span class="p">[</span><span class="n">param</span><span class="p">];</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">,</span> <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_usb_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;AAPL,clock-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;usb0u048&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;usb1u148&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">number</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;usb2u248&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">number</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Sorry for the brute-force locking, but this is only used during</span>
<span class="cm">	 * sleep and the timing seem to be critical</span>
<span class="cm">	 */</span>
	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn ON */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="p">(</span><span class="n">KL0_USB0_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL0_USB0_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_USB0_CELL_ENABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="p">(</span><span class="n">KL0_USB1_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL0_USB1_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_USB1_CELL_ENABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="p">(</span><span class="n">KL1_USB2_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL1_USB2_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_USB2_CELL_ENABLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="p">(</span><span class="n">KL4_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL4_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">));</span>
			<span class="n">reg</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="p">(</span><span class="n">KL4_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL4_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="p">(</span><span class="n">KL3_IT_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL3_IT_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">reg</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="p">(</span><span class="n">KL3_IT_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL3_IT_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_intrepid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait for clock stopped bits to clear */</span>
			<span class="n">u32</span> <span class="n">test0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">test1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">status0</span><span class="p">,</span> <span class="n">status1</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

			<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">test0</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB0</span><span class="p">;</span>
				<span class="n">test1</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB0PCI</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">test0</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB1</span><span class="p">;</span>
				<span class="n">test1</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB1PCI</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">test0</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB2</span><span class="p">;</span>
				<span class="n">test1</span> <span class="o">=</span> <span class="n">UNI_N_CLOCK_STOPPED_USB2PCI</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;core99_usb_enable: &quot;</span>
					       <span class="s">&quot;Timeout waiting for clocks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">status0</span> <span class="o">=</span> <span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_STOP_STATUS0</span><span class="p">);</span>
				<span class="n">status1</span> <span class="o">=</span> <span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_STOP_STATUS1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">test0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">test1</span><span class="p">));</span>
			<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn OFF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span>	<span class="n">KL4_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL4_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span>	<span class="n">KL4_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL4_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL4_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="n">number</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span>	<span class="n">KL3_IT_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL3_IT_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span>	<span class="n">KL3_IT_PORT_WAKEUP_ENABLE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_RESUME_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">KL3_IT_PORT_CONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">KL3_IT_PORT_DISCONNECT_WAKE_EN</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
				<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_USB0_CELL_ENABLE</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="p">(</span><span class="n">KL0_USB0_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL0_USB0_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
				<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_USB1_CELL_ENABLE</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="p">(</span><span class="n">KL0_USB1_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL0_USB1_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="p">(</span><span class="n">KL1_USB2_PAD_SUSPEND0</span> <span class="o">|</span> <span class="n">KL1_USB2_PAD_SUSPEND1</span><span class="p">));</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_firewire_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_FW_SUPPORTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UN_BIS</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_FW</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">UN_BIC</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">UNI_N_CLOCK_CNTL_FW</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_firewire_cable_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>

	<span class="cm">/* Trick: we allow NULL node */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_HAS_FW_POWER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_FW_SUPPORTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_FW_CABLE_POWER</span> <span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_FW_CABLE_POWER</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KL_GPIO_FW_CABLE_POWER</span> <span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KL_GPIO_FW_CABLE_POWER</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">intrepid_aack_delay_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_rev</span> <span class="o">&lt;</span> <span class="mh">0xd2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span>
		<span class="n">UN_BIS</span><span class="p">(</span><span class="n">UNI_N_AACK_DELAY</span><span class="p">,</span> <span class="n">UNI_N_AACK_DELAY_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">UN_BIC</span><span class="p">(</span><span class="n">UNI_N_AACK_DELAY</span><span class="p">,</span> <span class="n">UNI_N_AACK_DELAY_ENABLE</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_read_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_write_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_POWER4</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_gmac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">K2_FCR1_GMAC_CLK_ENABLE</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">k2_skiplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">k2_skiplist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">K2_FCR1_GMAC_CLK_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_fw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">K2_FCR1_FW_CLK_ENABLE</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">k2_skiplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">k2_skiplist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">K2_FCR1_FW_CLK_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_mpic_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">of_get_parent</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_u3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">is_u3</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;u3&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">strcmp</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;u4&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_u3</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">UN_BIS</span><span class="p">(</span><span class="n">U3_TOGGLE_REG</span><span class="p">,</span> <span class="n">U3_MPIC_RESET</span> <span class="o">|</span> <span class="n">U3_MPIC_OUTPUT_ENABLE</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_eth_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_reset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must not reset the combo PHYs, only the BCM5221 found in</span>
<span class="cm">	 * the iMac G5.</span>
<span class="cm">	 */</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="n">of_get_next_child</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">need_reset</span> <span class="o">=</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="s">&quot;B5221&quot;</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_reset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* PHY reset is GPIO 29, not in device-tree unfortunately */</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">K2_GPIO_EXTINT_0</span> <span class="o">+</span> <span class="mi">29</span><span class="p">,</span>
		   <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span> <span class="o">|</span> <span class="n">KEYLARGO_GPIO_OUTOUT_DATA</span><span class="p">);</span>
	<span class="cm">/* Thankfully, this is now always called at a time when we can</span>
<span class="cm">	 * schedule by sungem.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">K2_GPIO_EXTINT_0</span> <span class="o">+</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_i2s_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Very crude implementation for now */</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cell</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fcrs</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">K2_FCR1_I2S0_CELL_ENABLE</span> <span class="o">|</span>
		  <span class="n">K2_FCR1_I2S0_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">K2_FCR1_I2S0_ENABLE</span><span class="p">,</span>
		  <span class="n">KL3_I2S0_CLK18_ENABLE</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="n">KL0_SCC_A_INTF_ENABLE</span><span class="p">,</span>
		  <span class="n">K2_FCR1_I2S1_CELL_ENABLE</span> <span class="o">|</span>
		  <span class="n">K2_FCR1_I2S1_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">K2_FCR1_I2S1_ENABLE</span><span class="p">,</span>
		  <span class="n">KL3_I2S1_CLK18_ENABLE</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="n">KL0_SCC_B_INTF_ENABLE</span><span class="p">,</span>
		  <span class="n">SH_FCR1_I2S2_CELL_ENABLE</span> <span class="o">|</span>
		  <span class="n">SH_FCR1_I2S2_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">SH_FCR1_I2S2_ENABLE</span><span class="p">,</span>
		  <span class="n">SH_FCR3_I2S2_CLK18_ENABLE</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo2</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_shasta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;i2s-&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">cell</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;a&#39;</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_shasta</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">fcrs</span><span class="p">[</span><span class="n">cell</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">g5_reset_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reset_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">cpus</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo2</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_shasta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">cpus</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/cpus&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span> <span class="n">np</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">np</span> <span class="o">=</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rst</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;soft-reset&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reset_io</span> <span class="o">=</span> <span class="o">*</span><span class="n">rst</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">reset_io</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">LOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">,</span> <span class="n">KEYLARGO_GPIO_OUTPUT_ENABLE</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">reset_io</span><span class="p">);</span>
	<span class="n">UNLOCK</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * This can be called from pmac_smp so isn&#39;t static</span>
<span class="cm"> *</span>
<span class="cm"> * This takes the second CPU off the bus on dual CPU machines</span>
<span class="cm"> * running UP</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">g5_phy_disable_cpu1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_maj</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">UN_OUT</span><span class="p">(</span><span class="n">U3_API_PHY_CONFIG_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

<span class="cp">#ifndef CONFIG_POWER4</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">save_gpio_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">save_gpio_extint</span><span class="p">[</span><span class="n">KEYLARGO_GPIO_EXTINT_CNT</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">save_gpio_normal</span><span class="p">[</span><span class="n">KEYLARGO_GPIO_CNT</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">save_unin_clock_ctl</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">keylargo_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">KL0_USB_REF_SUSPEND</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span><span class="n">KL0_SCCA_ENABLE</span> <span class="o">|</span> <span class="n">KL0_SCCB_ENABLE</span> <span class="o">|</span>
				<span class="n">KL0_SCC_CELL_ENABLE</span> <span class="o">|</span>
				<span class="n">KL0_IRDA_ENABLE</span> <span class="o">|</span> <span class="n">KL0_IRDA_CLK32_ENABLE</span> <span class="o">|</span>
				<span class="n">KL0_IRDA_CLK19_ENABLE</span><span class="p">);</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_MBCR</span><span class="p">,</span> <span class="n">KL_MBCR_MB0_DEV_MASK</span><span class="p">);</span>
	<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_MBCR</span><span class="p">,</span> <span class="n">KL_MBCR_MB0_IDE_ENABLE</span><span class="p">);</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span>
		<span class="n">KL1_AUDIO_SEL_22MCLK</span> <span class="o">|</span> <span class="n">KL1_AUDIO_CLK_ENABLE_BIT</span> <span class="o">|</span>
		<span class="n">KL1_AUDIO_CLK_OUT_ENABLE</span> <span class="o">|</span> <span class="n">KL1_AUDIO_CELL_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_I2S0_CELL_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S0_CLK_ENABLE_BIT</span> <span class="o">|</span>
		<span class="n">KL1_I2S0_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S1_CELL_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_I2S1_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">KL1_I2S1_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_EIDE0_ENABLE</span> <span class="o">|</span> <span class="n">KL1_EIDE0_RESET_N</span> <span class="o">|</span>
		<span class="n">KL1_EIDE1_ENABLE</span> <span class="o">|</span> <span class="n">KL1_EIDE1_RESET_N</span> <span class="o">|</span>
		<span class="n">KL1_UIDE_ENABLE</span><span class="p">);</span>

	<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_ALT_DATA_OUT</span><span class="p">);</span>
	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_IOBUS_ENABLE</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">KL3_SHUTDOWN_PLL2X</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">KL3_SHUTDOWN_PLL_TOTAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">|=</span> <span class="n">KL3_SHUTDOWN_PLLKW6</span> <span class="o">|</span> <span class="n">KL3_SHUTDOWN_PLLKW4</span> <span class="o">|</span>
		<span class="n">KL3_SHUTDOWN_PLLKW35</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">KL3_SHUTDOWN_PLLKW12</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_CLK66_ENABLE</span> <span class="o">|</span> <span class="n">KL3_CLK49_ENABLE</span> <span class="o">|</span> <span class="n">KL3_CLK45_ENABLE</span>
		<span class="o">|</span> <span class="n">KL3_CLK31_ENABLE</span> <span class="o">|</span> <span class="n">KL3_I2S1_CLK18_ENABLE</span> <span class="o">|</span> <span class="n">KL3_I2S0_CLK18_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_TIMER_CLK18_ENABLE</span> <span class="o">|</span> <span class="n">KL3_VIA_CLK16_ENABLE</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Flush posted writes &amp; wait a bit */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pangea_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span><span class="n">KL0_SCCA_ENABLE</span> <span class="o">|</span> <span class="n">KL0_SCCB_ENABLE</span> <span class="o">|</span>
				<span class="n">KL0_SCC_CELL_ENABLE</span> <span class="o">|</span>
				<span class="n">KL0_USB0_CELL_ENABLE</span> <span class="o">|</span> <span class="n">KL0_USB1_CELL_ENABLE</span><span class="p">);</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span>
		<span class="n">KL1_AUDIO_SEL_22MCLK</span> <span class="o">|</span> <span class="n">KL1_AUDIO_CLK_ENABLE_BIT</span> <span class="o">|</span>
		<span class="n">KL1_AUDIO_CLK_OUT_ENABLE</span> <span class="o">|</span> <span class="n">KL1_AUDIO_CELL_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_I2S0_CELL_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S0_CLK_ENABLE_BIT</span> <span class="o">|</span>
		<span class="n">KL1_I2S0_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S1_CELL_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_I2S1_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">KL1_I2S1_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_UIDE_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">)</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_UIDE_RESET_N</span><span class="p">);</span>

	<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">KL2_ALT_DATA_OUT</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">KL3_SHUTDOWN_PLLKW6</span> <span class="o">|</span> <span class="n">KL3_SHUTDOWN_PLLKW4</span> <span class="o">|</span>
		<span class="n">KL3_SHUTDOWN_PLLKW35</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_CLK49_ENABLE</span> <span class="o">|</span> <span class="n">KL3_CLK45_ENABLE</span> <span class="o">|</span> <span class="n">KL3_CLK31_ENABLE</span>
		<span class="o">|</span> <span class="n">KL3_I2S0_CLK18_ENABLE</span> <span class="o">|</span> <span class="n">KL3_I2S1_CLK18_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_VIA_CLK16_ENABLE</span> <span class="o">|</span> <span class="n">KL3_TIMER_CLK18_ENABLE</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Flush posted writes &amp; wait a bit */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intrepid_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sleep_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span><span class="n">KL0_SCCA_ENABLE</span> <span class="o">|</span> <span class="n">KL0_SCCB_ENABLE</span> <span class="o">|</span>
		  <span class="n">KL0_SCC_CELL_ENABLE</span><span class="p">);</span>

	<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span>
		<span class="n">KL1_I2S0_CELL_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S0_CLK_ENABLE_BIT</span> <span class="o">|</span>
		<span class="n">KL1_I2S0_ENABLE</span> <span class="o">|</span> <span class="n">KL1_I2S1_CELL_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_I2S1_CLK_ENABLE_BIT</span> <span class="o">|</span> <span class="n">KL1_I2S1_ENABLE</span> <span class="o">|</span>
		<span class="n">KL1_EIDE0_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">)</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">KL1_UIDE_RESET_N</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_CLK49_ENABLE</span> <span class="o">|</span> <span class="n">KL3_CLK45_ENABLE</span> <span class="o">|</span>
		  <span class="n">KL3_I2S1_CLK18_ENABLE</span> <span class="o">|</span> <span class="n">KL3_I2S0_CLK18_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sleep_mode</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">KL3_TIMER_CLK18_ENABLE</span> <span class="o">|</span> <span class="n">KL3_IT_VIA_CLK32_ENABLE</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Flush posted writes &amp; wait a bit */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">core99_sleep</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* We power off the wireless slot in case it was not done</span>
<span class="cm">	 * by the driver. We don&#39;t power it on automatically however</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_AIRPORT_ON</span><span class="p">)</span>
		<span class="n">core99_airport_enable</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* We power off the FW cable. Should be done by the driver... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MACIO_FLAG_FW_SUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">core99_firewire_enable</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">core99_firewire_cable_power</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We make sure int. modem is off (in case driver lost it) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span><span class="p">)</span>
		<span class="n">core99_modem_enable</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pangea_modem_enable</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* We make sure the sound is off as well */</span>
	<span class="n">core99_sound_chip_enable</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save various bits of KeyLargo</span>
<span class="cm">	 */</span>

	<span class="cm">/* Save the state of the various GPIOs */</span>
	<span class="n">save_gpio_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_LEVELS0</span><span class="p">);</span>
	<span class="n">save_gpio_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_LEVELS1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">KEYLARGO_GPIO_EXTINT_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">save_gpio_extint</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">KEYLARGO_GPIO_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">save_gpio_normal</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Save the FCRs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span><span class="p">)</span>
		<span class="n">save_mbcr</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_MBCR</span><span class="p">);</span>
	<span class="n">save_fcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span>
	<span class="n">save_fcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">);</span>
	<span class="n">save_fcr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span>
	<span class="n">save_fcr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span>
	<span class="n">save_fcr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_pangea</span> <span class="o">||</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="n">save_fcr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR5</span><span class="p">);</span>

	<span class="cm">/* Save state &amp; config of DBDMA channels */</span>
	<span class="n">dbdma_save</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_dbdma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turn off as much as we can</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_pangea</span><span class="p">)</span>
		<span class="n">pangea_shutdown</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="n">intrepid_shutdown</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span><span class="p">)</span>
		<span class="n">keylargo_shutdown</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put the host bridge to sleep</span>
<span class="cm">	 */</span>

	<span class="n">save_unin_clock_ctl</span> <span class="o">=</span> <span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">);</span>
	<span class="cm">/* Note: do not switch GMAC off, driver does it when necessary, WOL must keep it</span>
<span class="cm">	 * enabled !</span>
<span class="cm">	 */</span>
	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">save_unin_clock_ctl</span> <span class="o">&amp;</span>
	       <span class="o">~</span><span class="p">(</span><span class="cm">/*UNI_N_CLOCK_CNTL_GMAC|*/</span><span class="n">UNI_N_CLOCK_CNTL_FW</span><span class="cm">/*|UNI_N_CLOCK_CNTL_PCI*/</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_HWINIT_STATE</span><span class="p">,</span> <span class="n">UNI_N_HWINIT_STATE_SLEEPING</span><span class="p">);</span>
	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_POWER_MGT</span><span class="p">,</span> <span class="n">UNI_N_POWER_MGT_SLEEP</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: A bit of black magic with OpenPIC (don&#39;t ask me why)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_SAWTOOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="mh">0x506e0</span><span class="p">,</span> <span class="mh">0x00400000</span><span class="p">);</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="mh">0x506e0</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">core99_wake_up</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_keylargo</span> <span class="o">&amp;&amp;</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_pangea</span> <span class="o">&amp;&amp;</span>
	    <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">macio_intrepid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wakeup the host bridge</span>
<span class="cm">	 */</span>
	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_POWER_MGT</span><span class="p">,</span> <span class="n">UNI_N_POWER_MGT_NORMAL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_HWINIT_STATE</span><span class="p">,</span> <span class="n">UNI_N_HWINIT_STATE_RUNNING</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore KeyLargo</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_MBCR</span><span class="p">,</span> <span class="n">save_mbcr</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_MBCR</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR0</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR1</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR2</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR3</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR4</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_pangea</span> <span class="o">||</span> <span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_intrepid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_FCR5</span><span class="p">,</span> <span class="n">save_fcr</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">MACIO_IN32</span><span class="p">(</span><span class="n">KEYLARGO_FCR5</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbdma_restore</span><span class="p">(</span><span class="n">macio</span><span class="p">,</span> <span class="n">save_dbdma</span><span class="p">);</span>

	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_LEVELS0</span><span class="p">,</span> <span class="n">save_gpio_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_LEVELS1</span><span class="p">,</span> <span class="n">save_gpio_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">KEYLARGO_GPIO_EXTINT_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_EXTINT_0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">save_gpio_extint</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">KEYLARGO_GPIO_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">MACIO_OUT8</span><span class="p">(</span><span class="n">KEYLARGO_GPIO_0</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">save_gpio_normal</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* FIXME more black magic with OpenPIC ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_SAWTOOTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="mh">0x506e0</span><span class="p">,</span> <span class="mh">0x00400000</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="mh">0x506e0</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_CLOCK_CNTL</span><span class="p">,</span> <span class="n">save_unin_clock_ctl</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">core99_sleep_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Param == 1 means to enter the &quot;fake sleep&quot; mode that is</span>
<span class="cm">	 * used for CPU speed switch</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_HWINIT_STATE</span><span class="p">,</span> <span class="n">UNI_N_HWINIT_STATE_SLEEPING</span><span class="p">);</span>
			<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_POWER_MGT</span><span class="p">,</span> <span class="n">UNI_N_POWER_MGT_IDLE2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_POWER_MGT</span><span class="p">,</span> <span class="n">UNI_N_POWER_MGT_NORMAL</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_HWINIT_STATE</span><span class="p">,</span> <span class="n">UNI_N_HWINIT_STATE_RUNNING</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_CAN_SLEEP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">core99_sleep</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">core99_wake_up</span><span class="p">();</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">generic_dev_can_wake</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Todo: eventually check we are really dealing with on-board</span>
<span class="cm">	 * video device ...</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">&amp;</span> <span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">)</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">|=</span> <span class="n">PMAC_MB_CAN_SLEEP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">generic_get_mb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span> <span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PMAC_MB_INFO_MODEL</span>:
			<span class="k">return</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PMAC_MB_INFO_FLAGS</span>:
			<span class="k">return</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PMAC_MB_INFO_NAME</span>:
			<span class="cm">/* hack hack hack... but should work */</span>
			<span class="o">*</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Table definitions</span>
<span class="cm"> */</span>

<span class="cm">/* Used on any machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">any_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GET_MB_INFO</span><span class="p">,</span>		<span class="n">generic_get_mb_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_DEVICE_CAN_WAKE</span><span class="p">,</span>	<span class="n">generic_dev_can_wake</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#ifndef CONFIG_POWER4</span>

<span class="cm">/* OHare based motherboards. Currently, we only use these on the</span>
<span class="cm"> * 2400,3400 and 3500 series powerbooks. Some older desktops seem</span>
<span class="cm"> * to have issues with turning on/off those asic cells</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">ohare_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">ohare_htw_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span>	<span class="n">ohare_floppy_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MESH_ENABLE</span><span class="p">,</span>		<span class="n">ohare_mesh_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">ohare_ide_enable</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">ohare_ide_reset</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">ohare_sleep_state</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Heathrow desktop machines (Beige G3).</span>
<span class="cm"> * Separated as some features couldn&#39;t be properly tested</span>
<span class="cm"> * and the serial port control bits appear to confuse it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">heathrow_desktop_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_floppy_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MESH_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_mesh_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">heathrow_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_BMAC_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_bmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Heathrow based laptop, that is the Wallstreet and mainstreet</span>
<span class="cm"> * powerbooks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">heathrow_laptop_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">ohare_htw_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_modem_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_floppy_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MESH_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_mesh_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">heathrow_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_BMAC_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_bmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_sound_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">heathrow_sleep_state</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Paddington based machines</span>
<span class="cm"> * The lombard (101) powerbook, first iMac models, B&amp;W G3 and Yikes G4.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">paddington_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">ohare_htw_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_modem_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SWIM3_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_floppy_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MESH_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_mesh_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">heathrow_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_BMAC_ENABLE</span><span class="p">,</span>		<span class="n">heathrow_bmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">heathrow_sound_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">heathrow_sleep_state</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Core99 &amp; MacRISC 2 machines (all machines released since the</span>
<span class="cm"> * iBook (included), that is all AGP machines, except pangea</span>
<span class="cm"> * chipset. The pangea chipset is the &quot;combo&quot; UniNorth/KeyLargo</span>
<span class="cm"> * used on iBook2 &amp; iMac &quot;flow power&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">core99_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">core99_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span>	<span class="n">core99_modem_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">core99_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">core99_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span>		<span class="n">core99_gmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span>	<span class="n">core99_gmac_phy_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">core99_sound_chip_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_AIRPORT_ENABLE</span><span class="p">,</span>	<span class="n">core99_airport_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_USB_ENABLE</span><span class="p">,</span>		<span class="n">core99_usb_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_ENABLE</span><span class="p">,</span>		<span class="n">core99_firewire_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_CABLE_POWER</span><span class="p">,</span>	<span class="n">core99_firewire_cable_power</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">core99_sleep_state</span> <span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_RESET_CPU</span><span class="p">,</span>		<span class="n">core99_reset_cpu</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PMAC_FTR_READ_GPIO</span><span class="p">,</span>		<span class="n">core99_read_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_WRITE_GPIO</span><span class="p">,</span>		<span class="n">core99_write_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* RackMac</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">rackmac_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">core99_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">core99_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">core99_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span>		<span class="n">core99_gmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span>	<span class="n">core99_gmac_phy_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_USB_ENABLE</span><span class="p">,</span>		<span class="n">core99_usb_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_ENABLE</span><span class="p">,</span>		<span class="n">core99_firewire_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_CABLE_POWER</span><span class="p">,</span>	<span class="n">core99_firewire_cable_power</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">core99_sleep_state</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_RESET_CPU</span><span class="p">,</span>		<span class="n">core99_reset_cpu</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PMAC_FTR_READ_GPIO</span><span class="p">,</span>		<span class="n">core99_read_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_WRITE_GPIO</span><span class="p">,</span>		<span class="n">core99_write_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Pangea features</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">pangea_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">core99_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span>	<span class="n">pangea_modem_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">core99_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">core99_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span>		<span class="n">core99_gmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span>	<span class="n">core99_gmac_phy_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">core99_sound_chip_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_AIRPORT_ENABLE</span><span class="p">,</span>	<span class="n">core99_airport_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_USB_ENABLE</span><span class="p">,</span>		<span class="n">core99_usb_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_ENABLE</span><span class="p">,</span>		<span class="n">core99_firewire_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_CABLE_POWER</span><span class="p">,</span>	<span class="n">core99_firewire_cable_power</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">core99_sleep_state</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_READ_GPIO</span><span class="p">,</span>		<span class="n">core99_read_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_WRITE_GPIO</span><span class="p">,</span>		<span class="n">core99_write_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Intrepid features</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">intrepid_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span>		<span class="n">core99_scc_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span>	<span class="n">pangea_modem_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_ENABLE</span><span class="p">,</span>		<span class="n">core99_ide_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_IDE_RESET</span><span class="p">,</span>		<span class="n">core99_ide_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span>		<span class="n">core99_gmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span>	<span class="n">core99_gmac_phy_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">core99_sound_chip_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_AIRPORT_ENABLE</span><span class="p">,</span>	<span class="n">core99_airport_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_USB_ENABLE</span><span class="p">,</span>		<span class="n">core99_usb_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_ENABLE</span><span class="p">,</span>		<span class="n">core99_firewire_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_CABLE_POWER</span><span class="p">,</span>	<span class="n">core99_firewire_cable_power</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SLEEP_STATE</span><span class="p">,</span>		<span class="n">core99_sleep_state</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_READ_GPIO</span><span class="p">,</span>		<span class="n">core99_read_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_WRITE_GPIO</span><span class="p">,</span>		<span class="n">core99_write_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_AACK_DELAY_ENABLE</span><span class="p">,</span>	<span class="n">intrepid_aack_delay_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

<span class="cm">/* G5 features</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">feature_table_entry</span> <span class="n">g5_features</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_ENABLE</span><span class="p">,</span>		<span class="n">g5_gmac_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_1394_ENABLE</span><span class="p">,</span>		<span class="n">g5_fw_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_ENABLE_MPIC</span><span class="p">,</span>		<span class="n">g5_mpic_enable</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_GMAC_PHY_RESET</span><span class="p">,</span>	<span class="n">g5_eth_phy_reset</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>	<span class="n">g5_i2s_enable</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_RESET_CPU</span><span class="p">,</span>		<span class="n">g5_reset_cpu</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PMAC_FTR_READ_GPIO</span><span class="p">,</span>		<span class="n">core99_read_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PMAC_FTR_WRITE_GPIO</span><span class="p">,</span>		<span class="n">core99_write_gpio</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pmac_mb_def</span> <span class="n">pmac_mb_defs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_POWER4</span>
	<span class="cm">/*</span>
<span class="cm">	 * Desktops</span>
<span class="cm">	 */</span>

	<span class="p">{</span>	<span class="s">&quot;AAPL,8500&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac 8500/8600&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PSURGE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,9500&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac 9500/9600&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PSURGE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,7200&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac 7200&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PSURGE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,7300&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac 7200/7300&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PSURGE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,7500&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac 7500&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PSURGE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,ShinerESB&quot;</span><span class="p">,</span>		<span class="s">&quot;Apple Network Server&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_ANS</span><span class="p">,</span>			<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,e407&quot;</span><span class="p">,</span>			<span class="s">&quot;Alchemy&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_ALCHEMY</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,e411&quot;</span><span class="p">,</span>			<span class="s">&quot;Gazelle&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_GAZELLE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,Gossamer&quot;</span><span class="p">,</span>		<span class="s">&quot;PowerMac G3 (Gossamer)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_GOSSAMER</span><span class="p">,</span>		<span class="n">heathrow_desktop_features</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,PowerMac G3&quot;</span><span class="p">,</span>		<span class="s">&quot;PowerMac G3 (Silk)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_SILK</span><span class="p">,</span>			<span class="n">heathrow_desktop_features</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac1,1&quot;</span><span class="p">,</span>			<span class="s">&quot;Blue&amp;White G3&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_YOSEMITE</span><span class="p">,</span>		<span class="n">paddington_features</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac1,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 PCI Graphics&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_YIKES</span><span class="p">,</span>		<span class="n">paddington_features</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac2,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac FireWire&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_FW_IMAC</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac2,2&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac FireWire&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_FW_IMAC</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 AGP Graphics&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_SAWTOOTH</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 AGP Graphics&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_SAWTOOTH</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,3&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 AGP Graphics&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_SAWTOOTH</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,4&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 Silver&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_QUICKSILVER</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,5&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 Silver&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_QUICKSILVER</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac3,6&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 Windtunnel&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_WINDTUNNEL</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac4,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac </span><span class="se">\&quot;</span><span class="s">Flower Power</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PANGEA_IMAC</span><span class="p">,</span>		<span class="n">pangea_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac4,2&quot;</span><span class="p">,</span>			<span class="s">&quot;Flat panel iMac&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_FLAT_PANEL_IMAC</span><span class="p">,</span>	<span class="n">pangea_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac4,4&quot;</span><span class="p">,</span>			<span class="s">&quot;eMac&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_EMAC</span><span class="p">,</span>			<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac5,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G4 Cube&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_CUBE</span><span class="p">,</span>			<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac6,1&quot;</span><span class="p">,</span>			<span class="s">&quot;Flat panel iMac&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac6,3&quot;</span><span class="p">,</span>			<span class="s">&quot;Flat panel iMac&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac6,4&quot;</span><span class="p">,</span>			<span class="s">&quot;eMac&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac10,1&quot;</span><span class="p">,</span>			<span class="s">&quot;Mac mini&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;PowerMac10,2&quot;</span><span class="p">,</span>                 <span class="s">&quot;Mac mini (Late 2005)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>     <span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span><span class="p">,</span>
	<span class="p">},</span>
 	<span class="p">{</span>	<span class="s">&quot;iMac,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac (first generation)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_ORIG_IMAC</span><span class="p">,</span>		<span class="n">paddington_features</span><span class="p">,</span>
		<span class="mi">0</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Xserve&#39;s</span>
<span class="cm">	 */</span>

	<span class="p">{</span>	<span class="s">&quot;RackMac1,1&quot;</span><span class="p">,</span>			<span class="s">&quot;XServe&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_RACKMAC</span><span class="p">,</span>		<span class="n">rackmac_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;RackMac1,2&quot;</span><span class="p">,</span>			<span class="s">&quot;XServe rev. 2&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_RACKMAC</span><span class="p">,</span>		<span class="n">rackmac_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * Laptops</span>
<span class="cm">	 */</span>

	<span class="p">{</span>	<span class="s">&quot;AAPL,3400/2400&quot;</span><span class="p">,</span>		<span class="s">&quot;PowerBook 3400&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_HOOPER</span><span class="p">,</span>		<span class="n">ohare_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,3500&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook 3500&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_KANGA</span><span class="p">,</span>		<span class="n">ohare_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;AAPL,PowerBook1998&quot;</span><span class="p">,</span>		<span class="s">&quot;PowerBook Wallstreet&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_WALLSTREET</span><span class="p">,</span>		<span class="n">heathrow_laptop_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook1,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook 101 (Lombard)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_101_PBOOK</span><span class="p">,</span>		<span class="n">paddington_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook2,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook (first generation)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_ORIG_IBOOK</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_CAN_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_OLD_CORE99</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook2,2&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook FireWire&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_FW_IBOOK</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span>
		<span class="n">PMAC_MB_OLD_CORE99</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook3,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook Pismo&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_PISMO</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span>
		<span class="n">PMAC_MB_OLD_CORE99</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook3,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook Titanium&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_TITANIUM</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook3,3&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook Titanium II&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_TITANIUM2</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook3,4&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook Titanium III&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_TITANIUM3</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook3,5&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook Titanium IV&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_TITANIUM4</span><span class="p">,</span>		<span class="n">core99_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook4,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook 2&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_IBOOK2</span><span class="p">,</span>		<span class="n">pangea_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook4,2&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook 2&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_IBOOK2</span><span class="p">,</span>		<span class="n">pangea_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook4,3&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook 2 rev. 2&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_IBOOK2</span><span class="p">,</span>		<span class="n">pangea_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 17</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 15</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,3&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 17</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,4&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 15</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,5&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 17</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,6&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 15</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,7&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 17</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,8&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 15</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span>  <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook5,9&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 17</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 12</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,3&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook G4&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,4&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 12</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,5&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook G4&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,7&quot;</span><span class="p">,</span>			<span class="s">&quot;iBook G4&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerBook6,8&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerBook G4 12</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">,</span>	<span class="n">intrepid_features</span><span class="p">,</span>
		<span class="n">PMAC_MB_MAY_SLEEP</span> <span class="o">|</span> <span class="n">PMAC_MB_HAS_FW_POWER</span> <span class="o">|</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac7,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G5&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_POWERMAC_G5</span><span class="p">,</span>		<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac7,3&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G5&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_POWERMAC_G5</span><span class="p">,</span>		<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac8,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac G5&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_IMAC_G5</span><span class="p">,</span>		<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac9,1&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G5&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_POWERMAC_G5_U3L</span><span class="p">,</span>	<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac11,2&quot;</span><span class="p">,</span>			<span class="s">&quot;PowerMac G5 Dual Core&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_POWERMAC_G5_U3L</span><span class="p">,</span>	<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="s">&quot;PowerMac12,1&quot;</span><span class="p">,</span>			<span class="s">&quot;iMac G5 (iSight)&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_POWERMAC_G5_U3L</span><span class="p">,</span>	<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>       <span class="s">&quot;RackMac3,1&quot;</span><span class="p">,</span>                   <span class="s">&quot;XServe G5&quot;</span><span class="p">,</span>
		<span class="n">PMAC_TYPE_XSERVE_G5</span><span class="p">,</span>		<span class="n">g5_features</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The toplevel feature_call callback</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">pmac_do_feature_call</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">selector</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">feature_call</span> <span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selector</span> <span class="o">==</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func</span> <span class="o">=</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">any_features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">any_features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selector</span> <span class="o">==</span> <span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func</span> <span class="o">=</span> <span class="n">any_features</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">function</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
	<span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span><span class="o">*</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span><span class="p">);</span>
	<span class="n">param</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">probe_motherboard</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Lookup known motherboard type in device-tree. First try an</span>
<span class="cm">	 * exact match on the &quot;model&quot; property, then try a &quot;compatible&quot;</span>
<span class="cm">	 * match is none is found.</span>
<span class="cm">	 */</span>
	<span class="n">dt</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;device-tree&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pmac_mb_defs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pmac_mb_defs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model_string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmac_mb</span> <span class="o">=</span> <span class="n">pmac_mb_defs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pmac_mb_defs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="n">pmac_mb_defs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model_string</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmac_mb</span> <span class="o">=</span> <span class="n">pmac_mb_defs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fallback to selection depending on mac-io chip type */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">macio</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_POWER4</span>
	    <span class="k">case</span> <span class="n">macio_grand_central</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_PSURGE</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown PowerSurge&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_ohare</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_OHARE</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown OHare-based&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_heathrow</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_HEATHROW</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Heathrow-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">heathrow_desktop_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_paddington</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_PADDINGTON</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Paddington-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">paddington_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_keylargo</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_CORE99</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Keylargo-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">core99_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_pangea</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_PANGEA</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Pangea-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">pangea_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">macio_intrepid</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_INTREPID</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Intrepid-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">intrepid_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>
	<span class="k">case</span> <span class="n">macio_keylargo2</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_K2</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown K2-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">g5_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">macio_shasta</span>:
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_UNKNOWN_SHASTA</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">&quot;Unknown Shasta-based&quot;</span><span class="p">;</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">g5_features</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">found:</span>
<span class="cp">#ifndef CONFIG_POWER4</span>
	<span class="cm">/* Fixup Hooper vs. Comet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_HOOPER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">mach_id_ptr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0xf3000034</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mach_id_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Here, I used to disable the media-bay on comet. It</span>
<span class="cm">		 * appears this is wrong, the floppy connector is actually</span>
<span class="cm">		 * a kind of media-bay and works with the current driver.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__raw_readl</span><span class="p">(</span><span class="n">mach_id_ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20000000UL</span><span class="p">)</span>
			<span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">PMAC_TYPE_COMET</span><span class="p">;</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mach_id_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set default value of powersave_nap on machines that support it.</span>
<span class="cm">	 * It appears that uninorth rev 3 has a problem with it, we don&#39;t</span>
<span class="cm">	 * enable it on those. In theory, the flush-on-lock property is</span>
<span class="cm">	 * supposed to be set when not supported, but I&#39;m not very confident</span>
<span class="cm">	 * that all Apple OF revs did it properly, I do it the paranoid way.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">uninorth_base</span> <span class="o">&amp;&amp;</span> <span class="n">uninorth_rev</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="s">&quot;/cpus&quot;</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpus</span> <span class="o">||</span> <span class="o">!</span><span class="n">cpus</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Can&#39;t find CPU(s) in device tree !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">cpus</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">;</span>
		<span class="cm">/* Nap mode not supported on SMP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">sibling</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Nap mode not supported if flush-on-lock property is present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;flush-on-lock&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">cpus</span><span class="p">);</span>
		<span class="n">powersave_nap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Processor NAP mode on idle enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On CPUs that support it (750FX), lowspeed by default during</span>
<span class="cm">	 * NAP mode</span>
<span class="cm">	 */</span>
	<span class="n">powersave_lowspeed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>
	<span class="n">powersave_nap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif  </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

	<span class="cm">/* Check for &quot;mobile&quot; machine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;PowerBook&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		   <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;iBook&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pmac_mb</span><span class="p">.</span><span class="n">board_flags</span> <span class="o">|=</span> <span class="n">PMAC_MB_MOBILE</span><span class="p">;</span>


	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PowerMac motherboard: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_name</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the Core99 UniNorth host bridge and memory controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">probe_uninorth</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addrp</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">actrl</span><span class="p">;</span>

	<span class="cm">/* Locate core99 Uni-N */</span>
	<span class="n">uninorth_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;uni-n&quot;</span><span class="p">);</span>
	<span class="n">uninorth_maj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Locate G5 u3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uninorth_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;u3&quot;</span><span class="p">);</span>
		<span class="n">uninorth_maj</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Locate G5 u4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uninorth_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;u4&quot;</span><span class="p">);</span>
		<span class="n">uninorth_maj</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uninorth_maj</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">uninorth_node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">address</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">uninorth_node</span><span class="p">,</span> <span class="n">addrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">uninorth_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mh">0x40000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">uninorth_rev</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">UN_REG</span><span class="p">(</span><span class="n">UNI_N_VERSION</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_maj</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">uninorth_maj</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u3_ht_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">U3_HT_CONFIG_BASE</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u3_ht_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">uninorth_base</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Found %s memory controller &amp; host bridge&quot;</span>
	       <span class="s">&quot; @ 0x%08x revision: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uninorth_maj</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">?</span> <span class="s">&quot;U3&quot;</span> <span class="o">:</span>
	       <span class="n">uninorth_maj</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="s">&quot;U4&quot;</span> <span class="o">:</span> <span class="s">&quot;UniNorth&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="n">uninorth_rev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Mapped at 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">uninorth_base</span><span class="p">);</span>

	<span class="cm">/* Set the arbitrer QAck delay according to what Apple does</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uninorth_rev</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">actrl</span> <span class="o">=</span> <span class="n">UN_IN</span><span class="p">(</span><span class="n">UNI_N_ARB_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">UNI_N_ARB_CTRL_QACK_DELAY_MASK</span><span class="p">;</span>
		<span class="n">actrl</span> <span class="o">|=</span> <span class="p">((</span><span class="n">uninorth_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="n">UNI_N_ARB_CTRL_QACK_DELAY105</span> <span class="o">:</span>
			<span class="n">UNI_N_ARB_CTRL_QACK_DELAY</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">UNI_N_ARB_CTRL_QACK_DELAY_SHIFT</span><span class="p">;</span>
		<span class="n">UN_OUT</span><span class="p">(</span><span class="n">UNI_N_ARB_CTRL</span><span class="p">,</span> <span class="n">actrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some more magic as done by them in recent MacOS X on UniNorth</span>
<span class="cm">	 * revs 1.5 to 2.O and Pangea. Seem to toggle the UniN Maxbus/PCI</span>
<span class="cm">	 * memory timeout</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">uninorth_rev</span> <span class="o">&gt;=</span> <span class="mh">0x11</span> <span class="o">&amp;&amp;</span> <span class="n">uninorth_rev</span> <span class="o">&lt;=</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">uninorth_rev</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="n">UN_OUT</span><span class="p">(</span><span class="mh">0x2160</span><span class="p">,</span> <span class="n">UN_IN</span><span class="p">(</span><span class="mh">0x2160</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">probe_one_macio</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">compat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span><span class="o">*</span>	<span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span>		<span class="o">*</span><span class="n">addrp</span><span class="p">,</span> <span class="o">*</span><span class="n">revp</span><span class="p">;</span>
	<span class="n">phys_addr_t</span>		<span class="n">addr</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">compat</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_MACIO_CHIPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span> <span class="o">==</span> <span class="n">node</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_MACIO_CHIPS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac_feature: Please increase MAX_MACIO_CHIPS !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac_feature: %s skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addrp</span> <span class="o">=</span> <span class="n">of_get_pci_address</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac_feature: %s: can&#39;t find base !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">addrp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac_feature: %s, can&#39;t translate base !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pmac_feature: %s, can&#39;t map mac-io chip !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">did</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">did</span> <span class="o">==</span> <span class="mh">0x00000025</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">macio_pangea</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">did</span> <span class="o">==</span> <span class="mh">0x0000003e</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">macio_intrepid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">did</span> <span class="o">==</span> <span class="mh">0x0000004f</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">macio_shasta</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">of_node</span>	<span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span>	<span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span>	<span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">MACIO_FLAG_SCCA_ON</span> <span class="o">|</span> <span class="n">MACIO_FLAG_SCCB_ON</span><span class="p">;</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span>	<span class="o">=</span> <span class="n">macio_names</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">revp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;revision-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">revp</span><span class="p">)</span>
		<span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rev</span> <span class="o">=</span> <span class="o">*</span><span class="n">revp</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Found a %s mac-io controller, rev: %d, mapped at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">macio_names</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rev</span><span class="p">,</span> <span class="n">macio_chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">probe_macios</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Warning, ordering is important */</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;gc&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">macio_grand_central</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;ohare&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">macio_ohare</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;pci106b,7&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">macio_ohareII</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;mac-io&quot;</span><span class="p">,</span> <span class="s">&quot;keylargo&quot;</span><span class="p">,</span> <span class="n">macio_keylargo</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;mac-io&quot;</span><span class="p">,</span> <span class="s">&quot;paddington&quot;</span><span class="p">,</span> <span class="n">macio_paddington</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;mac-io&quot;</span><span class="p">,</span> <span class="s">&quot;gatwick&quot;</span><span class="p">,</span> <span class="n">macio_gatwick</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;mac-io&quot;</span><span class="p">,</span> <span class="s">&quot;heathrow&quot;</span><span class="p">,</span> <span class="n">macio_heathrow</span><span class="p">);</span>
	<span class="n">probe_one_macio</span><span class="p">(</span><span class="s">&quot;mac-io&quot;</span><span class="p">,</span> <span class="s">&quot;K2-Keylargo&quot;</span><span class="p">,</span> <span class="n">macio_keylargo2</span><span class="p">);</span>

	<span class="cm">/* Make sure the &quot;main&quot; macio chip appear first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_gatwick</span>
	    <span class="o">&amp;&amp;</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_heathrow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">macio_chip</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_ohareII</span>
	    <span class="o">&amp;&amp;</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_ohare</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">macio_chip</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lbus</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">lbus</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">initial_serial_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">slot_names_prop</span> <span class="p">{</span>
		<span class="kt">int</span>	<span class="n">count</span><span class="p">;</span>
		<span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">slots</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_type</span> <span class="o">=</span> <span class="n">PMAC_SCC_ASYNC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">slots</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;slot-names&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">conn</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;AAPL,connector&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s">&quot;infrared&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">port_type</span> <span class="o">=</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cobalt&quot;</span><span class="p">))</span>
		<span class="n">modem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">slots</span> <span class="o">&amp;&amp;</span> <span class="n">slots</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">slots</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IrDA&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">port_type</span> <span class="o">=</span> <span class="n">PMAC_SCC_IRDA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">slots</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Modem&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">modem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modem</span><span class="p">)</span>
		<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_MODEM_ENABLE</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_SCC_ENABLE</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">port_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">set_initial_features</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="cm">/* That hack appears to be necessary for some StarMax motherboards</span>
<span class="cm">	 * but I&#39;m not too sure it was audited for side-effects on other</span>
<span class="cm">	 * ohare based machines...</span>
<span class="cm">	 * Since I still have difficulties figuring the right way to</span>
<span class="cm">	 * differenciate them all and since that hack was there for a long</span>
<span class="cm">	 * time, I&#39;ll keep it around</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_ohare</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;via-pmu&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span>
			<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IOBUS_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">MACIO_OUT32</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">STARMAX_FEATURES</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_ohare</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">OHARE_FCR</span><span class="p">,</span> <span class="n">OH_IOBUS_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_POWER4</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo2</span> <span class="o">||</span>
	    <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_shasta</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_SMP</span>
		<span class="cm">/* On SMP machines running UP, we have the second CPU eating</span>
<span class="cm">		 * bus cycles. We need to take it off the bus. This is done</span>
<span class="cm">		 * from pmac_smp for SMP kernels running on one CPU</span>
<span class="cm">		 */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_type</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">g5_phy_disable_cpu1</span><span class="p">();</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
		<span class="cm">/* Enable GMAC for now for PCI probing. It will be disabled</span>
<span class="cm">		 * later on after PCI probe</span>
<span class="cm">		 */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ethernet&quot;</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;K2-GMAC&quot;</span><span class="p">))</span>
				<span class="n">g5_gmac_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ethernet&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable FW before PCI probe. Will be disabled later on</span>
<span class="cm">		 * Note: We should have a batter way to check that we are</span>
<span class="cm">		 * dealing with uninorth internal cell and not a PCI cell</span>
<span class="cm">		 * on the external PCI. The code below works though.</span>
<span class="cm">		 */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;firewire&quot;</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;pci106b,5811&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_FW_SUPPORTED</span><span class="p">;</span>
				<span class="n">g5_fw_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;firewire&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_keylargo</span> <span class="o">||</span>
	    <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_pangea</span> <span class="o">||</span>
	    <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_intrepid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable GMAC for now for PCI probing. It will be disabled</span>
<span class="cm">		 * later on after PCI probe</span>
<span class="cm">		 */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ethernet&quot;</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span>
			    <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;uni-north&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;gmac&quot;</span><span class="p">))</span>
				<span class="n">core99_gmac_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ethernet&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable FW before PCI probe. Will be disabled later on</span>
<span class="cm">		 * Note: We should have a batter way to check that we are</span>
<span class="cm">		 * dealing with uninorth internal cell and not a PCI cell</span>
<span class="cm">		 * on the external PCI. The code below works though.</span>
<span class="cm">		 */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;firewire&quot;</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span>
			    <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;uni-north&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;pci106b,18&quot;</span><span class="p">)</span> <span class="o">||</span>
			        <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;pci106b,30&quot;</span><span class="p">)</span> <span class="o">||</span>
			        <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;pci11c1,5811&quot;</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_FW_SUPPORTED</span><span class="p">;</span>
				<span class="n">core99_firewire_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;firewire&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable ATA-100 before PCI probe. */</span>
		<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ata-6&quot;</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span>
			    <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;uni-north&quot;</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;kauai-ata&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">core99_ata100_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ata-6&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Switch airport off */</span>
		<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;radio&quot;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">==</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MACIO_FLAG_AIRPORT_ON</span><span class="p">;</span>
				<span class="n">core99_airport_enable</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* On all machines that support sound PM, switch sound off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span><span class="p">)</span>
		<span class="n">pmac_do_feature_call</span><span class="p">(</span><span class="n">PMAC_FTR_SOUND_CHIP_ENABLE</span><span class="p">,</span>
			<span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* While on some desktop G3s, we turn it back on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of_node</span> <span class="o">&amp;&amp;</span> <span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">macio_heathrow</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_GOSSAMER</span> <span class="o">||</span>
		    <span class="n">pmac_mb</span><span class="p">.</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">PMAC_TYPE_SILK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">macio_chip</span> <span class="o">*</span><span class="n">macio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">macio_chips</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">MACIO_BIS</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_CLK_ENABLE</span><span class="p">);</span>
		<span class="n">MACIO_BIC</span><span class="p">(</span><span class="n">HEATHROW_FCR</span><span class="p">,</span> <span class="n">HRW_SOUND_POWER_N</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_POWER4 */</span><span class="cp"></span>

	<span class="cm">/* On all machines, switch modem &amp; serial ports off */</span>
	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ch-a&quot;</span><span class="p">)</span>
		<span class="n">initial_serial_shutdown</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">for_each_node_by_name</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ch-b&quot;</span><span class="p">)</span>
		<span class="n">initial_serial_shutdown</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">pmac_feature_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Detect the UniNorth memory controller */</span>
	<span class="n">probe_uninorth</span><span class="p">();</span>

	<span class="cm">/* Probe mac-io controllers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe_macios</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;No mac-io chip found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Probe machine type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe_motherboard</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown PowerMac !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set some initial features (turn off some chips that will</span>
<span class="cm">	 * be later turned on)</span>
<span class="cm">	 */</span>
	<span class="n">set_initial_features</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void dump_HT_speeds(char *name, u32 cfg, u32 frq)</span>
<span class="c">{</span>
<span class="c">	int	freqs[16] = { 200,300,400,500,600,800,1000,0,0,0,0,0,0,0,0,0 };</span>
<span class="c">	int	bits[8] = { 8,16,0,32,2,4,0,0 };</span>
<span class="c">	int	freq = (frq &gt;&gt; 8) &amp; 0xf;</span>

<span class="c">	if (freqs[freq] == 0)</span>
<span class="c">		printk(&quot;%s: Unknown HT link frequency %x\n&quot;, name, freq);</span>
<span class="c">	else</span>
<span class="c">		printk(&quot;%s: %d MHz on main link, (%d in / %d out) bits width\n&quot;,</span>
<span class="c">		       name, freqs[freq],</span>
<span class="c">		       bits[(cfg &gt;&gt; 28) &amp; 0x7], bits[(cfg &gt;&gt; 24) &amp; 0x7]);</span>
<span class="c">}</span>

<span class="c">void __init pmac_check_ht_link(void)</span>
<span class="c">{</span>
<span class="c">	u32	ufreq, freq, ucfg, cfg;</span>
<span class="c">	struct device_node *pcix_node;</span>
<span class="c">	u8	px_bus, px_devfn;</span>
<span class="c">	struct pci_controller *px_hose;</span>

<span class="c">	(void)in_be32(u3_ht_base + U3_HT_LINK_COMMAND);</span>
<span class="c">	ucfg = cfg = in_be32(u3_ht_base + U3_HT_LINK_CONFIG);</span>
<span class="c">	ufreq = freq = in_be32(u3_ht_base + U3_HT_LINK_FREQ);</span>
<span class="c">	dump_HT_speeds(&quot;U3 HyperTransport&quot;, cfg, freq);</span>

<span class="c">	pcix_node = of_find_compatible_node(NULL, &quot;pci&quot;, &quot;pci-x&quot;);</span>
<span class="c">	if (pcix_node == NULL) {</span>
<span class="c">		printk(&quot;No PCI-X bridge found\n&quot;);</span>
<span class="c">		return;</span>
<span class="c">	}</span>
<span class="c">	if (pci_device_from_OF_node(pcix_node, &amp;px_bus, &amp;px_devfn) != 0) {</span>
<span class="c">		printk(&quot;PCI-X bridge found but not matched to pci\n&quot;);</span>
<span class="c">		return;</span>
<span class="c">	}</span>
<span class="c">	px_hose = pci_find_hose_for_OF_device(pcix_node);</span>
<span class="c">	if (px_hose == NULL) {</span>
<span class="c">		printk(&quot;PCI-X bridge found but not matched to host\n&quot;);</span>
<span class="c">		return;</span>
<span class="c">	}	</span>
<span class="c">	early_read_config_dword(px_hose, px_bus, px_devfn, 0xc4, &amp;cfg);</span>
<span class="c">	early_read_config_dword(px_hose, px_bus, px_devfn, 0xcc, &amp;freq);</span>
<span class="c">	dump_HT_speeds(&quot;PCI-X HT Uplink&quot;, cfg, freq);</span>
<span class="c">	early_read_config_dword(px_hose, px_bus, px_devfn, 0xc8, &amp;cfg);</span>
<span class="c">	early_read_config_dword(px_hose, px_bus, px_devfn, 0xd0, &amp;freq);</span>
<span class="c">	dump_HT_speeds(&quot;PCI-X HT Downlink&quot;, cfg, freq);</span>
<span class="c">}</span>
<span class="cp">#endif /* 0 */</span>

<span class="cm">/*</span>
<span class="cm"> * Early video resume hook</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pmac_early_vresume_proc</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pmac_early_vresume_data</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">pmac_set_early_video_resume</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">proc</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">pmac_early_vresume_proc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
	<span class="n">pmac_early_vresume_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pmac_set_early_video_resume</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmac_call_early_video_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_early_vresume_proc</span><span class="p">)</span>
		<span class="n">pmac_early_vresume_proc</span><span class="p">(</span><span class="n">pmac_early_vresume_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AGP related suspend/resume code</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pmac_agp_bridge</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pmac_agp_suspend</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">pmac_agp_resume</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmac_register_agp_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">),</span>
				 <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">bridge</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">suspend</span> <span class="o">||</span> <span class="n">resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmac_agp_bridge</span> <span class="o">=</span> <span class="n">bridge</span><span class="p">;</span>
		<span class="n">pmac_agp_suspend</span> <span class="o">=</span> <span class="n">suspend</span><span class="p">;</span>
		<span class="n">pmac_agp_resume</span> <span class="o">=</span> <span class="n">resume</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bridge</span> <span class="o">!=</span> <span class="n">pmac_agp_bridge</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pmac_agp_suspend</span> <span class="o">=</span> <span class="n">pmac_agp_resume</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pmac_register_agp_pm</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmac_suspend_agp_for_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_agp_bridge</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pmac_agp_suspend</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_agp_bridge</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pmac_agp_suspend</span><span class="p">(</span><span class="n">pmac_agp_bridge</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pmac_suspend_agp_for_card</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">pmac_resume_agp_for_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_agp_bridge</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pmac_agp_resume</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_agp_bridge</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pmac_agp_resume</span><span class="p">(</span><span class="n">pmac_agp_bridge</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pmac_resume_agp_for_card</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">pmac_get_uninorth_variant</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">uninorth_maj</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
