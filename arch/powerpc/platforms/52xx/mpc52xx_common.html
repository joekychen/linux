<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › 52xx › mpc52xx_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mpc52xx_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Utility functions for the Freescale MPC52xx.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Sylvain Munaut &lt;tnt@246tNt.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/of_gpio.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/mpc52xx.h&gt;</span>

<span class="cm">/* MPC5200 device tree match tables */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_xlb_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-xlb&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-xlb&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_bus_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-immr&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200b-immr&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;simple-bus&quot;</span><span class="p">,</span> <span class="p">},</span>

	<span class="cm">/* depreciated matches; shouldn&#39;t be used in new device trees */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,lpb&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;builtin&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* efika */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;soc&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* lite5200 */</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This variable is mapped in mpc52xx_map_wdt() and used in mpc52xx_restart().</span>
<span class="cm"> * Permanent mapping is required because mpc52xx_restart() can be called</span>
<span class="cm"> * from interrupt context while node mapping (which calls ioremap())</span>
<span class="cm"> * cannot be used at such point.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">mpc52xx_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc52xx_gpt</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mpc52xx_wdt</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc52xx_cdm</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mpc52xx_cdm</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the XLB arbiter settings to match what Linux expects.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">mpc5200_setup_xlb_arbiter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_xlb</span>  <span class="n">__iomem</span> <span class="o">*</span><span class="n">xlb</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_xlb_ids</span><span class="p">);</span>
	<span class="n">xlb</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xlb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">__FILE__</span> <span class="s">&quot;: &quot;</span>
			<span class="s">&quot;Error mapping XLB in mpc52xx_setup_cpu(). &quot;</span>
			<span class="s">&quot;Expect some abnormal behavior</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure the XLB Arbiter priorities */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xlb</span><span class="o">-&gt;</span><span class="n">master_pri_enable</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xlb</span><span class="o">-&gt;</span><span class="n">master_priority</span><span class="p">,</span> <span class="mh">0x11111111</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable XLB pipelining</span>
<span class="cm">	 * (cfr errate 292. We could do this only just before ATA PIO</span>
<span class="cm">	 *  transaction and re-enable it afterwards ...)</span>
<span class="cm">	 * Not needed on MPC5200B.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SVR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC5200_SVR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MPC5200_SVR</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xlb</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xlb</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">|</span> <span class="n">MPC52xx_XLB_CFG_PLDIS</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">xlb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This variable is mapped in mpc52xx_map_common_devices and</span>
<span class="cm"> * used in mpc5200_psc_ac97_gpio_reset().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">gpio_lock</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">mpc52xx_gpio</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">simple_gpio</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">mpc52xx_gpio_wkup</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wkup_gpio</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_declare_of_platform_devices: register internal devices and children</span>
<span class="cm"> *					of the localplus bus to the of_platform</span>
<span class="cm"> *					bus.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpc52xx_declare_of_platform_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Find all the &#39;platform&#39; devices and register them. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_platform_populate</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_bus_ids</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">__FILE__</span> <span class="s">&quot;: Error while populating devices from DT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * match tables used by mpc52xx_map_common_devices()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_gpt_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-gpt&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-gpt&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* old */</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_cdm_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-cdm&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-cdm&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* old */</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_gpio_simple</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-gpio&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_gpio_wkup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-gpio-wkup&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * mpc52xx_map_common_devices: iomap devices required by common code</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">mpc52xx_map_common_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="cm">/* mpc52xx_wdt is mapped here and used in mpc52xx_restart,</span>
<span class="cm">	 * possibly from a interrupt context. wdt is only implement</span>
<span class="cm">	 * on a gpt0, so check has-wdt property before mapping.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_matching_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">mpc52xx_gpt_ids</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;fsl,has-wdt&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;has-wdt&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mpc52xx_wdt</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clock Distribution Module, used by PSC clock setting function */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_cdm_ids</span><span class="p">);</span>
	<span class="n">mpc52xx_cdm</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="cm">/* simple_gpio registers */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_gpio_simple</span><span class="p">);</span>
	<span class="n">simple_gpio</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="cm">/* wkup_gpio registers */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_gpio_wkup</span><span class="p">);</span>
	<span class="n">wkup_gpio</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_set_psc_clkdiv: Set clock divider in the CDM for PSC ports</span>
<span class="cm"> *</span>
<span class="cm"> * @psc_id: id of psc port; must be 1,2,3 or 6</span>
<span class="cm"> * @clkdiv: clock divider value to put into CDM PSC register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mpc52xx_set_psc_clkdiv</span><span class="p">(</span><span class="kt">int</span> <span class="n">psc_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clkdiv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mclken_div</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc52xx_cdm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mclken_div</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="p">(</span><span class="n">clkdiv</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">psc_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">mclken_div_psc1</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">mclken_div_psc2</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">mclken_div_psc3</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">mclken_div_psc6</span><span class="p">;</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the rate and enable the clock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">mclken_div</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">clk_enables</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">clk_enables</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpc52xx_set_psc_clkdiv</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_get_xtal_freq - Get SYS_XTAL_IN frequency for a device</span>
<span class="cm"> *</span>
<span class="cm"> * @node: device node</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the frequency of the external oscillator clock connected</span>
<span class="cm"> * to the SYS_XTAL_IN pin, or 0 if it cannot be determined.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpc52xx_get_xtal_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc52xx_cdm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="n">mpc5xxx_get_bus_frequency</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">ipb_clk_sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">val</span>  <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_cdm</span><span class="o">-&gt;</span><span class="n">rstcfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span>
		<span class="n">freq</span> <span class="o">*=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">freq</span> <span class="o">/=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">/=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpc52xx_get_xtal_freq</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_restart: ppc_md-&gt;restart hook for mpc5200 using the watchdog timer</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mpc52xx_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="cm">/* Turn on the watchdog and wait for it to expire.</span>
<span class="cm">	 * It effectively does a reset. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc52xx_wdt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_wdt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_wdt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mh">0x000000ff</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpc52xx_wdt</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="mh">0x00009004</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">__FILE__</span> <span class="s">&quot;: &quot;</span>
			<span class="s">&quot;mpc52xx_restart: Can&#39;t access wdt. &quot;</span>
			<span class="s">&quot;Restart impossible, system halted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PSC1_RESET     0x1</span>
<span class="cp">#define PSC1_SYNC      0x4</span>
<span class="cp">#define PSC1_SDATA_OUT 0x1</span>
<span class="cp">#define PSC2_RESET     0x2</span>
<span class="cp">#define PSC2_SYNC      (0x4&lt;&lt;4)</span>
<span class="cp">#define PSC2_SDATA_OUT (0x1&lt;&lt;4)</span>
<span class="cp">#define MPC52xx_GPIO_PSC1_MASK 0x7</span>
<span class="cp">#define MPC52xx_GPIO_PSC2_MASK (0x7&lt;&lt;4)</span>

<span class="cm">/**</span>
<span class="cm"> * mpc5200_psc_ac97_gpio_reset: Use gpio pins to reset the ac97 bus</span>
<span class="cm"> *</span>
<span class="cm"> * @psc: psc number to reset (only psc 1 and 2 support ac97)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mpc5200_psc_ac97_gpio_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">psc_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mux</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sync</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">simple_gpio</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">wkup_gpio</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psc_number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reset</span>   <span class="o">=</span> <span class="n">PSC1_RESET</span><span class="p">;</span>           <span class="cm">/* AC97_1_RES */</span>
		<span class="n">sync</span>    <span class="o">=</span> <span class="n">PSC1_SYNC</span><span class="p">;</span>            <span class="cm">/* AC97_1_SYNC */</span>
		<span class="n">out</span>     <span class="o">=</span> <span class="n">PSC1_SDATA_OUT</span><span class="p">;</span>       <span class="cm">/* AC97_1_SDATA_OUT */</span>
		<span class="n">gpio</span>    <span class="o">=</span> <span class="n">MPC52xx_GPIO_PSC1_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reset</span>   <span class="o">=</span> <span class="n">PSC2_RESET</span><span class="p">;</span>           <span class="cm">/* AC97_2_RES */</span>
		<span class="n">sync</span>    <span class="o">=</span> <span class="n">PSC2_SYNC</span><span class="p">;</span>            <span class="cm">/* AC97_2_SYNC */</span>
		<span class="n">out</span>     <span class="o">=</span> <span class="n">PSC2_SDATA_OUT</span><span class="p">;</span>       <span class="cm">/* AC97_2_SDATA_OUT */</span>
		<span class="n">gpio</span>    <span class="o">=</span> <span class="n">MPC52xx_GPIO_PSC2_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="n">__FILE__</span> <span class="s">&quot;: Unable to determine PSC, no ac97 &quot;</span>
		       <span class="s">&quot;cold-reset will be performed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reconfiure pin-muxing to gpio */</span>
	<span class="n">mux</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">port_config</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">port_config</span><span class="p">,</span> <span class="n">mux</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">gpio</span><span class="p">));</span>

	<span class="cm">/* enable gpio pins for output */</span>
	<span class="n">setbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkup_gpio</span><span class="o">-&gt;</span><span class="n">wkup_gpioe</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">simple_gpioe</span><span class="p">,</span> <span class="n">sync</span> <span class="o">|</span> <span class="n">out</span><span class="p">);</span>

	<span class="n">setbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkup_gpio</span><span class="o">-&gt;</span><span class="n">wkup_ddr</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">simple_ddr</span><span class="p">,</span> <span class="n">sync</span> <span class="o">|</span> <span class="n">out</span><span class="p">);</span>

	<span class="cm">/* Assert cold reset */</span>
	<span class="n">clrbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">simple_dvo</span><span class="p">,</span> <span class="n">sync</span> <span class="o">|</span> <span class="n">out</span><span class="p">);</span>
	<span class="n">clrbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkup_gpio</span><span class="o">-&gt;</span><span class="n">wkup_dvo</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>

	<span class="cm">/* wait for 1 us */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Deassert reset */</span>
	<span class="n">setbits8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkup_gpio</span><span class="o">-&gt;</span><span class="n">wkup_dvo</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>

	<span class="cm">/* wait at least 200ns */</span>
	<span class="cm">/* 7 ~= (200ns * timebase) / ns2sec */</span>
	<span class="n">__delay</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* Restore pin-muxing */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">simple_gpio</span><span class="o">-&gt;</span><span class="n">port_config</span><span class="p">,</span> <span class="n">mux</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">mpc5200_psc_ac97_gpio_reset</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
