<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › 52xx › mpc52xx_pic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mpc52xx_pic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Programmable Interrupt Controller functions for the Freescale MPC52xx.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Secret Lab Technologies Ltd.</span>
<span class="cm"> * Copyright (C) 2006 bplan GmbH</span>
<span class="cm"> * Copyright (C) 2004 Sylvain Munaut &lt;tnt@246tNt.com&gt;</span>
<span class="cm"> * Copyright (C) 2003 Montavista Software, Inc</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the code from the 2.4 kernel by</span>
<span class="cm"> * Dale Farnsworth &lt;dfarnsworth@mvista.com&gt; and Kent Borg.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This is the device driver for the MPC5200 interrupt controller.</span>
<span class="cm"> *</span>
<span class="cm"> * hardware overview</span>
<span class="cm"> * -----------------</span>
<span class="cm"> * The MPC5200 interrupt controller groups the all interrupt sources into</span>
<span class="cm"> * three groups called &#39;critical&#39;, &#39;main&#39;, and &#39;peripheral&#39;.  The critical</span>
<span class="cm"> * group has 3 irqs, External IRQ0, slice timer 0 irq, and wake from deep</span>
<span class="cm"> * sleep.  Main group include the other 3 external IRQs, slice timer 1, RTC,</span>
<span class="cm"> * gpios, and the general purpose timers.  Peripheral group contains the</span>
<span class="cm"> * remaining irq sources from all of the on-chip peripherals (PSCs, Ethernet,</span>
<span class="cm"> * USB, DMA, etc).</span>
<span class="cm"> *</span>
<span class="cm"> * virqs</span>
<span class="cm"> * -----</span>
<span class="cm"> * The Linux IRQ subsystem requires that each irq source be assigned a</span>
<span class="cm"> * system wide unique IRQ number starting at 1 (0 means no irq).  Since</span>
<span class="cm"> * systems can have multiple interrupt controllers, the virtual IRQ (virq)</span>
<span class="cm"> * infrastructure lets each interrupt controller to define a local set</span>
<span class="cm"> * of IRQ numbers and the virq infrastructure maps those numbers into</span>
<span class="cm"> * a unique range of the global IRQ# space.</span>
<span class="cm"> *</span>
<span class="cm"> * To define a range of virq numbers for this controller, this driver first</span>
<span class="cm"> * assigns a number to each of the irq groups (called the level 1 or L1</span>
<span class="cm"> * value).  Within each group individual irq sources are also assigned a</span>
<span class="cm"> * number, as defined by the MPC5200 user guide, and refers to it as the</span>
<span class="cm"> * level 2 or L2 value.  The virq number is determined by shifting up the</span>
<span class="cm"> * L1 value by MPC52xx_IRQ_L1_OFFSET and ORing it with the L2 value.</span>
<span class="cm"> *</span>
<span class="cm"> * For example, the TMR0 interrupt is irq 9 in the main group.  The</span>
<span class="cm"> * virq for TMR0 is calculated by ((1 &lt;&lt; MPC52xx_IRQ_L1_OFFSET) | 9).</span>
<span class="cm"> *</span>
<span class="cm"> * The observant reader will also notice that this driver defines a 4th</span>
<span class="cm"> * interrupt group called &#39;bestcomm&#39;.  The bestcomm group isn&#39;t physically</span>
<span class="cm"> * part of the MPC5200 interrupt controller, but it is used here to assign</span>
<span class="cm"> * a separate virq number for each bestcomm task (since any of the 16</span>
<span class="cm"> * bestcomm tasks can cause the bestcomm interrupt to be raised).  When a</span>
<span class="cm"> * bestcomm interrupt occurs (peripheral group, irq 0) this driver determines</span>
<span class="cm"> * which task needs servicing and returns the irq number for that task.  This</span>
<span class="cm"> * allows drivers which use bestcomm to define their own interrupt handlers.</span>
<span class="cm"> *</span>
<span class="cm"> * irq_chip structures</span>
<span class="cm"> * -------------------</span>
<span class="cm"> * For actually manipulating IRQs (masking, enabling, clearing, etc) this</span>
<span class="cm"> * driver defines four separate &#39;irq_chip&#39; structures, one for the main</span>
<span class="cm"> * group, one for the peripherals group, one for the bestcomm group and one</span>
<span class="cm"> * for external interrupts.  The irq_chip structures provide the hooks needed</span>
<span class="cm"> * to manipulate each IRQ source, and since each group is has a separate set</span>
<span class="cm"> * of registers for controlling the irq, it makes sense to divide up the</span>
<span class="cm"> * hooks along those lines.</span>
<span class="cm"> *</span>
<span class="cm"> * You&#39;ll notice that there is not an irq_chip for the critical group and</span>
<span class="cm"> * you&#39;ll also notice that there is an irq_chip defined for external</span>
<span class="cm"> * interrupts even though there is no external interrupt group.  The reason</span>
<span class="cm"> * for this is that the four external interrupts are all managed with the same</span>
<span class="cm"> * register even though one of the external IRQs is in the critical group and</span>
<span class="cm"> * the other three are in the main group.  For this reason it makes sense for</span>
<span class="cm"> * the 4 external irqs to be managed using a separate set of hooks.  The</span>
<span class="cm"> * reason there is no crit irq_chip is that of the 3 irqs in the critical</span>
<span class="cm"> * group, only external interrupt is actually support at this time by this</span>
<span class="cm"> * driver and since external interrupt is the only one used, it can just</span>
<span class="cm"> * be directed to make use of the external irq irq_chip.</span>
<span class="cm"> *</span>
<span class="cm"> * device tree bindings</span>
<span class="cm"> * --------------------</span>
<span class="cm"> * The device tree bindings for this controller reflect the two level</span>
<span class="cm"> * organization of irqs in the device.  #interrupt-cells = &lt;3&gt; where the</span>
<span class="cm"> * first cell is the group number [0..3], the second cell is the irq</span>
<span class="cm"> * number in the group, and the third cell is the sense type (level/edge).</span>
<span class="cm"> * For reference, the following is a list of the interrupt property values</span>
<span class="cm"> * associated with external interrupt sources on the MPC5200 (just because</span>
<span class="cm"> * it is non-obvious to determine what the interrupts property should be</span>
<span class="cm"> * when reading the mpc5200 manual and it is a frequently asked question).</span>
<span class="cm"> *</span>
<span class="cm"> * External interrupts:</span>
<span class="cm"> * &lt;0 0 n&gt;	external irq0, n is sense	(n=0: level high,</span>
<span class="cm"> * &lt;1 1 n&gt;	external irq1, n is sense	 n=1: edge rising,</span>
<span class="cm"> * &lt;1 2 n&gt;	external irq2, n is sense	 n=2: edge falling,</span>
<span class="cm"> * &lt;1 3 n&gt;	external irq3, n is sense	 n=3: level low)</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/mpc52xx.h&gt;</span>

<span class="cm">/* HW IRQ mapping */</span>
<span class="cp">#define MPC52xx_IRQ_L1_CRIT	(0)</span>
<span class="cp">#define MPC52xx_IRQ_L1_MAIN	(1)</span>
<span class="cp">#define MPC52xx_IRQ_L1_PERP	(2)</span>
<span class="cp">#define MPC52xx_IRQ_L1_SDMA	(3)</span>

<span class="cp">#define MPC52xx_IRQ_L1_OFFSET	(6)</span>
<span class="cp">#define MPC52xx_IRQ_L1_MASK	(0x00c0)</span>
<span class="cp">#define MPC52xx_IRQ_L2_MASK	(0x003f)</span>

<span class="cp">#define MPC52xx_IRQ_HIGHTESTHWIRQ (0xd0)</span>


<span class="cm">/* MPC5200 device tree match tables */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_pic_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-pic&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-pic&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_sdma_ids</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-bestcomm&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-bestcomm&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc52xx_intr</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">intr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc52xx_sdma</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sdma</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">mpc52xx_irqhost</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mpc52xx_map_senses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>
	<span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>
	<span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">,</span>
	<span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Utility functions */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">io_be_setbit</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitno</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">io_be_clrbit</span><span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitno</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ[0-3] interrupt irq_chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_extirq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_clrbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">11</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_extirq_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_setbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">11</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_extirq_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_setbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">27</span><span class="o">-</span><span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_extirq_set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: irq=%x. l2=%d flow_type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">l2irq</span><span class="p">,</span> <span class="n">flow_type</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flow_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQF_TRIGGER_HIGH</span>: <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQF_TRIGGER_RISING</span>: <span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQF_TRIGGER_FALLING</span>: <span class="n">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IRQF_TRIGGER_LOW</span>: <span class="n">type</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">22</span> <span class="o">-</span> <span class="p">(</span><span class="n">l2irq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">22</span> <span class="o">-</span> <span class="p">(</span><span class="n">l2irq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">ctrl_reg</span><span class="p">);</span>

	<span class="n">__irq_set_handler_locked</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpc52xx_extirq_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPC52xx External&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">mpc52xx_extirq_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">mpc52xx_extirq_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span> <span class="o">=</span> <span class="n">mpc52xx_extirq_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span> <span class="o">=</span> <span class="n">mpc52xx_extirq_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Main interrupt irq_chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_null_set_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Do nothing so that the sense mask will get updated */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_main_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_setbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">main_mask</span><span class="p">,</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_main_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_clrbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">main_mask</span><span class="p">,</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpc52xx_main_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPC52xx Main&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">mpc52xx_main_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span> <span class="o">=</span> <span class="n">mpc52xx_main_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">mpc52xx_main_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span> <span class="o">=</span> <span class="n">mpc52xx_null_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Peripherals interrupt irq_chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_periph_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_setbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_mask</span><span class="p">,</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_periph_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_clrbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_mask</span><span class="p">,</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpc52xx_periph_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPC52xx Peripherals&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">mpc52xx_periph_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask_ack</span> <span class="o">=</span> <span class="n">mpc52xx_periph_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">mpc52xx_periph_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span> <span class="o">=</span> <span class="n">mpc52xx_null_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * SDMA interrupt irq_chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_sdma_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_setbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_sdma_unmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">io_be_clrbit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpc52xx_sdma_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l2irq</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntPend</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">l2irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpc52xx_sdma_irqchip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MPC52xx SDMA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">mpc52xx_sdma_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span> <span class="o">=</span> <span class="n">mpc52xx_sdma_unmask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_ack</span> <span class="o">=</span> <span class="n">mpc52xx_sdma_ack</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span> <span class="o">=</span> <span class="n">mpc52xx_null_set_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_is_extirq - Returns true if hwirq number is for an external IRQ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_is_extirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">l1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">l1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">((</span><span class="n">l1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_irqhost_xlate - translate virq# from device tree interrupts property</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_irqhost_xlate</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">intspec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intsize</span><span class="p">,</span>
				 <span class="n">irq_hw_number_t</span> <span class="o">*</span><span class="n">out_hwirq</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">intrvect_l1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intrvect_l2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intrvect_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">intrvect_linux</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intsize</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">intrvect_l1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">intrvect_l2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">intspec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">intrvect_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">intspec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">intrvect_linux</span> <span class="o">=</span> <span class="p">(</span><span class="n">intrvect_l1</span> <span class="o">&lt;&lt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">MPC52xx_IRQ_L1_MASK</span><span class="p">;</span>
	<span class="n">intrvect_linux</span> <span class="o">|=</span> <span class="n">intrvect_l2</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>

	<span class="o">*</span><span class="n">out_hwirq</span> <span class="o">=</span> <span class="n">intrvect_linux</span><span class="p">;</span>
	<span class="o">*</span><span class="n">out_flags</span> <span class="o">=</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc52xx_is_extirq</span><span class="p">(</span><span class="n">intrvect_l1</span><span class="p">,</span> <span class="n">intrvect_l2</span><span class="p">))</span>
		<span class="o">*</span><span class="n">out_flags</span> <span class="o">=</span> <span class="n">mpc52xx_map_senses</span><span class="p">[</span><span class="n">intrvect_type</span><span class="p">];</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;return %x, l1=%d, l2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intrvect_linux</span><span class="p">,</span> <span class="n">intrvect_l1</span><span class="p">,</span>
		 <span class="n">intrvect_l2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_irqhost_map - Hook to map from virq to an irq_chip structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpc52xx_irqhost_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">,</span>
			       <span class="n">irq_hw_number_t</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l1irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">irqchip</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hndlr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">l1irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L1_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">;</span>
	<span class="n">l2irq</span> <span class="o">=</span> <span class="n">irq</span> <span class="o">&amp;</span> <span class="n">MPC52xx_IRQ_L2_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * External IRQs are handled differently by the hardware so they are</span>
<span class="cm">	 * handled by a dedicated irq_chip structure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpc52xx_is_extirq</span><span class="p">(</span><span class="n">l1irq</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">mpc52xx_map_senses</span><span class="p">[(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">22</span> <span class="o">-</span> <span class="n">l2irq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">))</span>
			<span class="n">hndlr</span> <span class="o">=</span> <span class="n">handle_edge_irq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hndlr</span> <span class="o">=</span> <span class="n">handle_level_irq</span><span class="p">;</span>

		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc52xx_extirq_irqchip</span><span class="p">,</span> <span class="n">hndlr</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: External IRQ%i virq=%x, hw=%x. type=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">irq</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It is an internal SOC irq.  Choose the correct irq_chip */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">l1irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MPC52xx_IRQ_L1_MAIN</span>: <span class="n">irqchip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_main_irqchip</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPC52xx_IRQ_L1_PERP</span>: <span class="n">irqchip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_periph_irqchip</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MPC52xx_IRQ_L1_SDMA</span>: <span class="n">irqchip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_sdma_irqchip</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid irq: virq=%i, l1=%i, l2=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">l1irq</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">irqchip</span><span class="p">,</span> <span class="n">handle_level_irq</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: virq=%x, l1=%i, l2=%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">l1irq</span><span class="p">,</span> <span class="n">l2irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">irq_domain_ops</span> <span class="n">mpc52xx_irqhost_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xlate</span> <span class="o">=</span> <span class="n">mpc52xx_irqhost_xlate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">mpc52xx_irqhost_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_init_irq - Initialize and register with the virq subsystem</span>
<span class="cm"> *</span>
<span class="cm"> * Hook for setting up IRQs on an mpc5200 system.  A pointer to this function</span>
<span class="cm"> * is to be put into the machine definition structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This function searches the device tree for an MPC5200 interrupt controller,</span>
<span class="cm"> * initializes it, and registers it with the virq subsystem.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpc52xx_init_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">picnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="cm">/* Remap the necessary zones */</span>
	<span class="n">picnode</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_pic_ids</span><span class="p">);</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">picnode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">__FILE__</span>	<span class="s">&quot;: find_and_map failed on &#39;mpc5200-pic&#39;. &quot;</span>
				<span class="s">&quot;Check node !&quot;</span><span class="p">);</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpc52xx_sdma_ids</span><span class="p">);</span>
	<span class="n">sdma</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">__FILE__</span>	<span class="s">&quot;: find_and_map failed on &#39;mpc5200-bestcomm&#39;. &quot;</span>
				<span class="s">&quot;Check node !&quot;</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;MPC5200 IRQ controller mapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

	<span class="cm">/* Disable all interrupt sources. */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntPend</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>	<span class="cm">/* 1 means clear pending */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntMask</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>	<span class="cm">/* 1 means disabled */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_mask</span><span class="p">,</span> <span class="mh">0x7ffffc00</span><span class="p">);</span>	<span class="cm">/* 1 means disabled */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">main_mask</span><span class="p">,</span> <span class="mh">0x00010fff</span><span class="p">);</span>	<span class="cm">/* 1 means disabled */</span>
	<span class="n">intr_ctrl</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">intr_ctrl</span> <span class="o">&amp;=</span> <span class="mh">0x00ff0000</span><span class="p">;</span>	<span class="cm">/* Keeps IRQ[0-3] config */</span>
	<span class="n">intr_ctrl</span> <span class="o">|=</span>	<span class="mh">0x0f000000</span> <span class="o">|</span>	<span class="cm">/* clear IRQ 0-3 */</span>
			<span class="mh">0x00001000</span> <span class="o">|</span>	<span class="cm">/* MEE master external enable */</span>
			<span class="mh">0x00000000</span> <span class="o">|</span>	<span class="cm">/* 0 means disable IRQ 0-3 */</span>
			<span class="mh">0x00000001</span><span class="p">;</span>	<span class="cm">/* CEb route critical normally */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">intr_ctrl</span><span class="p">);</span>

	<span class="cm">/* Zero a bunch of the priority settings. */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_pri1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_pri2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">per_pri3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">main_pri1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">main_pri2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * As last step, add an irq host to translate the real</span>
<span class="cm">	 * hw irq information provided by the ofw to linux virq</span>
<span class="cm">	 */</span>
	<span class="n">mpc52xx_irqhost</span> <span class="o">=</span> <span class="n">irq_domain_add_linear</span><span class="p">(</span><span class="n">picnode</span><span class="p">,</span>
	                                 <span class="n">MPC52xx_IRQ_HIGHTESTHWIRQ</span><span class="p">,</span>
	                                 <span class="o">&amp;</span><span class="n">mpc52xx_irqhost_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc52xx_irqhost</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="n">__FILE__</span> <span class="s">&quot;: Cannot allocate the IRQ host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">irq_set_default_host</span><span class="p">(</span><span class="n">mpc52xx_irqhost</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;MPC52xx PIC is up and running!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mpc52xx_get_irq - Get pending interrupt number hook function</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the interrupt handler to determine what IRQ handler needs to be</span>
<span class="cm"> * executed.</span>
<span class="cm"> *</span>
<span class="cm"> * Status of pending interrupts is determined by reading the encoded status</span>
<span class="cm"> * register.  The encoded status register has three fields; one for each of the</span>
<span class="cm"> * types of interrupts defined by the controller - &#39;critical&#39;, &#39;main&#39; and</span>
<span class="cm"> * &#39;peripheral&#39;.  This function reads the status register and returns the IRQ</span>
<span class="cm"> * number associated with the highest priority pending interrupt.  &#39;Critical&#39;</span>
<span class="cm"> * interrupts have the highest priority, followed by &#39;main&#39; interrupts, and</span>
<span class="cm"> * then &#39;peripheral&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> * The mpc5200 interrupt controller can be configured to boost the priority</span>
<span class="cm"> * of individual &#39;peripheral&#39; interrupts.  If this is the case then a special</span>
<span class="cm"> * value will appear in either the crit or main fields indicating a high</span>
<span class="cm"> * or medium priority peripheral irq has occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks each of the 3 irq request fields and returns the</span>
<span class="cm"> * first pending interrupt that it finds.</span>
<span class="cm"> *</span>
<span class="cm"> * This function also identifies a 4th type of interrupt; &#39;bestcomm&#39;.  Each</span>
<span class="cm"> * bestcomm DMA task can raise the bestcomm peripheral interrupt.  When this</span>
<span class="cm"> * occurs at task-specific IRQ# is decoded so that each task can have its</span>
<span class="cm"> * own IRQ handler.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpc52xx_get_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="o">-&gt;</span><span class="n">enc_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x00000400</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* critical */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* high priority peripheral */</span>
			<span class="k">goto</span> <span class="n">peripheral</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPC52xx_IRQ_L1_CRIT</span> <span class="o">&lt;&lt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x00200000</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* main */</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* low priority peripheral */</span>
			<span class="k">goto</span> <span class="n">peripheral</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPC52xx_IRQ_L1_MAIN</span> <span class="o">&lt;&lt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* peripheral */</span>
	      <span class="nl">peripheral:</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* bestcomm */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdma</span><span class="o">-&gt;</span><span class="n">IntPend</span><span class="p">);</span>
			<span class="n">irq</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">irq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPC52xx_IRQ_L1_SDMA</span> <span class="o">&lt;&lt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">irq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MPC52xx_IRQ_L1_PERP</span> <span class="o">&lt;&lt;</span> <span class="n">MPC52xx_IRQ_L1_OFFSET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">irq_linear_revmap</span><span class="p">(</span><span class="n">mpc52xx_irqhost</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
