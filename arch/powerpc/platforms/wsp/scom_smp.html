<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › platforms › wsp › scom_smp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>scom_smp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SCOM support for A2 platforms</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007-2011 Benjamin Herrenschmidt, David Gibson,</span>
<span class="cm"> *		       Michael Ellerman, IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;asm/cputhreads.h&gt;</span>
<span class="cp">#include &lt;asm/reg_a2.h&gt;</span>
<span class="cp">#include &lt;asm/scom.h&gt;</span>
<span class="cp">#include &lt;asm/udbg.h&gt;</span>

<span class="cp">#include &quot;wsp.h&quot;</span>

<span class="cp">#define SCOM_RAMC		0x2a		</span><span class="cm">/* Ram Command */</span><span class="cp"></span>
<span class="cp">#define SCOM_RAMC_TGT1_EXT	0x80000000</span>
<span class="cp">#define SCOM_RAMC_SRC1_EXT	0x40000000</span>
<span class="cp">#define SCOM_RAMC_SRC2_EXT	0x20000000</span>
<span class="cp">#define SCOM_RAMC_SRC3_EXT	0x10000000</span>
<span class="cp">#define SCOM_RAMC_ENABLE	0x00080000</span>
<span class="cp">#define SCOM_RAMC_THREADSEL	0x00060000</span>
<span class="cp">#define SCOM_RAMC_EXECUTE	0x00010000</span>
<span class="cp">#define SCOM_RAMC_MSR_OVERRIDE	0x00008000</span>
<span class="cp">#define SCOM_RAMC_MSR_PR	0x00004000</span>
<span class="cp">#define SCOM_RAMC_MSR_GS	0x00002000</span>
<span class="cp">#define SCOM_RAMC_FORCE		0x00001000</span>
<span class="cp">#define SCOM_RAMC_FLUSH		0x00000800</span>
<span class="cp">#define SCOM_RAMC_INTERRUPT	0x00000004</span>
<span class="cp">#define SCOM_RAMC_ERROR		0x00000002</span>
<span class="cp">#define SCOM_RAMC_DONE		0x00000001</span>
<span class="cp">#define SCOM_RAMI		0x29		</span><span class="cm">/* Ram Instruction */</span><span class="cp"></span>
<span class="cp">#define SCOM_RAMIC		0x28		</span><span class="cm">/* Ram Instruction and Command */</span><span class="cp"></span>
<span class="cp">#define SCOM_RAMIC_INSN		0xffffffff00000000</span>
<span class="cp">#define SCOM_RAMD		0x2d		</span><span class="cm">/* Ram Data */</span><span class="cp"></span>
<span class="cp">#define SCOM_RAMDH		0x2e		</span><span class="cm">/* Ram Data High */</span><span class="cp"></span>
<span class="cp">#define SCOM_RAMDL		0x2f		</span><span class="cm">/* Ram Data Low */</span><span class="cp"></span>
<span class="cp">#define SCOM_PCCR0		0x33		</span><span class="cm">/* PC Configuration Register 0 */</span><span class="cp"></span>
<span class="cp">#define SCOM_PCCR0_ENABLE_DEBUG	0x80000000</span>
<span class="cp">#define SCOM_PCCR0_ENABLE_RAM	0x40000000</span>
<span class="cp">#define SCOM_THRCTL		0x30		</span><span class="cm">/* Thread Control and Status */</span><span class="cp"></span>
<span class="cp">#define SCOM_THRCTL_T0_STOP	0x80000000</span>
<span class="cp">#define SCOM_THRCTL_T1_STOP	0x40000000</span>
<span class="cp">#define SCOM_THRCTL_T2_STOP	0x20000000</span>
<span class="cp">#define SCOM_THRCTL_T3_STOP	0x10000000</span>
<span class="cp">#define SCOM_THRCTL_T0_STEP	0x08000000</span>
<span class="cp">#define SCOM_THRCTL_T1_STEP	0x04000000</span>
<span class="cp">#define SCOM_THRCTL_T2_STEP	0x02000000</span>
<span class="cp">#define SCOM_THRCTL_T3_STEP	0x01000000</span>
<span class="cp">#define SCOM_THRCTL_T0_RUN	0x00800000</span>
<span class="cp">#define SCOM_THRCTL_T1_RUN	0x00400000</span>
<span class="cp">#define SCOM_THRCTL_T2_RUN	0x00200000</span>
<span class="cp">#define SCOM_THRCTL_T3_RUN	0x00100000</span>
<span class="cp">#define SCOM_THRCTL_T0_PM	0x00080000</span>
<span class="cp">#define SCOM_THRCTL_T1_PM	0x00040000</span>
<span class="cp">#define SCOM_THRCTL_T2_PM	0x00020000</span>
<span class="cp">#define SCOM_THRCTL_T3_PM	0x00010000</span>
<span class="cp">#define SCOM_THRCTL_T0_UDE	0x00008000</span>
<span class="cp">#define SCOM_THRCTL_T1_UDE	0x00004000</span>
<span class="cp">#define SCOM_THRCTL_T2_UDE	0x00002000</span>
<span class="cp">#define SCOM_THRCTL_T3_UDE	0x00001000</span>
<span class="cp">#define SCOM_THRCTL_ASYNC_DIS	0x00000800</span>
<span class="cp">#define SCOM_THRCTL_TB_DIS	0x00000400</span>
<span class="cp">#define SCOM_THRCTL_DEC_DIS	0x00000200</span>
<span class="cp">#define SCOM_THRCTL_AND		0x31		</span><span class="cm">/* Thread Control and Status */</span><span class="cp"></span>
<span class="cp">#define SCOM_THRCTL_OR		0x32		</span><span class="cm">/* Thread Control and Status */</span><span class="cp"></span>


<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="n">scom_map_t</span><span class="p">,</span> <span class="n">scom_ptrs</span><span class="p">);</span>

<span class="k">static</span> <span class="n">scom_map_t</span> <span class="nf">get_scom</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">first_thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scom_map_t</span> <span class="n">scom</span> <span class="o">=</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">scom_ptrs</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tcpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scom_map_ok</span><span class="p">(</span><span class="n">scom</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">first_thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">scom</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">first_thread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">scom</span> <span class="o">=</span> <span class="n">scom_map_device</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tcpu</span> <span class="o">=</span> <span class="n">cpu_first_thread_sibling</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	     <span class="n">tcpu</span> <span class="o">&lt;=</span> <span class="n">cpu_last_thread_sibling</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span> <span class="n">tcpu</span><span class="o">++</span><span class="p">)</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">scom_ptrs</span><span class="p">,</span> <span class="n">tcpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">scom</span><span class="p">;</span>

	<span class="cm">/* Hack: for the boot core, this will actually get called on</span>
<span class="cm">	 * the second thread up, not the first so our test above will</span>
<span class="cm">	 * set first_thread incorrectly. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_first_thread_sibling</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">first_thread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scom</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_ram</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">u32</span> <span class="n">insn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">insn</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">extmask</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="kr">thread</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCOM_RAMC_ENABLE</span> <span class="o">|</span> <span class="n">SCOM_RAMC_EXECUTE</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">SCOM_RAMC_DONE</span> <span class="o">|</span> <span class="n">SCOM_RAMC_INTERRUPT</span> <span class="o">|</span> <span class="n">SCOM_RAMC_ERROR</span><span class="p">;</span>

	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_RAMIC</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">scom_read</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_RAMC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;Waiting on RAMC = 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RAMC timeout on instruction 0x%08x, thread %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">insn</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SCOM_RAMC_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RAMC interrupt on instruction 0x%08x, thread %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">insn</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">SCOM_RAMC_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SCOM_RAMC_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RAMC error on instruction 0x%08x, thread %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">insn</span><span class="p">,</span> <span class="kr">thread</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">SCOM_RAMC_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_getgpr</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alt</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="o">*</span><span class="n">out_gpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* or rN, rN, rN */</span>
	<span class="n">u32</span> <span class="n">insn</span> <span class="o">=</span> <span class="mh">0x7c000378</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">alt</span> <span class="o">?</span> <span class="mh">0xf</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="o">*</span><span class="n">out_gpr</span> <span class="o">=</span> <span class="n">scom_read</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_RAMD</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_getspr</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">out_spr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">sprhi</span><span class="p">,</span> <span class="n">sprlo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">insn</span><span class="p">;</span>

	<span class="n">sprhi</span> <span class="o">=</span> <span class="n">spr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">sprlo</span> <span class="o">=</span> <span class="n">spr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">insn</span> <span class="o">=</span> <span class="mh">0x7c2002a6</span> <span class="o">|</span> <span class="p">(</span><span class="n">sprlo</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sprhi</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span> <span class="cm">/* mfspr r1,spr */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spr</span> <span class="o">==</span> <span class="mh">0x0ff0</span><span class="p">)</span>
		<span class="n">insn</span> <span class="o">=</span> <span class="mh">0x7c2000a6</span><span class="p">;</span> <span class="cm">/* mfmsr r1 */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">a2_scom_getgpr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out_spr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_setgpr</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">alt</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lis</span> <span class="o">=</span> <span class="mh">0x3c000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">li</span> <span class="o">=</span> <span class="mh">0x38000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">oris</span> <span class="o">=</span> <span class="mh">0x64000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ori</span> <span class="o">=</span> <span class="mh">0x60000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rldicr32</span> <span class="o">=</span> <span class="mh">0x780007c6</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">highest</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">higher</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">low</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lext</span> <span class="o">=</span> <span class="n">alt</span> <span class="o">?</span> <span class="mh">0x8</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oext</span> <span class="o">=</span> <span class="n">alt</span> <span class="o">?</span> <span class="mh">0xf</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highest</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">lis</span> <span class="o">|</span> <span class="n">highest</span><span class="p">,</span> <span class="n">lext</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">higher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">highest</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">oris</span> <span class="o">|</span> <span class="n">higher</span><span class="p">,</span> <span class="n">oext</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">li</span> <span class="o">|</span> <span class="n">higher</span><span class="p">,</span> <span class="n">lext</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highest</span> <span class="o">||</span> <span class="n">higher</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">rldicr32</span><span class="p">,</span> <span class="n">oext</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">high</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">highest</span> <span class="o">||</span> <span class="n">higher</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">oris</span> <span class="o">|</span> <span class="n">high</span><span class="p">,</span> <span class="n">oext</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">lis</span> <span class="o">|</span> <span class="n">high</span><span class="p">,</span> <span class="n">lext</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highest</span> <span class="o">||</span> <span class="n">higher</span> <span class="o">||</span> <span class="n">high</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">ori</span> <span class="o">|</span> <span class="n">low</span><span class="p">,</span> <span class="n">oext</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">li</span> <span class="o">|</span> <span class="n">low</span><span class="p">,</span> <span class="n">lext</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_setspr</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sprhi</span> <span class="o">=</span> <span class="n">spr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sprlo</span> <span class="o">=</span> <span class="n">spr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="cm">/* mtspr spr, r1 */</span>
	<span class="n">u32</span> <span class="n">insn</span> <span class="o">=</span> <span class="mh">0x7c2003a6</span> <span class="o">|</span> <span class="p">(</span><span class="n">sprlo</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sprhi</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spr</span> <span class="o">==</span> <span class="mh">0x0ff0</span><span class="p">)</span>
		<span class="n">insn</span> <span class="o">=</span> <span class="mh">0x7c200124</span><span class="p">;</span> <span class="cm">/* mtmsr r1 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a2_scom_setgpr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">a2_scom_initial_tlb</span><span class="p">(</span><span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">,</span> <span class="kt">int</span> <span class="kr">thread</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="n">u32</span> <span class="n">a2_tlbinit_code_start</span><span class="p">[],</span> <span class="n">a2_tlbinit_code_end</span><span class="p">[];</span>
	<span class="k">extern</span> <span class="n">u32</span> <span class="n">a2_tlbinit_after_iprot_flush</span><span class="p">[];</span>
	<span class="k">extern</span> <span class="n">u32</span> <span class="n">a2_tlbinit_after_linear_map</span><span class="p">[];</span>
	<span class="n">u32</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">epn</span><span class="p">,</span> <span class="n">tlbcfg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Invalidate all entries (including iprot) */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_TLB0CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlbcfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">scom_fail</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">tlbcfg</span> <span class="o">&amp;</span> <span class="n">TLBnCFG_N_ENTRY</span><span class="p">;</span>
	<span class="n">assoc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlbcfg</span> <span class="o">&amp;</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">epn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set MMUCR2 to enable 4K, 64K, 1M, 16M and 1G pages */</span>
	<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MMUCR2</span><span class="p">,</span> <span class="mh">0x000a7531</span><span class="p">);</span>
	<span class="cm">/* Set MMUCR3 to write all thids bit to the TLB */</span>
	<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MMUCR3</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">);</span>

	<span class="cm">/* Set MAS1 for 1G page size, and MAS2 to our initial EPN */</span>
	<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS1</span><span class="p">,</span> <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_1GB</span><span class="p">));</span>
	<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS2</span><span class="p">,</span> <span class="n">epn</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS0</span><span class="p">,</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">assoc</span><span class="p">));</span>

		<span class="cm">/* tlbwe */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mh">0x7c0007a4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">scom_fail</span><span class="p">;</span>

		<span class="cm">/* Next entry is new address? */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">assoc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">epn</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">);</span>
			<span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS2</span><span class="p">,</span> <span class="n">epn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup args for linear mapping */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_setgpr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">scom_fail</span><span class="p">;</span>

	<span class="cm">/* Linear mapping */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">a2_tlbinit_code_start</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">a2_tlbinit_after_linear_map</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">scom_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the boot thread, between the linear mapping and the debug</span>
<span class="cm">	 * mappings there is a loop to flush iprot mappings. Ramming doesn&#39;t do</span>
<span class="cm">	 * branches, but the secondary threads don&#39;t need to be nearly as smart</span>
<span class="cm">	 * (i.e. we don&#39;t need to worry about invalidating the mapping we&#39;re</span>
<span class="cm">	 * standing on).</span>
<span class="cm">	 */</span>

	<span class="cm">/* Debug mappings. Expects r11 = MAS0 from linear map (set above) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">a2_tlbinit_after_iprot_flush</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">a2_tlbinit_code_end</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">scom_fail</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">scom_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Setting up initial TLB failed, err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">SCOM_RAMC_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Interrupt, dump some status */</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">u64</span> <span class="n">iar</span><span class="p">,</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">srr1</span><span class="p">,</span> <span class="n">esr</span><span class="p">,</span> <span class="n">mas0</span><span class="p">,</span> <span class="n">mas1</span><span class="p">,</span> <span class="n">mas2</span><span class="p">,</span> <span class="n">mas7_3</span><span class="p">,</span> <span class="n">mas8</span><span class="p">,</span> <span class="n">ccr2</span><span class="p">;</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_IAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iar</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_SRR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srr0</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_SRR1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srr1</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_ESR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esr</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas0</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas1</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas2</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS7_MAS3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas7_3</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_MAS8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mas8</span><span class="p">);</span>
		<span class="n">rc</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="kr">thread</span><span class="p">,</span> <span class="n">SPRN_A2_CCR2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccr2</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; -&gt; retreived IAR =0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iar</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived SRR0=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived SRR1=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srr1</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived ESR =0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">esr</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived MAS0=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mas0</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived MAS1=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mas1</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived MAS2=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mas2</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived MS73=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mas7_3</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived MAS8=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mas8</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;    retreived CCR2=0x%llx (err %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccr2</span><span class="p">,</span> <span class="n">rc</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">a2_scom_startup_cpu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">thr_idx</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">init_iar</span><span class="p">,</span> <span class="n">init_msr</span><span class="p">,</span> <span class="n">init_ccr2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_here</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">core_setup</span><span class="p">;</span>
	<span class="n">scom_map_t</span> <span class="n">scom</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pccr0</span><span class="p">;</span>

	<span class="n">scom</span> <span class="o">=</span> <span class="n">get_scom</span><span class="p">(</span><span class="n">lcpu</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">core_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t map SCOM for CPU%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;Bringing up CPU%d using SCOM...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcpu</span><span class="p">);</span>

	<span class="n">pccr0</span> <span class="o">=</span> <span class="n">scom_read</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_PCCR0</span><span class="p">);</span>
	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_PCCR0</span><span class="p">,</span> <span class="n">pccr0</span> <span class="o">|</span> <span class="n">SCOM_PCCR0_ENABLE_DEBUG</span> <span class="o">|</span>
				     <span class="n">SCOM_PCCR0_ENABLE_RAM</span><span class="p">);</span>

	<span class="cm">/* Stop the thead with THRCTL. If we are setting up the TLB we stop all</span>
<span class="cm">	 * threads. We also disable asynchronous interrupts while RAMing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core_setup</span><span class="p">)</span>
		<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_THRCTL_OR</span><span class="p">,</span>
			      <span class="n">SCOM_THRCTL_T0_STOP</span> <span class="o">|</span>
			      <span class="n">SCOM_THRCTL_T1_STOP</span> <span class="o">|</span>
			      <span class="n">SCOM_THRCTL_T2_STOP</span> <span class="o">|</span>
			      <span class="n">SCOM_THRCTL_T3_STOP</span> <span class="o">|</span>
			      <span class="n">SCOM_THRCTL_ASYNC_DIS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_THRCTL_OR</span><span class="p">,</span> <span class="n">SCOM_THRCTL_T0_STOP</span> <span class="o">&gt;&gt;</span> <span class="n">thr_idx</span><span class="p">);</span>

	<span class="cm">/* Flush its pipeline just in case */</span>
	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_RAMC</span><span class="p">,</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">thr_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">SCOM_RAMC_FLUSH</span> <span class="o">|</span> <span class="n">SCOM_RAMC_ENABLE</span><span class="p">);</span>

	<span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="n">SPRN_IAR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_iar</span><span class="p">);</span>
	<span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mh">0x0ff0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_msr</span><span class="p">);</span>
	<span class="n">a2_scom_getspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="n">SPRN_A2_CCR2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">init_ccr2</span><span class="p">);</span>

	<span class="cm">/* Set MSR to MSR_CM (0x0ff0 is magic value for MSR_CM) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mh">0x0ff0</span><span class="p">,</span> <span class="n">MSR_CM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to set MSR ! err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RAM in an sync/isync for the sake of it */</span>
	<span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mh">0x7c0004ac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">a2_scom_ram</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mh">0x4c00012c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;CPU%d is first thread in core, initializing TLB...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">lcpu</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">a2_scom_initial_tlb</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start_here</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">core_setup</span> <span class="o">?</span> <span class="n">generic_secondary_smp_init</span>
					<span class="o">:</span> <span class="n">generic_secondary_thread_init</span><span class="p">);</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;CPU%d entry point at 0x%lx...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcpu</span><span class="p">,</span> <span class="n">start_here</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="n">SPRN_IAR</span><span class="p">,</span> <span class="n">start_here</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_setgpr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">lcpu</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Tell book3e_secondary_core_init not to set up the TLB, we&#39;ve</span>
<span class="cm">	 * already done that.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_setgpr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">|=</span> <span class="n">a2_scom_setspr</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">thr_idx</span><span class="p">,</span> <span class="n">SPRN_TENS</span><span class="p">,</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">thr_idx</span><span class="p">);</span>

	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_RAMC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_THRCTL_AND</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">SCOM_THRCTL_T0_STOP</span> <span class="o">&gt;&gt;</span> <span class="n">thr_idx</span><span class="p">));</span>
	<span class="n">scom_write</span><span class="p">(</span><span class="n">scom</span><span class="p">,</span> <span class="n">SCOM_PCCR0</span><span class="p">,</span> <span class="n">pccr0</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">pr_devel</span><span class="p">(</span><span class="s">&quot;  SCOM initialization %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;succeeded&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Old IAR=0x%08llx MSR=0x%08llx CCR2=0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">init_iar</span><span class="p">,</span> <span class="n">init_msr</span><span class="p">,</span> <span class="n">init_ccr2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
