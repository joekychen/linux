<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › boot › wrapper

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wrapper</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>Copyright (C) 2006 Paul Mackerras, IBM Corporation <a href="&#x6D;&#97;&#105;&#x6C;&#116;&#x6F;:&#x70;&#97;&#117;&#x6C;u&#x73;&#64;&#115;&#x61;mb&#97;&#x2E;&#111;&#x72;&#x67;">&#x70;&#97;&#117;&#x6C;u&#x73;&#64;&#115;&#x61;mb&#97;&#x2E;&#111;&#x72;&#x67;</a>
This program may be used under the terms of version 2 of the GNU
General Public License.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div></td><td class="code"><div class="highlight shebang"><pre><span>#!/bin/sh

</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This script takes a kernel binary and optionally an initrd image
and/or a device-tree blob, and creates a bootable zImage for a
given platform.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Options:
-o zImage    specify output file
-p platform    specify platform (links in $platform.o)
-i initrd    specify initrd file
-d devtree    specify device-tree blob
-s tree.dts    specify device-tree source file (needs dtc installed)
-c        cache $kernel.strip.gz (use if present &amp; newer, else make)
-C prefix    specify command prefix for cross-building tools
    (strip, objcopy, ld)
-D dir    specify directory containing data files used by script
    (default ./arch/powerpc/boot)
-W dir    specify working directory for temporary files (default .)</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Stop execution if any command fails</p></td><td class="code"><div class="highlight"><pre><span class="nb">set</span> -e</pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Allow for verbose output</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$V&quot;</span> <span class="o">=</span> 1 <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">set</span> -x
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>defaults</p></td><td class="code"><div class="highlight"><pre><span class="nv">kernel</span><span class="o">=</span>
<span class="nv">ofile</span><span class="o">=</span>zImage
<span class="nv">platform</span><span class="o">=</span>of
<span class="nv">initrd</span><span class="o">=</span>
<span class="nv">dtb</span><span class="o">=</span>
<span class="nv">dts</span><span class="o">=</span>
<span class="nv">cacheit</span><span class="o">=</span>
<span class="nv">binary</span><span class="o">=</span>
<span class="nv">gzip</span><span class="o">=</span>.gz
<span class="nv">pie</span><span class="o">=</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>cross-compilation prefix</p></td><td class="code"><div class="highlight"><pre><span class="nv">CROSS</span><span class="o">=</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>mkimage wrapper script</p></td><td class="code"><div class="highlight"><pre><span class="nv">MKIMAGE</span><span class="o">=</span><span class="nv">$srctree</span>/scripts/mkuboot.sh</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>directory for object and other files used by this script</p></td><td class="code"><div class="highlight"><pre><span class="nv">object</span><span class="o">=</span>arch/powerpc/boot
<span class="nv">objbin</span><span class="o">=</span><span class="nv">$object</span>
<span class="nv">dtc</span><span class="o">=</span>scripts/dtc/dtc</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>directory for working files</p></td><td class="code"><div class="highlight"><pre><span class="nv">tmpdir</span><span class="o">=</span>.

usage<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s1">&#39;Usage: wrapper [-o output] [-p platform] [-i initrd]&#39;</span> &gt;&amp;2
    <span class="nb">echo</span> <span class="s1">&#39;       [-d devtree] [-s tree.dts] [-c] [-C cross-prefix]&#39;</span> &gt;&amp;2
    <span class="nb">echo</span> <span class="s1">&#39;       [-D datadir] [-W workingdir] [--no-gzip] [vmlinux]&#39;</span> &gt;&amp;2
    <span class="nb">exit </span>1
<span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span>; <span class="k">do</span>
<span class="k">    case</span> <span class="s2">&quot;$1&quot;</span> in
    -o<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">ofile</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -p<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">platform</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -i<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">initrd</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -d<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">dtb</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -s<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">dts</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -c<span class="o">)</span>
	<span class="nv">cacheit</span><span class="o">=</span>y
	;;
    -C<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">CROSS</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -D<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">object</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	<span class="nv">objbin</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    -W<span class="o">)</span>
	<span class="nb">shift</span>
	<span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -gt 0 <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">tmpdir</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    --no-gzip<span class="o">)</span>
        <span class="nv">gzip</span><span class="o">=</span>
        ;;
    -?<span class="o">)</span>
	usage
	;;
    *<span class="o">)</span>
	<span class="o">[</span> -z <span class="s2">&quot;$kernel&quot;</span> <span class="o">]</span> <span class="o">||</span> usage
	<span class="nv">kernel</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
	;;
    <span class="k">esac</span>
<span class="k">    </span><span class="nb">shift</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$dts&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[</span> ! -r <span class="s2">&quot;$dts&quot;</span> -a -r <span class="s2">&quot;$object/dts/$dts&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">dts</span><span class="o">=</span><span class="s2">&quot;$object/dts/$dts&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -z <span class="s2">&quot;$dtb&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">dtb</span><span class="o">=</span><span class="s2">&quot;$platform.dtb&quot;</span>
    <span class="k">fi</span>
    <span class="nv">$dtc</span> -O dtb -o <span class="s2">&quot;$dtb&quot;</span> -b 0 <span class="s2">&quot;$dts&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$kernel&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">kernel</span><span class="o">=</span>vmlinux
<span class="k">fi</span>

<span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/<span class="s2">&quot;$platform&quot;</span>.o
<span class="nv">lds</span><span class="o">=</span><span class="nv">$object</span>/zImage.lds
<span class="nv">ext</span><span class="o">=</span>strip
<span class="nv">objflags</span><span class="o">=</span>-S
<span class="nv">tmp</span><span class="o">=</span><span class="nv">$tmpdir</span>/zImage.<span class="nv">$$</span>.o
<span class="nv">ksection</span><span class="o">=</span>.kernel:vmlinux.strip
<span class="nv">isection</span><span class="o">=</span>.kernel:initrd
<span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x400000&#39;</span>
<span class="nv">make_space</span><span class="o">=</span>y

<span class="k">case</span> <span class="s2">&quot;$platform&quot;</span> in
pseries<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/of.o
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x4000000&#39;</span>
    ;;
maple<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/of.o
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x400000&#39;</span>
    ;;
pmac|chrp<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/of.o
    ;;
coff<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/crt0.o $object/of.o&quot;</span>
    <span class="nv">lds</span><span class="o">=</span><span class="nv">$object</span>/zImage.coff.lds
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x500000&#39;</span>
    <span class="nv">pie</span><span class="o">=</span>
    ;;
miboot|uboot*<span class="o">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>miboot and U-boot want just the bare bits, not an ELF binary</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">ext</span><span class="o">=</span>bin
    <span class="nv">objflags</span><span class="o">=</span><span class="s2">&quot;-O binary&quot;</span>
    <span class="nv">tmp</span><span class="o">=</span><span class="s2">&quot;$ofile&quot;</span>
    <span class="nv">ksection</span><span class="o">=</span>image
    <span class="nv">isection</span><span class="o">=</span>initrd
    ;;
cuboot*<span class="o">)</span>
    <span class="nv">binary</span><span class="o">=</span>y
    <span class="nv">gzip</span><span class="o">=</span>
    <span class="k">case</span> <span class="s2">&quot;$platform&quot;</span> in
    *-mpc866ads|*-mpc885ads|*-adder875*|*-ep88xc<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-8xx.o
        ;;
    *5200*|*-motionpro<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-52xx.o
        ;;
    *-pq2fads|*-ep8248e|*-mpc8272*|*-storcenter<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-pq2.o
        ;;
    *-mpc824*<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-824x.o
        ;;
    *-mpc83*|*-asp834x*<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-83xx.o
        ;;
    *-tqm8541|*-mpc8560*|*-tqm8560|*-tqm8555|*-ksi8560*<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-85xx-cpm2.o
        ;;
    *-mpc85*|*-tqm85*|*-sbc85*<span class="o">)</span>
        <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-85xx.o
        ;;
    *-amigaone<span class="o">)</span>
        <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x800000&#39;</span>
        ;;
    <span class="k">esac</span>
    ;;
ps3<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/ps3-head.o $object/ps3-hvcall.o $object/ps3.o&quot;</span>
    <span class="nv">lds</span><span class="o">=</span><span class="nv">$object</span>/zImage.ps3.lds
    <span class="nv">gzip</span><span class="o">=</span>
    <span class="nv">ext</span><span class="o">=</span>bin
    <span class="nv">objflags</span><span class="o">=</span><span class="s2">&quot;-O binary --set-section-flags=.bss=contents,alloc,load,data&quot;</span>
    <span class="nv">ksection</span><span class="o">=</span>.kernel:vmlinux.bin
    <span class="nv">isection</span><span class="o">=</span>.kernel:initrd
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="nv">make_space</span><span class="o">=</span>n
    <span class="nv">pie</span><span class="o">=</span>
    ;;
ep88xc|ep405|ep8248e<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/fixed-head.o $object/$platform.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
adder875-redboot<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/fixed-head.o $object/redboot-8xx.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
simpleboot-virtex405-*<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/virtex405-head.o $object/simpleboot.o $object/virtex.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
simpleboot-virtex440-*<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/fixed-head.o $object/simpleboot.o $object/virtex.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
simpleboot-*<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/fixed-head.o $object/simpleboot.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
asp834x-redboot<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/fixed-head.o $object/redboot-83xx.o&quot;</span>
    <span class="nv">binary</span><span class="o">=</span>y
    ;;
xpedite52*<span class="o">)</span>
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x1400000&#39;</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="nv">$object</span>/cuboot-85xx.o
    ;;
gamecube|wii<span class="o">)</span>
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x600000&#39;</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/$platform-head.o $object/$platform.o&quot;</span>
    ;;
treeboot-currituck<span class="o">)</span>
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x1000000&#39;</span>
    ;;
treeboot-iss4xx-mpic<span class="o">)</span>
    <span class="nv">platformo</span><span class="o">=</span><span class="s2">&quot;$object/treeboot-iss4xx.o&quot;</span>
    ;;
epapr<span class="o">)</span>
    <span class="nv">link_address</span><span class="o">=</span><span class="s1">&#39;0x20000000&#39;</span>
    <span class="nv">pie</span><span class="o">=</span>-pie
    ;;
<span class="k">esac</span>

<span class="nv">vmz</span><span class="o">=</span><span class="s2">&quot;$tmpdir/`basename \&quot;$kernel\&quot;`.$ext&quot;</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$cacheit&quot;</span> -o ! -f <span class="s2">&quot;$vmz$gzip&quot;</span> -o <span class="s2">&quot;$vmz$gzip&quot;</span> -ot <span class="s2">&quot;$kernel&quot;</span> <span class="o">]</span>; <span class="k">then</span>
    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy <span class="nv">$objflags</span> <span class="s2">&quot;$kernel&quot;</span> <span class="s2">&quot;$vmz.$$&quot;</span>

    <span class="nv">strip_size</span><span class="o">=</span><span class="k">$(</span>stat -c %s <span class="nv">$vmz</span>.<span class="nv">$$</span><span class="k">)</span>

    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$gzip&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">        </span>gzip -n -f -9 <span class="s2">&quot;$vmz.$$&quot;</span>
    <span class="k">fi</span>

<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$cacheit&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>mv -f <span class="s2">&quot;$vmz.$$$gzip&quot;</span> <span class="s2">&quot;$vmz$gzip&quot;</span>
    <span class="k">else</span>
<span class="k">	</span><span class="nv">vmz</span><span class="o">=</span><span class="s2">&quot;$vmz.$$&quot;</span>
    <span class="k">fi</span>
<span class="k">else</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Calculate the vmlinux.strip size</p></td><td class="code"><div class="highlight"><pre>    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy <span class="nv">$objflags</span> <span class="s2">&quot;$kernel&quot;</span> <span class="s2">&quot;$vmz.$$&quot;</span>
    <span class="nv">strip_size</span><span class="o">=</span><span class="k">$(</span>stat -c %s <span class="nv">$vmz</span>.<span class="nv">$$</span><span class="k">)</span>
    rm -f <span class="nv">$vmz</span>.<span class="nv">$$</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$make_space&quot;</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span> <span class="o">]</span>; <span class="k">then</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Round the size to next higher MB limit</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">round_size</span><span class="o">=</span><span class="k">$((</span><span class="o">(</span>strip_size <span class="o">+</span> <span class="m">0</span>xfffff<span class="o">)</span> <span class="o">&amp;</span> <span class="m">0</span>xfff00000<span class="k">))</span>

	<span class="nv">round_size</span><span class="o">=</span>0x<span class="k">$(</span><span class="nb">printf</span> <span class="s2">&quot;%x&quot;</span> <span class="nv">$round_size</span><span class="k">)</span>
	<span class="nv">link_addr</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> <span class="s2">&quot;%d&quot;</span> <span class="nv">$link_address</span><span class="k">)</span>

	<span class="k">if</span> <span class="o">[</span> <span class="nv">$link_addr</span> -lt <span class="nv">$strip_size</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	    </span><span class="nb">echo</span> <span class="s2">&quot;INFO: Uncompressed kernel (size 0x$(printf &quot;</span>%x<span class="se">\n</span><span class="s2">&quot; $strip_size))&quot;</span> <span class="se">\</span>
			<span class="s2">&quot;overlaps the address of the wrapper($link_address)&quot;</span>
	    <span class="nb">echo</span> <span class="s2">&quot;INFO: Fixing the link_address of wrapper to ($round_size)&quot;</span>
	    <span class="nv">link_address</span><span class="o">=</span><span class="nv">$round_size</span>
	<span class="k">fi</span>
<span class="k">fi</span>

<span class="nv">vmz</span><span class="o">=</span><span class="s2">&quot;$vmz$gzip&quot;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Extract kernel version information, some platforms want to include
it in the image header</p></td><td class="code"><div class="highlight"><pre><span class="nv">version</span><span class="o">=</span><span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>strings <span class="s2">&quot;$kernel&quot;</span> | grep <span class="s1">&#39;^Linux version [-0-9.]&#39;</span> | <span class="se">\</span>
    cut -d<span class="s1">&#39; &#39;</span> -f3<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$version&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nv">uboot_version</span><span class="o">=</span><span class="s2">&quot;-n Linux-$version&quot;</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>physical offset of kernel image</p></td><td class="code"><div class="highlight"><pre><span class="nv">membase</span><span class="o">=</span><span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objdump -p <span class="s2">&quot;$kernel&quot;</span> | grep -m 1 LOAD | awk <span class="s1">&#39;{print $7}&#39;</span><span class="sb">`</span>

<span class="k">case</span> <span class="s2">&quot;$platform&quot;</span> in
uboot<span class="o">)</span>
    rm -f <span class="s2">&quot;$ofile&quot;</span>
    <span class="k">${</span><span class="nv">MKIMAGE</span><span class="k">}</span> -A ppc -O linux -T kernel -C gzip -a <span class="nv">$membase</span> -e <span class="nv">$membase</span> <span class="se">\</span>
	<span class="nv">$uboot_version</span> -d <span class="s2">&quot;$vmz&quot;</span> <span class="s2">&quot;$ofile&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$cacheit&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm -f <span class="s2">&quot;$vmz&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>0
    ;;
uboot-obs600<span class="o">)</span>
    rm -f <span class="s2">&quot;$ofile&quot;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>obs600 wants a multi image with an initrd, so we need to put a fake
one in even when building a "normal" image.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$initrd&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span><span class="nv">real_rd</span><span class="o">=</span><span class="s2">&quot;$initrd&quot;</span>
    <span class="k">else</span>
<span class="k">	</span><span class="nv">real_rd</span><span class="o">=</span><span class="sb">`</span>mktemp<span class="sb">`</span>
	<span class="nb">echo</span> <span class="s2">&quot;\0&quot;</span> &gt;&gt;<span class="s2">&quot;$real_rd&quot;</span>
    <span class="k">fi</span>
    <span class="k">${</span><span class="nv">MKIMAGE</span><span class="k">}</span> -A ppc -O linux -T multi -C gzip -a <span class="nv">$membase</span> -e <span class="nv">$membase</span> <span class="se">\</span>
	<span class="nv">$uboot_version</span> -d <span class="s2">&quot;$vmz&quot;</span>:<span class="s2">&quot;$real_rd&quot;</span>:<span class="s2">&quot;$dtb&quot;</span> <span class="s2">&quot;$ofile&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$initrd&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm -f <span class="s2">&quot;$real_rd&quot;</span>
    <span class="k">fi</span>
<span class="k">    if</span> <span class="o">[</span> -z <span class="s2">&quot;$cacheit&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm -f <span class="s2">&quot;$vmz&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>0
    ;;
<span class="k">esac</span>

addsec<span class="o">()</span> <span class="o">{</span>
    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy <span class="nv">$4</span> <span class="nv">$1</span> <span class="se">\</span>
	--add-section<span class="o">=</span><span class="nv">$3</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span> <span class="se">\</span>
	--set-section-flags<span class="o">=</span><span class="nv">$3</span><span class="o">=</span>contents,alloc,load,readonly,data
<span class="o">}</span>

addsec <span class="nv">$tmp</span> <span class="s2">&quot;$vmz&quot;</span> <span class="nv">$ksection</span> <span class="nv">$object</span>/empty.o
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$cacheit&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>rm -f <span class="s2">&quot;$vmz&quot;</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$initrd&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>addsec <span class="nv">$tmp</span> <span class="s2">&quot;$initrd&quot;</span> <span class="nv">$isection</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$dtb&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>addsec <span class="nv">$tmp</span> <span class="s2">&quot;$dtb&quot;</span> .kernel:dtb
    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$dts&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm <span class="nv">$dtb</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$platform&quot;</span> !<span class="o">=</span> <span class="s2">&quot;miboot&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$link_address&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
<span class="k">        </span><span class="nv">text_start</span><span class="o">=</span><span class="s2">&quot;-Ttext $link_address&quot;</span>
    <span class="k">fi</span>
    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>ld -m elf32ppc -T <span class="nv">$lds</span> <span class="nv">$text_start</span> <span class="nv">$pie</span> -o <span class="s2">&quot;$ofile&quot;</span> <span class="se">\</span>
	<span class="nv">$platformo</span> <span class="nv">$tmp</span> <span class="nv">$object</span>/wrapper.a
    rm <span class="nv">$tmp</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Some platforms need the zImage's entry point and base address</p></td><td class="code"><div class="highlight"><pre><span class="nv">base</span><span class="o">=</span>0x<span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>nm <span class="s2">&quot;$ofile&quot;</span> | grep <span class="s1">&#39; _start$&#39;</span> | cut -d<span class="s1">&#39; &#39;</span> -f1<span class="sb">`</span>
<span class="nv">entry</span><span class="o">=</span><span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objdump -f <span class="s2">&quot;$ofile&quot;</span> | grep <span class="s1">&#39;^start address &#39;</span> | cut -d<span class="s1">&#39; &#39;</span> -f3<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$binary&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span>mv <span class="s2">&quot;$ofile&quot;</span> <span class="s2">&quot;$ofile&quot;</span>.elf
    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy -O binary <span class="s2">&quot;$ofile&quot;</span>.elf <span class="s2">&quot;$ofile&quot;</span>
<span class="k">fi</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>post-processing needed for some platforms</p></td><td class="code"><div class="highlight"><pre><span class="k">case</span> <span class="s2">&quot;$platform&quot;</span> in
pseries|chrp|maple<span class="o">)</span>
    <span class="nv">$objbin</span>/addnote <span class="s2">&quot;$ofile&quot;</span>
    ;;
coff<span class="o">)</span>
    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy -O aixcoff-rs6000 --set-start <span class="s2">&quot;$entry&quot;</span> <span class="s2">&quot;$ofile&quot;</span>
    <span class="nv">$objbin</span>/hack-coff <span class="s2">&quot;$ofile&quot;</span>
    ;;
cuboot*<span class="o">)</span>
    gzip -n -f -9 <span class="s2">&quot;$ofile&quot;</span>
    <span class="k">${</span><span class="nv">MKIMAGE</span><span class="k">}</span> -A ppc -O linux -T kernel -C gzip -a <span class="s2">&quot;$base&quot;</span> -e <span class="s2">&quot;$entry&quot;</span> <span class="se">\</span>
            <span class="nv">$uboot_version</span> -d <span class="s2">&quot;$ofile&quot;</span>.gz <span class="s2">&quot;$ofile&quot;</span>
    ;;
treeboot*<span class="o">)</span>
    mv <span class="s2">&quot;$ofile&quot;</span> <span class="s2">&quot;$ofile.elf&quot;</span>
    <span class="nv">$objbin</span>/mktree <span class="s2">&quot;$ofile.elf&quot;</span> <span class="s2">&quot;$ofile&quot;</span> <span class="s2">&quot;$base&quot;</span> <span class="s2">&quot;$entry&quot;</span>
    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$cacheit&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">	</span>rm -f <span class="s2">&quot;$ofile.elf&quot;</span>
    <span class="k">fi</span>
<span class="k">    </span><span class="nb">exit </span>0
    ;;
ps3<span class="o">)</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>The ps3's loader supports loading a gzipped binary image from flash
rom to ram addr zero. The loader then enters the system reset
vector at addr 0x100.  A bootwrapper overlay is used to arrange for
a binary image of the kernel to be at addr zero, and yet have a
suitable bootwrapper entry at 0x100.  To construct the final rom
image 512 bytes from offset 0x100 is copied to the bootwrapper
place holder at symbol <em>_system</em>reset<em>kernel.  The 512 bytes of the
bootwrapper entry code at symbol _</em>system<em>reset</em>overlay is then
copied to offset 0x100.  At runtime the bootwrapper program copies
the data at <em>_system</em>reset_kernel back to addr 0x100.</p></td><td class="code"><div class="highlight"><pre>    <span class="nv">system_reset_overlay</span><span class="o">=</span>0x<span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>nm <span class="s2">&quot;$ofile&quot;</span> <span class="se">\</span>
        | grep <span class="s1">&#39; __system_reset_overlay$&#39;</span>       <span class="se">\</span>
        | cut -d<span class="s1">&#39; &#39;</span> -f1<span class="sb">`</span>
    <span class="nv">system_reset_overlay</span><span class="o">=</span><span class="sb">`</span><span class="nb">printf</span> <span class="s2">&quot;%d&quot;</span> <span class="nv">$system_reset_overlay</span><span class="sb">`</span>
    <span class="nv">system_reset_kernel</span><span class="o">=</span>0x<span class="sb">`</span><span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>nm <span class="s2">&quot;$ofile&quot;</span> <span class="se">\</span>
        | grep <span class="s1">&#39; __system_reset_kernel$&#39;</span>       <span class="se">\</span>
        | cut -d<span class="s1">&#39; &#39;</span> -f1<span class="sb">`</span>
    <span class="nv">system_reset_kernel</span><span class="o">=</span><span class="sb">`</span><span class="nb">printf</span> <span class="s2">&quot;%d&quot;</span> <span class="nv">$system_reset_kernel</span><span class="sb">`</span>
    <span class="nv">overlay_dest</span><span class="o">=</span><span class="s2">&quot;256&quot;</span>
    <span class="nv">overlay_size</span><span class="o">=</span><span class="s2">&quot;512&quot;</span>

    <span class="k">${</span><span class="nv">CROSS</span><span class="k">}</span>objcopy -O binary <span class="s2">&quot;$ofile&quot;</span> <span class="s2">&quot;$ofile.bin&quot;</span>

    dd <span class="k">if</span><span class="o">=</span><span class="s2">&quot;$ofile.bin&quot;</span> <span class="nv">of</span><span class="o">=</span><span class="s2">&quot;$ofile.bin&quot;</span> <span class="nv">conv</span><span class="o">=</span>notrunc   <span class="se">\</span>
        <span class="nv">skip</span><span class="o">=</span><span class="nv">$overlay_dest</span> <span class="nv">seek</span><span class="o">=</span><span class="nv">$system_reset_kernel</span>  <span class="se">\</span>
        <span class="nv">count</span><span class="o">=</span><span class="nv">$overlay_size</span> <span class="nv">bs</span><span class="o">=</span>1

    dd <span class="k">if</span><span class="o">=</span><span class="s2">&quot;$ofile.bin&quot;</span> <span class="nv">of</span><span class="o">=</span><span class="s2">&quot;$ofile.bin&quot;</span> <span class="nv">conv</span><span class="o">=</span>notrunc   <span class="se">\</span>
        <span class="nv">skip</span><span class="o">=</span><span class="nv">$system_reset_overlay</span> <span class="nv">seek</span><span class="o">=</span><span class="nv">$overlay_dest</span> <span class="se">\</span>
        <span class="nv">count</span><span class="o">=</span><span class="nv">$overlay_size</span> <span class="nv">bs</span><span class="o">=</span>1

    <span class="nv">odir</span><span class="o">=</span><span class="s2">&quot;$(dirname &quot;</span><span class="nv">$ofile</span>.bin<span class="s2">&quot;)&quot;</span>
    rm -f <span class="s2">&quot;$odir/otheros.bld&quot;</span>
    gzip -n --force -9 --stdout <span class="s2">&quot;$ofile.bin&quot;</span> &gt; <span class="s2">&quot;$odir/otheros.bld&quot;</span>
    ;;
<span class="k">esac</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
