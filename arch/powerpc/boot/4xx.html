<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › boot › 4xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>4xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2007 David Gibson, IBM Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on earlier code:</span>
<span class="cm"> *   Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *   Copyright 2002-2005 MontaVista Software Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *   Eugene Surovegin &lt;eugene.surovegin@zultys.com&gt; or &lt;ebs@ebshome.net&gt;</span>
<span class="cm"> *   Copyright (c) 2003, 2004 Zultys Technologies</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Wind River Systems, Inc.</span>
<span class="cm"> *   Updated for supporting PPC405EX on Kilauea.</span>
<span class="cm"> *   Tiejun Chen &lt;tiejun.chen@windriver.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;stddef.h&gt;</span>
<span class="cp">#include &quot;types.h&quot;</span>
<span class="cp">#include &quot;string.h&quot;</span>
<span class="cp">#include &quot;stdio.h&quot;</span>
<span class="cp">#include &quot;ops.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;dcr.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">chip_11_errata</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">memsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pvr</span><span class="p">;</span>

	<span class="n">pvr</span> <span class="o">=</span> <span class="n">mfpvr</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pvr</span> <span class="o">&amp;</span> <span class="mh">0xf0000ff0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x40000850</span>:
		<span class="k">case</span> <span class="mh">0x400008d0</span>:
		<span class="k">case</span> <span class="mh">0x200008d0</span>:
			<span class="n">memsize</span> <span class="o">-=</span> <span class="mi">4096</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">memsize</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read the 4xx SDRAM controller to get size of system memory. */</span>
<span class="kt">void</span> <span class="nf">ibm4xx_sdram_fixup_memsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">memsize</span><span class="p">,</span> <span class="n">bank_config</span><span class="p">;</span>

	<span class="n">memsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdram_bxcr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bank_config</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">sdram_bxcr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bank_config</span> <span class="o">&amp;</span> <span class="n">SDRAM_CONFIG_BANK_ENABLE</span><span class="p">)</span>
			<span class="n">memsize</span> <span class="o">+=</span> <span class="n">SDRAM_CONFIG_BANK_SIZE</span><span class="p">(</span><span class="n">bank_config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memsize</span> <span class="o">=</span> <span class="n">chip_11_errata</span><span class="p">(</span><span class="n">memsize</span><span class="p">);</span>
	<span class="n">dt_fixup_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read the 440SPe MQ controller to get size of system memory. */</span>
<span class="cp">#define DCRN_MQ0_B0BAS		0x40</span>
<span class="cp">#define DCRN_MQ0_B1BAS		0x41</span>
<span class="cp">#define DCRN_MQ0_B2BAS		0x42</span>
<span class="cp">#define DCRN_MQ0_B3BAS		0x43</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ibm440spe_decode_bas</span><span class="p">(</span><span class="n">u32</span> <span class="n">bas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">base</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">bas</span> <span class="o">&amp;</span> <span class="mh">0xFFE00000u</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* open coded because I&#39;m paranoid about invalid values */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="n">bas</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xffc</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x000800000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xff8</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x001000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xff0</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x002000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfe0</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x004000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfc0</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x008000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf80</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x010000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf00</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x020000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xe00</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x040000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc00</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x080000000ull</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x800</span>:
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0x100000000ull</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Memory BAS value 0x%08x unsupported !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bas</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm440spe_fixup_memsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">banktop</span><span class="p">,</span> <span class="n">memsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ultimately, we should directly construct the memory node</span>
<span class="cm">	 * so we are able to handle holes in the memory address space</span>
<span class="cm">	 */</span>
	<span class="n">banktop</span> <span class="o">=</span> <span class="n">ibm440spe_decode_bas</span><span class="p">(</span><span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_MQ0_B0BAS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">banktop</span> <span class="o">&gt;</span> <span class="n">memsize</span><span class="p">)</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">banktop</span><span class="p">;</span>
	<span class="n">banktop</span> <span class="o">=</span> <span class="n">ibm440spe_decode_bas</span><span class="p">(</span><span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_MQ0_B1BAS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">banktop</span> <span class="o">&gt;</span> <span class="n">memsize</span><span class="p">)</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">banktop</span><span class="p">;</span>
	<span class="n">banktop</span> <span class="o">=</span> <span class="n">ibm440spe_decode_bas</span><span class="p">(</span><span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_MQ0_B2BAS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">banktop</span> <span class="o">&gt;</span> <span class="n">memsize</span><span class="p">)</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">banktop</span><span class="p">;</span>
	<span class="n">banktop</span> <span class="o">=</span> <span class="n">ibm440spe_decode_bas</span><span class="p">(</span><span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_MQ0_B3BAS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">banktop</span> <span class="o">&gt;</span> <span class="n">memsize</span><span class="p">)</span>
		<span class="n">memsize</span> <span class="o">=</span> <span class="n">banktop</span><span class="p">;</span>

	<span class="n">dt_fixup_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* 4xx DDR1/2 Denali memory controller support */</span>
<span class="cm">/* DDR0 registers */</span>
<span class="cp">#define DDR0_02			2</span>
<span class="cp">#define DDR0_08			8</span>
<span class="cp">#define DDR0_10			10</span>
<span class="cp">#define DDR0_14			14</span>
<span class="cp">#define DDR0_42			42</span>
<span class="cp">#define DDR0_43			43</span>

<span class="cm">/* DDR0_02 */</span>
<span class="cp">#define DDR_START		0x1</span>
<span class="cp">#define DDR_START_SHIFT		0</span>
<span class="cp">#define DDR_MAX_CS_REG		0x3</span>
<span class="cp">#define DDR_MAX_CS_REG_SHIFT	24</span>
<span class="cp">#define DDR_MAX_COL_REG		0xf</span>
<span class="cp">#define DDR_MAX_COL_REG_SHIFT	16</span>
<span class="cp">#define DDR_MAX_ROW_REG		0xf</span>
<span class="cp">#define DDR_MAX_ROW_REG_SHIFT	8</span>
<span class="cm">/* DDR0_08 */</span>
<span class="cp">#define DDR_DDR2_MODE		0x1</span>
<span class="cp">#define DDR_DDR2_MODE_SHIFT	0</span>
<span class="cm">/* DDR0_10 */</span>
<span class="cp">#define DDR_CS_MAP		0x3</span>
<span class="cp">#define DDR_CS_MAP_SHIFT	8</span>
<span class="cm">/* DDR0_14 */</span>
<span class="cp">#define DDR_REDUC		0x1</span>
<span class="cp">#define DDR_REDUC_SHIFT		16</span>
<span class="cm">/* DDR0_42 */</span>
<span class="cp">#define DDR_APIN		0x7</span>
<span class="cp">#define DDR_APIN_SHIFT		24</span>
<span class="cm">/* DDR0_43 */</span>
<span class="cp">#define DDR_COL_SZ		0x7</span>
<span class="cp">#define DDR_COL_SZ_SHIFT	8</span>
<span class="cp">#define DDR_BANK8		0x1</span>
<span class="cp">#define DDR_BANK8_SHIFT		0</span>

<span class="cp">#define DDR_GET_VAL(val, mask, shift)	(((val) &gt;&gt; (shift)) &amp; (mask))</span>

<span class="cm">/*</span>
<span class="cm"> * Some U-Boot versions set the number of chipselects to two</span>
<span class="cm"> * for Sequoia/Rainier boards while they only have one chipselect</span>
<span class="cm"> * hardwired. Hardcode the number of chipselects to one</span>
<span class="cm"> * for sequioa/rainer board models or read the actual value</span>
<span class="cm"> * from the memory controller register DDR0_10 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">ibm4xx_denali_get_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">model</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">cs</span><span class="p">;</span>

	<span class="n">devp</span> <span class="o">=</span> <span class="n">finddevice</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">read_cs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">getprop</span><span class="p">(</span><span class="n">devp</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">model</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">read_cs</span><span class="p">;</span>

	<span class="n">model</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;amcc,sequoia&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;amcc,rainier&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">read_cs:</span>
	<span class="cm">/* get CS value */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">DDR0_10</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_CS_MAP</span><span class="p">,</span> <span class="n">DDR_CS_MAP_SHIFT</span><span class="p">);</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm4xx_denali_fixup_memsize</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">max_cs</span><span class="p">,</span> <span class="n">max_col</span><span class="p">,</span> <span class="n">max_row</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cs</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">dpath</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">memsize</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">DDR0_02</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_START</span><span class="p">,</span> <span class="n">DDR_START_SHIFT</span><span class="p">))</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;DDR controller is not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* get maximum cs col and row values */</span>
	<span class="n">max_cs</span>  <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_MAX_CS_REG</span><span class="p">,</span> <span class="n">DDR_MAX_CS_REG_SHIFT</span><span class="p">);</span>
	<span class="n">max_col</span> <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_MAX_COL_REG</span><span class="p">,</span> <span class="n">DDR_MAX_COL_REG_SHIFT</span><span class="p">);</span>
	<span class="n">max_row</span> <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_MAX_ROW_REG</span><span class="p">,</span> <span class="n">DDR_MAX_ROW_REG_SHIFT</span><span class="p">);</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">ibm4xx_denali_get_cs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;No memory installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">&gt;</span> <span class="n">max_cs</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;DDR wrong CS configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* get data path bytes */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">DDR0_14</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_REDUC</span><span class="p">,</span> <span class="n">DDR_REDUC_SHIFT</span><span class="p">))</span>
		<span class="n">dpath</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 32 bits */</span>
	<span class="k">else</span>
		<span class="n">dpath</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 64 bits */</span>

	<span class="cm">/* get address pins (rows) */</span>
 	<span class="n">val</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">DDR0_42</span><span class="p">);</span>

	<span class="n">row</span> <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_APIN</span><span class="p">,</span> <span class="n">DDR_APIN_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&gt;</span> <span class="n">max_row</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;DDR wrong APIN configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">row</span> <span class="o">=</span> <span class="n">max_row</span> <span class="o">-</span> <span class="n">row</span><span class="p">;</span>

	<span class="cm">/* get collomn size and banks */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">SDRAM0_READ</span><span class="p">(</span><span class="n">DDR0_43</span><span class="p">);</span>

	<span class="n">col</span> <span class="o">=</span> <span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_COL_SZ</span><span class="p">,</span> <span class="n">DDR_COL_SZ_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">&gt;</span> <span class="n">max_col</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;DDR wrong COL configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">col</span> <span class="o">=</span> <span class="n">max_col</span> <span class="o">-</span> <span class="n">col</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DDR_GET_VAL</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">DDR_BANK8</span><span class="p">,</span> <span class="n">DDR_BANK8_SHIFT</span><span class="p">))</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8 banks */</span>
	<span class="k">else</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 4 banks */</span>

	<span class="n">memsize</span> <span class="o">=</span> <span class="n">cs</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="n">row</span><span class="p">))</span> <span class="o">*</span> <span class="n">bank</span> <span class="o">*</span> <span class="n">dpath</span><span class="p">;</span>
	<span class="n">memsize</span> <span class="o">=</span> <span class="n">chip_11_errata</span><span class="p">(</span><span class="n">memsize</span><span class="p">);</span>
	<span class="n">dt_fixup_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">memsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SPRN_DBCR0_40X 0x3F2</span>
<span class="cp">#define SPRN_DBCR0_44X 0x134</span>
<span class="cp">#define DBCR0_RST_SYSTEM 0x30000000</span>

<span class="kt">void</span> <span class="nf">ibm44x_dbcr_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
		<span class="s">&quot;mfspr	%0,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;oris	%0,%0,%2@h</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;mtspr	%1,%0&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">SPRN_DBCR0_44X</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">DBCR0_RST_SYSTEM</span><span class="p">)</span>
		<span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm40x_dbcr_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span>
		<span class="s">&quot;mfspr	%0,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;oris	%0,%0,%2@h</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;mtspr	%1,%0&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">SPRN_DBCR0_40X</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">DBCR0_RST_SYSTEM</span><span class="p">)</span>
		<span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define EMAC_RESET 0x20000000</span>
<span class="kt">void</span> <span class="nf">ibm4xx_quiesce_eth</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">emac0</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">emac1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Quiesce the MAL and EMAC(s) since PIBS/OpenBIOS don&#39;t</span>
<span class="cm">	 * do this for us</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">emac0</span> <span class="o">=</span> <span class="n">EMAC_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emac1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">emac1</span> <span class="o">=</span> <span class="n">EMAC_RESET</span><span class="p">;</span>

	<span class="n">mtdcr</span><span class="p">(</span><span class="n">DCRN_MAL0_CFG</span><span class="p">,</span> <span class="n">MAL_RESET</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_MAL0_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAL_RESET</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* loop until reset takes effect */</span>
<span class="p">}</span>

<span class="cm">/* Read 4xx EBC bus bridge registers to get mappings of the peripheral</span>
<span class="cm"> * banks into the OPB address space */</span>
<span class="kt">void</span> <span class="nf">ibm4xx_fixup_ebc_ranges</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ebc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">devp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bxcr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ranges</span><span class="p">[</span><span class="n">EBC_NUM_BANKS</span><span class="o">*</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EBC_NUM_BANKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtdcr</span><span class="p">(</span><span class="n">DCRN_EBC0_CFGADDR</span><span class="p">,</span> <span class="n">EBC_BXCR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">bxcr</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_EBC0_CFGDATA</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bxcr</span> <span class="o">&amp;</span> <span class="n">EBC_BXCR_BU</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EBC_BXCR_BU_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">bxcr</span> <span class="o">&amp;</span> <span class="n">EBC_BXCR_BAS</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">EBC_BXCR_BANK_SIZE</span><span class="p">(</span><span class="n">bxcr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">devp</span> <span class="o">=</span> <span class="n">finddevice</span><span class="p">(</span><span class="n">ebc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">devp</span><span class="p">)</span>
		<span class="n">fatal</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t locate EBC node %s</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>

	<span class="n">setprop</span><span class="p">(</span><span class="n">devp</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">ranges</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Calculate 440GP clocks */</span>
<span class="kt">void</span> <span class="nf">ibm440gp_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sys0</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_SYS0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cr0</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_CR0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">plb</span><span class="p">,</span> <span class="n">opb</span><span class="p">,</span> <span class="n">ebc</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">uart0</span><span class="p">,</span> <span class="n">uart1</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opdv</span> <span class="o">=</span> <span class="n">CPC0_SYS0_OPDV</span><span class="p">(</span><span class="n">sys0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">epdv</span> <span class="o">=</span> <span class="n">CPC0_SYS0_EPDV</span><span class="p">(</span><span class="n">sys0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sys0</span> <span class="o">&amp;</span> <span class="n">CPC0_SYS0_BYPASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bypass system PLL */</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">=</span> <span class="n">sys_clk</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sys0</span> <span class="o">&amp;</span> <span class="n">CPC0_SYS0_EXTSL</span><span class="p">)</span>
			<span class="cm">/* PerClk */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">CPC0_SYS0_FWDVB</span><span class="p">(</span><span class="n">sys0</span><span class="p">)</span> <span class="o">*</span> <span class="n">opdv</span> <span class="o">*</span> <span class="n">epdv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* CPU clock */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">CPC0_SYS0_FBDV</span><span class="p">(</span><span class="n">sys0</span><span class="p">)</span> <span class="o">*</span> <span class="n">CPC0_SYS0_FWDVA</span><span class="p">(</span><span class="n">sys0</span><span class="p">);</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">CPC0_SYS0_FWDVA</span><span class="p">(</span><span class="n">sys0</span><span class="p">);</span>
		<span class="n">plb</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">CPC0_SYS0_FWDVB</span><span class="p">(</span><span class="n">sys0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">opb</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">opdv</span><span class="p">;</span>
	<span class="n">ebc</span> <span class="o">=</span> <span class="n">opb</span> <span class="o">/</span> <span class="n">epdv</span><span class="p">;</span>

	<span class="cm">/* FIXME: Check if this is for all 440GP, or just Ebony */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mfpvr</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xf0000fff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40000440</span><span class="p">)</span>
		<span class="cm">/* Rev. B 440GP, use external system clock */</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="n">sys_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Rev. C 440GP, errata force us to use internal clock */</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">CPC0_CR0_U0EC</span><span class="p">)</span>
		<span class="cm">/* External UART clock */</span>
		<span class="n">uart0</span> <span class="o">=</span> <span class="n">ser_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Internal UART clock */</span>
		<span class="n">uart0</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">CPC0_CR0_UDIV</span><span class="p">(</span><span class="n">cr0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cr0</span> <span class="o">&amp;</span> <span class="n">CPC0_CR0_U1EC</span><span class="p">)</span>
		<span class="cm">/* External UART clock */</span>
		<span class="n">uart1</span> <span class="o">=</span> <span class="n">ser_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Internal UART clock */</span>
		<span class="n">uart1</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">CPC0_CR0_UDIV</span><span class="p">(</span><span class="n">cr0</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;PPC440GP: SysClk = %dMHz (%x)</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">sys_clk</span> <span class="o">+</span> <span class="mi">500000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">sys_clk</span><span class="p">);</span>

	<span class="n">dt_fixup_cpu_clocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb&quot;</span><span class="p">,</span> <span class="n">plb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb&quot;</span><span class="p">,</span> <span class="n">opb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/ebc&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@40000200&quot;</span><span class="p">,</span> <span class="n">uart0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@40000300&quot;</span><span class="p">,</span> <span class="n">uart1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SPRN_CCR1 0x378</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">__fix_zero</span><span class="p">(</span><span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">u32</span> <span class="n">def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v</span> <span class="o">?</span> <span class="n">v</span> <span class="o">:</span> <span class="n">def</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__ibm440eplike_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmr_clk</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">per_clk_from_opb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PLL config */</span>
	<span class="n">u32</span> <span class="n">pllc</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PLLC</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">plld</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PLLD</span><span class="p">);</span>

	<span class="cm">/* Dividers */</span>
	<span class="n">u32</span> <span class="n">fbdv</span>   <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">plld</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fwdva</span>  <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">plld</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fwdvb</span>  <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">plld</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lfbdv</span>  <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">(</span><span class="n">plld</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pradv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PRIMAD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">prbdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PRIMBD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">opbdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_OPBD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">perdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PERD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Input clocks for primary dividers */</span>
	<span class="n">u32</span> <span class="n">clk_a</span><span class="p">,</span> <span class="n">clk_b</span><span class="p">;</span>

	<span class="cm">/* Resulting clocks */</span>
	<span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">plb</span><span class="p">,</span> <span class="n">opb</span><span class="p">,</span> <span class="n">ebc</span><span class="p">,</span> <span class="n">vco</span><span class="p">;</span>

	<span class="cm">/* Timebase */</span>
	<span class="n">u32</span> <span class="n">ccr1</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">tmr_clk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pllc</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">m</span><span class="p">;</span>

		<span class="cm">/* Feedback path */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">pllc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* PLLOUTx */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllc</span> <span class="o">&amp;</span> <span class="mh">0x20000000</span><span class="p">)</span> <span class="o">?</span> <span class="n">fwdvb</span> <span class="o">:</span> <span class="n">fwdva</span><span class="p">)</span> <span class="o">*</span> <span class="n">lfbdv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* CPU */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fwdva</span> <span class="o">*</span> <span class="n">pradv0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* PERClk */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fwdvb</span> <span class="o">*</span> <span class="n">prbdv0</span> <span class="o">*</span> <span class="n">opbdv0</span> <span class="o">*</span> <span class="n">perdv0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING ! Invalid PLL feedback source !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bypass</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span> <span class="o">*=</span> <span class="n">fbdv</span><span class="p">;</span>
		<span class="n">vco</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span><span class="p">;</span>
		<span class="n">clk_a</span> <span class="o">=</span> <span class="n">vco</span> <span class="o">/</span> <span class="n">fwdva</span><span class="p">;</span>
		<span class="n">clk_b</span> <span class="o">=</span> <span class="n">vco</span> <span class="o">/</span> <span class="n">fwdvb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">bypass:</span>
		<span class="cm">/* Bypass system PLL */</span>
		<span class="n">vco</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clk_a</span> <span class="o">=</span> <span class="n">clk_b</span> <span class="o">=</span> <span class="n">sys_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">clk_a</span> <span class="o">/</span> <span class="n">pradv0</span><span class="p">;</span>
	<span class="n">plb</span> <span class="o">=</span> <span class="n">clk_b</span> <span class="o">/</span> <span class="n">prbdv0</span><span class="p">;</span>
	<span class="n">opb</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">opbdv0</span><span class="p">;</span>
	<span class="n">ebc</span> <span class="o">=</span> <span class="p">(</span><span class="n">per_clk_from_opb</span> <span class="o">?</span> <span class="n">opb</span> <span class="o">:</span> <span class="n">plb</span><span class="p">)</span> <span class="o">/</span> <span class="n">perdv0</span><span class="p">;</span>

	<span class="cm">/* Figure out timebase.  Either CPU or default TmrClk */</span>
	<span class="n">ccr1</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_CCR1</span><span class="p">);</span>

	<span class="cm">/* If passed a 0 tmr_clk, force CPU clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80u</span><span class="p">;</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_CCR1</span><span class="p">,</span> <span class="n">ccr1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccr1</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tb</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">dt_fixup_cpu_clocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb&quot;</span><span class="p">,</span> <span class="n">plb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb&quot;</span><span class="p">,</span> <span class="n">opb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/ebc&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">plb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eplike_fixup_uart_clk</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plb_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sdr</span> <span class="o">=</span> <span class="n">SDR0_READ</span><span class="p">(</span><span class="n">DCRN_SDR0_UART0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sdr</span> <span class="o">=</span> <span class="n">SDR0_READ</span><span class="p">(</span><span class="n">DCRN_SDR0_UART1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">sdr</span> <span class="o">=</span> <span class="n">SDR0_READ</span><span class="p">(</span><span class="n">DCRN_SDR0_UART2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">sdr</span> <span class="o">=</span> <span class="n">SDR0_READ</span><span class="p">(</span><span class="n">DCRN_SDR0_UART3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdr</span> <span class="o">&amp;</span> <span class="mh">0x00800000u</span><span class="p">)</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">ser_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">plb_clk</span> <span class="o">/</span> <span class="n">__fix_zero</span><span class="p">(</span><span class="n">sdr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm440ep_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmr_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plb_clk</span> <span class="o">=</span> <span class="n">__ibm440eplike_fixup_clocks</span><span class="p">(</span><span class="n">sys_clk</span><span class="p">,</span> <span class="n">tmr_clk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* serial clocks need fixup based on int/ext */</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@ef600300&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@ef600400&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@ef600500&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@ef600600&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm440gx_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmr_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plb_clk</span> <span class="o">=</span> <span class="n">__ibm440eplike_fixup_clocks</span><span class="p">(</span><span class="n">sys_clk</span><span class="p">,</span> <span class="n">tmr_clk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* serial clocks need fixup based on int/ext */</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@40000200&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@40000300&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm440spe_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmr_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plb_clk</span> <span class="o">=</span> <span class="n">__ibm440eplike_fixup_clocks</span><span class="p">(</span><span class="n">sys_clk</span><span class="p">,</span> <span class="n">tmr_clk</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* serial clocks need fixup based on int/ext */</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@f0000200&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@f0000300&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
	<span class="n">eplike_fixup_uart_clk</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;/plb/opb/serial@f0000600&quot;</span><span class="p">,</span> <span class="n">ser_clk</span><span class="p">,</span> <span class="n">plb_clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm405gp_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ser_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pllmr</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_PLLMR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpc0_cr0</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_405_CPC0_CR0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpc0_cr1</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_405_CPC0_CR1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">psr</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_405_CPC0_PSR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">plb</span><span class="p">,</span> <span class="n">opb</span><span class="p">,</span> <span class="n">ebc</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">uart0</span><span class="p">,</span> <span class="n">uart1</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwdv</span><span class="p">,</span> <span class="n">fwdvb</span><span class="p">,</span> <span class="n">fbdv</span><span class="p">,</span> <span class="n">cbdv</span><span class="p">,</span> <span class="n">opdv</span><span class="p">,</span> <span class="n">epdv</span><span class="p">,</span> <span class="n">ppdv</span><span class="p">,</span> <span class="n">udiv</span><span class="p">;</span>

	<span class="n">fwdv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">((</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0xe0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">));</span>
	<span class="n">fbdv</span> <span class="o">=</span> <span class="p">(</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x1e000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fbdv</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">cbdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x00060000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* CPU:PLB */</span>
	<span class="n">opdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x00018000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PLB:OPB */</span>
	<span class="n">ppdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x00001800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PLB:PCI */</span>
	<span class="n">epdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x00001800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* PLB:EBC */</span>
	<span class="n">udiv</span> <span class="o">=</span> <span class="p">((</span><span class="n">cpc0_cr0</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check for 405GPr */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mfpvr</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x50910951</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fwdvb</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">pllmr</span> <span class="o">&amp;</span> <span class="mh">0x00000007</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">))</span> <span class="cm">/* PCI async mode enable == 0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="mh">0x00000020</span><span class="p">)</span> <span class="cm">/* New mode enable */</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">fwdvb</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ppdv</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">fwdvb</span> <span class="o">*</span> <span class="n">cbdv</span> <span class="o">*</span> <span class="n">ppdv</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="mh">0x00000020</span><span class="p">)</span> <span class="cm">/* New mode enable */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">)</span> <span class="cm">/* PerClk synch mode */</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">fwdvb</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">epdv</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">fwdv</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epdv</span> <span class="o">==</span> <span class="n">fbdv</span><span class="p">)</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">cbdv</span> <span class="o">*</span> <span class="n">epdv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">fwdvb</span> <span class="o">*</span> <span class="n">cbdv</span><span class="p">;</span>

		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">fwdv</span><span class="p">;</span>
		<span class="n">plb</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">fwdvb</span> <span class="o">*</span> <span class="n">cbdv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">fwdv</span> <span class="o">*</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">cbdv</span><span class="p">;</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="n">fwdv</span><span class="p">;</span>
		<span class="n">plb</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="n">cbdv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">opb</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">opdv</span><span class="p">;</span>
	<span class="n">ebc</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">epdv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpc0_cr0</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="cm">/* uart0 uses the external clock */</span>
		<span class="n">uart0</span> <span class="o">=</span> <span class="n">ser_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uart0</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="n">udiv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpc0_cr0</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="cm">/* uart1 uses the external clock */</span>
		<span class="n">uart1</span> <span class="o">=</span> <span class="n">ser_clk</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uart1</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="n">udiv</span><span class="p">;</span>

	<span class="cm">/* setup the timebase clock to tick at the cpu frequency */</span>
	<span class="n">cpc0_cr1</span> <span class="o">=</span> <span class="n">cpc0_cr1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00800000</span><span class="p">;</span>
	<span class="n">mtdcr</span><span class="p">(</span><span class="n">DCRN_405_CPC0_CR1</span><span class="p">,</span> <span class="n">cpc0_cr1</span><span class="p">);</span>
	<span class="n">tb</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">dt_fixup_cpu_clocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb&quot;</span><span class="p">,</span> <span class="n">plb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb&quot;</span><span class="p">,</span> <span class="n">opb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/ebc&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600300&quot;</span><span class="p">,</span> <span class="n">uart0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600400&quot;</span><span class="p">,</span> <span class="n">uart1</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ibm405ep_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pllmr0</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_PLLMR0</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pllmr1</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_PLLMR1</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpc0_ucr</span> <span class="o">=</span> <span class="n">mfdcr</span><span class="p">(</span><span class="n">DCRN_CPC0_UCR</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">plb</span><span class="p">,</span> <span class="n">opb</span><span class="p">,</span> <span class="n">ebc</span><span class="p">,</span> <span class="n">uart0</span><span class="p">,</span> <span class="n">uart1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fwdva</span><span class="p">,</span> <span class="n">fwdvb</span><span class="p">,</span> <span class="n">fbdv</span><span class="p">,</span> <span class="n">cbdv</span><span class="p">,</span> <span class="n">opdv</span><span class="p">,</span> <span class="n">epdv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pllmr0_ccdv</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="n">fwdva</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">((</span><span class="n">pllmr1</span> <span class="o">&amp;</span> <span class="mh">0x00070000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">fwdvb</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">((</span><span class="n">pllmr1</span> <span class="o">&amp;</span> <span class="mh">0x00007000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">fbdv</span> <span class="o">=</span> <span class="p">(</span><span class="n">pllmr1</span> <span class="o">&amp;</span> <span class="mh">0x00f00000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbdv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fbdv</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">cbdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr0</span> <span class="o">&amp;</span> <span class="mh">0x00030000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* CPU:PLB */</span>
	<span class="n">epdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr0</span> <span class="o">&amp;</span> <span class="mh">0x00000300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* PLB:EBC */</span>
	<span class="n">opdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr0</span> <span class="o">&amp;</span> <span class="mh">0x00003000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PLB:OPB */</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">fwdvb</span><span class="p">;</span>

	<span class="n">pllmr0_ccdv</span> <span class="o">=</span> <span class="p">((</span><span class="n">pllmr0</span> <span class="o">&amp;</span> <span class="mh">0x00300000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pllmr1</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">fwdva</span> <span class="o">*</span> <span class="n">pllmr0_ccdv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">sys_clk</span> <span class="o">/</span> <span class="n">pllmr0_ccdv</span><span class="p">;</span>

	<span class="n">plb</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="n">cbdv</span><span class="p">;</span>
	<span class="n">opb</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">opdv</span><span class="p">;</span>
	<span class="n">ebc</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">epdv</span><span class="p">;</span>
	<span class="n">tb</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">uart0</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="p">(</span><span class="n">cpc0_ucr</span> <span class="o">&amp;</span> <span class="mh">0x0000007f</span><span class="p">);</span>
	<span class="n">uart1</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">/</span> <span class="p">((</span><span class="n">cpc0_ucr</span> <span class="o">&amp;</span> <span class="mh">0x00007f00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dt_fixup_cpu_clocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb&quot;</span><span class="p">,</span> <span class="n">plb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb&quot;</span><span class="p">,</span> <span class="n">opb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/ebc&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600300&quot;</span><span class="p">,</span> <span class="n">uart0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600400&quot;</span><span class="p">,</span> <span class="n">uart1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">ibm405ex_fwdv_multi_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* values for:  1 - 16 */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span>
<span class="p">};</span>

<span class="n">u32</span> <span class="nf">ibm405ex_get_fwdva</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpr_fwdv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ibm405ex_fwdv_multi_bits</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpr_fwdv</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ibm405ex_fwdv_multi_bits</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">ibm405ex_fbdv_multi_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* values for:  1 - 100 */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span>
	<span class="mh">0x29</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span>
	<span class="mh">0x77</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
	<span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span>
	<span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span>
	<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span>
	<span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span>
	<span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
	<span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span>
	<span class="cm">/* values for:  101 - 200 */</span>
	<span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span>
	<span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span>
	<span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span>
	<span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span>
	<span class="mh">0x63</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span>
	<span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span>
	<span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span>
	<span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span>
	<span class="cm">/* values for:  201 - 255 */</span>
	<span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span>
	<span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span>
	<span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>
	<span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x3f</span>  <span class="cm">/* END */</span>
<span class="p">};</span>

<span class="n">u32</span> <span class="nf">ibm405ex_get_fbdv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpr_fbdv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ibm405ex_fbdv_multi_bits</span><span class="p">);</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpr_fbdv</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ibm405ex_fbdv_multi_bits</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ibm405ex_fixup_clocks</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sys_clk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uart_clk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* PLL config */</span>
	<span class="n">u32</span> <span class="n">pllc</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PLLC</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">plld</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PLLD</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cpud</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PRIMAD</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">plbd</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PRIMBD</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">opbd</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_OPBD</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">perd</span>  <span class="o">=</span> <span class="n">CPR0_READ</span><span class="p">(</span><span class="n">DCRN_CPR0_PERD</span><span class="p">);</span>

	<span class="cm">/* Dividers */</span>
	<span class="n">u32</span> <span class="n">fbdv</span>   <span class="o">=</span> <span class="n">ibm405ex_get_fbdv</span><span class="p">(</span><span class="n">__fix_zero</span><span class="p">((</span><span class="n">plld</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">u32</span> <span class="n">fwdva</span>  <span class="o">=</span> <span class="n">ibm405ex_get_fwdva</span><span class="p">(</span><span class="n">__fix_zero</span><span class="p">((</span><span class="n">plld</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">u32</span> <span class="n">cpudv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">cpud</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* PLBDV0 is hardwared to 010. */</span>
	<span class="n">u32</span> <span class="n">plbdv0</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">plb2xdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">plbd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">opbdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">opbd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">perdv0</span> <span class="o">=</span> <span class="n">__fix_zero</span><span class="p">((</span><span class="n">perd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Resulting clocks */</span>
	<span class="n">u32</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">plb</span><span class="p">,</span> <span class="n">opb</span><span class="p">,</span> <span class="n">ebc</span><span class="p">,</span> <span class="n">vco</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">uart0</span><span class="p">,</span> <span class="n">uart1</span><span class="p">;</span>

	<span class="cm">/* PLL&#39;s VCO is the source for primary forward ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pllc</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">m</span><span class="p">;</span>

		<span class="cm">/* Feedback path */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">pllc</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* PLLOUTx */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* CPU */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">fwdva</span> <span class="o">*</span> <span class="n">cpudv0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* PERClk */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">fbdv</span> <span class="o">*</span> <span class="n">fwdva</span> <span class="o">*</span> <span class="n">plb2xdv0</span> <span class="o">*</span> <span class="n">plbdv0</span> <span class="o">*</span> <span class="n">opbdv0</span> <span class="o">*</span> <span class="n">perdv0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING ! Invalid PLL feedback source !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bypass</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vco</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">sys_clk</span> <span class="o">*</span> <span class="n">m</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="nl">bypass:</span>
		<span class="cm">/* Bypass system PLL */</span>
		<span class="n">vco</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CPU = VCO / ( FWDVA x CPUDV0) */</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">vco</span> <span class="o">/</span> <span class="p">(</span><span class="n">fwdva</span> <span class="o">*</span> <span class="n">cpudv0</span><span class="p">);</span>
	<span class="cm">/* PLB = VCO / ( FWDVA x PLB2XDV0 x PLBDV0) */</span>
	<span class="n">plb</span> <span class="o">=</span> <span class="n">vco</span> <span class="o">/</span> <span class="p">(</span><span class="n">fwdva</span> <span class="o">*</span> <span class="n">plb2xdv0</span> <span class="o">*</span> <span class="n">plbdv0</span><span class="p">);</span>
	<span class="cm">/* OPB = PLB / OPBDV0 */</span>
	<span class="n">opb</span> <span class="o">=</span> <span class="n">plb</span> <span class="o">/</span> <span class="n">opbdv0</span><span class="p">;</span>
	<span class="cm">/* EBC = OPB / PERDV0 */</span>
	<span class="n">ebc</span> <span class="o">=</span> <span class="n">opb</span> <span class="o">/</span> <span class="n">perdv0</span><span class="p">;</span>

	<span class="n">tb</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">uart0</span> <span class="o">=</span> <span class="n">uart1</span> <span class="o">=</span> <span class="n">uart_clk</span><span class="p">;</span>

	<span class="n">dt_fixup_cpu_clocks</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb&quot;</span><span class="p">,</span> <span class="n">plb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb&quot;</span><span class="p">,</span> <span class="n">opb</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/ebc&quot;</span><span class="p">,</span> <span class="n">ebc</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600200&quot;</span><span class="p">,</span> <span class="n">uart0</span><span class="p">);</span>
	<span class="n">dt_fixup_clock</span><span class="p">(</span><span class="s">&quot;/plb/opb/serial@ef600300&quot;</span><span class="p">,</span> <span class="n">uart1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
