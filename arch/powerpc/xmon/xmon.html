<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › xmon › xmon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xmon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Routines providing a simple monitor for use on the PowerMac.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996-2005 Paul Mackerras.</span>
<span class="cm"> * Copyright (C) 2001 PPC64 Team, IBM Corp</span>
<span class="cm"> * Copyrignt (C) 2006 Michael Ellerman, IBM Corp</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/xmon.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/mmu.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/sstep.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>
<span class="cp">#include &lt;asm/spu.h&gt;</span>
<span class="cp">#include &lt;asm/spu_priv1.h&gt;</span>
<span class="cp">#include &lt;asm/setjmp.h&gt;</span>
<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#include &lt;asm/hvcall.h&gt;</span>
<span class="cp">#include &lt;asm/paca.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;nonstdio.h&quot;</span>
<span class="cp">#include &quot;dis-asm.h&quot;</span>

<span class="cp">#define scanhex	xmon_scanhex</span>
<span class="cp">#define skipbl	xmon_skipbl</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="n">cpumask_t</span> <span class="n">cpus_in_xmon</span> <span class="o">=</span> <span class="n">CPU_MASK_NONE</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xmon_taken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xmon_owner</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xmon_gate</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_xmon</span> <span class="n">__read_mostly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adrs</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#define MAX_DUMP (128 * 1024)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ndump</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nidump</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ncsum</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">termch</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">tmpstr</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">long</span> <span class="n">bus_error_jmp</span><span class="p">[</span><span class="n">JMP_BUF_LEN</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">catch_memory_errors</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="o">*</span><span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>

<span class="cm">/* Breakpoint stuff */</span>
<span class="k">struct</span> <span class="n">bpt</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">instr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">atomic_t</span>	<span class="n">ref_count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">enabled</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">pad</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Bits in bpt.enabled */</span>
<span class="cp">#define BP_IABR_TE	1		</span><span class="cm">/* IABR translation enabled */</span><span class="cp"></span>
<span class="cp">#define BP_IABR		2</span>
<span class="cp">#define BP_TRAP		8</span>
<span class="cp">#define BP_DABR		0x10</span>

<span class="cp">#define NBPTS	256</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="n">bpts</span><span class="p">[</span><span class="n">NBPTS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="n">dabr</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">iabr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">bpinstr</span> <span class="o">=</span> <span class="mh">0x7fe00008</span><span class="p">;</span>	<span class="cm">/* trap */</span>

<span class="cp">#define BP_NUM(bp)	((bp) - bpts + 1)</span>

<span class="cm">/* Prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mread</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mwrite</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">handle_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">byterev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">memex</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bsesc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dump</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_inst_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dump_log_buf</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">backtrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">excprint</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">memops</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">memlocate</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">memzcan</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">memdiffs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">skipbl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">scanhex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">valp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scannl</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hexdigit</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">getstring</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_input</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inchar</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">take_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">read_spr</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">write_spr</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">super_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">insert_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">remove_cpu_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">insert_cpu_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">at_breakpoint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">in_breakpoint_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">offp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">do_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bpt_cmds</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cacheflush</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">cpu_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">csum</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">bootcmds</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">proccall</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">dump_segments</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">symbol_lookup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">xmon_show_stack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">xmon_print_symbol</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mid</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">after</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getvecname</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vec</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_spu_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_44x</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dump_tlb_44x</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3E</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dump_tlb_book3e</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xmon_no_auto_backtrace</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">xmon_enter</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">xmon_leave</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#define REG		&quot;%.16lx&quot;</span>
<span class="cp">#define REGS_PER_LINE	4</span>
<span class="cp">#define LAST_VOLATILE	13</span>
<span class="cp">#else</span>
<span class="cp">#define REG		&quot;%.8lx&quot;</span>
<span class="cp">#define REGS_PER_LINE	8</span>
<span class="cp">#define LAST_VOLATILE	12</span>
<span class="cp">#endif</span>

<span class="cp">#define GETWORD(v)	(((v)[0] &lt;&lt; 24) + ((v)[1] &lt;&lt; 16) + ((v)[2] &lt;&lt; 8) + (v)[3])</span>

<span class="cp">#define isxdigit(c)	((&#39;0&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;9&#39;) \</span>
<span class="cp">			 || (&#39;a&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;f&#39;) \</span>
<span class="cp">			 || (&#39;A&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;F&#39;))</span>
<span class="cp">#define isalnum(c)	((&#39;0&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;9&#39;) \</span>
<span class="cp">			 || (&#39;a&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;z&#39;) \</span>
<span class="cp">			 || (&#39;A&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;Z&#39;))</span>
<span class="cp">#define isspace(c)	(c == &#39; &#39; || c == &#39;\t&#39; || c == 10 || c == 13 || c == 0)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">help_string</span> <span class="o">=</span> <span class="s">&quot;\</span>
<span class="s">Commands:</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  b	show breakpoints</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  bd	set data breakpoint</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  bi	set instruction breakpoint</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  bc	clear breakpoint</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
  <span class="s">&quot;\</span>
<span class="s">  c	print cpus stopped in xmon</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  c#	try to switch to cpu number h (in hex)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
  <span class="s">&quot;\</span>
<span class="s">  C	checksum</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  d	dump bytes</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  di	dump instructions</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  df	dump float values</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  dd	dump double values</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  dl    dump the kernel log buffer</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  dr	dump stream of raw bytes</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  e	print exception information</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  f	flush cache</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  la	lookup symbol+offset of specified address</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  ls	lookup address of specified symbol</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  m	examine/change memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  mm	move a block of memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  ms	set a block of memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  md	compare two blocks of memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  ml	locate a block of memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  mz	zero a block of memory</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  mi	show information about memory allocation</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  p 	call a procedure</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  r	print registers</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  s	single step</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#ifdef CONFIG_SPU_BASE</span>
<span class="s">&quot;  ss	stop execution on all spus</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  sr	restore execution on stopped spus</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  sf  #	dump spu fields for spu # (in hex)</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  sd  #	dump spu local store for spu # (in hex)</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  sdi #	disassemble spu local store for spu # (in hex)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
<span class="s">&quot;  S	print special registers</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  t	print backtrace</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  x	exit monitor and recover</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  X	exit monitor and dont recover</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#if defined(CONFIG_PPC64) &amp;&amp; !defined(CONFIG_PPC_BOOK3E)</span>
<span class="s">&quot;  u	dump segment table or SLB</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#elif defined(CONFIG_PPC_STD_MMU_32)</span>
<span class="s">&quot;  u	dump segment registers</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#elif defined(CONFIG_44x) || defined(CONFIG_PPC_BOOK3E)</span>
<span class="s">&quot;  u	dump TLB</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="cp">#endif</span>
<span class="s">&quot;  ?	help</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;  zr	reboot</span><span class="se">\n</span><span class="s">\</span>
<span class="s">  zh	halt</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">xmon_regs</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;sync; isync&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">store_inst</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;dcbst 0,%0; sync; icbi 0,%0; isync&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cflush</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;dcbf 0,%0; icbi 0,%0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cinval</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;dcbi 0,%0; icbi 0,%0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable surveillance (the service processor watchdog function)</span>
<span class="cm"> * while we are in xmon.</span>
<span class="cm"> * XXX we should re-enable it when we leave. :)</span>
<span class="cm"> */</span>
<span class="cp">#define SURVEILLANCE_TOKEN	9000</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_surveillance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_PSERIES</span>
	<span class="cm">/* Since this can&#39;t be a module, args should end up below 4GB. */</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">rtas_args</span> <span class="n">args</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point we have got all the cpus we can into</span>
<span class="cm">	 * xmon, so there is hopefully no other cpu calling RTAS</span>
<span class="cm">	 * at the moment, even though we don&#39;t take rtas.lock.</span>
<span class="cm">	 * If we did try to take rtas.lock there would be a</span>
<span class="cm">	 * real possibility of deadlock.</span>
<span class="cm">	 */</span>
	<span class="n">args</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;set-indicator&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">token</span> <span class="o">==</span> <span class="n">RTAS_UNKNOWN_SERVICE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nargs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">rets</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SURVEILLANCE_TOKEN</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enter_rtas</span><span class="p">(</span><span class="n">__pa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PSERIES */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">xmon_speaker</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_output_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">me</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">()</span> <span class="o">+</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_speaker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xmon_speaker</span> <span class="o">==</span> <span class="n">me</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xmon_speaker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">last_speaker</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xmon_speaker</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_speaker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">xmon_speaker</span> <span class="o">==</span> <span class="n">last_speaker</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* hostile takeover */</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xmon_speaker</span><span class="p">,</span> <span class="n">last_speaker</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">==</span> <span class="n">last_speaker</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_output_lock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xmon_speaker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cpus_are_in_xmon</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">cpumask_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">unrecoverable_excp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_4xx) || defined(CONFIG_PPC_BOOK3E)</span>
	<span class="cm">/* We have no MSR_RI bit on 4xx or Book3e, so we simply return false */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_RI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_core</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fromipi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">recurse_jmp</span><span class="p">[</span><span class="n">JMP_BUF_LEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">secondary</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">in_breakpoint_table</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">remove_cpu_bpts</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">get_output_lock</span><span class="p">();</span>
		<span class="n">excprint</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu 0x%x: Exception %lx %s in xmon, &quot;</span>
		       <span class="s">&quot;returning to main loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cpu</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">getvecname</span><span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">)));</span>
		<span class="n">release_output_lock</span><span class="p">();</span>
		<span class="n">longjmp</span><span class="p">(</span><span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">recurse_jmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_xmon</span> <span class="o">||</span> <span class="o">!</span><span class="n">xmon_gate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_output_lock</span><span class="p">();</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;xmon: WARNING: bad recursive fault &quot;</span>
			       <span class="s">&quot;on cpu 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="n">release_output_lock</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">waiting</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">secondary</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">xmon_taken</span> <span class="o">&amp;&amp;</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">xmon_owner</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">cmdloop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="n">recurse_jmp</span><span class="p">;</span>
	<span class="n">cpumask_set_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">);</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">||</span> <span class="n">unrecoverable_excp</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">fromipi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fromipi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_output_lock</span><span class="p">();</span>
		<span class="n">excprint</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu 0x%x stopped at breakpoint 0x%x (&quot;</span><span class="p">,</span>
			       <span class="n">cpu</span><span class="p">,</span> <span class="n">BP_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
			<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unrecoverable_excp</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: exception is not recoverable, &quot;</span>
			       <span class="s">&quot;can&#39;t continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">release_output_lock</span><span class="p">();</span>
	<span class="p">}</span>

 <span class="nl">waiting:</span>
	<span class="n">secondary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">secondary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xmon_gate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_xmon</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fromipi</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
			<span class="n">secondary</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_xmon</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">secondary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xmon_gate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are the first cpu to come in */</span>
		<span class="cm">/* interrupt other cpu(s) */</span>
		<span class="kt">int</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>

		<span class="n">xmon_owner</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smp_send_debugger_break</span><span class="p">();</span>
			<span class="cm">/* wait for other cpus to come in */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000000</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_weight</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ncpus</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">barrier</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">remove_bpts</span><span class="p">();</span>
		<span class="n">disable_surveillance</span><span class="p">();</span>
		<span class="cm">/* for breakpoint or single step, print the current instr. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">||</span> <span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd00</span><span class="p">)</span>
			<span class="n">ppc_inst_dump</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;enter ? for help</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">xmon_gate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>

 <span class="nl">cmdloop:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">in_xmon</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secondary</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">xmon_owner</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmon_taken</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">secondary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* missed it */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">xmon_owner</span><span class="p">)</span>
					<span class="n">barrier</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">barrier</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* exiting xmon */</span>
				<span class="n">insert_bpts</span><span class="p">();</span>
				<span class="n">xmon_gate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">wmb</span><span class="p">();</span>
				<span class="n">in_xmon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* have switched to some other cpu */</span>
			<span class="n">secondary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">leave:</span>
	<span class="n">cpumask_clear_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">);</span>
	<span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="n">cpu</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* UP is simple... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_xmon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Exception %lx %s in xmon, returning to main loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">getvecname</span><span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">)));</span>
		<span class="n">longjmp</span><span class="p">(</span><span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">recurse_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xmon_fault_jmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">recurse_jmp</span><span class="p">;</span>
		<span class="n">in_xmon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">excprint</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Stopped at breakpoint %x (&quot;</span><span class="p">,</span> <span class="n">BP_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
			<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unrecoverable_excp</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;WARNING: exception is not recoverable, &quot;</span>
			       <span class="s">&quot;can&#39;t continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">remove_bpts</span><span class="p">();</span>
		<span class="n">disable_surveillance</span><span class="p">();</span>
		<span class="cm">/* for breakpoint or single step, print the current instr. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">||</span> <span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xd00</span><span class="p">)</span>
			<span class="n">ppc_inst_dump</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;enter ? for help</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">insert_bpts</span><span class="p">();</span>
	<span class="n">in_xmon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">stepped</span> <span class="o">=</span> <span class="n">emulate_step</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stepped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stepped</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t single-step %s instruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">IS_RFID</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">?</span> <span class="s">&quot;rfid&quot;</span><span class="o">:</span> <span class="s">&quot;mtmsrd&quot;</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">insert_cpu_bpts</span><span class="p">();</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="sc">&#39;X&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">xmon</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">excp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">excp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc_save_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">excp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xmon_core</span><span class="p">(</span><span class="n">excp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">xmon</span><span class="p">);</span>

<span class="n">irqreturn_t</span> <span class="nf">xmon_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Keyboard interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">xmon</span><span class="p">(</span><span class="n">get_irq_regs</span><span class="p">());</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_bpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Are we at the trap at bp-&gt;instr[1] for some bp? */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">in_breakpoint_table</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Are we at a breakpoint? */</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xmon_core</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_sstep</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xmon_core</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_dabr_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xmon_core</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_iabr_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iabr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">xmon_core</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_xmon</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">))</span>
		<span class="n">xmon_core</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">xmon_fault_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_xmon</span> <span class="o">&amp;&amp;</span> <span class="n">catch_memory_errors</span><span class="p">)</span>
		<span class="n">handle_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>	<span class="cm">/* doesn&#39;t return */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_64BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">in_breakpoint_table</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="nf">at_breakpoint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">bpts</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBPTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">bp</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">pc</span> <span class="o">==</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="nf">in_breakpoint_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">offp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">nip</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bpts</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bpts</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">%=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpt</span><span class="p">,</span> <span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	    <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpt</span><span class="p">,</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">offp</span> <span class="o">=</span> <span class="n">off</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpt</span><span class="p">,</span> <span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">nip</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="nf">new_breakpoint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3UL</span><span class="p">;</span>
	<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bp</span> <span class="o">=</span> <span class="n">bpts</span><span class="p">;</span> <span class="n">bp</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">bpts</span><span class="p">[</span><span class="n">NBPTS</span><span class="p">];</span> <span class="o">++</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpinstr</span><span class="p">;</span>
			<span class="n">store_inst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">bp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Sorry, no free breakpoints.  Please clear one first.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">bpts</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBPTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BP_TRAP</span><span class="o">|</span><span class="n">BP_IABR</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t read instruction at %lx, &quot;</span>
			       <span class="s">&quot;disabling breakpoint there</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_MTMSRD</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="n">IS_RFID</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Breakpoint at %lx is on an mtmsrd or rfid &quot;</span>
			       <span class="s">&quot;instruction, disabling it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">store_inst</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="n">BP_IABR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwrite</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bpinstr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t write instruction at %lx, &quot;</span>
			       <span class="s">&quot;disabling breakpoint there</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BP_TRAP</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">store_inst</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_cpu_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">set_dabr</span><span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">address</span> <span class="o">|</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iabr</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_IABR</span><span class="p">))</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_IABR</span><span class="p">,</span> <span class="n">iabr</span><span class="o">-&gt;</span><span class="n">address</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">iabr</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BP_IABR</span><span class="o">|</span><span class="n">BP_IABR_TE</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">instr</span><span class="p">;</span>

	<span class="n">bp</span> <span class="o">=</span> <span class="n">bpts</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBPTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BP_TRAP</span><span class="o">|</span><span class="n">BP_IABR</span><span class="p">))</span> <span class="o">!=</span> <span class="n">BP_TRAP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
		    <span class="o">&amp;&amp;</span> <span class="n">instr</span> <span class="o">==</span> <span class="n">bpinstr</span>
		    <span class="o">&amp;&amp;</span> <span class="n">mwrite</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t remove breakpoint at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">store_inst</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_cpu_bpts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_dabr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_IABR</span><span class="p">))</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_IABR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Command interpreting routine */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last_cmd</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">excp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">last_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">xmon_regs</span> <span class="o">=</span> <span class="n">excp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xmon_no_auto_backtrace</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xmon_no_auto_backtrace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xmon_show_stack</span><span class="p">(</span><span class="n">excp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">excp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">excp</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x:&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;mon&gt; &quot;</span><span class="p">);</span>
		<span class="n">flush_input</span><span class="p">();</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">take_input</span><span class="p">(</span><span class="n">last_cmd</span><span class="p">);</span>
			<span class="n">last_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
				<span class="n">memops</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
				<span class="n">memlocate</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
				<span class="n">memzcan</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
				<span class="n">show_mem</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
				<span class="n">memex</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="n">dump</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="n">symbol_lookup</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
			<span class="n">prregs</span><span class="p">(</span><span class="n">excp</span><span class="p">);</span>	<span class="cm">/* print regs */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
			<span class="n">excprint</span><span class="p">(</span><span class="n">excp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
			<span class="n">super_regs</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
			<span class="n">backtrace</span><span class="p">(</span><span class="n">excp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="n">cacheflush</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">do_spu_cmd</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_step</span><span class="p">(</span><span class="n">excp</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
			<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EOF</span>:
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; &lt;no input ...&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">xmon_puts</span><span class="p">(</span><span class="n">help_string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="n">bpt_cmds</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;C&#39;</span>:
			<span class="n">csum</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu_cmd</span><span class="p">())</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;z&#39;</span>:
			<span class="n">bootcmds</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span>:
			<span class="n">proccall</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_STD_MMU</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="n">dump_segments</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_4xx)</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="n">dump_tlb_44x</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_PPC_BOOK3E)</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
			<span class="n">dump_tlb_book3e</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unrecognized command: &quot;</span><span class="p">);</span>
		        <span class="k">do</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="sc">&#39; &#39;</span> <span class="o">&lt;</span> <span class="n">cmd</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span><span class="p">)</span>
					<span class="n">putchar</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span> 
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; (type ? for help)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BOOKE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_DE</span><span class="p">;</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBCR0_IC</span> <span class="o">|</span> <span class="n">DBCR0_IDM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cm">/*</span>
<span class="cm"> * Step a single instruction.</span>
<span class="cm"> * Some instructions we emulate, others we execute with MSR_SE set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stepped</span><span class="p">;</span>

	<span class="cm">/* check we are in 64-bit kernel mode, translation enabled */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_64BIT</span><span class="o">|</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_IR</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="n">MSR_64BIT</span><span class="o">|</span><span class="n">MSR_IR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stepped</span> <span class="o">=</span> <span class="n">emulate_step</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">instr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stepped</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t single-step %s instruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">IS_RFID</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;rfid&quot;</span><span class="o">:</span> <span class="s">&quot;mtmsrd&quot;</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stepped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span> <span class="o">=</span> <span class="mh">0xd00</span> <span class="o">|</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;stepped to &quot;</span><span class="p">);</span>
				<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ppc_inst_dump</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_SE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bootcmds</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">restart</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">halt</span><span class="p">();</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;p&#39;</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">power_off</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cpu_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* print cpus waiting or in xmon */</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpus stopped:&quot;</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %x&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
				<span class="o">++</span><span class="n">count</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;-%x&quot;</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;-%x&quot;</span><span class="p">,</span> <span class="n">NR_CPUS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* try to switch to cpu specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpumask_test_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpus_in_xmon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu 0x%x isn&#39;t in xmon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xmon_taken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">xmon_owner</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">xmon_taken</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xmon_taken</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* take control back */</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="n">xmon_owner</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu %u didn&#39;t take control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fcstab</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x1189</span><span class="p">,</span> <span class="mh">0x2312</span><span class="p">,</span> <span class="mh">0x329b</span><span class="p">,</span> <span class="mh">0x4624</span><span class="p">,</span> <span class="mh">0x57ad</span><span class="p">,</span> <span class="mh">0x6536</span><span class="p">,</span> <span class="mh">0x74bf</span><span class="p">,</span>
	<span class="mh">0x8c48</span><span class="p">,</span> <span class="mh">0x9dc1</span><span class="p">,</span> <span class="mh">0xaf5a</span><span class="p">,</span> <span class="mh">0xbed3</span><span class="p">,</span> <span class="mh">0xca6c</span><span class="p">,</span> <span class="mh">0xdbe5</span><span class="p">,</span> <span class="mh">0xe97e</span><span class="p">,</span> <span class="mh">0xf8f7</span><span class="p">,</span>
	<span class="mh">0x1081</span><span class="p">,</span> <span class="mh">0x0108</span><span class="p">,</span> <span class="mh">0x3393</span><span class="p">,</span> <span class="mh">0x221a</span><span class="p">,</span> <span class="mh">0x56a5</span><span class="p">,</span> <span class="mh">0x472c</span><span class="p">,</span> <span class="mh">0x75b7</span><span class="p">,</span> <span class="mh">0x643e</span><span class="p">,</span>
	<span class="mh">0x9cc9</span><span class="p">,</span> <span class="mh">0x8d40</span><span class="p">,</span> <span class="mh">0xbfdb</span><span class="p">,</span> <span class="mh">0xae52</span><span class="p">,</span> <span class="mh">0xdaed</span><span class="p">,</span> <span class="mh">0xcb64</span><span class="p">,</span> <span class="mh">0xf9ff</span><span class="p">,</span> <span class="mh">0xe876</span><span class="p">,</span>
	<span class="mh">0x2102</span><span class="p">,</span> <span class="mh">0x308b</span><span class="p">,</span> <span class="mh">0x0210</span><span class="p">,</span> <span class="mh">0x1399</span><span class="p">,</span> <span class="mh">0x6726</span><span class="p">,</span> <span class="mh">0x76af</span><span class="p">,</span> <span class="mh">0x4434</span><span class="p">,</span> <span class="mh">0x55bd</span><span class="p">,</span>
	<span class="mh">0xad4a</span><span class="p">,</span> <span class="mh">0xbcc3</span><span class="p">,</span> <span class="mh">0x8e58</span><span class="p">,</span> <span class="mh">0x9fd1</span><span class="p">,</span> <span class="mh">0xeb6e</span><span class="p">,</span> <span class="mh">0xfae7</span><span class="p">,</span> <span class="mh">0xc87c</span><span class="p">,</span> <span class="mh">0xd9f5</span><span class="p">,</span>
	<span class="mh">0x3183</span><span class="p">,</span> <span class="mh">0x200a</span><span class="p">,</span> <span class="mh">0x1291</span><span class="p">,</span> <span class="mh">0x0318</span><span class="p">,</span> <span class="mh">0x77a7</span><span class="p">,</span> <span class="mh">0x662e</span><span class="p">,</span> <span class="mh">0x54b5</span><span class="p">,</span> <span class="mh">0x453c</span><span class="p">,</span>
	<span class="mh">0xbdcb</span><span class="p">,</span> <span class="mh">0xac42</span><span class="p">,</span> <span class="mh">0x9ed9</span><span class="p">,</span> <span class="mh">0x8f50</span><span class="p">,</span> <span class="mh">0xfbef</span><span class="p">,</span> <span class="mh">0xea66</span><span class="p">,</span> <span class="mh">0xd8fd</span><span class="p">,</span> <span class="mh">0xc974</span><span class="p">,</span>
	<span class="mh">0x4204</span><span class="p">,</span> <span class="mh">0x538d</span><span class="p">,</span> <span class="mh">0x6116</span><span class="p">,</span> <span class="mh">0x709f</span><span class="p">,</span> <span class="mh">0x0420</span><span class="p">,</span> <span class="mh">0x15a9</span><span class="p">,</span> <span class="mh">0x2732</span><span class="p">,</span> <span class="mh">0x36bb</span><span class="p">,</span>
	<span class="mh">0xce4c</span><span class="p">,</span> <span class="mh">0xdfc5</span><span class="p">,</span> <span class="mh">0xed5e</span><span class="p">,</span> <span class="mh">0xfcd7</span><span class="p">,</span> <span class="mh">0x8868</span><span class="p">,</span> <span class="mh">0x99e1</span><span class="p">,</span> <span class="mh">0xab7a</span><span class="p">,</span> <span class="mh">0xbaf3</span><span class="p">,</span>
	<span class="mh">0x5285</span><span class="p">,</span> <span class="mh">0x430c</span><span class="p">,</span> <span class="mh">0x7197</span><span class="p">,</span> <span class="mh">0x601e</span><span class="p">,</span> <span class="mh">0x14a1</span><span class="p">,</span> <span class="mh">0x0528</span><span class="p">,</span> <span class="mh">0x37b3</span><span class="p">,</span> <span class="mh">0x263a</span><span class="p">,</span>
	<span class="mh">0xdecd</span><span class="p">,</span> <span class="mh">0xcf44</span><span class="p">,</span> <span class="mh">0xfddf</span><span class="p">,</span> <span class="mh">0xec56</span><span class="p">,</span> <span class="mh">0x98e9</span><span class="p">,</span> <span class="mh">0x8960</span><span class="p">,</span> <span class="mh">0xbbfb</span><span class="p">,</span> <span class="mh">0xaa72</span><span class="p">,</span>
	<span class="mh">0x6306</span><span class="p">,</span> <span class="mh">0x728f</span><span class="p">,</span> <span class="mh">0x4014</span><span class="p">,</span> <span class="mh">0x519d</span><span class="p">,</span> <span class="mh">0x2522</span><span class="p">,</span> <span class="mh">0x34ab</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span> <span class="mh">0x17b9</span><span class="p">,</span>
	<span class="mh">0xef4e</span><span class="p">,</span> <span class="mh">0xfec7</span><span class="p">,</span> <span class="mh">0xcc5c</span><span class="p">,</span> <span class="mh">0xddd5</span><span class="p">,</span> <span class="mh">0xa96a</span><span class="p">,</span> <span class="mh">0xb8e3</span><span class="p">,</span> <span class="mh">0x8a78</span><span class="p">,</span> <span class="mh">0x9bf1</span><span class="p">,</span>
	<span class="mh">0x7387</span><span class="p">,</span> <span class="mh">0x620e</span><span class="p">,</span> <span class="mh">0x5095</span><span class="p">,</span> <span class="mh">0x411c</span><span class="p">,</span> <span class="mh">0x35a3</span><span class="p">,</span> <span class="mh">0x242a</span><span class="p">,</span> <span class="mh">0x16b1</span><span class="p">,</span> <span class="mh">0x0738</span><span class="p">,</span>
	<span class="mh">0xffcf</span><span class="p">,</span> <span class="mh">0xee46</span><span class="p">,</span> <span class="mh">0xdcdd</span><span class="p">,</span> <span class="mh">0xcd54</span><span class="p">,</span> <span class="mh">0xb9eb</span><span class="p">,</span> <span class="mh">0xa862</span><span class="p">,</span> <span class="mh">0x9af9</span><span class="p">,</span> <span class="mh">0x8b70</span><span class="p">,</span>
	<span class="mh">0x8408</span><span class="p">,</span> <span class="mh">0x9581</span><span class="p">,</span> <span class="mh">0xa71a</span><span class="p">,</span> <span class="mh">0xb693</span><span class="p">,</span> <span class="mh">0xc22c</span><span class="p">,</span> <span class="mh">0xd3a5</span><span class="p">,</span> <span class="mh">0xe13e</span><span class="p">,</span> <span class="mh">0xf0b7</span><span class="p">,</span>
	<span class="mh">0x0840</span><span class="p">,</span> <span class="mh">0x19c9</span><span class="p">,</span> <span class="mh">0x2b52</span><span class="p">,</span> <span class="mh">0x3adb</span><span class="p">,</span> <span class="mh">0x4e64</span><span class="p">,</span> <span class="mh">0x5fed</span><span class="p">,</span> <span class="mh">0x6d76</span><span class="p">,</span> <span class="mh">0x7cff</span><span class="p">,</span>
	<span class="mh">0x9489</span><span class="p">,</span> <span class="mh">0x8500</span><span class="p">,</span> <span class="mh">0xb79b</span><span class="p">,</span> <span class="mh">0xa612</span><span class="p">,</span> <span class="mh">0xd2ad</span><span class="p">,</span> <span class="mh">0xc324</span><span class="p">,</span> <span class="mh">0xf1bf</span><span class="p">,</span> <span class="mh">0xe036</span><span class="p">,</span>
	<span class="mh">0x18c1</span><span class="p">,</span> <span class="mh">0x0948</span><span class="p">,</span> <span class="mh">0x3bd3</span><span class="p">,</span> <span class="mh">0x2a5a</span><span class="p">,</span> <span class="mh">0x5ee5</span><span class="p">,</span> <span class="mh">0x4f6c</span><span class="p">,</span> <span class="mh">0x7df7</span><span class="p">,</span> <span class="mh">0x6c7e</span><span class="p">,</span>
	<span class="mh">0xa50a</span><span class="p">,</span> <span class="mh">0xb483</span><span class="p">,</span> <span class="mh">0x8618</span><span class="p">,</span> <span class="mh">0x9791</span><span class="p">,</span> <span class="mh">0xe32e</span><span class="p">,</span> <span class="mh">0xf2a7</span><span class="p">,</span> <span class="mh">0xc03c</span><span class="p">,</span> <span class="mh">0xd1b5</span><span class="p">,</span>
	<span class="mh">0x2942</span><span class="p">,</span> <span class="mh">0x38cb</span><span class="p">,</span> <span class="mh">0x0a50</span><span class="p">,</span> <span class="mh">0x1bd9</span><span class="p">,</span> <span class="mh">0x6f66</span><span class="p">,</span> <span class="mh">0x7eef</span><span class="p">,</span> <span class="mh">0x4c74</span><span class="p">,</span> <span class="mh">0x5dfd</span><span class="p">,</span>
	<span class="mh">0xb58b</span><span class="p">,</span> <span class="mh">0xa402</span><span class="p">,</span> <span class="mh">0x9699</span><span class="p">,</span> <span class="mh">0x8710</span><span class="p">,</span> <span class="mh">0xf3af</span><span class="p">,</span> <span class="mh">0xe226</span><span class="p">,</span> <span class="mh">0xd0bd</span><span class="p">,</span> <span class="mh">0xc134</span><span class="p">,</span>
	<span class="mh">0x39c3</span><span class="p">,</span> <span class="mh">0x284a</span><span class="p">,</span> <span class="mh">0x1ad1</span><span class="p">,</span> <span class="mh">0x0b58</span><span class="p">,</span> <span class="mh">0x7fe7</span><span class="p">,</span> <span class="mh">0x6e6e</span><span class="p">,</span> <span class="mh">0x5cf5</span><span class="p">,</span> <span class="mh">0x4d7c</span><span class="p">,</span>
	<span class="mh">0xc60c</span><span class="p">,</span> <span class="mh">0xd785</span><span class="p">,</span> <span class="mh">0xe51e</span><span class="p">,</span> <span class="mh">0xf497</span><span class="p">,</span> <span class="mh">0x8028</span><span class="p">,</span> <span class="mh">0x91a1</span><span class="p">,</span> <span class="mh">0xa33a</span><span class="p">,</span> <span class="mh">0xb2b3</span><span class="p">,</span>
	<span class="mh">0x4a44</span><span class="p">,</span> <span class="mh">0x5bcd</span><span class="p">,</span> <span class="mh">0x6956</span><span class="p">,</span> <span class="mh">0x78df</span><span class="p">,</span> <span class="mh">0x0c60</span><span class="p">,</span> <span class="mh">0x1de9</span><span class="p">,</span> <span class="mh">0x2f72</span><span class="p">,</span> <span class="mh">0x3efb</span><span class="p">,</span>
	<span class="mh">0xd68d</span><span class="p">,</span> <span class="mh">0xc704</span><span class="p">,</span> <span class="mh">0xf59f</span><span class="p">,</span> <span class="mh">0xe416</span><span class="p">,</span> <span class="mh">0x90a9</span><span class="p">,</span> <span class="mh">0x8120</span><span class="p">,</span> <span class="mh">0xb3bb</span><span class="p">,</span> <span class="mh">0xa232</span><span class="p">,</span>
	<span class="mh">0x5ac5</span><span class="p">,</span> <span class="mh">0x4b4c</span><span class="p">,</span> <span class="mh">0x79d7</span><span class="p">,</span> <span class="mh">0x685e</span><span class="p">,</span> <span class="mh">0x1ce1</span><span class="p">,</span> <span class="mh">0x0d68</span><span class="p">,</span> <span class="mh">0x3ff3</span><span class="p">,</span> <span class="mh">0x2e7a</span><span class="p">,</span>
	<span class="mh">0xe70e</span><span class="p">,</span> <span class="mh">0xf687</span><span class="p">,</span> <span class="mh">0xc41c</span><span class="p">,</span> <span class="mh">0xd595</span><span class="p">,</span> <span class="mh">0xa12a</span><span class="p">,</span> <span class="mh">0xb0a3</span><span class="p">,</span> <span class="mh">0x8238</span><span class="p">,</span> <span class="mh">0x93b1</span><span class="p">,</span>
	<span class="mh">0x6b46</span><span class="p">,</span> <span class="mh">0x7acf</span><span class="p">,</span> <span class="mh">0x4854</span><span class="p">,</span> <span class="mh">0x59dd</span><span class="p">,</span> <span class="mh">0x2d62</span><span class="p">,</span> <span class="mh">0x3ceb</span><span class="p">,</span> <span class="mh">0x0e70</span><span class="p">,</span> <span class="mh">0x1ff9</span><span class="p">,</span>
	<span class="mh">0xf78f</span><span class="p">,</span> <span class="mh">0xe606</span><span class="p">,</span> <span class="mh">0xd49d</span><span class="p">,</span> <span class="mh">0xc514</span><span class="p">,</span> <span class="mh">0xb1ab</span><span class="p">,</span> <span class="mh">0xa022</span><span class="p">,</span> <span class="mh">0x92b9</span><span class="p">,</span> <span class="mh">0x8330</span><span class="p">,</span>
	<span class="mh">0x7bc7</span><span class="p">,</span> <span class="mh">0x6a4e</span><span class="p">,</span> <span class="mh">0x58d5</span><span class="p">,</span> <span class="mh">0x495c</span><span class="p">,</span> <span class="mh">0x3de3</span><span class="p">,</span> <span class="mh">0x2c6a</span><span class="p">,</span> <span class="mh">0x1ef1</span><span class="p">,</span> <span class="mh">0x0f78</span>
<span class="p">};</span>

<span class="cp">#define FCS(fcs, c)	(((fcs) &gt;&gt; 8) ^ fcstab[((fcs) ^ (c)) &amp; 0xff])</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">csum</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncsum</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fcs</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncsum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">adrs</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;csum stopped at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adrs</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fcs</span> <span class="o">=</span> <span class="n">FCS</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if this is a suitable place to put a breakpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">check_bp_loc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Breakpoints may only be placed at kernel addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mread</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">instr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">instr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Can&#39;t read instruction at address %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MTMSRD</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_RFID</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Breakpoints may not be placed on mtmsrd or rfid &quot;</span>
		       <span class="s">&quot;instructions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">breakpoint_help_string</span> <span class="o">=</span> 
    <span class="s">&quot;Breakpoint command usage:</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;b                show breakpoints</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;b &lt;addr&gt; [cnt]   set breakpoint at given instr addr</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;bc               clear all breakpoints</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;bc &lt;n/addr&gt;      clear breakpoint number n or at addr</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;bi &lt;addr&gt; [cnt]  set hardware instr breakpoint (POWER3/RS64 only)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;bd &lt;addr&gt; [cnt]  set hardware data breakpoint</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bpt_cmds</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bpt</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">badaddr</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Only kernel addresses are permitted &quot;</span>
		<span class="s">&quot;for breakpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_8xx</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:	<span class="cm">/* bd - hardware data breakpoint */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">dabr</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dabr</span><span class="p">.</span><span class="n">address</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">address</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">badaddr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dabr</span><span class="p">.</span><span class="n">address</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
			<span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">BP_DABR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:	<span class="cm">/* bi - hardware instr breakpoint */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_IABR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hardware instruction breakpoint &quot;</span>
			       <span class="s">&quot;not supported on this cpu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iabr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iabr</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BP_IABR</span> <span class="o">|</span> <span class="n">BP_IABR_TE</span><span class="p">);</span>
			<span class="n">iabr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_bp_loc</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">new_breakpoint</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">|=</span> <span class="n">BP_IABR</span> <span class="o">|</span> <span class="n">BP_IABR_TE</span><span class="p">;</span>
			<span class="n">iabr</span> <span class="o">=</span> <span class="n">bp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* clear all breakpoints */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBPTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">bpts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">iabr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;All breakpoints cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="n">NBPTS</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* assume a breakpoint number */</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bpts</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* bp nums are 1 based */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* assume a breakpoint address */</span>
			<span class="n">bp</span> <span class="o">=</span> <span class="n">at_breakpoint</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;No breakpoint at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cleared breakpoint %x (&quot;</span><span class="p">,</span> <span class="n">BP_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">));</span>
		<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	        <span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">breakpoint_help_string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* print all breakpoints */</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;   type            address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;   data   &quot;</span><span class="n">REG</span><span class="s">&quot;  [&quot;</span><span class="p">,</span> <span class="n">dabr</span><span class="p">.</span><span class="n">address</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dabr</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;w&quot;</span><span class="p">);</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bp</span> <span class="o">=</span> <span class="n">bpts</span><span class="p">;</span> <span class="n">bp</span> <span class="o">&lt;</span> <span class="o">&amp;</span><span class="n">bpts</span><span class="p">[</span><span class="n">NBPTS</span><span class="p">];</span> <span class="o">++</span><span class="n">bp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%2x %s   &quot;</span><span class="p">,</span> <span class="n">BP_NUM</span><span class="p">(</span><span class="n">bp</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="n">BP_IABR</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;inst&quot;</span><span class="o">:</span> <span class="s">&quot;trap&quot;</span><span class="p">);</span>
				<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">bp</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_bp_loc</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">new_breakpoint</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">bp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">|=</span> <span class="n">BP_TRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Very cheap human name for vector lookup. */</span>
<span class="k">static</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getvecname</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x100</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(System Reset)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x200</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Machine Check)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Data Access)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x380</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Data SLB Access)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x400</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Instruction Access)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x480</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Instruction SLB Access)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x500</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Hardware Interrupt)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x600</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Alignment)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x700</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Program Check)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x800</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(FPU Unavailable)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x900</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Decrementer)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xc00</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(System Call)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xd00</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Single Step)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf00</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Performance Monitor)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xf20</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Altivec Unavailable)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1300</span>:	<span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;(Instruction Breakpoint)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">ret</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_function_bounds</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">startp</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">endp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="o">*</span><span class="n">startp</span> <span class="o">=</span> <span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">kallsyms_lookup</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tmpstr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">startp</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sync</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">xmon_depth_to_print</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

<span class="cp">#define LRSAVE_OFFSET		(STACK_FRAME_LR_SAVE * sizeof(unsigned long))</span>
<span class="cp">#define MARKER_OFFSET		(STACK_FRAME_MARKER * sizeof(unsigned long))</span>

<span class="cp">#ifdef __powerpc64__</span>
<span class="cp">#define REGS_OFFSET		0x70</span>
<span class="cp">#else</span>
<span class="cp">#define REGS_OFFSET		16</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmon_show_stack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">marker</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;SP (%lx) is in userspace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mread</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="n">LRSAVE_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">mread</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newsp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t read stack frame at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For the first stack frame, try to work out if</span>
<span class="cm">		 * LR and/or the saved LR value in the bottommost</span>
<span class="cm">		 * stack frame are valid.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">|</span> <span class="n">lr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fnstart</span><span class="p">,</span> <span class="n">fnend</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nextip</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">printip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">get_function_bounds</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnstart</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fnend</span><span class="p">);</span>
			<span class="n">nextip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">newsp</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="p">)</span>
				<span class="n">mread</span><span class="p">(</span><span class="n">newsp</span> <span class="o">+</span> <span class="n">LRSAVE_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nextip</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">&lt;</span> <span class="n">PAGE_OFFSET</span>
				    <span class="o">||</span> <span class="p">(</span><span class="n">fnstart</span> <span class="o">&lt;=</span> <span class="n">lr</span> <span class="o">&amp;&amp;</span> <span class="n">lr</span> <span class="o">&lt;</span> <span class="n">fnend</span><span class="p">))</span>
					<span class="n">printip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">==</span> <span class="n">nextip</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lr</span> <span class="o">&gt;=</span> <span class="n">PAGE_OFFSET</span>
				   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fnstart</span> <span class="o">&lt;=</span> <span class="n">lr</span> <span class="o">&amp;&amp;</span> <span class="n">lr</span> <span class="o">&lt;</span> <span class="n">fnend</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;[link register   ] &quot;</span><span class="p">);</span>
				<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">printip</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="n">REG</span><span class="s">&quot;] &quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
				<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot; (unreliable)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pc</span> <span class="o">=</span> <span class="n">lr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;[&quot;</span><span class="n">REG</span><span class="s">&quot;] &quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
			<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Look for &quot;regshere&quot; marker to see if this is</span>
<span class="cm">		   an exception frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="n">MARKER_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">marker</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="n">marker</span> <span class="o">==</span> <span class="n">STACK_FRAME_REGS_MARKER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">sp</span> <span class="o">+</span> <span class="n">REGS_OFFSET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t read registers at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">sp</span> <span class="o">+</span> <span class="n">REGS_OFFSET</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;--- Exception: %lx %s at &quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">trap</span><span class="p">,</span>
			       <span class="n">getvecname</span><span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)));</span>
			<span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">nip</span><span class="p">;</span>
			<span class="n">lr</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">link</span><span class="p">;</span>
			<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">newsp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sp</span> <span class="o">=</span> <span class="n">newsp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">xmon_depth_to_print</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">backtrace</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">excp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">))</span>
		<span class="n">xmon_show_stack</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">xmon_show_stack</span><span class="p">(</span><span class="n">excp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">excp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">excp</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">scannl</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_bug_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BUG</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bug_entry</span> <span class="o">*</span><span class="n">bug</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* not in kernel */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">;</span>	<span class="cm">/* address of trap instruction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PAGE_OFFSET</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bug</span> <span class="o">=</span> <span class="n">find_bug</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bug</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_warning_bug</span><span class="p">(</span><span class="n">bug</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_DEBUG_BUGVERBOSE</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;kernel BUG at %s:%u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bug</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">bug</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;kernel BUG at %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">bug</span><span class="o">-&gt;</span><span class="n">bug_addr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">excprint</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trap</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cpu 0x%x: &quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

	<span class="n">trap</span> <span class="o">=</span> <span class="n">TRAP</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Vector: %lx %s at [%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">getvecname</span><span class="p">(</span><span class="n">trap</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;    pc: &quot;</span><span class="p">);</span>
	<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;    lr: &quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;    sp: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;   msr: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">==</span> <span class="mh">0x300</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">==</span> <span class="mh">0x380</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">==</span> <span class="mh">0x600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;   dar: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">!=</span> <span class="mh">0x380</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; dsisr: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">dsisr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  current = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  paca    = 0x%lx</span><span class="se">\t</span><span class="s"> softe: %d</span><span class="se">\t</span><span class="s"> irq_happened: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">local_paca</span><span class="p">,</span> <span class="n">local_paca</span><span class="o">-&gt;</span><span class="n">soft_enabled</span><span class="p">,</span> <span class="n">local_paca</span><span class="o">-&gt;</span><span class="n">irq_happened</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;    pid   = %ld, comm = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">==</span> <span class="mh">0x700</span><span class="p">)</span>
		<span class="n">print_bug_trap</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">trap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>
			<span class="n">regs</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>
			<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error reading registers from &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">base</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FULL_REGS</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;R%.2ld = &quot;</span><span class="n">REG</span><span class="s">&quot;   R%.2ld = &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">n</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">n</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">16</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;R%.2ld = &quot;</span><span class="n">REG</span><span class="s">&quot;   R%.2ld = &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">n</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">n</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;R%.2d = %.8x%s&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
		       <span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="o">?</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">:</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FULL_REGS</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;pc  = &quot;</span><span class="p">);</span>
	<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xc00</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_CFAR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;cfar= &quot;</span><span class="p">);</span>
		<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">orig_gpr3</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;lr  = &quot;</span><span class="p">);</span>
	<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;msr = &quot;</span><span class="n">REG</span><span class="s">&quot;   cr  = %.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;ctr = &quot;</span><span class="n">REG</span><span class="s">&quot;   xer = &quot;</span><span class="n">REG</span><span class="s">&quot;   trap = %4lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">xer</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">);</span>
	<span class="n">trap</span> <span class="o">=</span> <span class="n">TRAP</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trap</span> <span class="o">==</span> <span class="mh">0x300</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">==</span> <span class="mh">0x380</span> <span class="o">||</span> <span class="n">trap</span> <span class="o">==</span> <span class="mh">0x600</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dar = &quot;</span><span class="n">REG</span><span class="s">&quot;   dsisr = %.8lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">dsisr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cacheflush</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nflush</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="sc">&#39;i&#39;</span><span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nflush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nflush</span><span class="p">);</span>
	<span class="n">nflush</span> <span class="o">=</span> <span class="p">(</span><span class="n">nflush</span> <span class="o">+</span> <span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">L1_CACHE_BYTES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="sc">&#39;i&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">nflush</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">nflush</span><span class="p">,</span> <span class="n">adrs</span> <span class="o">+=</span> <span class="n">L1_CACHE_BYTES</span><span class="p">)</span>
				<span class="n">cflush</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">adrs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">nflush</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">nflush</span><span class="p">,</span> <span class="n">adrs</span> <span class="o">+=</span> <span class="n">L1_CACHE_BYTES</span><span class="p">)</span>
				<span class="n">cinval</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">adrs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">read_spr</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">code</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">opd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">instrs</span><span class="p">;</span>
	<span class="n">opd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">opd</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">instrs</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* mfspr r3,n; blr */</span>
	<span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7c6002a6</span> <span class="o">+</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x3e0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4e800020</span><span class="p">;</span>
	<span class="n">store_inst</span><span class="p">(</span><span class="n">instrs</span><span class="p">);</span>
	<span class="n">store_inst</span><span class="p">(</span><span class="n">instrs</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">code</span><span class="p">();</span>

		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_spr</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instrs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">code</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">opd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">instrs</span><span class="p">;</span>
	<span class="n">opd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">opd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">opd</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span> <span class="n">instrs</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">instrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7c6003a6</span> <span class="o">+</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mh">0x3e0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">instrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x4e800020</span><span class="p">;</span>
	<span class="n">store_inst</span><span class="p">(</span><span class="n">instrs</span><span class="p">);</span>
	<span class="n">store_inst</span><span class="p">(</span><span class="n">instrs</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>

		<span class="n">code</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regno</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">exc_prolog</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">dec_exc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">super_regs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
	        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sp</span><span class="p">,</span> <span class="n">toc</span><span class="p">;</span>
		<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mr %0,1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">:</span><span class="p">);</span>
		<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mr %0,2&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">toc</span><span class="p">)</span> <span class="o">:</span><span class="p">);</span>

		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;msr  = &quot;</span><span class="n">REG</span><span class="s">&quot;  sprg0= &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mfmsr</span><span class="p">(),</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SPRG0</span><span class="p">));</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;pvr  = &quot;</span><span class="n">REG</span><span class="s">&quot;  sprg1= &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_PVR</span><span class="p">),</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SPRG1</span><span class="p">));</span> 
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;dec  = &quot;</span><span class="n">REG</span><span class="s">&quot;  sprg2= &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DEC</span><span class="p">),</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SPRG2</span><span class="p">));</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;sp   = &quot;</span><span class="n">REG</span><span class="s">&quot;  sprg3= &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_SPRG3</span><span class="p">));</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;toc  = &quot;</span><span class="n">REG</span><span class="s">&quot;  dar  = &quot;</span><span class="n">REG</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">toc</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DAR</span><span class="p">));</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regno</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_spr</span><span class="p">(</span><span class="n">regno</span><span class="p">);</span>
		<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">write_spr</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;spr %lx = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regno</span><span class="p">,</span> <span class="n">read_spr</span><span class="p">(</span><span class="n">regno</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scannl</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stuff for reading and writing memory safely</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mread</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adrs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">adrs</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">q</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sync</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwrite</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adrs</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">adrs</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">q</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">q</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sync</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error writing address %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adrs</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fault_type</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fault_except</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fault_chars</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;--&quot;</span><span class="p">,</span> <span class="s">&quot;**&quot;</span><span class="p">,</span> <span class="s">&quot;##&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fault_except</span> <span class="o">=</span> <span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x200</span>:
		<span class="n">fault_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300</span>:
	<span class="k">case</span> <span class="mh">0x380</span>:
		<span class="n">fault_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fault_type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">longjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SWAP(a, b, t)	((t) = (a), (a) = (b), (b) = (t))</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">byterev</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* is there really any use for this? */</span>
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="n">SWAP</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">t</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">brev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mnoread</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">memex_help_string</span> <span class="o">=</span> 
    <span class="s">&quot;Memory examine command usage:</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;m [addr] [flags] examine/change memory</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  addr is optional.  will start where left off.</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  flags may include chars from this set:</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    b   modify by bytes (default)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    w   modify by words (2 byte)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    l   modify by longs (4 byte)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    d   modify by doubleword (8 byte)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    r   toggle reverse byte order mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    n   do not read memory (for i/o spaces)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;    .   ok to read (default)</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;NOTE: flags are saved as defaults</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">memex_subcmd_help_string</span> <span class="o">=</span> 
    <span class="s">&quot;Memory examine subcommands:</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  hexval   write this val to current location</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  &#39;string&#39; write chars from string to this location</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  &#39;        increment address</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  ^        decrement address</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  /        increment addr by 0x10.  //=0x100, ///=0x1000, etc</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  </span><span class="se">\\</span><span class="s">        decrement addr by 0x10.  </span><span class="se">\\\\</span><span class="s">=0x100, </span><span class="se">\\\\\\</span><span class="s">=0x1000, etc</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  `        clear no-read flag</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  ;        stay at this addr</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  v        change to byte mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  w        change to word (2 byte) mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  l        change to long (4 byte) mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  u        change to doubleword (8 byte) mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  m addr   change current addr</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  n        toggle no-read flag</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  r        toggle byte reverse flag</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  &lt; count  back up count bytes</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  &gt; count  skip forward count bytes</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;  x        exit this mode</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">memex</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">nslash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">memex_help_string</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">())</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">){</span>
		<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:	<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:	<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:	<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:	<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;r&#39;</span>: 	<span class="n">brev</span> <span class="o">=</span> <span class="o">!</span><span class="n">brev</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:	<span class="n">mnoread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;.&#39;</span>:	<span class="n">mnoread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(;;){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mnoread</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">mread</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">REG</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">adrs</span><span class="p">,</span> <span class="n">brev</span><span class="o">?</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mnoread</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">brev</span><span class="p">)</span>
				<span class="n">byterev</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.2x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">fault_chars</span><span class="p">[</span><span class="n">fault_type</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="n">inc</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">nslash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(;;){</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">)</span> <span class="p">){</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
					<span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brev</span><span class="p">)</span>
					<span class="n">byterev</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">mwrite</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
				<span class="n">inc</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;\&#39;&#39;</span>:
				<span class="k">for</span><span class="p">(;;){</span>
					<span class="n">n</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
					<span class="k">if</span><span class="p">(</span> <span class="n">n</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="p">)</span>
						<span class="n">n</span> <span class="o">=</span> <span class="n">bsesc</span><span class="p">();</span>
					<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">n</span> <span class="o">==</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
						<span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brev</span><span class="p">)</span>
						<span class="n">byterev</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
					<span class="n">mwrite</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
					<span class="n">adrs</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">adrs</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
				<span class="n">inc</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
				<span class="n">adrs</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
				<span class="n">mnoread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;;&#39;</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="k">case</span> <span class="n">EOF</span>:
				<span class="n">scannl</span><span class="p">();</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;v&#39;</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;w&#39;</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;u&#39;</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;^&#39;</span>:
				<span class="n">adrs</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;/&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">nslash</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">adrs</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nslash</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">nslash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nslash</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">adrs</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nslash</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;\\&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">nslash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">adrs</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">nslash</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">nslash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">nslash</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">adrs</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">nslash</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
				<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
				<span class="n">mnoread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
				<span class="n">brev</span> <span class="o">=</span> <span class="o">!</span><span class="n">brev</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span>:
				<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
				<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
				<span class="n">adrs</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span>:
				<span class="n">n</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
				<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
				<span class="n">adrs</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">printf</span><span class="p">(</span><span class="n">memex_subcmd_help_string</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bsesc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">switch</span><span class="p">(</span> <span class="n">c</span> <span class="p">){</span>
	<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:	<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:	<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;b&#39;</span>:	<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\b&#39;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:	<span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\t&#39;</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmon_rawdump</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adrs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ndump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ndump</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">?</span> <span class="n">n</span><span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">mread</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.2x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="n">m</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">fault_chars</span><span class="p">[</span><span class="n">fault_type</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define isxdigit(c)	((&#39;0&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;9&#39;) \</span>
<span class="cp">			 || (&#39;a&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;f&#39;) \</span>
<span class="cp">			 || (&#39;A&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;F&#39;))</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;f&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;d&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nidump</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nidump</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nidump</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nidump</span> <span class="o">&gt;</span> <span class="n">MAX_DUMP</span><span class="p">)</span>
			<span class="n">nidump</span> <span class="o">=</span> <span class="n">MAX_DUMP</span><span class="p">;</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">ppc_inst_dump</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">nidump</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;di</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_log_buf</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndump</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndump</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ndump</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">xmon_rawdump</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">ndump</span><span class="p">);</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">ndump</span><span class="p">;</span>
		<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;dr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndump</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ndump</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ndump</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ndump</span> <span class="o">&gt;</span> <span class="n">MAX_DUMP</span><span class="p">)</span>
			<span class="n">ndump</span> <span class="o">=</span> <span class="n">MAX_DUMP</span><span class="p">;</span>
		<span class="n">prdump</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">ndump</span><span class="p">);</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">ndump</span><span class="p">;</span>
		<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prdump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adrs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">ndump</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">temp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ndump</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="n">REG</span><span class="p">,</span> <span class="n">adrs</span><span class="p">);</span>
		<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">?</span> <span class="n">n</span><span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">mread</span><span class="p">(</span><span class="n">adrs</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">adrs</span> <span class="o">+=</span> <span class="n">nr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		        <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.2x&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="n">m</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">fault_chars</span><span class="p">[</span><span class="n">fault_type</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		        <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  |&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">m</span><span class="p">];</span>
				<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;~&#39;</span><span class="o">?</span> <span class="n">c</span><span class="o">:</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">m</span><span class="p">)</span>
			<span class="n">putchar</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;|</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">instruction_dump_func</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">inst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">generic_inst_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">praddr</span><span class="p">,</span>
			<span class="n">instruction_dump_func</span> <span class="n">dump_func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">dotted</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">first_adr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">inst</span><span class="p">,</span> <span class="n">last_inst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">dotted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">first_adr</span> <span class="o">=</span> <span class="n">adr</span><span class="p">;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">count</span><span class="p">,</span> <span class="n">adr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">mread</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">praddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">fault_chars</span><span class="p">[</span><span class="n">fault_type</span><span class="p">];</span>
				<span class="n">printf</span><span class="p">(</span><span class="n">REG</span><span class="s">&quot;  %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">inst</span> <span class="o">=</span> <span class="n">GETWORD</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adr</span> <span class="o">&gt;</span> <span class="n">first_adr</span> <span class="o">&amp;&amp;</span> <span class="n">inst</span> <span class="o">==</span> <span class="n">last_inst</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dotted</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot; ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dotted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dotted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">last_inst</span> <span class="o">=</span> <span class="n">inst</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">praddr</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">REG</span><span class="s">&quot;  %.8x&quot;</span><span class="p">,</span> <span class="n">adr</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dump_func</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">adr</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">adr</span> <span class="o">-</span> <span class="n">first_adr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ppc_inst_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">praddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_inst_dump</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">praddr</span><span class="p">,</span> <span class="n">print_insn_powerpc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">print_address</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"># &quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">dump_log_buf</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

        <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unable to lookup symbol __log_buf!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">sync</span><span class="p">();</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">kallsyms_lookup_name</span><span class="p">(</span><span class="s">&quot;__log_buf&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">addr</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Symbol __log_buf not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">else</span> <span class="p">{</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">CONFIG_LOG_BUF_SHIFT</span><span class="p">);</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mread</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Can&#39;t read memory at address 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
                                <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
                                <span class="k">break</span><span class="p">;</span>

                        <span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">sync</span><span class="p">();</span>
        <span class="cm">/* wait a little while to see if we get a machine check */</span>
        <span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
        <span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Memory operations - move, set, print differences</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mdest</span><span class="p">;</span>		<span class="cm">/* destination address */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msrc</span><span class="p">;</span>		<span class="cm">/* source address */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mval</span><span class="p">;</span>		<span class="cm">/* byte value to set memory to */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mcount</span><span class="p">;</span>		<span class="cm">/* # bytes to affect */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mdiffs</span><span class="p">;</span>		<span class="cm">/* max # differences to print */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">memops</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mdest</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">cmd</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span><span class="o">?</span> <span class="o">&amp;</span><span class="n">mval</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">msrc</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mcount</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">){</span>
	<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:
		<span class="n">memmove</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mdest</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">msrc</span><span class="p">,</span> <span class="n">mcount</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mdest</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">mcount</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="k">if</span><span class="p">(</span> <span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
			<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mdiffs</span><span class="p">);</span>
		<span class="n">memdiffs</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mdest</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msrc</span><span class="p">,</span> <span class="n">mcount</span><span class="p">,</span> <span class="n">mdiffs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">memdiffs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">maxpr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">n</span><span class="p">,</span> <span class="n">prt</span><span class="p">;</span>

	<span class="n">prt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nb</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">n</span> <span class="p">)</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p1</span><span class="o">++</span> <span class="o">!=</span> <span class="o">*</span><span class="n">p2</span><span class="o">++</span> <span class="p">)</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">++</span><span class="n">prt</span> <span class="o">&lt;=</span> <span class="n">maxpr</span> <span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.16x %.2x # %.16x %.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">p1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">prt</span> <span class="o">&gt;</span> <span class="n">maxpr</span> <span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Total of %d differences</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">mend</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">memlocate</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">a</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;ml&quot;</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mdest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mend</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mval</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scanhex</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">mdest</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">mend</span><span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mread</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
			<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">GETWORD</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">^</span> <span class="n">mval</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.16x:  %.16x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">GETWORD</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mskip</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mlim</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">memzcan</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="n">ook</span><span class="p">;</span>

	<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mskip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mlim</span><span class="p">);</span>
	<span class="n">ook</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">mdest</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">mlim</span><span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="n">mskip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="n">mread</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ook</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.8x .. &quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">&amp;&amp;</span> <span class="n">ook</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">mskip</span><span class="p">);</span>
		<span class="n">ook</span> <span class="o">=</span> <span class="n">ok</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">mskip</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ook</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">mskip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proccall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">args</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">callfunc_t</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
	<span class="n">callfunc_t</span> <span class="n">func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adrs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">termch</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">||</span> <span class="n">termch</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">func</span> <span class="o">=</span> <span class="p">(</span><span class="n">callfunc_t</span><span class="p">)</span> <span class="n">adrs</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;return value is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** %x exception occurred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fault_except</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Input scanning routines */</span>
<span class="kt">int</span>
<span class="nf">skipbl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">termch</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">){</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">termch</span><span class="p">;</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span> <span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define N_PTREGS	44</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regnames</span><span class="p">[</span><span class="n">N_PTREGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;r0&quot;</span><span class="p">,</span> <span class="s">&quot;r1&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r3&quot;</span><span class="p">,</span> <span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r5&quot;</span><span class="p">,</span> <span class="s">&quot;r6&quot;</span><span class="p">,</span> <span class="s">&quot;r7&quot;</span><span class="p">,</span>
	<span class="s">&quot;r8&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span><span class="p">,</span> <span class="s">&quot;r10&quot;</span><span class="p">,</span> <span class="s">&quot;r11&quot;</span><span class="p">,</span> <span class="s">&quot;r12&quot;</span><span class="p">,</span> <span class="s">&quot;r13&quot;</span><span class="p">,</span> <span class="s">&quot;r14&quot;</span><span class="p">,</span> <span class="s">&quot;r15&quot;</span><span class="p">,</span>
	<span class="s">&quot;r16&quot;</span><span class="p">,</span> <span class="s">&quot;r17&quot;</span><span class="p">,</span> <span class="s">&quot;r18&quot;</span><span class="p">,</span> <span class="s">&quot;r19&quot;</span><span class="p">,</span> <span class="s">&quot;r20&quot;</span><span class="p">,</span> <span class="s">&quot;r21&quot;</span><span class="p">,</span> <span class="s">&quot;r22&quot;</span><span class="p">,</span> <span class="s">&quot;r23&quot;</span><span class="p">,</span>
	<span class="s">&quot;r24&quot;</span><span class="p">,</span> <span class="s">&quot;r25&quot;</span><span class="p">,</span> <span class="s">&quot;r26&quot;</span><span class="p">,</span> <span class="s">&quot;r27&quot;</span><span class="p">,</span> <span class="s">&quot;r28&quot;</span><span class="p">,</span> <span class="s">&quot;r29&quot;</span><span class="p">,</span> <span class="s">&quot;r30&quot;</span><span class="p">,</span> <span class="s">&quot;r31&quot;</span><span class="p">,</span>
	<span class="s">&quot;pc&quot;</span><span class="p">,</span> <span class="s">&quot;msr&quot;</span><span class="p">,</span> <span class="s">&quot;or3&quot;</span><span class="p">,</span> <span class="s">&quot;ctr&quot;</span><span class="p">,</span> <span class="s">&quot;lr&quot;</span><span class="p">,</span> <span class="s">&quot;xer&quot;</span><span class="p">,</span> <span class="s">&quot;ccr&quot;</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="s">&quot;softe&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="s">&quot;mq&quot;</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="s">&quot;trap&quot;</span><span class="p">,</span> <span class="s">&quot;dar&quot;</span><span class="p">,</span> <span class="s">&quot;dsisr&quot;</span><span class="p">,</span> <span class="s">&quot;res&quot;</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">scanhex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* parse register name */</span>
		<span class="kt">char</span> <span class="n">regname</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regname</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalnum</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">regname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">regname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_PTREGS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">regnames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regname</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xmon_regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;regs not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">xmon_regs</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;invalid register name &#39;%%%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regname</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* skip leading &quot;0x&quot; if any */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">d</span> <span class="o">=</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">63</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmpstr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmpstr</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>
			<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">kallsyms_lookup_name</span><span class="p">(</span><span class="n">tmpstr</span><span class="p">);</span>
			<span class="n">sync</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">vp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;unknown symbol &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmpstr</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">hexdigit</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">d</span> <span class="o">!=</span> <span class="n">EOF</span><span class="p">);</span>
	<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">scannl</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">termch</span><span class="p">;</span>
	<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hexdigit</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="sc">&#39;A&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;F&#39;</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="sc">&#39;A&#39;</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="sc">&#39;a&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;f&#39;</span> <span class="p">)</span>
		<span class="k">return</span> <span class="n">c</span> <span class="o">-</span> <span class="p">(</span><span class="sc">&#39;a&#39;</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">getstring</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">skipbl</span><span class="p">();</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">){</span>
			<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="o">--</span><span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\t&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">);</span>
	<span class="n">termch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lineptr</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">flush_input</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lineptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">inchar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lineptr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">lineptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xmon_gets</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lineptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lineptr</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">lineptr</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">take_input</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lineptr</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">symbol_lookup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;a&#39;</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">xmon_print_symbol</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="s">&quot;: &quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="n">getstring</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">kallsyms_lookup_name</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Symbol &#39;%s&#39; not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">sync</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">termch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Print an address in numeric and symbolic form (if possible) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmon_print_symbol</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mid</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">after</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">modname</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="n">REG</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">kallsyms_lookup</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modname</span><span class="p">,</span>
				       <span class="n">tmpstr</span><span class="p">);</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="cm">/* wait a little while to see if we get a machine check */</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s%s+%#lx/%#lx&quot;</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modname</span><span class="p">)</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; [%s]&quot;</span><span class="p">,</span> <span class="n">modname</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">after</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_slb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esid</span><span class="p">,</span><span class="n">vsid</span><span class="p">,</span><span class="n">valid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">llp</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;SLB contents of cpu %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mmu_slb_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;slbmfee  %0,%1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">esid</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;slbmfev  %0,%1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">vsid</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">esid</span> <span class="o">&amp;</span> <span class="n">SLB_ESID_V</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span> <span class="o">|</span> <span class="n">esid</span> <span class="o">|</span> <span class="n">vsid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%02d %016lx %016lx&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">esid</span><span class="p">,</span> <span class="n">vsid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">llp</span> <span class="o">=</span> <span class="n">vsid</span> <span class="o">&amp;</span> <span class="n">SLB_VSID_LLP</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vsid</span> <span class="o">&amp;</span> <span class="n">SLB_VSID_B_1T</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot;  1T  ESID=%9lx  VSID=%13lx LLP:%3lx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">GET_ESID_1T</span><span class="p">(</span><span class="n">esid</span><span class="p">),</span>
						<span class="p">(</span><span class="n">vsid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SLB_VSID_B</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SLB_VSID_SHIFT_1T</span><span class="p">,</span>
						<span class="n">llp</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printf</span><span class="p">(</span><span class="s">&quot; 256M ESID=%9lx  VSID=%13lx LLP:%3lx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">GET_ESID</span><span class="p">(</span><span class="n">esid</span><span class="p">),</span>
						<span class="p">(</span><span class="n">vsid</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SLB_VSID_B</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SLB_VSID_SHIFT</span><span class="p">,</span>
						<span class="n">llp</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_stab</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">local_paca</span><span class="o">-&gt;</span><span class="n">stab_addr</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Segment table contents of cpu %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">());</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

		<span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">tmp</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">||</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%03d %016lx &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_segments</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mmu_has_feature</span><span class="p">(</span><span class="n">MMU_FTR_SLB</span><span class="p">))</span>
		<span class="n">dump_slb</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">dump_stab</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_STD_MMU_32</span>
<span class="kt">void</span> <span class="nf">dump_segments</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;sr0-15 =&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %x&quot;</span><span class="p">,</span> <span class="n">mfsrin</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_44x</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_tlb_44x</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PPC44x_TLB_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w0</span><span class="p">,</span><span class="n">w1</span><span class="p">,</span><span class="n">w2</span><span class="p">;</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbre  %0,%1,0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">w0</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbre  %0,%1,1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">w1</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbre  %0,%1,2&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">w2</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%02x] %08x %08x %08x &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w0</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;V %08x -&gt; %01x%08x %c%c%c%c%c&quot;</span><span class="p">,</span>
			       <span class="n">w0</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_EPN_MASK</span><span class="p">,</span>
			       <span class="n">w1</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_ERPN_MASK</span><span class="p">,</span>
			       <span class="n">w1</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_RPN_MASK</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">w2</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_W</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;W&#39;</span> <span class="o">:</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">w2</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_I</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39;i&#39;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">w2</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_M</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;M&#39;</span> <span class="o">:</span> <span class="sc">&#39;m&#39;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">w2</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_G</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;G&#39;</span> <span class="o">:</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">w2</span> <span class="o">&amp;</span> <span class="n">PPC44x_TLB_E</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;E&#39;</span> <span class="o">:</span> <span class="sc">&#39;e&#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_44x */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3E</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_tlb_book3e</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mmucfg</span><span class="p">,</span> <span class="n">pidmask</span><span class="p">,</span> <span class="n">lpidmask</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ramask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tlb</span><span class="p">,</span> <span class="n">ntlbs</span><span class="p">,</span> <span class="n">pidsz</span><span class="p">,</span> <span class="n">lpidsz</span><span class="p">,</span> <span class="n">rasz</span><span class="p">,</span> <span class="n">lrat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmu_version</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pgsz_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;  1K&quot;</span><span class="p">,</span>
		<span class="s">&quot;  2K&quot;</span><span class="p">,</span>
		<span class="s">&quot;  4K&quot;</span><span class="p">,</span>
		<span class="s">&quot;  8K&quot;</span><span class="p">,</span>
		<span class="s">&quot; 16K&quot;</span><span class="p">,</span>
		<span class="s">&quot; 32K&quot;</span><span class="p">,</span>
		<span class="s">&quot; 64K&quot;</span><span class="p">,</span>
		<span class="s">&quot;128K&quot;</span><span class="p">,</span>
		<span class="s">&quot;256K&quot;</span><span class="p">,</span>
		<span class="s">&quot;512K&quot;</span><span class="p">,</span>
		<span class="s">&quot;  1M&quot;</span><span class="p">,</span>
		<span class="s">&quot;  2M&quot;</span><span class="p">,</span>
		<span class="s">&quot;  4M&quot;</span><span class="p">,</span>
		<span class="s">&quot;  8M&quot;</span><span class="p">,</span>
		<span class="s">&quot; 16M&quot;</span><span class="p">,</span>
		<span class="s">&quot; 32M&quot;</span><span class="p">,</span>
		<span class="s">&quot; 64M&quot;</span><span class="p">,</span>
		<span class="s">&quot;128M&quot;</span><span class="p">,</span>
		<span class="s">&quot;256M&quot;</span><span class="p">,</span>
		<span class="s">&quot;512M&quot;</span><span class="p">,</span>
		<span class="s">&quot;  1G&quot;</span><span class="p">,</span>
		<span class="s">&quot;  2G&quot;</span><span class="p">,</span>
		<span class="s">&quot;  4G&quot;</span><span class="p">,</span>
		<span class="s">&quot;  8G&quot;</span><span class="p">,</span>
		<span class="s">&quot; 16G&quot;</span><span class="p">,</span>
		<span class="s">&quot; 32G&quot;</span><span class="p">,</span>
		<span class="s">&quot; 64G&quot;</span><span class="p">,</span>
		<span class="s">&quot;128G&quot;</span><span class="p">,</span>
		<span class="s">&quot;256G&quot;</span><span class="p">,</span>
		<span class="s">&quot;512G&quot;</span><span class="p">,</span>
		<span class="s">&quot;  1T&quot;</span><span class="p">,</span>
		<span class="s">&quot;  2T&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* Gather some infos about the MMU */</span>
	<span class="n">mmucfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MMUCFG</span><span class="p">);</span>
	<span class="n">mmu_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">mmucfg</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ntlbs</span> <span class="o">=</span> <span class="p">((</span><span class="n">mmucfg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pidsz</span> <span class="o">=</span> <span class="p">((</span><span class="n">mmucfg</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lpidsz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mmucfg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">rasz</span> <span class="o">=</span> <span class="p">(</span><span class="n">mmucfg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mmu_version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mmucfg</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">))</span>
		<span class="n">lrat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Book3E MMU MAV=%d.0,%d TLBs,%d-bit PID,%d-bit LPID,%d-bit RA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mmu_version</span><span class="p">,</span> <span class="n">ntlbs</span><span class="p">,</span> <span class="n">pidsz</span><span class="p">,</span> <span class="n">lpidsz</span><span class="p">,</span> <span class="n">rasz</span><span class="p">);</span>
	<span class="n">pidmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">pidsz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lpidmask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ul</span> <span class="o">&lt;&lt;</span> <span class="n">lpidsz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ramask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1ull</span> <span class="o">&lt;&lt;</span> <span class="n">rasz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tlb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tlb</span> <span class="o">&lt;</span> <span class="n">ntlbs</span><span class="p">;</span> <span class="n">tlb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tlbcfg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nent</span><span class="p">,</span> <span class="n">assoc</span><span class="p">,</span> <span class="n">new_cc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;TLB %d:</span><span class="se">\n</span><span class="s">------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tlb</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">tlb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tlbcfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB0CFG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tlbcfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB1CFG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">tlbcfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB2CFG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">tlbcfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB3CFG</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unsupported TLB number !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nent</span> <span class="o">=</span> <span class="n">tlbcfg</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="n">assoc</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlbcfg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nent</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mas0</span> <span class="o">=</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="n">tlb</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">mas1</span> <span class="o">=</span> <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_4K</span><span class="p">);</span>
			<span class="n">u64</span> <span class="n">mas2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">mas7_mas3</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">esel</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">assoc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cc</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">assoc</span><span class="p">;</span>
				<span class="n">esel</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">assoc</span><span class="p">;</span>
				<span class="n">mas2</span> <span class="o">=</span> <span class="n">cc</span> <span class="o">*</span> <span class="mh">0x1000</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mas0</span> <span class="o">|=</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">esel</span><span class="p">);</span>
			<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS0</span><span class="p">,</span> <span class="n">mas0</span><span class="p">);</span>
			<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS1</span><span class="p">,</span> <span class="n">mas1</span><span class="p">);</span>
			<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS2</span><span class="p">,</span> <span class="n">mas2</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbre  0,0,0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
			<span class="n">mas1</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MAS1</span><span class="p">);</span>
			<span class="n">mas2</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MAS2</span><span class="p">);</span>
			<span class="n">mas7_mas3</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MAS7_MAS3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">assoc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">assoc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">new_cc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_VALID</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">assoc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%04x- &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_cc</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%04x-%c&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">esel</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot;    |%c&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">esel</span><span class="p">);</span>
			<span class="n">new_cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %016llx %04x %s %c%c AS%c&quot;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3ffull</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">mas1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">,</span>
			       <span class="n">pgsz_names</span><span class="p">[(</span><span class="n">mas1</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">],</span>
			       <span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_IND</span> <span class="o">?</span> <span class="sc">&#39;I&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_IPROT</span> <span class="o">?</span> <span class="sc">&#39;P&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_TS</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %c%c%c%c%c%c%c&quot;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_X0</span> <span class="o">?</span> <span class="sc">&#39;a&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_X1</span> <span class="o">?</span> <span class="sc">&#39;v&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_W</span>  <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_I</span>  <span class="o">?</span> <span class="sc">&#39;i&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_M</span>  <span class="o">?</span> <span class="sc">&#39;m&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_G</span>  <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
			       <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_E</span>  <span class="o">?</span> <span class="sc">&#39;e&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %016llx&quot;</span><span class="p">,</span> <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">ramask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7ffull</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_IND</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">pgsz_names</span><span class="p">[(</span><span class="n">mas7_mas3</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&quot; U%c%c%c S%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_UX</span> <span class="o">?</span> <span class="sc">&#39;x&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_UW</span> <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_UR</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_SX</span> <span class="o">?</span> <span class="sc">&#39;x&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_SW</span> <span class="o">?</span> <span class="sc">&#39;w&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
				       <span class="n">mas7_mas3</span> <span class="o">&amp;</span> <span class="n">MAS3_SR</span> <span class="o">?</span> <span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_BOOK3E */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmon_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__debugger</span> <span class="o">=</span> <span class="n">xmon</span><span class="p">;</span>
		<span class="n">__debugger_ipi</span> <span class="o">=</span> <span class="n">xmon_ipi</span><span class="p">;</span>
		<span class="n">__debugger_bpt</span> <span class="o">=</span> <span class="n">xmon_bpt</span><span class="p">;</span>
		<span class="n">__debugger_sstep</span> <span class="o">=</span> <span class="n">xmon_sstep</span><span class="p">;</span>
		<span class="n">__debugger_iabr_match</span> <span class="o">=</span> <span class="n">xmon_iabr_match</span><span class="p">;</span>
		<span class="n">__debugger_dabr_match</span> <span class="o">=</span> <span class="n">xmon_dabr_match</span><span class="p">;</span>
		<span class="n">__debugger_fault_handler</span> <span class="o">=</span> <span class="n">xmon_fault_handler</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__debugger</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_ipi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_bpt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_sstep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_iabr_match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_dabr_match</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__debugger_fault_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xmon_map_scc</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysrq_handle_xmon</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ensure xmon is enabled */</span>
	<span class="n">xmon_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">debugger</span><span class="p">(</span><span class="n">get_irq_regs</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_xmon_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span>	<span class="n">sysrq_handle_xmon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span> <span class="o">=</span>	<span class="s">&quot;Xmon&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span> <span class="o">=</span>	<span class="s">&quot;Entering xmon&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_xmon_sysrq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_sysrq_key</span><span class="p">(</span><span class="sc">&#39;x&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysrq_xmon_op</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__initcall</span><span class="p">(</span><span class="n">setup_xmon_sysrq</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MAGIC_SYSRQ */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">xmon_early</span><span class="p">,</span> <span class="n">xmon_off</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_xmon</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span> <span class="o">||</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;early&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just &quot;xmon&quot; is equivalent to &quot;xmon=early&quot; */</span>
		<span class="n">xmon_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">xmon_early</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xmon_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xmon_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;nobt&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xmon_no_auto_backtrace</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;xmon&quot;</span><span class="p">,</span> <span class="n">early_parse_xmon</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">xmon_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_XMON_DEFAULT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xmon_off</span><span class="p">)</span>
		<span class="n">xmon_init</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xmon_early</span><span class="p">)</span>
		<span class="n">debugger</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SPU_BASE</span>

<span class="k">struct</span> <span class="n">spu_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">saved_mfc_sr1_RW</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saved_spu_runcntl_RW</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dump_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stopped_ok</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define XMON_NUM_SPUS	16	</span><span class="cm">/* Enough for current hardware */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">spu_info</span> <span class="n">spu_info</span><span class="p">[</span><span class="n">XMON_NUM_SPUS</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">xmon_register_spus</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="n">full_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="n">XMON_NUM_SPUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spu_info</span><span class="p">[</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">spu</span> <span class="o">=</span> <span class="n">spu</span><span class="p">;</span>
		<span class="n">spu_info</span><span class="p">[</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">stopped_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spu_info</span><span class="p">[</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">dump_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				<span class="n">spu_info</span><span class="p">[</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_spus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XMON_NUM_SPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>

			<span class="n">spu</span> <span class="o">=</span> <span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spu</span><span class="p">;</span>

			<span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_spu_runcntl_RW</span> <span class="o">=</span>
				<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_runcntl_RW</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">spu_mfc_sr1_get</span><span class="p">(</span><span class="n">spu</span><span class="p">);</span>
			<span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_mfc_sr1_RW</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MFC_STATE1_MASTER_RUN_CONTROL_MASK</span><span class="p">;</span>
			<span class="n">spu_mfc_sr1_set</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="n">sync</span><span class="p">();</span>
			<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

			<span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stopped_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Stopped spu %.2d (was %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
					<span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_spu_runcntl_RW</span> <span class="o">?</span>
					<span class="s">&quot;running&quot;</span> <span class="o">:</span> <span class="s">&quot;stopped&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error stopping spu %.2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_spus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">XMON_NUM_SPUS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spu</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stopped_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error, spu %d was not successfully stopped&quot;</span>
					<span class="s">&quot;, not restarting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sync</span><span class="p">();</span>

			<span class="n">spu</span> <span class="o">=</span> <span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">spu</span><span class="p">;</span>
			<span class="n">spu_mfc_sr1_set</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_mfc_sr1_RW</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_runcntl_RW</span><span class="p">,</span>
					<span class="n">spu_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">saved_spu_runcntl_RW</span><span class="p">);</span>

			<span class="n">sync</span><span class="p">();</span>
			<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Restarted spu %.2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error restarting spu %.2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define DUMP_WIDTH	23</span>
<span class="cp">#define DUMP_VALUE(format, field, value)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (setjmp(bus_error_jmp) == 0) {				\</span>
<span class="cp">		catch_memory_errors = 1;				\</span>
<span class="cp">		sync();							\</span>
<span class="cp">		printf(&quot;  %-*s = &quot;format&quot;\n&quot;, DUMP_WIDTH,		\</span>
<span class="cp">				#field, value);				\</span>
<span class="cp">		sync();							\</span>
<span class="cp">		__delay(200);						\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		catch_memory_errors = 0;				\</span>
<span class="cp">		printf(&quot;  %-*s = *** Error reading field.\n&quot;,		\</span>
<span class="cp">					DUMP_WIDTH, #field);		\</span>
<span class="cp">	}								\</span>
<span class="cp">	catch_memory_errors = 0;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define DUMP_FIELD(obj, format, field)	\</span>
<span class="cp">	DUMP_VALUE(format, field, obj-&gt;field)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_spu_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">spu</span> <span class="o">*</span><span class="n">spu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Dumping spu fields at address %p:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">spu</span><span class="p">);</span>

	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">number</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">local_store_phys</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">local_store</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">ls_size</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">class_0_pending</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">class_0_dar</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">class_1_dar</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">class_1_dsisr</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">irqs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">slb_replace</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%lx&quot;</span><span class="p">,</span> <span class="n">problem_phys</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="p">);</span>
	<span class="n">DUMP_VALUE</span><span class="p">(</span><span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_runcntl_RW</span><span class="p">,</span>
			<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_runcntl_RW</span><span class="p">));</span>
	<span class="n">DUMP_VALUE</span><span class="p">(</span><span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_status_R</span><span class="p">,</span>
			<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_status_R</span><span class="p">));</span>
	<span class="n">DUMP_VALUE</span><span class="p">(</span><span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_npc_RW</span><span class="p">,</span>
			<span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">problem</span><span class="o">-&gt;</span><span class="n">spu_npc_RW</span><span class="p">));</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">priv2</span><span class="p">);</span>
	<span class="n">DUMP_FIELD</span><span class="p">(</span><span class="n">spu</span><span class="p">,</span> <span class="s">&quot;0x%p&quot;</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">spu_inst_dump</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">praddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">generic_inst_dump</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">praddr</span><span class="p">,</span> <span class="n">print_insn_spu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_spu_ls</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ls_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setjmp</span><span class="p">(</span><span class="n">bus_error_jmp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">ls_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spu_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">spu</span><span class="o">-&gt;</span><span class="n">local_store</span><span class="p">;</span>
		<span class="n">sync</span><span class="p">();</span>
		<span class="n">__delay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error: accessing spu info for spu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">catch_memory_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ls_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">spu_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">dump_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">ls_addr</span> <span class="o">+</span> <span class="n">LS_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error: address outside of local store</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;i&#39;</span>:
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">spu_inst_dump</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;sdi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">prdump</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">last_cmd</span> <span class="o">=</span> <span class="s">&quot;sd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spu_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">dump_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_spu_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
		<span class="n">stop_spus</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
		<span class="n">restart_spus</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
		<span class="n">subcmd</span> <span class="o">=</span> <span class="n">inchar</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">subcmd</span><span class="p">)</span> <span class="o">||</span> <span class="n">subcmd</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="n">termch</span> <span class="o">=</span> <span class="n">subcmd</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
		<span class="n">scanhex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">XMON_NUM_SPUS</span> <span class="o">||</span> <span class="o">!</span><span class="n">spu_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">spu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">&quot;*** Error: invalid spu number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span>:
			<span class="n">dump_spu_fields</span><span class="p">(</span><span class="n">spu_info</span><span class="p">[</span><span class="n">num</span><span class="p">].</span><span class="n">spu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dump_spu_ls</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* ! CONFIG_SPU_BASE */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_spu_cmd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
