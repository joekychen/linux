<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › include › asm › mpic.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mpic.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_POWERPC_MPIC_H</span>
<span class="cp">#define _ASM_POWERPC_MPIC_H</span>
<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dcr.h&gt;</span>
<span class="cp">#include &lt;asm/msi_bitmap.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Global registers</span>
<span class="cm"> */</span>

<span class="cp">#define MPIC_GREG_BASE			0x01000</span>

<span class="cp">#define MPIC_GREG_FEATURE_0		0x00000</span>
<span class="cp">#define		MPIC_GREG_FEATURE_LAST_SRC_MASK		0x07ff0000</span>
<span class="cp">#define		MPIC_GREG_FEATURE_LAST_SRC_SHIFT	16</span>
<span class="cp">#define		MPIC_GREG_FEATURE_LAST_CPU_MASK		0x00001f00</span>
<span class="cp">#define		MPIC_GREG_FEATURE_LAST_CPU_SHIFT	8</span>
<span class="cp">#define		MPIC_GREG_FEATURE_VERSION_MASK		0xff</span>
<span class="cp">#define MPIC_GREG_FEATURE_1		0x00010</span>
<span class="cp">#define MPIC_GREG_GLOBAL_CONF_0		0x00020</span>
<span class="cp">#define		MPIC_GREG_GCONF_RESET			0x80000000</span>
<span class="cm">/* On the FSL mpic implementations the Mode field is expand to be</span>
<span class="cm"> * 2 bits wide:</span>
<span class="cm"> *	0b00 = pass through (interrupts routed to IRQ0)</span>
<span class="cm"> *	0b01 = Mixed mode</span>
<span class="cm"> *	0b10 = reserved</span>
<span class="cm"> *	0b11 = External proxy / coreint</span>
<span class="cm"> */</span>
<span class="cp">#define		MPIC_GREG_GCONF_COREINT			0x60000000</span>
<span class="cp">#define		MPIC_GREG_GCONF_8259_PTHROU_DIS		0x20000000</span>
<span class="cp">#define		MPIC_GREG_GCONF_NO_BIAS			0x10000000</span>
<span class="cp">#define		MPIC_GREG_GCONF_BASE_MASK		0x000fffff</span>
<span class="cp">#define		MPIC_GREG_GCONF_MCK			0x08000000</span>
<span class="cp">#define MPIC_GREG_GLOBAL_CONF_1		0x00030</span>
<span class="cp">#define		MPIC_GREG_GLOBAL_CONF_1_SIE		0x08000000</span>
<span class="cp">#define		MPIC_GREG_GLOBAL_CONF_1_CLK_RATIO_MASK	0x70000000</span>
<span class="cp">#define		MPIC_GREG_GLOBAL_CONF_1_CLK_RATIO(r)	\</span>
<span class="cp">			(((r) &lt;&lt; 28) &amp; MPIC_GREG_GLOBAL_CONF_1_CLK_RATIO_MASK)</span>
<span class="cp">#define MPIC_GREG_VENDOR_0		0x00040</span>
<span class="cp">#define MPIC_GREG_VENDOR_1		0x00050</span>
<span class="cp">#define MPIC_GREG_VENDOR_2		0x00060</span>
<span class="cp">#define MPIC_GREG_VENDOR_3		0x00070</span>
<span class="cp">#define MPIC_GREG_VENDOR_ID		0x00080</span>
<span class="cp">#define 	MPIC_GREG_VENDOR_ID_STEPPING_MASK	0x00ff0000</span>
<span class="cp">#define 	MPIC_GREG_VENDOR_ID_STEPPING_SHIFT	16</span>
<span class="cp">#define 	MPIC_GREG_VENDOR_ID_DEVICE_ID_MASK	0x0000ff00</span>
<span class="cp">#define 	MPIC_GREG_VENDOR_ID_DEVICE_ID_SHIFT	8</span>
<span class="cp">#define 	MPIC_GREG_VENDOR_ID_VENDOR_ID_MASK	0x000000ff</span>
<span class="cp">#define MPIC_GREG_PROCESSOR_INIT	0x00090</span>
<span class="cp">#define MPIC_GREG_IPI_VECTOR_PRI_0	0x000a0</span>
<span class="cp">#define MPIC_GREG_IPI_VECTOR_PRI_1	0x000b0</span>
<span class="cp">#define MPIC_GREG_IPI_VECTOR_PRI_2	0x000c0</span>
<span class="cp">#define MPIC_GREG_IPI_VECTOR_PRI_3	0x000d0</span>
<span class="cp">#define MPIC_GREG_IPI_STRIDE		0x10</span>
<span class="cp">#define MPIC_GREG_SPURIOUS		0x000e0</span>
<span class="cp">#define MPIC_GREG_TIMER_FREQ		0x000f0</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Timer registers</span>
<span class="cm"> */</span>
<span class="cp">#define MPIC_TIMER_BASE			0x01100</span>
<span class="cp">#define MPIC_TIMER_STRIDE		0x40</span>

<span class="cp">#define MPIC_TIMER_CURRENT_CNT		0x00000</span>
<span class="cp">#define MPIC_TIMER_BASE_CNT		0x00010</span>
<span class="cp">#define MPIC_TIMER_VECTOR_PRI		0x00020</span>
<span class="cp">#define MPIC_TIMER_DESTINATION		0x00030</span>

<span class="cm">/*</span>
<span class="cm"> * Per-Processor registers</span>
<span class="cm"> */</span>

<span class="cp">#define MPIC_CPU_THISBASE		0x00000</span>
<span class="cp">#define MPIC_CPU_BASE			0x20000</span>
<span class="cp">#define MPIC_CPU_STRIDE			0x01000</span>

<span class="cp">#define MPIC_CPU_IPI_DISPATCH_0		0x00040</span>
<span class="cp">#define MPIC_CPU_IPI_DISPATCH_1		0x00050</span>
<span class="cp">#define MPIC_CPU_IPI_DISPATCH_2		0x00060</span>
<span class="cp">#define MPIC_CPU_IPI_DISPATCH_3		0x00070</span>
<span class="cp">#define MPIC_CPU_IPI_DISPATCH_STRIDE	0x00010</span>
<span class="cp">#define MPIC_CPU_CURRENT_TASK_PRI	0x00080</span>
<span class="cp">#define 	MPIC_CPU_TASKPRI_MASK			0x0000000f</span>
<span class="cp">#define MPIC_CPU_WHOAMI			0x00090</span>
<span class="cp">#define 	MPIC_CPU_WHOAMI_MASK			0x0000001f</span>
<span class="cp">#define MPIC_CPU_INTACK			0x000a0</span>
<span class="cp">#define MPIC_CPU_EOI			0x000b0</span>
<span class="cp">#define MPIC_CPU_MCACK			0x000c0</span>

<span class="cm">/*</span>
<span class="cm"> * Per-source registers</span>
<span class="cm"> */</span>

<span class="cp">#define MPIC_IRQ_BASE			0x10000</span>
<span class="cp">#define MPIC_IRQ_STRIDE			0x00020</span>
<span class="cp">#define MPIC_IRQ_VECTOR_PRI		0x00000</span>
<span class="cp">#define 	MPIC_VECPRI_MASK			0x80000000</span>
<span class="cp">#define 	MPIC_VECPRI_ACTIVITY			0x40000000	</span><span class="cm">/* Read Only */</span><span class="cp"></span>
<span class="cp">#define 	MPIC_VECPRI_PRIORITY_MASK		0x000f0000</span>
<span class="cp">#define 	MPIC_VECPRI_PRIORITY_SHIFT		16</span>
<span class="cp">#define 	MPIC_VECPRI_VECTOR_MASK			0x000007ff</span>
<span class="cp">#define 	MPIC_VECPRI_POLARITY_POSITIVE		0x00800000</span>
<span class="cp">#define 	MPIC_VECPRI_POLARITY_NEGATIVE		0x00000000</span>
<span class="cp">#define 	MPIC_VECPRI_POLARITY_MASK		0x00800000</span>
<span class="cp">#define 	MPIC_VECPRI_SENSE_LEVEL			0x00400000</span>
<span class="cp">#define 	MPIC_VECPRI_SENSE_EDGE			0x00000000</span>
<span class="cp">#define 	MPIC_VECPRI_SENSE_MASK			0x00400000</span>
<span class="cp">#define MPIC_IRQ_DESTINATION		0x00010</span>

<span class="cp">#define MPIC_MAX_IRQ_SOURCES	2048</span>
<span class="cp">#define MPIC_MAX_CPUS		32</span>
<span class="cp">#define MPIC_MAX_ISU		32</span>

<span class="cm">/*</span>
<span class="cm"> * Tsi108 implementation of MPIC has many differences from the original one</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Global registers</span>
<span class="cm"> */</span>

<span class="cp">#define TSI108_GREG_BASE		0x00000</span>
<span class="cp">#define TSI108_GREG_FEATURE_0		0x00000</span>
<span class="cp">#define TSI108_GREG_GLOBAL_CONF_0	0x00004</span>
<span class="cp">#define TSI108_GREG_VENDOR_ID		0x0000c</span>
<span class="cp">#define TSI108_GREG_IPI_VECTOR_PRI_0	0x00204		</span><span class="cm">/* Doorbell 0 */</span><span class="cp"></span>
<span class="cp">#define TSI108_GREG_IPI_STRIDE		0x0c</span>
<span class="cp">#define TSI108_GREG_SPURIOUS		0x00010</span>
<span class="cp">#define TSI108_GREG_TIMER_FREQ		0x00014</span>

<span class="cm">/*</span>
<span class="cm"> * Timer registers</span>
<span class="cm"> */</span>
<span class="cp">#define TSI108_TIMER_BASE		0x0030</span>
<span class="cp">#define TSI108_TIMER_STRIDE		0x10</span>
<span class="cp">#define TSI108_TIMER_CURRENT_CNT	0x00000</span>
<span class="cp">#define TSI108_TIMER_BASE_CNT		0x00004</span>
<span class="cp">#define TSI108_TIMER_VECTOR_PRI		0x00008</span>
<span class="cp">#define TSI108_TIMER_DESTINATION	0x0000c</span>

<span class="cm">/*</span>
<span class="cm"> * Per-Processor registers</span>
<span class="cm"> */</span>
<span class="cp">#define TSI108_CPU_BASE			0x00300</span>
<span class="cp">#define TSI108_CPU_STRIDE		0x00040</span>
<span class="cp">#define TSI108_CPU_IPI_DISPATCH_0	0x00200</span>
<span class="cp">#define TSI108_CPU_IPI_DISPATCH_STRIDE	0x00000</span>
<span class="cp">#define TSI108_CPU_CURRENT_TASK_PRI	0x00000</span>
<span class="cp">#define TSI108_CPU_WHOAMI		0xffffffff</span>
<span class="cp">#define TSI108_CPU_INTACK		0x00004</span>
<span class="cp">#define TSI108_CPU_EOI			0x00008</span>
<span class="cp">#define TSI108_CPU_MCACK		0x00004 </span><span class="cm">/* Doesn&#39;t really exist here */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Per-source registers</span>
<span class="cm"> */</span>
<span class="cp">#define TSI108_IRQ_BASE			0x00100</span>
<span class="cp">#define TSI108_IRQ_STRIDE		0x00008</span>
<span class="cp">#define TSI108_IRQ_VECTOR_PRI		0x00000</span>
<span class="cp">#define TSI108_VECPRI_VECTOR_MASK	0x000000ff</span>
<span class="cp">#define TSI108_VECPRI_POLARITY_POSITIVE	0x01000000</span>
<span class="cp">#define TSI108_VECPRI_POLARITY_NEGATIVE	0x00000000</span>
<span class="cp">#define TSI108_VECPRI_SENSE_LEVEL	0x02000000</span>
<span class="cp">#define TSI108_VECPRI_SENSE_EDGE	0x00000000</span>
<span class="cp">#define TSI108_VECPRI_POLARITY_MASK	0x01000000</span>
<span class="cp">#define TSI108_VECPRI_SENSE_MASK	0x02000000</span>
<span class="cp">#define TSI108_IRQ_DESTINATION		0x00004</span>

<span class="cm">/* weird mpic register indices and mask bits in the HW info array */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MPIC_IDX_GREG_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_FEATURE_0</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_GLOBAL_CONF_0</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_VENDOR_ID</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_IPI_VECTOR_PRI_0</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_IPI_STRIDE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_SPURIOUS</span><span class="p">,</span>
	<span class="n">MPIC_IDX_GREG_TIMER_FREQ</span><span class="p">,</span>

	<span class="n">MPIC_IDX_TIMER_BASE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_TIMER_STRIDE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_TIMER_CURRENT_CNT</span><span class="p">,</span>
	<span class="n">MPIC_IDX_TIMER_BASE_CNT</span><span class="p">,</span>
	<span class="n">MPIC_IDX_TIMER_VECTOR_PRI</span><span class="p">,</span>
	<span class="n">MPIC_IDX_TIMER_DESTINATION</span><span class="p">,</span>

	<span class="n">MPIC_IDX_CPU_BASE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_STRIDE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_IPI_DISPATCH_0</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_IPI_DISPATCH_STRIDE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_CURRENT_TASK_PRI</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_WHOAMI</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_INTACK</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_EOI</span><span class="p">,</span>
	<span class="n">MPIC_IDX_CPU_MCACK</span><span class="p">,</span>

	<span class="n">MPIC_IDX_IRQ_BASE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_IRQ_STRIDE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_IRQ_VECTOR_PRI</span><span class="p">,</span>

	<span class="n">MPIC_IDX_VECPRI_VECTOR_MASK</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_POLARITY_POSITIVE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_POLARITY_NEGATIVE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_SENSE_LEVEL</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_SENSE_EDGE</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_POLARITY_MASK</span><span class="p">,</span>
	<span class="n">MPIC_IDX_VECPRI_SENSE_MASK</span><span class="p">,</span>
	<span class="n">MPIC_IDX_IRQ_DESTINATION</span><span class="p">,</span>
	<span class="n">MPIC_IDX_END</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
<span class="cm">/* Fixup table entry */</span>
<span class="k">struct</span> <span class="n">mpic_irq_fixup</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">applebase</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">index</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>


<span class="k">enum</span> <span class="n">mpic_reg_type</span> <span class="p">{</span>
	<span class="n">mpic_access_mmio_le</span><span class="p">,</span>
	<span class="n">mpic_access_mmio_be</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>
	<span class="n">mpic_access_dcr</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">base</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>
	<span class="n">dcr_host_t</span>	<span class="n">dhost</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_DCR */</span><span class="cp"></span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpic_irq_save</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">vecprio</span><span class="p">,</span>
			<span class="n">dest</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="n">u32</span>		<span class="n">fixup_data</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/* The instance data of a given MPIC */</span>
<span class="k">struct</span> <span class="n">mpic</span>
<span class="p">{</span>
	<span class="cm">/* The OpenFirmware dt node for this MPIC */</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="cm">/* The remapper for this MPIC */</span>
	<span class="k">struct</span> <span class="n">irq_domain</span>	<span class="o">*</span><span class="n">irqhost</span><span class="p">;</span>

	<span class="cm">/* The &quot;linux&quot; controller struct */</span>
	<span class="k">struct</span> <span class="n">irq_chip</span>		<span class="n">hc_irq</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="k">struct</span> <span class="n">irq_chip</span>		<span class="n">hc_ht_irq</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">struct</span> <span class="n">irq_chip</span>		<span class="n">hc_ipi</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">irq_chip</span>		<span class="n">hc_tm</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="cm">/* Flags */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="cm">/* How many irq sources in a given ISU */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">isu_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">isu_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">isu_mask</span><span class="p">;</span>
	<span class="cm">/* Number of sources */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">num_sources</span><span class="p">;</span>

	<span class="cm">/* vector numbers used for internal sources (ipi/timers) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">timer_vecs</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* Spurious vector to program into unused sources */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">spurious_vec</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="cm">/* The fixup table */</span>
	<span class="k">struct</span> <span class="n">mpic_irq_fixup</span>	<span class="o">*</span><span class="n">fixups</span><span class="p">;</span>
	<span class="n">raw_spinlock_t</span>	<span class="n">fixup_lock</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Register access method */</span>
	<span class="k">enum</span> <span class="n">mpic_reg_type</span>	<span class="n">reg_type</span><span class="p">;</span>

	<span class="cm">/* The physical base address of the MPIC */</span>
	<span class="n">phys_addr_t</span> <span class="n">paddr</span><span class="p">;</span>

	<span class="cm">/* The various ioremap&#39;ed bases */</span>
	<span class="k">struct</span> <span class="n">mpic_reg_bank</span>	<span class="n">gregs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpic_reg_bank</span>	<span class="n">tmregs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpic_reg_bank</span>	<span class="n">cpuregs</span><span class="p">[</span><span class="n">MPIC_MAX_CPUS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpic_reg_bank</span>	<span class="n">isus</span><span class="p">[</span><span class="n">MPIC_MAX_ISU</span><span class="p">];</span>

	<span class="cm">/* Protected sources */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="o">*</span><span class="n">protected</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MPIC_WEIRD</span>
	<span class="cm">/* Pointer to HW info array */</span>
	<span class="n">u32</span>			<span class="o">*</span><span class="n">hw_set</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
	<span class="k">struct</span> <span class="n">msi_bitmap</span>	<span class="n">msi_bitmap</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MPIC_BROKEN_REGREAD</span>
	<span class="n">u32</span>			<span class="n">isu_reg0_shadow</span><span class="p">[</span><span class="n">MPIC_MAX_IRQ_SOURCES</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="cm">/* link */</span>
	<span class="k">struct</span> <span class="n">mpic</span>		<span class="o">*</span><span class="n">next</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="k">struct</span> <span class="n">mpic_irq_save</span>	<span class="o">*</span><span class="n">save_data</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * MPIC flags (passed to mpic_alloc)</span>
<span class="cm"> *</span>
<span class="cm"> * The top 4 bits contain an MPIC bhw id that is used to index the</span>
<span class="cm"> * register offsets and some masks when CONFIG_MPIC_WEIRD is set.</span>
<span class="cm"> * Note setting any ID (leaving those bits to 0) means standard MPIC</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This is a secondary (&quot;chained&quot;) controller; it only uses the CPU0</span>
<span class="cm"> * registers.  Primary controllers have IPIs and affinity control.</span>
<span class="cm"> */</span>
<span class="cp">#define MPIC_SECONDARY			0x00000001</span>

<span class="cm">/* Set this for a big-endian MPIC */</span>
<span class="cp">#define MPIC_BIG_ENDIAN			0x00000002</span>
<span class="cm">/* Broken U3 MPIC */</span>
<span class="cp">#define MPIC_U3_HT_IRQS			0x00000004</span>
<span class="cm">/* Broken IPI registers (autodetected) */</span>
<span class="cp">#define MPIC_BROKEN_IPI			0x00000008</span>
<span class="cm">/* Spurious vector requires EOI */</span>
<span class="cp">#define MPIC_SPV_EOI			0x00000020</span>
<span class="cm">/* No passthrough disable */</span>
<span class="cp">#define MPIC_NO_PTHROU_DIS		0x00000040</span>
<span class="cm">/* DCR based MPIC */</span>
<span class="cp">#define MPIC_USES_DCR			0x00000080</span>
<span class="cm">/* MPIC has 11-bit vector fields (or larger) */</span>
<span class="cp">#define MPIC_LARGE_VECTORS		0x00000100</span>
<span class="cm">/* Enable delivery of prio 15 interrupts as MCK instead of EE */</span>
<span class="cp">#define MPIC_ENABLE_MCK			0x00000200</span>
<span class="cm">/* Disable bias among target selection, spread interrupts evenly */</span>
<span class="cp">#define MPIC_NO_BIAS			0x00000400</span>
<span class="cm">/* Destination only supports a single CPU at a time */</span>
<span class="cp">#define MPIC_SINGLE_DEST_CPU		0x00001000</span>
<span class="cm">/* Enable CoreInt delivery of interrupts */</span>
<span class="cp">#define MPIC_ENABLE_COREINT		0x00002000</span>
<span class="cm">/* Do not reset the MPIC during initialization */</span>
<span class="cp">#define MPIC_NO_RESET			0x00004000</span>
<span class="cm">/* Freescale MPIC (compatible includes &quot;fsl,mpic&quot;) */</span>
<span class="cp">#define MPIC_FSL			0x00008000</span>

<span class="cm">/* MPIC HW modification ID */</span>
<span class="cp">#define MPIC_REGSET_MASK		0xf0000000</span>
<span class="cp">#define MPIC_REGSET(val)		(((val) &amp; 0xf ) &lt;&lt; 28)</span>
<span class="cp">#define MPIC_GET_REGSET(flags)		(((flags) &gt;&gt; 28) &amp; 0xf)</span>

<span class="cp">#define	MPIC_REGSET_STANDARD		MPIC_REGSET(0)	</span><span class="cm">/* Original MPIC */</span><span class="cp"></span>
<span class="cp">#define	MPIC_REGSET_TSI108		MPIC_REGSET(1)	</span><span class="cm">/* Tsi108/109 PIC */</span><span class="cp"></span>

<span class="cm">/* Allocate the controller structure and setup the linux irq descs</span>
<span class="cm"> * for the range if interrupts passed in. No HW initialization is</span>
<span class="cm"> * actually performed.</span>
<span class="cm"> * </span>
<span class="cm"> * @phys_addr:	physial base address of the MPIC</span>
<span class="cm"> * @flags:	flags, see constants above</span>
<span class="cm"> * @isu_size:	number of interrupts in an ISU. Use 0 to use a</span>
<span class="cm"> *              standard ISU-less setup (aka powermac)</span>
<span class="cm"> * @irq_offset: first irq number to assign to this mpic</span>
<span class="cm"> * @irq_count:  number of irqs to use with this mpic IRQ sources. Pass 0</span>
<span class="cm"> *	        to match the number of sources</span>
<span class="cm"> * @ipi_offset: first irq number to assign to this mpic IPI sources,</span>
<span class="cm"> *		used only on primary mpic</span>
<span class="cm"> * @senses:	array of sense values</span>
<span class="cm"> * @senses_num: number of entries in the array</span>
<span class="cm"> *</span>
<span class="cm"> * Note about the sense array. If none is passed, all interrupts are</span>
<span class="cm"> * setup to be level negative unless MPIC_U3_HT_IRQS is set in which</span>
<span class="cm"> * case they are edge positive (and the array is ignored anyway).</span>
<span class="cm"> * The values in the array start at the first source of the MPIC,</span>
<span class="cm"> * that is senses[0] correspond to linux irq &quot;irq_offset&quot;.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
			       <span class="n">phys_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isu_size</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_count</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>

<span class="cm">/* Assign ISUs, to call before mpic_init()</span>
<span class="cm"> *</span>
<span class="cm"> * @mpic:	controller structure as returned by mpic_alloc()</span>
<span class="cm"> * @isu_num:	ISU number</span>
<span class="cm"> * @phys_addr:	physical address of the ISU</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_assign_isu</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isu_num</span><span class="p">,</span>
			    <span class="n">phys_addr_t</span> <span class="n">phys_addr</span><span class="p">);</span>


<span class="cm">/* Initialize the controller. After this has been called, none of the above</span>
<span class="cm"> * should be called again for this mpic</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * All of the following functions must only be used after the</span>
<span class="cm"> * ISUs have been assigned and the controller fully initialized</span>
<span class="cm"> * with mpic_init()</span>
<span class="cm"> */</span>


<span class="cm">/* Change the priority of an interrupt. Default is 8 for irqs and</span>
<span class="cm"> * 10 for IPIs. You can call this on both IPIs and IRQ numbers, but the</span>
<span class="cm"> * IPI number is then the offset&#39;ed (linux irq number mapped to the IPI)</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_irq_set_priority</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">);</span>

<span class="cm">/* Setup a non-boot CPU */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_setup_this_cpu</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Clean up for kexec (or cpu offline or ...) */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_teardown_this_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">secondary</span><span class="p">);</span>

<span class="cm">/* Get the current cpu priority for this cpu (0..15) */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mpic_cpu_get_priority</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Set the current cpu priority for this cpu */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_cpu_set_priority</span><span class="p">(</span><span class="kt">int</span> <span class="n">prio</span><span class="p">);</span>

<span class="cm">/* Request IPIs on primary mpic */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_request_ipis</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Send a message (IPI) to a given target (cpu number or MSG_*) */</span>
<span class="kt">void</span> <span class="n">smp_mpic_message_pass</span><span class="p">(</span><span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg</span><span class="p">);</span>

<span class="cm">/* Unmask a specific virq */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="cm">/* Mask a specific virq */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="cm">/* EOI a specific virq */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mpic_end_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>

<span class="cm">/* Fetch interrupt from a given mpic */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpic_get_one_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">);</span>
<span class="cm">/* This one gets from the primary mpic */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpic_get_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cm">/* This one gets from the primary mpic via CoreInt*/</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpic_get_coreint_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cm">/* Fetch Machine Check interrupt from primary mpic */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mpic_get_mcirq</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Set the EPIC clock ratio */</span>
<span class="kt">void</span> <span class="n">mpic_set_clk_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clock_ratio</span><span class="p">);</span>

<span class="cm">/* Enable/Disable EPIC serial interrupt mode */</span>
<span class="kt">void</span> <span class="n">mpic_set_serial_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>
<span class="cp">#endif	</span><span class="cm">/* _ASM_POWERPC_MPIC_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
