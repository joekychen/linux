<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › include › asm › exception-64e.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>exception-64e.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Definitions for use by exception code on Book3-E</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2008 Ben. Herrenschmidt (benh@kernel.crashing.org), IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version</span>
<span class="cm"> *  2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ASM_POWERPC_EXCEPTION_64E_H</span>
<span class="cp">#define _ASM_POWERPC_EXCEPTION_64E_H</span>

<span class="cm">/*</span>
<span class="cm"> * SPRGs usage an other considerations...</span>
<span class="cm"> *</span>
<span class="cm"> * Since TLB miss and other standard exceptions can be interrupted by</span>
<span class="cm"> * critical exceptions which can themselves be interrupted by machine</span>
<span class="cm"> * checks, and since the two later can themselves cause a TLB miss when</span>
<span class="cm"> * hitting the linear mapping for the kernel stacks, we need to be a bit</span>
<span class="cm"> * creative on how we use SPRGs.</span>
<span class="cm"> *</span>
<span class="cm"> * The base idea is that we have one SRPG reserved for critical and one</span>
<span class="cm"> * for machine check interrupts. Those are used to save a GPR that can</span>
<span class="cm"> * then be used to get the PACA, and store as much context as we need</span>
<span class="cm"> * to save in there. That includes saving the SPRGs used by the TLB miss</span>
<span class="cm"> * handler for linear mapping misses and the associated SRR0/1 due to</span>
<span class="cm"> * the above re-entrancy issue.</span>
<span class="cm"> *</span>
<span class="cm"> * So here&#39;s the current usage pattern. It&#39;s done regardless of which</span>
<span class="cm"> * SPRGs are user-readable though, thus we might have to change some of</span>
<span class="cm"> * this later. In order to do that more easily, we use special constants</span>
<span class="cm"> * for naming them</span>
<span class="cm"> *</span>
<span class="cm"> * WARNING: Some of these SPRGs are user readable. We need to do something</span>
<span class="cm"> * about it as some point by making sure they can&#39;t be used to leak kernel</span>
<span class="cm"> * critical data</span>
<span class="cm"> */</span>


<span class="cm">/* We are out of SPRGs so we save some things in the PACA. The normal</span>
<span class="cm"> * exception frame is smaller than the CRIT or MC one though</span>
<span class="cm"> */</span>
<span class="cp">#define EX_R1		(0 * 8)</span>
<span class="cp">#define EX_CR		(1 * 8)</span>
<span class="cp">#define EX_R10		(2 * 8)</span>
<span class="cp">#define EX_R11		(3 * 8)</span>
<span class="cp">#define EX_R14		(4 * 8)</span>
<span class="cp">#define EX_R15		(5 * 8)</span>

<span class="cm">/*</span>
<span class="cm"> * The TLB miss exception uses different slots.</span>
<span class="cm"> *</span>
<span class="cm"> * The bolted variant uses only the first six fields,</span>
<span class="cm"> * which in combination with pgd and kernel_pgd fits in</span>
<span class="cm"> * one 64-byte cache line.</span>
<span class="cm"> */</span>

<span class="cp">#define EX_TLB_R10	( 0 * 8)</span>
<span class="cp">#define EX_TLB_R11	( 1 * 8)</span>
<span class="cp">#define EX_TLB_R14	( 2 * 8)</span>
<span class="cp">#define EX_TLB_R15	( 3 * 8)</span>
<span class="cp">#define EX_TLB_R16	( 4 * 8)</span>
<span class="cp">#define EX_TLB_CR	( 5 * 8)</span>
<span class="cp">#define EX_TLB_R12	( 6 * 8)</span>
<span class="cp">#define EX_TLB_R13	( 7 * 8)</span>
<span class="cp">#define EX_TLB_DEAR	( 8 * 8) </span><span class="cm">/* Level 0 and 2 only */</span><span class="cp"></span>
<span class="cp">#define EX_TLB_ESR	( 9 * 8) </span><span class="cm">/* Level 0 and 2 only */</span><span class="cp"></span>
<span class="cp">#define EX_TLB_SRR0	(10 * 8)</span>
<span class="cp">#define EX_TLB_SRR1	(11 * 8)</span>
<span class="cp">#ifdef CONFIG_BOOK3E_MMU_TLB_STATS</span>
<span class="cp">#define EX_TLB_R8	(12 * 8)</span>
<span class="cp">#define EX_TLB_R9	(13 * 8)</span>
<span class="cp">#define EX_TLB_LR	(14 * 8)</span>
<span class="cp">#define EX_TLB_SIZE	(15 * 8)</span>
<span class="cp">#else</span>
<span class="cp">#define EX_TLB_SIZE	(12 * 8)</span>
<span class="cp">#endif</span>

<span class="cp">#define	START_EXCEPTION(label)						\</span>
<span class="cp">	.globl exc_##label##_book3e;					\</span>
<span class="cp">exc_##label##_book3e:</span>

<span class="cm">/* TLB miss exception prolog</span>
<span class="cm"> *</span>
<span class="cm"> * This prolog handles re-entrancy (up to 3 levels supported in the PACA</span>
<span class="cm"> * though we currently don&#39;t test for overflow). It provides you with a</span>
<span class="cm"> * re-entrancy safe working space of r10...r16 and CR with r12 being used</span>
<span class="cm"> * as the exception area pointer in the PACA for that level of re-entrancy</span>
<span class="cm"> * and r13 containing the PACA pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * SRR0 and SRR1 are saved, but DEAR and ESR are not, since they don&#39;t apply</span>
<span class="cm"> * as-is for instruction exceptions. It&#39;s up to the actual exception code</span>
<span class="cm"> * to save them as well if required.</span>
<span class="cm"> */</span>
<span class="cp">#define TLB_MISS_PROLOG							    \</span>
<span class="cp">	mtspr	SPRN_SPRG_TLB_SCRATCH,r12;				    \</span>
<span class="cp">	mfspr	r12,SPRN_SPRG_TLB_EXFRAME;				    \</span>
<span class="cp">	std	r10,EX_TLB_R10(r12);					    \</span>
<span class="cp">	mfcr	r10;							    \</span>
<span class="cp">	std	r11,EX_TLB_R11(r12);					    \</span>
<span class="cp">	mfspr	r11,SPRN_SPRG_TLB_SCRATCH;				    \</span>
<span class="cp">	std	r13,EX_TLB_R13(r12);					    \</span>
<span class="cp">	mfspr	r13,SPRN_SPRG_PACA;					    \</span>
<span class="cp">	std	r14,EX_TLB_R14(r12);					    \</span>
<span class="cp">	addi	r14,r12,EX_TLB_SIZE;					    \</span>
<span class="cp">	std	r15,EX_TLB_R15(r12);					    \</span>
<span class="cp">	mfspr	r15,SPRN_SRR1;						    \</span>
<span class="cp">	std	r16,EX_TLB_R16(r12);					    \</span>
<span class="cp">	mfspr	r16,SPRN_SRR0;						    \</span>
<span class="cp">	std	r10,EX_TLB_CR(r12);					    \</span>
<span class="cp">	std	r11,EX_TLB_R12(r12);					    \</span>
<span class="cp">	mtspr	SPRN_SPRG_TLB_EXFRAME,r14;				    \</span>
<span class="cp">	std	r15,EX_TLB_SRR1(r12);					    \</span>
<span class="cp">	std	r16,EX_TLB_SRR0(r12);					    \</span>
<span class="cp">	TLB_MISS_PROLOG_STATS</span>

<span class="cm">/* And these are the matching epilogs that restores things</span>
<span class="cm"> *</span>
<span class="cm"> * There are 3 epilogs:</span>
<span class="cm"> *</span>
<span class="cm"> * - SUCCESS       : Unwinds one level</span>
<span class="cm"> * - ERROR         : restore from level 0 and reset</span>
<span class="cm"> * - ERROR_SPECIAL : restore from current level and reset</span>
<span class="cm"> *</span>
<span class="cm"> * Normal errors use ERROR, that is, they restore the initial fault context</span>
<span class="cm"> * and trigger a fault. However, there is a special case for linear mapping</span>
<span class="cm"> * errors. Those should basically never happen, but if they do happen, we</span>
<span class="cm"> * want the error to point out the context that did that linear mapping</span>
<span class="cm"> * fault, not the initial level 0 (basically, we got a bogus PGF or something</span>
<span class="cm"> * like that). For userland errors on the linear mapping, there is no</span>
<span class="cm"> * difference since those are always level 0 anyway</span>
<span class="cm"> */</span>

<span class="cp">#define TLB_MISS_RESTORE(freg)						    \</span>
<span class="cp">	ld	r14,EX_TLB_CR(r12);					    \</span>
<span class="cp">	ld	r10,EX_TLB_R10(r12);					    \</span>
<span class="cp">	ld	r15,EX_TLB_SRR0(r12);					    \</span>
<span class="cp">	ld	r16,EX_TLB_SRR1(r12);					    \</span>
<span class="cp">	mtspr	SPRN_SPRG_TLB_EXFRAME,freg;				    \</span>
<span class="cp">	ld	r11,EX_TLB_R11(r12);					    \</span>
<span class="cp">	mtcr	r14;							    \</span>
<span class="cp">	ld	r13,EX_TLB_R13(r12);					    \</span>
<span class="cp">	ld	r14,EX_TLB_R14(r12);					    \</span>
<span class="cp">	mtspr	SPRN_SRR0,r15;						    \</span>
<span class="cp">	ld	r15,EX_TLB_R15(r12);					    \</span>
<span class="cp">	mtspr	SPRN_SRR1,r16;						    \</span>
<span class="cp">	TLB_MISS_RESTORE_STATS						    \</span>
<span class="cp">	ld	r16,EX_TLB_R16(r12);					    \</span>
<span class="cp">	ld	r12,EX_TLB_R12(r12);					    \</span>

<span class="cp">#define TLB_MISS_EPILOG_SUCCESS						    \</span>
<span class="cp">	TLB_MISS_RESTORE(r12)</span>

<span class="cp">#define TLB_MISS_EPILOG_ERROR						    \</span>
<span class="cp">	addi	r12,r13,PACA_EXTLB;					    \</span>
<span class="cp">	TLB_MISS_RESTORE(r12)</span>

<span class="cp">#define TLB_MISS_EPILOG_ERROR_SPECIAL					    \</span>
<span class="cp">	addi	r11,r13,PACA_EXTLB;					    \</span>
<span class="cp">	TLB_MISS_RESTORE(r11)</span>

<span class="cp">#ifdef CONFIG_BOOK3E_MMU_TLB_STATS</span>
<span class="cp">#define TLB_MISS_PROLOG_STATS						    \</span>
<span class="cp">	mflr	r10;							    \</span>
<span class="cp">	std	r8,EX_TLB_R8(r12);					    \</span>
<span class="cp">	std	r9,EX_TLB_R9(r12);					    \</span>
<span class="cp">	std	r10,EX_TLB_LR(r12);</span>
<span class="cp">#define TLB_MISS_RESTORE_STATS					            \</span>
<span class="cp">	ld	r16,EX_TLB_LR(r12);					    \</span>
<span class="cp">	ld	r9,EX_TLB_R9(r12);					    \</span>
<span class="cp">	ld	r8,EX_TLB_R8(r12);					    \</span>
<span class="cp">	mtlr	r16;</span>
<span class="cp">#define TLB_MISS_PROLOG_STATS_BOLTED						    \</span>
<span class="cp">	mflr	r10;							    \</span>
<span class="cp">	std	r8,PACA_EXTLB+EX_TLB_R8(r13);				    \</span>
<span class="cp">	std	r9,PACA_EXTLB+EX_TLB_R9(r13);				    \</span>
<span class="cp">	std	r10,PACA_EXTLB+EX_TLB_LR(r13);</span>
<span class="cp">#define TLB_MISS_RESTORE_STATS_BOLTED					            \</span>
<span class="cp">	ld	r16,PACA_EXTLB+EX_TLB_LR(r13);				    \</span>
<span class="cp">	ld	r9,PACA_EXTLB+EX_TLB_R9(r13);				    \</span>
<span class="cp">	ld	r8,PACA_EXTLB+EX_TLB_R8(r13);				    \</span>
<span class="cp">	mtlr	r16;</span>
<span class="cp">#define TLB_MISS_STATS_D(name)						    \</span>
<span class="cp">	addi	r9,r13,MMSTAT_DSTATS+name;				    \</span>
<span class="cp">	bl	.tlb_stat_inc;</span>
<span class="cp">#define TLB_MISS_STATS_I(name)						    \</span>
<span class="cp">	addi	r9,r13,MMSTAT_ISTATS+name;				    \</span>
<span class="cp">	bl	.tlb_stat_inc;</span>
<span class="cp">#define TLB_MISS_STATS_X(name)						    \</span>
<span class="cp">	ld	r8,PACA_EXTLB+EX_TLB_ESR(r13);				    \</span>
<span class="cp">	cmpdi	cr2,r8,-1;						    \</span>
<span class="cp">	beq	cr2,61f;						    \</span>
<span class="cp">	addi	r9,r13,MMSTAT_DSTATS+name;				    \</span>
<span class="cp">	b	62f;							    \</span>
<span class="cp">61:	addi	r9,r13,MMSTAT_ISTATS+name;				    \</span>
<span class="cp">62:	bl	.tlb_stat_inc;</span>
<span class="cp">#define TLB_MISS_STATS_SAVE_INFO					    \</span>
<span class="cp">	std	r14,EX_TLB_ESR(r12);	</span><span class="cm">/* save ESR */</span><span class="cp"></span>
<span class="cp">#define TLB_MISS_STATS_SAVE_INFO_BOLTED					    \</span>
<span class="cp">	std	r14,PACA_EXTLB+EX_TLB_ESR(r13);	</span><span class="cm">/* save ESR */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define TLB_MISS_PROLOG_STATS</span>
<span class="cp">#define TLB_MISS_RESTORE_STATS</span>
<span class="cp">#define TLB_MISS_PROLOG_STATS_BOLTED</span>
<span class="cp">#define TLB_MISS_RESTORE_STATS_BOLTED</span>
<span class="cp">#define TLB_MISS_STATS_D(name)</span>
<span class="cp">#define TLB_MISS_STATS_I(name)</span>
<span class="cp">#define TLB_MISS_STATS_X(name)</span>
<span class="cp">#define TLB_MISS_STATS_Y(name)</span>
<span class="cp">#define TLB_MISS_STATS_SAVE_INFO</span>
<span class="cp">#define TLB_MISS_STATS_SAVE_INFO_BOLTED</span>
<span class="cp">#endif</span>

<span class="cp">#define SET_IVOR(vector_number, vector_offset)	\</span>
<span class="cp">	li	r3,vector_offset@l; 		\</span>
<span class="cp">	ori	r3,r3,interrupt_base_book3e@l;	\</span>
<span class="cp">	mtspr	SPRN_IVOR##vector_number,r3;</span>

<span class="cp">#endif </span><span class="cm">/* _ASM_POWERPC_EXCEPTION_64E_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
