<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › include › asm › kvm_book3s.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>kvm_book3s.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright SUSE Linux Products GmbH 2009</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Alexander Graf &lt;agraf@suse.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __ASM_KVM_BOOK3S_H__</span>
<span class="cp">#define __ASM_KVM_BOOK3S_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_book3s_asm.h&gt;</span>

<span class="k">struct</span> <span class="n">kvmppc_bat</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">raw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bepi</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bepi_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">brpn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wimg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vs</span>		<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vp</span>		<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kvmppc_sid_map</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">guest_vsid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">guest_esid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">host_vsid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">valid</span>	<span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define SID_MAP_BITS    9</span>
<span class="cp">#define SID_MAP_NUM     (1 &lt;&lt; SID_MAP_BITS)</span>
<span class="cp">#define SID_MAP_MASK    (SID_MAP_NUM - 1)</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
<span class="cp">#define SID_CONTEXTS	1</span>
<span class="cp">#else</span>
<span class="cp">#define SID_CONTEXTS	128</span>
<span class="cp">#define VSID_POOL_SIZE	(SID_CONTEXTS * 16)</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">hpte_cache</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">list_pte</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">list_pte_long</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">list_vpte</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">list_vpte_long</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu_head</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">host_va</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_pte</span> <span class="n">pte</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="n">vcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">shadow_vcpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_sid_map</span> <span class="n">sid_map</span><span class="p">[</span><span class="n">SID_MAP_NUM</span><span class="p">];</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">esid</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">vsid</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">slb_shadow</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">slb_shadow_max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_bat</span> <span class="n">ibat</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">kvmppc_bat</span> <span class="n">dbat</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">hid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">gqr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">sdr1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hior</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msr_mask</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
	<span class="n">u32</span> <span class="n">vsid_pool</span><span class="p">[</span><span class="n">VSID_POOL_SIZE</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">vsid_next</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">u64</span> <span class="n">proto_vsid_first</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">proto_vsid_max</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">proto_vsid_next</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">context_id</span><span class="p">[</span><span class="n">SID_CONTEXTS</span><span class="p">];</span>

	<span class="n">bool</span> <span class="n">hior_explicit</span><span class="p">;</span>		<span class="cm">/* HIOR is set by ioctl, not PVR */</span>

	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">hpte_hash_pte</span><span class="p">[</span><span class="n">HPTEG_HASH_NUM_PTE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">hpte_hash_pte_long</span><span class="p">[</span><span class="n">HPTEG_HASH_NUM_PTE_LONG</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">hpte_hash_vpte</span><span class="p">[</span><span class="n">HPTEG_HASH_NUM_VPTE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="n">hpte_hash_vpte_long</span><span class="p">[</span><span class="n">HPTEG_HASH_NUM_VPTE_LONG</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">hpte_cache_count</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mmu_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define CONTEXT_HOST		0</span>
<span class="cp">#define CONTEXT_GUEST		1</span>
<span class="cp">#define CONTEXT_GUEST_END	2</span>

<span class="cp">#define VSID_REAL	0x1fffffffffc00000ULL</span>
<span class="cp">#define VSID_BAT	0x1fffffffffb00000ULL</span>
<span class="cp">#define VSID_REAL_DR	0x2000000000000000ULL</span>
<span class="cp">#define VSID_REAL_IR	0x4000000000000000ULL</span>
<span class="cp">#define VSID_PR		0x8000000000000000ULL</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_pte_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">ea</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">ea_mask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_pte_vflush</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vp_mask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_pte_pflush</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">pa_start</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">pa_end</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_set_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">new_msr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_set_pvr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pvr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_book3s_64_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_book3s_32_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_book3s_hv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_mmu_map_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvmppc_pte</span> <span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">eaddr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_flush_segments</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_book3s_hv_page_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">kvmppc_hv_find_lock_hpte</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slb_v</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valid</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_hpte_cache_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpte_cache</span> <span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">hpte_cache</span> <span class="o">*</span><span class="n">kvmppc_mmu_hpte_cache_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_hpte_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_mmu_hpte_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_invalidate_pte</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hpte_cache</span> <span class="o">*</span><span class="n">pte</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_mmu_hpte_sysinit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_mmu_hpte_sysexit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_mmu_hv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_ld</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">eaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_st</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="o">*</span><span class="n">eaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_inject_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="n">u64</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_set_bat</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvmppc_bat</span> <span class="o">*</span><span class="n">bat</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">upper</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">msr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_emulate_paired_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">pfn_t</span> <span class="n">kvmppc_gfn_to_pfn</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_add_revmap_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">revmap_entry</span> <span class="o">*</span><span class="n">rev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rmap</span><span class="p">,</span> <span class="kt">long</span> <span class="n">pte_index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">realmode</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_invalidate_hpte</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">hptep</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte_index</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">kvmppc_clear_ref_hpte</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">hptep</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte_index</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kvmppc_pin_guest_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">nb_ret</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_unpin_guest_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">kvmppc_virtmode_h_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
			<span class="kt">long</span> <span class="n">pte_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pteh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptel</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">kvmppc_h_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span>
			<span class="kt">long</span> <span class="n">pte_index</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pteh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptel</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">kvmppc_hv_get_dirty_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">memslot</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_entry_trampoline</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_hv_entry_trampoline</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_load_up_fpu</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_load_up_altivec</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvmppc_load_up_vsx</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">kvmppc_alignment_dsisr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inst</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">ulong</span> <span class="n">kvmppc_alignment_dar</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inst</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">kvmppc_h_pr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="o">*</span><span class="nf">to_book3s</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">kvm_return_point</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Also add subarch specific defines */</span>

<span class="cp">#ifdef CONFIG_KVM_BOOK3S_32_HANDLER</span>
<span class="cp">#include &lt;asm/kvm_book3s_32.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_HANDLER</span>
<span class="cp">#include &lt;asm/kvm_book3s_64.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_KVM_BOOK3S_PR</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvmppc_interrupt_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_update_int_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending_now</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_pending</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending_now</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">int_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_pending</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">int_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_gpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
		<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_gpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">ulong</span> <span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_xer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_xer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">xer</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_lr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">lr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_lr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">lr</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_last_inst</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Load the instruction manually if it failed to do so in the</span>
<span class="cm">	 * exit path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">last_inst</span> <span class="o">==</span> <span class="n">KVM_INST_FETCH_FAILED</span><span class="p">)</span>
		<span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">last_inst</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">last_inst</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_fault_dar</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">fault_dar</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">kvmppc_critical_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">crit_raw</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">critical</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">crit_r1</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">crit</span><span class="p">;</span>

	<span class="cm">/* Truncate crit indicators in 32 bit mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">crit_raw</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">crit_r1</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Critical section when crit == r1 */</span>
	<span class="n">crit</span> <span class="o">=</span> <span class="p">(</span><span class="n">crit_raw</span> <span class="o">==</span> <span class="n">crit_r1</span><span class="p">);</span>
	<span class="cm">/* ... and we&#39;re in supervisor mode */</span>
	<span class="n">crit</span> <span class="o">=</span> <span class="n">crit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">crit</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_KVM_BOOK3S_PR */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvmppc_interrupt_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_update_int_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending_now</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_pending</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_gpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_gpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">gpr</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_xer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">xer</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_xer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">xer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_ctr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ctr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_lr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_lr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_set_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_pc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">kvmppc_get_last_inst</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/* Load the instruction manually if it failed to do so in the</span>
<span class="cm">	 * exit path */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">last_inst</span> <span class="o">==</span> <span class="n">KVM_INST_FETCH_FAILED</span><span class="p">)</span>
		<span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">last_inst</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">last_inst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">ulong</span> <span class="nf">kvmppc_get_fault_dar</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_dar</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">kvmppc_critical_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Magic register values loaded into r3 and r4 before the &#39;sc&#39; assembly</span>
<span class="cm"> * instruction for the OSI hypercalls */</span>
<span class="cp">#define OSI_SC_MAGIC_R3			0x113724FA</span>
<span class="cp">#define OSI_SC_MAGIC_R4			0x77810F9B</span>

<span class="cp">#define INS_DCBZ			0x7c0007ec</span>

<span class="cm">/* LPIDs we support with this build -- runtime limit may be lower */</span>
<span class="cp">#define KVMPPC_NR_LPIDS			(LPID_RSVD + 1)</span>

<span class="cp">#endif </span><span class="cm">/* __ASM_KVM_BOOK3S_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
