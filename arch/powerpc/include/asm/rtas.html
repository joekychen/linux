<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › include › asm › rtas.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rtas.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _POWERPC_RTAS_H</span>
<span class="cp">#define _POWERPC_RTAS_H</span>
<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Definitions for talking to the RTAS on CHRP machines.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2001 Peter Bergner</span>
<span class="cm"> * Copyright (C) 2001 PPC 64 Team, IBM Corp</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#define RTAS_UNKNOWN_SERVICE (-1)</span>
<span class="cp">#define RTAS_INSTANTIATE_MAX (1ULL&lt;&lt;30) </span><span class="cm">/* Don&#39;t instantiate rtas at/above this value */</span><span class="cp"></span>

<span class="cm">/* Buffer size for ppc_rtas system call. */</span>
<span class="cp">#define RTAS_RMOBUF_MAX (64 * 1024)</span>

<span class="cm">/* RTAS return status codes */</span>
<span class="cp">#define RTAS_NOT_SUSPENDABLE	-9004</span>
<span class="cp">#define RTAS_BUSY		-2    </span><span class="cm">/* RTAS Busy */</span><span class="cp"></span>
<span class="cp">#define RTAS_EXTENDED_DELAY_MIN	9900</span>
<span class="cp">#define RTAS_EXTENDED_DELAY_MAX	9905</span>

<span class="cm">/*</span>
<span class="cm"> * In general to call RTAS use rtas_token(&quot;string&quot;) to lookup</span>
<span class="cm"> * an RTAS token for the given string (e.g. &quot;event-scan&quot;).</span>
<span class="cm"> * To actually perform the call use</span>
<span class="cm"> *    ret = rtas_call(token, n_in, n_out, ...)</span>
<span class="cm"> * Where n_in is the number of input parameters and</span>
<span class="cm"> *       n_out is the number of output parameters</span>
<span class="cm"> *</span>
<span class="cm"> * If the &quot;string&quot; is invalid on this system, RTAS_UNKNOWN_SERVICE</span>
<span class="cm"> * will be returned as a token.  rtas_call() does look for this</span>
<span class="cm"> * token and error out gracefully so rtas_call(rtas_token(&quot;str&quot;), ...)</span>
<span class="cm"> * may be safely used for one-shot calls to RTAS.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="n">u32</span> <span class="n">rtas_arg_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rtas_args</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nargs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nret</span><span class="p">;</span> 
	<span class="n">rtas_arg_t</span> <span class="n">args</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">rtas_arg_t</span> <span class="o">*</span><span class="n">rets</span><span class="p">;</span>     <span class="cm">/* Pointer to return values in args[]. */</span>
<span class="p">};</span>  

<span class="k">struct</span> <span class="n">rtas_t</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>		<span class="cm">/* physical address pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>		<span class="cm">/* physical address pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">arch_spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rtas_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>	<span class="cm">/* virtual address pointer */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtas_suspend_me_data</span> <span class="p">{</span>
	<span class="n">atomic_t</span> <span class="n">working</span><span class="p">;</span> <span class="cm">/* number of cpus accessing this struct */</span>
	<span class="n">atomic_t</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">token</span><span class="p">;</span> <span class="cm">/* ibm,suspend-me */</span>
	<span class="n">atomic_t</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">complete</span><span class="p">;</span> <span class="cm">/* wait on this until working == 0 */</span>
<span class="p">};</span>

<span class="cm">/* RTAS event classes */</span>
<span class="cp">#define RTAS_INTERNAL_ERROR		0x80000000 </span><span class="cm">/* set bit 0 */</span><span class="cp"></span>
<span class="cp">#define RTAS_EPOW_WARNING		0x40000000 </span><span class="cm">/* set bit 1 */</span><span class="cp"></span>
<span class="cp">#define RTAS_HOTPLUG_EVENTS		0x10000000 </span><span class="cm">/* set bit 3 */</span><span class="cp"></span>
<span class="cp">#define RTAS_IO_EVENTS			0x08000000 </span><span class="cm">/* set bit 4 */</span><span class="cp"></span>
<span class="cp">#define RTAS_EVENT_SCAN_ALL_EVENTS	0xffffffff</span>

<span class="cm">/* RTAS event severity */</span>
<span class="cp">#define RTAS_SEVERITY_FATAL		0x5</span>
<span class="cp">#define RTAS_SEVERITY_ERROR		0x4</span>
<span class="cp">#define RTAS_SEVERITY_ERROR_SYNC	0x3</span>
<span class="cp">#define RTAS_SEVERITY_WARNING		0x2</span>
<span class="cp">#define RTAS_SEVERITY_EVENT		0x1</span>
<span class="cp">#define RTAS_SEVERITY_NO_ERROR		0x0</span>

<span class="cm">/* RTAS event disposition */</span>
<span class="cp">#define RTAS_DISP_FULLY_RECOVERED	0x0</span>
<span class="cp">#define RTAS_DISP_LIMITED_RECOVERY	0x1</span>
<span class="cp">#define RTAS_DISP_NOT_RECOVERED		0x2</span>

<span class="cm">/* RTAS event initiator */</span>
<span class="cp">#define RTAS_INITIATOR_UNKNOWN		0x0</span>
<span class="cp">#define RTAS_INITIATOR_CPU		0x1</span>
<span class="cp">#define RTAS_INITIATOR_PCI		0x2</span>
<span class="cp">#define RTAS_INITIATOR_ISA		0x3</span>
<span class="cp">#define RTAS_INITIATOR_MEMORY		0x4</span>
<span class="cp">#define RTAS_INITIATOR_POWERMGM		0x5</span>

<span class="cm">/* RTAS event target */</span>
<span class="cp">#define RTAS_TARGET_UNKNOWN		0x0</span>
<span class="cp">#define RTAS_TARGET_CPU			0x1</span>
<span class="cp">#define RTAS_TARGET_PCI			0x2</span>
<span class="cp">#define RTAS_TARGET_ISA			0x3</span>
<span class="cp">#define RTAS_TARGET_MEMORY		0x4</span>
<span class="cp">#define RTAS_TARGET_POWERMGM		0x5</span>

<span class="cm">/* RTAS event type */</span>
<span class="cp">#define RTAS_TYPE_RETRY			0x01</span>
<span class="cp">#define RTAS_TYPE_TCE_ERR		0x02</span>
<span class="cp">#define RTAS_TYPE_INTERN_DEV_FAIL	0x03</span>
<span class="cp">#define RTAS_TYPE_TIMEOUT		0x04</span>
<span class="cp">#define RTAS_TYPE_DATA_PARITY		0x05</span>
<span class="cp">#define RTAS_TYPE_ADDR_PARITY		0x06</span>
<span class="cp">#define RTAS_TYPE_CACHE_PARITY		0x07</span>
<span class="cp">#define RTAS_TYPE_ADDR_INVALID		0x08</span>
<span class="cp">#define RTAS_TYPE_ECC_UNCORR		0x09</span>
<span class="cp">#define RTAS_TYPE_ECC_CORR		0x0a</span>
<span class="cp">#define RTAS_TYPE_EPOW			0x40</span>
<span class="cp">#define RTAS_TYPE_PLATFORM		0xE0</span>
<span class="cp">#define RTAS_TYPE_IO			0xE1</span>
<span class="cp">#define RTAS_TYPE_INFO			0xE2</span>
<span class="cp">#define RTAS_TYPE_DEALLOC		0xE3</span>
<span class="cp">#define RTAS_TYPE_DUMP			0xE4</span>
<span class="cm">/* I don&#39;t add PowerMGM events right now, this is a different topic */</span> 
<span class="cp">#define RTAS_TYPE_PMGM_POWER_SW_ON	0x60</span>
<span class="cp">#define RTAS_TYPE_PMGM_POWER_SW_OFF	0x61</span>
<span class="cp">#define RTAS_TYPE_PMGM_LID_OPEN		0x62</span>
<span class="cp">#define RTAS_TYPE_PMGM_LID_CLOSE	0x63</span>
<span class="cp">#define RTAS_TYPE_PMGM_SLEEP_BTN	0x64</span>
<span class="cp">#define RTAS_TYPE_PMGM_WAKE_BTN		0x65</span>
<span class="cp">#define RTAS_TYPE_PMGM_BATTERY_WARN	0x66</span>
<span class="cp">#define RTAS_TYPE_PMGM_BATTERY_CRIT	0x67</span>
<span class="cp">#define RTAS_TYPE_PMGM_SWITCH_TO_BAT	0x68</span>
<span class="cp">#define RTAS_TYPE_PMGM_SWITCH_TO_AC	0x69</span>
<span class="cp">#define RTAS_TYPE_PMGM_KBD_OR_MOUSE	0x6a</span>
<span class="cp">#define RTAS_TYPE_PMGM_ENCLOS_OPEN	0x6b</span>
<span class="cp">#define RTAS_TYPE_PMGM_ENCLOS_CLOSED	0x6c</span>
<span class="cp">#define RTAS_TYPE_PMGM_RING_INDICATE	0x6d</span>
<span class="cp">#define RTAS_TYPE_PMGM_LAN_ATTENTION	0x6e</span>
<span class="cp">#define RTAS_TYPE_PMGM_TIME_ALARM	0x6f</span>
<span class="cp">#define RTAS_TYPE_PMGM_CONFIG_CHANGE	0x70</span>
<span class="cp">#define RTAS_TYPE_PMGM_SERVICE_PROC	0x71</span>

<span class="cm">/* RTAS check-exception vector offset */</span>
<span class="cp">#define RTAS_VECTOR_EXTERNAL_INTERRUPT	0x500</span>

<span class="k">struct</span> <span class="n">rtas_error_log</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">version</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>		<span class="cm">/* Architectural version */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">severity</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>		<span class="cm">/* Severity level of error */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">disposition</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>		<span class="cm">/* Degree of recovery */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">extended</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* extended log present? */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="cm">/* reserved */</span> <span class="o">:</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Reserved for future use */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">initiator</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>		<span class="cm">/* Initiator of event */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">target</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>			<span class="cm">/* Target of failed operation */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>			<span class="cm">/* General event or error*/</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">extended_log_length</span><span class="o">:</span><span class="mi">32</span><span class="p">;</span>	<span class="cm">/* length in bytes */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>		<span class="cm">/* Start of extended log */</span>
						<span class="cm">/* Variable length.      */</span>
<span class="p">};</span>

<span class="cp">#define RTAS_V6EXT_LOG_FORMAT_EVENT_LOG	14</span>

<span class="cp">#define RTAS_V6EXT_COMPANY_ID_IBM	((&#39;I&#39; &lt;&lt; 24) | (&#39;B&#39; &lt;&lt; 16) | (&#39;M&#39; &lt;&lt; 8))</span>

<span class="cm">/* RTAS general extended event log, Version 6. The extended log starts</span>
<span class="cm"> * from &quot;buffer&quot; field of struct rtas_error_log defined above.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rtas_ext_event_log_v6</span> <span class="p">{</span>
	<span class="cm">/* Byte 0 */</span>
	<span class="kt">uint32_t</span> <span class="n">log_valid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 1:Log valid */</span>
	<span class="kt">uint32_t</span> <span class="n">unrecoverable_error</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1:Unrecoverable error */</span>
	<span class="kt">uint32_t</span> <span class="n">recoverable_error</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1:recoverable (correctable	*/</span>
					<span class="cm">/*   or successfully retried)	*/</span>
	<span class="kt">uint32_t</span> <span class="n">degraded_operation</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* 1:Unrecoverable err, bypassed*/</span>
					<span class="cm">/*   - degraded operation (e.g.	*/</span>
					<span class="cm">/*   CPU or mem taken off-line)	*/</span>
	<span class="kt">uint32_t</span> <span class="n">predictive_error</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">new_log</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 1:&quot;New&quot; log (Always 1 for	*/</span>
					<span class="cm">/*   data returned from RTAS	*/</span>
	<span class="kt">uint32_t</span> <span class="n">big_endian</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 1: Big endian */</span>
	<span class="kt">uint32_t</span> <span class="o">:</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* reserved */</span>
	<span class="cm">/* Byte 1 */</span>
	<span class="kt">uint32_t</span> <span class="o">:</span><span class="mi">8</span><span class="p">;</span>			<span class="cm">/* reserved */</span>
	<span class="cm">/* Byte 2 */</span>
	<span class="kt">uint32_t</span> <span class="n">powerpc_format</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Set to 1 (indicating log is	*/</span>
					<span class="cm">/* in PowerPC format		*/</span>
	<span class="kt">uint32_t</span> <span class="o">:</span><span class="mi">3</span><span class="p">;</span>			<span class="cm">/* reserved */</span>
	<span class="kt">uint32_t</span> <span class="n">log_format</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>		<span class="cm">/* Log format indicator. Define	*/</span>
					<span class="cm">/* format used for byte 12-2047	*/</span>
	<span class="cm">/* Byte 3 */</span>
	<span class="kt">uint32_t</span> <span class="o">:</span><span class="mi">8</span><span class="p">;</span>			<span class="cm">/* reserved */</span>
	<span class="cm">/* Byte 4-11 */</span>
	<span class="kt">uint8_t</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>		<span class="cm">/* reserved */</span>
	<span class="cm">/* Byte 12-15 */</span>
	<span class="kt">uint32_t</span> <span class="n">company_id</span><span class="p">;</span>		<span class="cm">/* Company ID of the company	*/</span>
					<span class="cm">/* that defines the format for	*/</span>
					<span class="cm">/* the vendor specific log type	*/</span>
	<span class="cm">/* Byte 16-end of log */</span>
	<span class="kt">uint8_t</span> <span class="n">vendor_log</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>		<span class="cm">/* Start of vendor specific log	*/</span>
					<span class="cm">/* Variable length.		*/</span>
<span class="p">};</span>

<span class="cm">/* pSeries event log format */</span>

<span class="cm">/* Two bytes ASCII section IDs */</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_PRIV_HDR		((&#39;P&#39; &lt;&lt; 8) | &#39;H&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_USER_HDR		((&#39;U&#39; &lt;&lt; 8) | &#39;H&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_PRIMARY_SRC	((&#39;P&#39; &lt;&lt; 8) | &#39;S&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_EXTENDED_UH	((&#39;E&#39; &lt;&lt; 8) | &#39;H&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_FAILING_MTMS	((&#39;M&#39; &lt;&lt; 8) | &#39;T&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_SECONDARY_SRC	((&#39;S&#39; &lt;&lt; 8) | &#39;S&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_DUMP_LOCATOR	((&#39;D&#39; &lt;&lt; 8) | &#39;H&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_FW_ERROR		((&#39;S&#39; &lt;&lt; 8) | &#39;W&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_IMPACT_PART_ID	((&#39;L&#39; &lt;&lt; 8) | &#39;P&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_LOGIC_RESOURCE_ID	((&#39;L&#39; &lt;&lt; 8) | &#39;R&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_HMC_ID		((&#39;H&#39; &lt;&lt; 8) | &#39;M&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_EPOW		((&#39;E&#39; &lt;&lt; 8) | &#39;P&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_IO_EVENT		((&#39;I&#39; &lt;&lt; 8) | &#39;E&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_MANUFACT_INFO	((&#39;M&#39; &lt;&lt; 8) | &#39;I&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_CALL_HOME		((&#39;C&#39; &lt;&lt; 8) | &#39;H&#39;)</span>
<span class="cp">#define PSERIES_ELOG_SECT_ID_USER_DEF		((&#39;U&#39; &lt;&lt; 8) | &#39;D&#39;)</span>

<span class="cm">/* Vendor specific Platform Event Log Format, Version 6, section header */</span>
<span class="k">struct</span> <span class="n">pseries_errorlog</span> <span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">id</span><span class="p">;</span>			<span class="cm">/* 0x00 2-byte ASCII section ID	*/</span>
	<span class="kt">uint16_t</span> <span class="n">length</span><span class="p">;</span>		<span class="cm">/* 0x02 Section length in bytes	*/</span>
	<span class="kt">uint8_t</span> <span class="n">version</span><span class="p">;</span>		<span class="cm">/* 0x04 Section version		*/</span>
	<span class="kt">uint8_t</span> <span class="n">subtype</span><span class="p">;</span>		<span class="cm">/* 0x05 Section subtype		*/</span>
	<span class="kt">uint16_t</span> <span class="n">creator_component</span><span class="p">;</span>	<span class="cm">/* 0x06 Creator component ID	*/</span>
	<span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[];</span>			<span class="cm">/* 0x08 Start of section data	*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pseries_errorlog</span> <span class="o">*</span><span class="n">get_pseries_errorlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtas_error_log</span> <span class="o">*</span><span class="n">log</span><span class="p">,</span>
					      <span class="kt">uint16_t</span> <span class="n">section_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This can be set by the rtas_flash module so that it can get called</span>
<span class="cm"> * as the absolutely last thing before the kernel terminates.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rtas_flash_term_hook</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">rtas_t</span> <span class="n">rtas</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">enter_rtas</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_token</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_service_present</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_call</span><span class="p">(</span><span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_restart</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_halt</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_os_term</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_get_sensor</span><span class="p">(</span><span class="kt">int</span> <span class="n">sensor</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_get_power_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">powerdomain</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">level</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_set_power_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">powerdomain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">setlevel</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">bool</span> <span class="n">rtas_indicator_present</span><span class="p">(</span><span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">maxindex</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_set_indicator</span><span class="p">(</span><span class="kt">int</span> <span class="n">indicator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_value</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_set_indicator_fast</span><span class="p">(</span><span class="kt">int</span> <span class="n">indicator</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_value</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_progress</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hex</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_initialize</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_suspend_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtas_suspend_me_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_suspend_last_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtas_suspend_me_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_ibm_suspend_me</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtas_args</span> <span class="o">*</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">rtc_time</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtas_get_boot_time</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_get_rtc_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">rtc_time</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_set_rtc_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtc_time</span> <span class="o">*</span><span class="n">rtc_time</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtas_busy_delay_time</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtas_busy_delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">early_init_dt_scan_rtas</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">node</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">pSeries_log_error</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fatal</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_RTAS_DAEMON</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">rtas_cancel_event_scan</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtas_cancel_event_scan</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Error types logged.  */</span>
<span class="cp">#define ERR_FLAG_ALREADY_LOGGED	0x0</span>
<span class="cp">#define ERR_FLAG_BOOT		0x1 	</span><span class="cm">/* log was pulled from NVRAM on boot */</span><span class="cp"></span>
<span class="cp">#define ERR_TYPE_RTAS_LOG	0x2	</span><span class="cm">/* from rtas event-scan */</span><span class="cp"></span>
<span class="cp">#define ERR_TYPE_KERNEL_PANIC	0x4	</span><span class="cm">/* from die()/panic() */</span><span class="cp"></span>
<span class="cp">#define ERR_TYPE_KERNEL_PANIC_GZ 0x8	</span><span class="cm">/* ditto, compressed */</span><span class="cp"></span>

<span class="cm">/* All the types and not flags */</span>
<span class="cp">#define ERR_TYPE_MASK \</span>
<span class="cp">	(ERR_TYPE_RTAS_LOG | ERR_TYPE_KERNEL_PANIC | ERR_TYPE_KERNEL_PANIC_GZ)</span>

<span class="cp">#define RTAS_DEBUG KERN_DEBUG &quot;RTAS: &quot;</span>
 
<span class="cp">#define RTAS_ERROR_LOG_MAX 2048</span>

<span class="cm">/*</span>
<span class="cm"> * Return the firmware-specified size of the error log buffer</span>
<span class="cm"> *  for all rtas calls that require an error buffer argument.</span>
<span class="cm"> *  This includes &#39;check-exception&#39; and &#39;rtas-last-error&#39;.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">rtas_get_error_log_max</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Event Scan Parameters */</span>
<span class="cp">#define EVENT_SCAN_ALL_EVENTS	0xf0000000</span>
<span class="cp">#define SURVEILLANCE_TOKEN	9000</span>
<span class="cp">#define LOG_NUMBER		64		</span><span class="cm">/* must be a power of two */</span><span class="cp"></span>
<span class="cp">#define LOG_NUMBER_MASK		(LOG_NUMBER-1)</span>

<span class="cm">/* Some RTAS ops require a data buffer and that buffer must be &lt; 4G.</span>
<span class="cm"> * Rather than having a memory allocator, just use this buffer</span>
<span class="cm"> * (get the lock first), make the RTAS call.  Copy the data instead</span>
<span class="cm"> * of holding the buffer for long.</span>
<span class="cm"> */</span>

<span class="cp">#define RTAS_DATA_BUF_SIZE 4096</span>
<span class="k">extern</span> <span class="n">spinlock_t</span> <span class="n">rtas_data_buf_lock</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">rtas_data_buf</span><span class="p">[</span><span class="n">RTAS_DATA_BUF_SIZE</span><span class="p">];</span>

<span class="cm">/* RMO buffer reserved for user-space RTAS use */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtas_rmo_buf</span><span class="p">;</span>

<span class="cp">#define GLOBAL_INTERRUPT_QUEUE 9005</span>

<span class="cm">/**</span>
<span class="cm"> * rtas_config_addr - Format a busno, devfn and reg for RTAS.</span>
<span class="cm"> * @busno: The bus number.</span>
<span class="cm"> * @devfn: The device and function number as encoded by PCI_DEVFN().</span>
<span class="cm"> * @reg: The register number.</span>
<span class="cm"> *</span>
<span class="cm"> * This function encodes the given busno, devfn and register number as</span>
<span class="cm"> * required for RTAS calls that take a &quot;config_addr&quot; parameter.</span>
<span class="cm"> * See PAPR requirement 7.3.4-1 for more info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rtas_config_addr</span><span class="p">(</span><span class="kt">int</span> <span class="n">busno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">busno</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="n">rtas_give_timebase</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="n">rtas_take_timebase</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_RTAS</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">page_is_rtas_user_buf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&gt;=</span> <span class="n">rtas_rmo_buf</span> <span class="o">&amp;&amp;</span> <span class="n">paddr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rtas_rmo_buf</span> <span class="o">+</span> <span class="n">RTAS_RMOBUF_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">page_is_rtas_user_buf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">call_rtas</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span> <span class="p">...);</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _POWERPC_RTAS_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
