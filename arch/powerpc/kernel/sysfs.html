<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/percpu.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/nodemask.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>

<span class="cp">#include &lt;asm/current.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/hvcall.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/pmc.h&gt;</span>

<span class="cp">#include &quot;cacheinfo.h&quot;</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#include &lt;asm/paca.h&gt;</span>
<span class="cp">#include &lt;asm/lppaca.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">cpu_devices</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SMT snooze delay stuff, 64-bit only for now</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PPC64</span>

<span class="cm">/* Time in microseconds we delay before sleeping in the idle loop */</span>
<span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">long</span><span class="p">,</span> <span class="n">smt_snooze_delay</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">100</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_smt_snooze_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">snooze</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snooze</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">per_cpu</span><span class="p">(</span><span class="n">smt_snooze_delay</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">snooze</span><span class="p">;</span>
	<span class="n">update_smt_snooze_delay</span><span class="p">(</span><span class="n">snooze</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_smt_snooze_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">per_cpu</span><span class="p">(</span><span class="n">smt_snooze_delay</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">smt_snooze_delay</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_smt_snooze_delay</span><span class="p">,</span>
		   <span class="n">store_smt_snooze_delay</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_smt_snooze_delay</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">snooze</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_SMT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">snooze</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span>
		<span class="n">per_cpu</span><span class="p">(</span><span class="n">smt_snooze_delay</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)</span> <span class="o">=</span> <span class="n">snooze</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;smt-snooze-delay=&quot;</span><span class="p">,</span> <span class="n">setup_smt_snooze_delay</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Enabling PMCs will slow partition context switch times so we only do</span>
<span class="cm"> * it the first time we write to the PMCs.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="kt">char</span><span class="p">,</span> <span class="n">pmcs_enabled</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ppc_enable_pmcs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ppc_set_pmu_inuse</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Only need to enable them once */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">pmcs_enabled</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">pmcs_enabled</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">enable_pmcs</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">enable_pmcs</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ppc_enable_pmcs</span><span class="p">);</span>

<span class="cp">#define SYSFS_PMCSETUP(NAME, ADDRESS) \</span>
<span class="cp">static void read_##NAME(void *val) \</span>
<span class="cp">{ \</span>
<span class="cp">	*(unsigned long *)val = mfspr(ADDRESS);	\</span>
<span class="cp">} \</span>
<span class="cp">static void write_##NAME(void *val) \</span>
<span class="cp">{ \</span>
<span class="cp">	ppc_enable_pmcs(); \</span>
<span class="cp">	mtspr(ADDRESS, *(unsigned long *)val);	\</span>
<span class="cp">} \</span>
<span class="cp">static ssize_t show_##NAME(struct device *dev, \</span>
<span class="cp">			struct device_attribute *attr, \</span>
<span class="cp">			char *buf) \</span>
<span class="cp">{ \</span>
<span class="cp">	struct cpu *cpu = container_of(dev, struct cpu, dev); \</span>
<span class="cp">	unsigned long val; \</span>
<span class="cp">	smp_call_function_single(cpu-&gt;dev.id, read_##NAME, &amp;val, 1);	\</span>
<span class="cp">	return sprintf(buf, &quot;%lx\n&quot;, val); \</span>
<span class="cp">} \</span>
<span class="cp">static ssize_t __used \</span>
<span class="cp">	store_##NAME(struct device *dev, struct device_attribute *attr, \</span>
<span class="cp">			const char *buf, size_t count) \</span>
<span class="cp">{ \</span>
<span class="cp">	struct cpu *cpu = container_of(dev, struct cpu, dev); \</span>
<span class="cp">	unsigned long val; \</span>
<span class="cp">	int ret = sscanf(buf, &quot;%lx&quot;, &amp;val); \</span>
<span class="cp">	if (ret != 1) \</span>
<span class="cp">		return -EINVAL; \</span>
<span class="cp">	smp_call_function_single(cpu-&gt;dev.id, write_##NAME, &amp;val, 1); \</span>
<span class="cp">	return count; \</span>
<span class="cp">}</span>


<span class="cm">/* Let&#39;s define all possible registers, we&#39;ll only hook up the ones</span>
<span class="cm"> * that are implemented on the current processor</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_PPC64)</span>
<span class="cp">#define HAS_PPC_PMC_CLASSIC	1</span>
<span class="cp">#define HAS_PPC_PMC_IBM		1</span>
<span class="cp">#define HAS_PPC_PMC_PA6T	1</span>
<span class="cp">#elif defined(CONFIG_6xx)</span>
<span class="cp">#define HAS_PPC_PMC_CLASSIC	1</span>
<span class="cp">#define HAS_PPC_PMC_IBM		1</span>
<span class="cp">#define HAS_PPC_PMC_G4		1</span>
<span class="cp">#endif</span>


<span class="cp">#ifdef HAS_PPC_PMC_CLASSIC</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">mmcr0</span><span class="p">,</span> <span class="n">SPRN_MMCR0</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">mmcr1</span><span class="p">,</span> <span class="n">SPRN_MMCR1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc1</span><span class="p">,</span> <span class="n">SPRN_PMC1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc2</span><span class="p">,</span> <span class="n">SPRN_PMC2</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc3</span><span class="p">,</span> <span class="n">SPRN_PMC3</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc4</span><span class="p">,</span> <span class="n">SPRN_PMC4</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc5</span><span class="p">,</span> <span class="n">SPRN_PMC5</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc6</span><span class="p">,</span> <span class="n">SPRN_PMC6</span><span class="p">);</span>

<span class="cp">#ifdef HAS_PPC_PMC_G4</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">mmcr2</span><span class="p">,</span> <span class="n">SPRN_MMCR2</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc7</span><span class="p">,</span> <span class="n">SPRN_PMC7</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pmc8</span><span class="p">,</span> <span class="n">SPRN_PMC8</span><span class="p">);</span>

<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">mmcra</span><span class="p">,</span> <span class="n">SPRN_MMCRA</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">purr</span><span class="p">,</span> <span class="n">SPRN_PURR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">spurr</span><span class="p">,</span> <span class="n">SPRN_SPURR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">dscr</span><span class="p">,</span> <span class="n">SPRN_DSCR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pir</span><span class="p">,</span> <span class="n">SPRN_PIR</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mmcra</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcra</span><span class="p">,</span> <span class="n">store_mmcra</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">spurr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_spurr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dscr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_dscr</span><span class="p">,</span> <span class="n">store_dscr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">purr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_purr</span><span class="p">,</span> <span class="n">store_purr</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pir</span><span class="p">,</span> <span class="mo">0400</span><span class="p">,</span> <span class="n">show_pir</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dscr_default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dscr_default</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_dscr_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dscr_default</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">__used</span> <span class="nf">store_dscr_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dscr_default</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dscr_default</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span>
		<span class="n">show_dscr_default</span><span class="p">,</span> <span class="n">store_dscr_default</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sysfs_create_dscr_default</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DSCR</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">cpu_subsys</span><span class="p">.</span><span class="n">dev_root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dscr_default</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

<span class="cp">#ifdef HAS_PPC_PMC_PA6T</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc0</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC0</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc1</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc2</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC2</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc3</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC3</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc4</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC4</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pa6t_pmc5</span><span class="p">,</span> <span class="n">SPRN_PA6T_PMC5</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_DEBUG_KERNEL</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">hid0</span><span class="p">,</span> <span class="n">SPRN_HID0</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">hid1</span><span class="p">,</span> <span class="n">SPRN_HID1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">hid4</span><span class="p">,</span> <span class="n">SPRN_HID4</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">hid5</span><span class="p">,</span> <span class="n">SPRN_HID5</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima0</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA0</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima1</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima2</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA2</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima3</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA3</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima4</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA4</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima5</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA5</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima6</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA6</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima7</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA7</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima8</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA8</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ima9</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMA9</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">imaat</span><span class="p">,</span> <span class="n">SPRN_PA6T_IMAAT</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">btcr</span><span class="p">,</span> <span class="n">SPRN_PA6T_BTCR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">pccr</span><span class="p">,</span> <span class="n">SPRN_PA6T_PCCR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">rpccr</span><span class="p">,</span> <span class="n">SPRN_PA6T_RPCCR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="n">SPRN_PA6T_DER</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">mer</span><span class="p">,</span> <span class="n">SPRN_PA6T_MER</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ber</span><span class="p">,</span> <span class="n">SPRN_PA6T_BER</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="n">SPRN_PA6T_IER</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">sier</span><span class="p">,</span> <span class="n">SPRN_PA6T_SIER</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">siar</span><span class="p">,</span> <span class="n">SPRN_PA6T_SIAR</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">tsr0</span><span class="p">,</span> <span class="n">SPRN_PA6T_TSR0</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">tsr1</span><span class="p">,</span> <span class="n">SPRN_PA6T_TSR1</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">tsr2</span><span class="p">,</span> <span class="n">SPRN_PA6T_TSR2</span><span class="p">);</span>
<span class="n">SYSFS_PMCSETUP</span><span class="p">(</span><span class="n">tsr3</span><span class="p">,</span> <span class="n">SPRN_PA6T_TSR3</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_KERNEL */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_PA6T */</span><span class="cp"></span>

<span class="cp">#ifdef HAS_PPC_PMC_IBM</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">ibm_common_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr0</span><span class="p">,</span> <span class="n">store_mmcr0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr1</span><span class="p">,</span> <span class="n">store_mmcr1</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_G4 */</span><span class="cp"></span>

<span class="cp">#ifdef HAS_PPC_PMC_G4</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">g4_common_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr0</span><span class="p">,</span> <span class="n">store_mmcr0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr1</span><span class="p">,</span> <span class="n">store_mmcr1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr2</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr2</span><span class="p">,</span> <span class="n">store_mmcr2</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_G4 */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">classic_pmc_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc1</span><span class="p">,</span> <span class="n">store_pmc1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc2</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc2</span><span class="p">,</span> <span class="n">store_pmc2</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc3</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc3</span><span class="p">,</span> <span class="n">store_pmc3</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc4</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc4</span><span class="p">,</span> <span class="n">store_pmc4</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc5</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc5</span><span class="p">,</span> <span class="n">store_pmc5</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc6</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc6</span><span class="p">,</span> <span class="n">store_pmc6</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc7</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc7</span><span class="p">,</span> <span class="n">store_pmc7</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc8</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pmc8</span><span class="p">,</span> <span class="n">store_pmc8</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef HAS_PPC_PMC_PA6T</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">pa6t_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr0</span><span class="p">,</span> <span class="n">store_mmcr0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mmcr1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mmcr1</span><span class="p">,</span> <span class="n">store_mmcr1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc0</span><span class="p">,</span> <span class="n">store_pa6t_pmc0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc1</span><span class="p">,</span> <span class="n">store_pa6t_pmc1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc2</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc2</span><span class="p">,</span> <span class="n">store_pa6t_pmc2</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc3</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc3</span><span class="p">,</span> <span class="n">store_pa6t_pmc3</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc4</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc4</span><span class="p">,</span> <span class="n">store_pa6t_pmc4</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pmc5</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pa6t_pmc5</span><span class="p">,</span> <span class="n">store_pa6t_pmc5</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_DEBUG_KERNEL</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hid0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_hid0</span><span class="p">,</span> <span class="n">store_hid0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hid1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_hid1</span><span class="p">,</span> <span class="n">store_hid1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hid4</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_hid4</span><span class="p">,</span> <span class="n">store_hid4</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hid5</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_hid5</span><span class="p">,</span> <span class="n">store_hid5</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima0</span><span class="p">,</span> <span class="n">store_ima0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima1</span><span class="p">,</span> <span class="n">store_ima1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima2</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima2</span><span class="p">,</span> <span class="n">store_ima2</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima3</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima3</span><span class="p">,</span> <span class="n">store_ima3</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima4</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima4</span><span class="p">,</span> <span class="n">store_ima4</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima5</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima5</span><span class="p">,</span> <span class="n">store_ima5</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima6</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima6</span><span class="p">,</span> <span class="n">store_ima6</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima7</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima7</span><span class="p">,</span> <span class="n">store_ima7</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima8</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima8</span><span class="p">,</span> <span class="n">store_ima8</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ima9</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ima9</span><span class="p">,</span> <span class="n">store_ima9</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">imaat</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_imaat</span><span class="p">,</span> <span class="n">store_imaat</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">btcr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_btcr</span><span class="p">,</span> <span class="n">store_btcr</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pccr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_pccr</span><span class="p">,</span> <span class="n">store_pccr</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rpccr</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_rpccr</span><span class="p">,</span> <span class="n">store_rpccr</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">der</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_der</span><span class="p">,</span> <span class="n">store_der</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">mer</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_mer</span><span class="p">,</span> <span class="n">store_mer</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ber</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ber</span><span class="p">,</span> <span class="n">store_ber</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">ier</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_ier</span><span class="p">,</span> <span class="n">store_ier</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">sier</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_sier</span><span class="p">,</span> <span class="n">store_sier</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">siar</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_siar</span><span class="p">,</span> <span class="n">store_siar</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tsr0</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_tsr0</span><span class="p">,</span> <span class="n">store_tsr0</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tsr1</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_tsr1</span><span class="p">,</span> <span class="n">store_tsr1</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tsr2</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_tsr2</span><span class="p">,</span> <span class="n">store_tsr2</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">tsr3</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">show_tsr3</span><span class="p">,</span> <span class="n">store_tsr3</span><span class="p">),</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_KERNEL */</span><span class="cp"></span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_PA6T */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_CLASSIC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span> <span class="nf">register_cpu_online</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_devices</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nattrs</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_SMT</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_smt_snooze_delay</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* PMC stuff */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">pmc_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HAS_PPC_PMC_IBM</span>
	<span class="k">case</span> <span class="n">PPC_PMC_IBM</span>:
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">ibm_common_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ibm_common_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="n">classic_pmc_attrs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_IBM */</span><span class="cp"></span>
<span class="cp">#ifdef HAS_PPC_PMC_G4</span>
	<span class="k">case</span> <span class="n">PPC_PMC_G4</span>:
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">g4_common_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g4_common_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="n">classic_pmc_attrs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_G4 */</span><span class="cp"></span>
<span class="cp">#ifdef HAS_PPC_PMC_PA6T</span>
	<span class="k">case</span> <span class="n">PPC_PMC_PA6T</span>:
		<span class="cm">/* PA Semi starts counting at PMC0 */</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">pa6t_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pa6t_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_PA6T */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nattrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc_attrs</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">num_pmcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_MMCRA</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_mmcra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PURR</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_purr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_SPURR</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_spurr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DSCR</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dscr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PPCAS_ARCH_V2</span><span class="p">))</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pir</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

	<span class="n">cacheinfo_cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">unregister_cpu_online</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_devices</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="o">*</span><span class="n">pmc_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nattrs</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hotpluggable</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_SMT</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_smt_snooze_delay</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* PMC stuff */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">pmc_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HAS_PPC_PMC_IBM</span>
	<span class="k">case</span> <span class="n">PPC_PMC_IBM</span>:
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">ibm_common_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ibm_common_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="n">classic_pmc_attrs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_IBM */</span><span class="cp"></span>
<span class="cp">#ifdef HAS_PPC_PMC_G4</span>
	<span class="k">case</span> <span class="n">PPC_PMC_G4</span>:
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">g4_common_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g4_common_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="n">classic_pmc_attrs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_G4 */</span><span class="cp"></span>
<span class="cp">#ifdef HAS_PPC_PMC_PA6T</span>
	<span class="k">case</span> <span class="n">PPC_PMC_PA6T</span>:
		<span class="cm">/* PA Semi starts counting at PMC0 */</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">pa6t_attrs</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pa6t_attrs</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span><span class="p">);</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* HAS_PPC_PMC_PA6T */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">nattrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pmc_attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nattrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmc_attrs</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">num_pmcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmc_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_MMCRA</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_mmcra</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PURR</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_purr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_SPURR</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_spurr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DSCR</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dscr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PPCAS_ARCH_V2</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pir</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

	<span class="n">cacheinfo_cpu_offline</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_CPU_PROBE_RELEASE</span>
<span class="kt">ssize_t</span> <span class="nf">arch_cpu_probe</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">cpu_probe</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">cpu_probe</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">arch_cpu_release</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">cpu_release</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">cpu_release</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ARCH_CPU_PROBE_RELEASE */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HOTPLUG_CPU */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">sysfs_cpu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
	<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
		<span class="n">register_cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_HOTPLUG_CPU</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">unregister_cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">__cpuinitdata</span> <span class="n">sysfs_cpu_nb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">sysfs_cpu_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cpu_mutex</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cpu_add_dev_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_create_file</span><span class="p">(</span><span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">),</span> <span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpu_add_dev_attr</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">cpu_add_dev_attr_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpu_add_dev_attr_group</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">cpu_remove_dev_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">),</span> <span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpu_remove_dev_attr</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">cpu_remove_dev_attr_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">get_cpu_device</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">attrs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpu_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cpu_remove_dev_attr_group</span><span class="p">);</span>


<span class="cm">/* NUMA stuff */</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">register_nodes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUMNODES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">register_one_node</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sysfs_add_device_to_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node_devices</span><span class="p">[</span><span class="n">nid</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span>
			<span class="n">kobject_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sysfs_add_device_to_node</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sysfs_remove_device_from_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">node_devices</span><span class="p">[</span><span class="n">nid</span><span class="p">];</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">kobject_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sysfs_remove_device_from_node</span><span class="p">);</span>

<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">register_nodes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* Only valid if CPU is present. */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_physical_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">physical_id</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_physical_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">topology_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">register_nodes</span><span class="p">();</span>
	<span class="n">register_cpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sysfs_cpu_nb</span><span class="p">);</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">per_cpu</span><span class="p">(</span><span class="n">cpu_devices</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * For now, we just see if the system supports making</span>
<span class="cm">		 * the RTAS calls for CPU hotplug.  But, there may be a</span>
<span class="cm">		 * more comprehensive way to do this for an individual</span>
<span class="cm">		 * CPU.  For instance, the boot cpu might never be valid</span>
<span class="cm">		 * for hotplugging.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">cpu_die</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">hotpluggable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">hotpluggable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">register_cpu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

			<span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_physical_id</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">))</span>
			<span class="n">register_cpu_online</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">sysfs_create_dscr_default</span><span class="p">();</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">topology_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
