<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › rtas-proc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtas-proc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Copyright (C) 2000 Tilmann Bitterberg</span>
<span class="cm"> *   (tilmann@bitterberg.de)</span>
<span class="cm"> *</span>
<span class="cm"> *   RTAS (Runtime Abstraction Services) stuff</span>
<span class="cm"> *   Intention is to provide a clean user interface</span>
<span class="cm"> *   to use the RTAS.</span>
<span class="cm"> *</span>
<span class="cm"> *   TODO:</span>
<span class="cm"> *   Split off a header file and maybe move it to a different</span>
<span class="cm"> *   location. Write Documentation on what the /proc/rtas/ entries</span>
<span class="cm"> *   actually do.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt; </span><span class="cm">/* for ppc_md */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/time.h&gt;</span>

<span class="cm">/* Token for Sensors */</span>
<span class="cp">#define KEY_SWITCH		0x0001</span>
<span class="cp">#define ENCLOSURE_SWITCH	0x0002</span>
<span class="cp">#define THERMAL_SENSOR		0x0003</span>
<span class="cp">#define LID_STATUS		0x0004</span>
<span class="cp">#define POWER_SOURCE		0x0005</span>
<span class="cp">#define BATTERY_VOLTAGE		0x0006</span>
<span class="cp">#define BATTERY_REMAINING	0x0007</span>
<span class="cp">#define BATTERY_PERCENTAGE	0x0008</span>
<span class="cp">#define EPOW_SENSOR		0x0009</span>
<span class="cp">#define BATTERY_CYCLESTATE	0x000a</span>
<span class="cp">#define BATTERY_CHARGING	0x000b</span>

<span class="cm">/* IBM specific sensors */</span>
<span class="cp">#define IBM_SURVEILLANCE	0x2328 </span><span class="cm">/* 9000 */</span><span class="cp"></span>
<span class="cp">#define IBM_FANRPM		0x2329 </span><span class="cm">/* 9001 */</span><span class="cp"></span>
<span class="cp">#define IBM_VOLTAGE		0x232a </span><span class="cm">/* 9002 */</span><span class="cp"></span>
<span class="cp">#define IBM_DRCONNECTOR		0x232b </span><span class="cm">/* 9003 */</span><span class="cp"></span>
<span class="cp">#define IBM_POWERSUPPLY		0x232c </span><span class="cm">/* 9004 */</span><span class="cp"></span>

<span class="cm">/* Status return values */</span>
<span class="cp">#define SENSOR_CRITICAL_HIGH	13</span>
<span class="cp">#define SENSOR_WARNING_HIGH	12</span>
<span class="cp">#define SENSOR_NORMAL		11</span>
<span class="cp">#define SENSOR_WARNING_LOW	10</span>
<span class="cp">#define SENSOR_CRITICAL_LOW	 9</span>
<span class="cp">#define SENSOR_SUCCESS		 0</span>
<span class="cp">#define SENSOR_HW_ERROR		-1</span>
<span class="cp">#define SENSOR_BUSY		-2</span>
<span class="cp">#define SENSOR_NOT_EXIST	-3</span>
<span class="cp">#define SENSOR_DR_ENTITY	-9000</span>

<span class="cm">/* Location Codes */</span>
<span class="cp">#define LOC_SCSI_DEV_ADDR	&#39;A&#39;</span>
<span class="cp">#define LOC_SCSI_DEV_LOC	&#39;B&#39;</span>
<span class="cp">#define LOC_CPU			&#39;C&#39;</span>
<span class="cp">#define LOC_DISKETTE		&#39;D&#39;</span>
<span class="cp">#define LOC_ETHERNET		&#39;E&#39;</span>
<span class="cp">#define LOC_FAN			&#39;F&#39;</span>
<span class="cp">#define LOC_GRAPHICS		&#39;G&#39;</span>
<span class="cm">/* reserved / not used		&#39;H&#39; */</span>
<span class="cp">#define LOC_IO_ADAPTER		&#39;I&#39;</span>
<span class="cm">/* reserved / not used		&#39;J&#39; */</span>
<span class="cp">#define LOC_KEYBOARD		&#39;K&#39;</span>
<span class="cp">#define LOC_LCD			&#39;L&#39;</span>
<span class="cp">#define LOC_MEMORY		&#39;M&#39;</span>
<span class="cp">#define LOC_NV_MEMORY		&#39;N&#39;</span>
<span class="cp">#define LOC_MOUSE		&#39;O&#39;</span>
<span class="cp">#define LOC_PLANAR		&#39;P&#39;</span>
<span class="cp">#define LOC_OTHER_IO		&#39;Q&#39;</span>
<span class="cp">#define LOC_PARALLEL		&#39;R&#39;</span>
<span class="cp">#define LOC_SERIAL		&#39;S&#39;</span>
<span class="cp">#define LOC_DEAD_RING		&#39;T&#39;</span>
<span class="cp">#define LOC_RACKMOUNTED		&#39;U&#39; </span><span class="cm">/* for _u_nit is rack mounted */</span><span class="cp"></span>
<span class="cp">#define LOC_VOLTAGE		&#39;V&#39;</span>
<span class="cp">#define LOC_SWITCH_ADAPTER	&#39;W&#39;</span>
<span class="cp">#define LOC_OTHER		&#39;X&#39;</span>
<span class="cp">#define LOC_FIRMWARE		&#39;Y&#39;</span>
<span class="cp">#define LOC_SCSI		&#39;Z&#39;</span>

<span class="cm">/* Tokens for indicators */</span>
<span class="cp">#define TONE_FREQUENCY		0x0001 </span><span class="cm">/* 0 - 1000 (HZ)*/</span><span class="cp"></span>
<span class="cp">#define TONE_VOLUME		0x0002 </span><span class="cm">/* 0 - 100 (%) */</span><span class="cp"></span>
<span class="cp">#define SYSTEM_POWER_STATE	0x0003 </span>
<span class="cp">#define WARNING_LIGHT		0x0004</span>
<span class="cp">#define DISK_ACTIVITY_LIGHT	0x0005</span>
<span class="cp">#define HEX_DISPLAY_UNIT	0x0006</span>
<span class="cp">#define BATTERY_WARNING_TIME	0x0007</span>
<span class="cp">#define CONDITION_CYCLE_REQUEST	0x0008</span>
<span class="cp">#define SURVEILLANCE_INDICATOR	0x2328 </span><span class="cm">/* 9000 */</span><span class="cp"></span>
<span class="cp">#define DR_ACTION		0x2329 </span><span class="cm">/* 9001 */</span><span class="cp"></span>
<span class="cp">#define DR_INDICATOR		0x232a </span><span class="cm">/* 9002 */</span><span class="cp"></span>
<span class="cm">/* 9003 - 9004: Vendor specific */</span>
<span class="cm">/* 9006 - 9999: Vendor specific */</span>

<span class="cm">/* other */</span>
<span class="cp">#define MAX_SENSORS		 17  </span><span class="cm">/* I only know of 17 sensors */</span><span class="cp">    </span>
<span class="cp">#define MAX_LINELENGTH          256</span>
<span class="cp">#define SENSOR_PREFIX		&quot;ibm,sensor-&quot;</span>
<span class="cp">#define cel_to_fahr(x)		((x*9/5)+32)</span>


<span class="cm">/* Globals */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtas_sensors</span> <span class="n">sensors</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">rtas_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">power_on_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Save the time the user set */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">progress_led</span><span class="p">[</span><span class="n">MAX_LINELENGTH</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtas_tone_frequency</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtas_tone_volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* ****************STRUCTS******************************************* */</span>
<span class="k">struct</span> <span class="n">individual_sensor</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">token</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">quant</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rtas_sensors</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">individual_sensor</span> <span class="n">sensor</span><span class="p">[</span><span class="n">MAX_SENSORS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">quant</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* Declarations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_sensors_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_clock_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ppc_rtas_clock_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_progress_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ppc_rtas_progress_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_poweron_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ppc_rtas_poweron_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ppc_rtas_tone_freq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_tone_freq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ppc_rtas_tone_volume_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_tone_volume_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_rmo_buf_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sensors_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_sensors_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_sensors_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sensors_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">poweron_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_poweron_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_poweron_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">poweron_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ppc_rtas_poweron_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">progress_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_progress_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_progress_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">progress_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ppc_rtas_progress_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clock_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_clock_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_clock_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">clock_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ppc_rtas_clock_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tone_freq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_tone_freq_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_tone_freq_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tone_freq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ppc_rtas_tone_freq_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tone_volume_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_tone_volume_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_tone_volume_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">tone_volume_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ppc_rtas_tone_volume_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rmo_buf_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ppc_rtas_rmo_buf_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ppc_rtas_rmo_buf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">rmo_buf_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ppc_rtas_find_all_sensors</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ppc_rtas_process_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">individual_sensor</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_location_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">individual_sensor</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">check_location_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">check_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">proc_rtas_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">pseries</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rtas_node</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;rtas&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtas_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/progress&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_progress_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/clock&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_clock_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/poweron&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_poweron_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/sensors&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_sensors_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/frequency&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_tone_freq_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/volume&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_tone_volume_operations</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;powerpc/rtas/rmo_buffer&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">ppc_rtas_rmo_buf_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">proc_rtas_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_number</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">39</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">end</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* POWER-ON-TIME                                                      */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ppc_rtas_poweron_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nowtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nowtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">power_on_time</span> <span class="o">=</span> <span class="n">nowtime</span><span class="p">;</span> <span class="cm">/* save the time */</span>

	<span class="n">to_tm</span><span class="p">(</span><span class="n">nowtime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;set-time-for-power-on&quot;</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
			<span class="n">tm</span><span class="p">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span> 
			<span class="n">tm</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* nano */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error: setting poweron time returned: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_poweron_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_on_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Power on time not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">power_on_time</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* PROGRESS                                                           */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ppc_rtas_progress_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">MAX_LINELENGTH</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_LINELENGTH</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">progress_led</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* save the string */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">progress_led</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Lets see if the user passed hexdigits */</span>
	<span class="n">hex</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">progress_led</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">rtas_progress</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">progress_led</span><span class="p">,</span> <span class="n">hex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* clear the line */</span>
	<span class="cm">/* rtas_progress(&quot;                   &quot;, 0xffff);*/</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_progress_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">progress_led</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">progress_led</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* CLOCK                                                              */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ppc_rtas_clock_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nowtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nowtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">to_tm</span><span class="p">(</span><span class="n">nowtime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tm</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;set-time-of-day&quot;</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> 
			<span class="n">tm</span><span class="p">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">,</span> 
			<span class="n">tm</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">tm</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error: setting the clock returned: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_clock_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;get-time-of-day&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error: reading the clock returned: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">;</span>
		<span class="n">year</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">mon</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">day</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">hour</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="n">min</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="n">sec</span>  <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mktime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">mon</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* SENSOR STUFF                                                       */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_sensors_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">get_sensor_state</span> <span class="o">=</span> <span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;get-sensor-state&quot;</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RTAS (RunTime Abstraction Services) Sensor Information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Sensor</span><span class="se">\t\t</span><span class="s">Value</span><span class="se">\t\t</span><span class="s">Condition</span><span class="se">\t</span><span class="s">Location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;********************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_rtas_find_all_sensors</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">No sensors are available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sensors</span><span class="p">.</span><span class="n">quant</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">individual_sensor</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensors</span><span class="p">.</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">rstr</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">llen</span><span class="p">,</span> <span class="n">offs</span><span class="p">;</span>

		<span class="n">sprintf</span> <span class="p">(</span><span class="n">rstr</span><span class="p">,</span> <span class="n">SENSOR_PREFIX</span><span class="s">&quot;%04d&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">);</span>
		<span class="n">loc</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="n">rstr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llen</span><span class="p">);</span>

		<span class="cm">/* A sensor may have multiple instances */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">quant</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span>	<span class="n">rtas_call</span><span class="p">(</span><span class="n">get_sensor_state</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> 
				  	  <span class="n">p</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="n">ppc_rtas_process_sensor</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">offs</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">loc</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">llen</span><span class="p">)</span>
					<span class="n">loc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_find_all_sensors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">utmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">utmp</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="s">&quot;rtas-sensors&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">utmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error: could not get rtas-sensors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sensors</span><span class="p">.</span><span class="n">quant</span> <span class="o">=</span> <span class="n">len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>      <span class="cm">/* int + int */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sensors</span><span class="p">.</span><span class="n">quant</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensors</span><span class="p">.</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">token</span> <span class="o">=</span> <span class="o">*</span><span class="n">utmp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sensors</span><span class="p">.</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">quant</span> <span class="o">=</span> <span class="o">*</span><span class="n">utmp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/*</span>
<span class="cm"> * Builds a string of what rtas returned</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ppc_rtas_process_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SENSOR_CRITICAL_HIGH</span>:
			<span class="k">return</span> <span class="s">&quot;(critical high)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_WARNING_HIGH</span>:
			<span class="k">return</span> <span class="s">&quot;(warning high)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_NORMAL</span>:
			<span class="k">return</span> <span class="s">&quot;(normal)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_WARNING_LOW</span>:
			<span class="k">return</span> <span class="s">&quot;(warning low)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_CRITICAL_LOW</span>:
			<span class="k">return</span> <span class="s">&quot;(critical low)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_SUCCESS</span>:
			<span class="k">return</span> <span class="s">&quot;(read ok)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_HW_ERROR</span>:
			<span class="k">return</span> <span class="s">&quot;(hardware error)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_BUSY</span>:
			<span class="k">return</span> <span class="s">&quot;(busy)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_NOT_EXIST</span>:
			<span class="k">return</span> <span class="s">&quot;(non existent)&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SENSOR_DR_ENTITY</span>:
			<span class="k">return</span> <span class="s">&quot;(dr entity removed)&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot;(UNKNOWN)&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/*</span>
<span class="cm"> * Builds a string out of what the sensor said</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc_rtas_process_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">individual_sensor</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Defined return vales */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">key_switch</span><span class="p">[]</span>        <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Off</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Normal</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Secure</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="s">&quot;Maintenance&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">enclosure_switch</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Closed&quot;</span><span class="p">,</span> <span class="s">&quot;Open&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">lid_status</span><span class="p">[]</span>        <span class="o">=</span> <span class="p">{</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;Open&quot;</span><span class="p">,</span> <span class="s">&quot;Closed&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">power_source</span><span class="p">[]</span>      <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;AC</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;Battery&quot;</span><span class="p">,</span> 
		  				<span class="s">&quot;AC &amp; Battery&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">battery_remaining</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Very Low&quot;</span><span class="p">,</span> <span class="s">&quot;Low&quot;</span><span class="p">,</span> <span class="s">&quot;Mid&quot;</span><span class="p">,</span> <span class="s">&quot;High&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">epow_sensor</span><span class="p">[]</span>       <span class="o">=</span> <span class="p">{</span> 
		<span class="s">&quot;EPOW Reset&quot;</span><span class="p">,</span> <span class="s">&quot;Cooling warning&quot;</span><span class="p">,</span> <span class="s">&quot;Power warning&quot;</span><span class="p">,</span>
		<span class="s">&quot;System shutdown&quot;</span><span class="p">,</span> <span class="s">&quot;System halt&quot;</span><span class="p">,</span> <span class="s">&quot;EPOW main enclosure&quot;</span><span class="p">,</span>
		<span class="s">&quot;EPOW power off&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">battery_cyclestate</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;In progress&quot;</span><span class="p">,</span> 
						<span class="s">&quot;Requested&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">battery_charging</span><span class="p">[]</span>    <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Charging&quot;</span><span class="p">,</span> <span class="s">&quot;Discharching&quot;</span><span class="p">,</span> 
						<span class="s">&quot;No current flow&quot;</span> <span class="p">};</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">ibm_drconnector</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Empty&quot;</span><span class="p">,</span> <span class="s">&quot;Present&quot;</span><span class="p">,</span> <span class="s">&quot;Unusable&quot;</span><span class="p">,</span> 
						<span class="s">&quot;Exchange&quot;</span> <span class="p">};</span>

	<span class="kt">int</span> <span class="n">have_strings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_states</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temperature</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* What kind of sensor do we have here? */</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KEY_SWITCH</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Key switch:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_switch</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_switch</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCLOSURE_SWITCH</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Enclosure switch:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">enclosure_switch</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">enclosure_switch</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">THERMAL_SENSOR</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Temp. (C/F):</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">temperature</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LID_STATUS</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Lid status:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lid_status</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lid_status</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POWER_SOURCE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Power source:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">power_source</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">power_source</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BATTERY_VOLTAGE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Battery voltage:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BATTERY_REMAINING</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Battery remaining:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">battery_remaining</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">battery_remaining</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BATTERY_PERCENTAGE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Battery percentage:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EPOW_SENSOR</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;EPOW Sensor:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">epow_sensor</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epow_sensor</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BATTERY_CYCLESTATE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Battery cyclestate:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">battery_cyclestate</span><span class="p">)</span> <span class="o">/</span> 
				     	<span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">battery_cyclestate</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BATTERY_CHARGING</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Battery Charging:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">battery_charging</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">battery_charging</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IBM_SURVEILLANCE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Surveillance:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IBM_FANRPM</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Fan (rpm):</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IBM_VOLTAGE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Voltage (mv):</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IBM_DRCONNECTOR</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DR connector:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">num_states</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ibm_drconnector</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">num_states</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> 
						<span class="n">ibm_drconnector</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>
				<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IBM_POWERSUPPLY</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Powersupply:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>  <span class="s">&quot;Unknown sensor (type %d), ignoring it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">);</span>
			<span class="n">unknown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">have_strings</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_strings</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temperature</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%4d /%4d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">cel_to_fahr</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%10d</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unknown</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
		<span class="n">get_location_code</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ****************************************************************** */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LOC_PLANAR</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Planar #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOC_CPU</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CPU #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOC_FAN</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Fan #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOC_RACKMOUNTED</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Rack #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOC_VOLTAGE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Voltage #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">LOC_LCD</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;LCD #%c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;- %c&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Unknown location&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* </span>
<span class="cm"> * Format: </span>
<span class="cm"> * ${LETTER}${NUMBER}[[-/]${LETTER}${NUMBER} [ ... ] ]</span>
<span class="cm"> * the &#39;.&#39; may be an abbrevation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_location_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isalpha</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
			<span class="n">check_location</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; at &quot;</span><span class="p">);</span>
		<span class="n">c</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* ****************************************************************** */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_location_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">individual_sensor</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loc</span> <span class="o">||</span> <span class="o">!*</span><span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;---&quot;</span><span class="p">);</span><span class="cm">/* does not have a location */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">check_location_string</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* INDICATORS - Tone Frequency                                        */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ppc_rtas_tone_freq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rtas_tone_frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span> <span class="cm">/* save it for later */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;set-indicator&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">TONE_FREQUENCY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error: setting tone frequency returned: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_tone_freq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtas_tone_frequency</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="cm">/* INDICATORS - Tone Volume                                           */</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ppc_rtas_tone_volume_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">volume</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">volume</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	
        <span class="n">rtas_tone_volume</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span> <span class="cm">/* save it for later */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">rtas_call</span><span class="p">(</span><span class="n">rtas_token</span><span class="p">(</span><span class="s">&quot;set-indicator&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">TONE_VOLUME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;error: setting tone volume returned: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">ppc_rtas_process_error</span><span class="p">(</span><span class="n">error</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* ****************************************************************** */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_tone_volume_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtas_tone_volume</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RMO_READ_BUF_MAX 30</span>

<span class="cm">/* RTAS Userspace access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc_rtas_rmo_buf_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%016lx %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtas_rmo_buf</span><span class="p">,</span> <span class="n">RTAS_RMOBUF_MAX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
