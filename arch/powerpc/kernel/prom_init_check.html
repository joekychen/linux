<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › prom_init_check.sh

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>prom_init_check.sh</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Copyright © 2008 IBM Corporation</p>

<p>This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version
2 of the License, or (at your option) any later version.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This script checks prom<em>init.o to see what external symbols it
is using, if it finds symbols not in the whitelist it returns
an error. The point of this is to discourage people from
intentionally or accidentally adding new code to prom</em>init.c
which has side effects on other parts of the kernel.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>If you really need to reference something from prom_init.o add
it to the list below:</p></td><td class="code"><div class="highlight"><pre><span class="nv">WHITELIST</span><span class="o">=</span><span class="s2">&quot;add_reloc_offset __bss_start __bss_stop copy_and_flush</span>
<span class="s2">_end enter_prom memcpy memset reloc_offset __secondary_hold</span>
<span class="s2">__secondary_hold_acknowledge __secondary_hold_spinloop __start</span>
<span class="s2">strcmp strcpy strlcpy strlen strncmp strstr logo_linux_clut224</span>
<span class="s2">reloc_got2 kernstart_addr memstart_addr linux_banner _stext</span>
<span class="s2">opal_query_takeover opal_do_takeover opal_enter_rtas opal_secondary_entry</span>
<span class="s2">boot_command_line&quot;</span>

<span class="nv">NM</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
<span class="nv">OBJ</span><span class="o">=</span><span class="s2">&quot;$2&quot;</span>

<span class="nv">ERROR</span><span class="o">=</span>0

<span class="k">for </span>UNDEF in <span class="k">$(</span><span class="nv">$NM</span> -u <span class="nv">$OBJ</span> | awk <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<span class="k">do</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>On 64-bit nm gives us the function descriptors, which have
a leading . on the name, so strip it off here.</p></td><td class="code"><div class="highlight"><pre>	<span class="nv">UNDEF</span><span class="o">=</span><span class="s2">&quot;${UNDEF#.}&quot;</span>

	<span class="k">if</span> <span class="o">[</span> <span class="nv">$KBUILD_VERBOSE</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		if</span> <span class="o">[</span> <span class="nv">$KBUILD_VERBOSE</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nb">echo</span> <span class="s2">&quot;Checking prom_init.o symbol &#39;$UNDEF&#39;&quot;</span>
		<span class="k">fi</span>
<span class="k">	fi</span>

<span class="k">	</span><span class="nv">OK</span><span class="o">=</span>0
	<span class="k">for </span>WHITE in <span class="nv">$WHITELIST</span>
	<span class="k">do</span>
<span class="k">		if</span> <span class="o">[</span> <span class="s2">&quot;$UNDEF&quot;</span> <span class="o">=</span> <span class="s2">&quot;$WHITE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">			</span><span class="nv">OK</span><span class="o">=</span>1
			<span class="nb">break</span>
<span class="nb">		</span><span class="k">fi</span>
<span class="k">	done</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>ignore register save/restore funcitons</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:9}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_restgpr_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:10}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_restgpr0_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:11}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_rest32gpr_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:9}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_savegpr_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:10}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_savegpr0_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>
<span class="k">	if</span> <span class="o">[</span> <span class="s2">&quot;${UNDEF:0:11}&quot;</span> <span class="o">=</span> <span class="s2">&quot;_save32gpr_&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">OK</span><span class="o">=</span>1
	<span class="k">fi</span>

<span class="k">	if</span> <span class="o">[</span> <span class="nv">$OK</span> -eq 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">		</span><span class="nv">ERROR</span><span class="o">=</span>1
		<span class="nb">echo</span> <span class="s2">&quot;Error: External symbol &#39;$UNDEF&#39; referenced&quot;</span> <span class="se">\</span>
		     <span class="s2">&quot;from prom_init.c&quot;</span> &gt;&amp;2
	<span class="k">fi</span>
<span class="k">done</span>

<span class="nb">exit</span> <span class="nv">$ERROR</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
