<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › prom_init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>prom_init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Procedures for interfacing to Open Firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Paul Mackerras	August 1996.</span>
<span class="cm"> * Copyright (C) 1996-2005 Paul Mackerras.</span>
<span class="cm"> * </span>
<span class="cm"> *  Adapted for 64bit PowerPC by Dave Engebretsen and Peter Bergner.</span>
<span class="cm"> *    {engebret|bergner}@us.ibm.com </span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG_PROM</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/threads.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/stringify.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/mmu.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/pci.h&gt;</span>
<span class="cp">#include &lt;asm/iommu.h&gt;</span>
<span class="cp">#include &lt;asm/btext.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/opal.h&gt;</span>

<span class="cp">#include &lt;linux/linux_logo.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Eventually bump that one up</span>
<span class="cm"> */</span>
<span class="cp">#define DEVTREE_CHUNK_SIZE	0x100000</span>

<span class="cm">/*</span>
<span class="cm"> * This is the size of the local memory reserve map that gets copied</span>
<span class="cm"> * into the boot params passed to the kernel. That size is totally</span>
<span class="cm"> * flexible as the kernel just reads the list until it encounters an</span>
<span class="cm"> * entry with size 0, so it can be changed without breaking binary</span>
<span class="cm"> * compatibility</span>
<span class="cm"> */</span>
<span class="cp">#define MEM_RESERVE_MAP_SIZE	8</span>

<span class="cm">/*</span>
<span class="cm"> * prom_init() is called very early on, before the kernel text</span>
<span class="cm"> * and data have been mapped to KERNELBASE.  At this point the code</span>
<span class="cm"> * is running at whatever address it has been loaded at.</span>
<span class="cm"> * On ppc32 we compile with -mrelocatable, which means that references</span>
<span class="cm"> * to extern and static variables get relocated automatically.</span>
<span class="cm"> * On ppc64 we have to relocate the references explicitly with</span>
<span class="cm"> * RELOC.  (Note that strings count as static variables.)</span>
<span class="cm"> *</span>
<span class="cm"> * Because OF may have mapped I/O devices into the area starting at</span>
<span class="cm"> * KERNELBASE, particularly on CHRP machines, we can&#39;t safely call</span>
<span class="cm"> * OF once the kernel has been mapped to KERNELBASE.  Therefore all</span>
<span class="cm"> * OF calls must be done within prom_init().</span>
<span class="cm"> *</span>
<span class="cm"> * ADDR is used in calls to call_prom.  The 4th and following</span>
<span class="cm"> * arguments to call_prom should be 32-bit values.</span>
<span class="cm"> * On ppc64, 64 bit values are truncated to 32 bits (and</span>
<span class="cm"> * fortunately don&#39;t get interpreted as two arguments).</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#define RELOC(x)        (*PTRRELOC(&amp;(x)))</span>
<span class="cp">#define ADDR(x)		(u32) add_reloc_offset((unsigned long)(x))</span>
<span class="cp">#define OF_WORKAROUNDS	0</span>
<span class="cp">#else</span>
<span class="cp">#define RELOC(x)	(x)</span>
<span class="cp">#define ADDR(x)		(u32) (x)</span>
<span class="cp">#define OF_WORKAROUNDS	of_workarounds</span>
<span class="kt">int</span> <span class="n">of_workarounds</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define OF_WA_CLAIM	1	</span><span class="cm">/* do phys/virt claim separately, then map */</span><span class="cp"></span>
<span class="cp">#define OF_WA_LONGTRAIL	2	</span><span class="cm">/* work around longtrail bugs */</span><span class="cp"></span>

<span class="cp">#define PROM_BUG() do {						\</span>
<span class="cp">        prom_printf(&quot;kernel BUG at %s line 0x%x!\n&quot;,		\</span>
<span class="cp">		    RELOC(__FILE__), __LINE__);			\</span>
<span class="cp">        __asm__ __volatile__(&quot;.long &quot; BUG_ILLEGAL_INSTR);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#ifdef DEBUG_PROM</span>
<span class="cp">#define prom_debug(x...)	prom_printf(x)</span>
<span class="cp">#else</span>
<span class="cp">#define prom_debug(x...)</span>
<span class="cp">#endif</span>


<span class="k">typedef</span> <span class="n">u32</span> <span class="n">prom_arg_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">prom_args</span> <span class="p">{</span>
        <span class="n">u32</span> <span class="n">service</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">nargs</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">nret</span><span class="p">;</span>
        <span class="n">prom_arg_t</span> <span class="n">args</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">prom_t</span> <span class="p">{</span>
	<span class="n">ihandle</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">chosen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">stdout</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">mmumap</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">memory</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mem_map_entry</span> <span class="p">{</span>
	<span class="n">u64</span>	<span class="n">base</span><span class="p">;</span>
	<span class="n">u64</span>	<span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">u32</span> <span class="n">cell_t</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__start</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r4</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r5</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r6</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r7</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r8</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r9</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">enter_prom</span><span class="p">(</span><span class="k">struct</span> <span class="n">prom_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">enter_prom</span><span class="p">(</span><span class="k">struct</span> <span class="n">prom_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">struct</span> <span class="n">prom_args</span> <span class="o">*</span><span class="p">))</span><span class="n">entry</span><span class="p">)(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">copy_and_flush</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">);</span>

<span class="cm">/* prom structure */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">prom_t</span> <span class="n">__initdata</span> <span class="n">prom</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prom_entry</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cp">#define PROM_SCRATCH_SIZE 256</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">of_stdout_device</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">prom_scratch</span><span class="p">[</span><span class="n">PROM_SCRATCH_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">dt_header_start</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">dt_struct_start</span><span class="p">,</span> <span class="n">dt_struct_end</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">dt_string_start</span><span class="p">,</span> <span class="n">dt_string_end</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">prom_initrd_start</span><span class="p">,</span> <span class="n">prom_initrd_end</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">prom_iommu_force_on</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">prom_iommu_off</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">prom_tce_alloc_start</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">prom_tce_alloc_end</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* Platforms codes are now obsolete in the kernel. Now only used within this</span>
<span class="cm"> * file and ultimately gone too. Feel free to change them if you need, they</span>
<span class="cm"> * are not shared with anything outside of this file anymore</span>
<span class="cm"> */</span>
<span class="cp">#define PLATFORM_PSERIES	0x0100</span>
<span class="cp">#define PLATFORM_PSERIES_LPAR	0x0101</span>
<span class="cp">#define PLATFORM_LPAR		0x0001</span>
<span class="cp">#define PLATFORM_POWERMAC	0x0400</span>
<span class="cp">#define PLATFORM_GENERIC	0x0500</span>
<span class="cp">#define PLATFORM_OPAL		0x0600</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">of_platform</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">prom_cmd_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">prom_memory_limit</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">alloc_top</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">alloc_top_high</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">alloc_bottom</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">rmo_top</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__initdata</span> <span class="n">ram_top</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mem_map_entry</span> <span class="n">__initdata</span> <span class="n">mem_reserve_map</span><span class="p">[</span><span class="n">MEM_RESERVE_MAP_SIZE</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">mem_reserve_cnt</span><span class="p">;</span>

<span class="k">static</span> <span class="n">cell_t</span> <span class="n">__initdata</span> <span class="n">regbuf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>


<span class="cm">/*</span>
<span class="cm"> * Error results ... some OF calls will return &quot;-1&quot; on error, some</span>
<span class="cm"> * will return 0, some will return either. To simplify, here are</span>
<span class="cm"> * macros to use with any ihandle or phandle return value to check if</span>
<span class="cm"> * it is valid</span>
<span class="cm"> */</span>

<span class="cp">#define PROM_ERROR		(-1u)</span>
<span class="cp">#define PHANDLE_VALID(p)	((p) != 0 &amp;&amp; (p) != PROM_ERROR)</span>
<span class="cp">#define IHANDLE_VALID(i)	((i) != 0 &amp;&amp; (i) != PROM_ERROR)</span>


<span class="cm">/* This is the one and *ONLY* place where we actually call open</span>
<span class="cm"> * firmware.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">call_prom</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nret</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">nargs</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nret</span> <span class="o">=</span> <span class="n">nret</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">nret</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">prom_arg_t</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enter_prom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_entry</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PROM_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">nret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">call_prom_ret</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nret</span><span class="p">,</span>
				<span class="n">prom_arg_t</span> <span class="o">*</span><span class="n">rets</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">nargs</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">nret</span> <span class="o">=</span> <span class="n">nret</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">rets</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">prom_arg_t</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enter_prom</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_entry</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PROM_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rets</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nret</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">nret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="o">++</span><span class="n">q</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">-</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="o">++</span><span class="n">q</span><span class="p">;</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_print_hex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">nibbles</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">nibbles</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="o">-</span><span class="sc">&#39;0&#39;</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">nibbles</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">nibbles</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* max number of decimal digits in an unsigned long */</span>
<span class="cp">#define UL_DIGITS 21</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_print_dec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">UL_DIGITS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UL_DIGITS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* shift stuff down */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">UL_DIGITS</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">vs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">PTRRELOC</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">q</span> <span class="o">!=</span> <span class="sc">&#39;%&#39;</span><span class="p">;</span> <span class="o">++</span><span class="n">q</span><span class="p">)</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">-</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">q</span><span class="p">;</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span>
				  <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">q</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
			<span class="o">++</span><span class="n">q</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
			<span class="n">prom_print</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span>:
			<span class="o">++</span><span class="n">q</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
			<span class="n">prom_print_hex</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:
			<span class="o">++</span><span class="n">q</span><span class="p">;</span>
			<span class="n">vs</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prom_print</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">));</span>
				<span class="n">vs</span> <span class="o">=</span> <span class="o">-</span><span class="n">vs</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prom_print_dec</span><span class="p">(</span><span class="n">vs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span>:
			<span class="o">++</span><span class="n">q</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">q</span><span class="p">;</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
				<span class="n">prom_print_hex</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;u&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* &#39;%lu&#39; */</span>
				<span class="o">++</span><span class="n">q</span><span class="p">;</span>
				<span class="n">v</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
				<span class="n">prom_print_dec</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* %ld */</span>
				<span class="o">++</span><span class="n">q</span><span class="p">;</span>
				<span class="n">vs</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">long</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">prom_print</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">));</span>
					<span class="n">vs</span> <span class="o">=</span> <span class="o">-</span><span class="n">vs</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">prom_print_dec</span><span class="p">(</span><span class="n">vs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_claim</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">virt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">align</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">OF_WORKAROUNDS</span> <span class="o">&amp;</span> <span class="n">OF_WA_CLAIM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Old OF requires we claim physical and virtual separately</span>
<span class="cm">		 * and then map explicitly (assuming virtual mode)</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">prom_arg_t</span> <span class="n">result</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_prom_ret</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
				    <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;claim&quot;</span><span class="p">),</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span>
				    <span class="n">align</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_prom_ret</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
				    <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;claim&quot;</span><span class="p">),</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span><span class="p">,</span>
				    <span class="n">align</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;release&quot;</span><span class="p">),</span>
				  <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* the 0x12 is M (coherence) + PP == read/write */</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;map&quot;</span><span class="p">),</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">virt</span><span class="p">,</span> <span class="n">virt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">virt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;claim&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">prom_arg_t</span><span class="p">)</span><span class="n">virt</span><span class="p">,</span> <span class="p">(</span><span class="n">prom_arg_t</span><span class="p">)</span><span class="n">size</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">prom_arg_t</span><span class="p">)</span><span class="n">align</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">noreturn</span><span class="p">))</span> <span class="n">prom_panic</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">PTRRELOC</span><span class="p">(</span><span class="n">reason</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">prom_print</span><span class="p">(</span><span class="n">reason</span><span class="p">);</span>
	<span class="cm">/* Do not call exit because it clears the screen on pmac</span>
<span class="cm">	 * it also causes some sort of double-fault on early pmacs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_POWERMAC</span><span class="p">)</span>
		<span class="n">asm</span><span class="p">(</span><span class="s">&quot;trap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* ToDo: should put up an SRC here on pSeries */</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;exit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span>			<span class="cm">/* should never get here */</span>
		<span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_next_node</span><span class="p">(</span><span class="n">phandle</span> <span class="o">*</span><span class="n">nodep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="o">*</span><span class="n">nodep</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">nodep</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;child&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">nodep</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;parent&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">nodep</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">prom_getprop</span><span class="p">(</span><span class="n">phandle</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pname</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">valuelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;getprop&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span>
			 <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">valuelen</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="kr">inline</span> <span class="nf">prom_getproplen</span><span class="p">(</span><span class="n">phandle</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;getproplen&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">pname</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">str</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">q</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tohex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">digits</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;0123456789abcdef&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="o">--</span><span class="n">i</span><span class="p">;</span>
		<span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">digits</span><span class="p">[</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_setprop</span><span class="p">(</span><span class="n">phandle</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nodename</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pname</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">valuelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">OF_WORKAROUNDS</span> <span class="o">&amp;</span> <span class="n">OF_WA_LONGTRAIL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;setprop&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span>
				 <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">valuelen</span><span class="p">);</span>

	<span class="cm">/* gah... setprop doesn&#39;t work on longtrail, have to use interpret */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">);</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">nodename</span><span class="p">);</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">tohex</span><span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">value</span><span class="p">));</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">tohex</span><span class="p">(</span><span class="n">valuelen</span><span class="p">));</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">tohex</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">pname</span><span class="p">)));</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">tohex</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">))));</span>
	<span class="n">add_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;property&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;interpret&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We can&#39;t use the standard versions because of RELOC headaches. */</span>
<span class="cp">#define isxdigit(c)	((&#39;0&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;9&#39;) \</span>
<span class="cp">			 || (&#39;a&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;f&#39;) \</span>
<span class="cp">			 || (&#39;A&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;F&#39;))</span>

<span class="cp">#define isdigit(c)	(&#39;0&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;9&#39;)</span>
<span class="cp">#define islower(c)	(&#39;a&#39; &lt;= (c) &amp;&amp; (c) &lt;= &#39;z&#39;)</span>
<span class="cp">#define toupper(c)	(islower(c) ? ((c) - &#39;a&#39; + &#39;A&#39;) : (c))</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">prom_strtoul</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">endp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">isxdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">cp</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="o">:</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span> <span class="o">-</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="n">base</span> <span class="o">+</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">endp</span> <span class="o">=</span> <span class="n">cp</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">prom_memparse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">retptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prom_strtoul</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">retptr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can&#39;t use a switch here because GCC *may* generate a</span>
<span class="cm">	 * jump table which won&#39;t work, because we&#39;re not running at</span>
<span class="cm">	 * the address we&#39;re linked at.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="sc">&#39;G&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span> <span class="o">||</span> <span class="sc">&#39;g&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="sc">&#39;M&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span> <span class="o">||</span> <span class="sc">&#39;m&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="sc">&#39;K&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span> <span class="o">||</span> <span class="sc">&#39;k&#39;</span> <span class="o">==</span> <span class="o">**</span><span class="n">retptr</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">retptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Early parsing of the command line passed to the kernel, used for</span>
<span class="cm"> * &quot;mem=x&quot; and the options that affect the iommu</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">early_cmdline_parse</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;bootargs&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">COMMAND_LINE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_CMDLINE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="cm">/* dbl check */</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">),</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">CONFIG_CMDLINE</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CMDLINE */</span><span class="cp"></span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;command line: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;iommu=&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;iommu opt is: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">opt</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">opt</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">opt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;off&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_iommu_off</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;force&quot;</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_iommu_force_on</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">opt</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;mem=&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">=</span> <span class="n">prom_memparse</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opt</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
		<span class="cm">/* Align to 16 MB == size of ppc64 large page */</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">),</span> <span class="mh">0x1000000</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PPC_PSERIES) || defined(CONFIG_PPC_POWERNV)</span>
<span class="cm">/*</span>
<span class="cm"> * There are two methods for telling firmware what our capabilities are.</span>
<span class="cm"> * Newer machines have an &quot;ibm,client-architecture-support&quot; method on the</span>
<span class="cm"> * root node.  For older machines, we have to call the &quot;process-elf-header&quot;</span>
<span class="cm"> * method in the /packages/elf-loader node, passing it a fake 32-bit</span>
<span class="cm"> * ELF header containing a couple of PT_NOTE sections that contain</span>
<span class="cm"> * structures that contain various information.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * New method - extensible architecture description vector.</span>
<span class="cm"> *</span>
<span class="cm"> * Because the description vector contains a mix of byte and word</span>
<span class="cm"> * values, we declare it as an unsigned char array, and use this</span>
<span class="cm"> * macro to put word values in.</span>
<span class="cm"> */</span>
<span class="cp">#define W(x)	((x) &gt;&gt; 24) &amp; 0xff, ((x) &gt;&gt; 16) &amp; 0xff, \</span>
<span class="cp">		((x) &gt;&gt; 8) &amp; 0xff, (x) &amp; 0xff</span>

<span class="cm">/* Option vector bits - generic bits in byte 1 */</span>
<span class="cp">#define OV_IGNORE		0x80	</span><span class="cm">/* ignore this vector */</span><span class="cp"></span>
<span class="cp">#define OV_CESSATION_POLICY	0x40	</span><span class="cm">/* halt if unsupported option present*/</span><span class="cp"></span>

<span class="cm">/* Option vector 1: processor architectures supported */</span>
<span class="cp">#define OV1_PPC_2_00		0x80	</span><span class="cm">/* set if we support PowerPC 2.00 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_01		0x40	</span><span class="cm">/* set if we support PowerPC 2.01 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_02		0x20	</span><span class="cm">/* set if we support PowerPC 2.02 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_03		0x10	</span><span class="cm">/* set if we support PowerPC 2.03 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_04		0x08	</span><span class="cm">/* set if we support PowerPC 2.04 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_05		0x04	</span><span class="cm">/* set if we support PowerPC 2.05 */</span><span class="cp"></span>
<span class="cp">#define OV1_PPC_2_06		0x02	</span><span class="cm">/* set if we support PowerPC 2.06 */</span><span class="cp"></span>

<span class="cm">/* Option vector 2: Open Firmware options supported */</span>
<span class="cp">#define OV2_REAL_MODE		0x20	</span><span class="cm">/* set if we want OF in real mode */</span><span class="cp"></span>

<span class="cm">/* Option vector 3: processor options supported */</span>
<span class="cp">#define OV3_FP			0x80	</span><span class="cm">/* floating point */</span><span class="cp"></span>
<span class="cp">#define OV3_VMX			0x40	</span><span class="cm">/* VMX/Altivec */</span><span class="cp"></span>
<span class="cp">#define OV3_DFP			0x20	</span><span class="cm">/* decimal FP */</span><span class="cp"></span>

<span class="cm">/* Option vector 4: IBM PAPR implementation */</span>
<span class="cp">#define OV4_MIN_ENT_CAP		0x01	</span><span class="cm">/* minimum VP entitled capacity */</span><span class="cp"></span>

<span class="cm">/* Option vector 5: PAPR/OF options supported */</span>
<span class="cp">#define OV5_LPAR		0x80	</span><span class="cm">/* logical partitioning supported */</span><span class="cp"></span>
<span class="cp">#define OV5_SPLPAR		0x40	</span><span class="cm">/* shared-processor LPAR supported */</span><span class="cp"></span>
<span class="cm">/* ibm,dynamic-reconfiguration-memory property supported */</span>
<span class="cp">#define OV5_DRCONF_MEMORY	0x20</span>
<span class="cp">#define OV5_LARGE_PAGES		0x10	</span><span class="cm">/* large pages supported */</span><span class="cp"></span>
<span class="cp">#define OV5_DONATE_DEDICATE_CPU 0x02	</span><span class="cm">/* donate dedicated CPU support */</span><span class="cp"></span>
<span class="cm">/* PCIe/MSI support.  Without MSI full PCIe is not supported */</span>
<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="cp">#define OV5_MSI			0x01	</span><span class="cm">/* PCIe/MSI support */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define OV5_MSI			0x00</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI_MSI */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_PPC_SMLPAR</span>
<span class="cp">#define OV5_CMO			0x80	</span><span class="cm">/* Cooperative Memory Overcommitment */</span><span class="cp"></span>
<span class="cp">#define OV5_XCMO			0x40	</span><span class="cm">/* Page Coalescing */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define OV5_CMO			0x00</span>
<span class="cp">#define OV5_XCMO			0x00</span>
<span class="cp">#endif</span>
<span class="cp">#define OV5_TYPE1_AFFINITY	0x80	</span><span class="cm">/* Type 1 NUMA affinity */</span><span class="cp"></span>
<span class="cp">#define OV5_PFO_HW_RNG		0x80	</span><span class="cm">/* PFO Random Number Generator */</span><span class="cp"></span>
<span class="cp">#define OV5_PFO_HW_ENCR		0x20	</span><span class="cm">/* PFO Encryption Accelerator */</span><span class="cp"></span>

<span class="cm">/* Option Vector 6: IBM PAPR hints */</span>
<span class="cp">#define OV6_LINUX		0x02	</span><span class="cm">/* Linux is our OS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * The architecture vector has an array of PVR mask/value pairs,</span>
<span class="cm"> * followed by # option vectors - 1, followed by the option vectors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ibm_architecture_vec</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xfffe0000</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x003a0000</span><span class="p">),</span>	<span class="cm">/* POWER5/POWER5+ */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffff0000</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x003e0000</span><span class="p">),</span>	<span class="cm">/* POWER6 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffff0000</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x003f0000</span><span class="p">),</span>	<span class="cm">/* POWER7 */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x0f000003</span><span class="p">),</span>	<span class="cm">/* all 2.06-compliant */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x0f000002</span><span class="p">),</span>	<span class="cm">/* all 2.05-compliant */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xfffffffe</span><span class="p">),</span> <span class="n">W</span><span class="p">(</span><span class="mh">0x0f000001</span><span class="p">),</span>	<span class="cm">/* all 2.04-compliant and earlier */</span>
	<span class="mi">6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>				<span class="cm">/* 6 option vectors */</span>

	<span class="cm">/* option vector 1: processor architectures supported */</span>
	<span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* don&#39;t ignore, don&#39;t halt */</span>
	<span class="n">OV1_PPC_2_00</span> <span class="o">|</span> <span class="n">OV1_PPC_2_01</span> <span class="o">|</span> <span class="n">OV1_PPC_2_02</span> <span class="o">|</span> <span class="n">OV1_PPC_2_03</span> <span class="o">|</span>
	<span class="n">OV1_PPC_2_04</span> <span class="o">|</span> <span class="n">OV1_PPC_2_05</span> <span class="o">|</span> <span class="n">OV1_PPC_2_06</span><span class="p">,</span>

	<span class="cm">/* option vector 2: Open Firmware options supported */</span>
	<span class="mi">34</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="n">OV2_REAL_MODE</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* real_base */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* real_size */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* virt_base */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* virt_size */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* load_base */</span>
	<span class="n">W</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>				<span class="cm">/* 256MB min RMA */</span>
	<span class="n">W</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">),</span>			<span class="cm">/* full client load */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* min RMA percentage of total RAM */</span>
	<span class="mi">48</span><span class="p">,</span>				<span class="cm">/* max log_2(hash table size) */</span>

	<span class="cm">/* option vector 3: processor options supported */</span>
	<span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* don&#39;t ignore, don&#39;t halt */</span>
	<span class="n">OV3_FP</span> <span class="o">|</span> <span class="n">OV3_VMX</span> <span class="o">|</span> <span class="n">OV3_DFP</span><span class="p">,</span>

	<span class="cm">/* option vector 4: IBM PAPR implementation */</span>
	<span class="mi">3</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* don&#39;t halt */</span>
	<span class="n">OV4_MIN_ENT_CAP</span><span class="p">,</span>		<span class="cm">/* minimum VP entitled capacity */</span>

	<span class="cm">/* option vector 5: PAPR/OF options */</span>
	<span class="mi">18</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="mi">0</span><span class="p">,</span>				<span class="cm">/* don&#39;t ignore, don&#39;t halt */</span>
	<span class="n">OV5_LPAR</span> <span class="o">|</span> <span class="n">OV5_SPLPAR</span> <span class="o">|</span> <span class="n">OV5_LARGE_PAGES</span> <span class="o">|</span> <span class="n">OV5_DRCONF_MEMORY</span> <span class="o">|</span>
	<span class="n">OV5_DONATE_DEDICATE_CPU</span> <span class="o">|</span> <span class="n">OV5_MSI</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">OV5_CMO</span> <span class="o">|</span> <span class="n">OV5_XCMO</span><span class="p">,</span>
	<span class="n">OV5_TYPE1_AFFINITY</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* WARNING: The offset of the &quot;number of cores&quot; field below</span>
<span class="cm">	 * must match by the macro below. Update the definition if</span>
<span class="cm">	 * the structure layout changes.</span>
<span class="cm">	 */</span>
<span class="cp">#define IBM_ARCH_VEC_NRCORES_OFFSET	101</span>
	<span class="n">W</span><span class="p">(</span><span class="n">NR_CPUS</span><span class="p">),</span>			<span class="cm">/* number of cores supported */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">OV5_PFO_HW_RNG</span> <span class="o">|</span> <span class="n">OV5_PFO_HW_ENCR</span><span class="p">,</span>

	<span class="cm">/* option vector 6: IBM PAPR hints */</span>
	<span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>				<span class="cm">/* length */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">OV6_LINUX</span><span class="p">,</span>

<span class="p">};</span>

<span class="cm">/* Old method - ELF header with PT_NOTE sections */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fake_elf</span> <span class="p">{</span>
	<span class="n">Elf32_Ehdr</span>	<span class="n">elfhdr</span><span class="p">;</span>
	<span class="n">Elf32_Phdr</span>	<span class="n">phdr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">chrpnote</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">namesz</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">descsz</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">type</span><span class="p">;</span>
		<span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* &quot;PowerPC&quot; */</span>
		<span class="k">struct</span> <span class="n">chrpdesc</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">real_mode</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">real_base</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">real_size</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">virt_base</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">virt_size</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">load_base</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">chrpdesc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">chrpnote</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rpanote</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">namesz</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">descsz</span><span class="p">;</span>
		<span class="n">u32</span>	<span class="n">type</span><span class="p">;</span>
		<span class="kt">char</span>	<span class="n">name</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>	<span class="cm">/* &quot;IBM,RPA-Client-Config&quot; */</span>
		<span class="k">struct</span> <span class="n">rpadesc</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">lpar_affinity</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">min_rmo_size</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">min_rmo_percent</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">max_pft_size</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">splpar</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">min_load</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">new_mem_def</span><span class="p">;</span>
			<span class="n">u32</span>	<span class="n">ignore_me</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">rpadesc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rpanote</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fake_elf</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">elfhdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">e_ident</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span>
			     <span class="n">ELFCLASS32</span><span class="p">,</span> <span class="n">ELFDATA2MSB</span><span class="p">,</span> <span class="n">EV_CURRENT</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">e_type</span> <span class="o">=</span> <span class="n">ET_EXEC</span><span class="p">,</span>	<span class="cm">/* yeah right */</span>
		<span class="p">.</span><span class="n">e_machine</span> <span class="o">=</span> <span class="n">EM_PPC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">e_version</span> <span class="o">=</span> <span class="n">EV_CURRENT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">e_phoff</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fake_elf</span><span class="p">,</span> <span class="n">phdr</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e_phentsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Elf32_Phdr</span><span class="p">),</span>
		<span class="p">.</span><span class="n">e_phnum</span> <span class="o">=</span> <span class="mi">2</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">phdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">PT_NOTE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">p_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fake_elf</span><span class="p">,</span> <span class="n">chrpnote</span><span class="p">),</span>
			<span class="p">.</span><span class="n">p_filesz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chrpnote</span><span class="p">)</span>
		<span class="p">},</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">PT_NOTE</span><span class="p">,</span>
			<span class="p">.</span><span class="n">p_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fake_elf</span><span class="p">,</span> <span class="n">rpanote</span><span class="p">),</span>
			<span class="p">.</span><span class="n">p_filesz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpanote</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">chrpnote</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">namesz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;PowerPC&quot;</span><span class="p">),</span>
		<span class="p">.</span><span class="n">descsz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chrpdesc</span><span class="p">),</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mh">0x1275</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PowerPC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chrpdesc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">real_mode</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>	<span class="cm">/* ~0 means &quot;don&#39;t care&quot; */</span>
			<span class="p">.</span><span class="n">real_base</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>
			<span class="p">.</span><span class="n">real_size</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>
			<span class="p">.</span><span class="n">virt_base</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>
			<span class="p">.</span><span class="n">virt_size</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>
			<span class="p">.</span><span class="n">load_base</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">rpanote</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">namesz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;IBM,RPA-Client-Config&quot;</span><span class="p">),</span>
		<span class="p">.</span><span class="n">descsz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpadesc</span><span class="p">),</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mh">0x12759999</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IBM,RPA-Client-Config&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rpadesc</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">lpar_affinity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_rmo_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>	<span class="cm">/* in megabytes */</span>
			<span class="p">.</span><span class="n">min_rmo_percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max_pft_size</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>	<span class="cm">/* 2^48 bytes max PFT size */</span>
			<span class="p">.</span><span class="n">splpar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">min_load</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0U</span><span class="p">,</span>
			<span class="p">.</span><span class="n">new_mem_def</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_count_smt_threads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>

	<span class="cm">/* Pick up th first CPU node we can find */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is an entry for each smt thread, each entry being</span>
<span class="cm">		 * 4 bytes long.  All cpus should have the same number of</span>
<span class="cm">		 * smt threads, so return after finding the first.</span>
<span class="cm">		 */</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="n">prom_getproplen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,ppc-interrupt-server#s&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">plen</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;Found %lu smt threads per core</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">plen</span><span class="p">);</span>

		<span class="cm">/* Sanity check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">plen</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Threads per core %lu out of bounds, assuming 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">plen</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">plen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;No threads found, assuming 1 per core</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_send_capabilities</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ihandle</span> <span class="n">elfloader</span><span class="p">,</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">prom_arg_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cores</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need to tell the FW about the number of cores we support.</span>
<span class="cm">		 *</span>
<span class="cm">		 * To do that, we count the number of threads on the first core</span>
<span class="cm">		 * (we assume this is the same for all cores) and use it to</span>
<span class="cm">		 * divide NR_CPUS.</span>
<span class="cm">		 */</span>
		<span class="n">cores</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm_architecture_vec</span><span class="p">[</span><span class="n">IBM_ARCH_VEC_NRCORES_OFFSET</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cores</span> <span class="o">!=</span> <span class="n">NR_CPUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;WARNING ! &quot;</span>
				    <span class="s">&quot;ibm_architecture_vec structure inconsistent: %lu!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="o">*</span><span class="n">cores</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">cores</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">NR_CPUS</span><span class="p">,</span> <span class="n">prom_count_smt_threads</span><span class="p">());</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Max number of cores passed to firmware: %lu (NR_CPUS = %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="o">*</span><span class="n">cores</span><span class="p">,</span> <span class="n">NR_CPUS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* try calling the ibm,client-architecture-support method */</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Calling ibm,client-architecture-support...&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_prom_ret</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span>
				  <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;ibm,client-architecture-support&quot;</span><span class="p">),</span>
				  <span class="n">root</span><span class="p">,</span>
				  <span class="n">ADDR</span><span class="p">(</span><span class="n">ibm_architecture_vec</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the call exists... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">WARNING: ibm,client-architecture&quot;</span>
					    <span class="s">&quot;-support call FAILED!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* no ibm,client-architecture-support call, try the old way */</span>
	<span class="n">elfloader</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/packages/elf-loader&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elfloader</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;couldn&#39;t open /packages/elf-loader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;process-elf-header&quot;</span><span class="p">),</span>
			<span class="n">elfloader</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fake_elf</span><span class="p">));</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">elfloader</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Memory allocation strategy... our layout is normally:</span>
<span class="cm"> *</span>
<span class="cm"> *  at 14Mb or more we have vmlinux, then a gap and initrd.  In some</span>
<span class="cm"> *  rare cases, initrd might end up being before the kernel though.</span>
<span class="cm"> *  We assume this won&#39;t override the final kernel at 0, we have no</span>
<span class="cm"> *  provision to handle that in this version, but it should hopefully</span>
<span class="cm"> *  never happen.</span>
<span class="cm"> *</span>
<span class="cm"> *  alloc_top is set to the top of RMO, eventually shrink down if the</span>
<span class="cm"> *  TCEs overlap</span>
<span class="cm"> *</span>
<span class="cm"> *  alloc_bottom is set to the top of kernel/initrd</span>
<span class="cm"> *</span>
<span class="cm"> *  from there, allocations are done this way : rtas is allocated</span>
<span class="cm"> *  topmost, and the device-tree is allocated from the bottom. We try</span>
<span class="cm"> *  to grow the device-tree allocation as we progress. If we can&#39;t,</span>
<span class="cm"> *  then we fail, we don&#39;t currently have a facility to restart</span>
<span class="cm"> *  elsewhere, but that shouldn&#39;t be necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *  Note that calls to reserve_mem have to be done explicitly, memory</span>
<span class="cm"> *  allocated with either alloc_up or alloc_down isn&#39;t automatically</span>
<span class="cm"> *  reserved.</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * Allocates memory in the RMO upward from the kernel/initrd</span>
<span class="cm"> *</span>
<span class="cm"> * When align is 0, this is a special case, it means to allocate in place</span>
<span class="cm"> * at the current location of alloc_bottom or fail (that is basically</span>
<span class="cm"> * extending the previous allocation). Used for the device-tree flattening</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">alloc_up</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;alloc_up(%x, %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;alloc_up() called with mem not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">),</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(;</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">);</span> 
	    <span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="n">align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    trying: 0x%x</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">prom_claim</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">PROM_ERROR</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">align</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_bottom : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_top    : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_top_hi : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  rmo_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  ram_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocates memory downward, either from top of RMO, or if highmem</span>
<span class="cm"> * is set, from the top of RAM.  Note that this one doesn&#39;t handle</span>
<span class="cm"> * failures.  It does claim memory if highmem is not set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">alloc_down</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">highmem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;alloc_down(%x, %x, %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span>
		   <span class="n">highmem</span> <span class="o">?</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;(high)&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;(low)&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;alloc_down() called with mem not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">highmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Carve out storage for the TCE table. */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Will we bump into the RMO ? If yes, check out that we</span>
<span class="cm">		 * didn&#39;t overlap existing allocations there, if we did,</span>
<span class="cm">		 * we are dead, we must be the first in town !</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Good, we are first */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">==</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">))</span>
				<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">bail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">base</span> <span class="o">&gt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">);</span>
	     <span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">base</span> <span class="o">-</span> <span class="mh">0x100000</span><span class="p">,</span> <span class="n">align</span><span class="p">))</span>  <span class="p">{</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    trying: 0x%x</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">prom_claim</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">PROM_ERROR</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

 <span class="nl">bail:</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot; -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_bottom : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_top    : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  alloc_top_hi : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  rmo_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  ram_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse a &quot;reg&quot; cell</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">prom_next_cell</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">cell_t</span> <span class="o">**</span><span class="n">cellp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cell_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">cellp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Ignore more than 2 cells */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">s</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="o">*</span><span class="n">cellp</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Very dumb function for adding to the memory reserve list, but</span>
<span class="cm"> * we don&#39;t need anything smarter at this point</span>
<span class="cm"> *</span>
<span class="cm"> * XXX Eventually check for collisions.  They should NEVER happen.</span>
<span class="cm"> * If problems seem to show up, it would be a good start to track</span>
<span class="cm"> * them down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">reserve_mem</span><span class="p">(</span><span class="n">u64</span> <span class="n">base</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">top</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We need to always keep one empty entry so that we</span>
<span class="cm">	 * have our terminator with &quot;size&quot; set to 0 since we are</span>
<span class="cm">	 * dumb and just copy this entire array to the boot params</span>
<span class="cm">	 */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">top</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">top</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MEM_RESERVE_MAP_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;Memory reserve map exhausted !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">)[</span><span class="n">cnt</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">)[</span><span class="n">cnt</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_cnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize memory allocation mechanism, parse &quot;memory&quot; nodes and</span>
<span class="cm"> * obtain that way the top of memory and RMO to setup out local allocator</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_init_mem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">cell_t</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rac</span><span class="p">,</span> <span class="n">rsc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We iterate the memory nodes to find</span>
<span class="cm">	 * 1) top of RMO (first node)</span>
<span class="cm">	 * 2) top of memory</span>
<span class="cm">	 */</span>
	<span class="n">rac</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;#address-cells&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rac</span><span class="p">));</span>
	<span class="n">rsc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;#size-cells&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsc</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;root_addr_cells: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rac</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;root_size_cells: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rsc</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;scanning memory:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_scratch</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * CHRP Longtrail machines have no device_type</span>
<span class="cm">			 * on the memory node, so check the name instead...</span>
<span class="cm">			 */</span>
			<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;memory&quot;</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">plen</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">regbuf</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regbuf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regbuf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;memory node too large for buffer !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">regbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">regbuf</span><span class="p">);</span>
		<span class="n">endp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">plen</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cell_t</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG_PROM</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="p">);</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  node %s :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG_PROM */</span><span class="cp"></span>

		<span class="k">while</span> <span class="p">((</span><span class="n">endp</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">rac</span> <span class="o">+</span> <span class="n">rsc</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">base</span> <span class="o">=</span> <span class="n">prom_next_cell</span><span class="p">(</span><span class="n">rac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">prom_next_cell</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLATFORM_LPAR</span><span class="p">))</span>
				<span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">))</span>
				<span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">)</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">_end</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If prom_memory_limit is set we reduce the upper limits *except* for</span>
<span class="cm">	 * alloc_top_high. This must be the real top of RAM so we can put</span>
<span class="cm">	 * TCE&#39;s up there.</span>
<span class="cm">	 */</span>

	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Ignoring mem=%x &lt;= alloc_bottom.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">));</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Ignoring mem=%x &gt;= ram_top.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">));</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">);</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup our top alloc point, that is top of RMO or top of</span>
<span class="cm">	 * segment 0 when running non-LPAR.</span>
<span class="cm">	 * Some RS64 machines have buggy firmware where claims up at</span>
<span class="cm">	 * 1GB fail.  Cap at 768MB as a workaround.</span>
<span class="cm">	 * Since 768MB is plenty of room, and we need to cap to something</span>
<span class="cm">	 * reasonable on 32-bit, cap at 768MB on all machines.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">))</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mh">0x30000000ul</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">));</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if we have an initrd after the kernel but still inside</span>
<span class="cm">	 * the RMO.  If we do move our bottom point to after it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">))</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">)</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">));</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;memory layout at init:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  memory_limit : %x (16 MB aligned)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  alloc_bottom : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  alloc_top    : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  alloc_top_hi : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  rmo_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">rmo_top</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  ram_top      : %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">ram_top</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_close_stdin</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="n">ihandle</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;stdin&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_POWERNV</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_opal_size</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_opal_align</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">prom_rtas_start_cpu</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_rtas_data</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_rtas_entry</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_EARLY_DEBUG_OPAL</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_opal_base</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">__initdata</span> <span class="n">prom_opal_entry</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* XXX Don&#39;t change this structure without updating opal-takeover.S */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">opal_secondary_data</span> <span class="p">{</span>
	<span class="n">s64</span>				<span class="n">ack</span><span class="p">;</span>	<span class="cm">/*  0 */</span>
	<span class="n">u64</span>				<span class="n">go</span><span class="p">;</span>	<span class="cm">/*  8 */</span>
	<span class="k">struct</span> <span class="n">opal_takeover_args</span>	<span class="n">args</span><span class="p">;</span>	<span class="cm">/* 16 */</span>
<span class="p">}</span> <span class="n">opal_secondary_data</span><span class="p">;</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="n">opal_secondary_entry</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_query_opal</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* We must not query for OPAL presence on a machine that</span>
<span class="cm">	 * supports TNK takeover (970 blades), as this uses the same</span>
<span class="cm">	 * h-call with different arguments and will crash</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/tnk-memory-map&quot;</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;TNK takeover detected, skipping OPAL check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Querying for OPAL presence... &quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">opal_query_takeover</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_size</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_align</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;(rc = %ld) &quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;not there.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">=</span> <span class="n">PLATFORM_OPAL</span><span class="p">;</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; there !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  opal_size  = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_size</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  opal_align = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_align</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_align</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_align</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prom_rtas_call</span><span class="p">(</span><span class="kt">int</span> <span class="n">token</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nret</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">outputs</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rtas_args</span> <span class="n">rtas_args</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rtas_args</span><span class="p">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="n">rtas_args</span><span class="p">.</span><span class="n">nargs</span> <span class="o">=</span> <span class="n">nargs</span><span class="p">;</span>
	<span class="n">rtas_args</span><span class="p">.</span><span class="n">nret</span>  <span class="o">=</span> <span class="n">nret</span><span class="p">;</span>
	<span class="n">rtas_args</span><span class="p">.</span><span class="n">rets</span>  <span class="o">=</span> <span class="p">(</span><span class="n">rtas_arg_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rtas_args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">nargs</span><span class="p">]);</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">outputs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nargs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">rtas_args</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">rtas_arg_t</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nret</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">rtas_args</span><span class="p">.</span><span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">opal_enter_rtas</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtas_args</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_data</span><span class="p">),</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_entry</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nret</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">outputs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nret</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rtas_args</span><span class="p">.</span><span class="n">rets</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">nret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="n">rtas_args</span><span class="p">.</span><span class="n">rets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_opal_hold_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">servers</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">opal_secondary_entry</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">opal_secondary_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">opal_secondary_data</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_opal_hold_cpus: start...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    - entry       = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    - data        = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* look for cpus */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Skip non-configured cpus. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;okay&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

		<span class="n">cnt</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,ppc-interrupt-server#s&quot;</span><span class="p">,</span> <span class="n">servers</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">servers</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpu</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;CPU %d ... &quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;booted !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;starting ... &quot;</span><span class="p">);</span>

			<span class="cm">/* Init the acknowledge var which will be reset by</span>
<span class="cm">			 * the secondary cpu when it awakens from its OF</span>
<span class="cm">			 * spinloop.</span>
<span class="cm">			 */</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">prom_rtas_call</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_start_cpu</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="nb">NULL</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;rtas rc=%d ...&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100000000</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">HMT_low</span><span class="p">();</span>
				<span class="n">mb</span><span class="p">();</span>
			<span class="p">}</span>
			<span class="n">HMT_medium</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;done, PIR=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;timeout !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_opal_hold_cpus: end...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_opal_takeover</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">opal_secondary_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">opal_secondary_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">opal_takeover_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">align</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_align</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">top_addr</span><span class="p">,</span> <span class="n">opal_addr</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">k_image</span>	<span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">RELOC</span><span class="p">(</span><span class="n">_stext</span><span class="p">);</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">k_size</span>	<span class="o">=</span> <span class="n">_end</span> <span class="o">-</span> <span class="n">_stext</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">k_entry</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">k_entry2</span>	<span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>

	<span class="n">top_addr</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">k_size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_image</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">);</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_size</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_image</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_loc</span> <span class="o">=</span> <span class="n">top_addr</span><span class="p">;</span>
		<span class="n">top_addr</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_loc</span> <span class="o">+</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Pickup an address for the HAL. We want to go really high</span>
<span class="cm">	 * up to avoid problem with future kexecs. On the other hand</span>
<span class="cm">	 * we don&#39;t want to be all over the TCEs on P5IOC2 machines</span>
<span class="cm">	 * which are going to be up there too. We assume the machine</span>
<span class="cm">	 * has plenty of memory, and we ask for the HAL for now to</span>
<span class="cm">	 * be just below the 1G point, or above the initrd</span>
<span class="cm">	 */</span>
	<span class="n">opal_addr</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="mh">0x40000000</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_size</span><span class="p">),</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opal_addr</span> <span class="o">&lt;</span> <span class="n">top_addr</span><span class="p">)</span>
		<span class="n">opal_addr</span> <span class="o">=</span> <span class="n">top_addr</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">hal_addr</span> <span class="o">=</span> <span class="n">opal_addr</span><span class="p">;</span>

	<span class="cm">/* Copy the command line to the kernel image */</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_cmd_line</span><span class="p">),</span>
		<span class="n">COMMAND_LINE_SIZE</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  k_image    = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">k_image</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  k_size     = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">k_size</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  k_entry    = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">k_entry</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  k_entry2   = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">k_entry2</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  hal_addr   = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">hal_addr</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  rd_image   = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_image</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  rd_size    = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_size</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;  rd_loc     = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">rd_loc</span><span class="p">);</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Performing OPAL takeover,this can take a few minutes..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prom_close_stdin</span><span class="p">();</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span>
		<span class="n">opal_do_takeover</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate room for and instantiate OPAL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_instantiate_opal</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">opal_node</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">opal_inst</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">align</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rets</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_instantiate_opal: start...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">opal_node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/ibm,opal&quot;</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;opal_node: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opal_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">opal_node</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">opal_node</span><span class="p">,</span> <span class="s">&quot;opal-runtime-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">opal_node</span><span class="p">,</span> <span class="s">&quot;opal-runtime-alignment&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">align</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">align</span><span class="p">));</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">alloc_down</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;OPAL allocation failed !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">opal_inst</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/ibm,opal&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IHANDLE_VALID</span><span class="p">(</span><span class="n">opal_inst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;opening opal package failed (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opal_inst</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;instantiating opal at 0x%x...&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call_prom_ret</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rets</span><span class="p">,</span>
			  <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;load-opal-runtime&quot;</span><span class="p">),</span>
			  <span class="n">opal_inst</span><span class="p">,</span>
			  <span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">rets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rets</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">rets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">rets</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reserve_mem</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;opal base     = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;opal align    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;opal entry    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;opal size     = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>

	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">opal_node</span><span class="p">,</span> <span class="s">&quot;/ibm,opal&quot;</span><span class="p">,</span> <span class="s">&quot;opal-base-address&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">base</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">opal_node</span><span class="p">,</span> <span class="s">&quot;/ibm,opal&quot;</span><span class="p">,</span> <span class="s">&quot;opal-entry-address&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_PPC_EARLY_DEBUG_OPAL</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_base</span><span class="p">)</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_entry</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_instantiate_opal: end...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_POWERNV */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Allocate room for and instantiate RTAS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_instantiate_rtas</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">rtas_node</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">rtas_inst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_instantiate_rtas: start...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtas_node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/rtas&quot;</span><span class="p">));</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;rtas_node: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtas_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="s">&quot;rtas-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">alloc_down</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;Could not allocate memory for RTAS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtas_inst</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/rtas&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IHANDLE_VALID</span><span class="p">(</span><span class="n">rtas_inst</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;opening rtas package failed (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtas_inst</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;instantiating rtas at 0x%x...&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call_prom_ret</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span>
			  <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;instantiate-rtas&quot;</span><span class="p">),</span>
			  <span class="n">rtas_inst</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">entry</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot; done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reserve_mem</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="s">&quot;/rtas&quot;</span><span class="p">,</span> <span class="s">&quot;linux,rtas-base&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">base</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="s">&quot;/rtas&quot;</span><span class="p">,</span> <span class="s">&quot;linux,rtas-entry&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_PPC_POWERNV</span>
	<span class="cm">/* PowerVN takeover hack */</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_entry</span><span class="p">)</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">rtas_node</span><span class="p">,</span> <span class="s">&quot;start-cpu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_rtas_start_cpu</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;rtas base     = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;rtas entry    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;rtas size     = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_instantiate_rtas: end...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cm">/*</span>
<span class="cm"> * Allocate room for and initialize TCE tables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_initialize_tce_table</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">phb_node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">compatible</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">type</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_scratch</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">base</span><span class="p">,</span> <span class="n">align</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">minalign</span><span class="p">,</span> <span class="n">minsize</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tce_entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tce_entryp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">local_alloc_top</span><span class="p">,</span> <span class="n">local_alloc_bottom</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_iommu_off</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;starting prom_initialize_tce_table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Cache current top of allocs so we reserve a single block */</span>
	<span class="n">local_alloc_top</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top_high</span><span class="p">);</span>
	<span class="n">local_alloc_bottom</span> <span class="o">=</span> <span class="n">local_alloc_top</span><span class="p">;</span>

	<span class="cm">/* Search all nodes looking for PHBs. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">compatible</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;compatible&quot;</span><span class="p">,</span>
			     <span class="n">compatible</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">compatible</span><span class="p">));</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">model</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;pci&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Keep the old logic intact to avoid regression. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">compatible</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">strstr</span><span class="p">(</span><span class="n">compatible</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;python&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">compatible</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;Speedwagon&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">compatible</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;Winnipeg&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">strstr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;ython&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;peedwagon&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;innipeg&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;tce-table-minalign&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minalign</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">minalign</span><span class="p">))</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="n">minalign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;tce-table-minsize&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minsize</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">minsize</span><span class="p">))</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="n">minsize</span> <span class="o">=</span> <span class="mi">4UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Even though we read what OF wants, we just set the table</span>
<span class="cm">		 * size to 4 MB.  This is enough to map 2GB of PCI DMA space.</span>
<span class="cm">		 * By doing this, we avoid the pitfalls of trying to DMA to</span>
<span class="cm">		 * MMIO space and the DMA alias hole.</span>
<span class="cm">		 *</span>
<span class="cm">		 * On POWER4, firmware sets the TCE region by assuming</span>
<span class="cm">		 * each TCE table is 8MB. Using this memory for anything</span>
<span class="cm">		 * else will impact performance, so we always allocate 8MB.</span>
<span class="cm">		 * Anton</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__is_processor</span><span class="p">(</span><span class="n">PV_POWER4</span><span class="p">)</span> <span class="o">||</span> <span class="n">__is_processor</span><span class="p">(</span><span class="n">PV_POWER4p</span><span class="p">))</span>
			<span class="n">minsize</span> <span class="o">=</span> <span class="mi">8UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">minsize</span> <span class="o">=</span> <span class="mi">4UL</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

		<span class="cm">/* Align to the greater of the align or size */</span>
		<span class="n">align</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">minalign</span><span class="p">,</span> <span class="n">minsize</span><span class="p">);</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">alloc_down</span><span class="p">(</span><span class="n">minsize</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;ERROR, cannot find space for TCE table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="n">local_alloc_bottom</span><span class="p">)</span>
			<span class="n">local_alloc_bottom</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

		<span class="cm">/* It seems OF doesn&#39;t null-terminate the path :-( */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="p">);</span>
		<span class="cm">/* Call OF to setup the TCE hardware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
			      <span class="n">path</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;package-to-path failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Save away the TCE table attributes for later use. */</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s">&quot;linux,tce-base&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s">&quot;linux,tce-size&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minsize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">minsize</span><span class="p">));</span>

		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;TCE table: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">node = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">base = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">minsize</span><span class="p">);</span>

		<span class="cm">/* Initialize the table to have a one-to-one mapping</span>
<span class="cm">		 * over the allocated size.</span>
<span class="cm">		 */</span>
		<span class="n">tce_entryp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">minsize</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">;</span><span class="n">tce_entryp</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tce_entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
			<span class="n">tce_entry</span> <span class="o">|=</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="o">*</span><span class="n">tce_entryp</span> <span class="o">=</span> <span class="n">tce_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;opening PHB %s&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="n">phb_node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phb_node</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;... failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;... done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;set-64-bit-addressing&quot;</span><span class="p">),</span>
			  <span class="n">phb_node</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">minsize</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">base</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phb_node</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reserve_mem</span><span class="p">(</span><span class="n">local_alloc_bottom</span><span class="p">,</span> <span class="n">local_alloc_top</span> <span class="o">-</span> <span class="n">local_alloc_bottom</span><span class="p">);</span>

	<span class="cm">/* These are only really needed if there is a memory limit in</span>
<span class="cm">	 * effect, but we don&#39;t know so export them always. */</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_tce_alloc_start</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_alloc_bottom</span><span class="p">;</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_tce_alloc_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">local_alloc_top</span><span class="p">;</span>

	<span class="cm">/* Flag the first invalid entry */</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;ending prom_initialize_tce_table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * With CHRP SMP we need to use the OF to start the other processors.</span>
<span class="cm"> * We can&#39;t wait until smp_boot_cpus (the OF is trashed by then)</span>
<span class="cm"> * so we have to put the processors into a holding pattern controlled</span>
<span class="cm"> * by the kernel (not OF) before we destroy the OF.</span>
<span class="cm"> *</span>
<span class="cm"> * This uses a chunk of low memory, puts some holding pattern</span>
<span class="cm"> * code there and sends the other processors off to there until</span>
<span class="cm"> * smp_boot_cpus tells them to do something.  The holding pattern</span>
<span class="cm"> * checks that address until its cpu # is there, when it is that</span>
<span class="cm"> * cpu jumps to __secondary_start().  smp_boot_cpus() takes care</span>
<span class="cm"> * of setting those values.</span>
<span class="cm"> *</span>
<span class="cm"> * We also use physical address 0x4 here to tell when a cpu</span>
<span class="cm"> * is in its holding pattern code.</span>
<span class="cm"> *</span>
<span class="cm"> * -- Cort</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * We want to reference the copy of __secondary_hold_* in the</span>
<span class="cm"> * 0 - 0x100 address range</span>
<span class="cm"> */</span>
<span class="cp">#define LOW_ADDR(x)	(((unsigned long) &amp;(x)) &amp; 0xff)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_hold_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">spinloop</span>
		<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">LOW_ADDR</span><span class="p">(</span><span class="n">__secondary_hold_spinloop</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">acknowledge</span>
		<span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">LOW_ADDR</span><span class="p">(</span><span class="n">__secondary_hold_acknowledge</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secondary_hold</span> <span class="o">=</span> <span class="n">LOW_ADDR</span><span class="p">(</span><span class="n">__secondary_hold</span><span class="p">);</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_hold_cpus: start...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    1) spinloop       = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">spinloop</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    1) *spinloop      = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">spinloop</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    1) acknowledge    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">acknowledge</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    1) *acknowledge   = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">acknowledge</span><span class="p">);</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;    1) secondary_hold = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">secondary_hold</span><span class="p">);</span>

	<span class="cm">/* Set the common spinloop variable, so all of the secondary cpus</span>
<span class="cm">	 * will block when they are awakened from their OF spinloop.</span>
<span class="cm">	 * This must occur for both SMP and non SMP kernels, since OF will</span>
<span class="cm">	 * be trashed when we move the kernel.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">spinloop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* look for cpus */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;cpu&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Skip non-configured cpus. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;okay&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>

		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;cpu hw idx   = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Init the acknowledge var which will be reset by</span>
<span class="cm">		 * the secondary cpu when it awakens from its OF</span>
<span class="cm">		 * spinloop.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">acknowledge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Primary Thread of non-boot cpu or any thread */</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;starting cpu hw idx %lu... &quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;start-cpu&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
				  <span class="n">secondary_hold</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
			     <span class="p">(</span><span class="o">*</span><span class="n">acknowledge</span> <span class="o">==</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
				<span class="n">mb</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">acknowledge</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span>
				<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;failed: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">acknowledge</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_SMP</span>
		<span class="k">else</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;boot cpu hw idx %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;prom_hold_cpus: end...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_init_client_services</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="cm">/* Get a handle to the prom entry point before anything else */</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_entry</span><span class="p">)</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>

	<span class="cm">/* get a handle for the stdout device */</span>
	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/chosen&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">))</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;cannot find chosen&quot;</span><span class="p">);</span> <span class="cm">/* msg won&#39;t be printed :( */</span>

	<span class="cm">/* get device tree root */</span>
	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">))</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;cannot find device tree root&quot;</span><span class="p">);</span> <span class="cm">/* msg won&#39;t be printed :( */</span>

	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
<span class="cm">/*</span>
<span class="cm"> * For really old powermacs, we need to map things we claim.</span>
<span class="cm"> * For that, we need the ihandle of the mmu.</span>
<span class="cm"> * Also, on the longtrail, we need to work around other bugs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_find_mmu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="n">phandle</span> <span class="n">oprom</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">version</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">oprom</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/openprom&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">oprom</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">oprom</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">version</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* XXX might need to add other versions here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;Open Firmware, 1.0.5&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">of_workarounds</span> <span class="o">=</span> <span class="n">OF_WA_CLAIM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;FirmWorks,3.&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">of_workarounds</span> <span class="o">=</span> <span class="n">OF_WA_CLAIM</span> <span class="o">|</span> <span class="n">OF_WA_LONGTRAIL</span><span class="p">;</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;interpret&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dev /memory 0 to allow-reclaim&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/memory&quot;</span><span class="p">));</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;mmu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span><span class="p">,</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IHANDLE_VALID</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IHANDLE_VALID</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">mmumap</span><span class="p">))</span>
		<span class="n">of_workarounds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OF_WA_CLAIM</span><span class="p">;</span>		<span class="cm">/* hmmm */</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define prom_find_mmu()</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_init_stdout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">of_stdout_device</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;stdout&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;cannot find stdout&quot;</span><span class="p">);</span>

	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Get the full OF pathname of the stdout device */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;instance-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;instance-to-package&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">stdout</span><span class="p">);</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,stdout-package&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;OF stdout device is: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">of_stdout_device</span><span class="p">));</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,stdout-path&quot;</span><span class="p">,</span>
		     <span class="n">path</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* If it&#39;s a display, note it */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;display&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s">&quot;linux,boot-display&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_find_machine_type</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">compat</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">phandle</span> <span class="n">rtas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Look for a PowerMac or a Cell */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;compatible&quot;</span><span class="p">,</span>
			   <span class="n">compat</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">compat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compat</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">compat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">sl</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;Power Macintosh&quot;</span><span class="p">))</span> <span class="o">||</span>
			    <span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;MacRISC&quot;</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">PLATFORM_POWERMAC</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
			<span class="cm">/* We must make sure we don&#39;t detect the IBM Cell</span>
<span class="cm">			 * blades as pSeries due to some firmware issues,</span>
<span class="cm">			 * so we do it here.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;IBM,CBEA&quot;</span><span class="p">))</span> <span class="o">||</span>
			    <span class="n">strstr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;IBM,CPBW-1.0&quot;</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">PLATFORM_GENERIC</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">sl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="cm">/* Try to detect OPAL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/ibm,opal&quot;</span><span class="p">))))</span>
		<span class="k">return</span> <span class="n">PLATFORM_OPAL</span><span class="p">;</span>

	<span class="cm">/* Try to figure out if it&#39;s an IBM pSeries or any other</span>
<span class="cm">	 * PAPR compliant platform. We assume it is if :</span>
<span class="cm">	 *  - /device_type is &quot;chrp&quot; (please, do NOT use that for future</span>
<span class="cm">	 *    non-IBM designs !</span>
<span class="cm">	 *  - it has /rtas</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span>
			   <span class="n">compat</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">compat</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PLATFORM_GENERIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">compat</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;chrp&quot;</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">PLATFORM_GENERIC</span><span class="p">;</span>

	<span class="cm">/* Default to pSeries. We need to know if we are running LPAR */</span>
	<span class="n">rtas</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/rtas&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">rtas</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PLATFORM_GENERIC</span><span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">prom_getproplen</span><span class="p">(</span><span class="n">rtas</span><span class="p">,</span> <span class="s">&quot;ibm,hypertas-functions&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">PROM_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;Hypertas detected, assuming LPAR !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PLATFORM_PSERIES_LPAR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PLATFORM_PSERIES</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">PLATFORM_GENERIC</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">prom_set_color</span><span class="p">(</span><span class="n">ihandle</span> <span class="n">ih</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">g</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;call-method&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;color!&quot;</span><span class="p">),</span> <span class="n">ih</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If we have a display that we don&#39;t know how to drive,</span>
<span class="cm"> * we will want to try to execute OF&#39;s open method for it</span>
<span class="cm"> * later.  However, OF will probably fall over if we do that</span>
<span class="cm"> * we&#39;ve taken over the MMU.</span>
<span class="cm"> * So we check whether we will need to open the display,</span>
<span class="cm"> * and if so, open it now.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_check_displays</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">type</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">ih</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">default_colors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span>
		<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
		<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
		<span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clut</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;Looking for displays</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">prom_next_node</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;display&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* It seems OF doesn&#39;t null-terminate the path :-( */</span>
		<span class="n">path</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_scratch</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * leave some room at the end of the path for appending extra</span>
<span class="cm">		 * arguments</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
			      <span class="n">PROM_SCRATCH_SIZE</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;found display   : %s, opening... &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		
		<span class="n">ih</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;open&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ih</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Success */</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="s">&quot;linux,opened&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Setup a usable color table when the appropriate</span>
<span class="cm">		 * method is available. Should update this to set-colors */</span>
		<span class="n">clut</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">default_colors</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">clut</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prom_set_color</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">clut</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clut</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					   <span class="n">clut</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_LOGO_LINUX_CLUT224</span>
		<span class="n">clut</span> <span class="o">=</span> <span class="n">PTRRELOC</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">logo_linux_clut224</span><span class="p">.</span><span class="n">clut</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">logo_linux_clut224</span><span class="p">.</span><span class="n">clutsize</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">clut</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prom_set_color</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">clut</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">clut</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					   <span class="n">clut</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_LOGO_LINUX_CLUT224 */</span><span class="cp"></span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Return (relocated) pointer to this much memory: moves initrd if reqd. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">make_room</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_end</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">needed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">needed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">mem_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">room</span><span class="p">,</span> <span class="n">chunk</span><span class="p">;</span>

		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;Chunk exhausted, claiming more at %x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">));</span>
		<span class="n">room</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&gt;</span> <span class="n">DEVTREE_CHUNK_SIZE</span><span class="p">)</span>
			<span class="n">room</span> <span class="o">=</span> <span class="n">DEVTREE_CHUNK_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;No memory for flatten_device_tree &quot;</span>
				   <span class="s">&quot;(no room)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chunk</span> <span class="o">=</span> <span class="n">alloc_up</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;No memory for flatten_device_tree &quot;</span>
				   <span class="s">&quot;(claim failed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">chunk</span> <span class="o">+</span> <span class="n">room</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="o">*</span><span class="n">mem_start</span> <span class="o">+=</span> <span class="n">needed</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define dt_push_token(token, mem_start, mem_end) \</span>
<span class="cp">	do { *((u32 *)make_room(mem_start, mem_end, 4, 4)) = token; } while(0)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">dt_find_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">os</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">os</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_end</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">s</span> <span class="o">-</span> <span class="n">os</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Open Firmware 1275 specification states properties must be 31 bytes or</span>
<span class="cm"> * less, however not all firmwares obey this. Make it 64 bytes to be safe.</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_PROPERTY_NAME 64</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">scan_dt_build_strings</span><span class="p">(</span><span class="n">phandle</span> <span class="n">node</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">prev_name</span><span class="p">,</span> <span class="o">*</span><span class="n">namep</span><span class="p">,</span> <span class="o">*</span><span class="n">sstart</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">soff</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">child</span><span class="p">;</span>

	<span class="n">sstart</span> <span class="o">=</span>  <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">);</span>

	<span class="cm">/* get and store all property names */</span>
	<span class="n">prev_name</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* 64 is max len of name including nul. */</span>
		<span class="n">namep</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">,</span> <span class="n">MAX_PROPERTY_NAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;nextprop&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">prev_name</span><span class="p">,</span> <span class="n">namep</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No more nodes: unwind alloc */</span>
			<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">namep</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

 		<span class="cm">/* skip &quot;name&quot; */</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">namep</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 			<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">namep</span><span class="p">;</span>
 			<span class="n">prev_name</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">);</span>
 			<span class="k">continue</span><span class="p">;</span>
 		<span class="p">}</span>
		<span class="cm">/* get/create string entry */</span>
		<span class="n">soff</span> <span class="o">=</span> <span class="n">dt_find_string</span><span class="p">(</span><span class="n">namep</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">soff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">namep</span><span class="p">;</span>
			<span class="n">namep</span> <span class="o">=</span> <span class="n">sstart</span> <span class="o">+</span> <span class="n">soff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Trim off some if we can */</span>
			<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">namep</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_end</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_name</span> <span class="o">=</span> <span class="n">namep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do all our children */</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;child&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_dt_build_strings</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">scan_dt_build_struct</span><span class="p">(</span><span class="n">phandle</span> <span class="n">node</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">mem_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">child</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">namep</span><span class="p">,</span> <span class="o">*</span><span class="n">prev_name</span><span class="p">,</span> <span class="o">*</span><span class="n">sstart</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">soff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">valp</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">pname</span><span class="p">[</span><span class="n">MAX_PROPERTY_NAME</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="n">has_phandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dt_push_token</span><span class="p">(</span><span class="n">OF_DT_BEGIN_NODE</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>

	<span class="cm">/* get the node&#39;s full name */</span>
	<span class="n">namep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">room</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem_end</span> <span class="o">-</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">room</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">namep</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Didn&#39;t fit?  Get more room. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="n">room</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">mem_end</span> <span class="o">-</span> <span class="o">*</span><span class="n">mem_start</span><span class="p">)</span>
				<span class="n">namep</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">namep</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">namep</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="cm">/* Fixup an Apple bug where they have bogus \0 chars in the</span>
<span class="cm">		 * middle of the path in some properties, and extract</span>
<span class="cm">		 * the unit name (everything after the last &#39;/&#39;).</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">namep</span><span class="p">,</span> <span class="n">ep</span> <span class="o">=</span> <span class="n">namep</span> <span class="o">+</span> <span class="n">l</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span>
				<span class="n">lp</span> <span class="o">=</span> <span class="n">namep</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">lp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">_ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">lp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* get it again for debugging */</span>
	<span class="n">path</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_scratch</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="p">);</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;package-to-path&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">PROM_SCRATCH_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* get and store all properties */</span>
	<span class="n">prev_name</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">sstart</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;nextprop&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">prev_name</span><span class="p">,</span>
			      <span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

 		<span class="cm">/* skip &quot;name&quot; */</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
 			<span class="n">prev_name</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">);</span>
 			<span class="k">continue</span><span class="p">;</span>
 		<span class="p">}</span>

		<span class="cm">/* find string offset */</span>
		<span class="n">soff</span> <span class="o">=</span> <span class="n">dt_find_string</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">soff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;WARNING: Can&#39;t find string index for&quot;</span>
				    <span class="s">&quot; &lt;%s&gt;, node %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev_name</span> <span class="o">=</span> <span class="n">sstart</span> <span class="o">+</span> <span class="n">soff</span><span class="p">;</span>

		<span class="cm">/* get length */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;getproplen&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">));</span>

		<span class="cm">/* sanity checks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* push property head */</span>
		<span class="n">dt_push_token</span><span class="p">(</span><span class="n">OF_DT_PROP</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
		<span class="n">dt_push_token</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
		<span class="n">dt_push_token</span><span class="p">(</span><span class="n">soff</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>

		<span class="cm">/* push property content */</span>
		<span class="n">valp</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;getprop&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span> <span class="n">valp</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="o">*</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">mem_start</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">pname</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;phandle&quot;</span><span class="p">)))</span>
			<span class="n">has_phandle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add a &quot;linux,phandle&quot; property if no &quot;phandle&quot; property already</span>
<span class="cm">	 * existed (can happen with OPAL)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_phandle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">soff</span> <span class="o">=</span> <span class="n">dt_find_string</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;linux,phandle&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">soff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;WARNING: Can&#39;t find string index for&quot;</span>
				    <span class="s">&quot; &lt;linux-phandle&gt; node %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dt_push_token</span><span class="p">(</span><span class="n">OF_DT_PROP</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
			<span class="n">dt_push_token</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
			<span class="n">dt_push_token</span><span class="p">(</span><span class="n">soff</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
			<span class="n">valp</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">valp</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* do all our children */</span>
	<span class="n">child</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;child&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_dt_build_struct</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
		<span class="n">child</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dt_push_token</span><span class="p">(</span><span class="n">OF_DT_END_NODE</span><span class="p">,</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">flatten_device_tree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">root</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_end</span><span class="p">,</span> <span class="n">room</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">boot_param_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">namep</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">rsvmap</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check how much room we have between alloc top &amp; bottom (+/- a</span>
<span class="cm">	 * few pages), crop to 1MB, as this is our &quot;chunk&quot; size</span>
<span class="cm">	 */</span>
	<span class="n">room</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_top</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">room</span> <span class="o">&gt;</span> <span class="n">DEVTREE_CHUNK_SIZE</span><span class="p">)</span>
		<span class="n">room</span> <span class="o">=</span> <span class="n">DEVTREE_CHUNK_SIZE</span><span class="p">;</span>
	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;starting device tree allocs at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">alloc_bottom</span><span class="p">));</span>

	<span class="cm">/* Now try to claim that */</span>
	<span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">alloc_up</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;Can&#39;t allocate initial device-tree chunk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mem_end</span> <span class="o">=</span> <span class="n">mem_start</span> <span class="o">+</span> <span class="n">room</span><span class="p">;</span>

	<span class="cm">/* Get root of tree */</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">phandle</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">root</span> <span class="o">==</span> <span class="p">(</span><span class="n">phandle</span><span class="p">)</span><span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span> <span class="p">(</span><span class="s">&quot;couldn&#39;t get device tree root</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Build header and make room for mem rsv map */</span> 
	<span class="n">mem_start</span> <span class="o">=</span> <span class="n">_ALIGN</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">boot_param_header</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">rsvmap</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Start of strings */</span>
	<span class="n">mem_start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mem_start</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">)</span> <span class="o">=</span> <span class="n">mem_start</span><span class="p">;</span>
	<span class="n">mem_start</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* hole */</span>

	<span class="cm">/* Add &quot;linux,phandle&quot; in there, we&#39;ll need it */</span>
	<span class="n">namep</span> <span class="o">=</span> <span class="n">make_room</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">namep</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="s">&quot;linux,phandle&quot;</span><span class="p">));</span>
	<span class="n">mem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">namep</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">namep</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Build string array */</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Building dt strings...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="n">scan_dt_build_strings</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">mem_start</span><span class="p">;</span>

	<span class="cm">/* Build structure */</span>
	<span class="n">mem_start</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mem_start</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_start</span><span class="p">)</span> <span class="o">=</span> <span class="n">mem_start</span><span class="p">;</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Building dt structure...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
	<span class="n">scan_dt_build_struct</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">);</span>
	<span class="n">dt_push_token</span><span class="p">(</span><span class="n">OF_DT_END</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_end</span><span class="p">);</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">mem_start</span><span class="p">);</span>

	<span class="cm">/* Finish header */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">boot_cpuid_phys</span> <span class="o">=</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">OF_DT_HEADER</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">totalsize</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">off_dt_struct</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">off_dt_strings</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dt_strings_size</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">off_mem_rsvmap</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rsvmap</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">OF_DT_VERSION</span><span class="p">;</span>
	<span class="cm">/* Version 16 is not backward compatible */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">last_comp_version</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="cm">/* Copy the reserve map in */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rsvmap</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">));</span>

<span class="cp">#ifdef DEBUG_PROM</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;reserved memory map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_cnt</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;  %x - %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">)[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">,</span>
				    <span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_map</span><span class="p">)[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Bump mem_reserve_cnt to cause further reservations to fail</span>
<span class="cm">	 * since it&#39;s too late.</span>
<span class="cm">	 */</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">mem_reserve_cnt</span><span class="p">)</span> <span class="o">=</span> <span class="n">MEM_RESERVE_MAP_SIZE</span><span class="p">;</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Device tree strings 0x%x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_start</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_string_end</span><span class="p">));</span> 
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Device tree struct  0x%x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_start</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_struct_end</span><span class="p">));</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_MAPLE</span>
<span class="cm">/* PIBS Version 1.05.0000 04/26/2005 has an incorrect /ht/isa/ranges property.</span>
<span class="cm"> * The values are bad, and it doesn&#39;t even have the right number of cells. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_maple</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">isa</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rloc</span> <span class="o">=</span> <span class="mh">0x01002000</span><span class="p">;</span> <span class="cm">/* IO space; PCI device = 4 */</span>
	<span class="n">u32</span> <span class="n">isa_ranges</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/ht@0/isa@4&quot;</span><span class="p">;</span>
	<span class="n">isa</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">isa</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/ht@0/isa@6&quot;</span><span class="p">;</span>
		<span class="n">isa</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
		<span class="n">rloc</span> <span class="o">=</span> <span class="mh">0x01003000</span><span class="p">;</span> <span class="cm">/* IO space; PCI device = 6 */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">isa</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getproplen</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">,</span> <span class="n">isa_ranges</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">isa_ranges</span><span class="p">))</span>
		<span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isa_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">||</span>
		<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf4000000</span> <span class="o">||</span>
		<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00010000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing up bogus ISA range on Maple/Apache...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rloc</span><span class="p">;</span>
	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">isa_ranges</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">isa</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">,</span>
			<span class="n">isa_ranges</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">isa_ranges</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define CPC925_MC_START		0xf8000000</span>
<span class="cp">#define CPC925_MC_LENGTH	0x1000000</span>
<span class="cm">/* The values for memory-controller don&#39;t have right number of cells */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_maple_memory_controller</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">mc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mc_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/hostbridge@f8000000&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ac</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>

	<span class="n">mc</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">mc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getproplen</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;#address-cells&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac</span><span class="p">));</span>
	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">,</span> <span class="s">&quot;#size-cells&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ac</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="n">mc_reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_reg</span><span class="p">))</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CPC925_MC_START</span> <span class="o">||</span> <span class="n">mc_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">CPC925_MC_LENGTH</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing up bogus hostbridge on Maple...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mc_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">mc_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CPC925_MC_START</span><span class="p">;</span>
	<span class="n">mc_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">mc_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">CPC925_MC_LENGTH</span><span class="p">;</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="n">mc_reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mc_reg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fixup_device_tree_maple()</span>
<span class="cp">#define fixup_device_tree_maple_memory_controller()</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_CHRP</span>
<span class="cm">/*</span>
<span class="cm"> * Pegasos and BriQ lacks the &quot;ranges&quot; property in the isa node</span>
<span class="cm"> * Pegasos needs decimal IRQ 14/15, not hexadecimal</span>
<span class="cm"> * Pegasos has the IDE configured in legacy mode, but advertised as native</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_chrp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">ph</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prop</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rloc</span> <span class="o">=</span> <span class="mh">0x01006000</span><span class="p">;</span> <span class="cm">/* IO space; PCI device = 12 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/pci@80000000/isa@c&quot;</span><span class="p">;</span>
	<span class="n">ph</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/pci@ff500000/isa@6&quot;</span><span class="p">;</span>
		<span class="n">ph</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
		<span class="n">rloc</span> <span class="o">=</span> <span class="mh">0x01003000</span><span class="p">;</span> <span class="cm">/* IO space; PCI device = 6 */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">prom_getproplen</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing up missing ISA range on Pegasos...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rloc</span><span class="p">;</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
			<span class="n">prom_setprop</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;/pci@80000000/ide@C,1&quot;</span><span class="p">;</span>
	<span class="n">ph</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">ph</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing up IDE interrupt on Pegasos...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">prop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing up IDE class-code on Pegasos...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="s">&quot;class-code&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x5</span><span class="p">;</span>
			<span class="n">prom_setprop</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s">&quot;class-code&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fixup_device_tree_chrp()</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PPC64) &amp;&amp; defined(CONFIG_PPC_PMAC)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_pmac</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phandle</span> <span class="n">u3</span><span class="p">,</span> <span class="n">i2c</span><span class="p">,</span> <span class="n">mpic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u3_rev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">interrupts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">parent</span><span class="p">;</span>

	<span class="cm">/* Some G5s have a missing interrupt definition, fix it up here */</span>
	<span class="n">u3</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/u3@0,f8000000&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">u3</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">i2c</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/u3@0,f8000000/i2c@f8001000&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">i2c</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">mpic</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/u3@0,f8000000/mpic@f8040000&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">mpic</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* check if proper rev of u3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">u3</span><span class="p">,</span> <span class="s">&quot;device-rev&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u3_rev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u3_rev</span><span class="p">))</span>
	    <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u3_rev</span> <span class="o">&lt;</span> <span class="mh">0x35</span> <span class="o">||</span> <span class="n">u3_rev</span> <span class="o">&gt;</span> <span class="mh">0x39</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* does it need fixup ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getproplen</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;fixing up bogus interrupts for u3 i2c...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* interrupt on this revision of u3 is number 0 and level */</span>
	<span class="n">interrupts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">interrupts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;/u3@0,f8000000/i2c@f8001000&quot;</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">interrupts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">interrupts</span><span class="p">));</span>
	<span class="n">parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mpic</span><span class="p">;</span>
	<span class="n">prom_setprop</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="s">&quot;/u3@0,f8000000/i2c@f8001000&quot;</span><span class="p">,</span> <span class="s">&quot;interrupt-parent&quot;</span><span class="p">,</span>
		     <span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parent</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fixup_device_tree_pmac()</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_EFIKA</span>
<span class="cm">/*</span>
<span class="cm"> * The MPC5200 FEC driver requires an phy-handle property to tell it how</span>
<span class="cm"> * to talk to the phy.  If the phy-handle property is missing, then this</span>
<span class="cm"> * function is called to add the appropriate nodes and link it to the</span>
<span class="cm"> * ethernet node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_efika_add_phy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prop</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="cm">/* Check if /builtin/ethernet exists - bail if it doesn&#39;t */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/builtin/ethernet&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Check if the phy-handle property exists - bail if it does */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;phy-handle&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point the ethernet device doesn&#39;t have a phy described.</span>
<span class="cm">	 * Now we need to add the missing phy node and linkage</span>
<span class="cm">	 */</span>

	<span class="cm">/* Check for an MDIO bus node - if missing then create one */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/builtin/mdio&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Adding Ethernet MDIO node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;interpret&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> /builtin</span><span class="se">\&quot;</span><span class="s"> find-device&quot;</span>
			<span class="s">&quot; new-device&quot;</span>
				<span class="s">&quot; 1 encode-int s</span><span class="se">\&quot;</span><span class="s"> #address-cells</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
				<span class="s">&quot; 0 encode-int s</span><span class="se">\&quot;</span><span class="s"> #size-cells</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> mdio</span><span class="se">\&quot;</span><span class="s"> device-name&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> fsl,mpc5200b-mdio</span><span class="se">\&quot;</span><span class="s"> encode-string&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> compatible</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
				<span class="s">&quot; 0xf0003000 0x400 reg&quot;</span>
				<span class="s">&quot; 0x2 encode-int&quot;</span>
				<span class="s">&quot; 0x5 encode-int encode+&quot;</span>
				<span class="s">&quot; 0x3 encode-int encode+&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> interrupts</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
			<span class="s">&quot; finish-device&quot;</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="cm">/* Check for a PHY device node - if missing then create one and</span>
<span class="cm">	 * give it&#39;s phandle to the ethernet node */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/builtin/mdio/ethernet-phy&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Adding Ethernet PHY node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;interpret&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> /builtin/mdio</span><span class="se">\&quot;</span><span class="s"> find-device&quot;</span>
			<span class="s">&quot; new-device&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> ethernet-phy</span><span class="se">\&quot;</span><span class="s"> device-name&quot;</span>
				<span class="s">&quot; 0x10 encode-int s</span><span class="se">\&quot;</span><span class="s"> reg</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
				<span class="s">&quot; my-self&quot;</span>
				<span class="s">&quot; ihandle&gt;phandle&quot;</span>
			<span class="s">&quot; finish-device&quot;</span>
			<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> /builtin/ethernet</span><span class="se">\&quot;</span><span class="s"> find-device&quot;</span>
				<span class="s">&quot; encode-int&quot;</span>
				<span class="s">&quot; s</span><span class="se">\&quot;</span><span class="s"> phy-handle</span><span class="se">\&quot;</span><span class="s"> property&quot;</span>
			<span class="s">&quot; device-end&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree_efika</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sound_irq</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">bcomm_irq</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				<span class="mi">3</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">prop</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Check if we&#39;re really running on a EFIKA */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;model&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;EFIKA5K2&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Applying EFIKA device tree fixups</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Claiming to be &#39;chrp&#39; is death */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">));</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">PROM_ERROR</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;chrp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="s">&quot;efika&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;efika&quot;</span><span class="p">));</span>

	<span class="cm">/* CODEGEN,description is exposed in /proc/cpuinfo so</span>
<span class="cm">	   fix that too */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;CODEGEN,description&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">!=</span> <span class="n">PROM_ERROR</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&quot;CHRP&quot;</span><span class="p">)))</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;CODEGEN,description&quot;</span><span class="p">,</span>
			     <span class="s">&quot;Efika 5200B PowerPC System&quot;</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;Efika 5200B PowerPC System&quot;</span><span class="p">));</span>

	<span class="cm">/* Fixup bestcomm interrupts property */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/builtin/bestcomm&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">prom_getproplen</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Fixing bestcomm interrupts property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;/builtin/bestcom&quot;</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span>
				     <span class="n">bcomm_irq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bcomm_irq</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fixup sound interrupts property */</span>
	<span class="n">node</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;finddevice&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADDR</span><span class="p">(</span><span class="s">&quot;/builtin/sound&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHANDLE_VALID</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">prom_getprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">PROM_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Adding sound interrupts property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">prom_setprop</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;/builtin/sound&quot;</span><span class="p">,</span> <span class="s">&quot;interrupts&quot;</span><span class="p">,</span>
				     <span class="n">sound_irq</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sound_irq</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure ethernet phy-handle property exists */</span>
	<span class="n">fixup_device_tree_efika_add_phy</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fixup_device_tree_efika()</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">fixup_device_tree</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fixup_device_tree_maple</span><span class="p">();</span>
	<span class="n">fixup_device_tree_maple_memory_controller</span><span class="p">();</span>
	<span class="n">fixup_device_tree_chrp</span><span class="p">();</span>
	<span class="n">fixup_device_tree_pmac</span><span class="p">();</span>
	<span class="n">fixup_device_tree_efika</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_find_boot_cpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">getprop_rval</span><span class="p">;</span>
	<span class="n">ihandle</span> <span class="n">prom_cpu</span><span class="p">;</span>
	<span class="n">phandle</span> <span class="n">cpu_pkg</span><span class="p">;</span>

	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prom_getprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prom_cpu</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prom_cpu</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cpu_pkg</span> <span class="o">=</span> <span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;instance-to-package&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prom_cpu</span><span class="p">);</span>

	<span class="n">prom_getprop</span><span class="p">(</span><span class="n">cpu_pkg</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">getprop_rval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">getprop_rval</span><span class="p">));</span>
	<span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">getprop_rval</span><span class="p">;</span>

	<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;Booting CPU hw index = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">_prom</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">prom_check_initrd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r4</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r3</span> <span class="o">&amp;&amp;</span> <span class="n">r4</span> <span class="o">&amp;&amp;</span> <span class="n">r4</span> <span class="o">!=</span> <span class="mh">0xdeadbeef</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">)</span> <span class="o">=</span> <span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">r3</span><span class="p">)</span> <span class="o">?</span> <span class="n">__pa</span><span class="p">(</span><span class="n">r3</span><span class="p">)</span> <span class="o">:</span> <span class="n">r3</span><span class="p">;</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">)</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">)</span> <span class="o">+</span> <span class="n">r4</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">);</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,initrd-start&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">);</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,initrd-end&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>

		<span class="n">reserve_mem</span><span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">),</span>
			    <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">)</span> <span class="o">-</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">));</span>

		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;initrd_start=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_start</span><span class="p">));</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;initrd_end=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_initrd_end</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BLK_DEV_INITRD */</span><span class="cp"></span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * We enter here early on, when the Open Firmware prom is still</span>
<span class="cm"> * handling exceptions and the MMU hash table for us.</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">prom_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r4</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pp</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r6</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r7</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kbase</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="k">struct</span> <span class="n">prom_t</span> <span class="o">*</span><span class="n">_prom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hdr</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">reloc_offset</span><span class="p">();</span>
	<span class="n">reloc_got2</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">_prom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First zero the BSS</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">__bss_start</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">__bss_stop</span> <span class="o">-</span> <span class="n">__bss_start</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init interface to Open Firmware, get some node references,</span>
<span class="cm">	 * like /chosen</span>
<span class="cm">	 */</span>
	<span class="n">prom_init_client_services</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if this OF is old enough that we need to do explicit maps</span>
<span class="cm">	 * and other workarounds</span>
<span class="cm">	 */</span>
	<span class="n">prom_find_mmu</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init prom stdout device</span>
<span class="cm">	 */</span>
	<span class="n">prom_init_stdout</span><span class="p">();</span>

	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Preparing to boot %s&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">linux_banner</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get default machine type. At this point, we do not differentiate</span>
<span class="cm">	 * between pSeries SMP and pSeries LPAR</span>
<span class="cm">	 */</span>
	<span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">=</span> <span class="n">prom_find_machine_type</span><span class="p">();</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Detected machine type: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">));</span>

<span class="cp">#ifndef CONFIG_NONSTATIC_KERNEL</span>
	<span class="cm">/* Bail if this is a kdump kernel. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PHYSICAL_START</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">prom_panic</span><span class="p">(</span><span class="s">&quot;Error: You can&#39;t boot a kdump kernel from OF!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for an initrd</span>
<span class="cm">	 */</span>
	<span class="n">prom_check_initrd</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="n">r4</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_PPC_PSERIES) || defined(CONFIG_PPC_POWERNV)</span>
	<span class="cm">/*</span>
<span class="cm">	 * On pSeries, inform the firmware about our capabilities</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_PSERIES</span> <span class="o">||</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_PSERIES_LPAR</span><span class="p">)</span>
		<span class="n">prom_send_capabilities</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy the CPU hold code</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_POWERMAC</span><span class="p">)</span>
		<span class="n">copy_and_flush</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kbase</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do early parsing of command line</span>
<span class="cm">	 */</span>
	<span class="n">early_cmdline_parse</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize memory management within prom_init</span>
<span class="cm">	 */</span>
	<span class="n">prom_init_mem</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine which cpu is actually running right _now_</span>
<span class="cm">	 */</span>
	<span class="n">prom_find_boot_cpu</span><span class="p">();</span>

	<span class="cm">/* </span>
<span class="cm">	 * Initialize display devices</span>
<span class="cm">	 */</span>
	<span class="n">prom_check_displays</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize IOMMU (TCE tables) on pSeries. Do that before anything else</span>
<span class="cm">	 * that uses the allocator, we need to make sure we get the top of memory</span>
<span class="cm">	 * available for us here...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_PSERIES</span><span class="p">)</span>
		<span class="n">prom_initialize_tce_table</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * On non-powermacs, try to instantiate RTAS. PowerMacs don&#39;t</span>
<span class="cm">	 * have a usable RTAS implementation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_POWERMAC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span>
		<span class="n">prom_instantiate_rtas</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PPC_POWERNV</span>
	<span class="cm">/* Detect HAL and try instanciating it &amp; doing takeover */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_PSERIES_LPAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_query_opal</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prom_opal_hold_cpus</span><span class="p">();</span>
			<span class="n">prom_opal_takeover</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">==</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span>
		<span class="n">prom_instantiate_opal</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * On non-powermacs, put all CPUs in spin-loops.</span>
<span class="cm">	 *</span>
<span class="cm">	 * PowerMacs use a different mechanism to spin CPUs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_POWERMAC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span>
		<span class="n">prom_hold_cpus</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in some infos for use by the kernel later on</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">))</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,memory-limit&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">prom_memory_limit</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_iommu_off</span><span class="p">))</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,iommu-off&quot;</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_iommu_force_on</span><span class="p">))</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,iommu-force-on&quot;</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_tce_alloc_start</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,tce-alloc-start&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_tce_alloc_start</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">prom_tce_alloc_start</span><span class="p">));</span>
		<span class="n">prom_setprop</span><span class="p">(</span><span class="n">_prom</span><span class="o">-&gt;</span><span class="n">chosen</span><span class="p">,</span> <span class="s">&quot;/chosen&quot;</span><span class="p">,</span> <span class="s">&quot;linux,tce-alloc-end&quot;</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">RELOC</span><span class="p">(</span><span class="n">prom_tce_alloc_end</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">prom_tce_alloc_end</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fixup any known bugs in the device-tree</span>
<span class="cm">	 */</span>
	<span class="n">fixup_device_tree</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now finally create the flattened device-tree</span>
<span class="cm">	 */</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;copying OF device tree...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">flatten_device_tree</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * in case stdin is USB and still active on IBM machines...</span>
<span class="cm">	 * Unfortunately quiesce crashes on some powermacs if we have</span>
<span class="cm">	 * closed stdin already (in particular the powerbook 101). It</span>
<span class="cm">	 * appears that the OPAL version of OFW doesn&#39;t like it either.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_POWERMAC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span>
		<span class="n">prom_close_stdin</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call OF &quot;quiesce&quot; method to shut down pending DMA&#39;s from</span>
<span class="cm">	 * devices etc...</span>
<span class="cm">	 */</span>
	<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;Calling quiesce...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">call_prom</span><span class="p">(</span><span class="s">&quot;quiesce&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * And finally, call the kernel passing it the flattened device</span>
<span class="cm">	 * tree and NULL as r5, thus triggering the new entry point which</span>
<span class="cm">	 * is common to us and kexec</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">dt_header_start</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t print anything after quiesce under OPAL, it crashes OFW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RELOC</span><span class="p">(</span><span class="n">of_platform</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PLATFORM_OPAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prom_printf</span><span class="p">(</span><span class="s">&quot;returning from prom_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">prom_debug</span><span class="p">(</span><span class="s">&quot;-&gt;dt_header_start=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
	<span class="n">reloc_got2</span><span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_EARLY_DEBUG_OPAL</span>
	<span class="cm">/* OPAL early debug gets the OPAL base &amp; entry in r8 and r9 */</span>
	<span class="n">__start</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">kbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_base</span><span class="p">),</span> <span class="n">RELOC</span><span class="p">(</span><span class="n">prom_opal_entry</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">__start</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">kbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
