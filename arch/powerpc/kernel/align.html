<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › align.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>align.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* align.c - handle alignment exceptions for the Power PC.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1996 Paul Mackerras &lt;paulus@cs.anu.edu.au&gt;</span>
<span class="cm"> * Copyright (c) 1998-1999 TiVo, Inc.</span>
<span class="cm"> *   PowerPC 403GCX modifications.</span>
<span class="cm"> * Copyright (c) 1999 Grant Erickson &lt;grant@lcse.umn.edu&gt;</span>
<span class="cm"> *   PowerPC 403GCX/405GP modifications.</span>
<span class="cm"> * Copyright (c) 2001-2002 PPC64 team, IBM Corp</span>
<span class="cm"> *   64-bit and Power4 support</span>
<span class="cm"> * Copyright (c) 2005 Benjamin Herrenschmidt, IBM Corp</span>
<span class="cm"> *                    &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *   Merge ppc32 and ppc64 implementations</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version</span>
<span class="cm"> * 2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/emulated_ops.h&gt;</span>
<span class="cp">#include &lt;asm/switch_to.h&gt;</span>

<span class="k">struct</span> <span class="n">aligninfo</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define IS_XFORM(inst)	(((inst) &gt;&gt; 26) == 31)</span>
<span class="cp">#define IS_DSFORM(inst)	(((inst) &gt;&gt; 26) &gt;= 56)</span>

<span class="cp">#define INVALID	{ 0, 0 }</span>

<span class="cm">/* Bits in the flags field */</span>
<span class="cp">#define LD	0	</span><span class="cm">/* load */</span><span class="cp"></span>
<span class="cp">#define ST	1	</span><span class="cm">/* store */</span><span class="cp"></span>
<span class="cp">#define SE	2	</span><span class="cm">/* sign-extend value, or FP ld/st as word */</span><span class="cp"></span>
<span class="cp">#define F	4	</span><span class="cm">/* to/from fp regs */</span><span class="cp"></span>
<span class="cp">#define U	8	</span><span class="cm">/* update index register */</span><span class="cp"></span>
<span class="cp">#define M	0x10	</span><span class="cm">/* multiple load/store */</span><span class="cp"></span>
<span class="cp">#define SW	0x20	</span><span class="cm">/* byte swap */</span><span class="cp"></span>
<span class="cp">#define S	0x40	</span><span class="cm">/* single-precision fp or... */</span><span class="cp"></span>
<span class="cp">#define SX	0x40	</span><span class="cm">/* ... byte count in XER */</span><span class="cp"></span>
<span class="cp">#define HARD	0x80	</span><span class="cm">/* string, stwcx. */</span><span class="cp"></span>
<span class="cp">#define E4	0x40	</span><span class="cm">/* SPE endianness is word */</span><span class="cp"></span>
<span class="cp">#define E8	0x80	</span><span class="cm">/* SPE endianness is double word */</span><span class="cp"></span>
<span class="cp">#define SPLT	0x80	</span><span class="cm">/* VSX SPLAT load */</span><span class="cp"></span>

<span class="cm">/* DSISR bits reported for a DCBZ instruction: */</span>
<span class="cp">#define DCBZ	0x5f	</span><span class="cm">/* 8xx/82xx dcbz faults when cache not enabled */</span><span class="cp"></span>

<span class="cp">#define SWAP(a, b)	(t = (a), (a) = (b), (b) = t)</span>

<span class="cm">/*</span>
<span class="cm"> * The PowerPC stores certain bits of the instruction that caused the</span>
<span class="cm"> * alignment exception in the DSISR register.  This array maps those</span>
<span class="cm"> * bits to information about the operand length and what the</span>
<span class="cm"> * instruction would do.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">aligninfo</span> <span class="n">aligninfo</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 00 0 0000: lwz / lwarx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 0 0001 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 00 0 0010: stw */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 0 0011 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 00 0 0100: lhz */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 00 0 0101: lha */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 00 0 0110: sth */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">M</span> <span class="p">},</span>		<span class="cm">/* 00 0 0111: lmw */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span> <span class="p">},</span>		<span class="cm">/* 00 0 1000: lfs */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 00 0 1001: lfd */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span> <span class="p">},</span>		<span class="cm">/* 00 0 1010: stfs */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 00 0 1011: stfd */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 0 1100 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 00 0 1101: ld/ldu/lwa */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 0 1110 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 00 0 1111: std/stdu */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 0000: lwzu */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 1 0001 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 0010: stwu */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 1 0011 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 0100: lhzu */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 0101: lhau */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 0110: sthu */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">M</span> <span class="p">},</span>		<span class="cm">/* 00 1 0111: stmw */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>	<span class="cm">/* 00 1 1000: lfsu */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 1001: lfdu */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>	<span class="cm">/* 00 1 1010: stfsu */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 00 1 1011: stfdu */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 00 1 1100: lfdp */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 1 1101 */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 00 1 1110: stfdp */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 00 1 1111 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 01 0 0000: ldx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 0001 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 01 0 0010: stdx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 0011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 0100 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 01 0 0101: lwax */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 0110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 0111 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="n">HARD</span><span class="o">+</span><span class="n">SX</span> <span class="p">},</span>	<span class="cm">/* 01 0 1000: lswx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="n">HARD</span> <span class="p">},</span>	<span class="cm">/* 01 0 1001: lswi */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="n">HARD</span><span class="o">+</span><span class="n">SX</span> <span class="p">},</span>	<span class="cm">/* 01 0 1010: stswx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">M</span><span class="o">+</span><span class="n">HARD</span> <span class="p">},</span>	<span class="cm">/* 01 0 1011: stswi */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 1100 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 01 0 1101: ldu */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 0 1110 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 01 0 1111: stdu */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 01 1 0000: ldux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 0001 */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 01 1 0010: stdux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 0011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 0100 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 01 1 0101: lwaux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 0110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 0111 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1000 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1001 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1010 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1100 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1101 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 01 1 1111 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0000 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0001 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0010: stwcx. */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0100 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0101 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 0111 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SW</span> <span class="p">},</span>		<span class="cm">/* 10 0 1000: lwbrx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 1001 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">SW</span> <span class="p">},</span>		<span class="cm">/* 10 0 1010: stwbrx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 1011 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SW</span> <span class="p">},</span>		<span class="cm">/* 10 0 1100: lhbrx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 10 0 1101  lwa */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">SW</span> <span class="p">},</span>		<span class="cm">/* 10 0 1110: sthbrx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 0 1111 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0000 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0001 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0010 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0100 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0101 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 0111 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1000 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1001 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1010 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1011 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1100 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1101 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 10 1 1110 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">HARD</span> <span class="p">},</span>		<span class="cm">/* 10 1 1111: dcbz */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 11 0 0000: lwzx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 0 0001 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 11 0 0010: stwx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 0 0011 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 11 0 0100: lhzx */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 11 0 0101: lhax */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 11 0 0110: sthx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 0 0111 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span> <span class="p">},</span>		<span class="cm">/* 11 0 1000: lfsx */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 0 1001: lfdx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span> <span class="p">},</span>		<span class="cm">/* 11 0 1010: stfsx */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 0 1011: stfdx */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 0 1100: lfdpx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 11 0 1101: lfiwax */</span>
	<span class="p">{</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 0 1110: stfdpx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 0 1111: stfiwx */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 0000: lwzux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 0001 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 0010: stwux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 0011 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 0100: lhzux */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 0101: lhaux */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 0110: sthux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 0111 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>	<span class="cm">/* 11 1 1000: lfsux */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 1001: lfdux */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>	<span class="cm">/* 11 1 1010: stfsux */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">U</span> <span class="p">},</span>		<span class="cm">/* 11 1 1011: stfdux */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 1100 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span> <span class="p">},</span>		<span class="cm">/* 11 1 1101: lfiwzx */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 1110 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 11 1 1111 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Create a DSISR value from the instruction</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">make_dsisr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">dsisr</span><span class="p">;</span>


	<span class="cm">/* bits  6:15 --&gt; 22:31 */</span>
	<span class="n">dsisr</span> <span class="o">=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x03ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_XFORM</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* bits 29:30 --&gt; 15:16 */</span>
		<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x00000006</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
		<span class="cm">/* bit     25 --&gt;    17 */</span>
		<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x00000040</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="cm">/* bits 21:24 --&gt; 18:21 */</span>
		<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x00000780</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* bit      5 --&gt;    17 */</span>
		<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x04000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="cm">/* bits  1: 4 --&gt; 18:21 */</span>
		<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x78000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">;</span>
		<span class="cm">/* bits 30:31 --&gt; 12:13 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DSFORM</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
			<span class="n">dsisr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&amp;</span> <span class="mh">0x00000003</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dsisr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The dcbz (data cache block zero) instruction</span>
<span class="cm"> * gives an alignment fault if used on non-cacheable</span>
<span class="cm"> * memory.  We handle the fault mainly for the</span>
<span class="cm"> * case when we are running with the cache disabled</span>
<span class="cm"> * for debugging.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_dcbz</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

<span class="cp">#ifdef __powerpc64__</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ppc64_caches</span><span class="p">.</span><span class="n">dline_size</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">L1_CACHE_BYTES</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__put_user_inatomic</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">+</span><span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate load &amp; store multiple instructions</span>
<span class="cm"> * On 64-bit machines, these instructions only affect/use the</span>
<span class="cm"> * bottom 4 bytes of each register, and the loads clear the</span>
<span class="cm"> * top 4 bytes of the affected register.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#define REG_BYTE(rp, i)		*((u8 *)((rp) + ((i) &gt;&gt; 2)) + ((i) &amp; 3) + 4)</span>
<span class="cp">#else</span>
<span class="cp">#define REG_BYTE(rp, i)		*((u8 *)(rp) + (i))</span>
<span class="cp">#endif</span>

<span class="cp">#define SWIZ_PTR(p)		((unsigned char __user *)((p) ^ swiz))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nb0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bswiz</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do not try to emulate 8 bytes multiple as they aren&#39;t really</span>
<span class="cm">	 * available in our operating environments and we don&#39;t try to</span>
<span class="cm">	 * emulate multiples operations in kernel land as they should never</span>
<span class="cm">	 * be used/generated there at least not on unaligned boundaries</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">nb</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* lmw, stmw, lswi/x, stswi/x */</span>
	<span class="n">nb0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">^</span> <span class="p">(</span><span class="n">swiz</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">swiz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">))</span>
				<span class="n">instr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">nb</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nb0</span> <span class="o">=</span> <span class="n">nb</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">-</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* lwm, stmw */</span>
		<span class="n">nb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">reg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span> <span class="o">?</span> <span class="n">VERIFY_WRITE</span><span class="o">:</span> <span class="n">VERIFY_READ</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">nb</span><span class="o">+</span><span class="n">nb0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>	<span class="cm">/* bad address */</span>

	<span class="n">rptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">bswiz</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">)</span><span class="o">?</span> <span class="mi">3</span><span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This zeroes the top 4 bytes of the affected registers</span>
<span class="cm">		 * in 64-bit mode, and also zeroes out any remaining</span>
<span class="cm">		 * bytes of the last register for lsw*.</span>
<span class="cm">		 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="n">nb</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">nb0</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">REG_BYTE</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">i</span> <span class="o">^</span> <span class="n">bswiz</span><span class="p">),</span>
						<span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">nb</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">REG_BYTE</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span>
								 <span class="n">i</span> <span class="o">^</span> <span class="n">bswiz</span><span class="p">),</span>
							<span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">REG_BYTE</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span> <span class="n">i</span> <span class="o">^</span> <span class="n">bswiz</span><span class="p">),</span>
						<span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nb0</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">nb</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">p</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">REG_BYTE</span><span class="p">(</span><span class="n">rptr</span><span class="p">,</span>
								 <span class="n">i</span> <span class="o">^</span> <span class="n">bswiz</span><span class="p">),</span>
							<span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate floating-point pair loads and stores.</span>
<span class="cm"> * Only POWER6 has these instructions, and it does true little-endian,</span>
<span class="cm"> * so we don&#39;t need the address swizzling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_fp_pair</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">TS_FPR</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">TS_FPR</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* invalid form: FRS/FRT must be even */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">)</span>
		<span class="n">sw</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">ptr0</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">ptr1</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ptr0</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ptr1</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* exception handled and fixed up */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SPE</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aligninfo</span> <span class="n">spe_aligninfo</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">E8</span> <span class="p">},</span>		<span class="cm">/* 0 00 00: evldd[x] */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">E4</span> <span class="p">},</span>		<span class="cm">/* 0 00 01: evldw[x] */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 00 10: evldh[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 0 00 11 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 01 00: evlhhesplat[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 0 01 01 */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 01 10: evlhhousplat[x] */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 0 01 11: evlhhossplat[x] */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 10 00: evlwhe[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 0 10 01 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 10 10: evlwhou[x] */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span> <span class="p">},</span>		<span class="cm">/* 0 10 11: evlwhos[x] */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span><span class="o">+</span><span class="n">E4</span> <span class="p">},</span>		<span class="cm">/* 0 11 00: evlwwsplat[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 0 11 01 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">LD</span> <span class="p">},</span>		<span class="cm">/* 0 11 10: evlwhsplat[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 0 11 11 */</span>

	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">E8</span> <span class="p">},</span>		<span class="cm">/* 1 00 00: evstdd[x] */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">E4</span> <span class="p">},</span>		<span class="cm">/* 1 00 01: evstdw[x] */</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 1 00 10: evstdh[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 00 11 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 01 00 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 01 01 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 01 10 */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 01 11 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 1 10 00: evstwhe[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 10 01 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span> <span class="p">},</span>		<span class="cm">/* 1 10 10: evstwho[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 10 11 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">E4</span> <span class="p">},</span>		<span class="cm">/* 1 11 00: evstwwe[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 11 01 */</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ST</span><span class="o">+</span><span class="n">E4</span> <span class="p">},</span>		<span class="cm">/* 1 11 10: evstwwo[x] */</span>
	<span class="n">INVALID</span><span class="p">,</span>		<span class="cm">/* 1 11 11 */</span>
<span class="p">};</span>

<span class="cp">#define	EVLDD		0x00</span>
<span class="cp">#define	EVLDW		0x01</span>
<span class="cp">#define	EVLDH		0x02</span>
<span class="cp">#define	EVLHHESPLAT	0x04</span>
<span class="cp">#define	EVLHHOUSPLAT	0x06</span>
<span class="cp">#define	EVLHHOSSPLAT	0x07</span>
<span class="cp">#define	EVLWHE		0x08</span>
<span class="cp">#define	EVLWHOU		0x0A</span>
<span class="cp">#define	EVLWHOS		0x0B</span>
<span class="cp">#define	EVLWWSPLAT	0x0C</span>
<span class="cp">#define	EVLWHSPLAT	0x0E</span>
<span class="cp">#define	EVSTDD		0x10</span>
<span class="cp">#define	EVSTDW		0x11</span>
<span class="cp">#define	EVSTDH		0x12</span>
<span class="cp">#define	EVSTWHE		0x18</span>
<span class="cp">#define	EVSTWHO		0x1A</span>
<span class="cp">#define	EVSTWWE		0x1C</span>
<span class="cp">#define	EVSTWWO		0x1E</span>

<span class="cm">/*</span>
<span class="cm"> * Emulate SPE loads and stores.</span>
<span class="cm"> * Only Book-E has these instructions, and it does true little-endian,</span>
<span class="cm"> * so we don&#39;t need the address swizzling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_spe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ll</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">u16</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">data</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">evr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">evr</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">instr</span> <span class="o">=</span> <span class="p">(</span><span class="n">instr</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="cm">/* DAR has the operand effective address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">;</span>

	<span class="n">nb</span> <span class="o">=</span> <span class="n">spe_aligninfo</span><span class="p">[</span><span class="n">instr</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">spe_aligninfo</span><span class="p">[</span><span class="n">instr</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Verify the address of the operand */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">access_ok</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span> <span class="o">?</span> <span class="n">VERIFY_WRITE</span> <span class="o">:</span> <span class="n">VERIFY_READ</span><span class="p">),</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">nb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* userland only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flush_spe_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

	<span class="cm">/* If we are loading, get the data from user space, else</span>
<span class="cm">	 * get it from register values</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVSTDD</span>:
		<span class="k">case</span> <span class="n">EVSTDW</span>:
		<span class="k">case</span> <span class="n">EVSTDH</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">evr</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVSTWHE</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">evr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVSTWHO</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">evr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVSTWWE</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">evr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVSTWWO</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">temp</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVLDD</span>:
		<span class="k">case</span> <span class="n">EVLDW</span>:
		<span class="k">case</span> <span class="n">EVLDH</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">ll</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLHHESPLAT</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLHHOUSPLAT</span>:
		<span class="k">case</span> <span class="n">EVLHHOSSPLAT</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLWHE</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLWHOU</span>:
		<span class="k">case</span> <span class="n">EVLWHOS</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLWWSPLAT</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EVLWHSPLAT</span>:
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">E8</span>:
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E4</span>:

			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Its half word endian */</span>
		<span class="nl">default:</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">data</span><span class="p">.</span><span class="n">h</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Store result to memory or update registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">p</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">evr</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SPE */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_VSX</span>
<span class="cm">/*</span>
<span class="cm"> * Emulate VSX instructions...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_vsx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">areg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">elsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">flush_vsx_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">TS_FPR</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vr</span><span class="p">[</span><span class="n">reg</span> <span class="o">-</span> <span class="mi">32</span><span class="p">];</span>

	<span class="n">lptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">)</span>
		<span class="n">sw</span> <span class="o">=</span> <span class="n">elsize</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">elsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elsize</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="o">^</span><span class="n">sw</span><span class="p">],</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ptr</span>  <span class="o">+=</span> <span class="n">elsize</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">elsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">U</span><span class="p">)</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">areg</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">;</span>

		<span class="cm">/* Splat load copies the same data to top and bottom 8 bytes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SPLT</span><span class="p">)</span>
			<span class="n">lptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="cm">/* For 8 byte loads, zero the top 8 bytes */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">==</span> <span class="n">length</span><span class="p">))</span>
			<span class="n">lptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Called on alignment exception. Attempts to fixup</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 on success</span>
<span class="cm"> * Return 0 if unable to handle the interrupt</span>
<span class="cm"> * Return -EFAULT if data address is bad</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">fix_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">instruction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">areg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dsisr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">,</span> <span class="n">swiz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">ll</span><span class="p">;</span>
		<span class="kt">double</span> <span class="n">dd</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">v</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">hi32</span><span class="p">;</span>
			<span class="kt">int</span>	 <span class="n">low32</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">x32</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hi48</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="kt">short</span>	      <span class="n">low16</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">x16</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We require a complete register set, if not, then our assembly</span>
<span class="cm">	 * is broken</span>
<span class="cm">	 */</span>
	<span class="n">CHECK_FULL_REGS</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">dsisr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dsisr</span><span class="p">;</span>

	<span class="cm">/* Some processors don&#39;t provide us with a DSISR we can use here,</span>
<span class="cm">	 * let&#39;s make one up from the instruction</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_NODSISRALIGN</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PPC_LE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LE</span><span class="p">))</span>
			<span class="n">pc</span> <span class="o">^=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_REAL_LE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LE</span><span class="p">))</span>
			<span class="n">instr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
		<span class="n">dsisr</span> <span class="o">=</span> <span class="n">make_dsisr</span><span class="p">(</span><span class="n">instr</span><span class="p">);</span>
		<span class="n">instruction</span> <span class="o">=</span> <span class="n">instr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* extract the operation and registers from the dsisr */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsisr</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>	<span class="cm">/* source/dest register */</span>
	<span class="n">areg</span> <span class="o">=</span> <span class="n">dsisr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>		<span class="cm">/* register to update */</span>

<span class="cp">#ifdef CONFIG_SPE</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instr</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">spe</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_spe</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">instr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">instr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsisr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">instr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dsisr</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">;</span>

	<span class="cm">/* Lookup the operation in our table */</span>
	<span class="n">nb</span> <span class="o">=</span> <span class="n">aligninfo</span><span class="p">[</span><span class="n">instr</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">aligninfo</span><span class="p">[</span><span class="n">instr</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Byteswap little endian loads and stores */</span>
	<span class="n">swiz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">^=</span> <span class="n">SW</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * So-called &quot;PowerPC little endian&quot; mode works by</span>
<span class="cm">		 * swizzling addresses rather than by actually doing</span>
<span class="cm">		 * any byte-swapping.  To emulate this, we XOR each</span>
<span class="cm">		 * byte address with 7.  We also byte-swap, because</span>
<span class="cm">		 * the processor&#39;s address swizzling depends on the</span>
<span class="cm">		 * operand size (it xors the address with 7 for bytes,</span>
<span class="cm">		 * 6 for halfwords, 4 for words, 0 for doublewords) but</span>
<span class="cm">		 * we will xor with 7 and load/store each byte separately.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_PPC_LE</span><span class="p">))</span>
			<span class="n">swiz</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DAR has the operand effective address */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0xfc00003e</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x7c000018</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">elsize</span><span class="p">;</span>

		<span class="cm">/* Additional register addressing bit (64 VSX vs 32 FPR/GPR) */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="cm">/* Simple inline decoder instead of a table */</span>
		<span class="cm">/* VSX has only 8 and 16 byte memory accesses */</span>
		<span class="n">nb</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/* Vector stores in little-endian mode swap individual</span>
<span class="cm">		   elements, so process them separately */</span>
		<span class="n">elsize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">elsize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LE</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">ST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x040</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">U</span><span class="p">;</span>
		<span class="cm">/* splat load needs a special decoder */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">instruction</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">SPLT</span><span class="p">;</span>
			<span class="n">nb</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">vsx</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_vsx</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">areg</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">elsize</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* A size of 0 indicates an instruction we don&#39;t support, with</span>
<span class="cm">	 * the exception of DCBZ which is handled as a special case here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instr</span> <span class="o">==</span> <span class="n">DCBZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">dcbz</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_dcbz</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Load/Store Multiple instructions are handled in their own</span>
<span class="cm">	 * function</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">multiple</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_multiple</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span>
					<span class="n">flags</span><span class="p">,</span> <span class="n">instr</span><span class="p">,</span> <span class="n">swiz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Verify the address of the operand */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">access_ok</span><span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span> <span class="o">?</span> <span class="n">VERIFY_WRITE</span> <span class="o">:</span> <span class="n">VERIFY_READ</span><span class="p">),</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">nb</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Force the fprs into the save area so we can reference them */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* userland only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flush_fp_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Special case for 16-byte FP loads and stores */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">fp_pair</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_fp_pair</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PPC_WARN_ALIGNMENT</span><span class="p">(</span><span class="n">unaligned</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="cm">/* If we are loading, get the data from user space, else</span>
<span class="cm">	 * get it from register values</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__get_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">.</span><span class="n">dd</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">TS_FPR</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Single-precision FP store requires conversion... */</span>
<span class="cp">#ifdef CONFIG_PPC_FPU</span>
			<span class="n">preempt_disable</span><span class="p">();</span>
			<span class="n">enable_kernel_fp</span><span class="p">();</span>
			<span class="n">cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">dd</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">preempt_enable</span><span class="p">();</span>
<span class="cp">#else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">SWAP</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Perform other misc operations like sign extension</span>
<span class="cm">	 * or floating point single precision conversion</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">U</span><span class="o">|</span><span class="n">SW</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">LD</span><span class="o">+</span><span class="n">SE</span>:	<span class="cm">/* sign extending integer loads */</span>
	<span class="k">case</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">SE</span>:	<span class="cm">/* sign extend for lfiwax */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">nb</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
			<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">x16</span><span class="p">.</span><span class="n">low16</span><span class="p">;</span>
		<span class="k">else</span>	<span class="cm">/* nb must be 4 */</span>
			<span class="n">data</span><span class="p">.</span><span class="n">ll</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">x32</span><span class="p">.</span><span class="n">low32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Single-precision FP load requires conversion... */</span>
	<span class="k">case</span> <span class="n">LD</span><span class="o">+</span><span class="n">F</span><span class="o">+</span><span class="n">S</span>:
<span class="cp">#ifdef CONFIG_PPC_FPU</span>
		<span class="n">preempt_disable</span><span class="p">();</span>
		<span class="n">enable_kernel_fp</span><span class="p">();</span>
		<span class="n">cvt_fd</span><span class="p">((</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">dd</span><span class="p">);</span>
		<span class="n">preempt_enable</span><span class="p">();</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Store result to memory or update registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">__put_user_inatomic</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">v</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">SWIZ_PTR</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">F</span><span class="p">)</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">TS_FPR</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">dd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">ll</span><span class="p">;</span>

	<span class="cm">/* Update RA as needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">U</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">areg</span><span class="p">]</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
