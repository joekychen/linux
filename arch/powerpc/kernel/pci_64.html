<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › pci_64.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>pci_64.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Port for PPC64 David Engebretsen, IBM Corp.</span>
<span class="cm"> * Contains common pci routines for ppc64 platform, pSeries and iSeries brands.</span>
<span class="cm"> * </span>
<span class="cm"> * Copyright (C) 2003 Anton Blanchard &lt;anton@au.ibm.com&gt;, IBM</span>
<span class="cm"> *   Rework, based on alpha PCI code.</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/ppc-pci.h&gt;</span>

<span class="cm">/* pci_io_base -- the base address from which io bars are offsets.</span>
<span class="cm"> * This is the lowest I/O base address (so bar values are always positive),</span>
<span class="cm"> * and it *must* be the start of ISA space if an ISA bus exists because</span>
<span class="cm"> * ISA drivers use hard coded offsets.  If no ISA bus exists nothing</span>
<span class="cm"> * is mapped on the first 64K of IO space</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pci_io_base</span> <span class="o">=</span> <span class="n">ISA_IO_BASE</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pci_io_base</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pcibios_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Probing PCI hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* For now, override phys_mem_access_prot. If we need it,g</span>
<span class="cm">	 * later, we may move that initialization to each ppc_md</span>
<span class="cm">	 */</span>
	<span class="n">ppc_md</span><span class="p">.</span><span class="n">phys_mem_access_prot</span> <span class="o">=</span> <span class="n">pci_phys_mem_access_prot</span><span class="p">;</span>

	<span class="cm">/* On ppc64, we always enable PCI domains and we keep domain 0</span>
<span class="cm">	 * backward compatible in /proc for video cards</span>
<span class="cm">	 */</span>
	<span class="n">pci_add_flags</span><span class="p">(</span><span class="n">PCI_ENABLE_PROC_DOMAINS</span> <span class="o">|</span> <span class="n">PCI_COMPAT_DOMAIN_0</span><span class="p">);</span>

	<span class="cm">/* Scan all of the recorded PCI controllers.  */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hose_list</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcibios_scan_phb</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
		<span class="n">pci_bus_add_devices</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Call common code to handle resource allocation */</span>
	<span class="n">pcibios_resource_survey</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;PCI: Probing PCI hardware done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">pcibios_init</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>

<span class="kt">int</span> <span class="nf">pcibios_unmap_io_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* If this is not a PHB, we only flush the hash table over</span>
<span class="cm">	 * the area mapped by this bridge. We don&#39;t play with the PTE</span>
<span class="cm">	 * mappings since we might have to deal with sub-page alignemnts</span>
<span class="cm">	 * so flushing the hash table is the only sane way to make sure</span>
<span class="cm">	 * that no hash entries are covering that removed bridge area</span>
<span class="cm">	 * while still allowing other busses overlapping those pages</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: If we ever support P2P hotplug on Book3E, we&#39;ll have</span>
<span class="cm">	 * to do an appropriate TLB flush here too</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_STD_MMU_64</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="cp">#endif</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IO unmapping for PCI-PCI bridge %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_PPC_STD_MMU_64</span>
		<span class="n">__flush_hash_table_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_mm</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">_IO_BASE</span><span class="p">,</span>
					 <span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="n">_IO_BASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the host bridge */</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

	<span class="cm">/* Check if we have IOs allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IO unmapping for PHB %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  alloc=0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span><span class="p">);</span>

	<span class="cm">/* This is a PHB, we fully unmap the IO area */</span>
	<span class="n">vunmap</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pcibios_unmap_io_space</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_HOTPLUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcibios_map_phb_io_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size_page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_virt_offset</span><span class="p">;</span>

	<span class="n">phys_page</span> <span class="o">=</span> <span class="n">_ALIGN_DOWN</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">size_page</span> <span class="o">=</span> <span class="n">_ALIGN_UP</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* Make sure IO area address is clear */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* If there&#39;s no IO to map on that bus, get away too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Let&#39;s allocate some IO space for that guy. We don&#39;t pass</span>
<span class="cm">	 * VM_IOREMAP because we don&#39;t care about alignment tricks that</span>
<span class="cm">	 * the core does in that case. Maybe we should due to stupid card</span>
<span class="cm">	 * with incomplete address decoding but I&#39;d rather not deal with</span>
<span class="cm">	 * those outside of the reserved 64K legacy region.</span>
<span class="cm">	 */</span>
	<span class="n">area</span> <span class="o">=</span> <span class="n">__get_vm_area</span><span class="p">(</span><span class="n">size_page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PHB_IO_BASE</span><span class="p">,</span> <span class="n">PHB_IO_END</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span> <span class="o">=</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_virt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span>
					      <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span> <span class="o">-</span> <span class="n">phys_page</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IO mapping for PHB %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  phys=0x%016llx, virt=0x%p (alloc=0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_virt</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_alloc</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  size=0x%016llx (alloc=0x%016lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_io_size</span><span class="p">,</span> <span class="n">size_page</span><span class="p">);</span>

	<span class="cm">/* Establish the mapping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__ioremap_at</span><span class="p">(</span><span class="n">phys_page</span><span class="p">,</span> <span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">size_page</span><span class="p">,</span>
			 <span class="n">_PAGE_NO_CACHE</span> <span class="o">|</span> <span class="n">_PAGE_GUARDED</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Fixup hose IO resource */</span>
	<span class="n">io_virt_offset</span> <span class="o">=</span> <span class="n">pcibios_io_space_offset</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">.</span><span class="n">start</span> <span class="o">+=</span> <span class="n">io_virt_offset</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">+=</span> <span class="n">io_virt_offset</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  hose-&gt;io_resource=%pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcibios_map_io_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* If this not a PHB, nothing to do, page tables still exist and</span>
<span class="cm">	 * thus HPTEs will be faulted in when needed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IO mapping for PCI-PCI bridge %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pci_name</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span><span class="p">));</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  virt=0x%016llx...0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">_IO_BASE</span><span class="p">,</span>
			 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+</span> <span class="n">_IO_BASE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pcibios_map_phb_io_space</span><span class="p">(</span><span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pcibios_map_io_space</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">pcibios_setup_phb_io_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcibios_map_phb_io_space</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IOBASE_BRIDGE_NUMBER	0</span>
<span class="cp">#define IOBASE_MEMORY		1</span>
<span class="cp">#define IOBASE_IO		2</span>
<span class="cp">#define IOBASE_ISA_IO		3</span>
<span class="cp">#define IOBASE_ISA_MEM		4</span>

<span class="kt">long</span> <span class="nf">sys_pciconfig_iobase</span><span class="p">(</span><span class="kt">long</span> <span class="n">which</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_bus</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">in_devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span><span class="o">*</span> <span class="n">hose</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">hose_node</span><span class="p">;</span>

	<span class="cm">/* Argh ! Please forgive me for that hack, but that&#39;s the</span>
<span class="cm">	 * simplest way to get existing XFree to not lockup on some</span>
<span class="cm">	 * G5 machines... So when something asks for bus 0 io base</span>
<span class="cm">	 * (bus 0 is HT root), we return the AGP one instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_bus</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;MacRISC4&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">agp</span><span class="p">;</span>

		<span class="n">agp</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;u3-agp&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agp</span><span class="p">)</span>
			<span class="n">in_bus</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">agp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* That syscall isn&#39;t quite compatible with PCI domains, but it&#39;s</span>
<span class="cm">	 * used on pre-domains setup. We return the first match</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ln</span> <span class="o">=</span> <span class="n">pci_root_buses</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">ln</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pci_root_buses</span><span class="p">;</span> <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="n">pci_bus_b</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_bus</span> <span class="o">&gt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;&amp;</span> <span class="n">in_bus</span> <span class="o">&lt;=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">subordinate</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hose_node</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="n">PCI_DN</span><span class="p">(</span><span class="n">hose_node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phb</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IOBASE_BRIDGE_NUMBER</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOBASE_MEMORY</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOBASE_IO</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOBASE_ISA_IO</span>:
		<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">isa_io_base</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IOBASE_ISA_MEM</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="kt">int</span> <span class="nf">pcibus_to_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">phb</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">phb</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pcibus_to_node</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
