<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › setup_32.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup_32.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Common prep/pmac/chrp boot and setup code.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/memblock.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/elf.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/bootx.h&gt;</span>
<span class="cp">#include &lt;asm/btext.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/nvram.h&gt;</span>
<span class="cp">#include &lt;asm/xmon.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/serial.h&gt;</span>
<span class="cp">#include &lt;asm/udbg.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>

<span class="cp">#include &quot;setup.h&quot;</span>

<span class="cp">#define DBG(fmt...)</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">bootx_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r4</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">boot_cpuid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">boot_cpuid</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">boot_cpuid_phys</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">boot_cpuid_phys</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">smp_hw_index</span><span class="p">[</span><span class="n">NR_CPUS</span><span class="p">];</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ISA_DMA_THRESHOLD</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DMA_MODE_READ</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DMA_MODE_WRITE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VGA_CONSOLE</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vgacon_remap_base</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vgacon_remap_base</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * These are used in binfmt_elf.c to put aux entries on the stack</span>
<span class="cm"> * for each elf executable being started.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">dcache_bsize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">icache_bsize</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ucache_bsize</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We&#39;re called here very early in the boot.  We determine the machine</span>
<span class="cm"> * type and call the appropriate low-level setup functions.</span>
<span class="cm"> *  -- Cort &lt;cort@fsmlabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the kernel may be running at an address which is different</span>
<span class="cm"> * from the address that it was linked at, so we must use RELOC/PTRRELOC</span>
<span class="cm"> * to access static data (including strings).  -- paulus</span>
<span class="cm"> */</span>
<span class="n">notrace</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">early_init</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dt_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">reloc_offset</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">cpu_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>

	<span class="cm">/* First zero the BSS -- use memset_io, some platforms don&#39;t have</span>
<span class="cm">	 * caches on yet */</span>
	<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__bss_start</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">__bss_stop</span> <span class="o">-</span> <span class="n">__bss_start</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify the CPU type and fix up code sections</span>
<span class="cm">	 * that depend on which cpu we have.</span>
<span class="cm">	 */</span>
	<span class="n">spec</span> <span class="o">=</span> <span class="n">identify_cpu</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_PVR</span><span class="p">));</span>

	<span class="n">do_feature_fixups</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cpu_features</span><span class="p">,</span>
			  <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__start___ftr_fixup</span><span class="p">),</span>
			  <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__stop___ftr_fixup</span><span class="p">));</span>

	<span class="n">do_feature_fixups</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">mmu_features</span><span class="p">,</span>
			  <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__start___mmu_ftr_fixup</span><span class="p">),</span>
			  <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__stop___mmu_ftr_fixup</span><span class="p">));</span>

	<span class="n">do_lwsync_fixups</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">cpu_features</span><span class="p">,</span>
			 <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__start___lwsync_fixup</span><span class="p">),</span>
			 <span class="n">PTRRELOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__stop___lwsync_fixup</span><span class="p">));</span>

	<span class="n">do_final_fixups</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">KERNELBASE</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Find out what kind of machine we&#39;re on and save any data we need</span>
<span class="cm"> * from the early boot process (devtree is copied on pmac by prom_init()).</span>
<span class="cm"> * This is called very early on the boot process, after a minimal</span>
<span class="cm"> * MMU environment has been set up but before MMU_init is called.</span>
<span class="cm"> */</span>
<span class="n">notrace</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">machine_init</span><span class="p">(</span><span class="n">u64</span> <span class="n">dt_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_init</span><span class="p">();</span>

	<span class="cm">/* Enable early debugging if any specified (see udbg.h) */</span>
	<span class="n">udbg_early_init</span><span class="p">();</span>

	<span class="cm">/* Do some early initialization based on the flat device tree */</span>
	<span class="n">early_init_devtree</span><span class="p">(</span><span class="n">__va</span><span class="p">(</span><span class="n">dt_ptr</span><span class="p">));</span>

	<span class="n">early_init_mmu</span><span class="p">();</span>

	<span class="n">probe_machine</span><span class="p">();</span>

	<span class="n">setup_kdump_trampoline</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_6xx</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_CAN_DOZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_CAN_NAP</span><span class="p">))</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">power_save</span> <span class="o">=</span> <span class="n">ppc6xx_idle</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_E500</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_CAN_DOZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_CAN_NAP</span><span class="p">))</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">power_save</span> <span class="o">=</span> <span class="n">e500_idle</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;id mach(): done&quot;</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BOOKE_WDT</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">booke_wdt_enabled</span><span class="p">;</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">booke_wdt_period</span><span class="p">;</span>

<span class="cm">/* Checks wdt=x and wdt_period=xx command-line option */</span>
<span class="n">notrace</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_wdt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	       <span class="n">booke_wdt_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;wdt&quot;</span><span class="p">,</span> <span class="n">early_parse_wdt</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">early_parse_wdt_period</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">booke_wdt_period</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">early_param</span><span class="p">(</span><span class="s">&quot;wdt_period&quot;</span><span class="p">,</span> <span class="n">early_parse_wdt_period</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_BOOKE_WDT */</span><span class="cp"></span>

<span class="cm">/* Checks &quot;l2cr=xxxx&quot; command-line option */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc_setup_l2cr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_L2CR</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;l2cr set to %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">_set_L2CR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>		<span class="cm">/* force invalidate by disable cache */</span>
		<span class="n">_set_L2CR</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>		<span class="cm">/* and enable it */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;l2cr=&quot;</span><span class="p">,</span> <span class="n">ppc_setup_l2cr</span><span class="p">);</span>

<span class="cm">/* Checks &quot;l3cr=xxxx&quot; command-line option */</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc_setup_l3cr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_L3CR</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;l3cr set to %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">_set_L3CR</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>		<span class="cm">/* and enable it */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;l3cr=&quot;</span><span class="p">,</span> <span class="n">ppc_setup_l3cr</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_GENERIC_NVRAM</span>

<span class="cm">/* Generic nvram hooks used by drivers/char/gen_nvram.c */</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">nvram_read_byte</span><span class="p">(</span><span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_read_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_read_val</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvram_read_byte</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nvram_write_byte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_write_val</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_write_val</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvram_write_byte</span><span class="p">);</span>

<span class="kt">ssize_t</span> <span class="nf">nvram_get_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_size</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvram_get_size</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">nvram_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_sync</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">nvram_sync</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">nvram_sync</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_NVRAM */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear the progress line */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;             &quot;</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* call platform init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">init</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">ppc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">irqstack_early_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* interrupt stacks must be in lowmem, we get that for free on ppc32</span>
<span class="cm">	 * as the memblock is limited to lowmem by default */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">softirq_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__va</span><span class="p">(</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="p">,</span> <span class="n">THREAD_SIZE</span><span class="p">));</span>
		<span class="n">hardirq_ctx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__va</span><span class="p">(</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="p">,</span> <span class="n">THREAD_SIZE</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_BOOKE) || defined(CONFIG_40x)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">exc_lvl_early_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">hw_cpu</span><span class="p">;</span>

	<span class="cm">/* interrupt stacks must be in lowmem, we get that for free on ppc32</span>
<span class="cm">	 * as the memblock is limited to lowmem by MEMBLOCK_REAL_LIMIT */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_cpu</span> <span class="o">=</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">critirq_ctx</span><span class="p">[</span><span class="n">hw_cpu</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__va</span><span class="p">(</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="p">,</span> <span class="n">THREAD_SIZE</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_BOOKE</span>
		<span class="n">dbgirq_ctx</span><span class="p">[</span><span class="n">hw_cpu</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__va</span><span class="p">(</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="p">,</span> <span class="n">THREAD_SIZE</span><span class="p">));</span>
		<span class="n">mcheckirq_ctx</span><span class="p">[</span><span class="n">hw_cpu</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thread_info</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">__va</span><span class="p">(</span><span class="n">memblock_alloc</span><span class="p">(</span><span class="n">THREAD_SIZE</span><span class="p">,</span> <span class="n">THREAD_SIZE</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define exc_lvl_early_init()</span>
<span class="cp">#endif</span>

<span class="cm">/* Warning, IO base is not yet inited */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">setup_arch</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">cmdline_p</span> <span class="o">=</span> <span class="n">cmd_line</span><span class="p">;</span>

	<span class="cm">/* so udelay does something sensible, assume &lt;= 1000 bogomips */</span>
	<span class="n">loops_per_jiffy</span> <span class="o">=</span> <span class="mi">500000000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">unflatten_device_tree</span><span class="p">();</span>
	<span class="n">check_for_initrd</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">init_early</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">init_early</span><span class="p">();</span>

	<span class="n">find_legacy_serial_ports</span><span class="p">();</span>

	<span class="n">smp_setup_cpu_maps</span><span class="p">();</span>

	<span class="cm">/* Register early console */</span>
	<span class="n">register_early_udbg_console</span><span class="p">();</span>

	<span class="n">xmon_setup</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set cache line size based on type of cpu as a default.</span>
<span class="cm">	 * Systems with OF can look in the properties on the cpu node(s)</span>
<span class="cm">	 * for a possibly more accurate value.</span>
<span class="cm">	 */</span>
	<span class="n">dcache_bsize</span> <span class="o">=</span> <span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">dcache_bsize</span><span class="p">;</span>
	<span class="n">icache_bsize</span> <span class="o">=</span> <span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">icache_bsize</span><span class="p">;</span>
	<span class="n">ucache_bsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_UNIFIED_ID_CACHE</span><span class="p">))</span>
		<span class="n">ucache_bsize</span> <span class="o">=</span> <span class="n">icache_bsize</span> <span class="o">=</span> <span class="n">dcache_bsize</span><span class="p">;</span>

	<span class="cm">/* reboot on panic */</span>
	<span class="n">panic_timeout</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">panic</span><span class="p">)</span>
		<span class="n">setup_panic</span><span class="p">();</span>

	<span class="n">init_mm</span><span class="p">.</span><span class="n">start_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">_stext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_code</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_etext</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">end_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_edata</span><span class="p">;</span>
	<span class="n">init_mm</span><span class="p">.</span><span class="n">brk</span> <span class="o">=</span> <span class="n">klimit</span><span class="p">;</span>

	<span class="n">exc_lvl_early_init</span><span class="p">();</span>

	<span class="n">irqstack_early_init</span><span class="p">();</span>

	<span class="cm">/* set up the bootmem stuff with available memory */</span>
	<span class="n">do_init_bootmem</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span> <span class="p">)</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;setup_arch: bootmem&quot;</span><span class="p">,</span> <span class="mh">0x3eab</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_DUMMY_CONSOLE</span>
	<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_con</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">setup_arch</span><span class="p">)</span>
		<span class="n">ppc_md</span><span class="p">.</span><span class="n">setup_arch</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span> <span class="p">)</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">progress</span><span class="p">(</span><span class="s">&quot;arch: exit&quot;</span><span class="p">,</span> <span class="mh">0x3eab</span><span class="p">);</span>

	<span class="n">paging_init</span><span class="p">();</span>

	<span class="cm">/* Initialize the MMU context management stuff */</span>
	<span class="n">mmu_context_init</span><span class="p">();</span>

<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
