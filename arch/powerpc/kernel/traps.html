<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 1995-1996  Gary Thomas (gdt@linuxppc.org)</span>
<span class="cm"> *  Copyright 2007-2010 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version</span>
<span class="cm"> *  2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  Modified by Cort Dougan (cort@cs.nmt.edu)</span>
<span class="cm"> *  and Paul Mackerras (paulus@samba.org)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file handles the architecture-dependent parts of hardware exceptions</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/prctl.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kprobes.h&gt;</span>
<span class="cp">#include &lt;linux/kexec.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/kdebug.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;asm/emulated_ops.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/rtas.h&gt;</span>
<span class="cp">#include &lt;asm/pmc.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC32</span>
<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="cp">#include &lt;asm/backlight.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="cp">#include &lt;asm/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/kexec.h&gt;</span>
<span class="cp">#include &lt;asm/ppc-opcode.h&gt;</span>
<span class="cp">#include &lt;asm/rio.h&gt;</span>
<span class="cp">#include &lt;asm/fadump.h&gt;</span>
<span class="cp">#include &lt;asm/switch_to.h&gt;</span>
<span class="cp">#include &lt;asm/debug.h&gt;</span>

<span class="cp">#if defined(CONFIG_DEBUGGER) || defined(CONFIG_KEXEC)</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_ipi</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_bpt</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_sstep</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_iabr_match</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_dabr_match</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">__debugger_fault_handler</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_ipi</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_bpt</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_sstep</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_iabr_match</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_dabr_match</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__debugger_fault_handler</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Trap &amp; Exception support</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pmac_backlight_unblank</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_backlight_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmac_backlight</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="o">*</span><span class="n">props</span><span class="p">;</span>

		<span class="n">props</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmac_backlight</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">props</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">;</span>
		<span class="n">props</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
		<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">pmac_backlight</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmac_backlight_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmac_backlight_unblank</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">arch_spinlock_t</span> <span class="n">die_lock</span> <span class="o">=</span> <span class="n">__ARCH_SPIN_LOCK_UNLOCKED</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">die_owner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">die_nest_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">die_counter</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">__kprobes</span> <span class="kt">long</span> <span class="nf">oops_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugger</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">oops_enter</span><span class="p">();</span>

	<span class="cm">/* racy, but better than risking deadlock. */</span>
	<span class="n">raw_local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">die_owner</span><span class="p">)</span>
			<span class="cm">/* nested oops. should stop eventually */</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">arch_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">die_nest_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">die_owner</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">bust_spinlocks</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="n">pmac_backlight_unblank</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__kprobes</span> <span class="nf">oops_end</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">signr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bust_spinlocks</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">die_owner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="n">die_nest_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">oops_exit</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">die_nest_count</span><span class="p">)</span>
		<span class="cm">/* Nest count reaches zero, release the lock. */</span>
		<span class="n">arch_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die_lock</span><span class="p">);</span>
	<span class="n">raw_local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">crash_fadump</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="s">&quot;die oops&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A system reset (0x100) is a request to dump, so we always send</span>
<span class="cm">	 * it through the crashdump code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kexec_should_crash</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">TRAP</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">crash_kexec</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We aren&#39;t the primary crash CPU. We need to send it</span>
<span class="cm">		 * to a holding pattern to avoid it ending up in the panic</span>
<span class="cm">		 * code.</span>
<span class="cm">		 */</span>
		<span class="n">crash_kexec_secondary</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * While our oops output is serialised by a spinlock, output</span>
<span class="cm">	 * from panic() called below can race and corrupt it. If we</span>
<span class="cm">	 * know we are going to panic, delay for 1 second so we have a</span>
<span class="cm">	 * chance to get clean backtraces from all CPUs that are oopsing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">||</span> <span class="n">panic_on_oops</span> <span class="o">||</span> <span class="o">!</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">||</span>
	    <span class="n">is_global_init</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="n">MSEC_PER_SEC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception in interrupt&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">panic_on_oops</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception&quot;</span><span class="p">);</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">signr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__kprobes</span> <span class="nf">__die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Oops: %s, sig: %ld [#%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">++</span><span class="n">die_counter</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PREEMPT</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PREEMPT &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SMP NR_CPUS=%d &quot;</span><span class="p">,</span> <span class="n">NR_CPUS</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_DEBUG_PAGEALLOC</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DEBUG_PAGEALLOC &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NUMA</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;NUMA &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">name</span> <span class="o">?</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_OOPS</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">print_modules</span><span class="p">();</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">oops_begin</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__die</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">oops_end</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">user_single_step_siginfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_TRACE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_exception</span><span class="p">(</span><span class="kt">int</span> <span class="n">signr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fmt32</span><span class="p">[]</span> <span class="o">=</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s[%d]: unhandled signal %d &quot;</span> \
			<span class="s">&quot;at %08lx nip %08lx lr %08lx code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">fmt64</span><span class="p">[]</span> <span class="o">=</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s[%d]: unhandled signal %d &quot;</span> \
			<span class="s">&quot;at %016lx nip %016lx lr %016lx code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Exception in kernel mode&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">signr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">show_unhandled_signals</span> <span class="o">&amp;&amp;</span> <span class="n">unhandled_signal</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">signr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_64BIT</span> <span class="o">?</span> <span class="n">fmt64</span> <span class="o">:</span> <span class="n">fmt32</span><span class="p">,</span>
				   <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">signr</span><span class="p">,</span>
				   <span class="n">addr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arch_irqs_disabled</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arch_irq_disabled_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">signr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">signr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="kt">void</span> <span class="nf">system_reset_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* See if any machine dependent calls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">system_reset_exception</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">system_reset_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">die</span><span class="p">(</span><span class="s">&quot;System Reset&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>

	<span class="cm">/* Must die if the interrupt is not recoverable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_RI</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unrecoverable System Reset&quot;</span><span class="p">);</span>

	<span class="cm">/* What should we do here? We could issue a shutdown or hard reset. */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * I/O accesses can cause machine checks on powermacs.</span>
<span class="cm"> * Check if the NIP corresponds to the address of a sync</span>
<span class="cm"> * instruction for which there is an entry in the exception</span>
<span class="cm"> * table.</span>
<span class="cm"> * Note that the 601 only takes a machine check on TEA</span>
<span class="cm"> * (transfer error ack) signal assertion, and does not</span>
<span class="cm"> * set any of the top 16 bits of SRR1.</span>
<span class="cm"> *  -- paulus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">check_io_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC32</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x80000</span> <span class="o">|</span> <span class="mh">0x40000</span><span class="p">)))</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check that it&#39;s a sync instruction, or somewhere</span>
<span class="cm">		 * in the twi; isync; nop sequence that inb/inw/inl uses.</span>
<span class="cm">		 * As the address is in the exception table</span>
<span class="cm">		 * we should be able to read the instr there.</span>
<span class="cm">		 * For the debug message, we look at the preceding</span>
<span class="cm">		 * load or store.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">==</span> <span class="mh">0x60000000</span><span class="p">)</span>		<span class="cm">/* nop */</span>
			<span class="n">nip</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">==</span> <span class="mh">0x4c00012c</span><span class="p">)</span>	<span class="cm">/* isync */</span>
			<span class="o">--</span><span class="n">nip</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">==</span> <span class="mh">0x7c0004ac</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* sync or twi */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">;</span>

			<span class="o">--</span><span class="n">nip</span><span class="p">;</span>
			<span class="n">rb</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s bad port %lx at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="o">*</span><span class="n">nip</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span><span class="o">?</span> <span class="s">&quot;OUT to&quot;</span><span class="o">:</span> <span class="s">&quot;IN from&quot;</span><span class="p">,</span>
			       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">-</span> <span class="n">_IO_BASE</span><span class="p">,</span> <span class="n">nip</span><span class="p">);</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_RI</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC32 */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_ADV_DEBUG_REGS</span>
<span class="cm">/* On 4xx, the reason for the machine check or program exception</span>
<span class="cm">   is in the ESR. */</span>
<span class="cp">#define get_reason(regs)	((regs)-&gt;dsisr)</span>
<span class="cp">#ifndef CONFIG_FSL_BOOKE</span>
<span class="cp">#define get_mc_reason(regs)	((regs)-&gt;dsisr)</span>
<span class="cp">#else</span>
<span class="cp">#define get_mc_reason(regs)	(mfspr(SPRN_MCSR))</span>
<span class="cp">#endif</span>
<span class="cp">#define REASON_FP		ESR_FP</span>
<span class="cp">#define REASON_ILLEGAL		(ESR_PIL | ESR_PUO)</span>
<span class="cp">#define REASON_PRIVILEGED	ESR_PPR</span>
<span class="cp">#define REASON_TRAP		ESR_PTR</span>

<span class="cm">/* single-step stuff */</span>
<span class="cp">#define single_stepping(regs)	(current-&gt;thread.dbcr0 &amp; DBCR0_IC)</span>
<span class="cp">#define clear_single_step(regs)	(current-&gt;thread.dbcr0 &amp;= ~DBCR0_IC)</span>

<span class="cp">#else</span>
<span class="cm">/* On non-4xx, the reason for the machine check or program</span>
<span class="cm">   exception is in the MSR. */</span>
<span class="cp">#define get_reason(regs)	((regs)-&gt;msr)</span>
<span class="cp">#define get_mc_reason(regs)	((regs)-&gt;msr)</span>
<span class="cp">#define REASON_FP		0x100000</span>
<span class="cp">#define REASON_ILLEGAL		0x80000</span>
<span class="cp">#define REASON_PRIVILEGED	0x40000</span>
<span class="cp">#define REASON_TRAP		0x20000</span>

<span class="cp">#define single_stepping(regs)	((regs)-&gt;msr &amp; MSR_SE)</span>
<span class="cp">#define clear_single_step(regs)	((regs)-&gt;msr &amp;= ~MSR_SE)</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_4xx)</span>
<span class="kt">int</span> <span class="nf">machine_check_4xx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">ESR_IMCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction&quot;</span><span class="p">);</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_ESR</span><span class="p">,</span> <span class="n">reason</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ESR_IMCP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine_check_440A</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">ESR_IMCP</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction Synchronous Machine Check exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_ESR</span><span class="p">,</span> <span class="n">reason</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ESR_IMCP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mcsr</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_IB</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction Read PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DRB</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data Read PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DWB</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data Write PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_TLBP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TLB Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_ICP</span><span class="p">){</span>
			<span class="n">flush_instruction_cache</span><span class="p">();</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;I-Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DCSP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;D-Cache Search Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DCFP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;D-Cache Flush Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_IMPE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine Check exception is imprecise</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Clear MCSR */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">,</span> <span class="n">mcsr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine_check_47x</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mcsr</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">ESR_IMCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;Instruction Synchronous Machine Check exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_ESR</span><span class="p">,</span> <span class="n">reason</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ESR_IMCP</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mcsr</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_IB</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Instruction Read PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DRB</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Data Read PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DWB</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Data Write PLB Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_TLBP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;TLB Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_ICP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_instruction_cache</span><span class="p">();</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;I-Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">MCSR_DCSP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;D-Cache Search Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">PPC47x_MCSR_GPR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;GPR Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">PPC47x_MCSR_FPR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;FPR Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcsr</span> <span class="o">&amp;</span> <span class="n">PPC47x_MCSR_IPR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Machine Check exception is imprecise</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clear MCSR */</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">,</span> <span class="n">mcsr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#elif defined(CONFIG_E500)</span>
<span class="kt">int</span> <span class="nf">machine_check_e500mc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mcsr</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">mcsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recoverable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_LD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="n">fsl_rio_mcheck_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recoverable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">silent_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caused by (from MCSR=%lx): &quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_MCP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine Check Signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_ICPERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is recoverable by invalidating the i-cache.</span>
<span class="cm">		 */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_L1CSR1</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_L1CSR1</span><span class="p">)</span> <span class="o">|</span> <span class="n">L1CSR1_ICFI</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_L1CSR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L1CSR1_ICFI</span><span class="p">)</span>
			<span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This will generally be accompanied by an instruction</span>
<span class="cm">		 * fetch error report -- only treat MCSR_IF as fatal</span>
<span class="cm">		 * if it wasn&#39;t due to an L1 parity error.</span>
<span class="cm">		 */</span>
		<span class="n">reason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCSR_IF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_DCPERR_MC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * In write shadow mode we auto-recover from the error, but it</span>
<span class="cm">		 * may still get logged and cause a machine check.  We should</span>
<span class="cm">		 * only treat the non-write shadow case as non-recoverable.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_L1CSR2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">L1CSR2_DCWS</span><span class="p">))</span>
			<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_L2MMU_MHIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hit on multiple TLB entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_NMI</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Non-maskable interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_IF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction Fetch Error Report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_LD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Load Error Report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Store Error Report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_LDG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Guarded Load Error Report</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_TLBSYNC</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Simultaneous tlbsync operations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BSL2_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Level 2 Cache Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">recoverable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_MAV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCAR</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCARU</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine Check %s Address: %#llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_MEA</span> <span class="o">?</span> <span class="s">&quot;Effective&quot;</span> <span class="o">:</span> <span class="s">&quot;Physical&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">silent_out:</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">,</span> <span class="n">mcsr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">recoverable</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine_check_e500</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_RBERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsl_rio_mcheck_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caused by (from MCSR=%lx): &quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_MCP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine Check Signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_ICPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_DCP_PERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data Cache Push Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_DCPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_IAERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Instruction Address Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_RAERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Address Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_WAERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Write Address Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_IBERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Instruction Data Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_RBERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Data Bus Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_WBERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Data Bus Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_IPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Instruction Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_RPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">machine_check_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#elif defined(CONFIG_E200)</span>
<span class="kt">int</span> <span class="nf">machine_check_e200</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caused by (from MCSR=%lx): &quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_MCP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine Check Signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_CP_PERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Cache Push Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_CPERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Cache Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_EXCP_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ISI, ITLB, or Bus Error on first instruction fetch for an exception handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_IRERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Bus Error on instruction fetch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_DRERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Read Bus Error on data load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MCSR_BUS_WRERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus - Write Bus Error on buffered store or cache line push</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="nf">machine_check_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_mc_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check in kernel mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Caused by (from SRR1=%lx): &quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="mh">0x601F0000</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x80000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Machine check signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* for 601 */</span>
	<span class="k">case</span> <span class="mh">0x40000</span>:
	<span class="k">case</span> <span class="mh">0x140000</span>:	<span class="cm">/* 7450 MSS error and TEA */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Transfer error ack signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data parity error signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Address parity error signal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20000000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;L1 Data Cache error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40000000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;L1 Instruction Cache error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x00100000</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;L2 data cache parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown values in msr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* everything else */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">machine_check_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">recover</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">irq_stat</span><span class="p">).</span><span class="n">mce_exceptions</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* See if any machine dependent calls. In theory, we would want</span>
<span class="cm">	 * to call the CPU first, and call the ppc_md. one if the CPU</span>
<span class="cm">	 * one returns a positive number. However there is existing code</span>
<span class="cm">	 * that assumes the board gets a first chance, so let&#39;s keep it</span>
<span class="cm">	 * that way for now and fix things later. --BenH.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc_md</span><span class="p">.</span><span class="n">machine_check_exception</span><span class="p">)</span>
		<span class="n">recover</span> <span class="o">=</span> <span class="n">ppc_md</span><span class="p">.</span><span class="n">machine_check_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">machine_check</span><span class="p">)</span>
		<span class="n">recover</span> <span class="o">=</span> <span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">machine_check</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recover</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_8xx) &amp;&amp; defined(CONFIG_PCI)</span>
	<span class="cm">/* the qspan pci read routines can cause machine checks -- Cort</span>
<span class="cm">	 *</span>
<span class="cm">	 * yuck !!! that totally needs to go away ! There are better ways</span>
<span class="cm">	 * to deal with that than having a wart in the mcheck handler.</span>
<span class="cm">	 * -- BenH</span>
<span class="cm">	 */</span>
	<span class="n">bad_page_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">,</span> <span class="n">SIGBUS</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debugger_fault_handler</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_io_access</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Machine check&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGBUS</span><span class="p">);</span>

	<span class="cm">/* Must die if the interrupt is not recoverable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_RI</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unrecoverable Machine check&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SMIException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;System Management Interrupt&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unknown_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bad trap at PC: %lx, SR: %lx, vector=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">);</span>

	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">instruction_breakpoint_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_IABR_MATCH</span><span class="p">,</span> <span class="s">&quot;iabr_match&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
					<span class="mi">5</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugger_iabr_match</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_BRKPT</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">RunModeException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__kprobes</span> <span class="nf">single_step_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_SSTEP</span><span class="p">,</span> <span class="s">&quot;single_step&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
					<span class="mi">5</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debugger_sstep</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_TRACE</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * After we have successfully emulated an instruction, we have to</span>
<span class="cm"> * check if the instruction was being single-stepped, and if so,</span>
<span class="cm"> * pretend we got a single-step exception.  This was pointed out</span>
<span class="cm"> * by Kumar Gala.  -- paulus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emulate_single_step</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_stepping</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">single_step_exception</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__parse_fpscr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fpscr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Invalid operation */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_VE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_VX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>

	<span class="cm">/* Overflow */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_OE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_OX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>

	<span class="cm">/* Underflow */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_UE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_UX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>

	<span class="cm">/* Divide by zero */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_ZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_ZX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>

	<span class="cm">/* Inexact result */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_XE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpscr</span> <span class="o">&amp;</span> <span class="n">FPSCR_XX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_fpe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flush_fp_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

	<span class="n">code</span> <span class="o">=</span> <span class="n">__parse_fpscr</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>

	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Illegal instruction emulation support.  Originally written to</span>
<span class="cm"> * provide the PVR to user applications using the mfspr rd, PVR.</span>
<span class="cm"> * Return non-zero if we can&#39;t emulate, or -EFAULT if the associated</span>
<span class="cm"> * memory access caused an access fault.  Return zero on success.</span>
<span class="cm"> *</span>
<span class="cm"> * There are a couple of ways to do this, either &quot;decode&quot; the instruction</span>
<span class="cm"> * or directly match lots of bits.  In this case, matching lots of</span>
<span class="cm"> * bits is faster and easier.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_string_inst</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">instword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rT</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rA</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">NB_RB</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">EA</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Early out if we are an invalid form of lswx */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_STRING_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_LSWX</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rT</span> <span class="o">==</span> <span class="n">rA</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rT</span> <span class="o">==</span> <span class="n">NB_RB</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">EA</span> <span class="o">=</span> <span class="p">(</span><span class="n">rA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rA</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_STRING_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PPC_INST_LSWX</span>:
		<span class="k">case</span> <span class="n">PPC_INST_STSWX</span>:
			<span class="n">EA</span> <span class="o">+=</span> <span class="n">NB_RB</span><span class="p">;</span>
			<span class="n">num_bytes</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PPC_INST_LSWI</span>:
		<span class="k">case</span> <span class="n">PPC_INST_STSWI</span>:
			<span class="n">num_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">NB_RB</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">NB_RB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">num_bytes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_STRING_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PPC_INST_LSWX</span>:
			<span class="k">case</span> <span class="n">PPC_INST_LSWI</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">EA</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="cm">/* first time updating this reg,</span>
<span class="cm">				 * zero it out */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rT</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PPC_INST_STSWI</span>:
			<span class="k">case</span> <span class="n">PPC_INST_STSWX</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rT</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">EA</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* move EA to next address */</span>
		<span class="n">EA</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">num_bytes</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* manage our position within the register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rT</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">rT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_popcntb_inst</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">instword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ra</span><span class="p">,</span><span class="n">rs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">rs</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x5555555555555555ULL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3333333333333333ULL</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3333333333333333ULL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f0f0f0f0f0f0f0fULL</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">ra</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_isel</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="n">u32</span> <span class="n">instword</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rT</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rA</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rB</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">BC</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rA</span><span class="p">];</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">BC</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rT</span><span class="p">]</span> <span class="o">=</span> <span class="n">bit</span> <span class="o">?</span> <span class="n">tmp</span> <span class="o">:</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rB</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulate_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instword</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_LE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">CHECK_FULL_REGS</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">instword</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Emulate the mfspr rD, PVR. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_MFSPR_PVR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_MFSPR_PVR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">mfpvr</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_PVR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Emulating the dcba insn is just a no-op.  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_DCBA_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_DCBA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">dcba</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Emulate the mcrxr insn.  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_MCRXR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_MCRXR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msk</span> <span class="o">=</span> <span class="mh">0xf0000000UL</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">mcrxr</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ccr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">msk</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf0000000UL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Emulate load/store string insn. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_STRING_GEN_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_STRING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_string_inst</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">instword</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Emulate the popcntb (Population Count Bytes) instruction. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_POPCNTB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_POPCNTB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">popcntb</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_popcntb_inst</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">instword</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Emulate isel (Integer Select) instruction */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_ISEL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_ISEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">isel</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">emulate_isel</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">instword</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="cm">/* Emulate the mfspr rD, DSCR. */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_MFSPR_DSCR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_MFSPR_DSCR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DSCR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">mfdscr</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DSCR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Emulate the mtspr DSCR, rD. */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">instword</span> <span class="o">&amp;</span> <span class="n">PPC_INST_MTSPR_DSCR_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PPC_INST_MTSPR_DSCR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DSCR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">mtdscr</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="p">(</span><span class="n">instword</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DSCR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">rd</span><span class="p">]);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dscr_inherit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">is_valid_bugaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_kernel_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__kprobes</span> <span class="nf">program_check_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">get_reason</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">do_mathemu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

	<span class="cm">/* We can now get here via a FP Unavailable exception if the core</span>
<span class="cm">	 * has no FPU, in that case the reason flags will be 0 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">REASON_FP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IEEE FP exception */</span>
		<span class="n">parse_fpe</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">REASON_TRAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Debugger is first in line to stop recursive faults in</span>
<span class="cm">		 * rcu_lock, notify_die, or atomic_notifier_call_chain */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugger_bpt</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* trap exception */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_BPT</span><span class="p">,</span> <span class="s">&quot;breakpoint&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span>
				<span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* not user-mode */</span>
		    <span class="n">report_bug</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUG_TRAP_TYPE_WARN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_BRKPT</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We restore the interrupt state now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_irq_disabled_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_MATH_EMULATION</span>
	<span class="cm">/* (reason &amp; REASON_ILLEGAL) would be the obvious thing here,</span>
<span class="cm">	 * but there seems to be a hardware bug on the 405GP (RevD)</span>
<span class="cm">	 * that means ESR is sometimes set incorrectly - either to</span>
<span class="cm">	 * ESR_DST (!?) or 0.  In the process of chasing this with the</span>
<span class="cm">	 * hardware people - not sure if it can happen on any illegal</span>
<span class="cm">	 * instruction or only on FP instructions, whether there is a</span>
<span class="cm">	 * pattern to occurrences etc. -dgibson 31/Mar/2003 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">do_mathemu</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">__parse_fpscr</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">_exception</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_MAPERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* fall through on any other errors */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MATH_EMULATION */</span><span class="cp"></span>

	<span class="cm">/* Try to emulate it if we should. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REASON_ILLEGAL</span> <span class="o">|</span> <span class="n">REASON_PRIVILEGED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">emulate_instruction</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
			<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_MAPERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">REASON_PRIVILEGED</span><span class="p">)</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_PRVOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">alignment_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We restore the interrupt state now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_irq_disabled_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="cm">/* we don&#39;t implement logging of alignment exceptions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">align_ctl</span> <span class="o">&amp;</span> <span class="n">PR_UNALIGN_SIGBUS</span><span class="p">))</span>
		<span class="n">fixed</span> <span class="o">=</span> <span class="n">fix_alignment</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* skip over emulated instruction */</span>
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Operand address was bad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fixed</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bad_page_fault</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">,</span> <span class="n">sig</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">StackOverflow</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;Kernel stack overflow in process %p, r1=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">debugger</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;kernel stack overflow&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nonrecoverable_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Non-recoverable exception at PC=%lx MSR=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">debugger</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;nonrecoverable exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">trace_syscall</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Task: %p(%d), PC: %08lX/%08lX, Syscall: %3ld, Result: %s%ld    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="o">&amp;</span><span class="mh">0x10000000</span><span class="o">?</span><span class="s">&quot;Error=&quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">print_tainted</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kernel_fp_unavailable_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Unrecoverable FP Unavailable Exception &quot;</span>
			  <span class="s">&quot;%lx at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unrecoverable FP Unavailable Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">altivec_unavailable_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* A user program has executed an altivec instruction,</span>
<span class="cm">		   but this kernel doesn&#39;t support altivec. */</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Unrecoverable VMX/Altivec Unavailable Exception &quot;</span>
			<span class="s">&quot;%lx at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unrecoverable VMX/Altivec Unavailable Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vsx_unavailable_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* A user program has executed an vsx instruction,</span>
<span class="cm">		   but this kernel doesn&#39;t support vsx. */</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Unrecoverable VSX Unavailable Exception &quot;</span>
			<span class="s">&quot;%lx at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unrecoverable VSX Unavailable Exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">performance_monitor_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">irq_stat</span><span class="p">).</span><span class="n">pmu_irqs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">perf_irq</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_8xx</span>
<span class="kt">void</span> <span class="nf">SoftwareEmulation</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">do_mathemu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">Soft_emulate_8xx</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#if defined(CONFIG_MATH_EMULATION) || defined(CONFIG_8XX_MINIMAL_FPEMU)</span>
	<span class="kt">int</span> <span class="n">errcode</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">CHECK_FULL_REGS</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">debugger</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Kernel Mode Software FPU Emulation&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGFPE</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MATH_EMULATION</span>
	<span class="n">errcode</span> <span class="o">=</span> <span class="n">do_mathemu</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">math</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
			<span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">__parse_fpscr</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">_exception</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_MAPERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#elif defined(CONFIG_8XX_MINIMAL_FPEMU)</span>
	<span class="n">errcode</span> <span class="o">=</span> <span class="n">Soft_emulate_8xx</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">errcode</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="mi">8</span><span class="n">xx</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">errcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_MAPERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_8xx */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PPC_ADV_DEBUG_REGS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">debug_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Determine the cause of the debug event, clear the</span>
<span class="cm">	 * event flags and send a trap to the handler. Torez</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DBSR_DAC1R</span> <span class="o">|</span> <span class="n">DBSR_DAC1W</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbcr_dac</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DBCR_DAC1R</span> <span class="o">|</span> <span class="n">DBCR_DAC1W</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PPC_ADV_DEBUG_DAC_RANGE</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR2_DAC12MODE</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DAC1</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">5</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DBSR_DAC2R</span> <span class="o">|</span> <span class="n">DBSR_DAC2W</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbcr_dac</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DBCR_DAC2R</span> <span class="o">|</span> <span class="n">DBCR_DAC2W</span><span class="p">);</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DAC2</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">6</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_IAC1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IAC1</span><span class="p">;</span>
		<span class="n">dbcr_iac_range</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR_IAC12MODE</span><span class="p">;</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IAC1</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_IAC2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IAC2</span><span class="p">;</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IAC2</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">2</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_IAC3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IAC3</span><span class="p">;</span>
		<span class="n">dbcr_iac_range</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR_IAC34MODE</span><span class="p">;</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IAC3</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">3</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_IAC4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IAC4</span><span class="p">;</span>
		<span class="n">do_send_trap</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IAC4</span><span class="p">),</span> <span class="n">debug_status</span><span class="p">,</span> <span class="n">TRAP_HWBKPT</span><span class="p">,</span>
			     <span class="mi">4</span><span class="p">);</span>
		<span class="n">changed</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * At the point this routine was called, the MSR(DE) was turned off.</span>
<span class="cm">	 * Check all other debug flags and see if that bit needs to be turned</span>
<span class="cm">	 * back on or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DBCR_ACTIVE_EVENTS</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr1</span><span class="p">))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_DE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Make sure the IDM flag is off */</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__kprobes</span> <span class="nf">DebugException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">debug_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbsr</span> <span class="o">=</span> <span class="n">debug_status</span><span class="p">;</span>

	<span class="cm">/* Hack alert: On BookE, Branch Taken stops on the branch itself, while</span>
<span class="cm">	 * on server, it stops on the target of the branch. In order to simulate</span>
<span class="cm">	 * the server behaviour, we thus restart right away with a single step</span>
<span class="cm">	 * instead of stopping here when hitting a BT</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_BT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_DE</span><span class="p">;</span>

		<span class="cm">/* Disable BT */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DBCR0_BT</span><span class="p">);</span>
		<span class="cm">/* Clear the BT event */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBSR</span><span class="p">,</span> <span class="n">DBSR_BT</span><span class="p">);</span>

		<span class="cm">/* Do the single step trick only when coming from userspace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_BT</span><span class="p">;</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">|=</span> <span class="n">DBCR0_IDM</span> <span class="o">|</span> <span class="n">DBCR0_IC</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_DE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_SSTEP</span><span class="p">,</span> <span class="s">&quot;block_step&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
			       <span class="mi">5</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debugger_sstep</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">debug_status</span> <span class="o">&amp;</span> <span class="n">DBSR_IC</span><span class="p">)</span> <span class="p">{</span> 	<span class="cm">/* Instruction complete */</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_DE</span><span class="p">;</span>

		<span class="cm">/* Disable instruction completion */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DBCR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DBCR0_IC</span><span class="p">);</span>
		<span class="cm">/* Clear the instruction completion event */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBSR</span><span class="p">,</span> <span class="n">DBSR_IC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_SSTEP</span><span class="p">,</span> <span class="s">&quot;single_step&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
			       <span class="mi">5</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debugger_sstep</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">DBCR_ACTIVE_EVENTS</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span><span class="p">,</span>
					       <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr1</span><span class="p">))</span>
				<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_DE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* Make sure the IDM bit is off */</span>
				<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbcr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DBCR0_IDM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">TRAP_TRACE</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">handle_debug</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">debug_status</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_ADV_DEBUG_REGS */</span><span class="cp"></span>

<span class="cp">#if !defined(CONFIG_TAU_INT)</span>
<span class="kt">void</span> <span class="nf">TAUException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TAU trap at PC: %lx, MSR: %lx, vector=%lx    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">print_tainted</span><span class="p">());</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_INT_TAU */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ALTIVEC</span>
<span class="kt">void</span> <span class="nf">altivec_assist_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;VMX/Altivec assist exception in kernel mode&quot;</span>
		       <span class="s">&quot; at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Kernel VMX/Altivec assist exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">flush_altivec_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

	<span class="n">PPC_WARN_EMULATED</span><span class="p">(</span><span class="n">altivec</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">emulate_altivec</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* skip emulated instruction */</span>
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* got an error reading the instruction */</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_ACCERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t recognize the instruction */</span>
		<span class="cm">/* XXX quick hack for now: set the non-Java bit in the VSCR */</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unrecognized altivec instruction &quot;</span>
				   <span class="s">&quot;in %s at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vscr</span><span class="p">.</span><span class="n">u</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ALTIVEC */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_VSX</span>
<span class="kt">void</span> <span class="nf">vsx_assist_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;VSX assist exception in kernel mode&quot;</span>
		       <span class="s">&quot; at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="n">die</span><span class="p">(</span><span class="s">&quot;Kernel VSX assist exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGILL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">flush_vsx_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;VSX assist not supported at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_ILLOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VSX */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_FSL_BOOKE</span>
<span class="kt">void</span> <span class="nf">CacheLockingException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We treat cache locking instructions from the user</span>
<span class="cm">	 * as priv ops, in the future we could try to do</span>
<span class="cm">	 * something smarter</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ESR_DLK</span><span class="o">|</span><span class="n">ESR_ILK</span><span class="p">))</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">ILL_PRVOPC</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_FSL_BOOKE */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SPE</span>
<span class="kt">void</span> <span class="nf">SPEFloatingPointException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">do_spe_mathemu</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">spefscr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpexc_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">flush_spe_to_thread</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

	<span class="n">spefscr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">spefscr</span><span class="p">;</span>
	<span class="n">fpexc_mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpexc_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">spefscr</span> <span class="o">&amp;</span> <span class="n">SPEFSCR_FOVF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpexc_mode</span> <span class="o">&amp;</span> <span class="n">PR_FP_EXC_OVF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">spefscr</span> <span class="o">&amp;</span> <span class="n">SPEFSCR_FUNF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpexc_mode</span> <span class="o">&amp;</span> <span class="n">PR_FP_EXC_UND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">spefscr</span> <span class="o">&amp;</span> <span class="n">SPEFSCR_FDBZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpexc_mode</span> <span class="o">&amp;</span> <span class="n">PR_FP_EXC_DIV</span><span class="p">))</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">spefscr</span> <span class="o">&amp;</span> <span class="n">SPEFSCR_FINV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpexc_mode</span> <span class="o">&amp;</span> <span class="n">PR_FP_EXC_INV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">spefscr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SPEFSCR_FG</span> <span class="o">|</span> <span class="n">SPEFSCR_FX</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fpexc_mode</span> <span class="o">&amp;</span> <span class="n">PR_FP_EXC_RES</span><span class="p">))</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">do_spe_mathemu</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* skip emulated instruction */</span>
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* got an error reading the instruction */</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_ACCERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t recognize the instruction */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unrecognized spe instruction &quot;</span>
		       <span class="s">&quot;in %s at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">SPEFloatingPointRoundException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">speround_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SPE</span><span class="p">)</span>
		<span class="n">giveup_spe</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">preempt_enable</span><span class="p">();</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">speround_handler</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* skip emulated instruction */</span>
		<span class="n">emulate_single_step</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* got an error reading the instruction */</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SEGV_ACCERR</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* didn&#39;t recognize the instruction */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unrecognized spe instruction &quot;</span>
		       <span class="s">&quot;in %s at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">_exception</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * We enter here if we get an unrecoverable exception, that is, one</span>
<span class="cm"> * that happened at a point where the RI (recoverable interrupt) bit</span>
<span class="cm"> * in the MSR is 0.  This indicates that SRR0/1 are live, and that</span>
<span class="cm"> * we therefore lost state by taking this exception.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">unrecoverable_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Unrecoverable exception %lx at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">trap</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Unrecoverable exception&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BOOKE_WDT</span>
<span class="cm">/*</span>
<span class="cm"> * Default handler for a Watchdog exception,</span>
<span class="cm"> * spins until a reboot occurs</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">weak</span><span class="p">))</span> <span class="n">WatchdogHandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Generic WatchdogHandler, implement your own */</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_TCR</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TCR</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">TCR_WIE</span><span class="p">));</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">WatchdogException</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;PowerPC Book-E Watchdog Exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">WatchdogHandler</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * We enter here if we discover during exception entry that we are</span>
<span class="cm"> * running in supervisor mode with a userspace value in the stack pointer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kernel_bad_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;Bad kernel stack pointer %lx at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
	<span class="n">die</span><span class="p">(</span><span class="s">&quot;Bad kernel stack pointer&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">SIGABRT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PPC_EMULATED_STATS</span>

<span class="cp">#define WARN_EMULATED_SETUP(type)	.type = { .name = #type }</span>

<span class="k">struct</span> <span class="n">ppc_emulated</span> <span class="n">ppc_emulated</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ALTIVEC</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">altivec</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">dcba</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">dcbz</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">fp_pair</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">isel</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">mcrxr</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">mfpvr</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">multiple</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">popcntb</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">spe</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">string</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">unaligned</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_MATH_EMULATION</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">math</span><span class="p">),</span>
<span class="cp">#elif defined(CONFIG_8XX_MINIMAL_FPEMU)</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="mi">8</span><span class="n">xx</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">vsx</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">mfdscr</span><span class="p">),</span>
	<span class="n">WARN_EMULATED_SETUP</span><span class="p">(</span><span class="n">mtdscr</span><span class="p">),</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">u32</span> <span class="n">ppc_warn_emulated</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">ppc_warn_emulated_print</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_warn_ratelimited</span><span class="p">(</span><span class="s">&quot;%s used emulated %s instruction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc_warn_emulated_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppc_emulated_entry</span> <span class="o">*</span><span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ppc_emulated</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">powerpc_debugfs_root</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;emulated_instructions&quot;</span><span class="p">,</span>
				 <span class="n">powerpc_debugfs_root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;do_warn&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">ppc_warn_emulated</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ppc_emulated</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">ppc_warn_emulated_init</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_EMULATED_STATS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
