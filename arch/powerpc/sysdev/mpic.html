<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › mpic.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mpic.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  arch/powerpc/kernel/mpic.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Driver for interrupt controllers following the OpenPIC standard, the</span>
<span class="cm"> *  common implementation beeing IBM&#39;s MPIC. This driver also can deal</span>
<span class="cm"> *  with various broken implementations of this HW.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004 Benjamin Herrenschmidt, IBM Corp.</span>
<span class="cm"> *  Copyright 2010-2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>
<span class="cp">#undef DEBUG_IPI</span>
<span class="cp">#undef DEBUG_IRQ</span>
<span class="cp">#undef DEBUG_LOW</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/syscore_ops.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/signal.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/mpic.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="cp">#include &quot;mpic.h&quot;</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(fmt...) printk(fmt)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(fmt...)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpics</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic_primary</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_RAW_SPINLOCK</span><span class="p">(</span><span class="n">mpic_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC32	</span><span class="cm">/* XXX for now */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_IRQ_ALL_CPUS</span>
<span class="cp">#define distribute_irqs	(1)</span>
<span class="cp">#else</span>
<span class="cp">#define distribute_irqs	(0)</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_MPIC_WEIRD</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">mpic_infos</span><span class="p">[][</span><span class="n">MPIC_IDX_END</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* Original OpenPIC compatible MPIC */</span>
		<span class="n">MPIC_GREG_BASE</span><span class="p">,</span>
		<span class="n">MPIC_GREG_FEATURE_0</span><span class="p">,</span>
		<span class="n">MPIC_GREG_GLOBAL_CONF_0</span><span class="p">,</span>
		<span class="n">MPIC_GREG_VENDOR_ID</span><span class="p">,</span>
		<span class="n">MPIC_GREG_IPI_VECTOR_PRI_0</span><span class="p">,</span>
		<span class="n">MPIC_GREG_IPI_STRIDE</span><span class="p">,</span>
		<span class="n">MPIC_GREG_SPURIOUS</span><span class="p">,</span>
		<span class="n">MPIC_GREG_TIMER_FREQ</span><span class="p">,</span>

		<span class="n">MPIC_TIMER_BASE</span><span class="p">,</span>
		<span class="n">MPIC_TIMER_STRIDE</span><span class="p">,</span>
		<span class="n">MPIC_TIMER_CURRENT_CNT</span><span class="p">,</span>
		<span class="n">MPIC_TIMER_BASE_CNT</span><span class="p">,</span>
		<span class="n">MPIC_TIMER_VECTOR_PRI</span><span class="p">,</span>
		<span class="n">MPIC_TIMER_DESTINATION</span><span class="p">,</span>

		<span class="n">MPIC_CPU_BASE</span><span class="p">,</span>
		<span class="n">MPIC_CPU_STRIDE</span><span class="p">,</span>
		<span class="n">MPIC_CPU_IPI_DISPATCH_0</span><span class="p">,</span>
		<span class="n">MPIC_CPU_IPI_DISPATCH_STRIDE</span><span class="p">,</span>
		<span class="n">MPIC_CPU_CURRENT_TASK_PRI</span><span class="p">,</span>
		<span class="n">MPIC_CPU_WHOAMI</span><span class="p">,</span>
		<span class="n">MPIC_CPU_INTACK</span><span class="p">,</span>
		<span class="n">MPIC_CPU_EOI</span><span class="p">,</span>
		<span class="n">MPIC_CPU_MCACK</span><span class="p">,</span>

		<span class="n">MPIC_IRQ_BASE</span><span class="p">,</span>
		<span class="n">MPIC_IRQ_STRIDE</span><span class="p">,</span>
		<span class="n">MPIC_IRQ_VECTOR_PRI</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_VECTOR_MASK</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_POLARITY_POSITIVE</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_POLARITY_NEGATIVE</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_SENSE_LEVEL</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_SENSE_EDGE</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_POLARITY_MASK</span><span class="p">,</span>
		<span class="n">MPIC_VECPRI_SENSE_MASK</span><span class="p">,</span>
		<span class="n">MPIC_IRQ_DESTINATION</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>	<span class="cm">/* Tsi108/109 PIC */</span>
		<span class="n">TSI108_GREG_BASE</span><span class="p">,</span>
		<span class="n">TSI108_GREG_FEATURE_0</span><span class="p">,</span>
		<span class="n">TSI108_GREG_GLOBAL_CONF_0</span><span class="p">,</span>
		<span class="n">TSI108_GREG_VENDOR_ID</span><span class="p">,</span>
		<span class="n">TSI108_GREG_IPI_VECTOR_PRI_0</span><span class="p">,</span>
		<span class="n">TSI108_GREG_IPI_STRIDE</span><span class="p">,</span>
		<span class="n">TSI108_GREG_SPURIOUS</span><span class="p">,</span>
		<span class="n">TSI108_GREG_TIMER_FREQ</span><span class="p">,</span>

		<span class="n">TSI108_TIMER_BASE</span><span class="p">,</span>
		<span class="n">TSI108_TIMER_STRIDE</span><span class="p">,</span>
		<span class="n">TSI108_TIMER_CURRENT_CNT</span><span class="p">,</span>
		<span class="n">TSI108_TIMER_BASE_CNT</span><span class="p">,</span>
		<span class="n">TSI108_TIMER_VECTOR_PRI</span><span class="p">,</span>
		<span class="n">TSI108_TIMER_DESTINATION</span><span class="p">,</span>

		<span class="n">TSI108_CPU_BASE</span><span class="p">,</span>
		<span class="n">TSI108_CPU_STRIDE</span><span class="p">,</span>
		<span class="n">TSI108_CPU_IPI_DISPATCH_0</span><span class="p">,</span>
		<span class="n">TSI108_CPU_IPI_DISPATCH_STRIDE</span><span class="p">,</span>
		<span class="n">TSI108_CPU_CURRENT_TASK_PRI</span><span class="p">,</span>
		<span class="n">TSI108_CPU_WHOAMI</span><span class="p">,</span>
		<span class="n">TSI108_CPU_INTACK</span><span class="p">,</span>
		<span class="n">TSI108_CPU_EOI</span><span class="p">,</span>
		<span class="n">TSI108_CPU_MCACK</span><span class="p">,</span>

		<span class="n">TSI108_IRQ_BASE</span><span class="p">,</span>
		<span class="n">TSI108_IRQ_STRIDE</span><span class="p">,</span>
		<span class="n">TSI108_IRQ_VECTOR_PRI</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_VECTOR_MASK</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_POLARITY_POSITIVE</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_POLARITY_NEGATIVE</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_SENSE_LEVEL</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_SENSE_EDGE</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_POLARITY_MASK</span><span class="p">,</span>
		<span class="n">TSI108_VECPRI_SENSE_MASK</span><span class="p">,</span>
		<span class="n">TSI108_IRQ_DESTINATION</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define MPIC_INFO(name) mpic-&gt;hw_set[MPIC_IDX_##name]</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_MPIC_WEIRD */</span><span class="cp"></span>

<span class="cp">#define MPIC_INFO(name) MPIC_##name</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_WEIRD */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_processor_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">))</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">cpu</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register accessor functions</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_mpic_read</span><span class="p">(</span><span class="k">enum</span> <span class="n">mpic_reg_type</span> <span class="n">type</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>
	<span class="k">case</span> <span class="n">mpic_access_dcr</span>:
		<span class="k">return</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">dhost</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">mpic_access_mmio_be</span>:
		<span class="k">return</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">mpic_access_mmio_le</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">in_le32</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_mpic_write</span><span class="p">(</span><span class="k">enum</span> <span class="n">mpic_reg_type</span> <span class="n">type</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
 			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>
	<span class="k">case</span> <span class="n">mpic_access_dcr</span>:
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">dhost</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">mpic_access_mmio_be</span>:
		<span class="n">out_be32</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">mpic_access_mmio_le</span>:
	<span class="nl">default:</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_mpic_ipi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">mpic_reg_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_VECTOR_PRI_0</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">ipi</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_STRIDE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_BROKEN_IPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">mpic_access_mmio_le</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">mpic_access_mmio_be</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">_mpic_read</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_mpic_ipi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipi</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_VECTOR_PRI_0</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">ipi</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_STRIDE</span><span class="p">));</span>

	<span class="n">_mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_mpic_tm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_VECTOR_PRI</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">tm</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_STRIDE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tm</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x1000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">_mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">tmregs</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_mpic_tm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_VECTOR_PRI</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">tm</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_STRIDE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tm</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x1000</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">_mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">tmregs</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_mpic_cpu_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">mpic_processor_id</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">cpuregs</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_mpic_cpu_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">mpic_processor_id</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>

	<span class="n">_mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">cpuregs</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">_mpic_irq_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_no</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">isu</span> <span class="o">=</span> <span class="n">src_no</span> <span class="o">&gt;&gt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">idx</span> <span class="o">=</span> <span class="n">src_no</span> <span class="o">&amp;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">_mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isus</span><span class="p">[</span><span class="n">isu</span><span class="p">],</span>
			 <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_STRIDE</span><span class="p">)));</span>
<span class="cp">#ifdef CONFIG_MPIC_BROKEN_REGREAD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPIC_VECPRI_MASK</span> <span class="o">|</span> <span class="n">MPIC_VECPRI_ACTIVITY</span><span class="p">))</span> <span class="o">|</span>
			<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_reg0_shadow</span><span class="p">[</span><span class="n">src_no</span><span class="p">];</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_mpic_irq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_no</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">isu</span> <span class="o">=</span> <span class="n">src_no</span> <span class="o">&gt;&gt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">idx</span> <span class="o">=</span> <span class="n">src_no</span> <span class="o">&amp;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_mask</span><span class="p">;</span>

	<span class="n">_mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isus</span><span class="p">[</span><span class="n">isu</span><span class="p">],</span>
		    <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_STRIDE</span><span class="p">)),</span> <span class="n">value</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MPIC_BROKEN_REGREAD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_reg0_shadow</span><span class="p">[</span><span class="n">src_no</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MPIC_VECPRI_MASK</span> <span class="o">|</span> <span class="n">MPIC_VECPRI_ACTIVITY</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#define mpic_read(b,r)		_mpic_read(mpic-&gt;reg_type,&amp;(b),(r))</span>
<span class="cp">#define mpic_write(b,r,v)	_mpic_write(mpic-&gt;reg_type,&amp;(b),(r),(v))</span>
<span class="cp">#define mpic_ipi_read(i)	_mpic_ipi_read(mpic,(i))</span>
<span class="cp">#define mpic_ipi_write(i,v)	_mpic_ipi_write(mpic,(i),(v))</span>
<span class="cp">#define mpic_tm_read(i)		_mpic_tm_read(mpic,(i))</span>
<span class="cp">#define mpic_tm_write(i,v)	_mpic_tm_write(mpic,(i),(v))</span>
<span class="cp">#define mpic_cpu_read(i)	_mpic_cpu_read(mpic,(i))</span>
<span class="cp">#define mpic_cpu_write(i,v)	_mpic_cpu_write(mpic,(i),(v))</span>
<span class="cp">#define mpic_irq_read(s,r)	_mpic_irq_read(mpic,(s),(r))</span>
<span class="cp">#define mpic_irq_write(s,r,v)	_mpic_irq_write(mpic,(s),(r),(v))</span>


<span class="cm">/*</span>
<span class="cm"> * Low level utility functions</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">_mpic_map_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">phys_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">phys_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC_DCR</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_mpic_map_dcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phys_addr_t</span> <span class="n">phys_addr</span> <span class="o">=</span> <span class="n">dcr_resource_start</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rb</span><span class="o">-&gt;</span><span class="n">dhost</span> <span class="o">=</span> <span class="n">dcr_map</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">phys_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">DCR_MAP_OK</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">dhost</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpic_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span>
			    <span class="n">phys_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpic_reg_bank</span> <span class="o">*</span><span class="n">rb</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_USES_DCR</span><span class="p">)</span>
		<span class="n">_mpic_map_dcr</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">_mpic_map_mmio</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_PPC_DCR */</span><span class="cp"></span>
<span class="cp">#define mpic_map(m,p,b,o,s)	_mpic_map_mmio(m,p,b,o,s)</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_PPC_DCR */</span><span class="cp"></span>



<span class="cm">/* Check if we have one of those nice broken MPICs with a flipped endian on</span>
<span class="cm"> * reads from IPI registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_test_broken_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_VECTOR_PRI_0</span><span class="p">),</span> <span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_IPI_VECTOR_PRI_0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">MPIC_VECPRI_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: Detected reversed IPI registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_BROKEN_IPI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>

<span class="cm">/* Test if an interrupt is sourced from HyperTransport (used on broken U3s)</span>
<span class="cm"> * to force the edge setting on the MPIC and do the ack workaround.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mpic_is_ht_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="mi">128</span> <span class="o">||</span> <span class="o">!</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">source</span><span class="p">].</span><span class="n">base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpic_ht_end_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic_irq_fixup</span> <span class="o">*</span><span class="n">fixup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">source</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">applebase</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">soff</span> <span class="o">=</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">applebase</span> <span class="o">+</span> <span class="n">soff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">raw_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x11</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">raw_spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_startup_ht_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">,</span>
				      <span class="n">bool</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic_irq_fixup</span> <span class="o">*</span><span class="n">fixup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">source</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;startup_ht_interrupt(0x%x) index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">source</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Enable and configure */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x23U</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* use the lowest bit inverted to the actual HW,</span>
<span class="cm">	 * set if this fixup was enabled, clear otherwise */</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">source</span><span class="p">].</span><span class="n">fixup_data</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_shutdown_ht_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic_irq_fixup</span> <span class="o">*</span><span class="n">fixup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">source</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;shutdown_ht_interrupt(0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

	<span class="cm">/* Disable */</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* use the lowest bit inverted to the actual HW,</span>
<span class="cm">	 * set if this fixup was enabled, clear otherwise */</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">source</span><span class="p">].</span><span class="n">fixup_data</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI_MSI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_scan_ht_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devbase</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pos</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">PCI_CAPABILITY_LIST</span><span class="p">);</span> <span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">pos</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_CAP_LIST_NEXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_CAP_LIST_ID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_HT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HT_5BIT_CAP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HT_CAPTYPE_MSI_MAPPING</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">HT_MSI_FLAGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HT_MSI_FLAGS_FIXED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">HT_MSI_ADDR_LO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HT_MSI_ADDR_LO_MASK</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">HT_MSI_ADDR_HI</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;mpic:   - HT:%02x.%x %s MSI mapping found @ 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">),</span>
		<span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HT_MSI_FLAGS_ENABLE</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HT_MSI_FLAGS_ENABLE</span><span class="p">))</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">flags</span> <span class="o">|</span> <span class="n">HT_MSI_FLAGS_ENABLE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">HT_MSI_FLAGS</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_scan_ht_msi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devbase</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_scan_ht_pic</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devbase</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">u32</span> <span class="n">vdid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pos</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">PCI_CAPABILITY_LIST</span><span class="p">);</span> <span class="n">pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">pos</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_CAP_LIST_NEXT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">id</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">PCI_CAP_LIST_ID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">PCI_CAP_ID_HT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">HT_5BIT_CAP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HT_CAPTYPE_IRQ</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">devbase</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic:   - HT:%02x.%x [0x%02x] vendor %04x device %04x&quot;</span>
	       <span class="s">&quot; has %d irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">vdid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">vdid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;HT PIC index 0x%x, irq 0x%x, tmp: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="cm">/* mask it , will be unmasked later */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">irq</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">irq</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="cm">/* Apple HT PIC has a non-standard way of doing EOIs */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vdid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x106b</span><span class="p">)</span>
			<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">irq</span><span class="p">].</span><span class="n">applebase</span> <span class="o">=</span> <span class="n">devbase</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">irq</span><span class="p">].</span><span class="n">applebase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x11</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">irq</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
 

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_scan_ht_pics</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cfgspace</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: Setting up HT PICs workarounds for U3/U4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Allocate fixups array */</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Init spinlock */</span>
	<span class="n">raw_spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixup_lock</span><span class="p">);</span>

	<span class="cm">/* Map U3 config space. We assume all IO-APICs are on the primary bus</span>
<span class="cm">	 * so we only need to map 64kB.</span>
<span class="cm">	 */</span>
	<span class="n">cfgspace</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="mh">0xf2000000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">cfgspace</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Now we scan all slots. We do a very quick scan, we read the header</span>
<span class="cm">	 * type, vendor ID and device ID only, that&#39;s plenty enough</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devfn</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">devfn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">devbase</span> <span class="o">=</span> <span class="n">cfgspace</span> <span class="o">+</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">hdr_type</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">PCI_HEADER_TYPE</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">l</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">PCI_VENDOR_ID</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">s</span><span class="p">;</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;devfn %x, l: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

		<span class="cm">/* If no device, skip */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">==</span> <span class="mh">0xffffffff</span> <span class="o">||</span> <span class="n">l</span> <span class="o">==</span> <span class="mh">0x00000000</span> <span class="o">||</span>
		    <span class="n">l</span> <span class="o">==</span> <span class="mh">0x0000ffff</span> <span class="o">||</span> <span class="n">l</span> <span class="o">==</span> <span class="mh">0xffff0000</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="cm">/* Check if is supports capability lists */</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">devbase</span> <span class="o">+</span> <span class="n">PCI_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">PCI_STATUS_CAP_LIST</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">mpic_scan_ht_pic</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">devbase</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">mpic_scan_ht_msi</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">devbase</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>

	<span class="nl">next:</span>
		<span class="cm">/* next device, if function 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdr_type</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">devfn</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mpic_is_ht_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_scan_ht_pics</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>

<span class="cm">/* Find an mpic associated with a given linux interrupt */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="nf">mpic_find</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="n">NUM_ISA_INTERRUPTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine if the linux irq is an IPI */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_is_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">&lt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Determine if the linux irq is a timer */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_is_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">&lt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Convert a cpu mask from logical to physical cpu numbers. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">mpic_physmask</span><span class="p">(</span><span class="n">u32</span> <span class="n">cpumask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">NR_CPUS</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">cpumask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cpumask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cm">/* Get the mpic structure from the IPI number */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span> <span class="nf">mpic_from_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Get the mpic structure from the irq number */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span> <span class="nf">mpic_from_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">irq_get_chip_data</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get the mpic structure from the irq data */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span> <span class="nf">mpic_from_irq_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">irq_data_get_irq_chip_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send an EOI */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mpic_eoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_EOI</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">mpic_cpu_read</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_WHOAMI</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Linux descriptor level callbacks</span>
<span class="cm"> */</span>


<span class="kt">void</span> <span class="nf">mpic_unmask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%p: %s: enable_irq: %d (src %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span>
		       <span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">))</span> <span class="o">&amp;</span>
		       <span class="o">~</span><span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
	<span class="cm">/* make sure mask gets to controller before we return to user */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loops</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout on hwirq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_mask_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: disable_irq: %d (src %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span>
		       <span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">))</span> <span class="o">|</span>
		       <span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>

	<span class="cm">/* make sure mask gets to controller before we return to user */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loops</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout on hwirq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">MPIC_VECPRI_MASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_end_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_IRQ</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: end_irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* We always EOI on end_irq() even for edge interrupts since that</span>
<span class="cm">	 * should only lower the priority, the MPIC should have properly</span>
<span class="cm">	 * latched another edge interrupt coming in anyway</span>
<span class="cm">	 */</span>

	<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_unmask_ht_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">mpic_unmask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqd_is_level_type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="n">mpic_ht_end_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_startup_ht_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">mpic_unmask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">mpic_startup_ht_interrupt</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">irqd_is_level_type</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_shutdown_ht_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">mpic_shutdown_ht_interrupt</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">mpic_mask_irq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_end_ht_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_IRQ</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: end_irq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* We always EOI on end_irq() even for edge interrupts since that</span>
<span class="cm">	 * should only lower the priority, the MPIC should have properly</span>
<span class="cm">	 * latched another edge interrupt coming in anyway</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqd_is_level_type</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="n">mpic_ht_end_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_unmask_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_ipi</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: enable_ipi: %d (ipi %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">mpic_ipi_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mpic_ipi_read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_mask_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NEVER disable an IPI... that&#39;s just plain wrong! */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_end_ipi</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_ipi</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * IPIs are marked IRQ_PER_CPU. This has the side effect of</span>
<span class="cm">	 * preventing the IRQ_PENDING/IRQ_INPROGRESS logic from</span>
<span class="cm">	 * applying to them. We EOI them late to avoid re-entering.</span>
<span class="cm">	 */</span>
	<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_unmask_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: enable_tm: %d (tm %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">mpic_tm_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mpic_tm_read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
	<span class="n">mpic_tm_read</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_mask_tm</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">mpic_tm_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mpic_tm_read</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">|</span> <span class="n">MPIC_VECPRI_MASK</span><span class="p">);</span>
	<span class="n">mpic_tm_read</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mpic_set_affinity</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cpumask</span> <span class="o">*</span><span class="n">cpumask</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SINGLE_DEST_CPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cpuid</span> <span class="o">=</span> <span class="n">irq_choose_cpu</span><span class="p">(</span><span class="n">cpumask</span><span class="p">);</span>

		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cpuid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">cpumask</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">cpu_online_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span>
			       <span class="n">mpic_physmask</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_type_to_vecpri</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Now convert sense value */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">IRQ_TYPE_SENSE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_RISING</span>:
		<span class="k">return</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_EDGE</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_POSITIVE</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span>:
	<span class="k">case</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span>:
		<span class="k">return</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_EDGE</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_NEGATIVE</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span>:
		<span class="k">return</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_LEVEL</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_POSITIVE</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_LEVEL</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_NEGATIVE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mpic_set_irq_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flow_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq_data</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">irqd_to_hwirq</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vecpri</span><span class="p">,</span> <span class="n">vold</span><span class="p">,</span> <span class="n">vnew</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: set_irq_type(mpic:@%p,virq:%d,src:0x%x,type:0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">mpic</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">flow_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vold</span> <span class="o">=</span> <span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">));</span>

	<span class="cm">/* We don&#39;t support &quot;none&quot; type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">)</span>
		<span class="n">flow_type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_DEFAULT</span><span class="p">;</span>

	<span class="cm">/* Default: read HW settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flow_type</span> <span class="o">==</span> <span class="n">IRQ_TYPE_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">vold</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_MASK</span><span class="p">)</span> <span class="o">|</span>
			       <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_EDGE</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_POSITIVE</span><span class="p">)</span><span class="o">:</span>
				<span class="n">flow_type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_EDGE</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_NEGATIVE</span><span class="p">)</span><span class="o">:</span>
				<span class="n">flow_type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_LEVEL</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_POSITIVE</span><span class="p">)</span><span class="o">:</span>
				<span class="n">flow_type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_LEVEL</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_NEGATIVE</span><span class="p">)</span><span class="o">:</span>
				<span class="n">flow_type</span> <span class="o">=</span> <span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Apply to irq desc */</span>
	<span class="n">irqd_set_trigger_type</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">flow_type</span><span class="p">);</span>

	<span class="cm">/* Apply to HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic_is_ht_interrupt</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span>
		<span class="n">vecpri</span> <span class="o">=</span> <span class="n">MPIC_VECPRI_POLARITY_POSITIVE</span> <span class="o">|</span>
			<span class="n">MPIC_VECPRI_SENSE_EDGE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vecpri</span> <span class="o">=</span> <span class="n">mpic_type_to_vecpri</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">flow_type</span><span class="p">);</span>

	<span class="n">vnew</span> <span class="o">=</span> <span class="n">vold</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_POLARITY_MASK</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_SENSE_MASK</span><span class="p">));</span>
	<span class="n">vnew</span> <span class="o">|=</span> <span class="n">vecpri</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vold</span> <span class="o">!=</span> <span class="n">vnew</span><span class="p">)</span>
		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span> <span class="n">vnew</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_SET_MASK_OK_NOCOPY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_set_vector</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vecpri</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: set_vector(mpic:@%p,virq:%d,src:%d,vector:0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">mpic</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vecpri</span> <span class="o">=</span> <span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">));</span>
	<span class="n">vecpri</span> <span class="o">=</span> <span class="n">vecpri</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_VECTOR_MASK</span><span class="p">);</span>
	<span class="n">vecpri</span> <span class="o">|=</span> <span class="n">vector</span><span class="p">;</span>
	<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span> <span class="n">vecpri</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_set_destination</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_from_irq</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: set_destination(mpic:@%p,virq:%d,src:%d,cpuid:0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">mpic</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">cpuid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cpuid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpic_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">mpic_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">mpic_unmask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span>	<span class="o">=</span> <span class="n">mpic_end_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">mpic_set_irq_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpic_ipi_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">mpic_mask_ipi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">mpic_unmask_ipi</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span>	<span class="o">=</span> <span class="n">mpic_end_ipi</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpic_tm_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">mpic_mask_tm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">mpic_unmask_tm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span>	<span class="o">=</span> <span class="n">mpic_end_irq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">mpic_irq_ht_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq_startup</span>	<span class="o">=</span> <span class="n">mpic_startup_ht_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_shutdown</span>	<span class="o">=</span> <span class="n">mpic_shutdown_ht_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_mask</span>	<span class="o">=</span> <span class="n">mpic_mask_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_unmask</span>	<span class="o">=</span> <span class="n">mpic_unmask_ht_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_eoi</span>	<span class="o">=</span> <span class="n">mpic_end_ht_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_set_type</span>	<span class="o">=</span> <span class="n">mpic_set_irq_type</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpic_host_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Exact match, unless mpic node is NULL */</span>
	<span class="k">return</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">of_node</span> <span class="o">==</span> <span class="n">node</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpic_host_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">,</span>
			 <span class="n">irq_hw_number_t</span> <span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">host_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: map virq %d, hwirq 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">virq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">==</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">spurious_vec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: mapping as IPI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">mpic</span><span class="p">);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ipi</span><span class="p">,</span>
					 <span class="n">handle_percpu_irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span> <span class="o">&lt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">);</span>

		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: mapping as timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">mpic</span><span class="p">);</span>
		<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_tm</span><span class="p">,</span>
					 <span class="n">handle_fasteoi_irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">&gt;=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mpic_msi_reserve_hwirq</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Default chip */</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_irq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="cm">/* Check for HT interrupts, override vecpri */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic_is_ht_interrupt</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">hw</span><span class="p">))</span>
		<span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ht_irq</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: mapping to irq chip @%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">irq_set_chip_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">mpic</span><span class="p">);</span>
	<span class="n">irq_set_chip_and_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">handle_fasteoi_irq</span><span class="p">);</span>

	<span class="cm">/* Set default irq type */</span>
	<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">IRQ_TYPE_DEFAULT</span><span class="p">);</span>

	<span class="cm">/* If the MPIC was reset, then all vectors have already been</span>
<span class="cm">	 * initialized.  Otherwise, a per source lazy initialization</span>
<span class="cm">	 * is done here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpic_is_ipi</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_NO_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mpic_set_vector</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="n">mpic_set_destination</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">mpic_processor_id</span><span class="p">(</span><span class="n">mpic</span><span class="p">));</span>
		<span class="n">mpic_irq_set_priority</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpic_host_xlate</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_domain</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">intspec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intsize</span><span class="p">,</span>
			   <span class="n">irq_hw_number_t</span> <span class="o">*</span><span class="n">out_hwirq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">out_flags</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">host_data</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">map_mpic_senses</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">,</span>
		<span class="n">IRQ_TYPE_LEVEL_LOW</span><span class="p">,</span>
		<span class="n">IRQ_TYPE_LEVEL_HIGH</span><span class="p">,</span>
		<span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">out_hwirq</span> <span class="o">=</span> <span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intsize</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_FSL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Freescale MPIC with extended intspec:</span>
<span class="cm">		 * First two cells are as usual.  Third specifies</span>
<span class="cm">		 * an &quot;interrupt type&quot;.  Fourth is type-specific data.</span>
<span class="cm">		 *</span>
<span class="cm">		 * See Documentation/devicetree/bindings/powerpc/fsl/mpic.txt</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">intspec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* no EISR/EIMR support for now, treat as shared IRQ */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="o">*</span><span class="n">out_hwirq</span> <span class="o">=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="o">*</span><span class="n">out_hwirq</span> <span class="o">=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: unknown irq type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">intspec</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">out_flags</span> <span class="o">=</span> <span class="n">map_mpic_senses</span><span class="p">[</span><span class="n">intspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>

		<span class="cm">/* Apple invented a new race of encoding on machines with</span>
<span class="cm">		 * an HT APIC. They encode, among others, the index within</span>
<span class="cm">		 * the HT APIC. We don&#39;t care about it here since thankfully,</span>
<span class="cm">		 * it appears that they have the APIC already properly</span>
<span class="cm">		 * configured, and thus our current fixup code that reads the</span>
<span class="cm">		 * APIC config works fine. However, we still need to mask out</span>
<span class="cm">		 * bits in the specifier to make sure we only get bit 0 which</span>
<span class="cm">		 * is the level/edge bit (the only sense bit exposed by Apple),</span>
<span class="cm">		 * as their bit 1 means something else.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">out_flags</span> <span class="o">=</span> <span class="n">map_mpic_senses</span><span class="p">[</span><span class="n">intspec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">out_flags</span> <span class="o">=</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;mpic: xlate (%d cells: 0x%08x 0x%08x) to line 0x%lx sense 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">intsize</span><span class="p">,</span> <span class="n">intspec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intspec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">out_hwirq</span><span class="p">,</span> <span class="o">*</span><span class="n">out_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* IRQ handler for a secondary MPIC cascaded from another IRQ controller */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_cascade</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">irq_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">irq_desc_get_chip</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">irq_desc_get_handler_data</span><span class="p">(</span><span class="n">desc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">virq</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">));</span>

	<span class="n">virq</span> <span class="o">=</span> <span class="n">mpic_get_one_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">virq</span><span class="p">)</span>
		<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">virq</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq_eoi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">irq_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_domain_ops</span> <span class="n">mpic_host_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">mpic_host_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">mpic_host_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xlate</span> <span class="o">=</span> <span class="n">mpic_host_xlate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Exported functions</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">mpic_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">,</span>
				<span class="n">phys_addr_t</span> <span class="n">phys_addr</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isu_size</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_count</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">intvec_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">greg_feature</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vers</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">psrc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_irq</span><span class="p">;</span>

	<span class="cm">/* Default MPIC search parameters */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">__initconst</span> <span class="n">mpic_device_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">type</span>	      <span class="o">=</span> <span class="s">&quot;open-pic&quot;</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;open-pic&quot;</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{},</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we were not passed a device-tree node, then perform the default</span>
<span class="cm">	 * search for standardized a standardized OpenPIC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">node</span> <span class="o">=</span> <span class="n">of_find_matching_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mpic_device_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pick the physical address from the device tree if unspecified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if it is DCR-based */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;dcr-reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_USES_DCR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_of_node_put</span><span class="p">;</span>
			<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read extra device-tree properties into the flags variable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;big-endian&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_BIG_ENDIAN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;pic-no-reset&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_NO_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;single-cpu-affinity&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_SINGLE_DEST_CPU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;fsl,mpic&quot;</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MPIC_FSL</span><span class="p">;</span>

	<span class="n">mpic</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_of_node_put</span><span class="p">;</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_irq</span> <span class="o">=</span> <span class="n">mpic_irq_chip</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_irq</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">))</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_irq</span><span class="p">.</span><span class="n">irq_set_affinity</span> <span class="o">=</span> <span class="n">mpic_set_affinity</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ht_irq</span> <span class="o">=</span> <span class="n">mpic_irq_ht_chip</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ht_irq</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">))</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ht_irq</span><span class="p">.</span><span class="n">irq_set_affinity</span> <span class="o">=</span> <span class="n">mpic_set_affinity</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MPIC_U3_HT_IRQS */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ipi</span> <span class="o">=</span> <span class="n">mpic_ipi_chip</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_ipi</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_tm</span> <span class="o">=</span> <span class="n">mpic_tm_chip</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hc_tm</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* so far */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_LARGE_VECTORS</span><span class="p">)</span>
		<span class="n">intvec_top</span> <span class="o">=</span> <span class="mi">2047</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">intvec_top</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>   <span class="o">=</span> <span class="n">intvec_top</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">spurious_vec</span>  <span class="o">=</span> <span class="n">intvec_top</span><span class="p">;</span>

	<span class="cm">/* Look for protected sources */</span>
	<span class="n">psrc</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;protected-sources&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psrc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate a bitmap with one bit per interrupt */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mapsize</span> <span class="o">=</span> <span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">intvec_top</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mapsize</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psize</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psrc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">intvec_top</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">psrc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MPIC_WEIRD</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">hw_set</span> <span class="o">=</span> <span class="n">mpic_infos</span><span class="p">[</span><span class="n">MPIC_GET_REGSET</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)];</span>
<span class="cp">#endif</span>

	<span class="cm">/* default register type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_BIG_ENDIAN</span><span class="p">)</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">mpic_access_mmio_be</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">mpic_access_mmio_le</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * An MPIC with a &quot;dcr-reg&quot; property must be accessed that way, but</span>
<span class="cm">	 * only if the kernel includes DCR support.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_PPC_DCR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_USES_DCR</span><span class="p">)</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span> <span class="o">=</span> <span class="n">mpic_access_dcr</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_USES_DCR</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Map the global registers */</span>
	<span class="n">mpic_map</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_BASE</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">mpic_map</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">tmregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_BASE</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="cm">/* Reset */</span>

	<span class="cm">/* When using a device-node, reset requests are only honored if the MPIC</span>
<span class="cm">	 * is allowed to reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_NO_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;mpic: Resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">),</span>
			   <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
			   <span class="o">|</span> <span class="n">MPIC_GREG_GCONF_RESET</span><span class="p">);</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
		       <span class="o">&amp;</span> <span class="n">MPIC_GREG_GCONF_RESET</span><span class="p">)</span>
			<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* CoreInt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_ENABLE_COREINT</span><span class="p">)</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">),</span>
			   <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
			   <span class="o">|</span> <span class="n">MPIC_GREG_GCONF_COREINT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_ENABLE_MCK</span><span class="p">)</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">),</span>
			   <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
			   <span class="o">|</span> <span class="n">MPIC_GREG_GCONF_MCK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MPIC driver will crash if there are more cores than we</span>
<span class="cm">	 * can initialize, so we may as well catch that problem here.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">num_possible_cpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">MPIC_MAX_CPUS</span><span class="p">);</span>

	<span class="cm">/* Map the per-CPU registers */</span>
	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="n">mpic_map</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">cpuregs</span><span class="p">[</span><span class="n">cpu</span><span class="p">],</span>
			 <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_BASE</span><span class="p">)</span> <span class="o">+</span> <span class="n">cpu</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_STRIDE</span><span class="p">),</span>
			 <span class="mh">0x1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read feature register.  For non-ISU MPICs, num sources as well. On</span>
<span class="cm">	 * ISU MPICs, sources are counted as ISUs are added</span>
<span class="cm">	 */</span>
	<span class="n">greg_feature</span> <span class="o">=</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_FEATURE_0</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * By default, the last source number comes from the MPIC, but the</span>
<span class="cm">	 * device-tree and board support code can override it on buggy hw.</span>
<span class="cm">	 * If we get passed an isu_size (multi-isu MPIC) then we use that</span>
<span class="cm">	 * as a default instead of the value read from the HW.</span>
<span class="cm">	 */</span>
	<span class="n">last_irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">greg_feature</span> <span class="o">&amp;</span> <span class="n">MPIC_GREG_FEATURE_LAST_SRC_MASK</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">MPIC_GREG_FEATURE_LAST_SRC_SHIFT</span><span class="p">;</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">isu_size</span><span class="p">)</span>
		<span class="n">last_irq</span> <span class="o">=</span> <span class="n">isu_size</span>  <span class="o">*</span> <span class="n">MPIC_MAX_ISU</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;last-interrupt-source&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_count</span><span class="p">)</span>
		<span class="n">last_irq</span> <span class="o">=</span> <span class="n">irq_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Initialize main ISU if none provided */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isu_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isu_size</span> <span class="o">=</span> <span class="n">last_irq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="o">=</span> <span class="n">isu_size</span><span class="p">;</span>
		<span class="n">mpic_map</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_BASE</span><span class="p">),</span>
				<span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_STRIDE</span><span class="p">)</span> <span class="o">*</span> <span class="n">isu_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span> <span class="o">=</span> <span class="n">isu_size</span><span class="p">;</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_shift</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">__ilog2</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span> <span class="o">=</span> <span class="n">irq_domain_add_linear</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
				       <span class="n">last_irq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">mpic_host_ops</span><span class="p">,</span> <span class="n">mpic</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: The code leaks the MPIC object and mappings here; this</span>
<span class="cm">	 * is very unlikely to fail but it ought to be fixed anyways.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Display version */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">greg_feature</span> <span class="o">&amp;</span> <span class="n">MPIC_GREG_FEATURE_VERSION_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">vers</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">vers</span> <span class="o">=</span> <span class="s">&quot;1.2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">vers</span> <span class="o">=</span> <span class="s">&quot;1.3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">vers</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: Setting up MPIC </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> version %s at %llx,&quot;</span>
	       <span class="s">&quot; max %d CPUs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">name</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">,</span> <span class="n">num_possible_cpus</span><span class="p">());</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: ISU size: %d, shift: %d, mask: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_shift</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_mask</span><span class="p">);</span>

	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">mpics</span><span class="p">;</span>
	<span class="n">mpics</span> <span class="o">=</span> <span class="n">mpic</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mpic_primary</span> <span class="o">=</span> <span class="n">mpic</span><span class="p">;</span>
		<span class="n">irq_set_default_host</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mpic</span><span class="p">;</span>

<span class="nl">err_of_node_put:</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_assign_isu</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isu_num</span><span class="p">,</span>
			    <span class="n">phys_addr_t</span> <span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">isu_first</span> <span class="o">=</span> <span class="n">isu_num</span> <span class="o">*</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">isu_num</span> <span class="o">&gt;=</span> <span class="n">MPIC_MAX_ISU</span><span class="p">);</span>

	<span class="n">mpic_map</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span>
		 <span class="n">paddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isus</span><span class="p">[</span><span class="n">isu_num</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_STRIDE</span><span class="p">)</span> <span class="o">*</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">isu_first</span> <span class="o">+</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">)</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="o">=</span> <span class="n">isu_first</span> <span class="o">+</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">isu_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: Initializing for %d sources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">);</span>

	<span class="cm">/* Set current processor priority to max */</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">),</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="cm">/* Initialize timers to our reserved vectors and mask them for now */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">tmregs</span><span class="p">,</span>
			   <span class="n">i</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_STRIDE</span><span class="p">)</span> <span class="o">+</span>
			   <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_DESTINATION</span><span class="p">),</span>
			   <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hard_smp_processor_id</span><span class="p">());</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">tmregs</span><span class="p">,</span>
			   <span class="n">i</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_STRIDE</span><span class="p">)</span> <span class="o">+</span>
			   <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">TIMER_VECTOR_PRI</span><span class="p">),</span>
			   <span class="n">MPIC_VECPRI_MASK</span> <span class="o">|</span>
			   <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize IPIs to our reserved vectors and mark them disabled for now */</span>
	<span class="n">mpic_test_broken_ipi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic_ipi_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span>
			       <span class="n">MPIC_VECPRI_MASK</span> <span class="o">|</span>
			       <span class="p">(</span><span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Do the HT PIC fixups on U3 broken mpic */</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;MPIC flags: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_U3_HT_IRQS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mpic_scan_ht_pics</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="n">mpic_u3msi_init</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mpic_pasemi_msi_init</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">mpic_processor_id</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_NO_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* start with vector = source number, and masked */</span>
			<span class="n">u32</span> <span class="n">vecpri</span> <span class="o">=</span> <span class="n">MPIC_VECPRI_MASK</span> <span class="o">|</span> <span class="n">i</span> <span class="o">|</span>
				<span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">);</span>
		
			<span class="cm">/* check if protected */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* init hw */</span>
			<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span> <span class="n">vecpri</span><span class="p">);</span>
			<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cpu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="cm">/* Init spurious vector */</span>
	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_SPURIOUS</span><span class="p">),</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">spurious_vec</span><span class="p">);</span>

	<span class="cm">/* Disable 8259 passthrough, if supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_NO_PTHROU_DIS</span><span class="p">))</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">),</span>
			   <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
			   <span class="o">|</span> <span class="n">MPIC_GREG_GCONF_8259_PTHROU_DIS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_NO_BIAS</span><span class="p">)</span>
		<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">),</span>
			<span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_GLOBAL_CONF_0</span><span class="p">))</span>
			<span class="o">|</span> <span class="n">MPIC_GREG_GCONF_NO_BIAS</span><span class="p">);</span>

	<span class="cm">/* Set current processor priority to 0 */</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="cm">/* allocate memory to save mpic state */</span>
	<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Check if this MPIC is chained from a parent interrupt controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SECONDARY</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">virq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">virq</span> <span class="o">!=</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: hooking up to IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">virq</span><span class="p">);</span>
			<span class="n">irq_set_handler_data</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="n">mpic</span><span class="p">);</span>
			<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">virq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic_cascade</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_set_clk_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clock_ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPIC_GREG_GLOBAL_CONF_1_CLK_RATIO_MASK</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1_CLK_RATIO</span><span class="p">(</span><span class="n">clock_ratio</span><span class="p">);</span>
	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">mpic_set_serial_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1_SIE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MPIC_GREG_GLOBAL_CONF_1_SIE</span><span class="p">;</span>
	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_GREG_GLOBAL_CONF_1</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_irq_set_priority</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_find</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">virq_to_hw</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpic</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic_is_ipi</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mpic_ipi_read</span><span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">MPIC_VECPRI_PRIORITY_MASK</span><span class="p">;</span>
		<span class="n">mpic_ipi_write</span><span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			       <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mpic_is_tm</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mpic_tm_read</span><span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">MPIC_VECPRI_PRIORITY_MASK</span><span class="p">;</span>
		<span class="n">mpic_tm_write</span><span class="p">(</span><span class="n">src</span> <span class="o">-</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">timer_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			      <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">))</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">MPIC_VECPRI_PRIORITY_MASK</span><span class="p">;</span>
		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span>
			       <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&lt;&lt;</span> <span class="n">MPIC_VECPRI_PRIORITY_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_setup_this_cpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: setup_this_cpu(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hard_smp_processor_id</span><span class="p">());</span>

	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

 	<span class="cm">/* let the mpic know we want intrs. default affinity is 0xffffffff</span>
<span class="cm">	 * until changed via /proc. That&#39;s how it&#39;s done on x86. If we want</span>
<span class="cm">	 * it differently, then we should make sure we also change the default</span>
<span class="cm">	 * values of irq_desc[].affinity in irq.c.</span>
<span class="cm"> 	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">distribute_irqs</span><span class="p">)</span> <span class="p">{</span>
	 	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span>
				<span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">))</span> <span class="o">|</span> <span class="n">msk</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set current processor priority to 0 */</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mpic_cpu_get_priority</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mpic_cpu_read</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_cpu_set_priority</span><span class="p">(</span><span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>

	<span class="n">prio</span> <span class="o">&amp;=</span> <span class="n">MPIC_CPU_TASKPRI_MASK</span><span class="p">;</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">),</span> <span class="n">prio</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_teardown_this_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msk</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: teardown_this_cpu(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hard_smp_processor_id</span><span class="p">());</span>
	<span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* let the mpic know we don&#39;t want intrs.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span>
			<span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">msk</span><span class="p">);</span>

	<span class="cm">/* Set current processor priority to max */</span>
	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_CURRENT_TASK_PRI</span><span class="p">),</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="cm">/* We need to EOI the IPI since not all platforms reset the MPIC</span>
<span class="cm">	 * on boot and new interrupts wouldn&#39;t get delivered otherwise.</span>
<span class="cm">	 */</span>
	<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>

	<span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">_mpic_get_one_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">mpic_cpu_read</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">VECPRI_VECTOR_MASK</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG_LOW</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: get_one_irq(reg 0x%x): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">spurious_vec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SPV_EOI</span><span class="p">)</span>
			<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Got protected source %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">src</span><span class="p">);</span>
		<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">irq_linear_revmap</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_get_one_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_mpic_get_one_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_INTACK</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_get_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mpic_get_one_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_get_coreint_irq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_EPR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">spurious_vec</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_SPV_EOI</span><span class="p">)</span>
			<span class="n">mpic_eoi</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">protected</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk_ratelimited</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Got protected source %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">src</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">irq_linear_revmap</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">NO_IRQ</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mpic_get_mcirq</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">_mpic_get_one_irq</span><span class="p">(</span><span class="n">mpic</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_MCACK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="kt">void</span> <span class="nf">mpic_request_ipis</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mpic: requesting IPIs...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vipi</span> <span class="o">=</span> <span class="n">irq_create_mapping</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">irqhost</span><span class="p">,</span>
						       <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">ipi_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vipi</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to map %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_ipi_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smp_request_message_ipi</span><span class="p">(</span><span class="n">vipi</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">smp_mpic_message_pass</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">physmask</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mpic</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* make sure we&#39;re sending something that translates to an IPI */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">msg</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SMP %d: smp_message_pass: unknown msg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG_IPI</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;%s: send_ipi(ipi_no: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">physmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">mpic_cpu_write</span><span class="p">(</span><span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_IPI_DISPATCH_0</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">msg</span> <span class="o">*</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">CPU_IPI_DISPATCH_STRIDE</span><span class="p">),</span> <span class="n">physmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">smp_mpic_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr_cpus</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;smp_mpic_probe()...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nr_cpus</span> <span class="o">=</span> <span class="n">cpumask_weight</span><span class="p">(</span><span class="n">cpu_possible_mask</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;nr_cpus: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_cpus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_cpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mpic_request_ipis</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">nr_cpus</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">smp_mpic_setup_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mpic_setup_this_cpu</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mpic_reset_core</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic_primary</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpuid</span> <span class="o">=</span> <span class="n">get_hard_smp_processor_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set target bit for core reset */</span>
	<span class="n">pir</span> <span class="o">=</span> <span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_PROCESSOR_INIT</span><span class="p">));</span>
	<span class="n">pir</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cpuid</span><span class="p">);</span>
	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_PROCESSOR_INIT</span><span class="p">),</span> <span class="n">pir</span><span class="p">);</span>
	<span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_PROCESSOR_INIT</span><span class="p">));</span>

	<span class="cm">/* Restore target bit after reset complete */</span>
	<span class="n">pir</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cpuid</span><span class="p">);</span>
	<span class="n">mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_PROCESSOR_INIT</span><span class="p">),</span> <span class="n">pir</span><span class="p">);</span>
	<span class="n">mpic_read</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">gregs</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">GREG_PROCESSOR_INIT</span><span class="p">));</span>

	<span class="cm">/* Perform 15 EOI on each reset core to clear pending interrupts.</span>
<span class="cm">	 * This is required for FSL CoreNet based devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MPIC_FSL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_mpic_write</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">cpuregs</span><span class="p">[</span><span class="n">cpuid</span><span class="p">],</span>
				      <span class="n">MPIC_CPU_EOI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_suspend_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vecprio</span> <span class="o">=</span>
			<span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">));</span>
		<span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest</span> <span class="o">=</span>
			<span class="n">mpic_irq_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpic_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpics</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mpic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic_suspend_one</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_resume_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">num_sources</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_VECTOR_PRI</span><span class="p">),</span>
			       <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vecprio</span><span class="p">);</span>
		<span class="n">mpic_irq_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">MPIC_INFO</span><span class="p">(</span><span class="n">IRQ_DESTINATION</span><span class="p">),</span>
			       <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dest</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MPIC_U3_HT_IRQS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mpic_irq_fixup</span> <span class="o">*</span><span class="n">fixup</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">fixups</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we use the lowest bit in an inverted meaning */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fixup_data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Enable and configure */</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0x10</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">mpic</span><span class="o">-&gt;</span><span class="n">save_data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fixup_data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">,</span>
			       <span class="n">fixup</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="cm">/* end for loop */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpic_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpic</span> <span class="o">*</span><span class="n">mpic</span> <span class="o">=</span> <span class="n">mpics</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">mpic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mpic_resume_one</span><span class="p">(</span><span class="n">mpic</span><span class="p">);</span>
		<span class="n">mpic</span> <span class="o">=</span> <span class="n">mpic</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">syscore_ops</span> <span class="n">mpic_syscore_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">mpic_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">mpic_suspend</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpic_init_sys</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">register_syscore_ops</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mpic_syscore_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">mpic_init_sys</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
