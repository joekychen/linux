<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › ppc4xx_pci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ppc4xx_pci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PCI / PCI-X / PCI-Express support for 4xx parts</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007 Ben. Herrenschmidt &lt;benh@kernel.crashing.org&gt;, IBM Corp.</span>
<span class="cm"> *</span>
<span class="cm"> * Most PCI Express code is coming from Stefan Roese implementation for</span>
<span class="cm"> * arch/ppc in the Denx tree, slightly reworked by me.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2007 DENX Software Engineering, Stefan Roese &lt;sr@denx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Some of that comes itself from a previous implementation for 440SPE only</span>
<span class="cm"> * by Roland Dreier:</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005 Cisco Systems.  All rights reserved.</span>
<span class="cm"> * Roland Dreier &lt;rolandd@cisco.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/pci-bridge.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/dcr.h&gt;</span>
<span class="cp">#include &lt;asm/dcr-regs.h&gt;</span>
<span class="cp">#include &lt;mm/mmu_decl.h&gt;</span>

<span class="cp">#include &quot;ppc4xx_pci.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_offset_set</span><span class="p">;</span>

<span class="cp">#define U64_TO_U32_LOW(val)	((u32)((val) &amp; 0x00000000ffffffffULL))</span>
<span class="cp">#define U64_TO_U32_HIGH(val)	((u32)((val) &gt;&gt; 32))</span>

<span class="cp">#define RES_TO_U32_LOW(val)	\</span>
<span class="cp">	((sizeof(resource_size_t) &gt; sizeof(u32)) ? U64_TO_U32_LOW(val) : (val))</span>
<span class="cp">#define RES_TO_U32_HIGH(val)	\</span>
<span class="cp">	((sizeof(resource_size_t) &gt; sizeof(u32)) ? U64_TO_U32_HIGH(val) : (0))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ppc440spe_revA</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Catch both 440SPe variants, with and without RAID6 support */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_PVR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffefffff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x53421890</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fixup_ppc4xx_pci_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pcix&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pci&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,plb440epx-pci&quot;</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;ibm,plb440grx-pci&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">indirect_type</span> <span class="o">|=</span> <span class="n">PPC_INDIRECT_TYPE_BROKEN_MRM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hide the PCI host BARs from the kernel as their content doesn&#39;t</span>
<span class="cm">	 * fit well in the resource management</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DEVICE_COUNT_RESOURCE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Hiding 4xx host bridge resources %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">DECLARE_PCI_FIXUP_HEADER</span><span class="p">(</span><span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">fixup_ppc4xx_pci_bridge</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_parse_dma_ranges</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ranges</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pna</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">np</span> <span class="o">=</span> <span class="n">pna</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* Default */</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span> <span class="o">|</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>

	<span class="cm">/* Get dma-ranges property */</span>
	<span class="n">ranges</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="s">&quot;dma-ranges&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ranges</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Walk it */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">rlen</span> <span class="o">-=</span> <span class="n">np</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pci_space</span> <span class="o">=</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">u64</span> <span class="n">pci_addr</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">ranges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">u64</span> <span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">of_translate_dma_address</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">ranges</span> <span class="o">+</span> <span class="n">pna</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ranges</span> <span class="o">+=</span> <span class="n">np</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">==</span> <span class="n">OF_BAD_ADDR</span> <span class="o">||</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* We only care about memory */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pci_space</span> <span class="o">&amp;</span> <span class="mh">0x03000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x02000000</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* We currently only support memory at 0, and pci_addr</span>
<span class="cm">		 * within 32 bits space</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_addr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pci_addr</span> <span class="o">&gt;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Ignored unsupported dma range&quot;</span>
			       <span class="s">&quot; 0x%016llx...0x%016llx -&gt; 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span>
			       <span class="n">pci_addr</span><span class="p">,</span> <span class="n">pci_addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if not prefetchable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_space</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">))</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IORESOURCE_PREFETCH</span><span class="p">;</span>


		<span class="cm">/* Use that */</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_addr</span><span class="p">;</span>
		<span class="cm">/* Beware of 32 bits resources */</span>
		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pci_addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x100000000ull</span><span class="p">)</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We only support one global DMA offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_offset_set</span> <span class="o">&amp;&amp;</span> <span class="n">pci_dram_offset</span> <span class="o">!=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dma-ranges(s) mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that we can fit all of memory as we don&#39;t support</span>
<span class="cm">	 * DMA bounce buffers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">total_memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dma-ranges too small &quot;</span>
		       <span class="s">&quot;(size=%llx total_memory=%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">total_memory</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check we are a power of 2 size and that base is a multiple of size*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="o">||</span>
	    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dma-ranges unaligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that we are fully contained within 32 bits space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: dma-ranges outside of 32 bits space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">dma_offset_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_dram_offset</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dma_window_base_cur</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dma_window_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;4xx PCI DMA offset set to 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci_dram_offset</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;4xx PCI DMA window base to 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dma_window_base_cur</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DMA window size 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dma_window_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 4xx PCI 2.x part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_setup_one_pci_PMM</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span>	<span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="n">__iomem</span>			<span class="o">*</span><span class="n">reg</span><span class="p">,</span>
					   <span class="n">u64</span>				<span class="n">plb_addr</span><span class="p">,</span>
					   <span class="n">u64</span>				<span class="n">pci_addr</span><span class="p">,</span>
					   <span class="n">u64</span>				<span class="n">size</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">flags</span><span class="p">,</span>
					   <span class="kt">int</span>				<span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ma</span><span class="p">,</span> <span class="n">pcila</span><span class="p">,</span> <span class="n">pciha</span><span class="p">;</span>

	<span class="cm">/* Hack warning ! The &quot;old&quot; PCI 2.x cell only let us configure the low</span>
<span class="cm">	 * 32-bit of incoming PLB addresses. The top 4 bits of the 36-bit</span>
<span class="cm">	 * address are actually hard wired to a value that appears to depend</span>
<span class="cm">	 * on the specific SoC. For example, it&#39;s 0 on 440EP and 1 on 440EPx.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The trick here is we just crop those top bits and ignore them when</span>
<span class="cm">	 * programming the chip. That means the device-tree has to be right</span>
<span class="cm">	 * for the specific part used (we don&#39;t print a warning if it&#39;s wrong</span>
<span class="cm">	 * but on the other hand, you&#39;ll crash quickly enough), but at least</span>
<span class="cm">	 * this code should work whatever the hard coded value is</span>
<span class="cm">	 */</span>
	<span class="n">plb_addr</span> <span class="o">&amp;=</span> <span class="mh">0xffffffffull</span><span class="p">;</span>

	<span class="cm">/* Note: Due to the above hack, the test below doesn&#39;t actually test</span>
<span class="cm">	 * if you address is above 4G, but it tests that address and</span>
<span class="cm">	 * (address + size) are both contained in the same 4G</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">plb_addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xffffffffull</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x1000</span> <span class="o">||</span> <span class="p">(</span><span class="n">plb_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Resource out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ma</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffu</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
		<span class="n">ma</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">pciha</span> <span class="o">=</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">pcila</span> <span class="o">=</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">plb_addr</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM0LA</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pcila</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM0PCILA</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pciha</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM0PCIHA</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM0MA</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">*</span> <span class="n">index</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pci_PMMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					     <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup outbound memory windows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* we only care about memory windows */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Too many ranges</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Configure the resource */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pci_PMM</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					     <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					     <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">,</span>
					     <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
					     <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
					     <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* If the resource PCI address is 0 then we have our</span>
<span class="cm">			 * ISA memory hole</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">)</span>
				<span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle ISA memory hole if not already covered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found_isa_hole</span> <span class="o">&amp;&amp;</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pci_PMM</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Legacy ISA memory support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pci_PTMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					     <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
					     <span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sa</span><span class="p">;</span>

	<span class="cm">/* Calculate window size */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffu</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sa</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* RAM is always at 0 local for now */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PTM1LA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PTM1MS</span><span class="p">);</span>

	<span class="cm">/* Map on PCI side */</span>
	<span class="n">early_write_config_dword</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
	<span class="n">early_write_config_dword</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">early_write_config_word</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_probe_pci_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NYI */</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">rsrc_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">rsrc_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">dma_window</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus_range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">primary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if device is enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_available</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Port disabled via device-tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fetch config space registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsrc_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get PCI config register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fetch host bridge internal registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsrc_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get PCI internal register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if primary bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">primary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get bus range if any */</span>
	<span class="n">bus_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;bus-range&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Map registers */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rsrc_reg</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsrc_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map registers !&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the host controller data structure */</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="n">pcibios_alloc_controller</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Setup config space */</span>
	<span class="n">setup_indirect_pci</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">rsrc_cfg</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rsrc_cfg</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable all windows */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM0MA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM1MA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PMM2MA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PTM1MS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIL0_PTM2MS</span><span class="p">);</span>

	<span class="cm">/* Parse outbound mapping resources */</span>
	<span class="n">pci_process_bridge_OF_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>

	<span class="cm">/* Parse inbound mapping resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_parse_dma_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Configure outbound ranges POMs */</span>
	<span class="n">ppc4xx_configure_pci_PMMs</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Configure inbound ranges PIMs */</span>
	<span class="n">ppc4xx_configure_pci_PTMs</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t need the registers anymore */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="p">)</span>
		<span class="n">pcibios_free_controller</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 4xx PCI-X part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_setup_one_pcix_POM</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span>	<span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					    <span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">reg</span><span class="p">,</span>
					    <span class="n">u64</span>				<span class="n">plb_addr</span><span class="p">,</span>
					    <span class="n">u64</span>				<span class="n">pci_addr</span><span class="p">,</span>
					    <span class="n">u64</span>				<span class="n">size</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">,</span>
					    <span class="kt">int</span>				<span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lah</span><span class="p">,</span> <span class="n">lal</span><span class="p">,</span> <span class="n">pciah</span><span class="p">,</span> <span class="n">pcial</span><span class="p">,</span> <span class="n">sa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x1000</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plb_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Resource out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate register values */</span>
	<span class="n">lah</span> <span class="o">=</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">plb_addr</span><span class="p">);</span>
	<span class="n">lal</span> <span class="o">=</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">plb_addr</span><span class="p">);</span>
	<span class="n">pciah</span> <span class="o">=</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">pcial</span> <span class="o">=</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffu</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* Program register values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0LAH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lal</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0LAL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pciah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0PCIAH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pcial</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0PCIAL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0SA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1LAH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">lal</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1LAL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pciah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1PCIAH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pcial</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1PCIAL</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1SA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pcix_POMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup outbound memory windows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* we only care about memory windows */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Too many ranges</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Configure the resource */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pcix_POM</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					      <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					      <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">,</span>
					      <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
					      <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
					      <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* If the resource PCI address is 0 then we have our</span>
<span class="cm">			 * ISA memory hole</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">)</span>
				<span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle ISA memory hole if not already covered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found_isa_hole</span> <span class="o">&amp;&amp;</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pcix_POM</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Legacy ISA memory support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pcix_PIMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
					      <span class="k">const</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">big_pim</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">enable_msi_hole</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sa</span><span class="p">;</span>

	<span class="cm">/* RAM is always at 0 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0LAH</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0LAL</span><span class="p">);</span>

	<span class="cm">/* Calculate window size */</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffu</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sa</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
		<span class="n">sa</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_msi_hole</span><span class="p">)</span>
		<span class="n">sa</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0SA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">big_pim</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0SAH</span><span class="p">);</span>

	<span class="cm">/* Map on PCI side */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_BAR0H</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_BAR0L</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x0006</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_COMMAND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_probe_pcix_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">rsrc_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">rsrc_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">dma_window</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus_range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">big_pim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">primary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Fetch config space registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsrc_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:Can&#39;t get PCI-X config register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fetch host bridge internal registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsrc_reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get PCI-X internal register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if it supports large PIMs (440GX) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;large-inbound-windows&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">big_pim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check if we should enable MSIs inbound hole */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;enable-msi-hole&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">msi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check if primary bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">primary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get bus range if any */</span>
	<span class="n">bus_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;bus-range&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Map registers */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rsrc_reg</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsrc_reg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map registers !&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the host controller data structure */</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="n">pcibios_alloc_controller</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Setup config space */</span>
	<span class="n">setup_indirect_pci</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">rsrc_cfg</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rsrc_cfg</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
					<span class="n">PPC_INDIRECT_TYPE_SET_CFG_TYPE</span><span class="p">);</span>

	<span class="cm">/* Disable all windows */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM0SA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM1SA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_POM2SA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0SA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM1SA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM2SA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">big_pim</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM0SAH</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">PCIX0_PIM2SAH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Parse outbound mapping resources */</span>
	<span class="n">pci_process_bridge_OF_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>

	<span class="cm">/* Parse inbound mapping resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_parse_dma_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Configure outbound ranges POMs */</span>
	<span class="n">ppc4xx_configure_pcix_POMs</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Configure inbound ranges PIMs */</span>
	<span class="n">ppc4xx_configure_pcix_PIMs</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">,</span> <span class="n">big_pim</span><span class="p">,</span> <span class="n">msi</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t need the registers anymore */</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="p">)</span>
		<span class="n">pcibios_free_controller</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC4xx_PCI_EXPRESS</span>

<span class="cm">/*</span>
<span class="cm"> * 4xx PCI-Express part</span>
<span class="cm"> *</span>
<span class="cm"> * We support 3 parts currently based on the compatible property:</span>
<span class="cm"> *</span>
<span class="cm"> * ibm,plb-pciex-440spe</span>
<span class="cm"> * ibm,plb-pciex-405ex</span>
<span class="cm"> * ibm,plb-pciex-460ex</span>
<span class="cm"> *</span>
<span class="cm"> * Anything else will be rejected for now as they are all subtly</span>
<span class="cm"> * different unfortunately.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define MAX_PCIE_BUS_MAPPED	0x40</span>

<span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span>	<span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span>	<span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">link</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">has_ibpre</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">sdr_base</span><span class="p">;</span>
	<span class="n">dcr_host_t</span>		<span class="n">dcrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">cfg_space</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">utl_regs</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">utl_base</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">ppc4xx_pciex_ports</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ppc4xx_pciex_port_count</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">want_sdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">core_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">port_init_hw</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">setup_utl</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">check_link</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="o">*</span><span class="n">ppc4xx_pciex_hwops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sdr_offset</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">sdr_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PCIE%d: Wait on SDR %x success with tm %d (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">sdr_offset</span><span class="p">,</span> <span class="n">timeout_ms</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_port_reset_sdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Wait for reset to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PESDRn_RCSSTS</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE%d: PGRST failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_check_link_sdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: Checking link...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* Check for card presence detect if supported, if not, just wait for</span>
<span class="cm">	 * link unconditionally.</span>
<span class="cm">	 *</span>
<span class="cm">	 * note that we don&#39;t fail if there is no link, we just filter out</span>
<span class="cm">	 * config space accesses. That way, it will be easier to implement</span>
<span class="cm">	 * hotplug later on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PESDRn_LOOP</span><span class="p">,</span>
				      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;PCIE%d: Device detected, waiting for link...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PESDRn_LOOP</span><span class="p">,</span>
					     <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;PCIE%d: Link up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;PCIE%d: link is up !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: No device detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_44x</span>

<span class="cm">/* Check various reset bits of the 440SPe PCIe core */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc440spe_pciex_check_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">valPE0</span><span class="p">,</span> <span class="n">valPE1</span><span class="p">,</span> <span class="n">valPE2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* SDR0_PEGPLLLCT1 reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * the PCIe core was probably already initialised</span>
<span class="cm">		 * by firmware - let&#39;s re-reset RCSSET regs</span>
<span class="cm">		 *</span>
<span class="cm">		 * -- Shouldn&#39;t we also re-reset the whole thing ? -- BenH</span>
<span class="cm">		 */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PCIE: SDR0_PLLLCT1 already reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_440SPE_RCSSET</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_440SPE_RCSSET</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_440SPE_RCSSET</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">valPE0</span> <span class="o">=</span> <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_440SPE_RCSSET</span><span class="p">);</span>
	<span class="n">valPE1</span> <span class="o">=</span> <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_440SPE_RCSSET</span><span class="p">);</span>
	<span class="n">valPE2</span> <span class="o">=</span> <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_440SPE_RCSSET</span><span class="p">);</span>

	<span class="cm">/* SDR0_PExRCSSET rstgu */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET rstgu error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SDR0_PExRCSSET rstdl */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET rstdl error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SDR0_PExRCSSET rstpyn */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET rstpyn error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SDR0_PExRCSSET hldplb */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET hldplb error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SDR0_PExRCSSET rdy */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET rdy error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SDR0_PExRCSSET shutdown */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">valPE0</span> <span class="o">&amp;</span> <span class="mh">0x00000100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE1</span> <span class="o">&amp;</span> <span class="mh">0x00000100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">valPE2</span> <span class="o">&amp;</span> <span class="mh">0x00000100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: SDR0_PExRCSSET shutdown error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Global PCIe core initializations for 440SPe core */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc440spe_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time_out</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="cm">/* Set PLL clock receiver to LVPECL */</span>
	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>

	<span class="cm">/* Shouldn&#39;t we do all the calibration stuff etc... here ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_pciex_check_reset</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: PESDR_PLLCT2 resistance calibration &quot;</span>
		       <span class="s">&quot;failed (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT2</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* De-assert reset of PCIe PLL, wait for lock */</span>
	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">time_out</span><span class="o">--</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE: VCO output not locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PCIE initialization OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc440spe_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_LEGACY_ENDPOINT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_ROOT_PORT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LNKW_X8</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LNKW_X4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_DLPSET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET1</span><span class="p">,</span> <span class="mh">0x20222222</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_revA</span><span class="p">())</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span> <span class="mh">0x11000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL0SET1</span><span class="p">,</span> <span class="mh">0x35000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL1SET1</span><span class="p">,</span> <span class="mh">0x35000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL2SET1</span><span class="p">,</span> <span class="mh">0x35000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL3SET1</span><span class="p">,</span> <span class="mh">0x35000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL4SET1</span><span class="p">,</span>
		       <span class="mh">0x35000000</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL5SET1</span><span class="p">,</span>
		       <span class="mh">0x35000000</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL6SET1</span><span class="p">,</span>
		       <span class="mh">0x35000000</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_440SPE_HSSL7SET1</span><span class="p">,</span>
		       <span class="mh">0x35000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ppc4xx_pciex_port_reset_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc440speA_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ppc440spe_pciex_init_port_hw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc440speB_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">ppc440spe_pciex_init_port_hw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440speA_pciex_init_utl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX Check what that value means... I hate magic */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_SPECIAL</span><span class="p">,</span> <span class="mh">0x68782800</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set buffer allocations and then assert VRB and TXE.</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OUTTR</span><span class="p">,</span>   <span class="mh">0x08000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_INTR</span><span class="p">,</span>    <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OPDBSZ</span><span class="p">,</span>  <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBBSZ</span><span class="p">,</span>   <span class="mh">0x53000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPHBSZ</span><span class="p">,</span>  <span class="mh">0x08000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPDBSZ</span><span class="p">,</span>  <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_RCIRQEN</span><span class="p">,</span> <span class="mh">0x00f00000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PCTL</span><span class="p">,</span>    <span class="mh">0x80800066</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc440speB_pciex_init_utl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Report CRS to the operating system */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBCTL</span><span class="p">,</span>    <span class="mh">0x08000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc440speA_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc440spe_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">ppc440speA_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc440speA_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc4xx_pciex_check_link_sdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc440speB_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc440spe_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">ppc440speB_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc440speB_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc4xx_pciex_check_link_sdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc460ex_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do, return 2 ports */</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc460ex_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">utlset1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_LEGACY_ENDPOINT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_ROOT_PORT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LNKW_X1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">utlset1</span> <span class="o">=</span> <span class="mh">0x20000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LNKW_X4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">utlset1</span> <span class="o">=</span> <span class="mh">0x20101101</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_DLPSET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET1</span><span class="p">,</span> <span class="n">utlset1</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span> <span class="mh">0x01210000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>

		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_PHY_CTL_RST</span><span class="p">,</span><span class="mh">0x10000000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L0CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L1CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L2CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L3CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L0DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L1DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L2DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L3DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L0CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L1CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L2CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_L3CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>

		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_PHY_CTL_RST</span><span class="p">,</span><span class="mh">0x10000000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
	       <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">PESDRx_RCSSET_RSTGU</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTPYN</span><span class="p">));</span>

	<span class="cm">/* Poll for PHY reset */</span>
	<span class="cm">/* XXX FIXME add timeout */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_RSTSTA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460EX_RSTSTA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">PESDRx_RCSSET_RSTGU</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTDL</span><span class="p">))</span> <span class="o">|</span>
	       <span class="n">PESDRx_RCSSET_RSTPYN</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ppc4xx_pciex_port_reset_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc460ex_pciex_init_utl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_SPECIAL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set buffer allocations and then assert VRB and TXE.</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBCTL</span><span class="p">,</span>	<span class="mh">0x0800000c</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OUTTR</span><span class="p">,</span>	<span class="mh">0x08000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_INTR</span><span class="p">,</span>	<span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OPDBSZ</span><span class="p">,</span>	<span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBBSZ</span><span class="p">,</span>	<span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPHBSZ</span><span class="p">,</span>	<span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPDBSZ</span><span class="p">,</span>	<span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_RCIRQEN</span><span class="p">,</span><span class="mh">0x00f00000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PCTL</span><span class="p">,</span>	<span class="mh">0x80800066</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc460ex_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc460ex_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">ppc460ex_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc460ex_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc4xx_pciex_check_link_sdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">apm821xx_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Return the number of pcie port */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">apm821xx_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do a software reset on PCIe ports.</span>
<span class="cm">	 * This code is to fix the issue that pci drivers doesn&#39;t re-assign</span>
<span class="cm">	 * bus number for PCIE devices after Uboot</span>
<span class="cm">	 * scanned and configured all the buses (eg. PCIE NIC IntelPro/1000</span>
<span class="cm">	 * PT quad port, SAS LSI 1064E)</span>
<span class="cm">	 */</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_PHY_CTL_RST</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_LEGACY_ENDPOINT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_ROOT_PORT</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="n">LNKW_X1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_DLPSET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0CDRCTL</span><span class="p">,</span> <span class="mh">0x00003230</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0DRV</span><span class="p">,</span> <span class="mh">0x00000130</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_L0CLK</span><span class="p">,</span> <span class="mh">0x00000006</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_PHY_CTL_RST</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460EX_PHY_CTL_RST</span><span class="p">,</span> <span class="mh">0x30000000</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
		<span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">PESDRx_RCSSET_RSTGU</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTPYN</span><span class="p">));</span>

	<span class="cm">/* Poll for PHY reset */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">PESDR0_460EX_RSTSTA</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>	<span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: PCIE: Can&#39;t reset PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="p">(</span><span class="n">PESDRx_RCSSET_RSTGU</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTDL</span><span class="p">))</span> <span class="o">|</span>
			<span class="n">PESDRx_RCSSET_RSTPYN</span><span class="p">);</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">apm821xx_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">apm821xx_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">apm821xx_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc460ex_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_check_link_sdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc460sx_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* HSS drive amplitude */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL0DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL1DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL2DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL3DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL4DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL5DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL6DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL7DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL0DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL1DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL2DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL3DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL0DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL1DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL2DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL3DAMP</span><span class="p">,</span> <span class="mh">0xB9843211</span><span class="p">);</span>

	<span class="cm">/* HSS TX pre-emphasis */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL0COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL1COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL2COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL3COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL4COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL5COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL6COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL7COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL0COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL1COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL2COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL3COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL0COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL1COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL2COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL3COEFA</span><span class="p">,</span> <span class="mh">0xDCB98987</span><span class="p">);</span>

	<span class="cm">/* HSS TX calibration control */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSL1CALDRV</span><span class="p">,</span> <span class="mh">0x22222222</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSL1CALDRV</span><span class="p">,</span> <span class="mh">0x22220000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSL1CALDRV</span><span class="p">,</span> <span class="mh">0x22220000</span><span class="p">);</span>

	<span class="cm">/* HSS TX slew control */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSSLEW</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSSLEW</span><span class="p">,</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSSLEW</span><span class="p">,</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>

	<span class="cm">/* Set HSS PRBS enabled */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_HSSCTLSET</span><span class="p">,</span> <span class="mh">0x00001130</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_HSSCTLSET</span><span class="p">,</span> <span class="mh">0x00001130</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* De-assert PLLRESET */</span>
	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_PLLLCT2</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset DL, UTL, GPL before configuration */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR0_460SX_RCSSET</span><span class="p">,</span>
			<span class="n">PESDRx_RCSSET_RSTDL</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTGU</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_RCSSET</span><span class="p">,</span>
			<span class="n">PESDRx_RCSSET_RSTDL</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTGU</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR2_460SX_RCSSET</span><span class="p">,</span>
			<span class="n">PESDRx_RCSSET_RSTDL</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTGU</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If bifurcation is not enabled, u-boot would have disabled the</span>
<span class="cm">	 * third PCIe port</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">PESDR1_460SX_HSSCTLSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">)</span> <span class="o">==</span>
				<span class="mh">0x00000001</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: PCIE bifurcation setup successfully.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Total 3 PCIE ports are present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCI: Total 2 PCIE ports are present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc460sx_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span>
				<span class="mh">0x01000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">);</span>

	<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span>
			<span class="p">(</span><span class="n">PESDRx_RCSSET_RSTGU</span> <span class="o">|</span> <span class="n">PESDRx_RCSSET_RSTDL</span><span class="p">),</span>
			<span class="n">PESDRx_RCSSET_RSTPYN</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ppc4xx_pciex_port_reset_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc460sx_pciex_init_utl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Max 128 Bytes */</span>
	<span class="n">out_be32</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBBSZ</span><span class="p">,</span>   <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="cm">/* Assert VRB and TXE - per datasheet turn off addr validation */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PCTL</span><span class="p">,</span>  <span class="mh">0x80800000</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc460sx_pciex_check_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempt</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map internal config space !&quot;</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">in_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_460SX_DLLSTA</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">PECFG_460SX_DLLSTA_LINKUP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">attempt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attempt</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">mbase</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc460sx_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc460sx_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">ppc460sx_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc460sx_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc460sx_pciex_check_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_44x */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_40x</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc405ex_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Nothing to do, return 2 ports */</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ppc405ex_pcie_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Assert the PE0_PHY reset */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* deassert the PE0_hotreset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span> <span class="mh">0x01111000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span> <span class="mh">0x01101000</span><span class="p">);</span>

	<span class="cm">/* poll for phy !reset */</span>
	<span class="cm">/* XXX FIXME add timeout */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_405EX_PHYSTA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">))</span>
		<span class="p">;</span>

	<span class="cm">/* deassert the PE0_gpl_utl_reset */</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span> <span class="mh">0x00101000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc405ex_pciex_init_port_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_LEGACY_ENDPOINT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">PTYPE_ROOT_PORT</span><span class="p">;</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_DLPSET</span><span class="p">,</span>
	       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span> <span class="o">|</span> <span class="n">LNKW_X1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_UTLSET2</span><span class="p">,</span> <span class="mh">0x01010000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_405EX_PHYSET1</span><span class="p">,</span> <span class="mh">0x720F0000</span><span class="p">);</span>
	<span class="n">mtdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_405EX_PHYSET2</span><span class="p">,</span> <span class="mh">0x70600003</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only reset the PHY when no link is currently established.</span>
<span class="cm">	 * This is for the Atheros PCIe board which has problems to establish</span>
<span class="cm">	 * the link (again) after this PHY reset. All other currently tested</span>
<span class="cm">	 * PCIe boards don&#39;t show this problem.</span>
<span class="cm">	 * This has to be re-tested and fixed in a later release!</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">mfdcri</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_LOOP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">))</span>
		<span class="n">ppc405ex_pcie_phy_reset</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">);</span>  <span class="cm">/* guarded on */</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">has_ibpre</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ppc4xx_pciex_port_reset_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc405ex_pciex_init_utl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_SPECIAL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set buffer allocations and then assert VRB and TXE.</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OUTTR</span><span class="p">,</span>   <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_INTR</span><span class="p">,</span>    <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_OPDBSZ</span><span class="p">,</span>  <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBBSZ</span><span class="p">,</span>   <span class="mh">0x21000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPHBSZ</span><span class="p">,</span>  <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_IPDBSZ</span><span class="p">,</span>  <span class="mh">0x04000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_RCIRQEN</span><span class="p">,</span> <span class="mh">0x00f00000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PCTL</span><span class="p">,</span>    <span class="mh">0x80800066</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_PBCTL</span><span class="p">,</span>   <span class="mh">0x08000000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc405ex_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">want_sdr</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc405ex_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_init_hw</span>	<span class="o">=</span> <span class="n">ppc405ex_pciex_init_port_hw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_utl</span>	<span class="o">=</span> <span class="n">ppc405ex_pciex_init_utl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc4xx_pciex_check_link_sdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_40x */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_476FPE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc_476fpe_pciex_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc_476fpe_pciex_check_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timeout_ms</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PECFG_TLDLP_LNKUP</span><span class="o">|</span><span class="n">PECFG_TLDLP_PRESENT</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x10000000</span><span class="p">,</span>
	                              <span class="mh">0x1000</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: Checking link...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE%d: failed to get cfg space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		                    <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout_ms</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_TLDLP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PECFG_TLDLP_PRESENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: link is up !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE%d: Link up failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mbase</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ppc4xx_pciex_hwops</span> <span class="n">ppc_476fpe_pcie_hwops</span> <span class="n">__initdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">core_init</span>	<span class="o">=</span> <span class="n">ppc_476fpe_pciex_core_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_link</span>	<span class="o">=</span> <span class="n">ppc_476fpe_pciex_check_link</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_476FPE */</span><span class="cp"></span>

<span class="cm">/* Check that the core has been initied and if not, do it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_check_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">core_init</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core_init</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_44x</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-440spe&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc440spe_revA</span><span class="p">())</span>
			<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc440speA_pcie_hwops</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc440speB_pcie_hwops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-460ex&quot;</span><span class="p">))</span>
		<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc460ex_pcie_hwops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-460sx&quot;</span><span class="p">))</span>
		<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc460sx_pcie_hwops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-apm821xx&quot;</span><span class="p">))</span>
		<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">apm821xx_pcie_hwops</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_44x    */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_40x</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-405ex&quot;</span><span class="p">))</span>
		<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc405ex_pcie_hwops</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_476FPE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-476fpe&quot;</span><span class="p">))</span>
		<span class="n">ppc4xx_pciex_hwops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc_476fpe_pcie_hwops</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_hwops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE: unknown host type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">core_init</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ppc4xx_pciex_ports</span> <span class="o">=</span>
		       <span class="n">kzalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ppc4xx_pciex_port_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE: failed to allocate ports array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_port_init_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We map PCI Express configuration based on the reg property */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFGBAH</span><span class="p">,</span>
		  <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFGBAL</span><span class="p">,</span>
		  <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>

	<span class="cm">/* XXX FIXME: Use size from reg property. For now, map 512M */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFGMSK</span><span class="p">,</span> <span class="mh">0xe0000001</span><span class="p">);</span>

	<span class="cm">/* We map UTL registers based on the reg property */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_REGBAH</span><span class="p">,</span>
		  <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_regs</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_REGBAL</span><span class="p">,</span>
		  <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_regs</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>

	<span class="cm">/* XXX FIXME: Use size from reg property */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_REGMSK</span><span class="p">,</span> <span class="mh">0x00007001</span><span class="p">);</span>

	<span class="cm">/* Disable all other outbound windows */</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1MSKL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR2MSKL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR3MSKL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_MSGMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_port_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Init HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">port_init_hw</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">port_init_hw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize mapping: disable all regions and configure</span>
<span class="cm">	 * CFG and REG regions based on resources in the device tree</span>
<span class="cm">	 */</span>
	<span class="n">ppc4xx_pciex_port_init_mapping</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">check_link</span><span class="p">)</span>
		<span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">check_link</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Map UTL</span>
<span class="cm">	 */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_regs</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup UTL registers --BenH.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">setup_utl</span><span class="p">)</span>
		<span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">setup_utl</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for VC0 active or PLL Locked and assert RDY.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
				<span class="s">&quot;ibm,plb-pciex-460sx&quot;</span><span class="p">)){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span> <span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
					<span class="n">PESDRn_RCSSTS</span><span class="p">,</span>
					<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: PLL not locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">&amp;&amp;</span>
			<span class="n">ppc4xx_pciex_wait_on_sdr</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">PESDRn_RCSSTS</span><span class="p">,</span>
				<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: VC0 not active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dcri_clrset</span><span class="p">(</span><span class="n">SDR0</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">+</span> <span class="n">PESDRn_RCSSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc4xx_pciex_validate_bdf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">message</span><span class="p">;</span>

	<span class="cm">/* Endpoint can not generate upstream(remote) config cycles */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="cm">/* Check we are within the mapped range */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning! Probing bus %u&quot;</span>
			       <span class="s">&quot; out of range !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="n">message</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The root complex has only one device / function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">&amp;&amp;</span> <span class="n">devfn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="cm">/* The other side of the RC has only one device as well */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="cm">/* Check if we have a link */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">ppc4xx_pciex_get_config_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
						  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">relbus</span><span class="p">;</span>

	<span class="cm">/* Remove the casts when we finally remove the stupid volatile</span>
<span class="cm">	 * in struct pci_controller</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_addr</span><span class="p">;</span>

	<span class="n">relbus</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">-</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_data</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">relbus</span>  <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc4xx_pciex_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ppc4xx_pciex_ports</span><span class="p">[</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">indirect_type</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpl_cfg</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">hose</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_validate_bdf</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_get_config_base</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reading from configuration space of non-existing device can</span>
<span class="cm">	 * generate transaction errors. For the read duration we suppress</span>
<span class="cm">	 * assertion of machine check exceptions to avoid those.</span>
<span class="cm">	 */</span>
	<span class="n">gpl_cfg</span> <span class="o">=</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">,</span> <span class="n">gpl_cfg</span> <span class="o">|</span> <span class="n">GPL_DMER_MASK_DISA</span><span class="p">);</span>

	<span class="cm">/* Make sure no CRS is recorded */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_RCSTA</span><span class="p">,</span> <span class="mh">0x00040000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">in_le16</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">in_le32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcie-config-read: bus=%3d [%3d..%3d] devfn=0x%04x&quot;</span>
		 <span class="s">&quot; offset=0x%04x len=%d, addr=0x%p val=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span><span class="p">,</span>
		 <span class="n">devfn</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Check for CRS (440SPe rev B does that for us but heh ..) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_base</span> <span class="o">+</span> <span class="n">PEUTL_RCSTA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00040000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Got CRS !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff0001</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">,</span> <span class="n">gpl_cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ppc4xx_pciex_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pci_bus_to_host</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">ppc4xx_pciex_ports</span><span class="p">[</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">indirect_type</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpl_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_validate_bdf</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_get_config_base</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reading from configuration space of non-existing device can</span>
<span class="cm">	 * generate transaction errors. For the read duration we suppress</span>
<span class="cm">	 * assertion of machine check exceptions to avoid those.</span>
<span class="cm">	 */</span>
	<span class="n">gpl_cfg</span> <span class="o">=</span> <span class="n">dcr_read</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">);</span>
	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">,</span> <span class="n">gpl_cfg</span> <span class="o">|</span> <span class="n">GPL_DMER_MASK_DISA</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcie-config-write: bus=%3d [%3d..%3d] devfn=0x%04x&quot;</span>
		 <span class="s">&quot; offset=0x%04x len=%d, addr=0x%p val=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span><span class="p">,</span>
		 <span class="n">devfn</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">out_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">out_le16</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">out_le32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_CFG</span><span class="p">,</span> <span class="n">gpl_cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">ppc4xx_pciex_pci_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>  <span class="o">=</span> <span class="n">ppc4xx_pciex_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ppc4xx_pciex_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_setup_one_pciex_POM</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span>	<span class="o">*</span><span class="n">port</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">pci_controller</span>	<span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					     <span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">mbase</span><span class="p">,</span>
					     <span class="n">u64</span>			<span class="n">plb_addr</span><span class="p">,</span>
					     <span class="n">u64</span>			<span class="n">pci_addr</span><span class="p">,</span>
					     <span class="n">u64</span>			<span class="n">size</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">flags</span><span class="p">,</span>
					     <span class="kt">int</span>			<span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lah</span><span class="p">,</span> <span class="n">lal</span><span class="p">,</span> <span class="n">pciah</span><span class="p">,</span> <span class="n">pcial</span><span class="p">,</span> <span class="n">sa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">plb_addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Resource out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate register values */</span>
	<span class="n">lah</span> <span class="o">=</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">plb_addr</span><span class="p">);</span>
	<span class="n">lal</span> <span class="o">=</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">plb_addr</span><span class="p">);</span>
	<span class="n">pciah</span> <span class="o">=</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">pcial</span> <span class="o">=</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">pci_addr</span><span class="p">);</span>
	<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffu</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* Program register values */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM0LAH</span><span class="p">,</span> <span class="n">pciah</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM0LAL</span><span class="p">,</span> <span class="n">pcial</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1BAH</span><span class="p">,</span> <span class="n">lah</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1BAL</span><span class="p">,</span> <span class="n">lal</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1MSKH</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>
		<span class="cm">/*Enabled and single region */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-460sx&quot;</span><span class="p">))</span>
			<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1MSKL</span><span class="p">,</span>
				<span class="n">sa</span> <span class="o">|</span> <span class="n">DCRO_PEGPL_460SX_OMR1MSKL_UOT</span>
					<span class="o">|</span> <span class="n">DCRO_PEGPL_OMRxMSKL_VAL</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-476fpe&quot;</span><span class="p">))</span>
			<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1MSKL</span><span class="p">,</span>
				<span class="n">sa</span> <span class="o">|</span> <span class="n">DCRO_PEGPL_476FPE_OMR1MSKL_UOT</span>
					<span class="o">|</span> <span class="n">DCRO_PEGPL_OMRxMSKL_VAL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR1MSKL</span><span class="p">,</span>
				<span class="n">sa</span> <span class="o">|</span> <span class="n">DCRO_PEGPL_OMR1MSKL_UOT</span>
					<span class="o">|</span> <span class="n">DCRO_PEGPL_OMRxMSKL_VAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM1LAH</span><span class="p">,</span> <span class="n">pciah</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM1LAL</span><span class="p">,</span> <span class="n">pcial</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR2BAH</span><span class="p">,</span> <span class="n">lah</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR2BAL</span><span class="p">,</span> <span class="n">lal</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR2MSKH</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR2MSKL</span><span class="p">,</span>
				<span class="n">sa</span> <span class="o">|</span> <span class="n">DCRO_PEGPL_OMRxMSKL_VAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM2LAH</span><span class="p">,</span> <span class="n">pciah</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_POM2LAL</span><span class="p">,</span> <span class="n">pcial</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR3BAH</span><span class="p">,</span> <span class="n">lah</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR3BAL</span><span class="p">,</span> <span class="n">lal</span><span class="p">);</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR3MSKH</span><span class="p">,</span> <span class="mh">0x7fffffff</span><span class="p">);</span>
		<span class="cm">/* Note that 3 here means enabled | IO space !!! */</span>
		<span class="n">dcr_write</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span><span class="p">,</span> <span class="n">DCRO_PEGPL_OMR3MSKL</span><span class="p">,</span>
				<span class="n">sa</span> <span class="o">|</span> <span class="n">DCRO_PEGPL_OMR3MSKL_IO</span>
					<span class="o">|</span> <span class="n">DCRO_PEGPL_OMRxMSKL_VAL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pciex_POMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup outbound memory windows */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_resources</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* we only care about memory windows */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Too many ranges</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Configure the resource */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pciex_POM</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">,</span>
					       <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					       <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">,</span>
					       <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
					       <span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
					       <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* If the resource PCI address is 0 then we have our</span>
<span class="cm">			 * ISA memory hole</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">pci_mem_offset</span><span class="p">)</span>
				<span class="n">found_isa_hole</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle ISA memory hole if not already covered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">found_isa_hole</span> <span class="o">&amp;&amp;</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_setup_one_pciex_POM</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">,</span>
					       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">isa_mem_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Legacy ISA memory support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">dn</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="cm">/* Configure IO, always 64K starting at 0. We hard wire it to 64K !</span>
<span class="cm">	 * Note also that it -has- to be region index 2 on this HW</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_resource</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="n">ppc4xx_setup_one_pciex_POM</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">,</span>
					   <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_base_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="mh">0x10000</span><span class="p">,</span> <span class="n">IORESOURCE_IO</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_configure_pciex_PIMs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
					       <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resource_size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">sa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resource_size_t</span> <span class="n">ep_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">resource_size_t</span> <span class="n">ep_size</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

		<span class="cm">/* Currently we map a fixed 64MByte window to PLB address</span>
<span class="cm">		 * 0 (SDRAM). This should probably be configurable via a dts</span>
<span class="cm">		 * property.</span>
<span class="cm">		 */</span>

		<span class="cm">/* Calculate window size */</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffffffffffull</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">ep_size</span><span class="p">));</span>

		<span class="cm">/* Setup BAR0 */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR0HMPA</span><span class="p">,</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR0LMPA</span><span class="p">,</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span> <span class="o">|</span>
			 <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">);</span>

		<span class="cm">/* Disable BAR1 &amp; BAR2 */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR1MPA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR2HMPA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR2LMPA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM01SAH</span><span class="p">,</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM01SAL</span><span class="p">,</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>

		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">ep_addr</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">ep_addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Calculate window size */</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffffffffffffull</span> <span class="o">&lt;&lt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_PREFETCH</span><span class="p">)</span>
			<span class="n">sa</span> <span class="o">|=</span> <span class="n">PCI_BASE_ADDRESS_MEM_PREFETCH</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-460sx&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-476fpe&quot;</span><span class="p">))</span>
			<span class="n">sa</span> <span class="o">|=</span> <span class="n">PCI_BASE_ADDRESS_MEM_TYPE_64</span><span class="p">;</span>

		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR0HMPA</span><span class="p">,</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_BAR0LMPA</span><span class="p">,</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">sa</span><span class="p">));</span>

		<span class="cm">/* The setup of the split looks weird to me ... let&#39;s see</span>
<span class="cm">		 * if it works</span>
<span class="cm">		 */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM0LAL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM0LAH</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM1LAL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM1LAH</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM01SAH</span><span class="p">,</span> <span class="mh">0xffff0000</span><span class="p">);</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIM01SAL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">RES_TO_U32_LOW</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">));</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="n">RES_TO_U32_HIGH</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Enable inbound mapping */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIMEN</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Enable I/O, Mem, and Busmaster cycles */</span>
	<span class="n">out_le16</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_COMMAND</span><span class="p">,</span>
		 <span class="n">in_le16</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_COMMAND</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">PCI_COMMAND_IO</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_pciex_port_setup_hose</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">dma_window</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bus_range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">primary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">busses</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">cfg_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Check if primary bridge */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_get_property</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;primary&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">primary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Get bus range if any */</span>
	<span class="n">bus_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;bus-range&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Allocate the host controller data structure */</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="n">pcibios_alloc_controller</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* We stick the port number in &quot;indirect_type&quot; so the config space</span>
<span class="cm">	 * ops can retrieve the port data structure easily</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">indirect_type</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Get bus range */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">bus_range</span> <span class="o">?</span> <span class="n">bus_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* Because of how big mapping the config space is (1M per bus), we</span>
<span class="cm">	 * limit how many busses we support. In the long run, we could replace</span>
<span class="cm">	 * that with something akin to kmap_atomic instead. We set aside 1 bus</span>
<span class="cm">	 * for the host itself too.</span>
<span class="cm">	 */</span>
	<span class="n">busses</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">-</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">;</span> <span class="cm">/* This is off by 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">busses</span> <span class="o">&gt;</span> <span class="n">MAX_PCIE_BUS_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">busses</span> <span class="o">=</span> <span class="n">MAX_PCIE_BUS_MAPPED</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">+</span> <span class="n">busses</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only map the external config space in cfg_data for</span>
<span class="cm">		 * PCIe root-complexes. External space is 1M per bus</span>
<span class="cm">		 */</span>
		<span class="n">cfg_data</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span>
				   <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x100000</span><span class="p">,</span>
				   <span class="n">busses</span> <span class="o">*</span> <span class="mh">0x100000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map external config space !&quot;</span><span class="p">,</span>
			       <span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_data</span> <span class="o">=</span> <span class="n">cfg_data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Always map the host config space in cfg_addr.</span>
<span class="cm">	 * Internal space is 4K</span>
<span class="cm">	 */</span>
	<span class="n">mbase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t map internal config space !&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_addr</span> <span class="o">=</span> <span class="n">mbase</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PCIE %s, bus %d..%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span>
		 <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;     config space mapped at: root @0x%p, other @0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_addr</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_data</span><span class="p">);</span>

	<span class="cm">/* Setup config space */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc4xx_pciex_pci_ops</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span><span class="p">;</span>
	<span class="n">mbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">cfg_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set bus numbers on our root port</span>
<span class="cm">		 */</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_PRIMARY_BUS</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_SECONDARY_BUS</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">first_busno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">out_8</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PCI_SUBORDINATE_BUS</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">last_busno</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * OMRs are already reset, also disable PIMs</span>
<span class="cm">	 */</span>
	<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="n">PECFG_PIMEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Parse outbound mapping resources */</span>
	<span class="n">pci_process_bridge_OF_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>

	<span class="cm">/* Parse inbound mapping resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_parse_dma_ranges</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Configure outbound ranges POMs */</span>
	<span class="n">ppc4xx_configure_pciex_POMs</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">);</span>

	<span class="cm">/* Configure inbound ranges PIMs */</span>
	<span class="n">ppc4xx_configure_pciex_PIMs</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hose</span><span class="p">,</span> <span class="n">mbase</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_window</span><span class="p">);</span>

	<span class="cm">/* The root complex doesn&#39;t show up if we don&#39;t set some vendor</span>
<span class="cm">	 * and device IDs into it. The defaults below are the same bogus</span>
<span class="cm">	 * one that the initial code in arch/ppc had. This can be</span>
<span class="cm">	 * overwritten by setting the &quot;vendor-id/device-id&quot; properties</span>
<span class="cm">	 * in the pciex node.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Get the (optional) vendor-/device-id from the device-tree */</span>
	<span class="n">pval</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;vendor-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xaaa0</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xeee0</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_le16</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">pval</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device-id&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xbed0</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xfed0</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out_le16</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x202</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Enable Bus master, memory, and io space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex-460sx&quot;</span><span class="p">))</span>
		<span class="n">out_le16</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x204</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set Class Code to PCI-PCI bridge and Revision Id to 1 */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x208</span><span class="p">,</span> <span class="mh">0x06040001</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: successfully set as root-complex</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set Class Code to Processor/PPC */</span>
		<span class="n">out_le32</span><span class="p">(</span><span class="n">mbase</span> <span class="o">+</span> <span class="mh">0x208</span><span class="p">,</span> <span class="mh">0x0b200001</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: successfully set as endpoint</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="p">)</span>
		<span class="n">pcibios_free_controller</span><span class="p">(</span><span class="n">hose</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg_data</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">cfg_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mbase</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">ppc4xx_probe_pciex_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppc4xx_pciex_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">portno</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcrs</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>

	<span class="cm">/* First, proceed to core initialization as we assume there&#39;s</span>
<span class="cm">	 * only one PCIe core in the system</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_check_core_init</span><span class="p">(</span><span class="n">np</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Get the port number from the device-tree */</span>
	<span class="n">pval</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pval</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCIE: Can&#39;t find port number for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">portno</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portno</span> <span class="o">&gt;=</span> <span class="n">ppc4xx_pciex_port_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCIE: port number out of range for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ppc4xx_pciex_ports</span><span class="p">[</span><span class="n">portno</span><span class="p">];</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">portno</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if device is enabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_available</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PCIE%d: Port disabled via device-tree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span> <span class="o">=</span> <span class="n">of_node_get</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_hwops</span><span class="o">-&gt;</span><span class="n">want_sdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pval</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;sdr-base&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pval</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCIE: missing sdr-base for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">sdr_base</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if device_type property is set to &quot;pci&quot; or &quot;pci-endpoint&quot;.</span>
<span class="cm">	 * Resulting from this setup this PCIe port will be configured</span>
<span class="cm">	 * as root-complex or as endpoint.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;device_type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;pci-endpoint&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;pci&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;PCIE: missing or incorrect device_type for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Fetch config space registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">cfg_space</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get PCI-E config space !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fetch host bridge internal registers address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">utl_regs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get UTL register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Map DCRs */</span>
	<span class="n">dcrs</span> <span class="o">=</span> <span class="n">dcr_resource_start</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcrs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t get DCR register base !&quot;</span><span class="p">,</span>
		       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dcrs</span> <span class="o">=</span> <span class="n">dcr_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">dcrs</span><span class="p">,</span> <span class="n">dcr_resource_len</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Initialize the port specific registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ppc4xx_pciex_port_init</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;PCIE%d: Port init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the linux hose data structure */</span>
	<span class="n">ppc4xx_pciex_port_setup_hose</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC4xx_PCI_EXPRESS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ppc4xx_pci_find_bridges</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">pci_add_flags</span><span class="p">(</span><span class="n">PCI_ENABLE_PROC_DOMAINS</span> <span class="o">|</span> <span class="n">PCI_COMPAT_DOMAIN_0</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC4xx_PCI_EXPRESS</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pciex&quot;</span><span class="p">)</span>
		<span class="n">ppc4xx_probe_pciex_bridge</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pcix&quot;</span><span class="p">)</span>
		<span class="n">ppc4xx_probe_pcix_bridge</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;ibm,plb-pci&quot;</span><span class="p">)</span>
		<span class="n">ppc4xx_probe_pci_bridge</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">ppc4xx_pci_find_bridges</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
