<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › fsl_rmu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsl_rmu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Freescale MPC85xx/MPC86xx RapidIO RMU support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Sysgo AG</span>
<span class="cm"> * Thomas Moll &lt;thomas.moll@sysgo.com&gt;</span>
<span class="cm"> * - fixed maintenance access routines, check for aligned access</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Integrated Device Technology, Inc.</span>
<span class="cm"> * Alex Bounine &lt;alexandre.bounine@idt.com&gt;</span>
<span class="cm"> * - Added Port-Write message handling</span>
<span class="cm"> * - Added Machine Check exception handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007, 2008, 2010, 2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> * Zhang Wei &lt;wei.zhang@freescale.com&gt;</span>
<span class="cm"> * Lian Minghuan-B31939 &lt;Minghuan.Lian@freescale.com&gt;</span>
<span class="cm"> * Liu Gang &lt;Gang.Liu@freescale.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 MontaVista Software, Inc.</span>
<span class="cm"> * Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;fsl_rio.h&quot;</span>

<span class="cp">#define GET_RMM_HANDLE(mport) \</span>
<span class="cp">		(((struct rio_priv *)(mport-&gt;priv))-&gt;rmm_handle)</span>

<span class="cm">/* RapidIO definition irq, which read from OF-tree */</span>
<span class="cp">#define IRQ_RIO_PW(m)		(((struct fsl_rio_pw *)(m))-&gt;pwirq)</span>
<span class="cp">#define IRQ_RIO_BELL(m) (((struct fsl_rio_dbell *)(m))-&gt;bellirq)</span>
<span class="cp">#define IRQ_RIO_TX(m) (((struct fsl_rmu *)(GET_RMM_HANDLE(m)))-&gt;txirq)</span>
<span class="cp">#define IRQ_RIO_RX(m) (((struct fsl_rmu *)(GET_RMM_HANDLE(m)))-&gt;rxirq)</span>

<span class="cp">#define RIO_MIN_TX_RING_SIZE	2</span>
<span class="cp">#define RIO_MAX_TX_RING_SIZE	2048</span>
<span class="cp">#define RIO_MIN_RX_RING_SIZE	2</span>
<span class="cp">#define RIO_MAX_RX_RING_SIZE	2048</span>

<span class="cp">#define RIO_IPWMR_SEN		0x00100000</span>
<span class="cp">#define RIO_IPWMR_QFIE		0x00000100</span>
<span class="cp">#define RIO_IPWMR_EIE		0x00000020</span>
<span class="cp">#define RIO_IPWMR_CQ		0x00000002</span>
<span class="cp">#define RIO_IPWMR_PWE		0x00000001</span>

<span class="cp">#define RIO_IPWSR_QF		0x00100000</span>
<span class="cp">#define RIO_IPWSR_TE		0x00000080</span>
<span class="cp">#define RIO_IPWSR_QFI		0x00000010</span>
<span class="cp">#define RIO_IPWSR_PWD		0x00000008</span>
<span class="cp">#define RIO_IPWSR_PWB		0x00000004</span>

<span class="cp">#define RIO_EPWISR		0x10010</span>
<span class="cm">/* EPWISR Error match value */</span>
<span class="cp">#define RIO_EPWISR_PINT1	0x80000000</span>
<span class="cp">#define RIO_EPWISR_PINT2	0x40000000</span>
<span class="cp">#define RIO_EPWISR_MU		0x00000002</span>
<span class="cp">#define RIO_EPWISR_PW		0x00000001</span>

<span class="cp">#define IPWSR_CLEAR		0x98</span>
<span class="cp">#define OMSR_CLEAR		0x1cb3</span>
<span class="cp">#define IMSR_CLEAR		0x491</span>
<span class="cp">#define IDSR_CLEAR		0x91</span>
<span class="cp">#define ODSR_CLEAR		0x1c00</span>
<span class="cp">#define LTLEECSR_ENABLE_ALL	0xFFC000FC</span>
<span class="cp">#define RIO_LTLEECSR		0x060c</span>

<span class="cp">#define RIO_IM0SR		0x64</span>
<span class="cp">#define RIO_IM1SR		0x164</span>
<span class="cp">#define RIO_OM0SR		0x4</span>
<span class="cp">#define RIO_OM1SR		0x104</span>

<span class="cp">#define RIO_DBELL_WIN_SIZE	0x1000</span>

<span class="cp">#define RIO_MSG_OMR_MUI		0x00000002</span>
<span class="cp">#define RIO_MSG_OSR_TE		0x00000080</span>
<span class="cp">#define RIO_MSG_OSR_QOI		0x00000020</span>
<span class="cp">#define RIO_MSG_OSR_QFI		0x00000010</span>
<span class="cp">#define RIO_MSG_OSR_MUB		0x00000004</span>
<span class="cp">#define RIO_MSG_OSR_EOMI	0x00000002</span>
<span class="cp">#define RIO_MSG_OSR_QEI		0x00000001</span>

<span class="cp">#define RIO_MSG_IMR_MI		0x00000002</span>
<span class="cp">#define RIO_MSG_ISR_TE		0x00000080</span>
<span class="cp">#define RIO_MSG_ISR_QFI		0x00000010</span>
<span class="cp">#define RIO_MSG_ISR_DIQI	0x00000001</span>

<span class="cp">#define RIO_MSG_DESC_SIZE	32</span>
<span class="cp">#define RIO_MSG_BUFFER_SIZE	4096</span>

<span class="cp">#define DOORBELL_DMR_DI		0x00000002</span>
<span class="cp">#define DOORBELL_DSR_TE		0x00000080</span>
<span class="cp">#define DOORBELL_DSR_QFI	0x00000010</span>
<span class="cp">#define DOORBELL_DSR_DIQI	0x00000001</span>

<span class="cp">#define DOORBELL_MESSAGE_SIZE	0x08</span>

<span class="k">struct</span> <span class="n">rio_msg_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">omr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">osr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odqdpar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">osar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odatr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odcr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odqepar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad4</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">imr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifqdpar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ifqepar</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_dbell_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">odmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad1</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">oddpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oddatr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">odretcr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad3</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dqdpar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dqepar</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_pw_regs</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pwmr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epwqbar</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwqbar</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">rio_tx_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pad1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dport</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dattr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwcnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_msg_tx_ring</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">RIO_MAX_TX_RING_SIZE</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_buffer</span><span class="p">[</span><span class="n">RIO_MAX_TX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tx_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_msg_rx_ring</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">RIO_MAX_RX_RING_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_msg_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">msg_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_msg_tx_ring</span> <span class="n">msg_tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_msg_rx_ring</span> <span class="n">msg_rx_ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txirq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxirq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rio_dbell_msg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">pad1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">info</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_tx_handler - MPC85xx outbound message interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @dev_instance: Pointer to interrupt-specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Handles outbound message interrupts. Executes a register outbound</span>
<span class="cm"> * mailbox event handler and acks the interrupt occurrence.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fsl_rio_tx_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">osr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">osr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osr</span> <span class="o">&amp;</span> <span class="n">RIO_MSG_OSR_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RIO: outbound message transmission error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osr</span><span class="p">,</span> <span class="n">RIO_MSG_OSR_TE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osr</span> <span class="o">&amp;</span> <span class="n">RIO_MSG_OSR_QOI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RIO: outbound message queue overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osr</span><span class="p">,</span> <span class="n">RIO_MSG_OSR_QOI</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osr</span> <span class="o">&amp;</span> <span class="n">RIO_MSG_OSR_EOMI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dqp</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">odqdpar</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">dqp</span> <span class="o">-</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">outb_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcback</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">dev_id</span><span class="p">,</span>
					<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					<span class="n">slot</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Ack the end-of-message interrupt */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osr</span><span class="p">,</span> <span class="n">RIO_MSG_OSR_EOMI</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_rx_handler - MPC85xx inbound message interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @dev_instance: Pointer to interrupt-specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Handles inbound message interrupts. Executes a registered inbound</span>
<span class="cm"> * mailbox event handler and acks the interrupt occurrence.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fsl_rio_rx_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="n">isr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">RIO_MSG_ISR_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RIO: inbound message reception error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">RIO_MSG_ISR_TE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX Need to check/dispatch until queue empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">RIO_MSG_ISR_DIQI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		* Can receive messages for any mailbox/letter to that</span>
<span class="cm">		* mailbox destination. So, make the callback with an</span>
<span class="cm">		* unknown/invalid mailbox number argument.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">inb_msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mcback</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">dev_id</span><span class="p">,</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				<span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Ack the queueing interrupt */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">RIO_MSG_ISR_DIQI</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_dbell_handler - MPC85xx doorbell interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @dev_instance: Pointer to interrupt-specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Handles doorbell interrupts. Parses a list of registered</span>
<span class="cm"> * doorbell event handlers and executes a matching event handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fsl_rio_dbell_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dsr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rio_dbell</span> <span class="o">*</span><span class="n">fsl_dbell</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_dbell</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dsr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsr</span> <span class="o">&amp;</span> <span class="n">DOORBELL_DSR_TE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RIO: doorbell reception error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">,</span> <span class="n">DOORBELL_DSR_TE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsr</span> <span class="o">&amp;</span> <span class="n">DOORBELL_DSR_QFI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;RIO: doorbell queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">,</span> <span class="n">DOORBELL_DSR_QFI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX Need to check/dispatch until queue empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsr</span> <span class="o">&amp;</span> <span class="n">DOORBELL_DSR_DIQI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rio_dbell_msg</span> <span class="o">*</span><span class="n">dmsg</span> <span class="o">=</span>
			<span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">virt</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dqdpar</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pr_debug</span>
			<span class="p">(</span><span class="s">&quot;RIO: processing doorbell,&quot;</span>
			<span class="s">&quot; sid %2.2x tid %2.2x info %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PORT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dbell</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span>
						<span class="o">&lt;=</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span>
						<span class="o">&gt;=</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dinb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dinb</span><span class="p">(</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span>
						<span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
						<span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span>
				<span class="p">(</span><span class="s">&quot;RIO: spurious doorbell,&quot;</span>
				<span class="s">&quot; sid %2.2x tid %2.2x info %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">sid</span><span class="p">,</span> <span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span>
				<span class="n">dmsg</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dmr</span><span class="p">,</span> <span class="n">DOORBELL_DMR_DI</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">,</span> <span class="n">DOORBELL_DSR_DIQI</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msg_unit_error_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*XXX: Error recovery is not implemented, we just clear errors */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="n">RIO_IM0SR</span><span class="p">),</span> <span class="n">IMSR_CLEAR</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="n">RIO_IM1SR</span><span class="p">),</span> <span class="n">IMSR_CLEAR</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="n">RIO_OM0SR</span><span class="p">),</span> <span class="n">OMSR_CLEAR</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="n">RIO_OM1SR</span><span class="p">),</span> <span class="n">OMSR_CLEAR</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">odsr</span><span class="p">,</span> <span class="n">ODSR_CLEAR</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">,</span> <span class="n">IDSR_CLEAR</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">,</span> <span class="n">IPWSR_CLEAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_port_write_handler - MPC85xx port write interrupt handler</span>
<span class="cm"> * @irq: Linux interrupt number</span>
<span class="cm"> * @dev_instance: Pointer to interrupt-specific data</span>
<span class="cm"> *</span>
<span class="cm"> * Handles port write interrupts. Parses a list of registered</span>
<span class="cm"> * port write event handlers and executes a matching event handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fsl_rio_port_write_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ipwmr</span><span class="p">,</span> <span class="n">ipwsr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rio_pw</span> <span class="o">*</span><span class="n">pw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_pw</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_instance</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">epwisr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">epwisr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_EPWISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">epwisr</span> <span class="o">&amp;</span> <span class="n">RIO_EPWISR_PW</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">pw_done</span><span class="p">;</span>

	<span class="n">ipwmr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">);</span>
	<span class="n">ipwsr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_PW</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;PW Int-&gt;IPWMR: 0x%08x IPWSR: 0x%08x (&quot;</span><span class="p">,</span> <span class="n">ipwmr</span><span class="p">,</span> <span class="n">ipwsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_QF</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; QF&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_TE</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; TE&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_QFI</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; QFI&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_PWD</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; PWD&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_PWB</span><span class="p">)</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; PWB&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; )</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Schedule deferred processing if PW was received */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_QFI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save PW message (if there is room in FIFO),</span>
<span class="cm">		 * otherwise discard it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_avail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">RIO_PW_MSG_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">msg_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kfifo_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span>
				 <span class="n">RIO_PW_MSG_SIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">discard_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: ISR Discarded Port-Write Msg(s) (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">discard_count</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Clear interrupt and issue Clear Queue command. This allows</span>
<span class="cm">		 * another port-write to be received.</span>
<span class="cm">		 */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">,</span>	<span class="n">RIO_IPWSR_QFI</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span> <span class="n">ipwmr</span> <span class="o">|</span> <span class="n">RIO_IPWMR_CQ</span><span class="p">);</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ipwmr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWMR_EIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_TE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">err_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: Port-Write Transaction Err (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">err_count</span><span class="p">);</span>
		<span class="cm">/* Clear Transaction Error: port-write controller should be</span>
<span class="cm">		 * disabled when clearing this error</span>
<span class="cm">		 */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span> <span class="n">ipwmr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RIO_IPWMR_PWE</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">,</span>	<span class="n">RIO_IPWSR_TE</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span> <span class="n">ipwmr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipwsr</span> <span class="o">&amp;</span> <span class="n">RIO_IPWSR_PWD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">discard_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: Port Discarded Port-Write Msg(s) (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">discard_count</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">,</span> <span class="n">RIO_IPWSR_PWD</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">pw_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">epwisr</span> <span class="o">&amp;</span> <span class="n">RIO_EPWISR_PINT1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_LTLEDCSR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">fsl_rio_port_error_handler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epwisr</span> <span class="o">&amp;</span> <span class="n">RIO_EPWISR_PINT2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_LTLEDCSR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">fsl_rio_port_error_handler</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epwisr</span> <span class="o">&amp;</span> <span class="n">RIO_EPWISR_MU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO_LTLEDCSR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">msg_unit_error_handler</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fsl_pw_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_rio_pw</span> <span class="o">*</span><span class="n">pw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fsl_rio_pw</span><span class="p">,</span> <span class="n">pw_work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process port-write messages</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">kfifo_out_spinlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_buffer</span><span class="p">,</span>
			 <span class="n">RIO_PW_MSG_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Process one message */</span>
<span class="cp">#ifdef DEBUG_PW</span>
		<span class="p">{</span>
		<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s : Port-Write Message:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RIO_PW_MSG_SIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">0x%02x: 0x%08x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
					 <span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; 0x%08x&quot;</span><span class="p">,</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Pass the port-write message to RIO core for processing */</span>
		<span class="n">rio_inb_pwrite_handler</span><span class="p">((</span><span class="k">union</span> <span class="n">rio_pw_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">msg_buffer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_pw_enable - enable/disable port-write interface init</span>
<span class="cm"> * @mport: Master port implementing the port write unit</span>
<span class="cm"> * @enable:    1=enable; 0=disable port-write message handling</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fsl_rio_pw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">|=</span> <span class="n">RIO_IPWMR_PWE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RIO_IPWMR_PWE</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_port_write_init - MPC85xx port write interface init</span>
<span class="cm"> * @mport: Master port implementing the port write unit</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes port write unit hardware and DMA buffer</span>
<span class="cm"> * ring. Called from fsl_rio_setup(). Returns %0 on success</span>
<span class="cm"> * or %-ENOMEM on failure.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">fsl_rio_port_write_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_pw</span> <span class="o">*</span><span class="n">pw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Following configurations require a disabled port write controller */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RIO_IPWMR_PWE</span><span class="p">);</span>

	<span class="cm">/* Initialize port write */</span>
	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">RIO_PW_MSG_SIZE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;RIO: unable allocate port write queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">err_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">discard_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Point dequeue/enqueue pointers at first entry */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">epwqbar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwqbar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;EIPWQBAR: 0x%08x IPWQBAR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">epwqbar</span><span class="p">),</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwqbar</span><span class="p">));</span>

	<span class="cm">/* Clear interrupt status IPWSR */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">RIO_IPWSR_TE</span> <span class="o">|</span> <span class="n">RIO_IPWSR_QFI</span> <span class="o">|</span> <span class="n">RIO_IPWSR_PWD</span><span class="p">));</span>

	<span class="cm">/* Configure port write contoller for snooping enable all reporting,</span>
<span class="cm">	   clear queue full */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">,</span>
		 <span class="n">RIO_IPWMR_SEN</span> <span class="o">|</span> <span class="n">RIO_IPWMR_QFIE</span> <span class="o">|</span> <span class="n">RIO_IPWMR_EIE</span> <span class="o">|</span> <span class="n">RIO_IPWMR_CQ</span><span class="p">);</span>


	<span class="cm">/* Hook up port-write handler */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_RIO_PW</span><span class="p">(</span><span class="n">pw</span><span class="p">),</span> <span class="n">fsl_rio_port_write_handler</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;port-write&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;MPC85xx RIO: unable to request inbound doorbell irq&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Enable Error Interrupt */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEECSR</span><span class="p">),</span> <span class="n">LTLEECSR_ENABLE_ALL</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_work</span><span class="p">,</span> <span class="n">fsl_pw_dpc</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_fifo</span><span class="p">,</span> <span class="n">RIO_PW_MSG_SIZE</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;FIFO allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;IPWMR: 0x%08x IPWSR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwmr</span><span class="p">),</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span><span class="o">-&gt;</span><span class="n">pwsr</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_out_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_RIO_PW</span><span class="p">(</span><span class="n">pw</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pw</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">pw</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RIO_PW_MSG_SIZE</span><span class="p">,</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span>
		<span class="n">pw</span><span class="o">-&gt;</span><span class="n">port_write_msg</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_doorbell_send - Send a MPC85xx doorbell message</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapidIO interface</span>
<span class="cm"> * @destid: Destination ID of target device</span>
<span class="cm"> * @data: 16-bit info field of RapidIO doorbell message</span>
<span class="cm"> *</span>
<span class="cm"> * Sends a MPC85xx doorbell message. Returns %0 on success or</span>
<span class="cm"> * %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fsl_rio_doorbell_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fsl_doorbell_send: index %d destid %4.4x data %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">index</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* In the serial version silicons, such as MPC8548, MPC8641,</span>
<span class="cm">	 * below operations is must be.</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">odmr</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">odretcr</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">oddpr</span><span class="p">,</span> <span class="n">destid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">oddatr</span><span class="p">,</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">odmr</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_add_outb_message - Add message to the MPC85xx outbound message queue</span>
<span class="cm"> * @mport: Master port with outbound message queue</span>
<span class="cm"> * @rdev: Target of outbound message</span>
<span class="cm"> * @mbox: Outbound mailbox</span>
<span class="cm"> * @buffer: Message to add to outbound queue</span>
<span class="cm"> * @len: Length of message</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the @buffer message to the MPC85xx outbound message queue. Returns</span>
<span class="cm"> * %0 on success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">fsl_add_outb_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rio_dev</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">omr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_tx_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_tx_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span>
					<span class="o">+</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: fsl_add_outb_message(): destid %4.4x mbox %d buffer &quot;</span> \
		 <span class="s">&quot;%p len %8.8zx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span><span class="p">,</span> <span class="n">mbox</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy and clear rest of buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">],</span> <span class="n">buffer</span><span class="p">,</span>
			<span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">RIO_MAX_MSG_SIZE</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">]</span>
				<span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RIO_MAX_MSG_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Set mbox field for message, and set destid */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dport</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">destid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mbox</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="cm">/* Enable EOMI interrupt and priority */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dattr</span> <span class="o">=</span> <span class="mh">0x28000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>

	<span class="cm">/* Set transfer size aligned to next power of 2 (in double words) */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">dwcnt</span> <span class="o">=</span> <span class="n">is_power_of_2</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">get_bitmask_order</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Set snooping and source buffer address */</span>
	<span class="n">desc</span><span class="o">-&gt;</span><span class="n">saddr</span> <span class="o">=</span> <span class="mh">0x00000004</span>
		<span class="o">|</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys_buffer</span><span class="p">[</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">];</span>

	<span class="cm">/* Increment enqueue pointer */</span>
	<span class="n">omr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">,</span> <span class="n">omr</span> <span class="o">|</span> <span class="n">RIO_MSG_OMR_MUI</span><span class="p">);</span>

	<span class="cm">/* Go to next descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span> <span class="o">==</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_open_outb_mbox - Initialize MPC85xx outbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the outbound message unit</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox to open</span>
<span class="cm"> * @entries: Number of entries in the outbound mailbox ring</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes buffer ring, request the outbound message interrupt,</span>
<span class="cm"> * and enables the outbound message unit. Returns %0 on success and</span>
<span class="cm"> * %-EINVAL or %-ENOMEM on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">fsl_open_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">RIO_MIN_TX_RING_SIZE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">RIO_MAX_TX_RING_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">entries</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize shadow copy ring */</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RIO_MSG_BUFFER_SIZE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
					<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">RIO_MSG_BUFFER_SIZE</span><span class="p">,</span>
							<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span>
							<span class="n">virt_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
							<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span>
							<span class="n">phys_buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize outbound message descriptor ring */</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MSG_DESC_SIZE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_dma</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MSG_DESC_SIZE</span><span class="p">);</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">tx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Point dequeue/enqueue pointers at first entry in ring */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">odqdpar</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">odqepar</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Configure for snooping */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osar</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">);</span>

	<span class="cm">/* Clear interrupt status */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">osr</span><span class="p">,</span> <span class="mh">0x000000b3</span><span class="p">);</span>

	<span class="cm">/* Hook up outbound message handler */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_RIO_TX</span><span class="p">(</span><span class="n">mport</span><span class="p">),</span> <span class="n">fsl_rio_tx_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="s">&quot;msg_tx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_irq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure outbound message unit</span>
<span class="cm">	 *      Snooping</span>
<span class="cm">	 *      Interrupts (all enabled, except QEIE)</span>
<span class="cm">	 *      Chaining mode</span>
<span class="cm">	 *      Disable</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">,</span> <span class="mh">0x00100220</span><span class="p">);</span>

	<span class="cm">/* Set number of entries */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">,</span>
		 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">)</span> <span class="o">|</span>
		 <span class="p">((</span><span class="n">get_bitmask_order</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="cm">/* Now enable the unit */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">out_irq:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MSG_DESC_SIZE</span><span class="p">,</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

<span class="nl">out_dma:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RIO_MSG_BUFFER_SIZE</span><span class="p">,</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_close_outb_mbox - Shut down MPC85xx outbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the outbound message unit</span>
<span class="cm"> * @mbox: Mailbox to close</span>
<span class="cm"> *</span>
<span class="cm"> * Disables the outbound message unit, free all buffers, and</span>
<span class="cm"> * frees the outbound message interrupt.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fsl_close_outb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="cm">/* Disable inbound message unit */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">omr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Free ring */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MSG_DESC_SIZE</span><span class="p">,</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Free interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_RIO_TX</span><span class="p">(</span><span class="n">mport</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_open_inb_mbox - Initialize MPC85xx inbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the inbound message unit</span>
<span class="cm"> * @dev_id: Device specific pointer to pass on event</span>
<span class="cm"> * @mbox: Mailbox to open</span>
<span class="cm"> * @entries: Number of entries in the inbound mailbox ring</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes buffer ring, request the inbound message interrupt,</span>
<span class="cm"> * and enables the inbound message unit. Returns %0 on success</span>
<span class="cm"> * and %-EINVAL or %-ENOMEM on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">fsl_open_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">RIO_MIN_RX_RING_SIZE</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">RIO_MAX_RX_RING_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">entries</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize client buffer ring */</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Initialize inbound message ring */</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Point dequeue/enqueue pointers at first entry in ring */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">ifqdpar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">ifqepar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Clear interrupt status */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="mh">0x00000091</span><span class="p">);</span>

	<span class="cm">/* Hook up inbound message handler */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_RIO_RX</span><span class="p">(</span><span class="n">mport</span><span class="p">),</span> <span class="n">fsl_rio_rx_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="s">&quot;msg_rx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RIO_MSG_BUFFER_SIZE</span><span class="p">,</span>
			<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_tx_ring</span><span class="p">.</span><span class="n">phys_buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure inbound message unit:</span>
<span class="cm">	 *      Snooping</span>
<span class="cm">	 *      4KB max message size</span>
<span class="cm">	 *      Unmask all interrupt sources</span>
<span class="cm">	 *      Disable</span>
<span class="cm">	 */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="mh">0x001b0060</span><span class="p">);</span>

	<span class="cm">/* Set number of queue entries */</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="p">(</span><span class="n">get_bitmask_order</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

	<span class="cm">/* Now enable the unit */</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_close_inb_mbox - Shut down MPC85xx inbound mailbox</span>
<span class="cm"> * @mport: Master port implementing the inbound message unit</span>
<span class="cm"> * @mbox: Mailbox to close</span>
<span class="cm"> *</span>
<span class="cm"> * Disables the inbound message unit, free all buffers, and</span>
<span class="cm"> * frees the inbound message interrupt.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fsl_close_inb_mbox</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="cm">/* Disable inbound message unit */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Free ring */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">,</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Free interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_RIO_RX</span><span class="p">(</span><span class="n">mport</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mport</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_add_inb_buffer - Add buffer to the MPC85xx inbound message queue</span>
<span class="cm"> * @mport: Master port implementing the inbound message unit</span>
<span class="cm"> * @mbox: Inbound mailbox number</span>
<span class="cm"> * @buf: Buffer to add to inbound queue</span>
<span class="cm"> *</span>
<span class="cm"> * Adds the @buf buffer to the MPC85xx inbound message queue. Returns</span>
<span class="cm"> * %0 on success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fsl_add_inb_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: fsl_add_inb_buffer(), msg_rx_ring.rx_slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;RIO: error adding inbound buffer %d, buffer exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span> <span class="o">==</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">rx_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_get_inb_message - Fetch inbound message from the MPC85xx message unit</span>
<span class="cm"> * @mport: Master port implementing the inbound message unit</span>
<span class="cm"> * @mbox: Inbound mailbox number</span>
<span class="cm"> *</span>
<span class="cm"> * Gets the next available inbound message from the inbound message queue.</span>
<span class="cm"> * A pointer to the message is returned on success or NULL on failure.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">fsl_get_inb_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span> <span class="o">=</span> <span class="n">GET_RMM_HANDLE</span><span class="p">(</span><span class="n">mport</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phys_buf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">virt_buf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_idx</span><span class="p">;</span>

	<span class="n">phys_buf</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">ifqdpar</span><span class="p">);</span>

	<span class="cm">/* If no more messages, then bail out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_buf</span> <span class="o">==</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">ifqepar</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>

	<span class="n">virt_buf</span> <span class="o">=</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt</span> <span class="o">+</span> <span class="p">(</span><span class="n">phys_buf</span>
						<span class="o">-</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">buf_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">phys_buf</span> <span class="o">-</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">)</span> <span class="o">/</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;RIO: inbound message copy failed, no buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy max message size, caller is expected to allocate that big */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">virt_buf</span><span class="p">,</span> <span class="n">RIO_MAX_MSG_SIZE</span><span class="p">);</span>

	<span class="cm">/* Clear the available buffer */</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_rx_ring</span><span class="p">.</span><span class="n">virt_buffer</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out1:</span>
	<span class="n">setbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span><span class="o">-&gt;</span><span class="n">imr</span><span class="p">,</span> <span class="n">RIO_MSG_IMR_MI</span><span class="p">);</span>

<span class="nl">out2:</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_doorbell_init - MPC85xx doorbell interface init</span>
<span class="cm"> * @mport: Master port implementing the inbound doorbell unit</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes doorbell unit hardware and inbound DMA buffer</span>
<span class="cm"> * ring. Called from fsl_rio_setup(). Returns %0 on success</span>
<span class="cm"> * or %-ENOMEM on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fsl_rio_doorbell_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize inbound doorbells */</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">virt</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">512</span> <span class="o">*</span>
		<span class="n">DOORBELL_MESSAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RIO: unable allocate inbound doorbell ring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Point dequeue/enqueue pointers at first entry in ring */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dqdpar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dqepar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>

	<span class="cm">/* Clear interrupt status */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dsr</span><span class="p">,</span> <span class="mh">0x00000091</span><span class="p">);</span>

	<span class="cm">/* Hook up doorbell handler */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_RIO_BELL</span><span class="p">(</span><span class="n">dbell</span><span class="p">),</span> <span class="n">fsl_rio_dbell_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="s">&quot;dbell_rx&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbell</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">DOORBELL_MESSAGE_SIZE</span><span class="p">,</span>
			 <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">virt</span><span class="p">,</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_ring</span><span class="p">.</span><span class="n">phys</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;MPC85xx RIO: unable to request inbound doorbell irq&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure doorbells for snooping, 512 entries, and enable */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span><span class="o">-&gt;</span><span class="n">dmr</span><span class="p">,</span> <span class="mh">0x00108161</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fsl_rio_setup_rmu</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsl_rmu</span> <span class="o">*</span><span class="n">rmu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msg_start</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">msg_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mport</span> <span class="o">||</span> <span class="o">!</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get %s property &#39;fsl,rmu&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rmu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rmu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aw</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
	<span class="n">msg_addr</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to find &#39;reg&#39; property of message-unit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rmu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg_start</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">msg_addr</span><span class="p">,</span> <span class="n">aw</span><span class="p">);</span>

	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">msg_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_msg_regs</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">msg_start</span><span class="p">);</span>

	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">txirq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rmu</span><span class="o">-&gt;</span><span class="n">rxirq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: txirq: %d, rxirq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">txirq</span><span class="p">,</span> <span class="n">rmu</span><span class="o">-&gt;</span><span class="n">rxirq</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rmm_handle</span> <span class="o">=</span> <span class="n">rmu</span><span class="p">;</span>

	<span class="n">rio_init_dbell_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_DOORBELL_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_INB_MBOX_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rio_init_mbox_res</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mport</span><span class="o">-&gt;</span><span class="n">riores</span><span class="p">[</span><span class="n">RIO_OUTB_MBOX_RESOURCE</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
