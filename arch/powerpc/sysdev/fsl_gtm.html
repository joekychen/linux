<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › fsl_gtm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsl_gtm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Freescale General-purpose Timers Module</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) Freescale Semicondutor, Inc. 2006.</span>
<span class="cm"> *               Shlomi Gridish &lt;gridish@freescale.com&gt;</span>
<span class="cm"> *               Jerry Huang &lt;Chang-Ming.Huang@freescale.com&gt;</span>
<span class="cm"> * Copyright (c) MontaVista Software, Inc. 2008.</span>
<span class="cm"> *               Anton Vorontsov &lt;avorontsov@ru.mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/fsl_gtm.h&gt;</span>

<span class="cp">#define GTCFR_STP(x)		((x) &amp; 1 ? 1 &lt;&lt; 5 : 1 &lt;&lt; 1)</span>
<span class="cp">#define GTCFR_RST(x)		((x) &amp; 1 ? 1 &lt;&lt; 4 : 1 &lt;&lt; 0)</span>

<span class="cp">#define GTMDR_ICLK_MASK		(3 &lt;&lt; 1)</span>
<span class="cp">#define GTMDR_ICLK_ICAS		(0 &lt;&lt; 1)</span>
<span class="cp">#define GTMDR_ICLK_ICLK		(1 &lt;&lt; 1)</span>
<span class="cp">#define GTMDR_ICLK_SLGO		(2 &lt;&lt; 1)</span>
<span class="cp">#define GTMDR_FRR		(1 &lt;&lt; 3)</span>
<span class="cp">#define GTMDR_ORI		(1 &lt;&lt; 4)</span>
<span class="cp">#define GTMDR_SPS(x)		((x) &lt;&lt; 8)</span>

<span class="k">struct</span> <span class="n">gtm_timers_regs</span> <span class="p">{</span>
	<span class="n">u8</span>	<span class="n">gtcfr1</span><span class="p">;</span>		<span class="cm">/* Timer 1, Timer 2 global config register */</span>
	<span class="n">u8</span>	<span class="n">res0</span><span class="p">[</span><span class="mh">0x3</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">gtcfr2</span><span class="p">;</span>		<span class="cm">/* Timer 3, timer 4 global config register */</span>
	<span class="n">u8</span>	<span class="n">res1</span><span class="p">[</span><span class="mh">0xB</span><span class="p">];</span>
	<span class="n">__be16</span>	<span class="n">gtmdr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 mode register */</span>
	<span class="n">__be16</span>	<span class="n">gtmdr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 mode register */</span>
	<span class="n">__be16</span>	<span class="n">gtrfr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 reference register */</span>
	<span class="n">__be16</span>	<span class="n">gtrfr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 reference register */</span>
	<span class="n">__be16</span>	<span class="n">gtcpr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 capture register */</span>
	<span class="n">__be16</span>	<span class="n">gtcpr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 capture register */</span>
	<span class="n">__be16</span>	<span class="n">gtcnr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 counter */</span>
	<span class="n">__be16</span>	<span class="n">gtcnr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 counter */</span>
	<span class="n">__be16</span>	<span class="n">gtmdr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 mode register */</span>
	<span class="n">__be16</span>	<span class="n">gtmdr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 mode register */</span>
	<span class="n">__be16</span>	<span class="n">gtrfr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 reference register */</span>
	<span class="n">__be16</span>	<span class="n">gtrfr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 reference register */</span>
	<span class="n">__be16</span>	<span class="n">gtcpr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 capture register */</span>
	<span class="n">__be16</span>	<span class="n">gtcpr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 capture register */</span>
	<span class="n">__be16</span>	<span class="n">gtcnr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 counter */</span>
	<span class="n">__be16</span>	<span class="n">gtcnr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 counter */</span>
	<span class="n">__be16</span>	<span class="n">gtevr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 event register */</span>
	<span class="n">__be16</span>	<span class="n">gtevr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 event register */</span>
	<span class="n">__be16</span>	<span class="n">gtevr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 event register */</span>
	<span class="n">__be16</span>	<span class="n">gtevr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 event register */</span>
	<span class="n">__be16</span>	<span class="n">gtpsr1</span><span class="p">;</span>		<span class="cm">/* Timer 1 prescale register */</span>
	<span class="n">__be16</span>	<span class="n">gtpsr2</span><span class="p">;</span>		<span class="cm">/* Timer 2 prescale register */</span>
	<span class="n">__be16</span>	<span class="n">gtpsr3</span><span class="p">;</span>		<span class="cm">/* Timer 3 prescale register */</span>
	<span class="n">__be16</span>	<span class="n">gtpsr4</span><span class="p">;</span>		<span class="cm">/* Timer 4 prescale register */</span>
	<span class="n">u8</span> <span class="n">res2</span><span class="p">[</span><span class="mh">0x40</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">gtm</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtm_timers_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtm_timer</span> <span class="n">timers</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">gtms</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_get_timer - request GTM timer to use it with the rest of GTM API</span>
<span class="cm"> * Context:	non-IRQ</span>
<span class="cm"> *</span>
<span class="cm"> * This function reserves GTM timer for later use. It returns gtm_timer</span>
<span class="cm"> * structure to use with the rest of GTM API, you should use timer-&gt;irq</span>
<span class="cm"> * to manage timer interrupt.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="nf">gtm_get_timer16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtm</span> <span class="o">*</span><span class="n">gtm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gtm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtms</span><span class="p">,</span> <span class="n">list_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requested</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gtm</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_get_timer16</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_get_specific_timer - request specific GTM timer</span>
<span class="cm"> * @gtm:	specific GTM, pass here GTM&#39;s device_node-&gt;data</span>
<span class="cm"> * @timer:	specific timer number, Timer1 is 0.</span>
<span class="cm"> * Context:	non-IRQ</span>
<span class="cm"> *</span>
<span class="cm"> * This function reserves GTM timer for later use. It returns gtm_timer</span>
<span class="cm"> * structure to use with the rest of GTM API, you should use timer-&gt;irq</span>
<span class="cm"> * to manage timer interrupt.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="nf">gtm_get_specific_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm</span> <span class="o">*</span><span class="n">gtm</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EBUSY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">timer</span><span class="p">].</span><span class="n">requested</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">timer</span><span class="p">];</span>
	<span class="n">ret</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_get_specific_timer16</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_put_timer16 - release 16 bits GTM timer</span>
<span class="cm"> * @tmr:	pointer to the gtm_timer structure obtained from gtm_get_timer</span>
<span class="cm"> * Context:	any</span>
<span class="cm"> *</span>
<span class="cm"> * This function releases GTM timer so others may request it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gtm_put_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gtm_stop_timer16</span><span class="p">(</span><span class="n">tmr</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_put_timer16</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is back-end for the exported functions, it&#39;s used to reset single</span>
<span class="cm"> * timer in reference mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gtm_set_ref_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frequency</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">reference_value</span><span class="p">,</span> <span class="n">bool</span> <span class="n">free_run</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtm</span> <span class="o">*</span><span class="n">gtm</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">tmr</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prescaler</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iclk</span> <span class="o">=</span> <span class="n">GTMDR_ICLK_ICLK</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">psr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sps</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_prescaler</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* CPM2 doesn&#39;t have primary prescaler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtpsr</span><span class="p">)</span>
		<span class="n">max_prescaler</span> <span class="o">/=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="n">prescaler</span> <span class="o">=</span> <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have two 8 bit prescalers -- primary and secondary (psr, sps),</span>
<span class="cm">	 * plus &quot;slow go&quot; mode (clk / 16). So, total prescale value is</span>
<span class="cm">	 * 16 * (psr + 1) * (sps + 1). Though, for CPM2 GTMs we losing psr.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prescaler</span> <span class="o">&gt;</span> <span class="n">max_prescaler</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prescaler</span> <span class="o">&gt;</span> <span class="n">max_prescaler</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iclk</span> <span class="o">=</span> <span class="n">GTMDR_ICLK_SLGO</span><span class="p">;</span>
		<span class="n">prescaler</span> <span class="o">/=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prescaler</span> <span class="o">&lt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sps</span> <span class="o">=</span> <span class="n">prescaler</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psr</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sps</span> <span class="o">=</span> <span class="n">prescaler</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Properly reset timers: stop, reset, set up prescalers, reference</span>
<span class="cm">	 * value and clear event register.</span>
<span class="cm">	 */</span>
	<span class="n">clrsetbits_8</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtcfr</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">GTCFR_STP</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">|</span> <span class="n">GTCFR_RST</span><span class="p">(</span><span class="n">num</span><span class="p">)),</span>
				 <span class="n">GTCFR_STP</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">|</span> <span class="n">GTCFR_RST</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>

	<span class="n">setbits8</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtcfr</span><span class="p">,</span> <span class="n">GTCFR_STP</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtpsr</span><span class="p">)</span>
		<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtpsr</span><span class="p">,</span> <span class="n">psr</span><span class="p">);</span>
	<span class="n">clrsetbits_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtmdr</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">iclk</span> <span class="o">|</span> <span class="n">GTMDR_SPS</span><span class="p">(</span><span class="n">sps</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GTMDR_ORI</span> <span class="o">|</span> <span class="p">(</span><span class="n">free_run</span> <span class="o">?</span> <span class="n">GTMDR_FRR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtcnr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtrfr</span><span class="p">,</span> <span class="n">reference_value</span><span class="p">);</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtevr</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="cm">/* Let it be. */</span>
	<span class="n">clrbits8</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtcfr</span><span class="p">,</span> <span class="n">GTCFR_STP</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_set_timer16 - (re)set 16 bit timer with arbitrary precision</span>
<span class="cm"> * @tmr:	pointer to the gtm_timer structure obtained from gtm_get_timer</span>
<span class="cm"> * @usec:	timer interval in microseconds</span>
<span class="cm"> * @reload:	if set, the timer will reset upon expiry rather than</span>
<span class="cm"> *         	continue running free.</span>
<span class="cm"> * Context:	any</span>
<span class="cm"> *</span>
<span class="cm"> * This function (re)sets the GTM timer so that it counts up to the requested</span>
<span class="cm"> * interval value, and fires the interrupt when the value is reached. This</span>
<span class="cm"> * function will reduce the precision of the timer as needed in order for the</span>
<span class="cm"> * requested timeout to fit in a 16-bit register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gtm_set_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usec</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* quite obvious, frequency which is enough for µSec precision */</span>
	<span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>

	<span class="n">bit</span> <span class="o">=</span> <span class="n">fls_long</span><span class="p">(</span><span class="n">usec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">&gt;&gt;=</span> <span class="n">bit</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">usec</span> <span class="o">&gt;&gt;=</span> <span class="n">bit</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gtm_set_ref_timer16</span><span class="p">(</span><span class="n">tmr</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">usec</span><span class="p">,</span> <span class="n">reload</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_set_timer16</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_set_exact_utimer16 - (re)set 16 bits timer</span>
<span class="cm"> * @tmr:	pointer to the gtm_timer structure obtained from gtm_get_timer</span>
<span class="cm"> * @usec:	timer interval in microseconds</span>
<span class="cm"> * @reload:	if set, the timer will reset upon expiry rather than</span>
<span class="cm"> *         	continue running free.</span>
<span class="cm"> * Context:	any</span>
<span class="cm"> *</span>
<span class="cm"> * This function (re)sets GTM timer so that it counts up to the requested</span>
<span class="cm"> * interval value, and fires the interrupt when the value is reached. If reload</span>
<span class="cm"> * flag was set, timer will also reset itself upon reference value, otherwise</span>
<span class="cm"> * it continues to increment.</span>
<span class="cm"> *</span>
<span class="cm"> * The _exact_ bit in the function name states that this function will not</span>
<span class="cm"> * crop precision of the &quot;usec&quot; argument, thus usec is limited to 16 bits</span>
<span class="cm"> * (single timer width).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gtm_set_exact_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">usec</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* quite obvious, frequency which is enough for µSec precision */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can lower the frequency (and probably power consumption) by</span>
<span class="cm">	 * dividing both frequency and usec by 2 until there is no remainder.</span>
<span class="cm">	 * But we won&#39;t bother with this unless savings are measured, so just</span>
<span class="cm">	 * run the timer as is.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">gtm_set_ref_timer16</span><span class="p">(</span><span class="n">tmr</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">usec</span><span class="p">,</span> <span class="n">reload</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_set_exact_timer16</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_stop_timer16 - stop single timer</span>
<span class="cm"> * @tmr:	pointer to the gtm_timer structure obtained from gtm_get_timer</span>
<span class="cm"> * Context:	any</span>
<span class="cm"> *</span>
<span class="cm"> * This function simply stops the GTM timer.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gtm_stop_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtm</span> <span class="o">*</span><span class="n">gtm</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">tmr</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">setbits8</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtcfr</span><span class="p">,</span> <span class="n">GTCFR_STP</span><span class="p">(</span><span class="n">num</span><span class="p">));</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtevr</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_stop_timer16</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gtm_ack_timer16 - acknowledge timer event (free-run timers only)</span>
<span class="cm"> * @tmr:	pointer to the gtm_timer structure obtained from gtm_get_timer</span>
<span class="cm"> * @events:	events mask to ack</span>
<span class="cm"> * Context:	any</span>
<span class="cm"> *</span>
<span class="cm"> * Thus function used to acknowledge timer interrupt event, use it inside the</span>
<span class="cm"> * interrupt handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gtm_ack_timer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">tmr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be16</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">gtevr</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">gtm_ack_timer16</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">gtm_set_shortcuts</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">gtm_timer</span> <span class="o">*</span><span class="n">timers</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">gtm_timers_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Yeah, I don&#39;t like this either, but timers&#39; registers a bit messed,</span>
<span class="cm">	 * so we have to provide shortcuts to write timer independent code.</span>
<span class="cm">	 * Alternative option is to create gt*() accessors, but that will be</span>
<span class="cm">	 * even uglier and cryptic.</span>
<span class="cm">	 */</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtcfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcfr1</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtmdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtmdr1</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtcnr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcnr1</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtrfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtrfr1</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtevr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtevr1</span><span class="p">;</span>

	<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtcfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcfr1</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtmdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtmdr2</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtcnr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcnr2</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtrfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtrfr2</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtevr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtevr2</span><span class="p">;</span>

	<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtcfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcfr2</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtmdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtmdr3</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtcnr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcnr3</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtrfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtrfr3</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtevr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtevr3</span><span class="p">;</span>

	<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtcfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcfr2</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtmdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtmdr4</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtcnr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtcnr4</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtrfr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtrfr4</span><span class="p">;</span>
	<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtevr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtevr4</span><span class="p">;</span>

	<span class="cm">/* CPM2 doesn&#39;t have primary prescaler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;fsl,cpm2-gtm&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">timers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">gtpsr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtpsr1</span><span class="p">;</span>
		<span class="n">timers</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">gtpsr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtpsr2</span><span class="p">;</span>
		<span class="n">timers</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">gtpsr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtpsr3</span><span class="p">;</span>
		<span class="n">timers</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">gtpsr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gtpsr4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fsl_gtm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,gtm&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">gtm</span> <span class="o">*</span><span class="n">gtm</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">clock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">gtm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gtm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gtm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">clock</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clock</span> <span class="o">||</span> <span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">clock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no clock-frequency</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gtm</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="o">*</span><span class="n">clock</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">resource</span> <span class="n">irq</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">of_irq_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: not enough interrupts specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
			<span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gtm</span> <span class="o">=</span> <span class="n">gtm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gtm</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to iomap registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gtm_set_shortcuts</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">,</span> <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtm</span><span class="o">-&gt;</span><span class="n">list_node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtms</span><span class="p">);</span>

		<span class="cm">/* We don&#39;t want to lose the node and its -&gt;data */</span>
		<span class="n">np</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">gtm</span><span class="p">;</span>
		<span class="n">of_node_get</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>

		<span class="k">continue</span><span class="p">;</span>
<span class="nl">err:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gtm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">fsl_gtm_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
