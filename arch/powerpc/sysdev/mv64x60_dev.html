<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › mv64x60_dev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mv64x60_dev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Platform device setup for Marvell mv64360/mv64460 host bridges (Discovery)</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Dale Farnsworth &lt;dale@farnsworth.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 2007 (c) MontaVista, Software, Inc.  This file is licensed under</span>
<span class="cm"> * the terms of the GNU General Public License version 2.  This program</span>
<span class="cm"> * is licensed &quot;as is&quot; without any warranty of any kind, whether express</span>
<span class="cm"> * or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/mv643xx.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/of_net.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;asm/prom.h&gt;</span>

<span class="cm">/* These functions provide the necessary setup for the mv64x60 drivers. */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">__initdata</span> <span class="n">of_mv64x60_devices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;marvell,mv64306-devctrl&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Create MPSC platform devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_mpsc_register_shared_pdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpsc_shared_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">phandle</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">mpscrouting</span><span class="p">,</span> <span class="o">*</span><span class="n">mpscintr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ph</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mpscrouting&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mpscrouting</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="o">*</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpscrouting</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">mpscrouting</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">mpscrouting</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ph</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mpscintr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mpscintr</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="o">*</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpscintr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">mpscintr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">mpscintr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">MPSC_SHARED_NAME</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_mpsc_device_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mpsc_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">phandle</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">sdma</span><span class="p">,</span> <span class="o">*</span><span class="n">brg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port_number</span><span class="p">;</span>

	<span class="cm">/* only register the shared platform device the first time through */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">mv64x60_mpsc_register_shared_pdev</span><span class="p">(</span><span class="n">np</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">of_irq_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="n">ph</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;sdma&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sdma</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="o">*</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">of_irq_to_resource</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">sdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">sdma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ph</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;brg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">brg</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="o">*</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">brg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">brg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">port_number</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">cache_mgmt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* All current revs need this set */</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">max_idle</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="cm">/* default */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;max_idle&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">max_idle</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">brg</span><span class="p">,</span> <span class="s">&quot;current-speed&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">default_baud</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="cm">/* Default is 8 bits, no parity, no flow control */</span>
	<span class="n">pdata</span><span class="p">.</span><span class="n">default_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pdata</span><span class="p">.</span><span class="n">default_parity</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>
	<span class="n">pdata</span><span class="p">.</span><span class="n">default_flow</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;chr_1&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">chr_1_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;chr_2&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">chr_2_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;chr_10&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">chr_10_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;mpcr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">mpcr_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">brg</span><span class="p">,</span> <span class="s">&quot;bcr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">bcr_val</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">brg_can_tune</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* All current revs need this set */</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">brg</span><span class="p">,</span> <span class="s">&quot;clock-src&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">brg_clk_src</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">brg</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">brg_clk_freq</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">MPSC_CTLR_NAME</span><span class="p">,</span> <span class="n">port_number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create mv64x60_eth platform devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">mv64x60_eth_register_shared_pdev</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="n">MV643XX_ETH_SHARED_NAME</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
					       <span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_eth_device_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">shared_pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mv643xx_eth_platform_data</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">phandle</span> <span class="o">*</span><span class="n">ph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
	<span class="n">of_irq_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared_pdev</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pdata</span><span class="p">.</span><span class="n">port_number</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">mac_addr</span> <span class="o">=</span> <span class="n">of_get_mac_address</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pdata</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;speed&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx_queue_size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">tx_queue_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx_queue_size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">rx_queue_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx_sram_addr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">tx_sram_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;tx_sram_size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">tx_sram_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx_sram_addr&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">rx_sram_addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;rx_sram_size&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">rx_sram_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">ph</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;phy&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ph</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">of_find_node_by_phandle</span><span class="p">(</span><span class="o">*</span><span class="n">ph</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">MV643XX_ETH_PHY_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">prop</span><span class="p">);</span>

	<span class="n">of_node_put</span><span class="p">(</span><span class="n">phy</span><span class="p">);</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">MV643XX_ETH_NAME</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create mv64x60_i2c platform devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_i2c_device_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv64xxx_i2c_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">of_irq_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">freq_m</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* default */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;freq_m&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">freq_m</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">freq_n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* default */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;freq_n&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span>
		<span class="n">pdata</span><span class="p">.</span><span class="n">freq_n</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>				<span class="cm">/* default: 1 second */</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">MV64XXX_I2C_CTLR_NAME</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create mv64x60_wdt platform devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_wdt_device_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mv64x60_wdt_pdata</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>

	<span class="n">pdata</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>			<span class="cm">/* Default: 10 seconds */</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_get_parent</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;clock-frequency&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pdata</span><span class="p">.</span><span class="n">bus_clk</span> <span class="o">=</span> <span class="o">*</span><span class="n">prop</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span> <span class="cm">/* wdt driver wants freq in MHz */</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">MV64x60_WDT_NAME</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_resources</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdata</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_device_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="o">*</span><span class="n">np2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;serial&quot;</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360-mpsc&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mv64x60_mpsc_device_setup</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">id</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to initialize MV64x60 &quot;</span>
					<span class="s">&quot;serial device %s: error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">id2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360-eth-group&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">mv64x60_eth_register_shared_pdev</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">id</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to initialize MV64x60 &quot;</span>
					<span class="s">&quot;network block %s: error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">for_each_child_of_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np2</span><span class="p">,</span>
					<span class="s">&quot;marvell,mv64360-eth&quot;</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">mv64x60_eth_device_setup</span><span class="p">(</span><span class="n">np2</span><span class="p">,</span> <span class="n">id2</span><span class="o">++</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to initialize &quot;</span>
						<span class="s">&quot;MV64x60 network device %s: &quot;</span>
						<span class="s">&quot;error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">np2</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;i2c&quot;</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360-i2c&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mv64x60_i2c_device_setup</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">id</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to initialize MV64x60 I2C &quot;</span>
					<span class="s">&quot;bus %s: error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* support up to one watchdog timer */</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360-wdt&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">mv64x60_wdt_device_setup</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">id</span><span class="p">)))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to initialize MV64x60 &quot;</span>
					<span class="s">&quot;Watchdog %s: error %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">of_node_put</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now add every node that is on the device bus */</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360&quot;</span><span class="p">)</span>
		<span class="n">of_platform_bus_probe</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">of_mv64x60_devices</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arch_initcall</span><span class="p">(</span><span class="n">mv64x60_device_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mv64x60_add_mpsc_console</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">of_chosen</span><span class="p">,</span> <span class="s">&quot;linux,stdout-path&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prop</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_mpsc</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_node_by_path</span><span class="p">(</span><span class="n">prop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_mpsc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">of_device_is_compatible</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;marvell,mv64360-mpsc&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">not_mpsc</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">not_mpsc</span><span class="p">;</span>

	<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;ttyMM&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">prop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="nl">not_mpsc:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">console_initcall</span><span class="p">(</span><span class="n">mv64x60_add_mpsc_console</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
