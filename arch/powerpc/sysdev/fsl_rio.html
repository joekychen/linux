<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › sysdev › fsl_rio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fsl_rio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Freescale MPC85xx/MPC86xx RapidIO support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Sysgo AG</span>
<span class="cm"> * Thomas Moll &lt;thomas.moll@sysgo.com&gt;</span>
<span class="cm"> * - fixed maintenance access routines, check for aligned access</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2009 Integrated Device Technology, Inc.</span>
<span class="cm"> * Alex Bounine &lt;alexandre.bounine@idt.com&gt;</span>
<span class="cm"> * - Added Port-Write message handling</span>
<span class="cm"> * - Added Machine Check exception handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007, 2008, 2010, 2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> * Zhang Wei &lt;wei.zhang@freescale.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2005 MontaVista Software, Inc.</span>
<span class="cm"> * Matt Porter &lt;mporter@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>

<span class="cp">#include &quot;fsl_rio.h&quot;</span>

<span class="cp">#undef DEBUG_PW	</span><span class="cm">/* Port-Write debugging */</span><span class="cp"></span>

<span class="cp">#define RIO_PORT1_EDCSR		0x0640</span>
<span class="cp">#define RIO_PORT2_EDCSR		0x0680</span>
<span class="cp">#define RIO_PORT1_IECSR		0x10130</span>
<span class="cp">#define RIO_PORT2_IECSR		0x101B0</span>

<span class="cp">#define RIO_GCCSR		0x13c</span>
<span class="cp">#define RIO_ESCSR		0x158</span>
<span class="cp">#define ESCSR_CLEAR		0x07120204</span>
<span class="cp">#define RIO_PORT2_ESCSR		0x178</span>
<span class="cp">#define RIO_CCSR		0x15c</span>
<span class="cp">#define RIO_LTLEDCSR_IER	0x80000000</span>
<span class="cp">#define RIO_LTLEDCSR_PRT	0x01000000</span>
<span class="cp">#define IECSR_CLEAR		0x80000000</span>
<span class="cp">#define RIO_ISR_AACR		0x10120</span>
<span class="cp">#define RIO_ISR_AACR_AA		0x1	</span><span class="cm">/* Accept All ID */</span><span class="cp"></span>

<span class="cp">#define __fsl_read_rio_config(x, addr, err, op)		\</span>
<span class="cp">	__asm__ __volatile__(				\</span>
<span class="cp">		&quot;1:	&quot;op&quot; %1,0(%2)\n&quot;		\</span>
<span class="cp">		&quot;	eieio\n&quot;			\</span>
<span class="cp">		&quot;2:\n&quot;					\</span>
<span class="cp">		&quot;.section .fixup,\&quot;ax\&quot;\n&quot;		\</span>
<span class="cp">		&quot;3:	li %1,-1\n&quot;			\</span>
<span class="cp">		&quot;	li %0,%3\n&quot;			\</span>
<span class="cp">		&quot;	b 2b\n&quot;				\</span>
<span class="cp">		&quot;.section __ex_table,\&quot;a\&quot;\n&quot;		\</span>
<span class="cp">			PPC_LONG_ALIGN &quot;\n&quot;		\</span>
<span class="cp">			PPC_LONG &quot;1b,3b\n&quot;		\</span>
<span class="cp">		&quot;.text&quot;					\</span>
<span class="cp">		: &quot;=r&quot; (err), &quot;=r&quot; (x)			\</span>
<span class="cp">		: &quot;b&quot; (addr), &quot;i&quot; (-EFAULT), &quot;0&quot; (err))</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rio_regs_win</span><span class="p">;</span>
<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">rmu_regs_win</span><span class="p">;</span>
<span class="n">resource_size_t</span> <span class="n">rio_law_start</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">fsl_rio_dbell</span> <span class="o">*</span><span class="n">dbell</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">fsl_rio_pw</span> <span class="o">*</span><span class="n">pw</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_E500</span>
<span class="kt">int</span> <span class="nf">fsl_rio_mcheck_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rio_regs_win</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_LTLEDCSR_IER</span> <span class="o">|</span> <span class="n">RIO_LTLEDCSR_PRT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check if we are prepared to handle this fault */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: %s - MC Exception handled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">);</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">),</span>
				 <span class="mi">0</span><span class="p">);</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">MSR_RI</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">fixup</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fsl_rio_mcheck_exception</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_local_config_read - Generate a MPC85xx local config space read</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @data: Value to be read into</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a MPC85xx local configuration space read. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_local_config_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fsl_local_config_read: index %d offset %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		 <span class="n">offset</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_local_config_write - Generate a MPC85xx local config space write</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @data: Value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a MPC85xx local configuration space write. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fsl_local_config_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">pr_debug</span>
		<span class="p">(</span><span class="s">&quot;fsl_local_config_write: index %d offset %8.8x data %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_config_read - Generate a MPC85xx read maintenance transaction</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @destid: Destination ID of transaction</span>
<span class="cm"> * @hopcount: Number of hops to target device</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @val: Location to be read into</span>
<span class="cm"> *</span>
<span class="cm"> * Generates a MPC85xx read maintenance transaction. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fsl_rio_config_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rval</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span>
		<span class="p">(</span><span class="s">&quot;fsl_rio_config_read:&quot;</span>
		<span class="s">&quot; index %d destid %d hopcount %d offset %8.8x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">index</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* 16MB maintenance window possible */</span>
	<span class="cm">/* allow only aligned access to maintenance registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000000</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowtar</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">destid</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hopcount</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowtear</span><span class="p">,</span> <span class="p">(</span><span class="n">destid</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_win</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_MAINT_WIN_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">__fsl_read_rio_config</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;lbz&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">__fsl_read_rio_config</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;lhz&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">__fsl_read_rio_config</span><span class="p">(</span><span class="n">rval</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="s">&quot;lwz&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;RIO: cfg_read error %d for %x:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">err</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_config_write - Generate a MPC85xx write maintenance transaction</span>
<span class="cm"> * @mport: RapidIO master port info</span>
<span class="cm"> * @index: ID of RapdiIO interface</span>
<span class="cm"> * @destid: Destination ID of transaction</span>
<span class="cm"> * @hopcount: Number of hops to target device</span>
<span class="cm"> * @offset: Offset into configuration space</span>
<span class="cm"> * @len: Length (in bytes) of the maintenance transaction</span>
<span class="cm"> * @val: Value to be written</span>
<span class="cm"> *</span>
<span class="cm"> * Generates an MPC85xx write maintenance transaction. Returns %0 on</span>
<span class="cm"> * success or %-EINVAL on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fsl_rio_config_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">mport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u16</span> <span class="n">destid</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">mport</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pr_debug</span>
		<span class="p">(</span><span class="s">&quot;fsl_rio_config_write:&quot;</span>
		<span class="s">&quot; index %d destid %d hopcount %d offset %8.8x len %d val %8.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">index</span><span class="p">,</span> <span class="n">destid</span><span class="p">,</span> <span class="n">hopcount</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* 16MB maintenance windows possible */</span>
	<span class="cm">/* allow only aligned access to maintenance registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x1000000</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowtar</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">destid</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">hopcount</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowtear</span><span class="p">,</span> <span class="p">(</span><span class="n">destid</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_win</span> <span class="o">+</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIO_MAINT_WIN_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">out_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">out_be16</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fsl_rio_port_error_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*XXX: Error recovery is not implemented, we just clear errors */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_LTLEDCSR</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_PORT1_EDCSR</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_PORT1_IECSR</span><span class="p">),</span> <span class="n">IECSR_CLEAR</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_ESCSR</span><span class="p">),</span> <span class="n">ESCSR_CLEAR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_PORT2_EDCSR</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_PORT2_IECSR</span><span class="p">),</span> <span class="n">IECSR_CLEAR</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">rio_regs_win</span> <span class="o">+</span> <span class="n">RIO_PORT2_ESCSR</span><span class="p">),</span> <span class="n">ESCSR_CLEAR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fsl_rio_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ccsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccsr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Serial phy */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ccsr</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;4&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Hardware port width: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">ccsr</span> <span class="o">&gt;&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;Single-lane 0&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;Single-lane 2&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;Four-lane&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Training connection status: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Parallel phy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ccsr</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Output port operating in 8-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ccsr</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">))</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Input port operating in 8-bit mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fsl_rio_setup - Setup Freescale PowerPC RapidIO interface</span>
<span class="cm"> * @dev: platform_device pointer</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes MPC85xx RapidIO hardware interface, configures</span>
<span class="cm"> * master port with system-specific info, and registers the</span>
<span class="cm"> * master port with the RapidIO subsystem.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fsl_rio_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rio_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_mport</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rio_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">dt_range</span><span class="p">,</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span> <span class="o">*</span><span class="n">port_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">active_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">regs</span><span class="p">,</span> <span class="n">rmu_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="o">*</span><span class="n">rmu_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ccsr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">range_start</span><span class="p">,</span> <span class="n">range_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">paw</span><span class="p">,</span> <span class="n">aw</span><span class="p">,</span> <span class="n">sw</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">rmu_np</span><span class="p">[</span><span class="n">MAX_MSG_UNIT_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device OF-Node is NULL&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get %s property &#39;reg&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Of-device full name %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Regs: %pR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">rio_regs_win</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rio_regs_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to map rio register window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_rio_regs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_ops</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_ops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">lcread</span> <span class="o">=</span> <span class="n">fsl_local_config_read</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">lcwrite</span> <span class="o">=</span> <span class="n">fsl_local_config_write</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">cread</span> <span class="o">=</span> <span class="n">fsl_rio_config_read</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">cwrite</span> <span class="o">=</span> <span class="n">fsl_rio_config_write</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">dsend</span> <span class="o">=</span> <span class="n">fsl_rio_doorbell_send</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwenable</span> <span class="o">=</span> <span class="n">fsl_rio_pw_enable</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_outb_mbox</span> <span class="o">=</span> <span class="n">fsl_open_outb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">open_inb_mbox</span> <span class="o">=</span> <span class="n">fsl_open_inb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_outb_mbox</span> <span class="o">=</span> <span class="n">fsl_close_outb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_inb_mbox</span> <span class="o">=</span> <span class="n">fsl_close_inb_mbox</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_outb_message</span> <span class="o">=</span> <span class="n">fsl_add_outb_message</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">add_inb_buffer</span> <span class="o">=</span> <span class="n">fsl_add_inb_buffer</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_inb_message</span> <span class="o">=</span> <span class="n">fsl_get_inb_message</span><span class="p">;</span>

	<span class="n">rmu_node</span> <span class="o">=</span> <span class="n">of_parse_phandle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;fsl,srio-rmu-handle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu_node</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rmu</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">rmu_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmu_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get %s property &#39;reg&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rmu_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_rmu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rmu_regs_win</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">rmu_regs</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rmu_regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rmu_regs_win</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to map rmu register window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_rmu</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">for_each_compatible_node</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,srio-msg-unit&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rmu_np</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">;</span>
		<span class="n">tmp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*set up doobell node*/</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,srio-dbell-unit&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dbell</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbell</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_dbell</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dbell</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t alloc memory for &#39;fsl_rio_dbell&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dbell</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">bellirq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bellirq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbell</span><span class="o">-&gt;</span><span class="n">bellirq</span><span class="p">);</span>

	<span class="n">aw</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">dt_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt_range</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to find &#39;reg&#39; property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range_start</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">dt_range</span><span class="p">,</span> <span class="n">aw</span><span class="p">);</span>
	<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">dbell_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_dbell_regs</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">range_start</span><span class="p">);</span>

	<span class="cm">/*set up port write node*/</span>
	<span class="n">np</span> <span class="o">=</span> <span class="n">of_find_compatible_node</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;fsl,srio-port-write-unit&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fsl_rio_pw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t alloc memory for &#39;fsl_rio_pw&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">pwirq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pwirq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pw</span><span class="o">-&gt;</span><span class="n">pwirq</span><span class="p">);</span>
	<span class="n">aw</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
	<span class="n">dt_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt_range</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to find &#39;reg&#39; property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range_start</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">dt_range</span><span class="p">,</span> <span class="n">aw</span><span class="p">);</span>
	<span class="n">pw</span><span class="o">-&gt;</span><span class="n">pw_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_pw_regs</span> <span class="o">*</span><span class="p">)(</span><span class="n">rmu_regs_win</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">range_start</span><span class="p">);</span>

	<span class="cm">/*set up ports node*/</span>
	<span class="n">for_each_child_of_node</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_index</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;cell-index&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get %s property &#39;cell-index&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dt_range</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;ranges&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dt_range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t get %s property &#39;ranges&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get node address wide */</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;#address-cells&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">)</span>
			<span class="n">aw</span> <span class="o">=</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">aw</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="cm">/* Get node size wide */</span>
		<span class="n">cell</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;#size-cells&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">)</span>
			<span class="n">sw</span> <span class="o">=</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sw</span> <span class="o">=</span> <span class="n">of_n_size_cells</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="cm">/* Get parent address wide wide */</span>
		<span class="n">paw</span> <span class="o">=</span> <span class="n">of_n_addr_cells</span><span class="p">(</span><span class="n">np</span><span class="p">);</span>
		<span class="n">range_start</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">dt_range</span> <span class="o">+</span> <span class="n">aw</span><span class="p">,</span> <span class="n">paw</span><span class="p">);</span>
		<span class="n">range_size</span> <span class="o">=</span> <span class="n">of_read_number</span><span class="p">(</span><span class="n">dt_range</span> <span class="o">+</span> <span class="n">aw</span> <span class="o">+</span> <span class="n">paw</span><span class="p">,</span> <span class="n">sw</span><span class="p">);</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: LAW start 0x%016llx, size 0x%016llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">,</span> <span class="n">range_start</span><span class="p">,</span> <span class="n">range_size</span><span class="p">);</span>

		<span class="n">port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_mport</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">port_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>

		<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rio_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can&#39;t alloc memory for &#39;priv&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dbells</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">range_start</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">range_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rio_io_win&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RIO: Error requesting master port region&quot;</span>
				<span class="s">&quot; 0x%016llx-0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;RIO mport %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">phys_efptr</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">=</span> <span class="n">rio_regs_win</span><span class="p">;</span>

		<span class="cm">/* Probe the master port phy type */</span>
		<span class="n">ccsr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">RIO_CCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ccsr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">RIO_PHY_SERIAL</span> <span class="o">:</span> <span class="n">RIO_PHY_PARALLEL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">RIO_PHY_PARALLEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RIO: Parallel PHY type, unsupported port type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RapidIO PHY type: Serial</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Checking the port training status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">RIO_ESCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %d is not ready. &quot;</span>
			<span class="s">&quot;Try to restart connection...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/* Disable ports */</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
				<span class="o">+</span> <span class="n">RIO_CCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Set 1x lane */</span>
			<span class="n">setbits32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
				<span class="o">+</span> <span class="n">RIO_CCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">);</span>
			<span class="cm">/* Enable ports */</span>
			<span class="n">setbits32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
				<span class="o">+</span> <span class="n">RIO_CCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00600000</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
					<span class="o">+</span> <span class="n">RIO_ESCSR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x20</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Port %d restart failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port %d restart success!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">fsl_rio_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ccsr</span><span class="p">);</span>

		<span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">in_be32</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">RIO_PEF_CAR</span><span class="p">))</span>
					<span class="o">&amp;</span> <span class="n">RIO_PEF_CTLS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RapidIO Common Transport System size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">sys_size</span> <span class="o">?</span> <span class="mi">65536</span> <span class="o">:</span> <span class="mi">256</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rio_register_mport</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">host_deviceid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">RIO_GCCSR</span><span class="p">,</span> <span class="n">RIO_PORT_GEN_HOST</span> <span class="o">|</span>
				<span class="n">RIO_PORT_GEN_MASTER</span> <span class="o">|</span> <span class="n">RIO_PORT_GEN_DISCOVERED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span> <span class="o">+</span> <span class="n">RIO_GCCSR</span><span class="p">,</span>
				<span class="n">RIO_PORT_GEN_MASTER</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">atmu_regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rio_atmu_regs</span> <span class="o">*</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
			<span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">RIO_ATMU_REGS_PORT1_OFFSET</span> <span class="o">:</span>
			<span class="n">RIO_ATMU_REGS_PORT2_OFFSET</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">atmu_regs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Set to receive any dist ID for serial RapidIO controller. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">RIO_PHY_SERIAL</span><span class="p">)</span>
			<span class="n">out_be32</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs_win</span>
				<span class="o">+</span> <span class="n">RIO_ISR_AACR</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mh">0x80</span><span class="p">),</span> <span class="n">RIO_ISR_AACR_AA</span><span class="p">);</span>

		<span class="cm">/* Configure maintenance transaction window */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowbar</span><span class="p">,</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_atmu_regs</span><span class="o">-&gt;</span><span class="n">rowar</span><span class="p">,</span>
			 <span class="mh">0x80077000</span> <span class="o">|</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">RIO_MAINT_WIN_SIZE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">maint_win</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">iores</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
				<span class="n">RIO_MAINT_WIN_SIZE</span><span class="p">);</span>

		<span class="n">rio_law_start</span> <span class="o">=</span> <span class="n">range_start</span><span class="p">;</span>

		<span class="n">fsl_rio_setup_rmu</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rmu_np</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">dbell</span><span class="o">-&gt;</span><span class="n">mport</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

		<span class="n">active_ports</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOLINK</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fsl_rio_doorbell_init</span><span class="p">(</span><span class="n">dbell</span><span class="p">);</span>
	<span class="n">fsl_rio_port_write_init</span><span class="p">(</span><span class="n">pw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pw</span><span class="p">);</span>
<span class="nl">err_pw:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dbell</span><span class="p">);</span>
<span class="nl">err_dbell:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">rmu_regs_win</span><span class="p">);</span>
<span class="nl">err_rmu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ops</span><span class="p">);</span>
<span class="nl">err_ops:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">rio_regs_win</span><span class="p">);</span>
<span class="nl">err_rio_regs:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The probe function for RapidIO peer-to-peer network.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fsl_of_rio_rpn_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Setting up RapidIO peer-to-peer network %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fsl_rio_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">fsl_of_rio_rpn_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,srio&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fsl_of_rio_rpn_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fsl-of-rio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">fsl_of_rio_rpn_ids</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">fsl_of_rio_rpn_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">fsl_of_rio_rpn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fsl_of_rio_rpn_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">fsl_of_rio_rpn_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
