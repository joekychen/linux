<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › book3s_pr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>book3s_pr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2009. SUSE Linux Products GmbH. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Alexander Graf &lt;agraf@suse.de&gt;</span>
<span class="cm"> *    Kevin Wolf &lt;mail@kevin-wolf.de&gt;</span>
<span class="cm"> *    Paul Mackerras &lt;paulus@samba.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * Functions relating to running KVM on Book 3S processors where</span>
<span class="cm"> * we don&#39;t have access to hypervisor mode, and we run the guest</span>
<span class="cm"> * in problem state (user mode).</span>
<span class="cm"> *</span>
<span class="cm"> * This file is derived from arch/powerpc/kvm/44x.c,</span>
<span class="cm"> * by Hollis Blanchard &lt;hollisb@us.ibm.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_book3s.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/switch_to.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>

<span class="cp">#include &quot;trace.h&quot;</span>

<span class="cm">/* #define EXIT_DEBUG */</span>
<span class="cm">/* #define DEBUG_EXT */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">kvmppc_handle_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">,</span>
			     <span class="n">ulong</span> <span class="n">msr</span><span class="p">);</span>

<span class="cm">/* Some compatibility defines */</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
<span class="cp">#define MSR_USER32 MSR_USER</span>
<span class="cp">#define MSR_USER64 MSR_USER</span>
<span class="cp">#define HW_PAGE_SIZE PAGE_SIZE</span>
<span class="cp">#define __hard_irq_disable local_irq_disable</span>
<span class="cp">#define __hard_irq_enable local_irq_enable</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb</span><span class="p">,</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slb_shadow</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">get_paca</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">,</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">get_paca</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">));</span>
	<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb_max</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slb_shadow_max</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">kvm_shadow_vcpu</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_vcpu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slb_shadow</span><span class="p">,</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_paca</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">get_paca</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">));</span>
	<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slb_shadow_max</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">slb_max</span><span class="p">;</span>
	<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_FP</span><span class="p">);</span>
	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_VEC</span><span class="p">);</span>
	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_VSX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_recalc_shadow_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">smsr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>

	<span class="cm">/* Guest MSR values */</span>
	<span class="n">smsr</span> <span class="o">&amp;=</span> <span class="n">MSR_FE0</span> <span class="o">|</span> <span class="n">MSR_FE1</span> <span class="o">|</span> <span class="n">MSR_SF</span> <span class="o">|</span> <span class="n">MSR_SE</span> <span class="o">|</span> <span class="n">MSR_BE</span> <span class="o">|</span> <span class="n">MSR_DE</span><span class="p">;</span>
	<span class="cm">/* Process MSR values */</span>
	<span class="n">smsr</span> <span class="o">|=</span> <span class="n">MSR_ME</span> <span class="o">|</span> <span class="n">MSR_RI</span> <span class="o">|</span> <span class="n">MSR_IR</span> <span class="o">|</span> <span class="n">MSR_DR</span> <span class="o">|</span> <span class="n">MSR_PR</span> <span class="o">|</span> <span class="n">MSR_EE</span><span class="p">;</span>
	<span class="cm">/* External providers the guest reserved */</span>
	<span class="n">smsr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest_owned_ext</span><span class="p">);</span>
	<span class="cm">/* 64-bit Process MSR values */</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="n">smsr</span> <span class="o">|=</span> <span class="n">MSR_ISF</span> <span class="o">|</span> <span class="n">MSR_HV</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">=</span> <span class="n">smsr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_set_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">old_msr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>

<span class="cp">#ifdef EXIT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;KVM: Set MSR to 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">msr</span> <span class="o">&amp;=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msr_mask</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">kvmppc_recalc_shadow_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_POW</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvm_vcpu_block</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">KVM_REQ_UNHALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">halt_wakeup</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Unset POW bit after we woke up */</span>
			<span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_POW</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_DR</span><span class="p">))</span> <span class="o">!=</span>
		   <span class="p">(</span><span class="n">old_msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_PR</span><span class="o">|</span><span class="n">MSR_IR</span><span class="o">|</span><span class="n">MSR_DR</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kvmppc_mmu_flush_segments</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>

		<span class="cm">/* Preload magic page segment when in kernel mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_pa</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">kvm_vcpu_arch</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DR</span><span class="p">)</span>
				<span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">magic_page_ea</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">magic_page_pa</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When switching from 32 to 64-bit, we may have a stale 32-bit</span>
<span class="cm">	 * magic page around, we need to flush it. Typically 32-bit magic</span>
<span class="cm">	 * page will be instanciated when calling into RTAS. Note: We</span>
<span class="cm">	 * assume that such transition only happens while in kernel mode,</span>
<span class="cm">	 * ie, we never transition from user 32-bit to kernel 64-bit with</span>
<span class="cm">	 * a 32-bit magic page around.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_pa</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">old_msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">old_msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* going from RTAS to normal kernel code */</span>
		<span class="n">kvmppc_mmu_pte_flush</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_pa</span><span class="p">,</span>
				     <span class="o">~</span><span class="mh">0xFFFUL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Preload FPU if it&#39;s enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_FP</span><span class="p">)</span>
		<span class="n">kvmppc_handle_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOK3S_INTERRUPT_FP_UNAVAIL</span><span class="p">,</span> <span class="n">MSR_FP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_set_pvr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pvr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">host_pvr</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BOOK3S_HFLAG_SLB</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span> <span class="o">=</span> <span class="n">pvr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pvr</span> <span class="o">&gt;=</span> <span class="mh">0x330000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pvr</span> <span class="o">&lt;</span> <span class="mh">0x70330000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvmppc_mmu_book3s_64_init</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior_explicit</span><span class="p">)</span>
			<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior</span> <span class="o">=</span> <span class="mh">0xfff00000</span><span class="p">;</span>
		<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msr_mask</span> <span class="o">=</span> <span class="mh">0xffffffffffffffffULL</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">=</span> <span class="n">KVM_CPU_3S_64</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">kvmppc_mmu_book3s_32_init</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior_explicit</span><span class="p">)</span>
			<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msr_mask</span> <span class="o">=</span> <span class="mh">0xffffffffULL</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">=</span> <span class="n">KVM_CPU_3S_32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_sanity_check</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/* If we are in hypervisor level on 970, we can tell the CPU to</span>
<span class="cm">	 * treat DCBZ as 32 bytes store */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">is_dcbz32</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mfmsr</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">MSR_HV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">,</span> <span class="s">&quot;ppc970&quot;</span><span class="p">))</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">;</span>

	<span class="cm">/* Cell performs badly if MSR_FEx are set. So let&#39;s hope nobody</span>
<span class="cm">	   really needs them in a VM on Cell and force disable them. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cur_cpu_spec</span><span class="o">-&gt;</span><span class="n">platform</span><span class="p">,</span> <span class="s">&quot;ppc-cell-be&quot;</span><span class="p">))</span>
		<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MSR_FE0</span> <span class="o">|</span> <span class="n">MSR_FE1</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
	<span class="cm">/* 32 bit Book3S always has 32 byte dcbz */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* On some CPUs we can execute paired single operations natively */</span>
	<span class="n">asm</span> <span class="p">(</span> <span class="s">&quot;mfpvr %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">host_pvr</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">host_pvr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00080200</span>:	<span class="cm">/* lonestar 2.0 */</span>
	<span class="k">case</span> <span class="mh">0x00088202</span>:	<span class="cm">/* lonestar 2.2 */</span>
	<span class="k">case</span> <span class="mh">0x70000100</span>:	<span class="cm">/* gekko 1.0 */</span>
	<span class="k">case</span> <span class="mh">0x00080100</span>:	<span class="cm">/* gekko 2.0 */</span>
	<span class="k">case</span> <span class="mh">0x00083203</span>:	<span class="cm">/* gekko 2.3a */</span>
	<span class="k">case</span> <span class="mh">0x00083213</span>:	<span class="cm">/* gekko 2.3b */</span>
	<span class="k">case</span> <span class="mh">0x00083204</span>:	<span class="cm">/* gekko 2.4 */</span>
	<span class="k">case</span> <span class="mh">0x00083214</span>:	<span class="cm">/* gekko 2.4e (8SE) - retail HW2 */</span>
	<span class="k">case</span> <span class="mh">0x00087200</span>:	<span class="cm">/* broadway */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">|=</span> <span class="n">BOOK3S_HFLAG_NATIVE_PS</span><span class="p">;</span>
		<span class="cm">/* Enable HID2.PSE - in case we need it later */</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_HID2_GEKKO</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_HID2_GEKKO</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Book3s_32 CPUs always have 32 bytes cache line size, which Linux assumes. To</span>
<span class="cm"> * make Book3s_32 Linux work on Book3s_64, we have to make sure we trap dcbz to</span>
<span class="cm"> * emulate 32 bytes dcbz length.</span>
<span class="cm"> *</span>
<span class="cm"> * The Book3s_64 inventors also realized this case and implemented a special bit</span>
<span class="cm"> * in the HID5 register, which is a hypervisor ressource. Thus we can&#39;t use it.</span>
<span class="cm"> *</span>
<span class="cm"> * My approach here is to patch the dcbz instruction on executing pages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_patch_dcbz</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvmppc_pte</span> <span class="o">*</span><span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">hpage</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hpage_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hpage</span> <span class="o">=</span> <span class="n">gfn_to_page</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">pte</span><span class="o">-&gt;</span><span class="n">raddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_error_page</span><span class="p">(</span><span class="n">hpage</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_release_page_clean</span><span class="p">(</span><span class="n">hpage</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hpage_offset</span> <span class="o">=</span> <span class="n">pte</span><span class="o">-&gt;</span><span class="n">raddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="n">hpage_offset</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFFFULL</span><span class="p">;</span>
	<span class="n">hpage_offset</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">get_page</span><span class="p">(</span><span class="n">hpage</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">hpage</span><span class="p">);</span>

	<span class="cm">/* patch dcbz into reserved instruction, so we trap */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">hpage_offset</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hpage_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">HW_PAGE_SIZE</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff0007ff</span><span class="p">)</span> <span class="o">==</span> <span class="n">INS_DCBZ</span><span class="p">)</span>
			<span class="n">page</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xfffffff7</span><span class="p">;</span>

	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="n">put_page</span><span class="p">(</span><span class="n">hpage</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_visible_gfn</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">mp_pa</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_pa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">))</span>
		<span class="n">mp_pa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">mp_pa</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mp_pa</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">unlikely</span><span class="p">((</span><span class="n">mp_pa</span> <span class="o">&amp;</span> <span class="n">KVM_PAM</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span> <span class="o">==</span> <span class="n">gfn</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">kvm_is_visible_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_handle_pagefault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			    <span class="n">ulong</span> <span class="n">eaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">BOOK3S_INTERRUPT_DATA_STORAGE</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">relocated</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_pte</span> <span class="n">pte</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_mmio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DR</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ir</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_IR</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vsid</span><span class="p">;</span>

	<span class="n">relocated</span> <span class="o">=</span> <span class="n">data</span> <span class="o">?</span> <span class="n">dr</span> <span class="o">:</span> <span class="n">ir</span><span class="p">;</span>

	<span class="cm">/* Resolve real address if translation turned on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">relocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page_found</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">xlate</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">may_execute</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">may_read</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">may_write</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">raddr</span> <span class="o">=</span> <span class="n">eaddr</span> <span class="o">&amp;</span> <span class="n">KVM_PAM</span><span class="p">;</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">eaddr</span> <span class="o">=</span> <span class="n">eaddr</span><span class="p">;</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">vpage</span> <span class="o">=</span> <span class="n">eaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_DR</span><span class="o">|</span><span class="n">MSR_IR</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pte</span><span class="p">.</span><span class="n">vpage</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">VSID_REAL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SID_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_DR</span>:
	<span class="k">case</span> <span class="n">MSR_IR</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">esid_to_vsid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span> <span class="o">&gt;&gt;</span> <span class="n">SID_SHIFT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vsid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_DR</span><span class="o">|</span><span class="n">MSR_IR</span><span class="p">))</span> <span class="o">==</span> <span class="n">MSR_DR</span><span class="p">)</span>
			<span class="n">pte</span><span class="p">.</span><span class="n">vpage</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">VSID_REAL_DR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SID_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">pte</span><span class="p">.</span><span class="n">vpage</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">VSID_REAL_IR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SID_SHIFT</span> <span class="o">-</span> <span class="mi">12</span><span class="p">));</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">vpage</span> <span class="o">|=</span> <span class="n">vsid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vsid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">page_found</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">is_dcbz32</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we do the dcbz hack, we have to NX on every execution,</span>
<span class="cm">		 * so we can patch the executing code. This renders our guest</span>
<span class="cm">		 * NX-less.</span>
<span class="cm">		 */</span>
		<span class="n">pte</span><span class="p">.</span><span class="n">may_execute</span> <span class="o">=</span> <span class="o">!</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_found</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Page not found in guest PTE entries */</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">fault_dsisr</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">shadow_srr1</span> <span class="o">&amp;</span> <span class="mh">0x00000000f8000000ULL</span><span class="p">);</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">page_found</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Storage protection */</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">fault_dsisr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSISR_NOHPTE</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">|=</span> <span class="n">DSISR_PROTFAULT</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span>
			<span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">shadow_srr1</span> <span class="o">&amp;</span> <span class="mh">0x00000000f8000000ULL</span><span class="p">;</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">page_found</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Page not found in guest SLB */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_mmio</span> <span class="o">&amp;&amp;</span>
		   <span class="n">kvmppc_visible_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">.</span><span class="n">raddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The guest&#39;s PTE is not mapped yet. Map on the host */</span>
		<span class="n">kvmppc_mmu_map_page</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sp_storage</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">is_dcbz32</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">)))</span>
			<span class="n">kvmppc_patch_dcbz</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pte</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MMIO */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">mmio_exits</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">raddr</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span> <span class="o">=</span> <span class="n">pte</span><span class="p">.</span><span class="n">eaddr</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_emulate_mmio</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">r</span> <span class="o">==</span> <span class="n">RESUME_HOST_NV</span> <span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_fpr_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="n">i</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Give up external provider (FPU, Altivec, VSX) */</span>
<span class="kt">void</span> <span class="nf">kvmppc_giveup_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">vcpu_fpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">vcpu_vsx</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vsr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">thread_fpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fpr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest_owned_ext</span> <span class="o">&amp;</span> <span class="n">msr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_EXT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Giving up ext 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSR_FP</span>:
		<span class="n">giveup_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vcpu_fpr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thread_fpr</span><span class="p">[</span><span class="n">get_fpr_index</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VEC</span>:
<span class="cp">#ifdef CONFIG_ALTIVEC</span>
		<span class="n">giveup_altivec</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">vr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vr</span><span class="p">));</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vscr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">vscr</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VSX</span>:
<span class="cp">#ifdef CONFIG_VSX</span>
		<span class="n">__giveup_vsx</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vsr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">vcpu_vsx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thread_fpr</span><span class="p">[</span><span class="n">get_fpr_index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest_owned_ext</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">kvmppc_recalc_shadow_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_read_inst</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">srr0</span> <span class="o">=</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">last_inst</span> <span class="o">=</span> <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srr0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">last_inst</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ulong</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>

		<span class="n">msr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">msr</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOK3S_INTERRUPT_INST_STORAGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EMULATE_AGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_check_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Need to do paired single emulation? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_PAIRED_SINGLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="cm">/* Read out the instruction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_read_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
		<span class="cm">/* Need to emulate */</span>
		<span class="k">return</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">EMULATE_AGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handle external providers (FPU, Altivec, VSX) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_handle_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">,</span>
			     <span class="n">ulong</span> <span class="n">msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thread_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">vcpu_fpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">vcpu_vsx</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vsr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">thread_fpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">fpr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* When we have paired singles, we emulate in software */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_PAIRED_SINGLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">msr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We already own the ext */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest_owned_ext</span> <span class="o">&amp;</span> <span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG_EXT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Loading up ext 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">msr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSR_FP</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">thread_fpr</span><span class="p">[</span><span class="n">get_fpr_index</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vcpu_fpr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">fpexc_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kvmppc_load_up_fpu</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VEC</span>:
<span class="cp">#ifdef CONFIG_ALTIVEC</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">vr</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vr</span><span class="p">));</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">vscr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vscr</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">vrsave</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">kvmppc_load_up_altivec</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSR_VSX</span>:
<span class="cp">#ifdef CONFIG_VSX</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vsr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">thread_fpr</span><span class="p">[</span><span class="n">get_fpr_index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu_vsx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">kvmppc_load_up_vsx</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest_owned_ext</span> <span class="o">|=</span> <span class="n">msr</span><span class="p">;</span>

	<span class="n">kvmppc_recalc_shadow_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_handle_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sum_exits</span><span class="o">++</span><span class="p">;</span>

	<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_UNKNOWN</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">ready_for_interrupt_injection</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* We get here with MSR.EE=0, so enable it to be a nice citizen */</span>
	<span class="n">__hard_irq_enable</span><span class="p">();</span>

	<span class="n">trace_kvm_book3s_exit</span><span class="p">(</span><span class="n">exit_nr</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="n">kvm_resched</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">exit_nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_INST_STORAGE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">ulong</span> <span class="n">shadow_srr1</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">shadow_srr1</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">pf_instruc</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
		<span class="cm">/* We set segments as unused segments when invalidating them. So</span>
<span class="cm">		 * treat the respective fault as segment fault. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">SID_SHIFT</span><span class="p">]</span> <span class="o">==</span> <span class="n">SR_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>

		<span class="cm">/* only care about PTEG not found errors, but leave NX alone */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shadow_srr1</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_handle_pagefault</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">exit_nr</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">sp_instruc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">is_dcbz32</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_DCBZ32</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * XXX If we do the dcbz hack we use the NX bit to flush&amp;patch the page,</span>
<span class="cm">			 *     so we can&#39;t use the NX bit inside the guest. Let&#39;s cross our fingers,</span>
<span class="cm">			 *     that no guest that needs the dcbz hack does NX.</span>
<span class="cm">			 */</span>
			<span class="n">kvmppc_mmu_pte_flush</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="o">~</span><span class="mh">0xFFFUL</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">shadow_srr1</span> <span class="o">&amp;</span> <span class="mh">0x58000000</span><span class="p">;</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_DATA_STORAGE</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fault_dsisr</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">fault_dsisr</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">pf_storage</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_32</span>
		<span class="cm">/* We set segments as unused segments when invalidating them. So</span>
<span class="cm">		 * treat the respective fault as segment fault. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">dar</span> <span class="o">&gt;&gt;</span> <span class="n">SID_SHIFT</span><span class="p">])</span> <span class="o">==</span> <span class="n">SR_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dar</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>

		<span class="cm">/* The only case we need to handle is missing shadow PTEs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fault_dsisr</span> <span class="o">&amp;</span> <span class="n">DSISR_NOHPTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_handle_pagefault</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">dar</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">dar</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">=</span> <span class="n">fault_dsisr</span><span class="p">;</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_DATA_SEGMENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_get_fault_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="n">BOOK3S_INTERRUPT_DATA_SEGMENT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_INST_SEGMENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_mmu_map_segment</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="n">BOOK3S_INTERRUPT_INST_SEGMENT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* We&#39;re good on these - the host merely wanted to get our attention */</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_DECREMENTER</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_HV_DECREMENTER</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">dec_exits</span><span class="o">++</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_EXTERNAL</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_EXTERNAL_LEVEL</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_EXTERNAL_HV</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">ext_intr_exits</span><span class="o">++</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_PERFMON</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_PROGRAM</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_H_EMUL_ASSIST</span>:
	<span class="p">{</span>
		<span class="k">enum</span> <span class="n">emulation_result</span> <span class="n">er</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span><span class="p">;</span>
		<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

<span class="nl">program_interrupt:</span>
		<span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">shadow_srr1</span> <span class="o">&amp;</span> <span class="mh">0x1f0000ull</span><span class="p">;</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef EXIT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Userspace triggered 0x700 exception at 0x%lx (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0007ff</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">INS_DCBZ</span> <span class="o">&amp;</span> <span class="mh">0xfffffff7</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">emulated_inst_exits</span><span class="o">++</span><span class="p">;</span>
		<span class="n">er</span> <span class="o">=</span> <span class="n">kvmppc_emulate_instruction</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">er</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EMULATE_DONE</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST_NV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMULATE_AGAIN</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMULATE_FAIL</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: emulation at %lx failed (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMULATE_DO_MMIO</span>:
			<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_MMIO</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST_NV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_SYSCALL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">papr_enabled</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x44000022</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* SC 1 papr hypercalls */</span>
			<span class="n">ulong</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_PR</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_h_pr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>

			<span class="n">run</span><span class="o">-&gt;</span><span class="n">papr_hcall</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ulong</span> <span class="n">gpr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">run</span><span class="o">-&gt;</span><span class="n">papr_hcall</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_PAPR_HCALL</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hcall_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osi_enabled</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="n">OSI_SC_MAGIC_R3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">==</span> <span class="n">OSI_SC_MAGIC_R4</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* MOL hypercalls */</span>
			<span class="n">u64</span> <span class="o">*</span><span class="n">gprs</span> <span class="o">=</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">osi</span><span class="p">.</span><span class="n">gprs</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_OSI</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">gprs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osi_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST_NV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">KVM_SC_MAGIC_R0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* KVM PV hypercalls */</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kvmppc_kvm_pv</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Guest syscalls */</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">syscall_exits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_FP_UNAVAIL</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_ALTIVEC</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_VSX</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ext_msr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">exit_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_FP_UNAVAIL</span>: <span class="n">ext_msr</span> <span class="o">=</span> <span class="n">MSR_FP</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_ALTIVEC</span>:    <span class="n">ext_msr</span> <span class="o">=</span> <span class="n">MSR_VEC</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_VSX</span>:        <span class="n">ext_msr</span> <span class="o">=</span> <span class="n">MSR_VSX</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">kvmppc_check_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EMULATE_DONE</span>:
			<span class="cm">/* everything ok - let&#39;s enable the ext */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_handle_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">,</span> <span class="n">ext_msr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EMULATE_FAIL</span>:
			<span class="cm">/* we need to emulate this instruction */</span>
			<span class="k">goto</span> <span class="n">program_interrupt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* nothing to worry about - go again */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_ALIGNMENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_read_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">=</span> <span class="n">kvmppc_alignment_dsisr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">kvmppc_alignment_dar</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_MACHINE_CHECK</span>:
	<span class="k">case</span> <span class="n">BOOK3S_INTERRUPT_TRACE</span>:
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="n">svcpu</span> <span class="o">=</span> <span class="n">svcpu_get</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">ulong</span> <span class="n">shadow_srr1</span> <span class="o">=</span> <span class="n">svcpu</span><span class="o">-&gt;</span><span class="n">shadow_srr1</span><span class="p">;</span>
		<span class="n">svcpu_put</span><span class="p">(</span><span class="n">svcpu</span><span class="p">);</span>
		<span class="cm">/* Ugh - bork here! What did we get? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;exit_nr=0x%x | pc=0x%lx | msr=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">exit_nr</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">shadow_srr1</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">RESUME_HOST</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* To avoid clobbering exit_reason, only check for signals if</span>
<span class="cm">		 * we aren&#39;t already exiting to userspace for some other</span>
<span class="cm">		 * reason. */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Interrupts could be timers for the guest which we have to</span>
<span class="cm">		 * inject again, so let&#39;s postpone them until we&#39;re in the guest</span>
<span class="cm">		 * and if we really did time things so badly, then we just exit</span>
<span class="cm">		 * again due to a host external interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">__hard_irq_disable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__hard_irq_enable</span><span class="p">();</span>
<span class="cp">#ifdef EXIT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;KVM: Going back to host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">signal_exits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTR</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* In case an interrupt came in that was triggered</span>
<span class="cm">			 * from userspace (like DEC), we need to check what</span>
<span class="cm">			 * to inject now! */</span>
			<span class="n">kvmppc_core_prepare_to_enter</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">trace_kvm_book3s_reenter</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_get_sregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="o">*</span><span class="n">vcpu3s</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">pvr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">sdr1</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sdr1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_SLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc64</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slbe</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">orige</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc64</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slbv</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">origv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">raw</span><span class="p">;</span>
			<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">raw</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_sregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="o">*</span><span class="n">vcpu3s</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kvmppc_set_pvr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">pvr</span><span class="p">);</span>

	<span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">sdr1</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">sdr1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_SLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">slbmte</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc64</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slbv</span><span class="p">,</span>
						    <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc64</span><span class="p">.</span><span class="n">slb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slbe</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmu</span><span class="p">.</span><span class="n">mtsrin</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">sr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvmppc_set_bat</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">false</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kvmppc_set_bat</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">true</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">ibat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
			<span class="n">kvmppc_set_bat</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">false</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">kvmppc_set_bat</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vcpu3s</span><span class="o">-&gt;</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">true</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ppc32</span><span class="p">.</span><span class="n">dbat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Flush the MMU after messing with the segments */</span>
	<span class="n">kvmppc_mmu_pte_flush</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_get_one_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_one_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_REG_PPC_HIOR</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_set_one_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_one_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_REG_PPC_HIOR</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
			<span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hior_explicit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_core_check_processor_compat</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="nf">kvmppc_core_vcpu_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="o">*</span><span class="n">vcpu_book3s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">vcpu_book3s</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_book3s</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_book3s_shadow_vcpu</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_vcpu</span><span class="p">;</span>

	<span class="n">vcpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kvm_vcpu_init</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_shadow_vcpu</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">__get_free_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">__GFP_ZERO</span><span class="p">);</span>
	<span class="cm">/* the real shared page fills the last 4k of our page */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">uninit_vcpu</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="cm">/* default to book3s_64 (970fx) */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span> <span class="o">=</span> <span class="mh">0x3C0301</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="cm">/* default to book3s_32 (750) */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span> <span class="o">=</span> <span class="mh">0x84202</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">kvmppc_set_pvr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">slb_nr</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">=</span> <span class="n">MSR_USER64</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kvmppc_mmu_init</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">uninit_vcpu</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vcpu</span><span class="p">;</span>

<span class="nl">uninit_vcpu:</span>
	<span class="n">kvm_vcpu_uninit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="nl">free_shadow_vcpu:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">);</span>
<span class="nl">free_vcpu:</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">vcpu_book3s</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_vcpu_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span> <span class="o">*</span><span class="n">vcpu_book3s</span> <span class="o">=</span> <span class="n">to_book3s</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
	<span class="n">kvm_vcpu_uninit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_book3s</span><span class="o">-&gt;</span><span class="n">shadow_vcpu</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">vcpu_book3s</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_vcpu_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">double</span> <span class="n">fpr</span><span class="p">[</span><span class="mi">32</span><span class="p">][</span><span class="n">TS_FPRWIDTH</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fpscr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpexc_mode</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ALTIVEC</span>
	<span class="n">vector128</span> <span class="n">vr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">vector128</span> <span class="n">vscr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">vrsave</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">used_vr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="kt">int</span> <span class="n">used_vsr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">ulong</span> <span class="n">ext_msr</span><span class="p">;</span>

	<span class="n">preempt_disable</span><span class="p">();</span>

	<span class="cm">/* Check if we can run the vcpu at all */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">sane</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTERNAL_ERROR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_core_prepare_to_enter</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupts could be timers for the guest which we have to inject</span>
<span class="cm">	 * again, so let&#39;s postpone them until we&#39;re in the guest and if we</span>
<span class="cm">	 * really did time things so badly, then we just exit again due to</span>
<span class="cm">	 * a host external interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">__hard_irq_disable</span><span class="p">();</span>

	<span class="cm">/* No need to go into the guest when all we do is going out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__hard_irq_enable</span><span class="p">();</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save FPU state in stack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_FP</span><span class="p">)</span>
		<span class="n">giveup_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">fpscr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">fpexc_mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpexc_mode</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ALTIVEC</span>
	<span class="cm">/* Save Altivec state in stack */</span>
	<span class="n">used_vr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">used_vr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used_vr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_VEC</span><span class="p">)</span>
			<span class="n">giveup_altivec</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vr</span><span class="p">));</span>
		<span class="n">vscr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vscr</span><span class="p">;</span>
		<span class="n">vrsave</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vrsave</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="cm">/* Save VSX state in stack */</span>
	<span class="n">used_vsr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">used_vsr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used_vsr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_VSX</span><span class="p">))</span>
			<span class="n">__giveup_vsx</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Remember the MSR with disabled extensions */</span>
	<span class="n">ext_msr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>

	<span class="cm">/* Preload FPU if it&#39;s enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_FP</span><span class="p">)</span>
		<span class="n">kvmppc_handle_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOK3S_INTERRUPT_FP_UNAVAIL</span><span class="p">,</span> <span class="n">MSR_FP</span><span class="p">);</span>

	<span class="n">kvm_guest_enter</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__kvmppc_vcpu_run</span><span class="p">(</span><span class="n">kvm_run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>

	<span class="n">kvm_guest_exit</span><span class="p">();</span>

	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">ext_msr</span><span class="p">;</span>

	<span class="cm">/* Make sure we save the guest FPU/Altivec/VSX state */</span>
	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_FP</span><span class="p">);</span>
	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_VEC</span><span class="p">);</span>
	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_VSX</span><span class="p">);</span>

	<span class="cm">/* Restore FPU state from stack */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">fpscr</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpexc_mode</span> <span class="o">=</span> <span class="n">fpexc_mode</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ALTIVEC</span>
	<span class="cm">/* Restore Altivec state from stack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used_vr</span> <span class="o">&amp;&amp;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">used_vr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vr</span><span class="p">,</span> <span class="n">vr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vr</span><span class="p">));</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vscr</span> <span class="o">=</span> <span class="n">vscr</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">vrsave</span> <span class="o">=</span> <span class="n">vrsave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">used_vr</span> <span class="o">=</span> <span class="n">used_vr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_VSX</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">used_vsr</span> <span class="o">=</span> <span class="n">used_vsr</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="nl">out:</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get (and clear) the dirty memory log for a memory slot.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kvm_vm_ioctl_get_dirty_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">kvm_dirty_log</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">memslot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">ga</span><span class="p">,</span> <span class="n">ga_end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">slots_lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_get_dirty_log</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_dirty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* If nothing is dirty, don&#39;t bother messing with page tables. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memslot</span> <span class="o">=</span> <span class="n">id_to_memslot</span><span class="p">(</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">memslots</span><span class="p">,</span> <span class="n">log</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>

		<span class="n">ga</span> <span class="o">=</span> <span class="n">memslot</span><span class="o">-&gt;</span><span class="n">base_gfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">ga_end</span> <span class="o">=</span> <span class="n">ga</span> <span class="o">+</span> <span class="p">(</span><span class="n">memslot</span><span class="o">-&gt;</span><span class="n">npages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

		<span class="n">kvm_for_each_vcpu</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm</span><span class="p">)</span>
			<span class="n">kvmppc_mmu_pte_pflush</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ga</span><span class="p">,</span> <span class="n">ga_end</span><span class="p">);</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">kvm_dirty_bitmap_bytes</span><span class="p">(</span><span class="n">memslot</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">memslot</span><span class="o">-&gt;</span><span class="n">dirty_bitmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">slots_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PPC64</span>
<span class="kt">int</span> <span class="nf">kvm_vm_ioctl_get_smmu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_ppc_smmu_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No flags */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* SLB is always 64 entries */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">slb_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="cm">/* Standard 4k base page size segment */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_shift</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">slb_enc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_shift</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pte_enc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Standard 16M large page size segment */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">page_shift</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">slb_enc</span> <span class="o">=</span> <span class="n">SLB_VSID_L</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">page_shift</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sps</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">enc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pte_enc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC64 */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">kvmppc_core_prepare_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_commit_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_core_init_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">spapr_tce_tables</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_destroy_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">spapr_tce_tables</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_book3s_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_book3s</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="n">THIS_MODULE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_mmu_hpte_sysinit</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_book3s_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_mmu_hpte_sysexit</span><span class="p">();</span>
	<span class="n">kvm_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">kvmppc_book3s_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">kvmppc_book3s_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
