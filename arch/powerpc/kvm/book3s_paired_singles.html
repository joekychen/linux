<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › book3s_paired_singles.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>book3s_paired_singles.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright Novell Inc 2010</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Alexander Graf &lt;agraf@suse.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/kvm.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>
<span class="cp">#include &lt;asm/disassemble.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_book3s.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_fpu.h&gt;</span>
<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/switch_to.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cm">/* #define DEBUG */</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define dprintk printk</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(...) do { } while(0);</span>
<span class="cp">#endif</span>

<span class="cp">#define OP_LFS			48</span>
<span class="cp">#define OP_LFSU			49</span>
<span class="cp">#define OP_LFD			50</span>
<span class="cp">#define OP_LFDU			51</span>
<span class="cp">#define OP_STFS			52</span>
<span class="cp">#define OP_STFSU		53</span>
<span class="cp">#define OP_STFD			54</span>
<span class="cp">#define OP_STFDU		55</span>
<span class="cp">#define OP_PSQ_L		56</span>
<span class="cp">#define OP_PSQ_LU		57</span>
<span class="cp">#define OP_PSQ_ST		60</span>
<span class="cp">#define OP_PSQ_STU		61</span>

<span class="cp">#define OP_31_LFSX		535</span>
<span class="cp">#define OP_31_LFSUX		567</span>
<span class="cp">#define OP_31_LFDX		599</span>
<span class="cp">#define OP_31_LFDUX		631</span>
<span class="cp">#define OP_31_STFSX		663</span>
<span class="cp">#define OP_31_STFSUX		695</span>
<span class="cp">#define OP_31_STFX		727</span>
<span class="cp">#define OP_31_STFUX		759</span>
<span class="cp">#define OP_31_LWIZX		887</span>
<span class="cp">#define OP_31_STFIWX		983</span>

<span class="cp">#define OP_59_FADDS		21</span>
<span class="cp">#define OP_59_FSUBS		20</span>
<span class="cp">#define OP_59_FSQRTS		22</span>
<span class="cp">#define OP_59_FDIVS		18</span>
<span class="cp">#define OP_59_FRES		24</span>
<span class="cp">#define OP_59_FMULS		25</span>
<span class="cp">#define OP_59_FRSQRTES		26</span>
<span class="cp">#define OP_59_FMSUBS		28</span>
<span class="cp">#define OP_59_FMADDS		29</span>
<span class="cp">#define OP_59_FNMSUBS		30</span>
<span class="cp">#define OP_59_FNMADDS		31</span>

<span class="cp">#define OP_63_FCMPU		0</span>
<span class="cp">#define OP_63_FCPSGN		8</span>
<span class="cp">#define OP_63_FRSP		12</span>
<span class="cp">#define OP_63_FCTIW		14</span>
<span class="cp">#define OP_63_FCTIWZ		15</span>
<span class="cp">#define OP_63_FDIV		18</span>
<span class="cp">#define OP_63_FADD		21</span>
<span class="cp">#define OP_63_FSQRT		22</span>
<span class="cp">#define OP_63_FSEL		23</span>
<span class="cp">#define OP_63_FRE		24</span>
<span class="cp">#define OP_63_FMUL		25</span>
<span class="cp">#define OP_63_FRSQRTE		26</span>
<span class="cp">#define OP_63_FMSUB		28</span>
<span class="cp">#define OP_63_FMADD		29</span>
<span class="cp">#define OP_63_FNMSUB		30</span>
<span class="cp">#define OP_63_FNMADD		31</span>
<span class="cp">#define OP_63_FCMPO		32</span>
<span class="cp">#define OP_63_MTFSB1		38 </span><span class="c1">// XXX</span>
<span class="cp">#define OP_63_FSUB		20</span>
<span class="cp">#define OP_63_FNEG		40</span>
<span class="cp">#define OP_63_MCRFS		64</span>
<span class="cp">#define OP_63_MTFSB0		70</span>
<span class="cp">#define OP_63_FMR		72</span>
<span class="cp">#define OP_63_MTFSFI		134</span>
<span class="cp">#define OP_63_FABS		264</span>
<span class="cp">#define OP_63_MFFS		583</span>
<span class="cp">#define OP_63_MTFSF		711</span>

<span class="cp">#define OP_4X_PS_CMPU0		0</span>
<span class="cp">#define OP_4X_PSQ_LX		6</span>
<span class="cp">#define OP_4XW_PSQ_STX		7</span>
<span class="cp">#define OP_4A_PS_SUM0		10</span>
<span class="cp">#define OP_4A_PS_SUM1		11</span>
<span class="cp">#define OP_4A_PS_MULS0		12</span>
<span class="cp">#define OP_4A_PS_MULS1		13</span>
<span class="cp">#define OP_4A_PS_MADDS0		14</span>
<span class="cp">#define OP_4A_PS_MADDS1		15</span>
<span class="cp">#define OP_4A_PS_DIV		18</span>
<span class="cp">#define OP_4A_PS_SUB		20</span>
<span class="cp">#define OP_4A_PS_ADD		21</span>
<span class="cp">#define OP_4A_PS_SEL		23</span>
<span class="cp">#define OP_4A_PS_RES		24</span>
<span class="cp">#define OP_4A_PS_MUL		25</span>
<span class="cp">#define OP_4A_PS_RSQRTE		26</span>
<span class="cp">#define OP_4A_PS_MSUB		28</span>
<span class="cp">#define OP_4A_PS_MADD		29</span>
<span class="cp">#define OP_4A_PS_NMSUB		30</span>
<span class="cp">#define OP_4A_PS_NMADD		31</span>
<span class="cp">#define OP_4X_PS_CMPO0		32</span>
<span class="cp">#define OP_4X_PSQ_LUX		38</span>
<span class="cp">#define OP_4XW_PSQ_STUX		39</span>
<span class="cp">#define OP_4X_PS_NEG		40</span>
<span class="cp">#define OP_4X_PS_CMPU1		64</span>
<span class="cp">#define OP_4X_PS_MR		72</span>
<span class="cp">#define OP_4X_PS_CMPO1		96</span>
<span class="cp">#define OP_4X_PS_NABS		136</span>
<span class="cp">#define OP_4X_PS_ABS		264</span>
<span class="cp">#define OP_4X_PS_MERGE00	528</span>
<span class="cp">#define OP_4X_PS_MERGE01	560</span>
<span class="cp">#define OP_4X_PS_MERGE10	592</span>
<span class="cp">#define OP_4X_PS_MERGE11	624</span>

<span class="cp">#define SCALAR_NONE		0</span>
<span class="cp">#define SCALAR_HIGH		(1 &lt;&lt; 0)</span>
<span class="cp">#define SCALAR_LOW		(1 &lt;&lt; 1)</span>
<span class="cp">#define SCALAR_NO_PS0		(1 &lt;&lt; 2)</span>
<span class="cp">#define SCALAR_NO_PS1		(1 &lt;&lt; 3)</span>

<span class="cp">#define GQR_ST_TYPE_MASK	0x00000007</span>
<span class="cp">#define GQR_ST_TYPE_SHIFT	0</span>
<span class="cp">#define GQR_ST_SCALE_MASK	0x00003f00</span>
<span class="cp">#define GQR_ST_SCALE_SHIFT	8</span>
<span class="cp">#define GQR_LD_TYPE_MASK	0x00070000</span>
<span class="cp">#define GQR_LD_TYPE_SHIFT	16</span>
<span class="cp">#define GQR_LD_SCALE_MASK	0x3f000000</span>
<span class="cp">#define GQR_LD_SCALE_SHIFT	24</span>

<span class="cp">#define GQR_QUANTIZE_FLOAT	0</span>
<span class="cp">#define GQR_QUANTIZE_U8		4</span>
<span class="cp">#define GQR_QUANTIZE_U16	5</span>
<span class="cp">#define GQR_QUANTIZE_S8		6</span>
<span class="cp">#define GQR_QUANTIZE_S16	7</span>

<span class="cp">#define FPU_LS_SINGLE		0</span>
<span class="cp">#define FPU_LS_DOUBLE		1</span>
<span class="cp">#define FPU_LS_SINGLE_LOW	2</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_sync_qpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rt</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">rt</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_inject_pf</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_store</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">dsisr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu_arch_shared</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="p">;</span>

	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">eaddr</span><span class="p">;</span>
	<span class="cm">/* Page Fault */</span>
	<span class="n">dsisr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_store</span><span class="p">)</span>
		<span class="n">shared</span><span class="o">-&gt;</span><span class="n">dsisr</span> <span class="o">=</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">dsisr</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOK3S_INTERRUPT_DATA_STORAGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ls_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ls_type</span> <span class="o">==</span> <span class="n">FPU_LS_DOUBLE</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* read from memory */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_inject_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done_load</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_MMIO_REG_FPR</span> <span class="o">|</span> <span class="n">rs</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done_load</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="cm">/* put in registers */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ls_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FPU_LS_SINGLE</span>:
		<span class="n">kvm_cvt_fd</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FPU_LS_DOUBLE</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;KVM: FPR_LD [0x%llx] at 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">,</span>
			  <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

<span class="nl">done_load:</span>
	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ls_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ls_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FPU_LS_SINGLE</span>:
		<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FPU_LS_SINGLE_LOW</span>:
		<span class="o">*</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">)</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FPU_LS_DOUBLE</span>:
		<span class="o">*</span><span class="p">((</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">)</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_st</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_inject_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;KVM: FPR_ST [0x%llx] at 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_emulate_psq_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">one</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* read from memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_ld</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_inject_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done_load</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_MMIO_REG_FPR</span> <span class="o">|</span> <span class="n">rs</span><span class="p">,</span>
					      <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">done_load</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">KVM_MMIO_REG_FQPR</span> <span class="o">|</span> <span class="n">rs</span><span class="p">,</span>
					      <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done_load</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="cm">/* put in registers */</span>
	<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">rs</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;KVM: PSQ_LD [0x%x, 0x%x] at 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			  <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>

<span class="nl">done_load:</span>
	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_emulate_psq_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">rs</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bool</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">w</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">);</span>

	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">rs</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">rs</span><span class="p">];</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_st</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_inject_pf</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;KVM: PSQ_ST [0x%x, 0x%x] at 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cuts out inst bits with ordering according to spec.</span>
<span class="cm"> * That means the leftmost bit is zero. All given bits are included.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">inst_get_field</span><span class="p">(</span><span class="n">u32</span> <span class="n">inst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lsb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvmppc_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">msb</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lsb</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Replaces inst bits with ordering according to spec.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">inst_set_field</span><span class="p">(</span><span class="n">u32</span> <span class="n">inst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lsb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvmppc_set_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">msb</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lsb</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">kvmppc_inst_is_paired_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hflags</span> <span class="o">&amp;</span> <span class="n">BOOK3S_HFLAG_PAIRED_SINGLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">get_op</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OP_PSQ_L</span>:
	<span class="k">case</span> <span class="n">OP_PSQ_LU</span>:
	<span class="k">case</span> <span class="n">OP_PSQ_ST</span>:
	<span class="k">case</span> <span class="n">OP_PSQ_STU</span>:
	<span class="k">case</span> <span class="n">OP_LFS</span>:
	<span class="k">case</span> <span class="n">OP_LFSU</span>:
	<span class="k">case</span> <span class="n">OP_LFD</span>:
	<span class="k">case</span> <span class="n">OP_LFDU</span>:
	<span class="k">case</span> <span class="n">OP_STFS</span>:
	<span class="k">case</span> <span class="n">OP_STFSU</span>:
	<span class="k">case</span> <span class="n">OP_STFD</span>:
	<span class="k">case</span> <span class="n">OP_STFDU</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* X form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPU0</span>:
		<span class="k">case</span> <span class="n">OP_4X_PSQ_LX</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPO0</span>:
		<span class="k">case</span> <span class="n">OP_4X_PSQ_LUX</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_NEG</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPU1</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_MR</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPO1</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_NABS</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_ABS</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE00</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE01</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE10</span>:
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE11</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* XW form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4XW_PSQ_STX</span>:
		<span class="k">case</span> <span class="n">OP_4XW_PSQ_STUX</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* A form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_SUM1</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_SUM0</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MULS0</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MULS1</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MADDS0</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MADDS1</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_DIV</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_SUB</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_ADD</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_SEL</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_RES</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MUL</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_RSQRTE</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MSUB</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_MADD</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_NMSUB</span>:
		<span class="k">case</span> <span class="n">OP_4A_PS_NMADD</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">59</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_59_FADDS</span>:
		<span class="k">case</span> <span class="n">OP_59_FSUBS</span>:
		<span class="k">case</span> <span class="n">OP_59_FDIVS</span>:
		<span class="k">case</span> <span class="n">OP_59_FRES</span>:
		<span class="k">case</span> <span class="n">OP_59_FRSQRTES</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_59_FMULS</span>:
		<span class="k">case</span> <span class="n">OP_59_FMSUBS</span>:
		<span class="k">case</span> <span class="n">OP_59_FMADDS</span>:
		<span class="k">case</span> <span class="n">OP_59_FNMSUBS</span>:
		<span class="k">case</span> <span class="n">OP_59_FNMADDS</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">63</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_63_MTFSB0</span>:
		<span class="k">case</span> <span class="n">OP_63_MTFSB1</span>:
		<span class="k">case</span> <span class="n">OP_63_MTFSF</span>:
		<span class="k">case</span> <span class="n">OP_63_MTFSFI</span>:
		<span class="k">case</span> <span class="n">OP_63_MCRFS</span>:
		<span class="k">case</span> <span class="n">OP_63_MFFS</span>:
		<span class="k">case</span> <span class="n">OP_63_FCMPU</span>:
		<span class="k">case</span> <span class="n">OP_63_FCMPO</span>:
		<span class="k">case</span> <span class="n">OP_63_FNEG</span>:
		<span class="k">case</span> <span class="n">OP_63_FMR</span>:
		<span class="k">case</span> <span class="n">OP_63_FABS</span>:
		<span class="k">case</span> <span class="n">OP_63_FRSP</span>:
		<span class="k">case</span> <span class="n">OP_63_FDIV</span>:
		<span class="k">case</span> <span class="n">OP_63_FADD</span>:
		<span class="k">case</span> <span class="n">OP_63_FSUB</span>:
		<span class="k">case</span> <span class="n">OP_63_FCTIW</span>:
		<span class="k">case</span> <span class="n">OP_63_FCTIWZ</span>:
		<span class="k">case</span> <span class="n">OP_63_FRSQRTE</span>:
		<span class="k">case</span> <span class="n">OP_63_FCPSGN</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_63_FMUL</span>:
		<span class="k">case</span> <span class="n">OP_63_FSEL</span>:
		<span class="k">case</span> <span class="n">OP_63_FMSUB</span>:
		<span class="k">case</span> <span class="n">OP_63_FMADD</span>:
		<span class="k">case</span> <span class="n">OP_63_FNMSUB</span>:
		<span class="k">case</span> <span class="n">OP_63_FNMADD</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">31</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_31_LFSX</span>:
		<span class="k">case</span> <span class="n">OP_31_LFSUX</span>:
		<span class="k">case</span> <span class="n">OP_31_LFDX</span>:
		<span class="k">case</span> <span class="n">OP_31_LFDUX</span>:
		<span class="k">case</span> <span class="n">OP_31_STFSX</span>:
		<span class="k">case</span> <span class="n">OP_31_STFSUX</span>:
		<span class="k">case</span> <span class="n">OP_31_STFX</span>:
		<span class="k">case</span> <span class="n">OP_31_STFUX</span>:
		<span class="k">case</span> <span class="n">OP_31_STFIWX</span>:
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_d_signext</span><span class="p">(</span><span class="n">u32</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">inst</span> <span class="o">&amp;</span> <span class="mh">0x8ff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_ps_three_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rc</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">reg_out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_in1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_in2</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">reg_in3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scalar</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">u64</span> <span class="o">*</span><span class="n">fpscr</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="o">*</span><span class="n">src2</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src3</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">qpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps0_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps0_in1</span><span class="p">,</span> <span class="n">ps0_in2</span><span class="p">,</span> <span class="n">ps0_in3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps1_in1</span><span class="p">,</span> <span class="n">ps1_in2</span><span class="p">,</span> <span class="n">ps1_in3</span><span class="p">;</span>

	<span class="cm">/* RC */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* PS0 */</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in1</span><span class="p">);</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in2</span><span class="p">);</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_LOW</span><span class="p">)</span>
		<span class="n">ps0_in2</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">];</span>

	<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in3</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS3 ps0 -&gt; f(0x%x, 0x%x, 0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ps0_in1</span><span class="p">,</span> <span class="n">ps0_in2</span><span class="p">,</span> <span class="n">ps0_in3</span><span class="p">,</span> <span class="n">ps0_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_NO_PS0</span><span class="p">))</span>
		<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>

	<span class="cm">/* PS1 */</span>
	<span class="n">ps1_in1</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in1</span><span class="p">];</span>
	<span class="n">ps1_in2</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">];</span>
	<span class="n">ps1_in3</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_HIGH</span><span class="p">)</span>
		<span class="n">ps1_in2</span> <span class="o">=</span> <span class="n">ps0_in2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_NO_PS1</span><span class="p">))</span>
		<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps1_in1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps1_in2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps1_in3</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS3 ps1 -&gt; f(0x%x, 0x%x, 0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ps1_in1</span><span class="p">,</span> <span class="n">ps1_in2</span><span class="p">,</span> <span class="n">ps1_in3</span><span class="p">,</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_ps_two_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">reg_out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_in1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_in2</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">scalar</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">u64</span> <span class="o">*</span><span class="n">fpscr</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src1</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="o">*</span><span class="n">src2</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">qpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps0_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps0_in1</span><span class="p">,</span> <span class="n">ps0_in2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps1_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps1_in1</span><span class="p">,</span> <span class="n">ps1_in2</span><span class="p">;</span>

	<span class="cm">/* RC */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* PS0 */</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_LOW</span><span class="p">)</span>
		<span class="n">ps0_in2</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in2</span><span class="p">);</span>

	<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_NO_PS0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS2 ps0 -&gt; f(0x%x, 0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ps0_in1</span><span class="p">,</span> <span class="n">ps0_in2</span><span class="p">,</span> <span class="n">ps0_out</span><span class="p">);</span>

		<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* PS1 */</span>
	<span class="n">ps1_in1</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in1</span><span class="p">];</span>
	<span class="n">ps1_in2</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_HIGH</span><span class="p">)</span>
		<span class="n">ps1_in2</span> <span class="o">=</span> <span class="n">ps0_in2</span><span class="p">;</span>

	<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps1_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps1_in1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps1_in2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scalar</span> <span class="o">&amp;</span> <span class="n">SCALAR_NO_PS1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">ps1_out</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS2 ps1 -&gt; f(0x%x, 0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ps1_in1</span><span class="p">,</span> <span class="n">ps1_in2</span><span class="p">,</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_ps_one_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rc</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">reg_out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg_in</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="n">u64</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
						 <span class="n">u32</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">src1</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">qpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps0_out</span><span class="p">,</span> <span class="n">ps0_in</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ps1_in</span><span class="p">;</span>

	<span class="cm">/* RC */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* PS0 */</span>
	<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_in</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps0_in</span><span class="p">);</span>
	<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps0_in</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS1 ps0 -&gt; f(0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ps0_in</span><span class="p">,</span> <span class="n">ps0_out</span><span class="p">);</span>

	<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ps0_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>

	<span class="cm">/* PS1 */</span>
	<span class="n">ps1_in</span> <span class="o">=</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_in</span><span class="p">];</span>
	<span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ps1_in</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PS1 ps1 -&gt; f(0x%x) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ps1_in</span><span class="p">,</span> <span class="n">qpr</span><span class="p">[</span><span class="n">reg_out</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_emulate_paired_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">emulation_result</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ax_rd</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ax_ra</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ax_rb</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ax_rc</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="kt">short</span> <span class="n">full_d</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr_d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">];</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr_a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_ra</span><span class="p">];</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr_b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">fpr_c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rc</span><span class="p">];</span>

	<span class="n">bool</span> <span class="n">rcomp</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cr</span> <span class="o">=</span> <span class="n">kvmppc_get_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmppc_inst_is_paired_single</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_FP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvmppc_book3s_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOK3S_INTERRUPT_FP_UNAVAIL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EMULATE_AGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_giveup_ext</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MSR_FP</span><span class="p">);</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">enable_kernel_fp</span><span class="p">();</span>
	<span class="cm">/* Do we need to clear FE0 / FE1 here? Don&#39;t think so. */</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">f</span><span class="p">;</span>
		<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FPR[%d] = 0x%x / 0x%llx    QPR[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">get_op</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OP_PSQ_L</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">get_d_signext</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_PSQ_LU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">get_d_signext</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_PSQ_ST</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">get_d_signext</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_PSQ_STU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">get_d_signext</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* X form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPU0</span>:
			<span class="cm">/* XXX */</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PSQ_LX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPO0</span>:
			<span class="cm">/* XXX */</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PSQ_LUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">);</span>
			<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_NEG</span>:
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x8000000000000000ULL</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">^=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPU1</span>:
			<span class="cm">/* XXX */</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_MR</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_CMPO1</span>:
			<span class="cm">/* XXX */</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_NABS</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x8000000000000000ULL</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_ABS</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8000000000000000ULL</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE00</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_ra</span><span class="p">];</span>
			<span class="cm">/* vcpu-&gt;arch.qpr[ax_rd] = vcpu-&gt;arch.fpr[ax_rb]; */</span>
			<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE01</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_ra</span><span class="p">];</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE10</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="cm">/* vcpu-&gt;arch.fpr[ax_rd] = vcpu-&gt;arch.qpr[ax_ra]; */</span>
			<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_ra</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]);</span>
			<span class="cm">/* vcpu-&gt;arch.qpr[ax_rd] = vcpu-&gt;arch.fpr[ax_rb]; */</span>
			<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4X_PS_MERGE11</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rcomp</span><span class="p">);</span>
			<span class="cm">/* vcpu-&gt;arch.fpr[ax_rd] = vcpu-&gt;arch.qpr[ax_ra]; */</span>
			<span class="n">kvm_cvt_fd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_ra</span><span class="p">],</span>
				   <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rb</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* XW form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4XW_PSQ_STX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_4XW_PSQ_STUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">);</span>
			<span class="n">bool</span> <span class="n">w</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_psq_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* A form */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_SUM1</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_rb</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">SCALAR_NO_PS0</span> <span class="o">|</span> <span class="n">SCALAR_HIGH</span><span class="p">,</span> <span class="n">fps_fadds</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">ax_rc</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_SUM0</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NO_PS1</span> <span class="o">|</span> <span class="n">SCALAR_LOW</span><span class="p">,</span> <span class="n">fps_fadds</span><span class="p">);</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rd</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">ax_rc</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MULS0</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">SCALAR_HIGH</span><span class="p">,</span> <span class="n">fps_fmuls</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MULS1</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">SCALAR_LOW</span><span class="p">,</span> <span class="n">fps_fmuls</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MADDS0</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_HIGH</span><span class="p">,</span> <span class="n">fps_fmadds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MADDS1</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_LOW</span><span class="p">,</span> <span class="n">fps_fmadds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_DIV</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fdivs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_SUB</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fsubs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_ADD</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fadds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_SEL</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fsel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_RES</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_one_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_rb</span><span class="p">,</span> <span class="n">fps_fres</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MUL</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_two_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fmuls</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_RSQRTE</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_one_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_rb</span><span class="p">,</span> <span class="n">fps_frsqrte</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MSUB</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fmsubs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_MADD</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fmadds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_NMSUB</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fnmsubs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_4A_PS_NMADD</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_ps_three_in</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rcomp</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
					<span class="n">ax_ra</span><span class="p">,</span> <span class="n">ax_rc</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">,</span> <span class="n">SCALAR_NONE</span><span class="p">,</span> <span class="n">fps_fnmadds</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Real FPU operations */</span>

	<span class="k">case</span> <span class="n">OP_LFS</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						   <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_LFSU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						   <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_LFD</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						   <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_LFDU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						   <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_STFS</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						    <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_STFSU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						    <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_STFD</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						    <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OP_STFDU</span>:
	<span class="p">{</span>
		<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_d</span><span class="p">;</span>

		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
						    <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">31</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_31_LFSX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							   <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_LFSUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							   <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_LFDX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							   <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_LFDUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							   <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_STFSX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							    <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_STFSUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							    <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_SINGLE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_STFX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							    <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_STFUX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							    <span class="n">addr</span><span class="p">,</span> <span class="n">FPU_LS_DOUBLE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_DONE</span><span class="p">)</span>
				<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_31_STFIWX</span>:
		<span class="p">{</span>
			<span class="n">ulong</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_ra</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
				     <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rb</span><span class="p">);</span>

			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_emulate_fpr_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">,</span>
							    <span class="n">addr</span><span class="p">,</span>
							    <span class="n">FPU_LS_SINGLE_LOW</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">59</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_59_FADDS</span>:
			<span class="n">fpd_fadds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FSUBS</span>:
			<span class="n">fpd_fsubs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FDIVS</span>:
			<span class="n">fpd_fdivs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FRES</span>:
			<span class="n">fpd_fres</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FRSQRTES</span>:
			<span class="n">fpd_frsqrtes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_59_FMULS</span>:
			<span class="n">fpd_fmuls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FMSUBS</span>:
			<span class="n">fpd_fmsubs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FMADDS</span>:
			<span class="n">fpd_fmadds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FNMSUBS</span>:
			<span class="n">fpd_fnmsubs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_59_FNMADDS</span>:
			<span class="n">fpd_fnmadds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">63</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_63_MTFSB0</span>:
		<span class="k">case</span> <span class="n">OP_63_MTFSB1</span>:
		<span class="k">case</span> <span class="n">OP_63_MCRFS</span>:
		<span class="k">case</span> <span class="n">OP_63_MTFSFI</span>:
			<span class="cm">/* XXX need to implement */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_MFFS</span>:
			<span class="cm">/* XXX missing CR */</span>
			<span class="o">*</span><span class="n">fpr_d</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_MTFSF</span>:
			<span class="cm">/* XXX missing fm bits */</span>
			<span class="cm">/* XXX missing CR */</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span> <span class="o">=</span> <span class="o">*</span><span class="n">fpr_b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FCMPU</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp_cr</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cr0_mask</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cr_shift</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">fpd_fcmpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_cr</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">cr0_mask</span> <span class="o">&gt;&gt;</span> <span class="n">cr_shift</span><span class="p">);</span>
			<span class="n">cr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">cr0_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cr_shift</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_63_FCMPO</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp_cr</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cr0_mask</span> <span class="o">=</span> <span class="mh">0xf0000000</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">cr_shift</span> <span class="o">=</span> <span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

			<span class="n">fpd_fcmpo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_cr</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">cr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">cr0_mask</span> <span class="o">&gt;&gt;</span> <span class="n">cr_shift</span><span class="p">);</span>
			<span class="n">cr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">cr0_mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">cr_shift</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_63_FNEG</span>:
			<span class="n">fpd_fneg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FMR</span>:
			<span class="o">*</span><span class="n">fpr_d</span> <span class="o">=</span> <span class="o">*</span><span class="n">fpr_b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FABS</span>:
			<span class="n">fpd_fabs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FCPSGN</span>:
			<span class="n">fpd_fcpsgn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FDIV</span>:
			<span class="n">fpd_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FADD</span>:
			<span class="n">fpd_fadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FSUB</span>:
			<span class="n">fpd_fsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FCTIW</span>:
			<span class="n">fpd_fctiw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FCTIWZ</span>:
			<span class="n">fpd_fctiwz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FRSP</span>:
			<span class="n">fpd_frsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="n">kvmppc_sync_qpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ax_rd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FRSQRTE</span>:
		<span class="p">{</span>
			<span class="kt">double</span> <span class="n">one</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>

			<span class="cm">/* fD = sqrt(fB) */</span>
			<span class="n">fpd_fsqrt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="cm">/* fD = 1.0f / fD */</span>
			<span class="n">fpd_fdiv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">one</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inst_get_field</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_63_FMUL</span>:
			<span class="n">fpd_fmul</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FSEL</span>:
			<span class="n">fpd_fsel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FMSUB</span>:
			<span class="n">fpd_fmsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FMADD</span>:
			<span class="n">fpd_fmadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FNMSUB</span>:
			<span class="n">fpd_fnmsub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_63_FNMADD</span>:
			<span class="n">fpd_fnmadd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="n">fpr_d</span><span class="p">,</span> <span class="n">fpr_a</span><span class="p">,</span> <span class="n">fpr_c</span><span class="p">,</span> <span class="n">fpr_b</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">f</span><span class="p">;</span>
		<span class="n">kvm_cvt_df</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;FPR[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcomp</span><span class="p">)</span>
		<span class="n">kvmppc_set_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>

	<span class="n">preempt_enable</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
