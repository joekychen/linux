<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › emulate.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>emulate.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2007</span>
<span class="cm"> * Copyright 2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Hollis Blanchard &lt;hollisb@us.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/clockchips.h&gt;</span>

<span class="cp">#include &lt;asm/reg.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>
<span class="cp">#include &lt;asm/disassemble.h&gt;</span>
<span class="cp">#include &quot;timing.h&quot;</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="cp">#define OP_TRAP 3</span>
<span class="cp">#define OP_TRAP_64 2</span>

<span class="cp">#define OP_31_XOP_TRAP      4</span>
<span class="cp">#define OP_31_XOP_LWZX      23</span>
<span class="cp">#define OP_31_XOP_TRAP_64   68</span>
<span class="cp">#define OP_31_XOP_LBZX      87</span>
<span class="cp">#define OP_31_XOP_STWX      151</span>
<span class="cp">#define OP_31_XOP_STBX      215</span>
<span class="cp">#define OP_31_XOP_LBZUX     119</span>
<span class="cp">#define OP_31_XOP_STBUX     247</span>
<span class="cp">#define OP_31_XOP_LHZX      279</span>
<span class="cp">#define OP_31_XOP_LHZUX     311</span>
<span class="cp">#define OP_31_XOP_MFSPR     339</span>
<span class="cp">#define OP_31_XOP_LHAX      343</span>
<span class="cp">#define OP_31_XOP_STHX      407</span>
<span class="cp">#define OP_31_XOP_STHUX     439</span>
<span class="cp">#define OP_31_XOP_MTSPR     467</span>
<span class="cp">#define OP_31_XOP_DCBI      470</span>
<span class="cp">#define OP_31_XOP_LWBRX     534</span>
<span class="cp">#define OP_31_XOP_TLBSYNC   566</span>
<span class="cp">#define OP_31_XOP_STWBRX    662</span>
<span class="cp">#define OP_31_XOP_LHBRX     790</span>
<span class="cp">#define OP_31_XOP_STHBRX    918</span>

<span class="cp">#define OP_LWZ  32</span>
<span class="cp">#define OP_LWZU 33</span>
<span class="cp">#define OP_LBZ  34</span>
<span class="cp">#define OP_LBZU 35</span>
<span class="cp">#define OP_STW  36</span>
<span class="cp">#define OP_STWU 37</span>
<span class="cp">#define OP_STB  38</span>
<span class="cp">#define OP_STBU 39</span>
<span class="cp">#define OP_LHZ  40</span>
<span class="cp">#define OP_LHZU 41</span>
<span class="cp">#define OP_LHA  42</span>
<span class="cp">#define OP_LHAU 43</span>
<span class="cp">#define OP_STH  44</span>
<span class="cp">#define OP_STHU 45</span>

<span class="kt">void</span> <span class="nf">kvmppc_emulate_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dec_nsec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">dec_time</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;mtDEC: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span><span class="p">);</span>
	<span class="n">hrtimer_try_to_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S</span>
	<span class="cm">/* mtdec lowers the interrupt line when positive. */</span>
	<span class="n">kvmppc_core_dequeue_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/* POWER4+ triggers a dec interrupt if the value is &lt; 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_core_queue_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="cm">/* On BOOKE, DEC = 0 is as good as decrementer not enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * The decrementer ticks at the same rate as the timebase, so</span>
<span class="cm">	 * that&#39;s how we convert the guest DEC value to the number of</span>
<span class="cm">	 * host ticks.</span>
<span class="cm">	 */</span>

	<span class="n">dec_time</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Guest timebase ticks at the same frequency as host decrementer.</span>
<span class="cm">	 * So use the host decrementer calculations for decrementer emulation.</span>
<span class="cm">	 */</span>
	<span class="n">dec_time</span> <span class="o">=</span> <span class="n">dec_time</span> <span class="o">&lt;&lt;</span> <span class="n">decrementer_clockevent</span><span class="p">.</span><span class="n">shift</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">dec_time</span><span class="p">,</span> <span class="n">decrementer_clockevent</span><span class="p">.</span><span class="n">mult</span><span class="p">);</span>
	<span class="n">dec_nsec</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">dec_time</span><span class="p">,</span> <span class="n">NSEC_PER_SEC</span><span class="p">);</span>
	<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">,</span>
		<span class="n">ktime_set</span><span class="p">(</span><span class="n">dec_time</span><span class="p">,</span> <span class="n">dec_nsec</span><span class="p">),</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_jiffies</span> <span class="o">=</span> <span class="n">get_tb</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">kvmppc_get_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">jd</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">-</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_jiffies</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">&lt;</span> <span class="n">jd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">jd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* XXX to do:</span>
<span class="cm"> * lhax</span>
<span class="cm"> * lhaux</span>
<span class="cm"> * lswx</span>
<span class="cm"> * lswi</span>
<span class="cm"> * stswx</span>
<span class="cm"> * stswi</span>
<span class="cm"> * lha</span>
<span class="cm"> * lhau</span>
<span class="cm"> * lmw</span>
<span class="cm"> * stmw</span>
<span class="cm"> *</span>
<span class="cm"> * XXX is_bigendian should depend on MMU mapping or MSR[LE]</span>
<span class="cm"> */</span>
<span class="cm">/* XXX Should probably auto-generate instruction decoding for a particular core</span>
<span class="cm"> * from opcode tables in the future. */</span>
<span class="kt">int</span> <span class="nf">kvmppc_emulate_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inst</span> <span class="o">=</span> <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ra</span> <span class="o">=</span> <span class="n">get_ra</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">get_rs</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">get_rt</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sprn</span> <span class="o">=</span> <span class="n">get_sprn</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">emulation_result</span> <span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">advance</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">spr_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* this default type might be overwritten by subcategories */</span>
	<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_INST_EXITS</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Emulating opcode %d / %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_op</span><span class="p">(</span><span class="n">inst</span><span class="p">),</span> <span class="n">get_xop</span><span class="p">(</span><span class="n">inst</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">get_op</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OP_TRAP</span>:
<span class="cp">#ifdef CONFIG_PPC_BOOK3S</span>
	<span class="k">case</span> <span class="n">OP_TRAP_64</span>:
		<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">SRR1_PROGTRAP</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
					  <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">esr</span> <span class="o">|</span> <span class="n">ESR_PTR</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">advance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">31</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">get_xop</span><span class="p">(</span><span class="n">inst</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_TRAP</span>:
<span class="cp">#ifdef CONFIG_64BIT</span>
		<span class="k">case</span> <span class="n">OP_31_XOP_TRAP_64</span>:
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">SRR1_PROGTRAP</span><span class="p">);</span>
<span class="cp">#else</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
					<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">esr</span> <span class="o">|</span> <span class="n">ESR_PTR</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">advance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_31_XOP_LWZX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LBZX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LBZUX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STWX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STBX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STBUX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LHAX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_loads</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LHZX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LHZUX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_MFSPR</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">sprn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SPRN_SRR0</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SRR1</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_PVR</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_PIR</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_MSSSR0</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Note: mftb and TBRL/TBWL are user-accessible, so</span>
<span class="cm">			 * the guest can always access the real TB anyways.</span>
<span class="cm">			 * In fact, we probably will never see these traps. */</span>
			<span class="k">case</span> <span class="n">SPRN_TBWL</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">get_tb</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_TBWU</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">get_tb</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SPRN_SPRG0</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG1</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG2</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG3</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Note: SPRG4-7 are user-readable, so we don&#39;t get</span>
<span class="cm">			 * a trap. */</span>

			<span class="k">case</span> <span class="n">SPRN_DEC</span>:
				<span class="n">spr_val</span> <span class="o">=</span> <span class="n">kvmppc_get_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">get_tb</span><span class="p">());</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_core_emulate_mfspr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sprn</span><span class="p">,</span>
								     <span class="o">&amp;</span><span class="n">spr_val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_FAIL</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mfspr: unknown spr &quot;</span>
						<span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sprn</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">spr_val</span><span class="p">);</span>
			<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_MFSPR_EXITS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STHX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STHUX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_MTSPR</span>:
			<span class="n">spr_val</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">sprn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SPRN_SRR0</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SRR1</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* XXX We need to context-switch the timebase for</span>
<span class="cm">			 * watchdog and FIT. */</span>
			<span class="k">case</span> <span class="n">SPRN_TBWL</span>: <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_TBWU</span>: <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SPRN_MSSSR0</span>: <span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SPRN_DEC</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="n">kvmppc_emulate_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SPRN_SPRG0</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg0</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG1</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg1</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG2</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg2</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPRN_SPRG3</span>:
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg3</span> <span class="o">=</span> <span class="n">spr_val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_core_emulate_mtspr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sprn</span><span class="p">,</span>
								     <span class="n">spr_val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_FAIL</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mtspr: unknown spr &quot;</span>
						<span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sprn</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_MTSPR_EXITS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_DCBI</span>:
			<span class="cm">/* Do nothing. The guest is performing dcbi because</span>
<span class="cm">			 * hardware DMA is not snooped by the dcache, but</span>
<span class="cm">			 * emulated DMA either goes through the dcache as</span>
<span class="cm">			 * normal writes, or the host kernel has handled dcache</span>
<span class="cm">			 * coherence. */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LWBRX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_TLBSYNC</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STWBRX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_LHBRX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_31_XOP_STHBRX</span>:
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
						       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
			                               <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* Attempt core-specific emulation below. */</span>
			<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LWZ</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LWZU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LBZ</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LBZU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STW</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STWU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STB</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STBU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LHZ</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LHZU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LHA</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_loads</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_LHAU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_loads</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STH</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">OP_STHU</span>:
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_handle_store</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span>
					       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rs</span><span class="p">),</span>
		                               <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">EMULATE_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emulated</span> <span class="o">=</span> <span class="n">kvmppc_core_emulate_op</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">advance</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_AGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">advance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">emulated</span> <span class="o">==</span> <span class="n">EMULATE_FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">advance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t emulate instruction 0x%08x &quot;</span>
			       <span class="s">&quot;(op %d xop %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">get_op</span><span class="p">(</span><span class="n">inst</span><span class="p">),</span> <span class="n">get_xop</span><span class="p">(</span><span class="n">inst</span><span class="p">));</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">trace_kvm_ppc_instr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">emulated</span><span class="p">);</span>

	<span class="cm">/* Advance past emulated instruction. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">advance</span><span class="p">)</span>
		<span class="n">kvmppc_set_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">kvmppc_get_pc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">emulated</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
