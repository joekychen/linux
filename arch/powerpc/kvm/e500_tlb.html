<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › e500_tlb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>e500_tlb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2008-2011 Freescale Semiconductor, Inc. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Yu Liu, yu.liu@freescale.com</span>
<span class="cm"> *         Scott Wood, scottwood@freescale.com</span>
<span class="cm"> *         Ashish Kalra, ashish.kalra@freescale.com</span>
<span class="cm"> *         Varun Sethi, varun.sethi@freescale.com</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> * This file is based on arch/powerpc/kvm/44x_tlb.c,</span>
<span class="cm"> * by Hollis Blanchard &lt;hollisb@us.ibm.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kvm.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/rwsem.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/hugetlb.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>

<span class="cp">#include &quot;e500.h&quot;</span>
<span class="cp">#include &quot;trace.h&quot;</span>
<span class="cp">#include &quot;timing.h&quot;</span>

<span class="cp">#define to_htlb1_esel(esel) (host_tlb_params[1].entries - (esel) - 1)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kvmppc_e500_tlb_params</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="n">E500_TLB_NUM</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">gtlb0_get_next_victim</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">victim</span><span class="p">;</span>

	<span class="n">victim</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">))</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">victim</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tlb1_max_shadow_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reserve one entry for magic page */</span>
	<span class="k">return</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span> <span class="o">-</span> <span class="n">tlbcam_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tlbe_is_writable</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">tlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAS3_SW</span><span class="o">|</span><span class="n">MAS3_UW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">e500_shadow_mas3_attrib</span><span class="p">(</span><span class="n">u32</span> <span class="n">mas3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usermode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Mask off reserved bits. */</span>
	<span class="n">mas3</span> <span class="o">&amp;=</span> <span class="n">MAS3_ATTRIB_MASK</span><span class="p">;</span>

<span class="cp">#ifndef CONFIG_KVM_BOOKE_HV</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usermode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Guest is in supervisor mode,</span>
<span class="cm">		 * so we need to translate guest</span>
<span class="cm">		 * supervisor permissions into user permissions. */</span>
		<span class="n">mas3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E500_TLB_USER_PERM_MASK</span><span class="p">;</span>
		<span class="n">mas3</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mas3</span> <span class="o">&amp;</span> <span class="n">E500_TLB_SUPER_PERM_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mas3</span> <span class="o">|=</span> <span class="n">E500_TLB_SUPER_PERM_MASK</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">mas3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">e500_shadow_mas2_attrib</span><span class="p">(</span><span class="n">u32</span> <span class="n">mas2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">usermode</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_ATTRIB_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAS2_M</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">mas2</span> <span class="o">&amp;</span> <span class="n">MAS2_ATTRIB_MASK</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * writing shadow tlb entry to host TLB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__write_host_tlbe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">mas0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS0</span><span class="p">,</span> <span class="n">mas0</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS1</span><span class="p">,</span> <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS3</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS7</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">));</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS8</span><span class="p">,</span> <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas8</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;isync; tlbwe&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="cm">/* Must clear mas8 for other host tlbwe&#39;s */</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">isync</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">trace_kvm_booke206_stlb_write</span><span class="p">(</span><span class="n">mas0</span><span class="p">,</span> <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas8</span><span class="p">,</span> <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">,</span>
	                              <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">,</span> <span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Acquire a mas0 with victim hint, as if we just took a TLB miss.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t care about the address we&#39;re searching for, other than that it&#39;s</span>
<span class="cm"> * in the right set and is not present in the TLB.  Using a zero PID and a</span>
<span class="cm"> * userspace address means we don&#39;t have to set and then restore MAS5, or</span>
<span class="cm"> * calculate a proper MAS6 value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_host_mas0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mas0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbsx 0, %0&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;b&quot;</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CONFIG_PAGE_OFFSET</span><span class="p">));</span>
	<span class="n">mas0</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MAS0</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mas0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sesel is for tlb1 only */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_host_tlbe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sesel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mas0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mas0</span> <span class="o">=</span> <span class="n">get_host_mas0</span><span class="p">(</span><span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">);</span>
		<span class="n">__write_host_tlbe</span><span class="p">(</span><span class="n">stlbe</span><span class="p">,</span> <span class="n">mas0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__write_host_tlbe</span><span class="p">(</span><span class="n">stlbe</span><span class="p">,</span>
				  <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				  <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">to_htlb1_esel</span><span class="p">(</span><span class="n">sesel</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_KVM_E500V2</span>
<span class="kt">void</span> <span class="nf">kvmppc_map_magic</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="n">magic</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">shared_page</span> <span class="o">=</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stid</span><span class="p">;</span>
	<span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pfn_t</span><span class="p">)</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">shared_page</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">get_page</span><span class="p">(</span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pfn</span><span class="p">));</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">stid</span> <span class="o">=</span> <span class="n">kvmppc_e500_get_sid</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">magic</span><span class="p">.</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">MAS1_VALID</span> <span class="o">|</span> <span class="n">MAS1_TS</span> <span class="o">|</span> <span class="n">MAS1_TID</span><span class="p">(</span><span class="n">stid</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_4K</span><span class="p">);</span>
	<span class="n">magic</span><span class="p">.</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_ea</span> <span class="o">|</span> <span class="n">MAS2_M</span><span class="p">;</span>
	<span class="n">magic</span><span class="p">.</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">MAS3_SW</span> <span class="o">|</span> <span class="n">MAS3_SR</span> <span class="o">|</span> <span class="n">MAS3_UW</span> <span class="o">|</span> <span class="n">MAS3_UR</span><span class="p">;</span>
	<span class="n">magic</span><span class="p">.</span><span class="n">mas8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">__write_host_tlbe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">magic</span><span class="p">,</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">tlbcam_index</span><span class="p">));</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inval_gtlbe_on_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">esel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span> <span class="o">=</span>
		<span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">esel</span><span class="p">].</span><span class="n">ref</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">E500_TLB_BITMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">[</span><span class="n">esel</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">hw_tlb_indx</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_tlb_indx</span> <span class="o">=</span> <span class="n">__ilog2_u64</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS0</span><span class="p">,</span>
			      <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			      <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">to_htlb1_esel</span><span class="p">(</span><span class="n">hw_tlb_indx</span><span class="p">)));</span>
			<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_MAS1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span><span class="p">(</span><span class="s">&quot;tlbwe&quot;</span><span class="p">);</span>
			<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">[</span><span class="n">hw_tlb_indx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">[</span><span class="n">esel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">esel</span><span class="p">].</span><span class="n">ref</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E500_TLB_BITMAP</span><span class="p">;</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Guest tlbe is backed by at most one host tlbe per shadow pid. */</span>
	<span class="n">kvmppc_e500_tlbil_one</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tlb0_set_base</span><span class="p">(</span><span class="n">gva_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ways</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">set_base</span><span class="p">;</span>

	<span class="n">set_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sets</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_base</span> <span class="o">*=</span> <span class="n">ways</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gtlb0_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tlb0_set_base</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sets</span><span class="p">,</span>
			     <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_tlb_esel</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlbsel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">esel</span> <span class="o">=</span> <span class="n">get_tlb_esel_bit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">&amp;=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">esel</span> <span class="o">+=</span> <span class="n">gtlb0_set_base</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">&amp;=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">esel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Search the guest TLB for a matching entry. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_e500_tlb_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
		<span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set_base</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_base</span> <span class="o">=</span> <span class="n">gtlb0_set_base</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span> <span class="o">||</span>
				<span class="n">eaddr</span> <span class="o">&gt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">set_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">tlbe</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">set_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&lt;</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">tlbe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&gt;</span> <span class="n">get_tlb_end</span><span class="p">(</span><span class="n">tlbe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tid</span> <span class="o">=</span> <span class="n">get_tlb_tid</span><span class="p">(</span><span class="n">tlbe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tid</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_tlb_v</span><span class="p">(</span><span class="n">tlbe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_tlb_ts</span><span class="p">(</span><span class="n">tlbe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">as</span> <span class="o">&amp;&amp;</span> <span class="n">as</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">set_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_ref_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span>
					 <span class="n">pfn_t</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">E500_TLB_VALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbe_is_writable</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">))</span>
		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">E500_TLB_DIRTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_ref_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">E500_TLB_VALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">E500_TLB_DIRTY</span><span class="p">)</span>
			<span class="n">kvm_release_pfn_dirty</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">pfn</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">pfn</span><span class="p">);</span>

		<span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_tlb1_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_tlb_privs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">ref</span><span class="p">;</span>
		<span class="n">kvmppc_e500_ref_release</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_tlb_refs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stlbsel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kvmppc_e500_tlbil_all</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="n">stlbsel</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="n">stlbsel</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="n">kvmppc_e500_ref_release</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear_tlb_privs</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_deliver_tlb_miss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">victim</span><span class="p">,</span> <span class="n">tsized</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">;</span>

	<span class="cm">/* since we only have two TLBs, only lower bit is used. */</span>
	<span class="n">tlbsel</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">victim</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">gtlb0_get_next_victim</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tsized</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">=</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="n">tlbsel</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MAS0_NV</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">]);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">MAS1_VALID</span> <span class="o">|</span> <span class="p">(</span><span class="n">as</span> <span class="o">?</span> <span class="n">MAS1_TS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MAS1_TID</span><span class="p">(</span><span class="n">get_tlbmiss_tid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">tsized</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="n">MAS2_EPN</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&amp;</span> <span class="n">MAS2_ATTRIB_MASK</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">&amp;=</span> <span class="n">MAS3_U0</span> <span class="o">|</span> <span class="n">MAS3_U1</span> <span class="o">|</span> <span class="n">MAS3_U2</span> <span class="o">|</span> <span class="n">MAS3_U3</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span> <span class="o">&amp;</span> <span class="n">MAS6_SPID1</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">get_cur_pid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">as</span> <span class="o">?</span> <span class="n">MAS6_SAS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* TID must be supplied by the caller */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_setup_stlbe</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">tsize</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="n">u64</span> <span class="n">gvaddr</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pfn_t</span> <span class="n">pfn</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">pfn</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">E500_TLB_VALID</span><span class="p">));</span>

	<span class="cm">/* Force IPROT=0 for all guest mappings. */</span>
	<span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">tsize</span><span class="p">)</span> <span class="o">|</span> <span class="n">get_tlb_sts</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAS1_VALID</span><span class="p">;</span>
	<span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="p">(</span><span class="n">gvaddr</span> <span class="o">&amp;</span> <span class="n">MAS2_EPN</span><span class="p">)</span> <span class="o">|</span>
		      <span class="n">e500_shadow_mas2_attrib</span><span class="p">(</span><span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
	<span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">e500_shadow_mas3_attrib</span><span class="p">(</span><span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas8</span> <span class="o">=</span> <span class="n">MAS8_TGS</span> <span class="o">|</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lpid</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_shadow_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
	<span class="n">u64</span> <span class="n">gvaddr</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">hva</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pfnmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tsize</span> <span class="o">=</span> <span class="n">BOOK3E_PAGESZ_4K</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Translate guest physical to true physical, acquiring</span>
<span class="cm">	 * a page reference if it is normal, non-reserved memory.</span>
<span class="cm">	 *</span>
<span class="cm">	 * gfn_to_memslot() must succeed because otherwise we wouldn&#39;t</span>
<span class="cm">	 * have gotten this far.  Eventually we should just pass the slot</span>
<span class="cm">	 * pointer through from the first lookup.</span>
<span class="cm">	 */</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">gfn_to_memslot</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>
	<span class="n">hva</span> <span class="o">=</span> <span class="n">gfn_to_hva_memslot</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>

		<span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">hva</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">hva</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_PFNMAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This VMA is a physically contiguous region (e.g.</span>
<span class="cm">			 * /dev/mem) that bypasses normal Linux page</span>
<span class="cm">			 * management.  Find the overlap between the</span>
<span class="cm">			 * vma and the memslot.</span>
<span class="cm">			 */</span>

			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slot_start</span><span class="p">,</span> <span class="n">slot_end</span><span class="p">;</span>

			<span class="n">pfnmap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">;</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span>
			      <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

			<span class="n">pfn</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">((</span><span class="n">hva</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

			<span class="n">slot_start</span> <span class="o">=</span> <span class="n">pfn</span> <span class="o">-</span> <span class="p">(</span><span class="n">gfn</span> <span class="o">-</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">base_gfn</span><span class="p">);</span>
			<span class="n">slot_end</span> <span class="o">=</span> <span class="n">slot_start</span> <span class="o">+</span> <span class="n">slot</span><span class="o">-&gt;</span><span class="n">npages</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">slot_start</span><span class="p">)</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">slot_start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">slot_end</span><span class="p">)</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">slot_end</span><span class="p">;</span>

			<span class="n">tsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_TSIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">MAS1_TSIZE_SHIFT</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * e500 doesn&#39;t implement the lowest tsize bit,</span>
<span class="cm">			 * or 1K pages.</span>
<span class="cm">			 */</span>
			<span class="n">tsize</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_4K</span><span class="p">,</span> <span class="n">tsize</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Now find the largest tsize (up to what the guest</span>
<span class="cm">			 * requested) that will cover gfn, stay within the</span>
<span class="cm">			 * range, and for which gfn and pfn are mutually</span>
<span class="cm">			 * aligned.</span>
<span class="cm">			 */</span>

			<span class="k">for</span> <span class="p">(;</span> <span class="n">tsize</span> <span class="o">&gt;</span> <span class="n">BOOK3E_PAGESZ_4K</span><span class="p">;</span> <span class="n">tsize</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gfn_start</span><span class="p">,</span> <span class="n">gfn_end</span><span class="p">,</span> <span class="n">tsize_pages</span><span class="p">;</span>
				<span class="n">tsize_pages</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">tsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

				<span class="n">gfn_start</span> <span class="o">=</span> <span class="n">gfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">tsize_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">gfn_end</span> <span class="o">=</span> <span class="n">gfn_start</span> <span class="o">+</span> <span class="n">tsize_pages</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">gfn_start</span> <span class="o">+</span> <span class="n">pfn</span> <span class="o">-</span> <span class="n">gfn</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gfn_end</span> <span class="o">+</span> <span class="n">pfn</span> <span class="o">-</span> <span class="n">gfn</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">gfn</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tsize_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span>
				    <span class="p">(</span><span class="n">pfn</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tsize_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">gvaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">tsize_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">pfn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">tsize_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">hva</span> <span class="o">&gt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_HUGETLB</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psize</span> <span class="o">=</span> <span class="n">vma_kernel_pagesize</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>

			<span class="n">tsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">&amp;</span> <span class="n">MAS1_TSIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">MAS1_TSIZE_SHIFT</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Take the largest page size that satisfies both host</span>
<span class="cm">			 * and guest mapping</span>
<span class="cm">			 */</span>
			<span class="n">tsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">__ilog2</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tsize</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * e500 doesn&#39;t implement the lowest tsize bit,</span>
<span class="cm">			 * or 1K pages.</span>
<span class="cm">			 */</span>
			<span class="n">tsize</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_4K</span><span class="p">,</span> <span class="n">tsize</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">pfnmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tsize_pages</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">tsize</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">gfn_to_pfn_memslot</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">.</span><span class="n">kvm</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">gfn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_error_pfn</span><span class="p">(</span><span class="n">pfn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Couldn&#39;t get real page for gfn %lx!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">gfn</span><span class="p">);</span>
			<span class="n">kvm_release_pfn_clean</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Align guest and physical address to page map boundaries */</span>
		<span class="n">pfn</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">tsize_pages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gvaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">tsize_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Drop old ref and setup new one. */</span>
	<span class="n">kvmppc_e500_ref_release</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">kvmppc_e500_ref_setup</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>

	<span class="n">kvmppc_e500_setup_stlbe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="n">tsize</span><span class="p">,</span>
				<span class="n">ref</span><span class="p">,</span> <span class="n">gvaddr</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* XXX only map the one-one case, for now use TLB0 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_e500_tlb0_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">esel</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>

	<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="n">ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">esel</span><span class="p">].</span><span class="n">ref</span><span class="p">;</span>

	<span class="n">kvmppc_e500_shadow_map</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">),</span>
			<span class="n">get_tlb_raddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			<span class="n">gtlbe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Caller must ensure that the specified guest TLB entry is safe to insert into</span>
<span class="cm"> * the shadow TLB. */</span>
<span class="cm">/* XXX for both one-one and one-to-many , for now use TLB1 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_e500_tlb1_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">gvaddr</span><span class="p">,</span> <span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">esel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tlbe_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">victim</span><span class="p">;</span>

	<span class="n">victim</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">host_tlb1_nv</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">host_tlb1_nv</span> <span class="o">&gt;=</span> <span class="n">tlb1_max_shadow_size</span><span class="p">()))</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">host_tlb1_nv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">victim</span><span class="p">];</span>
	<span class="n">kvmppc_e500_shadow_map</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gvaddr</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">[</span><span class="n">esel</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">victim</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">esel</span><span class="p">].</span><span class="n">ref</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">E500_TLB_BITMAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">[</span><span class="n">victim</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">[</span><span class="n">victim</span><span class="p">];</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">victim</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">[</span><span class="n">victim</span><span class="p">]</span> <span class="o">=</span> <span class="n">esel</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">victim</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">tlbe</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_tlb_v</span><span class="p">(</span><span class="n">tlbe</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">eaddr</span> <span class="o">=</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">tlbe</span><span class="p">);</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span> <span class="o">=</span>
				<span class="n">min</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>

		<span class="n">eaddr</span> <span class="o">=</span> <span class="n">get_tlb_end</span><span class="p">(</span><span class="n">tlbe</span><span class="p">);</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span> <span class="o">=</span>
				<span class="n">max</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_need_recalc_tlb1map_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">get_tlb_bytes</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span> <span class="o">==</span> <span class="n">start</span> <span class="o">||</span>
			<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span> <span class="o">==</span> <span class="n">end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function is supposed to be called for a adding a new valid tlb entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_set_tlb1map_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_tlb_v</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">get_tlb_bytes</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_min_eaddr</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb1_max_eaddr</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">esel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span> <span class="o">=</span>
		<span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">get_tlb_iprot</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">kvmppc_need_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">))</span>
		<span class="n">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>

	<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_mt_mmucsr0</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">esel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">MMUCSR0_TLB0FI</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">esel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">esel</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span> <span class="n">esel</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">MMUCSR0_TLB1FI</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">esel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">esel</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span> <span class="n">esel</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>

	<span class="cm">/* Invalidate all vcpu id mappings */</span>
	<span class="n">kvmppc_e500_tlbil_all</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_tlbivax</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ra</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ia</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">esel</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">ea</span><span class="p">;</span>

	<span class="n">ea</span> <span class="o">=</span> <span class="p">((</span><span class="n">ra</span><span class="p">)</span> <span class="o">?</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>

	<span class="n">ia</span> <span class="o">=</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="cm">/* since we only have two TLBs, only lower bit is used. */</span>
	<span class="n">tlbsel</span> <span class="o">=</span> <span class="p">(</span><span class="n">ea</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalidate all entries */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">esel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">esel</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>
		     <span class="n">esel</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ea</span> <span class="o">&amp;=</span> <span class="mh">0xfffff000</span><span class="p">;</span>
		<span class="n">esel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb_index</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span>
				<span class="n">get_cur_pid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Invalidate all vcpu id mappings */</span>
	<span class="n">kvmppc_e500_tlbil_all</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlbilx_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">tlbe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">esel</span><span class="p">;</span>

	<span class="cm">/* invalidate all entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">esel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">esel</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span> <span class="n">esel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">get_tlb_tid</span><span class="p">(</span><span class="n">tlbe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inval_gtlbe_on_host</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tlbilx_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">ra</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">ea</span><span class="p">;</span>

	<span class="n">ea</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ra</span><span class="p">)</span>
		<span class="n">ea</span> <span class="o">+=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tlbsel</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">tlbsel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb_index</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">inval_gtlbe_on_host</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
			<span class="n">kvmppc_e500_gtlbe_invalidate</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_tlbilx</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ra</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">get_cur_spid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlbilx_all</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
		<span class="n">tlbilx_all</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">rt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlbilx_one</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_tlbre</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">;</span>

	<span class="n">tlbsel</span> <span class="o">=</span> <span class="n">get_tlb_tlbsel</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">esel</span> <span class="o">=</span> <span class="n">get_tlb_esel</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">);</span>

	<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAS0_NV</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">|=</span> <span class="n">MAS0_NV</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">]);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_tlbsx</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">as</span> <span class="o">=</span> <span class="o">!!</span><span class="n">get_cur_sas</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">get_cur_spid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">esel</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">ea</span><span class="p">;</span>

	<span class="n">ea</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">rb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tlbsel</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">tlbsel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb_index</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">ea</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">&amp;=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">].</span><span class="n">ways</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">=</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="n">tlbsel</span><span class="p">)</span> <span class="o">|</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">esel</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">MAS0_NV</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">]);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">victim</span><span class="p">;</span>

		<span class="cm">/* since we only have two TLBs, only lower bit is used. */</span>
		<span class="n">tlbsel</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">victim</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">gtlb0_get_next_victim</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">=</span> <span class="n">MAS0_TLBSEL</span><span class="p">(</span><span class="n">tlbsel</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">MAS0_ESEL</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">MAS0_NV</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_nv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">]);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span>
			  <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span> <span class="o">&amp;</span> <span class="n">MAS6_SPID0</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAS6_SAS</span> <span class="o">?</span> <span class="n">MAS1_TS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&amp;</span> <span class="n">MAS4_TSIZED</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">&amp;=</span> <span class="n">MAS2_EPN</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">|=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">&amp;</span>
					   <span class="n">MAS2_ATTRIB_MASK</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">&amp;=</span> <span class="n">MAS3_U0</span> <span class="o">|</span> <span class="n">MAS3_U1</span> <span class="o">|</span>
					     <span class="n">MAS3_U2</span> <span class="o">|</span> <span class="n">MAS3_U3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_TLBSX_EXITS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sesel is for tlb1 only */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_stlbe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">stlbe</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sesel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stid</span><span class="p">;</span>

	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">stid</span> <span class="o">=</span> <span class="n">kvmppc_e500_get_tlb_stid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">);</span>

	<span class="n">stlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">|=</span> <span class="n">MAS1_TID</span><span class="p">(</span><span class="n">stid</span><span class="p">);</span>
	<span class="n">write_host_tlbe</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="n">sesel</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">);</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_emul_tlbwe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">,</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="n">sesel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tlbsel</span> <span class="o">=</span> <span class="n">get_tlb_tlbsel</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">esel</span> <span class="o">=</span> <span class="n">get_tlb_esel</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">);</span>

	<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_tlb_v</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inval_gtlbe_on_host</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">kvmppc_need_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">))</span>
			<span class="n">recal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">;</span>
	<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">;</span>
	<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">;</span>

	<span class="n">trace_kvm_booke206_gtlb_write</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span><span class="p">,</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">,</span>
	                              <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">,</span> <span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a valid tlb1 entry is overwritten then recalculate the</span>
<span class="cm">		 * min/max TLB1 map address range otherwise no need to look</span>
<span class="cm">		 * in tlb1 array.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recal</span><span class="p">)</span>
			<span class="n">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kvmppc_set_tlb1map_range</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Invalidate shadow mappings for the about-to-be-clobbered TLBE. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlbe_is_host_safe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">eaddr</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">raddr</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tlbsel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* TLB0 */</span>
			<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">gtlbe</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">|=</span> <span class="n">MAS1_TSIZE</span><span class="p">(</span><span class="n">BOOK3E_PAGESZ_4K</span><span class="p">);</span>

			<span class="n">stlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kvmppc_e500_tlb0_map</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">esel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">);</span>
			<span class="n">sesel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unused */</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* TLB1 */</span>
			<span class="n">eaddr</span> <span class="o">=</span> <span class="n">get_tlb_eaddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">);</span>
			<span class="n">raddr</span> <span class="o">=</span> <span class="n">get_tlb_raddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">);</span>

			<span class="cm">/* Create a 4KB mapping on the host.</span>
<span class="cm">			 * If the guest wanted a large page,</span>
<span class="cm">			 * only the first 4KB is mapped here and the rest</span>
<span class="cm">			 * are mapped on the fly. */</span>
			<span class="n">stlbsel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sesel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb1_map</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span>
				    <span class="n">raddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">write_stlbe</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">,</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="n">sesel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_TLBWE_EXITS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">EMULATE_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_e500_tlb_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				  <span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">esel</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tlbsel</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">tlbsel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">esel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb_index</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">esel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">index_of</span><span class="p">(</span><span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* &#39;linear_address&#39; is actually an encoding of AS|PID|EADDR . */</span>
<span class="kt">int</span> <span class="nf">kvmppc_core_vcpu_translate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                               <span class="k">struct</span> <span class="n">kvm_translation</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">as</span><span class="p">;</span>

	<span class="n">eaddr</span> <span class="o">=</span> <span class="n">tr</span><span class="o">-&gt;</span><span class="n">linear_address</span><span class="p">;</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">linear_address</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">as</span> <span class="o">=</span> <span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">linear_address</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb_search</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">physical_address</span> <span class="o">=</span> <span class="n">kvmppc_mmu_xlate</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
	<span class="cm">/* XXX what does &quot;writeable&quot; and &quot;usermode&quot; even mean? */</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">kvmppc_mmu_itlb_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">as</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_IS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">kvmppc_e500_tlb_search</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">get_cur_pid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">as</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_mmu_dtlb_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">as</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DS</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">kvmppc_e500_tlb_search</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">get_cur_pid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">),</span> <span class="n">as</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_mmu_itlb_miss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">as</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_IS</span><span class="p">);</span>

	<span class="n">kvmppc_e500_deliver_tlb_miss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_mmu_dtlb_miss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">as</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DS</span><span class="p">);</span>

	<span class="n">kvmppc_e500_deliver_tlb_miss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_dear</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">gpa_t</span> <span class="nf">kvmppc_mmu_xlate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			<span class="n">gva_t</span> <span class="n">eaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pgmask</span><span class="p">;</span>

	<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel_of</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">esel_of</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
	<span class="n">pgmask</span> <span class="o">=</span> <span class="n">get_tlb_bytes</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">get_tlb_raddr</span><span class="p">(</span><span class="n">gtlbe</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="n">pgmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_mmu_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_mmu_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">gpa_t</span> <span class="n">gpaddr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tlbe_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="n">gtlbe</span><span class="p">,</span> <span class="n">stlbe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tlbsel</span> <span class="o">=</span> <span class="n">tlbsel_of</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">esel</span> <span class="o">=</span> <span class="n">esel_of</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="n">sesel</span><span class="p">;</span>

	<span class="n">gtlbe</span> <span class="o">=</span> <span class="n">get_entry</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">tlbsel</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tlbsel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">stlbsel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sesel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* unused */</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="n">tlbsel</span><span class="p">][</span><span class="n">esel</span><span class="p">];</span>

		<span class="n">kvmppc_e500_setup_stlbe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="n">BOOK3E_PAGESZ_4K</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>: <span class="p">{</span>
		<span class="n">gfn_t</span> <span class="n">gfn</span> <span class="o">=</span> <span class="n">gpaddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

		<span class="n">stlbsel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sesel</span> <span class="o">=</span> <span class="n">kvmppc_e500_tlb1_map</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">gfn</span><span class="p">,</span>
					     <span class="n">gtlbe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">,</span> <span class="n">esel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_stlbe</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">,</span> <span class="n">gtlbe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stlbe</span><span class="p">,</span> <span class="n">stlbsel</span><span class="p">,</span> <span class="n">sesel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_gtlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">clear_tlb1_bitmap</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">);</span>

	<span class="n">clear_tlb_refs</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">shared_tlb_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">round_down</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span><span class="p">,</span>
					  <span class="n">PAGE_SIZE</span><span class="p">)));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">num_shared_tlb_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_page_dirty_lock</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">shared_tlb_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">put_page</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">shared_tlb_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">num_shared_tlb_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">shared_tlb_pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_get_sregs_e500_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas4</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas6</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mmucfg</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmucfg</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_set_sregs_e500_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_ARCH206_MMU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas0</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas1</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas1</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas2</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas2</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas7_3</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas7_3</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas4</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas4</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">mas6</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mas6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_config_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">kvm_config_tlb</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_params</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">virt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">**</span><span class="n">pages</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tlbe_priv</span> <span class="o">*</span><span class="n">privs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">g2h_bitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">array_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sets</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mmu_type</span> <span class="o">!=</span> <span class="n">KVM_MMU_FSL_BOOKE_NOHV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sets</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">ilog2</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">sets</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">array_len</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">array_len</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">array_len</span> <span class="o">&lt;</span> <span class="n">array_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">num_pages</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">+</span> <span class="n">array_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">-</span>
		    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">pages</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_user_pages_fast</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pages</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pages</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">num_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">num_pages</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_put_page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">virt</span> <span class="o">=</span> <span class="n">vmap</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="n">num_pages</span><span class="p">,</span> <span class="n">VM_MAP</span><span class="p">,</span> <span class="n">PAGE_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">virt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_page</span><span class="p">;</span>

	<span class="n">privs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_priv</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">privs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_priv</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">privs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">privs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err_put_page</span><span class="p">;</span>

	<span class="n">g2h_bitmap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	                     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g2h_bitmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put_page</span><span class="p">;</span>

	<span class="n">free_gtlb</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">privs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">privs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span> <span class="o">=</span> <span class="n">g2h_bitmap</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">virt</span> <span class="o">+</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmucfg</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MMUCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MMUCFG_LPIDSIZE</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TLBnCFG_N_ENTRY</span> <span class="o">|</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">TLBnCFG_ASSOC_SHIFT</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TLBnCFG_N_ENTRY</span> <span class="o">|</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">TLBnCFG_ASSOC_SHIFT</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">shared_tlb_pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">num_shared_tlb_pages</span> <span class="o">=</span> <span class="n">num_pages</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_ways</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span> <span class="n">sets</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="n">tlb_sizes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_put_page:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">privs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">privs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">put_page</span><span class="p">(</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">err_pages:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_dirty_tlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">kvm_dirty_tlb</span> <span class="o">*</span><span class="n">dirty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span> <span class="o">=</span> <span class="n">to_e500</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="n">clear_tlb_refs</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_e500_tlb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_book3e_206_tlb_entry</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">entries</span> <span class="o">=</span> <span class="n">KVM_E500_TLB0_SIZE</span> <span class="o">+</span> <span class="n">KVM_E500_TLB1_SIZE</span><span class="p">;</span>

	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB0CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TLBnCFG_N_ENTRY</span><span class="p">;</span>
	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB1CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TLBnCFG_N_ENTRY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This should never happen on real e500 hardware, but is</span>
<span class="cm">	 * architecturally possible -- e.g. in some weird nested</span>
<span class="cm">	 * virtualization case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: need to know host tlb size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB0CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				  <span class="n">TLBnCFG_ASSOC_SHIFT</span><span class="p">;</span>
	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">||</span>
	    <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: bad tlb0 host config: %u entries %u ways</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
		       <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span>
		<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">/</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span><span class="p">;</span>
	<span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">KVM_E500_TLB0_SIZE</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">KVM_E500_TLB1_SIZE</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="n">KVM_E500_TLB0_WAY_NUM</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span>
		<span class="n">KVM_E500_TLB0_SIZE</span> <span class="o">/</span> <span class="n">KVM_E500_TLB0_WAY_NUM</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ways</span> <span class="o">=</span> <span class="n">KVM_E500_TLB1_SIZE</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">sets</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">entries</span> <span class="o">*</span> <span class="n">entry_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_arch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KVM_E500_TLB0_SIZE</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span><span class="p">)</span> <span class="o">*</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span><span class="p">)</span> <span class="o">*</span> <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span><span class="p">)</span> <span class="o">*</span>
					  <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tlbe_ref</span><span class="p">)</span> <span class="o">*</span>
					  <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_priv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span>
					  <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">g2h_tlb1_map</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span>
					   <span class="n">host_tlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Init TLB configuration register */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB0CFG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TLBnCFG_N_ENTRY</span> <span class="o">|</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ways</span> <span class="o">&lt;&lt;</span> <span class="n">TLBnCFG_ASSOC_SHIFT</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_TLB1CFG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="o">~</span><span class="p">(</span><span class="n">TLBnCFG_N_ENTRY</span> <span class="o">|</span> <span class="n">TLBnCFG_ASSOC</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">entries</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tlbcfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span>
		<span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">gtlb_params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ways</span> <span class="o">&lt;&lt;</span> <span class="n">TLBnCFG_ASSOC_SHIFT</span><span class="p">;</span>

	<span class="n">kvmppc_recalc_tlb1map_range</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">free_gtlb</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_e500_tlb_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvmppc_vcpu_e500</span> <span class="o">*</span><span class="n">vcpu_e500</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_gtlb</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">h2g_tlb1_rmap</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vcpu_e500</span><span class="o">-&gt;</span><span class="n">tlb_refs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
