<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › booke.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>booke.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2007</span>
<span class="cm"> * Copyright 2010-2011 Freescale Semiconductor, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Hollis Blanchard &lt;hollisb@us.ibm.com&gt;</span>
<span class="cm"> *          Christian Ehrhardt &lt;ehrhardt@linux.vnet.ibm.com&gt;</span>
<span class="cm"> *          Scott Wood &lt;scottwood@freescale.com&gt;</span>
<span class="cm"> *          Varun Sethi &lt;varun.sethi@freescale.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/dbell.h&gt;</span>
<span class="cp">#include &lt;asm/hw_irq.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &quot;timing.h&quot;</span>
<span class="cp">#include &quot;booke.h&quot;</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kvmppc_booke_handlers</span><span class="p">;</span>

<span class="cp">#define VM_STAT(x) offsetof(struct kvm, stat.x), KVM_STAT_VM</span>
<span class="cp">#define VCPU_STAT(x) offsetof(struct kvm_vcpu, stat.x), KVM_STAT_VCPU</span>

<span class="k">struct</span> <span class="n">kvm_stats_debugfs_item</span> <span class="n">debugfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;mmio&quot;</span><span class="p">,</span>       <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">mmio_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dcr&quot;</span><span class="p">,</span>        <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dcr_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sig&quot;</span><span class="p">,</span>        <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">signal_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;itlb_r&quot;</span><span class="p">,</span>     <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">itlb_real_miss_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;itlb_v&quot;</span><span class="p">,</span>     <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">itlb_virt_miss_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dtlb_r&quot;</span><span class="p">,</span>     <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dtlb_real_miss_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dtlb_v&quot;</span><span class="p">,</span>     <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dtlb_virt_miss_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sysc&quot;</span><span class="p">,</span>       <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">syscall_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;isi&quot;</span><span class="p">,</span>        <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">isi_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dsi&quot;</span><span class="p">,</span>        <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dsi_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;inst_emu&quot;</span><span class="p">,</span>   <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">emulated_inst_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;dec&quot;</span><span class="p">,</span>        <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dec_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ext_intr&quot;</span><span class="p">,</span>   <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">ext_intr_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;halt_wakeup&quot;</span><span class="p">,</span> <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">halt_wakeup</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;doorbell&quot;</span><span class="p">,</span> <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">dbell_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;guest doorbell&quot;</span><span class="p">,</span> <span class="n">VCPU_STAT</span><span class="p">(</span><span class="n">gdbell_exits</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* TODO: use vcpu_printf() */</span>
<span class="kt">void</span> <span class="nf">kvmppc_dump_vcpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc:   %08lx msr:  %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lr:   %08lx ctr:  %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lr</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ctr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;srr0: %08llx srr1: %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span><span class="p">,</span>
					    <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;exceptions: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;gpr%02d: %08lx %08lx %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
		       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
		       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span>
		       <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SPE</span>
<span class="kt">void</span> <span class="nf">kvmppc_vcpu_disable_spe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">enable_kernel_spe</span><span class="p">();</span>
	<span class="n">kvmppc_save_guest_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MSR_SPE</span><span class="p">;</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_vcpu_enable_spe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="n">enable_kernel_spe</span><span class="p">();</span>
	<span class="n">kvmppc_load_guest_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">|=</span> <span class="n">MSR_SPE</span><span class="p">;</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_vcpu_sync_spe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">&amp;</span> <span class="n">MSR_SPE</span><span class="p">))</span>
			<span class="n">kvmppc_vcpu_enable_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">&amp;</span> <span class="n">MSR_SPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_vcpu_disable_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_vcpu_sync_spe</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Helper function for &quot;full&quot; MSR writes.  No need to call this if only</span>
<span class="cm"> * EE/CE/ME/DE/RI are changing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kvmppc_set_msr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_msr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_msr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">new_msr</span> <span class="o">|=</span> <span class="n">MSR_GS</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">new_msr</span><span class="p">;</span>

	<span class="n">kvmppc_mmu_msr_notify</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">old_msr</span><span class="p">);</span>
	<span class="n">kvmppc_vcpu_sync_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_core_queue_dtlb_miss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                        <span class="n">ulong</span> <span class="n">dear_flags</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">esr_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_dear</span> <span class="o">=</span> <span class="n">dear_flags</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_esr</span> <span class="o">=</span> <span class="n">esr_flags</span><span class="p">;</span>
	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_DTLB_MISS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_core_queue_data_storage</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                           <span class="n">ulong</span> <span class="n">dear_flags</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">esr_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_dear</span> <span class="o">=</span> <span class="n">dear_flags</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_esr</span> <span class="o">=</span> <span class="n">esr_flags</span><span class="p">;</span>
	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_DATA_STORAGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_core_queue_inst_storage</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                           <span class="n">ulong</span> <span class="n">esr_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_esr</span> <span class="o">=</span> <span class="n">esr_flags</span><span class="p">;</span>
	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_INST_STORAGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_queue_program</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">esr_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_esr</span> <span class="o">=</span> <span class="n">esr_flags</span><span class="p">;</span>
	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_PROGRAM</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_queue_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_DECREMENTER</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_core_pending_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">BOOKE_IRQPRIO_DECREMENTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_dequeue_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BOOKE_IRQPRIO_DECREMENTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_queue_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="n">kvm_interrupt</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">prio</span> <span class="o">=</span> <span class="n">BOOKE_IRQPRIO_EXTERNAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">KVM_INTERRUPT_SET_LEVEL</span><span class="p">)</span>
		<span class="n">prio</span> <span class="o">=</span> <span class="n">BOOKE_IRQPRIO_EXTERNAL_LEVEL</span><span class="p">;</span>

	<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_dequeue_external</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_interrupt</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BOOKE_IRQPRIO_EXTERNAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">BOOKE_IRQPRIO_EXTERNAL_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_srr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srr1</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_GSRR0</span><span class="p">,</span> <span class="n">srr0</span><span class="p">);</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_GSRR1</span><span class="p">,</span> <span class="n">srr1</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span> <span class="o">=</span> <span class="n">srr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span> <span class="o">=</span> <span class="n">srr1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_csrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr0</span> <span class="o">=</span> <span class="n">srr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr1</span> <span class="o">=</span> <span class="n">srr1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_dsrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_DEBUG_LVL_EXC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dsrr0</span> <span class="o">=</span> <span class="n">srr0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dsrr1</span> <span class="o">=</span> <span class="n">srr1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_guest_csrr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">srr1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_mcsrr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srr0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr0</span> <span class="o">=</span> <span class="n">srr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr1</span> <span class="o">=</span> <span class="n">srr1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_guest_dear</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="k">return</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_GDEAR</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_dear</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dear</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_GDEAR</span><span class="p">,</span> <span class="n">dear</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">dar</span> <span class="o">=</span> <span class="n">dear</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_guest_esr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="k">return</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_GESR</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">esr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_guest_esr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">esr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_GESR</span><span class="p">,</span> <span class="n">esr</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">esr</span> <span class="o">=</span> <span class="n">esr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Deliver the interrupt of the corresponding priority, if possible. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_booke_irqprio_deliver</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">msr_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">update_esr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">update_dear</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">crit_raw</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">critical</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">crit_r1</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">crit</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">keep_irq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">int_class</span> <span class="n">int_class</span><span class="p">;</span>

	<span class="cm">/* Truncate crit indicators in 32 bit mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">crit_raw</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">crit_r1</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Critical section when crit == r1 */</span>
	<span class="n">crit</span> <span class="o">=</span> <span class="p">(</span><span class="n">crit_raw</span> <span class="o">==</span> <span class="n">crit_r1</span><span class="p">);</span>
	<span class="cm">/* ... and we&#39;re in supervisor mode */</span>
	<span class="n">crit</span> <span class="o">=</span> <span class="n">crit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priority</span> <span class="o">==</span> <span class="n">BOOKE_IRQPRIO_EXTERNAL_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priority</span> <span class="o">=</span> <span class="n">BOOKE_IRQPRIO_EXTERNAL</span><span class="p">;</span>
		<span class="n">keep_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priority</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DTLB_MISS</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DATA_STORAGE</span>:
		<span class="n">update_dear</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_INST_STORAGE</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_PROGRAM</span>:
		<span class="n">update_esr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_ITLB_MISS</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_SYSCALL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_FP_UNAVAIL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_SPE_UNAVAIL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_SPE_FP_DATA</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_SPE_FP_ROUND</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_AP_UNAVAIL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_ALIGNMENT</span>:
		<span class="n">allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">msr_mask</span> <span class="o">=</span> <span class="n">MSR_CE</span> <span class="o">|</span> <span class="n">MSR_ME</span> <span class="o">|</span> <span class="n">MSR_DE</span><span class="p">;</span>
		<span class="n">int_class</span> <span class="o">=</span> <span class="n">INT_CLASS_NONCRIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_CRITICAL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DBELL_CRIT</span>:
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_CE</span><span class="p">;</span>
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crit</span><span class="p">;</span>
		<span class="n">msr_mask</span> <span class="o">=</span> <span class="n">MSR_ME</span><span class="p">;</span>
		<span class="n">int_class</span> <span class="o">=</span> <span class="n">INT_CLASS_CRIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_MACHINE_CHECK</span>:
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_ME</span><span class="p">;</span>
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crit</span><span class="p">;</span>
		<span class="n">int_class</span> <span class="o">=</span> <span class="n">INT_CLASS_MC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DECREMENTER</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_FIT</span>:
		<span class="n">keep_irq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_EXTERNAL</span>:
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DBELL</span>:
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_EE</span><span class="p">;</span>
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crit</span><span class="p">;</span>
		<span class="n">msr_mask</span> <span class="o">=</span> <span class="n">MSR_CE</span> <span class="o">|</span> <span class="n">MSR_ME</span> <span class="o">|</span> <span class="n">MSR_DE</span><span class="p">;</span>
		<span class="n">int_class</span> <span class="o">=</span> <span class="n">INT_CLASS_NONCRIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_IRQPRIO_DEBUG</span>:
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_DE</span><span class="p">;</span>
		<span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crit</span><span class="p">;</span>
		<span class="n">msr_mask</span> <span class="o">=</span> <span class="n">MSR_ME</span><span class="p">;</span>
		<span class="n">int_class</span> <span class="o">=</span> <span class="n">INT_CLASS_CRIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">int_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INT_CLASS_NONCRIT</span>:
			<span class="n">set_guest_srr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span>
				      <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INT_CLASS_CRIT</span>:
			<span class="n">set_guest_csrr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span>
				       <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INT_CLASS_DBG</span>:
			<span class="n">set_guest_dsrr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span>
				       <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INT_CLASS_MC</span>:
			<span class="n">set_guest_mcsrr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span>
					<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivpr</span> <span class="o">|</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">priority</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">update_esr</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">set_guest_esr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_esr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">update_dear</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">set_guest_dear</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">queued_dear</span><span class="p">);</span>
		<span class="n">kvmppc_set_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">msr_mask</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keep_irq</span><span class="p">)</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">priority</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="cm">/*</span>
<span class="cm">	 * If an interrupt is pending but masked, raise a guest doorbell</span>
<span class="cm">	 * so that we are notified when the guest enables the relevant</span>
<span class="cm">	 * MSR bit.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span> <span class="o">&amp;</span> <span class="n">BOOKE_IRQMASK_EE</span><span class="p">)</span>
		<span class="n">kvmppc_set_pending_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INT_CLASS_NONCRIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span> <span class="o">&amp;</span> <span class="n">BOOKE_IRQMASK_CE</span><span class="p">)</span>
		<span class="n">kvmppc_set_pending_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INT_CLASS_CRIT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span> <span class="o">&amp;</span> <span class="n">BOOKE_IRQPRIO_MACHINE_CHECK</span><span class="p">)</span>
		<span class="n">kvmppc_set_pending_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INT_CLASS_MC</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">allowed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_timer_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tcr</span> <span class="o">&amp;</span> <span class="n">TCR_DIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsr</span> <span class="o">&amp;</span> <span class="n">TSR_DIS</span><span class="p">))</span>
		<span class="n">kvmppc_core_queue_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kvmppc_core_dequeue_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_core_check_exceptions</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pending</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_check_request</span><span class="p">(</span><span class="n">KVM_REQ_PENDING_TIMER</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">smp_mb</span><span class="p">();</span>
			<span class="n">update_timer_ints</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priority</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="o">*</span><span class="n">pending</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="n">BOOKE_IRQPRIO_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_booke_irqprio_deliver</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">priority</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">priority</span> <span class="o">=</span> <span class="n">find_next_bit</span><span class="p">(</span><span class="n">pending</span><span class="p">,</span>
		                         <span class="n">BITS_PER_BYTE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pending</span><span class="p">),</span>
		                         <span class="n">priority</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the guest about our interrupt status */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">int_pending</span> <span class="o">=</span> <span class="o">!!*</span><span class="n">pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check pending exceptions and deliver one, if possible. */</span>
<span class="kt">int</span> <span class="nf">kvmppc_core_prepare_to_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">kvmppc_core_check_exceptions</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_WE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="n">kvm_vcpu_block</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">KVM_REQ_UNHALT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">);</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>

		<span class="n">kvmppc_set_exit_type</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_MTMSRWE_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common checks before entering the guest world.  Call with interrupts</span>
<span class="cm"> * disabled.</span>
<span class="cm"> *</span>
<span class="cm"> * returns !0 if a signal is pending and check_signal is true</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvmppc_prepare_to_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">local_irq_enable</span><span class="p">();</span>
			<span class="n">cond_resched</span><span class="p">();</span>
			<span class="n">local_irq_disable</span><span class="p">();</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_core_prepare_to_enter</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* interrupts got enabled in between, so we</span>
<span class="cm">			   are back at square 1 */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_vcpu_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">kvm_run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_FPU</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fpscr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpexc_mode</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">fpr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">sane</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTERNAL_ERROR</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_prepare_to_enter</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kvm_run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvm_guest_enter</span><span class="p">();</span>

<span class="cp">#ifdef CONFIG_PPC_FPU</span>
	<span class="cm">/* Save userspace FPU state in stack */</span>
	<span class="n">enable_kernel_fp</span><span class="p">();</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">fpscr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">fpexc_mode</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpexc_mode</span><span class="p">;</span>

	<span class="cm">/* Restore guest FPU state to thread */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we can&#39;t trap on MSR_FP in GS-mode, we consider the guest</span>
<span class="cm">	 * as always using the FPU.  Kernel usage of FP (via</span>
<span class="cm">	 * enable_kernel_fp()) in this thread must not occur while</span>
<span class="cm">	 * vcpu-&gt;fpu_active is set.</span>
<span class="cm">	 */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">fpu_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">kvmppc_load_guest_fp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__kvmppc_vcpu_run</span><span class="p">(</span><span class="n">kvm_run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PPC_FPU</span>
	<span class="n">kvmppc_save_guest_fp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">fpu_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Save guest FPU state from thread */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpscr</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Restore userspace FPU state from stack */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">,</span> <span class="n">fpr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpr</span><span class="p">));</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpscr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">fpscr</span><span class="p">;</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fpexc_mode</span> <span class="o">=</span> <span class="n">fpexc_mode</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">kvm_guest_exit</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emulation_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">emulation_result</span> <span class="n">er</span><span class="p">;</span>

	<span class="n">er</span> <span class="o">=</span> <span class="n">kvmppc_emulate_instruction</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">er</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EMULATE_DONE</span>:
		<span class="cm">/* don&#39;t overwrite subtypes, just account kvm_stats */</span>
		<span class="n">kvmppc_account_exit_stat</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EMULATED_INST_EXITS</span><span class="p">);</span>
		<span class="cm">/* Future optimization: only reload non-volatiles if</span>
<span class="cm">		 * they were actually modified by emulation. */</span>
		<span class="k">return</span> <span class="n">RESUME_GUEST_NV</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EMULATE_DO_DCR</span>:
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_DCR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RESUME_HOST</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EMULATE_FAIL</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: emulation at %lx failed (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">last_inst</span><span class="p">);</span>
		<span class="cm">/* For debugging, encode the failing instruction and</span>
<span class="cm">		 * report it to userspace. */</span>
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">|=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">last_inst</span><span class="p">;</span>
		<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ESR_PIL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">RESUME_HOST</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_fill_pt_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">r1</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">msr</span><span class="p">,</span> <span class="n">lr</span><span class="p">;</span>

	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mr %0, 1&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">r1</span><span class="p">));</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mflr %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">lr</span><span class="p">));</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;mfmsr %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">msr</span><span class="p">));</span>
	<span class="n">asm</span><span class="p">(</span><span class="s">&quot;bl 1f; 1: mflr %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">regs</span><span class="p">));</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">nip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">lr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_restart_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">exit_nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_EXTERNAL</span>:
		<span class="n">kvmppc_fill_pt_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DECREMENTER</span>:
		<span class="n">kvmppc_fill_pt_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">timer_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_PPC_FSL_BOOK3E) || defined(CONFIG_PPC_BOOK3E_64)</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DOORBELL</span>:
		<span class="n">kvmppc_fill_pt_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">doorbell_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_MACHINE_CHECK</span>:
		<span class="cm">/* FIXME */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_PERFORMANCE_MONITOR</span>:
		<span class="n">kvmppc_fill_pt_regs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="n">performance_monitor_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * kvmppc_handle_exit</span>
<span class="cm"> *</span>
<span class="cm"> * Return value is in the form (errcode&lt;&lt;2 | RESUME_FLAG_HOST | RESUME_FLAG_NV)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">kvmppc_handle_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exit_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>

	<span class="cm">/* update before a new last_exit_type is rewritten */</span>
	<span class="n">kvmppc_update_timing_stats</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/* restart interrupts if they were meant for the host */</span>
	<span class="n">kvmppc_restart_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>

	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_UNKNOWN</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">ready_for_interrupt_injection</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">exit_nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_MACHINE_CHECK</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MACHINE CHECK: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">));</span>
		<span class="n">kvmppc_dump_vcpu</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="cm">/* For debugging, send invalid exit reason to user space */</span>
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">=</span> <span class="o">~</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">|=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_MCSR</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_EXTERNAL</span>:
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">EXT_INTR_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DECREMENTER</span>:
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DEC_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DOORBELL</span>:
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DBELL_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_GUEST_DBELL_CRIT</span>:
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">GDBELL_EXITS</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We are here because there is a pending guest interrupt</span>
<span class="cm">		 * which could not be delivered as MSR_CE or MSR_ME was not</span>
<span class="cm">		 * set.  Once we break from here we will retry delivery.</span>
<span class="cm">		 */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_GUEST_DBELL</span>:
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">GDBELL_EXITS</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We are here because there is a pending guest interrupt</span>
<span class="cm">		 * which could not be delivered as MSR_EE was not set.  Once</span>
<span class="cm">		 * we break from here we will retry delivery.</span>
<span class="cm">		 */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_PERFORMANCE_MONITOR</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_HV_PRIV</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">emulation_exit</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_PROGRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MSR_PR</span> <span class="o">|</span> <span class="n">MSR_GS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Program traps generated by user-level software must</span>
<span class="cm">			 * be handled by the guest kernel.</span>
<span class="cm">			 *</span>
<span class="cm">			 * In GS mode, hypervisor privileged instructions trap</span>
<span class="cm">			 * on BOOKE_INTERRUPT_HV_PRIV, not here, so these are</span>
<span class="cm">			 * actual program interrupts, handled by the guest.</span>
<span class="cm">			 */</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_esr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">USR_PR_INST</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">emulation_exit</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_FP_UNAVAIL</span>:
		<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_FP_UNAVAIL</span><span class="p">);</span>
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">FP_UNAVAIL</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SPE</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_UNAVAIL</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SPE</span><span class="p">)</span>
			<span class="n">kvmppc_vcpu_enable_spe</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
						   <span class="n">BOOKE_IRQPRIO_SPE_UNAVAIL</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_FP_DATA</span>:
		<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_SPE_FP_DATA</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_FP_ROUND</span>:
		<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_SPE_FP_ROUND</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_UNAVAIL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Guest wants SPE, but host kernel doesn&#39;t support it.  Send</span>
<span class="cm">		 * an &quot;unimplemented operation&quot; program check to the guest.</span>
<span class="cm">		 */</span>
		<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ESR_PUO</span> <span class="o">|</span> <span class="n">ESR_SPV</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * These really should never happen without CONFIG_SPE,</span>
<span class="cm">	 * as we should never enable the real MSR[SPE] in the guest.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_FP_DATA</span>:
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SPE_FP_ROUND</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;%s: unexpected SPE interrupt %u at %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hardware_exit_reason</span> <span class="o">=</span> <span class="n">exit_nr</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DATA_STORAGE</span>:
		<span class="n">kvmppc_core_queue_data_storage</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_dear</span><span class="p">,</span>
		                               <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_esr</span><span class="p">);</span>
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DSI_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_INST_STORAGE</span>:
		<span class="n">kvmppc_core_queue_inst_storage</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_esr</span><span class="p">);</span>
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ISI_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_HV_SYSCALL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kvmppc_kvm_pv</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * hcall from guest userspace -- send privileged</span>
<span class="cm">			 * instruction program check.</span>
<span class="cm">			 */</span>
			<span class="n">kvmppc_core_queue_program</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ESR_PPR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_SYSCALL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="n">KVM_SC_MAGIC_R0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* KVM PV hypercalls */</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kvmppc_kvm_pv</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Guest syscalls */</span>
			<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_SYSCALL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">SYSCALL_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DTLB_MISS</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eaddr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_dear</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">gtlb_index</span><span class="p">;</span>
		<span class="n">gpa_t</span> <span class="n">gpaddr</span><span class="p">;</span>
		<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_E500V2</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_PR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">eaddr</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_ea</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kvmppc_map_magic</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DTLB_VIRT_MISS_EXITS</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* Check the guest TLB. */</span>
		<span class="n">gtlb_index</span> <span class="o">=</span> <span class="n">kvmppc_mmu_dtlb_index</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gtlb_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The guest didn&#39;t have a mapping for it. */</span>
			<span class="n">kvmppc_core_queue_dtlb_miss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span>
			                            <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_dear</span><span class="p">,</span>
			                            <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fault_esr</span><span class="p">);</span>
			<span class="n">kvmppc_mmu_dtlb_miss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DTLB_REAL_MISS_EXITS</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gpaddr</span> <span class="o">=</span> <span class="n">kvmppc_mmu_xlate</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlb_index</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
		<span class="n">gfn</span> <span class="o">=</span> <span class="n">gpaddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_is_visible_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The guest TLB had a mapping, but the shadow TLB</span>
<span class="cm">			 * didn&#39;t, and it is RAM. This could be because:</span>
<span class="cm">			 * a) the entry is mapping the host kernel, or</span>
<span class="cm">			 * b) the guest used a large mapping which we&#39;re faking</span>
<span class="cm">			 * Either way, we need to satisfy the fault without</span>
<span class="cm">			 * invoking the guest. */</span>
			<span class="n">kvmppc_mmu_map</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">gpaddr</span><span class="p">,</span> <span class="n">gtlb_index</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DTLB_VIRT_MISS_EXITS</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Guest has mapped and accessed a page which is not</span>
<span class="cm">			 * actually RAM. */</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span> <span class="o">=</span> <span class="n">gpaddr</span><span class="p">;</span>
			<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vaddr_accessed</span> <span class="o">=</span> <span class="n">eaddr</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_emulate_mmio</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">MMIO_EXITS</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_ITLB_MISS</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eaddr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
		<span class="n">gpa_t</span> <span class="n">gpaddr</span><span class="p">;</span>
		<span class="n">gfn_t</span> <span class="n">gfn</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">gtlb_index</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST</span><span class="p">;</span>

		<span class="cm">/* Check the guest TLB. */</span>
		<span class="n">gtlb_index</span> <span class="o">=</span> <span class="n">kvmppc_mmu_itlb_index</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gtlb_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The guest didn&#39;t have a mapping for it. */</span>
			<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_ITLB_MISS</span><span class="p">);</span>
			<span class="n">kvmppc_mmu_itlb_miss</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ITLB_REAL_MISS_EXITS</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ITLB_VIRT_MISS_EXITS</span><span class="p">);</span>

		<span class="n">gpaddr</span> <span class="o">=</span> <span class="n">kvmppc_mmu_xlate</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gtlb_index</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">);</span>
		<span class="n">gfn</span> <span class="o">=</span> <span class="n">gpaddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kvm_is_visible_gfn</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">kvm</span><span class="p">,</span> <span class="n">gfn</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* The guest TLB had a mapping, but the shadow TLB</span>
<span class="cm">			 * didn&#39;t. This could be because:</span>
<span class="cm">			 * a) the entry is mapping the host kernel, or</span>
<span class="cm">			 * b) the guest used a large mapping which we&#39;re faking</span>
<span class="cm">			 * Either way, we need to satisfy the fault without</span>
<span class="cm">			 * invoking the guest. */</span>
			<span class="n">kvmppc_mmu_map</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eaddr</span><span class="p">,</span> <span class="n">gpaddr</span><span class="p">,</span> <span class="n">gtlb_index</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Guest mapped and leaped at non-RAM! */</span>
			<span class="n">kvmppc_booke_queue_irqprio</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">BOOKE_IRQPRIO_MACHINE_CHECK</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">BOOKE_INTERRUPT_DEBUG</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dbsr</span><span class="p">;</span>

		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_CSRR0</span><span class="p">);</span>

		<span class="cm">/* clear IAC events in DBSR register */</span>
		<span class="n">dbsr</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_DBSR</span><span class="p">);</span>
		<span class="n">dbsr</span> <span class="o">&amp;=</span> <span class="n">DBSR_IAC1</span> <span class="o">|</span> <span class="n">DBSR_IAC2</span> <span class="o">|</span> <span class="n">DBSR_IAC3</span> <span class="o">|</span> <span class="n">DBSR_IAC4</span><span class="p">;</span>
		<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_DBSR</span><span class="p">,</span> <span class="n">dbsr</span><span class="p">);</span>

		<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_DEBUG</span><span class="p">;</span>
		<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">DEBUG_EXITS</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;exit_nr %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exit_nr</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * To avoid clobbering exit_reason, only check for signals if we</span>
<span class="cm">	 * aren&#39;t already exiting to userspace for some other reason.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">RESUME_HOST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_irq_disable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kvmppc_prepare_to_enter</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_INTR</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">EINTR</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">RESUME_HOST</span> <span class="o">|</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="n">RESUME_FLAG_NV</span><span class="p">);</span>
			<span class="n">kvmppc_account_exit</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">SIGNAL_EXITS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initial guest state: 16MB mapping 0 -&gt; 0, PC = 0, MSR = 0, R1 = 16MB */</span>
<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">pir</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">;</span>
	<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* -8 for the callee-save LR slot */</span>
	<span class="n">kvmppc_set_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_KVM_BOOKE_HV</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_msr</span> <span class="o">=</span> <span class="n">MSR_USER</span> <span class="o">|</span> <span class="n">MSR_DE</span> <span class="o">|</span> <span class="n">MSR_IS</span> <span class="o">|</span> <span class="n">MSR_DS</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shadow_pid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Eye-catching numbers so we know if the guest takes an interrupt</span>
<span class="cm">	 * before it&#39;s programmed its own IVPR/IVORs. */</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivpr</span> <span class="o">=</span> <span class="mh">0x55550000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOOKE_IRQPRIO_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7700</span> <span class="o">|</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">kvmppc_init_timing_stats</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_core_vcpu_setup</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvmppc_sanity_check</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_get_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="n">kvmppc_get_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ctr</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">lr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lr</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span> <span class="o">=</span> <span class="n">kvmppc_get_xer</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">srr0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">srr1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pid</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg0</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg1</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg2</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg2</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg3</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg3</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg4</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg4</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg5</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg5</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg6</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg6</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg7</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">kvmppc_set_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">lr</span><span class="p">;</span>
	<span class="n">kvmppc_set_xer</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">xer</span><span class="p">);</span>
	<span class="n">kvmppc_set_msr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr0</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">srr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">srr1</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">srr1</span><span class="p">;</span>
	<span class="n">kvmppc_set_pid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg0</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg1</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg2</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg2</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg3</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg3</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg4</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg4</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg5</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg5</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg6</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg6</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">sprg7</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sprg7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gpr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_sregs_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                           <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">get_tb</span><span class="p">();</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">KVM_SREGS_E_BASE</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">csrr0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr0</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">csrr1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr1</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsr</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">esr</span> <span class="o">=</span> <span class="n">get_guest_esr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">dear</span> <span class="o">=</span> <span class="n">get_guest_dear</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tsr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsr</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tcr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tcr</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">kvmppc_get_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tb</span><span class="p">);</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">vrsave</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vrsave</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sregs_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                          <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_BASE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr0</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">csrr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">csrr1</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">csrr1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsr</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsr</span><span class="p">;</span>
	<span class="n">set_guest_esr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">esr</span><span class="p">);</span>
	<span class="n">set_guest_dear</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">dear</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vrsave</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">vrsave</span><span class="p">;</span>
	<span class="n">kvmppc_set_tcr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">update_special</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_UPDATE_DEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">dec</span><span class="p">;</span>
		<span class="n">kvmppc_emulate_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">update_special</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_UPDATE_TSR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsr</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">tsr</span><span class="p">;</span>
		<span class="n">update_timer_ints</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_sregs_arch206</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                              <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">KVM_SREGS_E_ARCH206</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">pir</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsrr0</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr0</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsrr1</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr1</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">decar</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">decar</span><span class="p">;</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivpr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivpr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_sregs_arch206</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_ARCH206</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">pir</span> <span class="o">!=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr0</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsrr0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mcsrr1</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">mcsrr1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">decar</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">decar</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivpr</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivpr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_get_sregs_ivor</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">KVM_SREGS_E_IVOR</span><span class="p">;</span>

	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_CRITICAL</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_MACHINE_CHECK</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DATA_STORAGE</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_INST_STORAGE</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_EXTERNAL</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_ALIGNMENT</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_PROGRAM</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_FP_UNAVAIL</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_SYSCALL</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_AP_UNAVAIL</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DECREMENTER</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_FIT</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_WATCHDOG</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DTLB_MISS</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_ITLB_MISS</span><span class="p">];</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DEBUG</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_set_sregs_ivor</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">KVM_SREGS_E_IVOR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_CRITICAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_MACHINE_CHECK</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DATA_STORAGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_INST_STORAGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_EXTERNAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_ALIGNMENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_PROGRAM</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_FP_UNAVAIL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_SYSCALL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_AP_UNAVAIL</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DECREMENTER</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_FIT</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_WATCHDOG</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DTLB_MISS</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_ITLB_MISS</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ivor</span><span class="p">[</span><span class="n">BOOKE_IRQPRIO_DEBUG</span><span class="p">]</span> <span class="o">=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">ivor_low</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_get_sregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sregs</span><span class="o">-&gt;</span><span class="n">pvr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span><span class="p">;</span>

	<span class="n">get_sregs_base</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="n">get_sregs_arch206</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="n">kvmppc_core_get_sregs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_sregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_sregs</span> <span class="o">*</span><span class="n">sregs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span> <span class="o">!=</span> <span class="n">sregs</span><span class="o">-&gt;</span><span class="n">pvr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_sregs_base</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_sregs_arch206</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">kvmppc_core_set_sregs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">sregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_get_one_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_one_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_set_one_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_one_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_get_fpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_fpu</span> <span class="o">*</span><span class="n">fpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_fpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_fpu</span> <span class="o">*</span><span class="n">fpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_translate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                  <span class="k">struct</span> <span class="n">kvm_translation</span> <span class="o">*</span><span class="n">tr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_core_vcpu_translate</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vm_ioctl_get_dirty_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_dirty_log</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_core_prepare_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_core_commit_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_set_tcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_tcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tcr</span> <span class="o">=</span> <span class="n">new_tcr</span><span class="p">;</span>
	<span class="n">update_timer_ints</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_set_tsr_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tsr_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bits</span><span class="p">(</span><span class="n">tsr_bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsr</span><span class="p">);</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">kvm_make_request</span><span class="p">(</span><span class="n">KVM_REQ_PENDING_TIMER</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_clr_tsr_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tsr_bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bits</span><span class="p">(</span><span class="n">tsr_bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tsr</span><span class="p">);</span>
	<span class="n">update_timer_ints</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_decrementer_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">kvmppc_set_tsr_bits</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">TSR_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_booke_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">kvm_vcpu</span> <span class="o">=</span> <span class="n">vcpu</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_booke_vcpu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">kvm_vcpu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">kvmppc_booke_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_KVM_BOOKE_HV</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ivor</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_ivor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We install our own exception handlers by hijacking IVPR. IVPR must</span>
<span class="cm">	 * be 16-bit aligned, so we need a 64KB allocation. */</span>
	<span class="n">kvmppc_booke_handlers</span> <span class="o">=</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">,</span>
	                                         <span class="n">VCPU_SIZE_ORDER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kvmppc_booke_handlers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* XXX make sure our handlers are smaller than Linux&#39;s */</span>

	<span class="cm">/* Copy our interrupt handlers to match host IVORs. That way we don&#39;t</span>
<span class="cm">	 * have to swap the IVORs on every guest/host transition. */</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR0</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR1</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR2</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR3</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR4</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR5</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR6</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR7</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR8</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR9</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR10</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR11</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR12</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR13</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR14</span><span class="p">);</span>
	<span class="n">ivor</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_IVOR15</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_ivor</span><span class="p">)</span>
			<span class="n">max_ivor</span> <span class="o">=</span> <span class="n">ivor</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kvmppc_booke_handlers</span> <span class="o">+</span> <span class="n">ivor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		       <span class="n">kvmppc_handlers_start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">kvmppc_handler_len</span><span class="p">,</span>
		       <span class="n">kvmppc_handler_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">flush_icache_range</span><span class="p">(</span><span class="n">kvmppc_booke_handlers</span><span class="p">,</span>
	                   <span class="n">kvmppc_booke_handlers</span> <span class="o">+</span> <span class="n">max_ivor</span> <span class="o">+</span> <span class="n">kvmppc_handler_len</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !BOOKE_HV */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">kvmppc_booke_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_pages</span><span class="p">(</span><span class="n">kvmppc_booke_handlers</span><span class="p">,</span> <span class="n">VCPU_SIZE_ORDER</span><span class="p">);</span>
	<span class="n">kvm_exit</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
