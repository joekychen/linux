<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › powerpc › kvm › powerpc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>powerpc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License, version 2, as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright IBM Corp. 2007</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Hollis Blanchard &lt;hollisb@us.ibm.com&gt;</span>
<span class="cm"> *          Christian Ehrhardt &lt;ehrhardt@linux.vnet.ibm.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/cputable.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/kvm_ppc.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/cputhreads.h&gt;</span>
<span class="cp">#include &quot;timing.h&quot;</span>
<span class="cp">#include &quot;../mm/mmu_decl.h&quot;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_runnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_WE</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!!</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pending_exceptions</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">v</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_should_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_kvm_pv</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__maybe_unused</span> <span class="n">param1</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__maybe_unused</span> <span class="n">param2</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__maybe_unused</span> <span class="n">param3</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__maybe_unused</span> <span class="n">param4</span> <span class="o">=</span> <span class="n">kvmppc_get_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">MSR_SF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 32 bit mode */</span>
		<span class="n">param1</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">param2</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">param3</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">param4</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HC_VENDOR_KVM</span> <span class="o">|</span> <span class="n">KVM_HC_PPC_MAP_MAGIC_PAGE</span>:
	<span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_pa</span> <span class="o">=</span> <span class="n">param1</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">magic_page_ea</span> <span class="o">=</span> <span class="n">param2</span><span class="p">;</span>

		<span class="n">r2</span> <span class="o">=</span> <span class="n">KVM_MAGIC_FEAT_SR</span> <span class="o">|</span> <span class="n">KVM_MAGIC_FEAT_MAS0_TO_SPRG7</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">HC_EV_SUCCESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HC_VENDOR_KVM</span> <span class="o">|</span> <span class="n">KVM_HC_FEATURES</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">HC_EV_SUCCESS</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_PPC_BOOK3S) || defined(CONFIG_KVM_E500V2)</span>
		<span class="cm">/* XXX Missing magic page on 44x */</span>
		<span class="n">r2</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">KVM_FEATURE_MAGIC_PAGE</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* Second return value is in r4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">HC_EV_UNIMPLEMENTED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* We have to know what CPU to virtualize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">pvr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* PAPR only works with book3s_64 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">cpu_type</span> <span class="o">!=</span> <span class="n">KVM_CPU_3S_64</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">papr_enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_HV</span>
	<span class="cm">/* HV KVM can only do PAPR mode for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">papr_enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_KVM_BOOKE_HV</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_EMB_HV</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">r</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">sane</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_emulate_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">emulation_result</span> <span class="n">er</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">er</span> <span class="o">=</span> <span class="n">kvmppc_emulate_instruction</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">er</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EMULATE_DONE</span>:
		<span class="cm">/* Future optimization: only reload non-volatiles if they were</span>
<span class="cm">		 * actually modified. */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_GUEST_NV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EMULATE_DO_MMIO</span>:
		<span class="n">run</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">KVM_EXIT_MMIO</span><span class="p">;</span>
		<span class="cm">/* We must reload nonvolatiles because &quot;update&quot; load/store</span>
<span class="cm">		 * instructions modify register state. */</span>
		<span class="cm">/* Future optimization: only reload non-volatiles if they were</span>
<span class="cm">		 * actually modified. */</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST_NV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EMULATE_FAIL</span>:
		<span class="cm">/* XXX Deliver Program interrupt to guest. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_EMERG</span> <span class="s">&quot;%s: emulation failed (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">kvmppc_get_last_inst</span><span class="p">(</span><span class="n">vcpu</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RESUME_HOST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_hardware_enable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">garbage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_hardware_disable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">garbage</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_hardware_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_hardware_unsetup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_check_processor_compat</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rtn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">rtn</span> <span class="o">=</span> <span class="n">kvmppc_core_check_processor_compat</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_init_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">kvmppc_core_init_vm</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_destroy_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>

	<span class="n">kvm_for_each_vcpu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">kvm</span><span class="p">)</span>
		<span class="n">kvm_arch_vcpu_free</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">online_vcpus</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kvm</span><span class="o">-&gt;</span><span class="n">vcpus</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">online_vcpus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">kvmppc_core_destroy_vm</span><span class="p">(</span><span class="n">kvm</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_sync_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_dev_ioctl_check_extension</span><span class="p">(</span><span class="kt">long</span> <span class="n">ext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_BOOKE_SREGS</span>:
<span class="cp">#else</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_SEGSTATE</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_HIOR</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_PAPR</span>:
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_UNSET_IRQ</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_IRQ_LEVEL</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_ENABLE_CAP</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_ONE_REG</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_KVM_BOOK3S_64_HV</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_PAIRED_SINGLES</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_OSI</span>:
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_GET_PVINFO</span>:
<span class="cp">#if defined(CONFIG_KVM_E500V2) || defined(CONFIG_KVM_E500MC)</span>
	<span class="k">case</span> <span class="n">KVM_CAP_SW_TLB</span>:
<span class="cp">#endif</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_CAP_COALESCED_MMIO</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">KVM_COALESCED_MMIO_PAGE_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">case</span> <span class="n">KVM_CAP_SPAPR_TCE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_BOOK3S_64 */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_HV</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_SMT</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">threads_per_core</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_RMA</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* PPC970 requires an RMA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_ARCH_201</span><span class="p">))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_CAP_SYNC_MMU</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">cpu_has_feature</span><span class="p">(</span><span class="n">CPU_FTR_ARCH_206</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">KVM_CAP_NR_VCPUS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Recommending a number of CPUs is somewhat arbitrary; we</span>
<span class="cm">		 * return the number of present CPUs for -HV (since a host</span>
<span class="cm">		 * will have secondary threads &quot;offline&quot;), and for other KVM</span>
<span class="cm">		 * implementations just count online CPUs.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_HV</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">num_present_cpus</span><span class="p">();</span>
<span class="cp">#else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">num_online_cpus</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_CAP_MAX_VCPUS</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">KVM_MAX_VCPUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_GET_SMMU_INFO</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">long</span> <span class="nf">kvm_arch_dev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_free_memslot</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">free</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">dont</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_create_memslot</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">npages</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_prepare_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
                                   <span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="o">*</span><span class="n">memslot</span><span class="p">,</span>
                                   <span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="n">old</span><span class="p">,</span>
                                   <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
                                   <span class="kt">int</span> <span class="n">user_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvmppc_core_prepare_memory_region</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_commit_memory_region</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">kvm_userspace_memory_region</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">kvm_memory_slot</span> <span class="n">old</span><span class="p">,</span>
               <span class="kt">int</span> <span class="n">user_alloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_core_commit_memory_region</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">kvm_arch_flush_shadow</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="nf">kvm_arch_vcpu_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>
	<span class="n">vcpu</span> <span class="o">=</span> <span class="n">kvmppc_core_vcpu_create</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">wqp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">;</span>
		<span class="n">kvmppc_create_vcpu_debugfs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vcpu</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_vcpu_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Make sure we&#39;re not using the vcpu anymore */</span>
	<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="n">kvmppc_remove_vcpu_debugfs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">kvmppc_core_vcpu_free</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_vcpu_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvm_arch_vcpu_free</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_cpu_has_pending_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kvmppc_core_pending_dec</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * low level hrtimer wake routine. Because this runs in hardirq context</span>
<span class="cm"> * we schedule a tasklet to do the real work.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">kvmppc_decrementer_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">;</span>

	<span class="n">vcpu</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span><span class="p">,</span> <span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">HRTIMER_NORESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">,</span> <span class="n">CLOCK_REALTIME</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">kvmppc_decrementer_func</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">kvmppc_decrementer_wakeup</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dec_expires</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KVM_EXIT_TIMING</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_timing_lock</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_vcpu_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_mmu_destroy</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_vcpu_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="cm">/*</span>
<span class="cm">	 * vrsave (formerly usprg0) isn&#39;t used by Linux, but may</span>
<span class="cm">	 * be used by the guest.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On non-booke this is associated with Altivec and</span>
<span class="cm">	 * is handled by code in book3s.c.</span>
<span class="cm">	 */</span>
	<span class="n">mtspr</span><span class="p">(</span><span class="n">SPRN_VRSAVE</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vrsave</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kvmppc_core_vcpu_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_vcpu_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_core_vcpu_put</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BOOKE</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vrsave</span> <span class="o">=</span> <span class="n">mfspr</span><span class="p">(</span><span class="n">SPRN_VRSAVE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_guest_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                        <span class="k">struct</span> <span class="n">kvm_guest_debug</span> <span class="o">*</span><span class="n">dbg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_complete_dcr_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                     <span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span><span class="p">,</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">dcr</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvmppc_complete_mmio_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                      <span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">gpr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gpr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bad MMIO length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmio_is_bigendian</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Convert BE data from userland back to LE. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="n">ld_le32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="n">ld_le16</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">gpr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmio_sign_extend</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC64</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">gpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s64</span><span class="p">)(</span><span class="n">s32</span><span class="p">)</span><span class="n">gpr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">gpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s64</span><span class="p">)(</span><span class="n">s16</span><span class="p">)</span><span class="n">gpr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">gpr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s64</span><span class="p">)(</span><span class="n">s8</span><span class="p">)</span><span class="n">gpr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">&amp;</span> <span class="n">KVM_MMIO_REG_EXT_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_MMIO_REG_GPR</span>:
		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span><span class="p">,</span> <span class="n">gpr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_MMIO_REG_FPR</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">&amp;</span> <span class="n">KVM_MMIO_REG_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S</span>
	<span class="k">case</span> <span class="n">KVM_MMIO_REG_QPR</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">&amp;</span> <span class="n">KVM_MMIO_REG_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_MMIO_REG_FQPR</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">fpr</span><span class="p">[</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">&amp;</span> <span class="n">KVM_MMIO_REG_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">qpr</span><span class="p">[</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">&amp;</span> <span class="n">KVM_MMIO_REG_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_handle_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_bigendian</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bad MMIO length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">is_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">io_gpr</span> <span class="o">=</span> <span class="n">rt</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmio_is_bigendian</span> <span class="o">=</span> <span class="n">is_bigendian</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_is_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmio_sign_extend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Same as above, but sign extends */</span>
<span class="kt">int</span> <span class="nf">kvmppc_handle_loads</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_bigendian</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_handle_load</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">is_bigendian</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mmio_sign_extend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvmppc_handle_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                        <span class="n">u64</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_bigendian</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: bad MMIO length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">phys_addr</span> <span class="o">=</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">paddr_accessed</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="n">run</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">.</span><span class="n">is_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_needed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_is_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Store the value at the lowest bytes in &#39;data&#39;. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bigendian</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="o">*</span><span class="p">(</span><span class="n">u8</span>  <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Store LE value into &#39;data&#39;. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">st_le32</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">st_le16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">EMULATE_DO_MMIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_run</span> <span class="o">*</span><span class="n">run</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">sigset_t</span> <span class="n">sigsaved</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">sigset_active</span><span class="p">)</span>
		<span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">sigset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigsaved</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_is_write</span><span class="p">)</span>
			<span class="n">kvmppc_complete_mmio_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">run</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">mmio_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dcr_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dcr_is_write</span><span class="p">)</span>
			<span class="n">kvmppc_complete_dcr_load</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">run</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dcr_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osi_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="o">*</span><span class="n">gprs</span> <span class="o">=</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">osi</span><span class="p">.</span><span class="n">gprs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gprs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osi_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hcall_needed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">papr_hcall</span><span class="p">.</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">kvmppc_set_gpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">run</span><span class="o">-&gt;</span><span class="n">papr_hcall</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">hcall_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_vcpu_run</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">sigset_active</span><span class="p">)</span>
		<span class="n">sigprocmask</span><span class="p">(</span><span class="n">SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sigsaved</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_interrupt</span> <span class="o">*</span><span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">KVM_INTERRUPT_UNSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kvmppc_core_dequeue_external</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kvmppc_core_queue_external</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">kvm_vcpu_kick</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vcpu_ioctl_enable_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">kvm_enable_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_OSI</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">osi_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVM_CAP_PPC_PAPR</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">papr_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_KVM_E500V2) || defined(CONFIG_KVM_E500MC)</span>
	<span class="k">case</span> <span class="n">KVM_CAP_SW_TLB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_config_tlb</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">user_ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_config_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvmppc_sanity_check</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_get_mpstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                    <span class="k">struct</span> <span class="n">kvm_mp_state</span> <span class="o">*</span><span class="n">mp_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_ioctl_set_mpstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
                                    <span class="k">struct</span> <span class="n">kvm_mp_state</span> <span class="o">*</span><span class="n">mp_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">kvm_arch_vcpu_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_INTERRUPT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_interrupt</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">irq</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">irq</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">KVM_ENABLE_CAP</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_enable_cap</span> <span class="n">cap</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_enable_cap</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">KVM_SET_ONE_REG</span>:
	<span class="k">case</span> <span class="n">KVM_GET_ONE_REG</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_one_reg</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span> <span class="o">==</span> <span class="n">KVM_SET_ONE_REG</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_set_one_reg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_get_one_reg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_KVM_E500V2) || defined(CONFIG_KVM_E500MC)</span>
	<span class="k">case</span> <span class="n">KVM_DIRTY_TLB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_dirty_tlb</span> <span class="n">dirty</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dirty</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dirty</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vcpu_ioctl_dirty_tlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirty</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_vcpu_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">VM_FAULT_SIGBUS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kvm_vm_ioctl_get_pvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_ppc_pvinfo</span> <span class="o">*</span><span class="n">pvinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inst_lis</span> <span class="o">=</span> <span class="mh">0x3c000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inst_ori</span> <span class="o">=</span> <span class="mh">0x60000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inst_nop</span> <span class="o">=</span> <span class="mh">0x60000000</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inst_sc</span> <span class="o">=</span> <span class="mh">0x44000002</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inst_imm_mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hypercall to get into KVM from within guest context is as</span>
<span class="cm">	 * follows:</span>
<span class="cm">	 *</span>
<span class="cm">	 *    lis r0, r0, KVM_SC_MAGIC_R0@h</span>
<span class="cm">	 *    ori r0, KVM_SC_MAGIC_R0@l</span>
<span class="cm">	 *    sc</span>
<span class="cm">	 *    nop</span>
<span class="cm">	 */</span>
	<span class="n">pvinfo</span><span class="o">-&gt;</span><span class="n">hcall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_lis</span> <span class="o">|</span> <span class="p">((</span><span class="n">KVM_SC_MAGIC_R0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">inst_imm_mask</span><span class="p">);</span>
	<span class="n">pvinfo</span><span class="o">-&gt;</span><span class="n">hcall</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_ori</span> <span class="o">|</span> <span class="p">(</span><span class="n">KVM_SC_MAGIC_R0</span> <span class="o">&amp;</span> <span class="n">inst_imm_mask</span><span class="p">);</span>
	<span class="n">pvinfo</span><span class="o">-&gt;</span><span class="n">hcall</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_sc</span><span class="p">;</span>
	<span class="n">pvinfo</span><span class="o">-&gt;</span><span class="n">hcall</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst_nop</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">kvm_arch_vm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ioctl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVM_PPC_GET_PVINFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_ppc_pvinfo</span> <span class="n">pvinfo</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pvinfo</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_get_pvinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvinfo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pvinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pvinfo</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">case</span> <span class="n">KVM_CREATE_SPAPR_TCE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm_create_spapr_tce</span> <span class="n">create_tce</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">create_tce</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">create_tce</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_create_spapr_tce</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">create_tce</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_BOOK3S_64 */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_KVM_BOOK3S_64_HV</span>
	<span class="k">case</span> <span class="n">KVM_ALLOCATE_RMA</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm_allocate_rma</span> <span class="n">rma</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_allocate_rma</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rma</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rma</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_KVM_BOOK3S_64_HV */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_PPC_BOOK3S_64</span>
	<span class="k">case</span> <span class="n">KVM_PPC_GET_SMMU_INFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">kvm_ppc_smmu_info</span> <span class="n">info</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">kvm_vm_ioctl_get_smmu_info</span><span class="p">(</span><span class="n">kvm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_BOOK3S_64 */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lpid_inuse</span><span class="p">[</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">KVMPPC_NR_LPIDS</span><span class="p">)];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_lpids</span><span class="p">;</span>

<span class="kt">long</span> <span class="nf">kvmppc_alloc_lpid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">lpid</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">lpid</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">lpid_inuse</span><span class="p">,</span> <span class="n">KVMPPC_NR_LPIDS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lpid</span> <span class="o">&gt;=</span> <span class="n">nr_lpids</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: No LPIDs free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">lpid</span><span class="p">,</span> <span class="n">lpid_inuse</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">lpid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_claim_lpid</span><span class="p">(</span><span class="kt">long</span> <span class="n">lpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">lpid</span><span class="p">,</span> <span class="n">lpid_inuse</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_free_lpid</span><span class="p">(</span><span class="kt">long</span> <span class="n">lpid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">lpid</span><span class="p">,</span> <span class="n">lpid_inuse</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvmppc_init_lpid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr_lpids_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nr_lpids</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">KVMPPC_NR_LPIDS</span><span class="p">,</span> <span class="n">nr_lpids_param</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lpid_inuse</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lpid_inuse</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_arch_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">opaque</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_arch_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
