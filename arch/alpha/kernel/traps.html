<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/alpha/kernel/traps.c</span>
<span class="cm"> *</span>
<span class="cm"> * (C) Copyright 1994 Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file initializes the trap entry points</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>

<span class="cp">#include &lt;asm/gentrap.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;asm/sysinfo.h&gt;</span>
<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/special_insns.h&gt;</span>

<span class="cp">#include &quot;proto.h&quot;</span>

<span class="cm">/* Work-around for some SRMs which mishandle opDEC faults.  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">opDEC_fix</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span>
<span class="nf">opDEC_check</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
	<span class="cm">/* Load the address of... */</span>
	<span class="s">&quot;	br	$16, 1f</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* A stub instruction fault handler.  Just add 4 to the</span>
<span class="cm">	   pc and continue.  */</span>
	<span class="s">&quot;	ldq	$16, 8($sp)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	addq	$16, 4, $16</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	stq	$16, 8($sp)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	call_pal %[rti]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* Install the instruction fault handler.  */</span>
	<span class="s">&quot;1:	lda	$17, 3</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	call_pal %[wrent]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* With that in place, the fault from the round-to-minf fp</span>
<span class="cm">	   insn will arrive either at the &quot;lda 4&quot; insn (bad) or one</span>
<span class="cm">	   past that (good).  This places the correct fixup in %0.  */</span>
	<span class="s">&quot;	lda %[fix], 0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	cvttq/svm $f31,$f31</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	lda %[fix], 4&quot;</span>
	<span class="o">:</span> <span class="p">[</span><span class="n">fix</span><span class="p">]</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">opDEC_fix</span><span class="p">)</span>
	<span class="o">:</span> <span class="p">[</span><span class="n">rti</span><span class="p">]</span> <span class="s">&quot;n&quot;</span> <span class="p">(</span><span class="n">PAL_rti</span><span class="p">),</span> <span class="p">[</span><span class="n">wrent</span><span class="p">]</span> <span class="s">&quot;n&quot;</span> <span class="p">(</span><span class="n">PAL_wrent</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;$0&quot;</span><span class="p">,</span> <span class="s">&quot;$1&quot;</span><span class="p">,</span> <span class="s">&quot;$16&quot;</span><span class="p">,</span> <span class="s">&quot;$17&quot;</span><span class="p">,</span> <span class="s">&quot;$22&quot;</span><span class="p">,</span> <span class="s">&quot;$23&quot;</span><span class="p">,</span> <span class="s">&quot;$24&quot;</span><span class="p">,</span> <span class="s">&quot;$25&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opDEC_fix</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;opDEC fixup enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">dik_show_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">r9_15</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc = [&lt;%016lx&gt;]  ra = [&lt;%016lx&gt;]  ps = %04lx    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r26</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">,</span> <span class="n">print_tainted</span><span class="p">());</span>
	<span class="n">print_symbol</span><span class="p">(</span><span class="s">&quot;pc is at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">print_symbol</span><span class="p">(</span><span class="s">&quot;ra is at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r26</span> <span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;v0 = %016lx  t0 = %016lx  t1 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;t2 = %016lx  t3 = %016lx  t4 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r4</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;t5 = %016lx  t6 = %016lx  t7 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r6</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r7</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r9_15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;s0 = %016lx  s1 = %016lx  s2 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">r9_15</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">r9_15</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">r9_15</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;s3 = %016lx  s4 = %016lx  s5 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">r9_15</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">r9_15</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">r9_15</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;s6 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r9_15</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;a0 = %016lx  a1 = %016lx  a2 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r17</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r18</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;a3 = %016lx  a4 = %016lx  a5 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r19</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r20</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r21</span><span class="p">);</span>
 	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;t8 = %016lx  t9 = %016lx  t10= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r22</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r23</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r24</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;t11= %016lx  pv = %016lx  at = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r25</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r27</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r28</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;gp = %016lx  sp = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">,</span> <span class="n">regs</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">__halt();</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static char * ireg_name[] = {&quot;v0&quot;, &quot;t0&quot;, &quot;t1&quot;, &quot;t2&quot;, &quot;t3&quot;, &quot;t4&quot;, &quot;t5&quot;, &quot;t6&quot;,</span>
<span class="c">			   &quot;t7&quot;, &quot;s0&quot;, &quot;s1&quot;, &quot;s2&quot;, &quot;s3&quot;, &quot;s4&quot;, &quot;s5&quot;, &quot;s6&quot;,</span>
<span class="c">			   &quot;a0&quot;, &quot;a1&quot;, &quot;a2&quot;, &quot;a3&quot;, &quot;a4&quot;, &quot;a5&quot;, &quot;t8&quot;, &quot;t9&quot;,</span>
<span class="c">			   &quot;t10&quot;, &quot;t11&quot;, &quot;ra&quot;, &quot;pv&quot;, &quot;at&quot;, &quot;gp&quot;, &quot;sp&quot;, &quot;zero&quot;};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dik_show_code</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Code:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">insn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%c%08x%c&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">insn</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dik_show_trace</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Trace:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mh">0x1ff8</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">extern</span> <span class="kt">char</span> <span class="n">_stext</span><span class="p">[],</span> <span class="n">_etext</span><span class="p">[];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_stext</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">_etext</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[&lt;%lx&gt;]&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">print_symbol</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; ...&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">kstack_depth_to_print</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * debugging aid: &quot;show_stack(NULL);&quot; prints the</span>
<span class="cm">	 * back trace for this cpu.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sp</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sp</span><span class="o">=</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sp</span><span class="p">;</span>

	<span class="n">stack</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kstack_depth_to_print</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">stack</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">THREAD_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">       &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%016lx &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">stack</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dik_show_trace</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">die_if_kernel</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">r9_15</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CPU %d &quot;</span><span class="p">,</span> <span class="n">hard_smp_processor_id</span><span class="p">());</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): %s %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="n">dik_show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">r9_15</span><span class="p">);</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="n">dik_show_trace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">dik_show_code</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_thread_flag</span> <span class="p">(</span><span class="n">TIF_DIE_IF_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;die_if_kernel recursion detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_MATHEMU</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">dummy_emul</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">alpha_fp_emul_imprecise</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">writemask</span><span class="p">)</span>
  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dummy_emul</span><span class="p">;</span>
<span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">alpha_fp_emul</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">)</span>
  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dummy_emul</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="kt">long</span> <span class="n">alpha_fp_emul_imprecise</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">writemask</span><span class="p">);</span>
<span class="kt">long</span> <span class="n">alpha_fp_emul</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">do_entArith</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">summary</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">write_mask</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">summary</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Software-completion summary bit is set, so try to</span>
<span class="cm">		   emulate the instruction.  If the processor supports</span>
<span class="cm">		   precise exceptions, we don&#39;t have to search.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amask</span><span class="p">(</span><span class="n">AMASK_PRECISE_TRAP</span><span class="p">))</span>
			<span class="n">si_code</span> <span class="o">=</span> <span class="n">alpha_fp_emul</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">si_code</span> <span class="o">=</span> <span class="n">alpha_fp_emul_imprecise</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">write_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">si_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Arithmetic fault&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">si_code</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">do_entIF</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">signo</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IPL_MAX</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">data</span>
			  <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Kernel bug at %s:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">),</span> 
			       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">die_if_kernel</span><span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;Kernel Bug&quot;</span> <span class="o">:</span> <span class="s">&quot;Instruction fault&quot;</span><span class="p">),</span>
			      <span class="n">regs</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* breakpoint */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_BRKPT</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptrace_cancel_bpt</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* make pc point to former bpt */</span>
		<span class="p">}</span>

		<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* bugcheck */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
		
	      <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* gentrap */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_trapno</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GEN_INTOVF</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_INTOVF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_INTDIV</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_INTDIV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_FLTOVF</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_FLTDIV</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_FLTUND</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_FLTINV</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_FLTINE</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">GEN_ROPRAND</span>:
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">GEN_DECOVF</span>:
		<span class="k">case</span> <span class="n">GEN_DECDIV</span>:
		<span class="k">case</span> <span class="n">GEN_DECINV</span>:
		<span class="k">case</span> <span class="n">GEN_ASSERTERR</span>:
		<span class="k">case</span> <span class="n">GEN_NULPTRERR</span>:
		<span class="k">case</span> <span class="n">GEN_STKOVF</span>:
		<span class="k">case</span> <span class="n">GEN_STRLENERR</span>:
		<span class="k">case</span> <span class="n">GEN_SUBSTRERR</span>:
		<span class="k">case</span> <span class="n">GEN_RANGERR</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG1</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG2</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG3</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG4</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG5</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG6</span>:
		<span class="k">case</span> <span class="n">GEN_SUBRNG7</span>:
		<span class="nl">default:</span>
			<span class="n">signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
			<span class="n">code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">signo</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
		<span class="n">send_sig_info</span><span class="p">(</span><span class="n">signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* opDEC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">implver</span><span class="p">()</span> <span class="o">==</span> <span class="n">IMPLVER_EV4</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">long</span> <span class="n">si_code</span><span class="p">;</span>

			<span class="cm">/* The some versions of SRM do not handle</span>
<span class="cm">			   the opDEC properly - they return the PC of the</span>
<span class="cm">			   opDEC fault, not the instruction after as the</span>
<span class="cm">			   Alpha architecture requires.  Here we fix it up.</span>
<span class="cm">			   We do this by intentionally causing an opDEC</span>
<span class="cm">			   fault during the boot sequence and testing if</span>
<span class="cm">			   we get the correct PC.  If not, we set a flag</span>
<span class="cm">			   to correct it every time through.  */</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">+=</span> <span class="n">opDEC_fix</span><span class="p">;</span> 
			
			<span class="cm">/* EV4 does not implement anything except normal</span>
<span class="cm">			   rounding.  Everything else will come here as</span>
<span class="cm">			   an illegal instruction.  Emulate them.  */</span>
			<span class="n">si_code</span> <span class="o">=</span> <span class="n">alpha_fp_emul</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">si_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">si_code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">si_code</span><span class="p">;</span>
				<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
				<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* FEN fault */</span>
		<span class="cm">/* Irritating users can call PAL_clrfen to disable the</span>
<span class="cm">		   FPU for the process.  The kernel will then trap in</span>
<span class="cm">		   do_switch_stack and undo_switch_stack when we try</span>
<span class="cm">		   to save and restore the FP registers.</span>

<span class="cm">		   Given that GCC by default generates code that uses the</span>
<span class="cm">		   FP registers, PAL_clrfen is not useful except for DoS</span>
<span class="cm">		   attacks.  So turn the bleeding FPU back on and be done</span>
<span class="cm">		   with it.  */</span>
		<span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">__reload_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pcb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* illoc */</span>
	      <span class="nl">default:</span> <span class="cm">/* unexpected instruction-fault type */</span>
		      <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* There is an ifdef in the PALcode in MILO that enables a </span>
<span class="cm">   &quot;kernel debugging entry point&quot; as an unprivileged call_pal.</span>

<span class="cm">   We don&#39;t want to have anything to do with it, but unfortunately</span>
<span class="cm">   several versions of MILO included in distributions have it enabled,</span>
<span class="cm">   and if we don&#39;t put something on the entry point we&#39;ll oops.  */</span>

<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">do_entDbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Instruction fault&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * entUna has a different register layout to be reasonably simple. It</span>
<span class="cm"> * needs access to all the integer registers (the kernel doesn&#39;t use</span>
<span class="cm"> * fp-regs), and it needs to have them in order for simpler access.</span>
<span class="cm"> *</span>
<span class="cm"> * Due to the non-standard register layout (and because we don&#39;t want</span>
<span class="cm"> * to handle floating-point regs), user-mode unaligned accesses are</span>
<span class="cm"> * handled separately by do_entUnaUser below.</span>
<span class="cm"> *</span>
<span class="cm"> * Oh, btw, we don&#39;t handle the &quot;gp&quot; register correctly, but if we fault</span>
<span class="cm"> * on a gp-register unaligned load/store, something is _very_ wrong</span>
<span class="cm"> * in the kernel anyway..</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">allregs</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regs</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ps</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">unaligned_stat</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">pc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>


<span class="cm">/* Macro for exception fixup code to access integer registers.  */</span>
<span class="cp">#define una_reg(r)  (_regs[(r) &gt;= 16 &amp;&amp; (r) &lt;= 18 ? (r)+19 : (r)])</span>


<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">do_entUna</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">va</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
	  <span class="k">struct</span> <span class="n">allregs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">error</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">,</span> <span class="n">tmp4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">_regs</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">exception_table_entry</span> <span class="o">*</span><span class="n">fixup</span><span class="p">;</span>

	<span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t want to use the generic get/put unaligned macros as</span>
<span class="cm">	   we want to trap exceptions.  Only if we actually get an</span>
<span class="cm">	   exception will we decide whether we should have caught it.  */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0c</span>: <span class="cm">/* ldwu */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,1(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extwl %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extwh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x28</span>: <span class="cm">/* ldl */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,3(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extll %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extlh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x29</span>: <span class="cm">/* ldq */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,7(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extql %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extqh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Note that the store sequences do not indicate that they change</span>
<span class="cm">	   memory because it _should_ be affecting nothing in this context.</span>
<span class="cm">	   (Otherwise we have other, much larger, problems.)  */</span>
	<span class="k">case</span> <span class="mh">0x0d</span>: <span class="cm">/* stw */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,1(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inswh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inswl %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskwh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskwl %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,1(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x2c</span>: <span class="cm">/* stl */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,3(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inslh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insll %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	msklh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskll %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,3(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x2d</span>: <span class="cm">/* stq */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,7(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insqh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insql %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskqh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskql %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,7(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">una_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">)),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">got_exception</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bad unaligned kernel access at %016lx: %p %lx %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pc</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>

<span class="nl">got_exception:</span>
	<span class="cm">/* Ok, we caught the exception, but we don&#39;t want it.  Is there</span>
<span class="cm">	   someone to pass it along to?  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fixup</span> <span class="o">=</span> <span class="n">search_exception_tables</span><span class="p">(</span><span class="n">pc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newpc</span><span class="p">;</span>
		<span class="n">newpc</span> <span class="o">=</span> <span class="n">fixup_exception</span><span class="p">(</span><span class="n">una_reg</span><span class="p">,</span> <span class="n">fixup</span><span class="p">,</span> <span class="n">pc</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Forwarding unaligned exception at %lx (%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pc</span><span class="p">,</span> <span class="n">newpc</span><span class="p">);</span>

		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">=</span> <span class="n">newpc</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Yikes!  No one to forward the exception to.</span>
<span class="cm">	 * Since the registers are in a weird format, dump them ourselves.</span>
<span class="cm"> 	 */</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): unhandled unaligned exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc = [&lt;%016lx&gt;]  ra = [&lt;%016lx&gt;]  ps = %04lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pc</span><span class="p">,</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">26</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r0 = %016lx  r1 = %016lx  r2 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r3 = %016lx  r4 = %016lx  r5 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r6 = %016lx  r7 = %016lx  r8 = %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r9 = %016lx  r10= %016lx  r11= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">11</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r12= %016lx  r13= %016lx  r14= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">14</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r15= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r16= %016lx  r17= %016lx  r18= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">18</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r19= %016lx  r20= %016lx  r21= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
 	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">21</span><span class="p">));</span>
 	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r22= %016lx  r23= %016lx  r24= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">22</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">24</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r25= %016lx  r27= %016lx  r28= %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">una_reg</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">27</span><span class="p">),</span> <span class="n">una_reg</span><span class="p">(</span><span class="mi">28</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;gp = %016lx  sp = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">,</span> <span class="n">regs</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">dik_show_code</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">dik_show_trace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">regs</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_thread_flag</span> <span class="p">(</span><span class="n">TIF_DIE_IF_KERNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;die_if_kernel recursion detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">local_irq_enable</span><span class="p">();</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an s-floating point value in memory format to the</span>
<span class="cm"> * corresponding value in register format.  The exponent</span>
<span class="cm"> * needs to be remapped to preserve non-finite values</span>
<span class="cm"> * (infinities, not-a-numbers, denormals).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">s_mem_to_reg</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">frac</span>    <span class="o">=</span> <span class="p">(</span><span class="n">s_mem</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sign</span>    <span class="o">=</span> <span class="p">(</span><span class="n">s_mem</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exp_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_mem</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exp_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_mem</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exp</span><span class="p">;</span>

	<span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp_msb</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">exp_low</span><span class="p">;</span>	<span class="cm">/* common case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">exp_msb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp_low</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="mh">0x7ff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exp_low</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sign</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">frac</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert an s-floating point value in register format to the</span>
<span class="cm"> * corresponding value in memory format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">s_reg_to_mem</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">s_reg</span> <span class="o">&gt;&gt;</span> <span class="mi">62</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">s_reg</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">34</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle user-level unaligned fault.  Handling user-level unaligned</span>
<span class="cm"> * faults is *extremely* slow and produces nasty messages.  A user</span>
<span class="cm"> * program *should* fix unaligned faults ASAP.</span>
<span class="cm"> *</span>
<span class="cm"> * Notice that we have (almost) the regular kernel stack layout here,</span>
<span class="cm"> * so finding the appropriate registers is a little more difficult</span>
<span class="cm"> * than in the kernel case.</span>
<span class="cm"> *</span>
<span class="cm"> * Finally, we handle regular integer load/stores only.  In</span>
<span class="cm"> * particular, load-linked/store-conditionally and floating point</span>
<span class="cm"> * load/stores are not supported.  The former make no sense with</span>
<span class="cm"> * unaligned faults (they are guaranteed to fail) and I don&#39;t think</span>
<span class="cm"> * the latter will occur in any decent program.</span>
<span class="cm"> *</span>
<span class="cm"> * Sigh. We *do* have to handle some FP operations, because GCC will</span>
<span class="cm"> * uses them as temporary storage for integer memory to memory copies.</span>
<span class="cm"> * However, we need to deal with stt/ldt and sts/lds only.</span>
<span class="cm"> */</span>

<span class="cp">#define OP_INT_MASK	( 1L &lt;&lt; 0x28 | 1L &lt;&lt; 0x2c   </span><span class="cm">/* ldl stl */</span><span class="cp">	\</span>
<span class="cp">			| 1L &lt;&lt; 0x29 | 1L &lt;&lt; 0x2d   </span><span class="cm">/* ldq stq */</span><span class="cp">	\</span>
<span class="cp">			| 1L &lt;&lt; 0x0c | 1L &lt;&lt; 0x0d   </span><span class="cm">/* ldwu stw */</span><span class="cp">	\</span>
<span class="cp">			| 1L &lt;&lt; 0x0a | 1L &lt;&lt; 0x0e ) </span><span class="cm">/* ldbu stb */</span><span class="cp"></span>

<span class="cp">#define OP_WRITE_MASK	( 1L &lt;&lt; 0x26 | 1L &lt;&lt; 0x27   </span><span class="cm">/* sts stt */</span><span class="cp">	\</span>
<span class="cp">			| 1L &lt;&lt; 0x2c | 1L &lt;&lt; 0x2d   </span><span class="cm">/* stl stq */</span><span class="cp">	\</span>
<span class="cp">			| 1L &lt;&lt; 0x0d | 1L &lt;&lt; 0x0e ) </span><span class="cm">/* stw stb */</span><span class="cp"></span>

<span class="cp">#define R(x)	((size_t) &amp;((struct pt_regs *)0)-&gt;x)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">unauser_reg_offsets</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R</span><span class="p">(</span><span class="n">r0</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r2</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r3</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r4</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r5</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r6</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r7</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r8</span><span class="p">),</span>
	<span class="cm">/* r9 ... r15 are stored in front of regs.  */</span>
	<span class="o">-</span><span class="mi">56</span><span class="p">,</span> <span class="o">-</span><span class="mi">48</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span>
	<span class="n">R</span><span class="p">(</span><span class="n">r16</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r17</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r18</span><span class="p">),</span>
	<span class="n">R</span><span class="p">(</span><span class="n">r19</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r20</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r21</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r22</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r23</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r24</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r25</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r26</span><span class="p">),</span>
	<span class="n">R</span><span class="p">(</span><span class="n">r27</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">r28</span><span class="p">),</span> <span class="n">R</span><span class="p">(</span><span class="n">gp</span><span class="p">),</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="cp">#undef R</span>

<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">do_entUnaUser</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">va</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opcode</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">DEFINE_RATELIMIT_STATE</span><span class="p">(</span><span class="n">ratelimit</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">,</span> <span class="n">tmp3</span><span class="p">,</span> <span class="n">tmp4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fake_reg</span><span class="p">,</span> <span class="o">*</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_reg</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check the UAC bits to decide what the user wants us to do</span>
<span class="cm">	   with the unaliged access.  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_thread_flag</span> <span class="p">(</span><span class="n">TIF_UAC_NOPRINT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ratelimit</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s(%d): unaligned trap at %016lx: %p %lx %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span> <span class="p">(</span><span class="n">TIF_UAC_SIGBUS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">give_sigbus</span><span class="p">;</span>
	<span class="cm">/* Not sure why you&#39;d want to use this, but... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span> <span class="p">(</span><span class="n">TIF_UAC_NOFIX</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t bother reading ds in the access check since we already</span>
<span class="cm">	   know that this came from the user.  Also rely on the fact that</span>
<span class="cm">	   the page at TASK_SIZE is unmapped and so can&#39;t be touched anyway. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__access_ok</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USER_DS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>

	<span class="o">++</span><span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
	<span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">;</span>
	<span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pc</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">opcode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OP_INT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* it&#39;s an integer load/store */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
			  <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span> <span class="o">+</span> <span class="n">unauser_reg_offsets</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* usp in PAL regs */</span>
			<span class="n">fake_reg</span> <span class="o">=</span> <span class="n">rdusp</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* zero &quot;register&quot; */</span>
			<span class="n">fake_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t want to use the generic get/put unaligned macros as</span>
<span class="cm">	   we want to trap exceptions.  Only if we actually get an</span>
<span class="cm">	   exception will we decide whether we should have caught it.  */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0c</span>: <span class="cm">/* ldwu */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,1(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extwl %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extwh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="o">*</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x22</span>: <span class="cm">/* lds */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,3(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extll %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extlh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="n">alpha_write_fp_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s_mem_to_reg</span><span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">)));</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* ldt */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,7(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extql %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extqh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="n">alpha_write_fp_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x28</span>: <span class="cm">/* ldl */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,3(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extll %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extlh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="o">*</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x29</span>: <span class="cm">/* ldq */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %1,0(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %2,7(%3)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extql %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	extqh %2,%3,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,3b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,3b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="o">*</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">tmp1</span><span class="o">|</span><span class="n">tmp2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Note that the store sequences do not indicate that they change</span>
<span class="cm">	   memory because it _should_ be affecting nothing in this context.</span>
<span class="cm">	   (Otherwise we have other, much larger, problems.)  */</span>
	<span class="k">case</span> <span class="mh">0x0d</span>: <span class="cm">/* stw */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,1(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inswh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inswl %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskwh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskwl %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,1(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">reg_addr</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x26</span>: <span class="cm">/* sts */</span>
		<span class="n">fake_reg</span> <span class="o">=</span> <span class="n">s_reg_to_mem</span><span class="p">(</span><span class="n">alpha_read_fp_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
		<span class="cm">/* FALLTHRU */</span>

	<span class="k">case</span> <span class="mh">0x2c</span>: <span class="cm">/* stl */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,3(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	inslh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insll %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	msklh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskll %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,3(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">reg_addr</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x27</span>: <span class="cm">/* stt */</span>
		<span class="n">fake_reg</span> <span class="o">=</span> <span class="n">alpha_read_fp_reg</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="cm">/* FALLTHRU */</span>

	<span class="k">case</span> <span class="mh">0x2d</span>: <span class="cm">/* stq */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;1:	ldq_u %2,7(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:	ldq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insqh %6,%5,%4</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	insql %6,%5,%3</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskqh %2,%5,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	mskql %1,%5,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	or %1,%3,%1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:	stq_u %2,7(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;4:	stq_u %1,0(%5)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;5:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.section __ex_table,</span><span class="se">\&quot;</span><span class="s">a</span><span class="se">\&quot;\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 1b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %2,5b-1b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 2b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda %1,5b-2b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 3b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-3b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	.long 4b - .</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;	lda $31,5b-4b(%0)</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;.previous&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">error</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp1</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp2</span><span class="p">),</span>
			  <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp3</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span><span class="p">(</span><span class="n">tmp4</span><span class="p">)</span>
			<span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">va</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="o">*</span><span class="n">reg_addr</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* What instruction were you trying to use, exactly?  */</span>
		<span class="k">goto</span> <span class="n">give_sigbus</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only integer loads should get here; everyone else returns early. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">wrusp</span><span class="p">(</span><span class="n">fake_reg</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">give_sigsegv:</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* make pc point to faulting insn */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We need to replicate some of the logic in mm/fault.c,</span>
<span class="cm">	   since we don&#39;t have access to the fault code in the</span>
<span class="cm">	   exception handling return path.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__access_ok</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">USER_DS</span><span class="p">))</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va</span><span class="p">))</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">mmap_sem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">give_sigbus:</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__cpuinit</span>
<span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Tell PAL-code what global pointer we want in the kernel.  */</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gptr</span> <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$29&quot;</span><span class="p">);</span>
	<span class="n">wrkgp</span><span class="p">(</span><span class="n">gptr</span><span class="p">);</span>

	<span class="cm">/* Hack for Multia (UDB) and JENSEN: some of their SRMs have</span>
<span class="cm">	   a bug in the handling of the opDEC fault.  Fix it up if so.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">implver</span><span class="p">()</span> <span class="o">==</span> <span class="n">IMPLVER_EV4</span><span class="p">)</span>
		<span class="n">opDEC_check</span><span class="p">();</span>

	<span class="n">wrent</span><span class="p">(</span><span class="n">entArith</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">wrent</span><span class="p">(</span><span class="n">entMM</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wrent</span><span class="p">(</span><span class="n">entIF</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">wrent</span><span class="p">(</span><span class="n">entUna</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">wrent</span><span class="p">(</span><span class="n">entSys</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">wrent</span><span class="p">(</span><span class="n">entDbg</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
