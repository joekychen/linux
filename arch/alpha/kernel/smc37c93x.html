<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › smc37c93x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smc37c93x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SMC 37C93X initialization code</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/segment.h&gt;</span>

<span class="cp">#define SMC_DEBUG 0</span>

<span class="cp">#if SMC_DEBUG</span>
<span class="cp"># define DBG_DEVS(args)         printk args</span>
<span class="cp">#else</span>
<span class="cp"># define DBG_DEVS(args)</span>
<span class="cp">#endif</span>

<span class="cp">#define KB              1024</span>
<span class="cp">#define MB              (1024*KB)</span>
<span class="cp">#define GB              (1024*MB)</span>

<span class="cm">/* device &quot;activate&quot; register contents */</span>
<span class="cp">#define DEVICE_ON		1</span>
<span class="cp">#define DEVICE_OFF		0</span>

<span class="cm">/* configuration on/off keys */</span>
<span class="cp">#define CONFIG_ON_KEY		0x55</span>
<span class="cp">#define CONFIG_OFF_KEY		0xaa</span>

<span class="cm">/* configuration space device definitions */</span>
<span class="cp">#define FDC			0</span>
<span class="cp">#define IDE1			1</span>
<span class="cp">#define IDE2			2</span>
<span class="cp">#define PARP			3</span>
<span class="cp">#define SER1			4</span>
<span class="cp">#define SER2			5</span>
<span class="cp">#define RTCL			6</span>
<span class="cp">#define KYBD			7</span>
<span class="cp">#define AUXIO			8</span>

<span class="cm">/* Chip register offsets from base */</span>
<span class="cp">#define CONFIG_CONTROL		0x02</span>
<span class="cp">#define INDEX_ADDRESS		0x03</span>
<span class="cp">#define LOGICAL_DEVICE_NUMBER	0x07</span>
<span class="cp">#define DEVICE_ID		0x20</span>
<span class="cp">#define DEVICE_REV		0x21</span>
<span class="cp">#define POWER_CONTROL		0x22</span>
<span class="cp">#define POWER_MGMT		0x23</span>
<span class="cp">#define OSC			0x24</span>

<span class="cp">#define ACTIVATE		0x30</span>
<span class="cp">#define ADDR_HI			0x60</span>
<span class="cp">#define ADDR_LO			0x61</span>
<span class="cp">#define INTERRUPT_SEL		0x70</span>
<span class="cp">#define INTERRUPT_SEL_2		0x72 </span><span class="cm">/* KYBD/MOUS only */</span><span class="cp"></span>
<span class="cp">#define DMA_CHANNEL_SEL		0x74 </span><span class="cm">/* FDC/PARP only */</span><span class="cp"></span>

<span class="cp">#define FDD_MODE_REGISTER	0x90</span>
<span class="cp">#define FDD_OPTION_REGISTER	0x91</span>

<span class="cm">/* values that we read back that are expected ... */</span>
<span class="cp">#define VALID_DEVICE_ID		2</span>

<span class="cm">/* default device addresses */</span>
<span class="cp">#define KYBD_INTERRUPT		1</span>
<span class="cp">#define MOUS_INTERRUPT		12</span>
<span class="cp">#define COM2_BASE		0x2f8</span>
<span class="cp">#define COM2_INTERRUPT		3</span>
<span class="cp">#define COM1_BASE		0x3f8</span>
<span class="cp">#define COM1_INTERRUPT		4</span>
<span class="cp">#define PARP_BASE		0x3bc</span>
<span class="cp">#define PARP_INTERRUPT		7</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">SMCConfigState</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">devId</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">configPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indexPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dataPort</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">configPort</span> <span class="o">=</span> <span class="n">indexPort</span> <span class="o">=</span> <span class="n">baseAddr</span><span class="p">;</span>
	<span class="n">dataPort</span> <span class="o">=</span> <span class="n">configPort</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#define NUM_RETRIES 5</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG_ON_KEY</span><span class="p">,</span> <span class="n">configPort</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG_ON_KEY</span><span class="p">,</span> <span class="n">configPort</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">DEVICE_ID</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
		<span class="n">devId</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dataPort</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devId</span> <span class="o">==</span> <span class="n">VALID_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">DEVICE_REV</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
			<span class="cm">/* unsigned char devRev = */</span> <span class="n">inb</span><span class="p">(</span><span class="n">dataPort</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">NUM_RETRIES</span><span class="p">)</span> <span class="o">?</span> <span class="n">baseAddr</span> <span class="o">:</span> <span class="mi">0L</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMCRunState</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">CONFIG_OFF_KEY</span><span class="p">,</span> <span class="n">baseAddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">SMCDetectUltraIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">;</span>

	<span class="n">baseAddr</span> <span class="o">=</span> <span class="mh">0x3F0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">baseAddr</span> <span class="o">=</span> <span class="n">SMCConfigState</span><span class="p">(</span> <span class="n">baseAddr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mh">0x3F0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">(</span> <span class="n">baseAddr</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="n">baseAddr</span> <span class="o">=</span> <span class="mh">0x370</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">baseAddr</span> <span class="o">=</span> <span class="n">SMCConfigState</span><span class="p">(</span> <span class="n">baseAddr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mh">0x370</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">(</span> <span class="n">baseAddr</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">(</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">)</span><span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMCEnableDevice</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">device</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">portaddr</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interrupt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indexPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dataPort</span><span class="p">;</span>

	<span class="n">indexPort</span> <span class="o">=</span> <span class="n">baseAddr</span><span class="p">;</span>
	<span class="n">dataPort</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">LOGICAL_DEVICE_NUMBER</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ADDR_LO</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span> <span class="n">portaddr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="p">),</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ADDR_HI</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">portaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">INTERRUPT_SEL</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">interrupt</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ACTIVATE</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DEVICE_ON</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMCEnableKYBD</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indexPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dataPort</span><span class="p">;</span>

	<span class="n">indexPort</span> <span class="o">=</span> <span class="n">baseAddr</span><span class="p">;</span>
	<span class="n">dataPort</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">LOGICAL_DEVICE_NUMBER</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">KYBD</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">INTERRUPT_SEL</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span> <span class="cm">/* Primary interrupt select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">KYBD_INTERRUPT</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">INTERRUPT_SEL_2</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span> <span class="cm">/* Secondary interrupt select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MOUS_INTERRUPT</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ACTIVATE</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DEVICE_ON</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMCEnableFDC</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indexPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dataPort</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oldValue</span><span class="p">;</span>

	<span class="n">indexPort</span> <span class="o">=</span> <span class="n">baseAddr</span><span class="p">;</span>
	<span class="n">dataPort</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">LOGICAL_DEVICE_NUMBER</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">FDC</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">FDD_MODE_REGISTER</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">oldValue</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dataPort</span><span class="p">);</span>

	<span class="n">oldValue</span> <span class="o">|=</span> <span class="mh">0x0E</span><span class="p">;</span>                   <span class="cm">/* Enable burst mode */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oldValue</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">INTERRUPT_SEL</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>	    <span class="cm">/* Primary interrupt select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="n">dataPort</span> <span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">DMA_CHANNEL_SEL</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>   <span class="cm">/* DMA channel select */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ACTIVATE</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">DEVICE_ON</span><span class="p">,</span> <span class="n">dataPort</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if SMC_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMCReportDeviceStatus</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseAddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">indexPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dataPort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">currentControl</span><span class="p">;</span>

	<span class="n">indexPort</span> <span class="o">=</span> <span class="n">baseAddr</span><span class="p">;</span>
	<span class="n">dataPort</span> <span class="o">=</span> <span class="n">baseAddr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">POWER_CONTROL</span><span class="p">,</span> <span class="n">indexPort</span><span class="p">);</span>
	<span class="n">currentControl</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dataPort</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FDC</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+FDC Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-FDC Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IDE1</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+IDE1 Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-IDE1 Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IDE2</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+IDE2 Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-IDE2 Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PARP</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+PARP Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-PARP Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SER1</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+SER1 Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-SER1 Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">currentControl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SER2</span><span class="p">)</span>
	       <span class="o">?</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">+SER2 Enabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">-SER2 Disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC93x_Init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SMCUltraBase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SMCUltraBase</span> <span class="o">=</span> <span class="n">SMCDetectUltraIO</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if SMC_DEBUG</span>
		<span class="n">SMCReportDeviceStatus</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">SMCEnableDevice</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">,</span> <span class="n">SER1</span><span class="p">,</span> <span class="n">COM1_BASE</span><span class="p">,</span> <span class="n">COM1_INTERRUPT</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;SMC FDC37C93X: SER1 done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">SMCEnableDevice</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">,</span> <span class="n">SER2</span><span class="p">,</span> <span class="n">COM2_BASE</span><span class="p">,</span> <span class="n">COM2_INTERRUPT</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;SMC FDC37C93X: SER2 done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">SMCEnableDevice</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">,</span> <span class="n">PARP</span><span class="p">,</span> <span class="n">PARP_BASE</span><span class="p">,</span> <span class="n">PARP_INTERRUPT</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;SMC FDC37C93X: PARP done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="cm">/* On PC164, IDE on the SMC is not enabled;</span>
<span class="cm">		   CMD646 (PCI) on MB */</span>
		<span class="n">SMCEnableKYBD</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;SMC FDC37C93X: KYB done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">SMCEnableFDC</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;SMC FDC37C93X: FDC done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="cp">#if SMC_DEBUG</span>
		<span class="n">SMCReportDeviceStatus</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">SMCRunState</span><span class="p">(</span><span class="n">SMCUltraBase</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SMC FDC37C93X Ultra I/O Controller found @ 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SMCUltraBase</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">DBG_DEVS</span><span class="p">((</span><span class="s">&quot;No SMC FDC37C93X Ultra I/O Controller found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
