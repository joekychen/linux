<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › smc37c669.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smc37c669.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SMC 37C669 initialization code</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/segment.h&gt;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c"># define DBG_DEVS(args)         printk args</span>
<span class="cp">#else</span>
<span class="cp"># define DBG_DEVS(args)</span>
<span class="cp">#endif</span>

<span class="cp">#define KB              1024</span>
<span class="cp">#define MB              (1024*KB)</span>
<span class="cp">#define GB              (1024*MB)</span>

<span class="cp">#define SMC_DEBUG   0</span>

<span class="cm">/* File:	smcc669_def.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997 by</span>
<span class="cm"> * Digital Equipment Corporation, Maynard, Massachusetts.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is furnished under a license and may be used and copied</span>
<span class="cm"> * only  in  accordance  of  the  terms  of  such  license  and with the</span>
<span class="cm"> * inclusion of the above copyright notice. This software or  any  other</span>
<span class="cm"> * copies thereof may not be provided or otherwise made available to any</span>
<span class="cm"> * other person.  No title to and  ownership of the  software is  hereby</span>
<span class="cm"> * transferred.</span>
<span class="cm"> *</span>
<span class="cm"> * The information in this software is  subject to change without notice</span>
<span class="cm"> * and  should  not  be  construed  as a commitment by Digital Equipment</span>
<span class="cm"> * Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * Digital assumes no responsibility for the use  or  reliability of its</span>
<span class="cm"> * software on equipment which is not supplied by Digital.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Abstract:	</span>
<span class="cm"> *</span>
<span class="cm"> *	This file contains header definitions for the SMC37c669 </span>
<span class="cm"> *	Super I/O controller. </span>
<span class="cm"> *</span>
<span class="cm"> * Author:	</span>
<span class="cm"> *</span>
<span class="cm"> *	Eric Rasmussen</span>
<span class="cm"> *</span>
<span class="cm"> * Modification History:</span>
<span class="cm"> *</span>
<span class="cm"> *	er	28-Jan-1997	Initial Entry</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __SMC37c669_H</span>
<span class="cp">#define __SMC37c669_H</span>

<span class="cm">/*</span>
<span class="cm">** Macros for handling device IRQs</span>
<span class="cm">**</span>
<span class="cm">** The mask acts as a flag used in mapping actual ISA IRQs (0 - 15) </span>
<span class="cm">** to device IRQs (A - H).</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_MASK	0x80000000</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ( __i )	\</span>
<span class="cp">	((SMC37c669_DEVICE_IRQ_MASK) | (__i))</span>
<span class="cp">#define SMC37c669_IS_DEVICE_IRQ(__i)	\</span>
<span class="cp">	(((__i) &amp; (SMC37c669_DEVICE_IRQ_MASK)) == (SMC37c669_DEVICE_IRQ_MASK))</span>
<span class="cp">#define SMC37c669_RAW_DEVICE_IRQ(__i)	\</span>
<span class="cp">	((__i) &amp; ~(SMC37c669_DEVICE_IRQ_MASK))</span>

<span class="cm">/*</span>
<span class="cm">** Macros for handling device DRQs</span>
<span class="cm">**</span>
<span class="cm">** The mask acts as a flag used in mapping actual ISA DMA</span>
<span class="cm">** channels to device DMA channels (A - C).</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_DEVICE_DRQ_MASK	0x80000000</span>
<span class="cp">#define SMC37c669_DEVICE_DRQ(__d)	\</span>
<span class="cp">	((SMC37c669_DEVICE_DRQ_MASK) | (__d))</span>
<span class="cp">#define SMC37c669_IS_DEVICE_DRQ(__d)	\</span>
<span class="cp">	(((__d) &amp; (SMC37c669_DEVICE_DRQ_MASK)) == (SMC37c669_DEVICE_DRQ_MASK))</span>
<span class="cp">#define SMC37c669_RAW_DEVICE_DRQ(__d)	\</span>
<span class="cp">	((__d) &amp; ~(SMC37c669_DEVICE_DRQ_MASK))</span>

<span class="cp">#define SMC37c669_DEVICE_ID	0x3</span>

<span class="cm">/*</span>
<span class="cm">** SMC37c669 Device Function Definitions</span>
<span class="cm">*/</span>
<span class="cp">#define SERIAL_0	0</span>
<span class="cp">#define SERIAL_1	1</span>
<span class="cp">#define PARALLEL_0	2</span>
<span class="cp">#define FLOPPY_0	3</span>
<span class="cp">#define IDE_0		4</span>
<span class="cp">#define NUM_FUNCS	5</span>

<span class="cm">/*</span>
<span class="cm">** Default Device Function Mappings</span>
<span class="cm">*/</span>
<span class="cp">#define COM1_BASE	0x3F8</span>
<span class="cp">#define COM1_IRQ	4</span>
<span class="cp">#define COM2_BASE	0x2F8</span>
<span class="cp">#define COM2_IRQ	3</span>
<span class="cp">#define PARP_BASE	0x3BC</span>
<span class="cp">#define PARP_IRQ	7</span>
<span class="cp">#define PARP_DRQ	3</span>
<span class="cp">#define FDC_BASE	0x3F0</span>
<span class="cp">#define FDC_IRQ		6</span>
<span class="cp">#define FDC_DRQ		2</span>

<span class="cm">/*</span>
<span class="cm">** Configuration On/Off Key Definitions</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_CONFIG_ON_KEY		0x55</span>
<span class="cp">#define SMC37c669_CONFIG_OFF_KEY	0xAA</span>

<span class="cm">/*</span>
<span class="cm">** SMC 37c669 Device IRQs</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_A	    ( SMC37c669_DEVICE_IRQ( 0x01 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_B	    ( SMC37c669_DEVICE_IRQ( 0x02 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_C	    ( SMC37c669_DEVICE_IRQ( 0x03 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_D	    ( SMC37c669_DEVICE_IRQ( 0x04 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_E	    ( SMC37c669_DEVICE_IRQ( 0x05 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_F	    ( SMC37c669_DEVICE_IRQ( 0x06 ) )</span>
<span class="cm">/*      SMC37c669_DEVICE_IRQ_G	    *** RESERVED ***/</span>
<span class="cp">#define SMC37c669_DEVICE_IRQ_H	    ( SMC37c669_DEVICE_IRQ( 0x08 ) )</span>

<span class="cm">/*</span>
<span class="cm">** SMC 37c669 Device DMA Channel Definitions</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_DEVICE_DRQ_A		    ( SMC37c669_DEVICE_DRQ( 0x01 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_DRQ_B		    ( SMC37c669_DEVICE_DRQ( 0x02 ) )</span>
<span class="cp">#define SMC37c669_DEVICE_DRQ_C		    ( SMC37c669_DEVICE_DRQ( 0x03 ) )</span>

<span class="cm">/*</span>
<span class="cm">** Configuration Register Index Definitions</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_CR00_INDEX	    0x00</span>
<span class="cp">#define SMC37c669_CR01_INDEX	    0x01</span>
<span class="cp">#define SMC37c669_CR02_INDEX	    0x02</span>
<span class="cp">#define SMC37c669_CR03_INDEX	    0x03</span>
<span class="cp">#define SMC37c669_CR04_INDEX	    0x04</span>
<span class="cp">#define SMC37c669_CR05_INDEX	    0x05</span>
<span class="cp">#define SMC37c669_CR06_INDEX	    0x06</span>
<span class="cp">#define SMC37c669_CR07_INDEX	    0x07</span>
<span class="cp">#define SMC37c669_CR08_INDEX	    0x08</span>
<span class="cp">#define SMC37c669_CR09_INDEX	    0x09</span>
<span class="cp">#define SMC37c669_CR0A_INDEX	    0x0A</span>
<span class="cp">#define SMC37c669_CR0B_INDEX	    0x0B</span>
<span class="cp">#define SMC37c669_CR0C_INDEX	    0x0C</span>
<span class="cp">#define SMC37c669_CR0D_INDEX	    0x0D</span>
<span class="cp">#define SMC37c669_CR0E_INDEX	    0x0E</span>
<span class="cp">#define SMC37c669_CR0F_INDEX	    0x0F</span>
<span class="cp">#define SMC37c669_CR10_INDEX	    0x10</span>
<span class="cp">#define SMC37c669_CR11_INDEX	    0x11</span>
<span class="cp">#define SMC37c669_CR12_INDEX	    0x12</span>
<span class="cp">#define SMC37c669_CR13_INDEX	    0x13</span>
<span class="cp">#define SMC37c669_CR14_INDEX	    0x14</span>
<span class="cp">#define SMC37c669_CR15_INDEX	    0x15</span>
<span class="cp">#define SMC37c669_CR16_INDEX	    0x16</span>
<span class="cp">#define SMC37c669_CR17_INDEX	    0x17</span>
<span class="cp">#define SMC37c669_CR18_INDEX	    0x18</span>
<span class="cp">#define SMC37c669_CR19_INDEX	    0x19</span>
<span class="cp">#define SMC37c669_CR1A_INDEX	    0x1A</span>
<span class="cp">#define SMC37c669_CR1B_INDEX	    0x1B</span>
<span class="cp">#define SMC37c669_CR1C_INDEX	    0x1C</span>
<span class="cp">#define SMC37c669_CR1D_INDEX	    0x1D</span>
<span class="cp">#define SMC37c669_CR1E_INDEX	    0x1E</span>
<span class="cp">#define SMC37c669_CR1F_INDEX	    0x1F</span>
<span class="cp">#define SMC37c669_CR20_INDEX	    0x20</span>
<span class="cp">#define SMC37c669_CR21_INDEX	    0x21</span>
<span class="cp">#define SMC37c669_CR22_INDEX	    0x22</span>
<span class="cp">#define SMC37c669_CR23_INDEX	    0x23</span>
<span class="cp">#define SMC37c669_CR24_INDEX	    0x24</span>
<span class="cp">#define SMC37c669_CR25_INDEX	    0x25</span>
<span class="cp">#define SMC37c669_CR26_INDEX	    0x26</span>
<span class="cp">#define SMC37c669_CR27_INDEX	    0x27</span>
<span class="cp">#define SMC37c669_CR28_INDEX	    0x28</span>
<span class="cp">#define SMC37c669_CR29_INDEX	    0x29</span>

<span class="cm">/*</span>
<span class="cm">** Configuration Register Alias Definitions</span>
<span class="cm">*/</span>
<span class="cp">#define SMC37c669_DEVICE_ID_INDEX		    SMC37c669_CR0D_INDEX</span>
<span class="cp">#define SMC37c669_DEVICE_REVISION_INDEX		    SMC37c669_CR0E_INDEX</span>
<span class="cp">#define SMC37c669_FDC_BASE_ADDRESS_INDEX	    SMC37c669_CR20_INDEX</span>
<span class="cp">#define SMC37c669_IDE_BASE_ADDRESS_INDEX	    SMC37c669_CR21_INDEX</span>
<span class="cp">#define SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX	    SMC37c669_CR22_INDEX</span>
<span class="cp">#define SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX	    SMC37c669_CR23_INDEX</span>
<span class="cp">#define SMC37c669_SERIAL0_BASE_ADDRESS_INDEX	    SMC37c669_CR24_INDEX</span>
<span class="cp">#define SMC37c669_SERIAL1_BASE_ADDRESS_INDEX	    SMC37c669_CR25_INDEX</span>
<span class="cp">#define SMC37c669_PARALLEL_FDC_DRQ_INDEX	    SMC37c669_CR26_INDEX</span>
<span class="cp">#define SMC37c669_PARALLEL_FDC_IRQ_INDEX	    SMC37c669_CR27_INDEX</span>
<span class="cp">#define SMC37c669_SERIAL_IRQ_INDEX		    SMC37c669_CR28_INDEX</span>

<span class="cm">/*</span>
<span class="cm">** Configuration Register Definitions</span>
<span class="cm">**</span>
<span class="cm">** The INDEX (write only) and DATA (read/write) ports are effective </span>
<span class="cm">** only when the chip is in the Configuration State.</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SMC37c669_CONFIG_REGS</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index_port</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_port</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CONFIG_REGS</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR00 - default value 0x28</span>
<span class="cm">**</span>
<span class="cm">**  IDE_EN (CR00&lt;1:0&gt;):</span>
<span class="cm">**	0x - 30ua pull-ups on nIDEEN, nHDCS0, NHDCS1</span>
<span class="cm">**	11 - IRQ_H available as IRQ output,</span>
<span class="cm">**	     IRRX2, IRTX2 available as alternate IR pins</span>
<span class="cm">**	10 - nIDEEN, nHDCS0, nHDCS1 used to control IDE</span>
<span class="cm">**</span>
<span class="cm">**  VALID (CR00&lt;7&gt;):</span>
<span class="cm">**	A high level on this software controlled bit can</span>
<span class="cm">**	be used to indicate that a valid configuration</span>
<span class="cm">**	cycle has occurred.  The control software must</span>
<span class="cm">**	take care to set this bit at the appropriate times.</span>
<span class="cm">**	Set to zero after power up.  This bit has no</span>
<span class="cm">**	effect on any other hardware in the chip.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR00</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ide_en</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* See note above		*/</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* RAZ			*/</span>
	<span class="kt">unsigned</span> <span class="n">fdc_pwr</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = supply power to FDC  */</span>
	<span class="kt">unsigned</span> <span class="n">reserved2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	    <span class="cm">/* Read as 010b		*/</span>
	<span class="kt">unsigned</span> <span class="n">valid</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		*/</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR00</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR01 - default value 0x9C</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR01</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">ppt_pwr</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = supply power to PPT	    */</span>
	<span class="kt">unsigned</span> <span class="n">ppt_mode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = Printer mode, 0 = EPP    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Read as 1		    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">lock_crx</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Lock CR00 - CR18		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR01</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR02 - default value 0x88</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR02</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">uart1_pwr</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = supply power to UART1    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">uart2_pwr</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = supply power to UART2    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR02</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR03 - default value 0x78</span>
<span class="cm">**</span>
<span class="cm">**  CR03&lt;7&gt;	CR03&lt;2&gt;	    Pin 94</span>
<span class="cm">**  -------	-------	    ------</span>
<span class="cm">**     0	   X	    DRV2 (input)</span>
<span class="cm">**     1	   0	    ADRX</span>
<span class="cm">**     1	   1	    IRQ_B</span>
<span class="cm">**</span>
<span class="cm">**  CR03&lt;6&gt;	CR03&lt;5&gt;	    Op Mode</span>
<span class="cm">**  -------	-------	    -------</span>
<span class="cm">**     0	   0	    Model 30</span>
<span class="cm">**     0	   1	    PS/2</span>
<span class="cm">**     1	   0	    Reserved</span>
<span class="cm">**     1	   1	    AT Mode</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR03</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">pwrgd_gamecs</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* 1 = PWRGD, 0 = GAMECS	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdc_mode2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = Enhanced Mode 2	    */</span>
	<span class="kt">unsigned</span> <span class="n">pin94_0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">drvden</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = high, 0 - output	    */</span>
	<span class="kt">unsigned</span> <span class="n">op_mode</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">pin94_1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR03</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR04 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  PP_EXT_MODE:</span>
<span class="cm">**	If CR01&lt;PP_MODE&gt; = 0 and PP_EXT_MODE =</span>
<span class="cm">**	    00 - Standard and Bidirectional</span>
<span class="cm">**	    01 - EPP mode and SPP</span>
<span class="cm">**	    10 - ECP mode</span>
<span class="cm">**		 In this mode, 2 drives can be supported</span>
<span class="cm">**		 directly, 3 or 4 drives must use external</span>
<span class="cm">**		 4 drive support.  SPP can be selected</span>
<span class="cm">**		 through the ECR register of ECP as mode 000.</span>
<span class="cm">**	    11 - ECP mode and EPP mode</span>
<span class="cm">**		 In this mode, 2 drives can be supported</span>
<span class="cm">**		 directly, 3 or 4 drives must use external</span>
<span class="cm">**		 4 drive support.  SPP can be selected</span>
<span class="cm">**		 through the ECR register of ECP as mode 000.</span>
<span class="cm">**		 In this mode, EPP can be selected through</span>
<span class="cm">**		 the ECR register of ECP as mode 100.</span>
<span class="cm">**</span>
<span class="cm">**  PP_FDC:</span>
<span class="cm">**	00 - Normal</span>
<span class="cm">**	01 - PPFD1</span>
<span class="cm">**	10 - PPFD2</span>
<span class="cm">**	11 - Reserved</span>
<span class="cm">**</span>
<span class="cm">**  MIDI1:</span>
<span class="cm">**	Serial Clock Select: </span>
<span class="cm">**	    A low level on this bit disables MIDI support,</span>
<span class="cm">**	    clock = divide by 13.  A high level on this </span>
<span class="cm">**	    bit enables MIDI support, clock = divide by 12.</span>
<span class="cm">**</span>
<span class="cm">**	MIDI operates at 31.25 Kbps which can be derived </span>
<span class="cm">**	from 125 KHz (24 MHz / 12 = 2 MHz, 2 MHz / 16 = 125 KHz)</span>
<span class="cm">**</span>
<span class="cm">**  ALT_IO:</span>
<span class="cm">**	0 - Use pins IRRX, IRTX</span>
<span class="cm">**	1 - Use pins IRRX2, IRTX2</span>
<span class="cm">**</span>
<span class="cm">**	If this bit is set, the IR receive and transmit</span>
<span class="cm">**	functions will not be available on pins 25 and 26</span>
<span class="cm">**	unless CR00&lt;IDE_EN&gt; = 11.</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR04</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ppt_ext_mode</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">ppt_fdc</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">midi1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">midi2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">epp_type</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 0 = EPP 1.9, 1 = EPP 1.7	    */</span>
	<span class="kt">unsigned</span> <span class="n">alt_io</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR04</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR05 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  DEN_SEL:</span>
<span class="cm">**	00 - Densel output normal</span>
<span class="cm">**	01 - Reserved</span>
<span class="cm">**	10 - Densel output 1</span>
<span class="cm">**	11 - Densel output 0</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR05</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* RAZ					*/</span>
	<span class="kt">unsigned</span> <span class="n">fdc_dma_mode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* 0 = burst, 1 = non-burst			*/</span>
	<span class="kt">unsigned</span> <span class="n">den_sel</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* See note above				*/</span>
	<span class="kt">unsigned</span> <span class="n">swap_drv</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Swap the FDC motor selects		*/</span>
	<span class="kt">unsigned</span> <span class="n">extx4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 0 = 2 drive, 1 = external 4 drive decode	*/</span>
	<span class="kt">unsigned</span> <span class="n">reserved2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* RAZ					*/</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR05</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR06 - default value 0xFF</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR06</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">floppy_a</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* Type of floppy drive A	    */</span>
	<span class="kt">unsigned</span> <span class="n">floppy_b</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* Type of floppy drive B	    */</span>
	<span class="kt">unsigned</span> <span class="n">floppy_c</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* Type of floppy drive C	    */</span>
	<span class="kt">unsigned</span> <span class="n">floppy_d</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* Type of floppy drive D	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR06</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR07 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  Auto Power Management CR07&lt;7:4&gt;:</span>
<span class="cm">**	0 - Auto Powerdown disabled (default)</span>
<span class="cm">**	1 - Auto Powerdown enabled</span>
<span class="cm">**</span>
<span class="cm">**	This bit is reset to the default state by POR or</span>
<span class="cm">**	a hardware reset.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR07</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">floppy_boot</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* 0 = A:, 1 = B:		    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">ppt_en</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">uart1_en</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">uart2_en</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">fdc_en</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR07</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR08 - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR08</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addrx7_4</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* ADR&lt;7:3&gt; for ADRx decode	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR08</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR09 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  ADRx_CONFIG:</span>
<span class="cm">**	00 - ADRx disabled</span>
<span class="cm">**	01 - 1 byte decode A&lt;3:0&gt; = 0000b</span>
<span class="cm">**	10 - 8 byte block decode A&lt;3:0&gt; = 0XXXb</span>
<span class="cm">**	11 - 16 byte block decode A&lt;3:0&gt; = XXXXb</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR09</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">adra8</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	    <span class="cm">/* ADR&lt;10:8&gt; for ADRx decode    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">adrx_config</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR09</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0A - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0A</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ecp_fifo_threshold</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0A</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0B - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0B</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">fdd0_drtx</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* FDD0 Data Rate Table	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd1_drtx</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* FDD1 Data Rate Table	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd2_drtx</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* FDD2 Data Rate Table	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd3_drtx</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* FDD3 Data Rate Table	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0B</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0C - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  UART2_MODE:</span>
<span class="cm">**	000 - Standard (default)</span>
<span class="cm">**	001 - IrDA (HPSIR)</span>
<span class="cm">**	010 - Amplitude Shift Keyed IR @500 KHz</span>
<span class="cm">**	011 - Reserved</span>
<span class="cm">**	1xx - Reserved</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0C</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">uart2_rcv_polarity</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>    <span class="cm">/* 1 = invert RX		*/</span>
	<span class="kt">unsigned</span> <span class="n">uart2_xmit_polarity</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* 1 = invert TX		*/</span>
	<span class="kt">unsigned</span> <span class="n">uart2_duplex</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = full, 0 = half	*/</span>
	<span class="kt">unsigned</span> <span class="n">uart2_mode</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	    <span class="cm">/* See note above		*/</span>
	<span class="kt">unsigned</span> <span class="n">uart1_speed</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = high speed enabled	*/</span>
	<span class="kt">unsigned</span> <span class="n">uart2_speed</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 1 = high speed enabled	*/</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0C</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0D - default value 0x03</span>
<span class="cm">**</span>
<span class="cm">**  Device ID Register - read only</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0D</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">device_id</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>	    <span class="cm">/* Returns 0x3 in this field    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0D</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0E - default value 0x02</span>
<span class="cm">**</span>
<span class="cm">**  Device Revision Register - read only</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0E</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">device_rev</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>    <span class="cm">/* Returns 0x2 in this field    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0E</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR0F - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR0F</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">test0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set to 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set to 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set to 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set t0 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set to 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set t0 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test6</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set t0 0	    */</span>
	<span class="kt">unsigned</span> <span class="n">test7</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Reserved - set to 0	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR0F</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR10 - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR10</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>	     <span class="cm">/* RAZ			    */</span>
	<span class="kt">unsigned</span> <span class="n">pll_gain</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	     <span class="cm">/* 1 = 3V, 2 = 5V operation    */</span>
	<span class="kt">unsigned</span> <span class="n">pll_stop</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	     <span class="cm">/* 1 = stop PLLs		    */</span>
	<span class="kt">unsigned</span> <span class="n">ace_stop</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	     <span class="cm">/* 1 = stop UART clocks	    */</span>
	<span class="kt">unsigned</span> <span class="n">pll_clock_ctrl</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 0 = 14.318 MHz, 1 = 24 MHz  */</span>
	<span class="kt">unsigned</span> <span class="n">ir_test</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	     <span class="cm">/* Enable IR test mode	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR10</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR11 - default value 0x00</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR11</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ir_loopback</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>   <span class="cm">/* Internal IR loop back		    */</span>
	<span class="kt">unsigned</span> <span class="n">test_10ms</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* Test 10ms autopowerdown FDC timeout  */</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>	    <span class="cm">/* RAZ				    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR11</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR12 - CR1D are reserved registers</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">** CR1E - default value 0x80</span>
<span class="cm">**</span>
<span class="cm">**  GAMECS:</span>
<span class="cm">**	00 - GAMECS disabled</span>
<span class="cm">**	01 - 1 byte decode ADR&lt;3:0&gt; = 0001b</span>
<span class="cm">**	10 - 8 byte block decode ADR&lt;3:0&gt; = 0XXXb</span>
<span class="cm">**	11 - 16 byte block decode ADR&lt;3:0&gt; = XXXXb</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c66_CR1E</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">gamecs_config</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">gamecs_addr9_4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* GAMECS Addr&lt;9:4&gt;	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR1E</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR1F - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  DT0 DT1 DRVDEN0 DRVDEN1 Drive Type</span>
<span class="cm">**  --- --- ------- ------- ----------</span>
<span class="cm">**   0   0  DENSEL  DRATE0  4/2/1 MB 3.5&quot;</span>
<span class="cm">**                          2/1 MB 5.25&quot;</span>
<span class="cm">**                          2/1.6/1 MB 3.5&quot; (3-mode)</span>
<span class="cm">**   0   1  DRATE1  DRATE0</span>
<span class="cm">**   1   0  nDENSEL DRATE0  PS/2</span>
<span class="cm">**   1   1  DRATE0  DRATE1</span>
<span class="cm">**</span>
<span class="cm">**  Note: DENSEL, DRATE1, and DRATE0 map onto two output</span>
<span class="cm">**	  pins - DRVDEN0 and DRVDEN1.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR1F</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">fdd0_drive_type</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* FDD0 drive type	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd1_drive_type</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* FDD1 drive type	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd2_drive_type</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* FDD2 drive type	    */</span>
	<span class="kt">unsigned</span> <span class="n">fdd3_drive_type</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* FDD3 drive type	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR1F</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR20 - default value 0x3C</span>
<span class="cm">**</span>
<span class="cm">**  FDC Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0, A&lt;3:0&gt; = 0XXXb to access.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR20</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addr9_4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>	    <span class="cm">/* FDC Addr&lt;9:4&gt;		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR20</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR21 - default value 0x3C</span>
<span class="cm">**</span>
<span class="cm">**  IDE Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0, A&lt;3:0&gt; = 0XXXb to access.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR21</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addr9_4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>	    <span class="cm">/* IDE Addr&lt;9:4&gt;		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR21</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR22 - default value 0x3D</span>
<span class="cm">**</span>
<span class="cm">**  IDE Alternate Status Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0, A&lt;3:0&gt; = 0110b to access.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR22</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addr9_4</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>	    <span class="cm">/* IDE Alt Status Addr&lt;9:4&gt;	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR22</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR23 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  Parallel Port Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0 to access.</span>
<span class="cm">**	- If EPP is enabled, A&lt;2:0&gt; = XXXb to access.</span>
<span class="cm">**	  If EPP is NOT enabled, A&lt;1:0&gt; = XXb to access</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR23</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">addr9_2</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>	    <span class="cm">/* Parallel Port Addr&lt;9:2&gt;	    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR23</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR24 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  UART1 Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0, A&lt;2:0&gt; = XXXb to access.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR24</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addr9_3</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>	    <span class="cm">/* UART1 Addr&lt;9:3&gt;		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR24</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR25 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  UART2 Base Address Register</span>
<span class="cm">**	- To disable this decode set Addr&lt;9:8&gt; = 0</span>
<span class="cm">**	- A&lt;10&gt; = 0, A&lt;2:0&gt; = XXXb to access.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR25</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">zero</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	    <span class="cm">/* 0			    */</span>
	<span class="kt">unsigned</span> <span class="n">addr9_3</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>	    <span class="cm">/* UART2 Addr&lt;9:3&gt;		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR25</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR26 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  Parallel Port / FDC DMA Select Register</span>
<span class="cm">**</span>
<span class="cm">**  D3 - D0	  DMA</span>
<span class="cm">**  D7 - D4	Selected</span>
<span class="cm">**  -------	--------</span>
<span class="cm">**   0000	 None</span>
<span class="cm">**   0001	 DMA_A</span>
<span class="cm">**   0010	 DMA_B</span>
<span class="cm">**   0011	 DMA_C</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR26</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ppt_drq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">fdc_drq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR26</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR27 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  Parallel Port / FDC IRQ Select Register</span>
<span class="cm">**</span>
<span class="cm">**  D3 - D0	  IRQ</span>
<span class="cm">**  D7 - D4	Selected</span>
<span class="cm">**  -------	--------</span>
<span class="cm">**   0000	 None</span>
<span class="cm">**   0001	 IRQ_A</span>
<span class="cm">**   0010	 IRQ_B</span>
<span class="cm">**   0011	 IRQ_C</span>
<span class="cm">**   0100	 IRQ_D</span>
<span class="cm">**   0101	 IRQ_E</span>
<span class="cm">**   0110	 IRQ_F</span>
<span class="cm">**   0111	 Reserved</span>
<span class="cm">**   1000	 IRQ_H</span>
<span class="cm">**</span>
<span class="cm">**  Any unselected IRQ REQ is in tristate</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR27</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">ppt_irq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">fdc_irq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR27</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR28 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  UART IRQ Select Register</span>
<span class="cm">**</span>
<span class="cm">**  D3 - D0	  IRQ</span>
<span class="cm">**  D7 - D4	Selected</span>
<span class="cm">**  -------	--------</span>
<span class="cm">**   0000	 None</span>
<span class="cm">**   0001	 IRQ_A</span>
<span class="cm">**   0010	 IRQ_B</span>
<span class="cm">**   0011	 IRQ_C</span>
<span class="cm">**   0100	 IRQ_D</span>
<span class="cm">**   0101	 IRQ_E</span>
<span class="cm">**   0110	 IRQ_F</span>
<span class="cm">**   0111	 Reserved</span>
<span class="cm">**   1000	 IRQ_H</span>
<span class="cm">**   1111	 share with UART1 (only for UART2)</span>
<span class="cm">**</span>
<span class="cm">**  Any unselected IRQ REQ is in tristate</span>
<span class="cm">**</span>
<span class="cm">**  To share an IRQ between UART1 and UART2, set</span>
<span class="cm">**  UART1 to use the desired IRQ and set UART2 to</span>
<span class="cm">**  0xF to enable sharing mechanism.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR28</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">uart2_irq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">uart1_irq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR28</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** CR29 - default value 0x00</span>
<span class="cm">**</span>
<span class="cm">**  IRQIN IRQ Select Register</span>
<span class="cm">**</span>
<span class="cm">**  D3 - D0	  IRQ</span>
<span class="cm">**  D7 - D4	Selected</span>
<span class="cm">**  -------	--------</span>
<span class="cm">**   0000	 None</span>
<span class="cm">**   0001	 IRQ_A</span>
<span class="cm">**   0010	 IRQ_B</span>
<span class="cm">**   0011	 IRQ_C</span>
<span class="cm">**   0100	 IRQ_D</span>
<span class="cm">**   0101	 IRQ_E</span>
<span class="cm">**   0110	 IRQ_F</span>
<span class="cm">**   0111	 Reserved</span>
<span class="cm">**   1000	 IRQ_H</span>
<span class="cm">**</span>
<span class="cm">**  Any unselected IRQ REQ is in tristate</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_SMC37c669_CR29</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">as_uchar</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="n">irqin_irq</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* See note above		    */</span>
	<span class="kt">unsigned</span> <span class="n">reserved1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>	    <span class="cm">/* RAZ			    */</span>
    <span class="p">}</span>	<span class="n">by_field</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_CR29</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** Aliases of Configuration Register formats (should match</span>
<span class="cm">** the set of index aliases).</span>
<span class="cm">**</span>
<span class="cm">** Note that CR24 and CR25 have the same format and are the</span>
<span class="cm">** base address registers for UART1 and UART2.  Because of</span>
<span class="cm">** this we only define 1 alias here - for CR24 - as the serial</span>
<span class="cm">** base address register.</span>
<span class="cm">**</span>
<span class="cm">** Note that CR21 and CR22 have the same format and are the</span>
<span class="cm">** base address and alternate status address registers for</span>
<span class="cm">** the IDE controller.  Because of this we only define 1 alias</span>
<span class="cm">** here - for CR21 - as the IDE address register.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR0D</span> <span class="n">SMC37c669_DEVICE_ID_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR0E</span> <span class="n">SMC37c669_DEVICE_REVISION_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR20</span> <span class="n">SMC37c669_FDC_BASE_ADDRESS_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR21</span> <span class="n">SMC37c669_IDE_ADDRESS_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR23</span> <span class="n">SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR24</span> <span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR26</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR27</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">SMC37c669_CR28</span> <span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** ISA/Device IRQ Translation Table Entry Definition</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SMC37c669_IRQ_TRANSLATION_ENTRY</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">device_irq</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">isa_irq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_IRQ_TRANSLATION_ENTRY</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** ISA/Device DMA Translation Table Entry Definition</span>
<span class="cm">*/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SMC37c669_DRQ_TRANSLATION_ENTRY</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">device_drq</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">isa_drq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SMC37c669_DRQ_TRANSLATION_ENTRY</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** External Interface Function Prototype Declarations</span>
<span class="cm">*/</span>

<span class="n">SMC37c669_CONFIG_REGS</span> <span class="o">*</span><span class="n">SMC37c669_detect</span><span class="p">(</span> 
    <span class="kt">int</span>
<span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SMC37c669_enable_device</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> 
<span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SMC37c669_disable_device</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> 
<span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SMC37c669_configure_device</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span><span class="p">,</span> 
    <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> 
    <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> 
    <span class="kt">int</span> <span class="n">drq</span> 
<span class="p">);</span>

<span class="kt">void</span> <span class="n">SMC37c669_display_device_info</span><span class="p">(</span> 
    <span class="kt">void</span> 
<span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* __SMC37c669_H */</span><span class="cp"></span>

<span class="cm">/* file:	smcc669.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1997 by</span>
<span class="cm"> * Digital Equipment Corporation, Maynard, Massachusetts.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This software is furnished under a license and may be used and copied</span>
<span class="cm"> * only  in  accordance  of  the  terms  of  such  license  and with the</span>
<span class="cm"> * inclusion of the above copyright notice. This software or  any  other</span>
<span class="cm"> * copies thereof may not be provided or otherwise made available to any</span>
<span class="cm"> * other person.  No title to and  ownership of the  software is  hereby</span>
<span class="cm"> * transferred.</span>
<span class="cm"> *</span>
<span class="cm"> * The information in this software is  subject to change without notice</span>
<span class="cm"> * and  should  not  be  construed  as a commitment by digital equipment</span>
<span class="cm"> * corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * Digital assumes no responsibility for the use  or  reliability of its</span>
<span class="cm"> * software on equipment which is not supplied by digital.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *++</span>
<span class="cm"> *  FACILITY:</span>
<span class="cm"> *</span>
<span class="cm"> *      Alpha SRM Console Firmware</span>
<span class="cm"> *</span>
<span class="cm"> *  MODULE DESCRIPTION:</span>
<span class="cm"> *</span>
<span class="cm"> *	SMC37c669 Super I/O controller configuration routines.</span>
<span class="cm"> *</span>
<span class="cm"> *  AUTHORS:</span>
<span class="cm"> *</span>
<span class="cm"> *	Eric Rasmussen</span>
<span class="cm"> *</span>
<span class="cm"> *  CREATION DATE:</span>
<span class="cm"> *  </span>
<span class="cm"> *	28-Jan-1997</span>
<span class="cm"> *</span>
<span class="cm"> *  MODIFICATION HISTORY:</span>
<span class="cm"> *	</span>
<span class="cm"> *	er	01-May-1997	Fixed pointer conversion errors in </span>
<span class="cm"> *				SMC37c669_get_device_config().</span>
<span class="cm"> *      er	28-Jan-1997	Initial version.</span>
<span class="cm"> *</span>
<span class="cm"> *--</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* $INCLUDE_OPTIONS$ */</span>
<span class="c">#include    &quot;cp$inc:platform_io.h&quot;</span>
<span class="c">/* $INCLUDE_OPTIONS_END$ */</span>
<span class="c">#include    &quot;cp$src:common.h&quot;</span>
<span class="c">#include    &quot;cp$inc:prototypes.h&quot;</span>
<span class="c">#include    &quot;cp$src:kernel_def.h&quot;</span>
<span class="c">#include    &quot;cp$src:msg_def.h&quot;</span>
<span class="c">#include    &quot;cp$src:smcc669_def.h&quot;</span>
<span class="c">/* Platform-specific includes */</span>
<span class="c">#include    &quot;cp$src:platform.h&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef TRUE</span>
<span class="cp">#define TRUE 1</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef FALSE</span>
<span class="cp">#define FALSE 0</span>
<span class="cp">#endif</span>

<span class="cp">#define wb( _x_, _y_ )	outb( _y_, (unsigned int)((unsigned long)_x_) )</span>
<span class="cp">#define rb( _x_ )	inb( (unsigned int)((unsigned long)_x_) )</span>

<span class="cm">/*</span>
<span class="cm">** Local storage for device configuration information.</span>
<span class="cm">**</span>
<span class="cm">** Since the SMC37c669 does not provide an explicit</span>
<span class="cm">** mechanism for enabling/disabling individual device </span>
<span class="cm">** functions, other than unmapping the device, local </span>
<span class="cm">** storage for device configuration information is </span>
<span class="cm">** allocated here for use in implementing our own </span>
<span class="cm">** function enable/disable scheme.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">DEVICE_CONFIG</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port2</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">drq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">local_config</span> <span class="p">[</span><span class="n">NUM_FUNCS</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm">** List of all possible addresses for the Super I/O chip</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">SMC37c669_Addresses</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
    <span class="p">{</span>
	<span class="mh">0x3F0UL</span><span class="p">,</span>	    <span class="cm">/* Primary address	    */</span>
	<span class="mh">0x370UL</span><span class="p">,</span>	    <span class="cm">/* Secondary address    */</span>
	<span class="mi">0UL</span>		    <span class="cm">/* End of list	    */</span>
    <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** Global Pointer to the Super I/O device</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_CONFIG_REGS</span> <span class="o">*</span><span class="n">SMC37c669</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** IRQ Translation Table</span>
<span class="cm">**</span>
<span class="cm">** The IRQ translation table is a list of SMC37c669 device </span>
<span class="cm">** and standard ISA IRQs.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_IRQ_TRANSLATION_ENTRY</span> <span class="o">*</span><span class="n">SMC37c669_irq_table</span> <span class="n">__initdata</span><span class="p">;</span> 

<span class="cm">/*</span>
<span class="cm">** The following definition is for the default IRQ </span>
<span class="cm">** translation table.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_IRQ_TRANSLATION_ENTRY</span> <span class="n">SMC37c669_default_irq_table</span><span class="p">[]</span>
<span class="n">__initdata</span> <span class="o">=</span> 
    <span class="p">{</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_C</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_D</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_E</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_F</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_H</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="cm">/* End of table */</span>
    <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** The following definition is for the MONET (XP1000) IRQ </span>
<span class="cm">** translation table.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_IRQ_TRANSLATION_ENTRY</span> <span class="n">SMC37c669_monet_irq_table</span><span class="p">[]</span>
<span class="n">__initdata</span> <span class="o">=</span> 
    <span class="p">{</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_B</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_C</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_D</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_E</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_F</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_IRQ_H</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="cm">/* End of table */</span>
    <span class="p">};</span>

<span class="k">static</span> <span class="n">SMC37c669_IRQ_TRANSLATION_ENTRY</span> <span class="o">*</span><span class="n">SMC37c669_irq_tables</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
    <span class="p">{</span>
	<span class="n">SMC37c669_default_irq_table</span><span class="p">,</span>
	<span class="n">SMC37c669_monet_irq_table</span>
    <span class="p">};</span> 

<span class="cm">/*</span>
<span class="cm">** DRQ Translation Table</span>
<span class="cm">**</span>
<span class="cm">** The DRQ translation table is a list of SMC37c669 device and</span>
<span class="cm">** ISA DMA channels.</span>
<span class="cm">**</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_DRQ_TRANSLATION_ENTRY</span> <span class="o">*</span><span class="n">SMC37c669_drq_table</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** The following definition is the default DRQ</span>
<span class="cm">** translation table.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">SMC37c669_DRQ_TRANSLATION_ENTRY</span> <span class="n">SMC37c669_default_drq_table</span><span class="p">[]</span>
<span class="n">__initdata</span> <span class="o">=</span> 
    <span class="p">{</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_DRQ_A</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_DRQ_B</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="n">SMC37c669_DEVICE_DRQ_C</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">}</span> <span class="cm">/* End of table */</span>
    <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">** Local Function Prototype Declarations</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> 
<span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static unsigned int SMC37c669_get_device_config( </span>
<span class="c">    unsigned int func, </span>
<span class="c">    int *port, </span>
<span class="c">    int *irq, </span>
<span class="c">    int *drq </span>
<span class="c">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">SMC37c669_config_mode</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span> 
<span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SMC37c669_read_config</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span> 
<span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">SMC37c669_write_config</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">,</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> 
<span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">SMC37c669_init_local_config</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">DEVICE_CONFIG</span> <span class="o">*</span><span class="n">SMC37c669_get_config</span><span class="p">(</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span>
<span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">SMC37c669_xlate_irq</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">irq</span> 
<span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">SMC37c669_xlate_drq</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">drq</span> 
<span class="p">);</span>

<span class="k">static</span>  <span class="n">__cacheline_aligned</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">smc_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function detects the presence of an SMC37c669 Super I/O</span>
<span class="cm">**	controller.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**	None</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns a pointer to the device if found, otherwise,</span>
<span class="cm">**	the NULL pointer is returned.</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="n">SMC37c669_CONFIG_REGS</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">SMC37c669_detect</span><span class="p">(</span> <span class="kt">int</span> <span class="n">index</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">SMC37c669_DEVICE_ID_REGISTER</span> <span class="n">id</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">SMC37c669_Addresses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** Initialize the device pointer even though we don&#39;t yet know if</span>
<span class="cm">** the controller is at this address.  The support functions access</span>
<span class="cm">** the controller through this device pointer so we need to set it</span>
<span class="cm">** even when we are looking ...</span>
<span class="cm">*/</span>
    	<span class="n">SMC37c669</span> <span class="o">=</span> <span class="p">(</span> <span class="n">SMC37c669_CONFIG_REGS</span> <span class="o">*</span> <span class="p">)</span><span class="n">SMC37c669_Addresses</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cm">/*</span>
<span class="cm">** Enter configuration mode</span>
<span class="cm">*/</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Read the device id</span>
<span class="cm">*/</span>
	<span class="n">id</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_DEVICE_ID_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Exit configuration mode</span>
<span class="cm">*/</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Does the device id match?  If so, assume we have found an</span>
<span class="cm">** SMC37c669 controller at this address.</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">id</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">SMC37c669_DEVICE_ID</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** Initialize the IRQ and DRQ translation tables.</span>
<span class="cm">*/</span>
    	    <span class="n">SMC37c669_irq_table</span> <span class="o">=</span> <span class="n">SMC37c669_irq_tables</span><span class="p">[</span> <span class="n">index</span> <span class="p">];</span>
	    <span class="n">SMC37c669_drq_table</span> <span class="o">=</span> <span class="n">SMC37c669_default_drq_table</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** erfix</span>
<span class="cm">**</span>
<span class="cm">** If the platform can&#39;t use the IRQ and DRQ defaults set up in this </span>
<span class="cm">** file, it should call a platform-specific external routine at this </span>
<span class="cm">** point to reset the IRQ and DRQ translation table pointers to point </span>
<span class="cm">** at the appropriate tables for the platform.  If the defaults are </span>
<span class="cm">** acceptable, then the external routine should do nothing.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">** Put the chip back into configuration mode</span>
<span class="cm">*/</span>
	    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Initialize local storage for configuration information</span>
<span class="cm">*/</span>
	    <span class="n">SMC37c669_init_local_config</span><span class="p">(</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Exit configuration mode</span>
<span class="cm">*/</span>
	    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** SMC37c669 controller found, break out of search loop</span>
<span class="cm">*/</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** Otherwise, we did not find an SMC37c669 controller at this</span>
<span class="cm">** address so set the device pointer to NULL.</span>
<span class="cm">*/</span>
	    <span class="n">SMC37c669</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">SMC37c669</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function enables an SMC37c669 device function.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      func:</span>
<span class="cm">**          Which device function to enable</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns TRUE is the device function was enabled, otherwise, FALSE</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**  DESIGN:</span>
<span class="cm">**</span>
<span class="cm">**      Enabling a device function in the SMC37c669 controller involves</span>
<span class="cm">**	setting all of its mappings (port, irq, drq ...).  A local </span>
<span class="cm">**	&quot;shadow&quot; copy of the device configuration is kept so we can</span>
<span class="cm">**	just set each mapping to what the local copy says.</span>
<span class="cm">**</span>
<span class="cm">**	This function ALWAYS updates the local shadow configuration of</span>
<span class="cm">**	the device function being enabled, even if the device is always</span>
<span class="cm">**	enabled.  To avoid replication of code, functions such as</span>
<span class="cm">**	configure_device set up the local copy and then call this </span>
<span class="cm">**	function to the update the real device.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_enable_device</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Put the device into configuration mode</span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="k">case</span> <span class="n">SERIAL_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enable the serial 1 IRQ mapping</span>
<span class="cm">*/</span>
	    	<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart1_irq</span> <span class="o">=</span>
		    <span class="n">SMC37c669_RAW_DEVICE_IRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">irq</span> <span class="p">)</span>
		    <span class="p">);</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the serial 1 port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_3</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_SERIAL0_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">SERIAL_1</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enable the serial 2 IRQ mapping</span>
<span class="cm">*/</span>
	    	<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart2_irq</span> <span class="o">=</span>
		    <span class="n">SMC37c669_RAW_DEVICE_IRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">irq</span> <span class="p">)</span>
		    <span class="p">);</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the serial 2 port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_3</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_SERIAL1_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">PARALLEL_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span> <span class="n">drq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enable the parallel port DMA channel mapping</span>
<span class="cm">*/</span>
	    	<span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span> <span class="p">);</span>

		<span class="n">drq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_drq</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_RAW_DEVICE_DRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_drq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">drq</span> <span class="p">)</span>
		    <span class="p">);</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span><span class="p">,</span>
		    <span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the parallel port IRQ mapping</span>
<span class="cm">*/</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_irq</span> <span class="o">=</span>
		    <span class="n">SMC37c669_RAW_DEVICE_IRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">irq</span> <span class="p">)</span>
		    <span class="p">);</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span><span class="p">,</span>
		    <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the parallel port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_2</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">FLOPPY_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_FDC_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span> <span class="n">drq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enable the floppy controller DMA channel mapping</span>
<span class="cm">*/</span>
	    	<span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span> <span class="p">);</span>
		 
		<span class="n">drq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_drq</span> <span class="o">=</span>
		    <span class="n">SMC37c669_RAW_DEVICE_DRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_drq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">drq</span> <span class="p">)</span>
		    <span class="p">);</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span><span class="p">,</span>
		    <span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the floppy controller IRQ mapping</span>
<span class="cm">*/</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span> <span class="p">);</span>
		 
		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_irq</span> <span class="o">=</span>
		    <span class="n">SMC37c669_RAW_DEVICE_IRQ</span><span class="p">(</span>
			<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">irq</span> <span class="p">)</span>
		    <span class="p">);</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span><span class="p">,</span>
		    <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the floppy controller base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_FDC_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">IDE_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_IDE_ADDRESS_REGISTER</span> <span class="n">ide_addr</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enable the IDE alternate status base address mapping</span>
<span class="cm">*/</span>
	    	<span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ide_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port2</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Enable the IDE controller base address mapping</span>
<span class="cm">*/</span>
		<span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ide_addr</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">=</span> <span class="n">local_config</span><span class="p">[</span> <span class="n">func</span> <span class="p">].</span><span class="n">port1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_IDE_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
    <span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">** Exit configuration mode and return</span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function disables a device function within the</span>
<span class="cm">**	SMC37c669 Super I/O controller.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      func:</span>
<span class="cm">**          Which function to disable</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Return TRUE if the device function was disabled, otherwise, FALSE</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**  DESIGN:</span>
<span class="cm">**</span>
<span class="cm">**      Disabling a function in the SMC37c669 device involves</span>
<span class="cm">**	disabling all the function&#39;s mappings (port, irq, drq ...).</span>
<span class="cm">**	A shadow copy of the device configuration is maintained</span>
<span class="cm">**	in local storage so we won&#39;t worry aboving saving the</span>
<span class="cm">**	current configuration information.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_disable_device</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** Put the device into configuration mode</span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="k">case</span> <span class="n">SERIAL_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Disable the serial 1 IRQ mapping</span>
<span class="cm">*/</span>
	    	<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart1_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the serial 1 port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_SERIAL0_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">SERIAL_1</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Disable the serial 2 IRQ mapping</span>
<span class="cm">*/</span>
	    	<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart2_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span><span class="p">,</span> <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the serial 2 port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_SERIAL1_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">PARALLEL_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span> <span class="n">drq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Disable the parallel port DMA channel mapping</span>
<span class="cm">*/</span>
	    	<span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span> <span class="p">);</span>

		<span class="n">drq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_drq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span><span class="p">,</span>
		    <span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the parallel port IRQ mapping</span>
<span class="cm">*/</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span> <span class="p">);</span>

		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span><span class="p">,</span>
		    <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the parallel port base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">FLOPPY_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_FDC_BASE_ADDRESS_REGISTER</span> <span class="n">base_addr</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span> <span class="n">irq</span><span class="p">;</span>
		<span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span> <span class="n">drq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Disable the floppy controller DMA channel mapping</span>
<span class="cm">*/</span>
	    	<span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span> <span class="p">);</span>
		 
		<span class="n">drq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_drq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span> 
		    <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span><span class="p">,</span>
		    <span class="n">drq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the floppy controller IRQ mapping</span>
<span class="cm">*/</span>
		<span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
		    <span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span> <span class="p">);</span>
		 
		<span class="n">irq</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span><span class="p">,</span>
		    <span class="n">irq</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the floppy controller base address mapping</span>
<span class="cm">*/</span>
		<span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_FDC_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">base_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="k">case</span> <span class="n">IDE_0</span>:
	    <span class="p">{</span>
	    	<span class="n">SMC37c669_IDE_ADDRESS_REGISTER</span> <span class="n">ide_addr</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Disable the IDE alternate status base address mapping</span>
<span class="cm">*/</span>
	    	<span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Disable the IDE controller base address mapping</span>
<span class="cm">*/</span>
		<span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 
		<span class="n">SMC37c669_write_config</span><span class="p">(</span>
		    <span class="n">SMC37c669_IDE_BASE_ADDRESS_INDEX</span><span class="p">,</span>
		    <span class="n">ide_addr</span><span class="p">.</span><span class="n">as_uchar</span>
		<span class="p">);</span>
		<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
    <span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">** Exit configuration mode and return</span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function configures a device function within the </span>
<span class="cm">**	SMC37c669 Super I/O controller.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      func:</span>
<span class="cm">**          Which device function</span>
<span class="cm">**       </span>
<span class="cm">**      port:</span>
<span class="cm">**          I/O port for the function to use</span>
<span class="cm">**	 </span>
<span class="cm">**      irq:</span>
<span class="cm">**          IRQ for the device function to use</span>
<span class="cm">**	 </span>
<span class="cm">**      drq:</span>
<span class="cm">**          DMA channel for the device function to use</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns TRUE if the device function was configured, </span>
<span class="cm">**	otherwise, FALSE.</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**  DESIGN:</span>
<span class="cm">**</span>
<span class="cm">**	If this function returns TRUE, the local shadow copy of</span>
<span class="cm">**	the configuration is also updated.  If the device function</span>
<span class="cm">**	is currently disabled, only the local shadow copy is </span>
<span class="cm">**	updated and the actual device function will be updated</span>
<span class="cm">**	if/when it is enabled.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_configure_device</span> <span class="p">(</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">drq</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">DEVICE_CONFIG</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** Check for a valid configuration</span>
<span class="cm">*/</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">cp</span> <span class="o">=</span> <span class="n">SMC37c669_get_config</span> <span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** Configuration is valid, update the local shadow copy</span>
<span class="cm">*/</span>
    	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">drq</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">drq</span> <span class="o">=</span> <span class="n">drq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">irq</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFF</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">port</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFF</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">cp</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">** If the device function is enabled, update the actual</span>
<span class="cm">** device configuration.</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="n">SMC37c669_enable_device</span><span class="p">(</span> <span class="n">func</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function determines whether a device function</span>
<span class="cm">**	within the SMC37c669 controller is enabled.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      func:</span>
<span class="cm">**          Which device function</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns TRUE if the device function is enabled, otherwise, FALSE</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**  DESIGN:</span>
<span class="cm">**</span>
<span class="cm">**      To check whether a device is enabled we will only look at </span>
<span class="cm">**	the port base address mapping.  According to the SMC37c669</span>
<span class="cm">**	specification, all of the port base address mappings are</span>
<span class="cm">**	disabled if the addr&lt;9:8&gt; (bits &lt;7:6&gt; of the register) are</span>
<span class="cm">**	zero.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_is_device_enabled</span> <span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">base_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">** Enter configuration mode</span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
     
    <span class="k">switch</span> <span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="k">case</span> <span class="n">SERIAL_0</span>:
	    <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL0_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
	    <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SERIAL_1</span>:
	    <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL1_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
	    <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARALLEL_0</span>:
	    <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
	    <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLOPPY_0</span>:
	    <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_FDC_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
	    <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IDE_0</span>:
	    <span class="n">base_addr</span> <span class="o">=</span>
		<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_IDE_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
	    <span class="n">dev_ok</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">** If we have a valid device, check base_addr&lt;7:6&gt; to see if the</span>
<span class="cm">** device is enabled (mapped).</span>
<span class="cm">*/</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">dev_ok</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="p">(</span> <span class="n">base_addr</span> <span class="o">&amp;</span> <span class="mh">0xC0</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** The mapping is not disabled, so assume that the function is </span>
<span class="cm">** enabled.</span>
<span class="cm">*/</span>
    	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cm">/*</span>
<span class="cm">** Exit configuration mode </span>
<span class="cm">*/</span>
    <span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>

    <span class="k">return</span> <span class="n">ret_val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c">**++</span>
<span class="c">**  FUNCTIONAL DESCRIPTION:</span>
<span class="c">**</span>
<span class="c">**      This function retrieves the configuration information of a </span>
<span class="c">**	device function within the SMC37c699 Super I/O controller.</span>
<span class="c">**</span>
<span class="c">**  FORMAL PARAMETERS:</span>
<span class="c">**</span>
<span class="c">**      func:</span>
<span class="c">**          Which device function</span>
<span class="c">**       </span>
<span class="c">**      port:</span>
<span class="c">**          I/O port returned</span>
<span class="c">**	 </span>
<span class="c">**      irq:</span>
<span class="c">**          IRQ returned</span>
<span class="c">**	 </span>
<span class="c">**      drq:</span>
<span class="c">**          DMA channel returned</span>
<span class="c">**</span>
<span class="c">**  RETURN VALUE:</span>
<span class="c">**</span>
<span class="c">**      Returns TRUE if the device configuration was successfully</span>
<span class="c">**	retrieved, otherwise, FALSE.</span>
<span class="c">**</span>
<span class="c">**  SIDE EFFECTS:</span>
<span class="c">**</span>
<span class="c">**      The data pointed to by the port, irq, and drq parameters</span>
<span class="c">**	my be modified even if the configuration is not successfully</span>
<span class="c">**	retrieved.</span>
<span class="c">**</span>
<span class="c">**  DESIGN:</span>
<span class="c">**</span>
<span class="c">**      The device configuration is fetched from the local shadow</span>
<span class="c">**	copy.  Any unused parameters will be set to -1.  Any</span>
<span class="c">**	parameter which is not desired can specify the NULL</span>
<span class="c">**	pointer.</span>
<span class="c">**</span>
<span class="c">**--</span>
<span class="c">*/</span>
<span class="c">static unsigned int __init SMC37c669_get_device_config (</span>
<span class="c">    unsigned int func,</span>
<span class="c">    int *port,</span>
<span class="c">    int *irq,</span>
<span class="c">    int *drq )</span>
<span class="c">{</span>
<span class="c">    struct DEVICE_CONFIG *cp;</span>
<span class="c">    unsigned int ret_val = FALSE;</span>
<span class="c">/*</span>
<span class="c">** Check for a valid device configuration</span>
<span class="c">*/</span>
<span class="c">    if ( ( cp = SMC37c669_get_config( func ) ) != NULL ) {</span>
<span class="c">    	if ( drq != NULL ) {</span>
<span class="c">	    *drq = cp-&gt;drq;</span>
<span class="c">	    ret_val = TRUE;</span>
<span class="c">	}</span>
<span class="c">	if ( irq != NULL ) {</span>
<span class="c">	    *irq = cp-&gt;irq;</span>
<span class="c">	    ret_val = TRUE;</span>
<span class="c">	}</span>
<span class="c">	if ( port != NULL ) {</span>
<span class="c">	    *port = cp-&gt;port1;</span>
<span class="c">	    ret_val = TRUE;</span>
<span class="c">	}</span>
<span class="c">    }</span>
<span class="c">    return ret_val;</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function displays the current state of the SMC37c699</span>
<span class="cm">**	Super I/O controller&#39;s device functions.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMC37c669_display_device_info</span> <span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">SERIAL_0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Serial 0:    Enabled [ Port 0x%x, IRQ %d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_0</span> <span class="p">].</span><span class="n">port1</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_0</span> <span class="p">].</span><span class="n">irq</span>
	<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Serial 0:    Disabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">SERIAL_1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Serial 1:    Enabled [ Port 0x%x, IRQ %d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_1</span> <span class="p">].</span><span class="n">port1</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_1</span> <span class="p">].</span><span class="n">irq</span>
	<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Serial 1:    Disabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">PARALLEL_0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Parallel:    Enabled [ Port 0x%x, IRQ %d/%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">PARALLEL_0</span> <span class="p">].</span><span class="n">port1</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">PARALLEL_0</span> <span class="p">].</span><span class="n">irq</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">PARALLEL_0</span> <span class="p">].</span><span class="n">drq</span>
	<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Parallel:    Disabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">FLOPPY_0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Floppy Ctrl: Enabled [ Port 0x%x, IRQ %d/%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">FLOPPY_0</span> <span class="p">].</span><span class="n">port1</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">FLOPPY_0</span> <span class="p">].</span><span class="n">irq</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">FLOPPY_0</span> <span class="p">].</span><span class="n">drq</span>
	<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  Floppy Ctrl: Disabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_is_device_enabled</span><span class="p">(</span> <span class="n">IDE_0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  IDE 0:       Enabled [ Port 0x%x, IRQ %d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">IDE_0</span> <span class="p">].</span><span class="n">port1</span><span class="p">,</span>
		 <span class="n">local_config</span><span class="p">[</span> <span class="n">IDE_0</span> <span class="p">].</span><span class="n">irq</span>
	<span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;  IDE 0:       Disabled</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function puts the SMC37c669 Super I/O controller into,</span>
<span class="cm">**	and takes it out of, configuration mode.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      enable:</span>
<span class="cm">**          TRUE to enter configuration mode, FALSE to exit.</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      The SMC37c669 controller may be left in configuration mode.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMC37c669_config_mode</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enable</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">enable</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** To enter configuration mode, two writes in succession to the index</span>
<span class="cm">** port are required.  If a write to another address or port occurs</span>
<span class="cm">** between these two writes, the chip does not enter configuration</span>
<span class="cm">** mode.  Therefore, a spinlock is placed around the two writes to </span>
<span class="cm">** guarantee that they complete uninterrupted.</span>
<span class="cm">*/</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc_lock</span><span class="p">);</span>
    	<span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">index_port</span><span class="p">,</span> <span class="n">SMC37c669_CONFIG_ON_KEY</span> <span class="p">);</span>
    	<span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">index_port</span><span class="p">,</span> <span class="n">SMC37c669_CONFIG_ON_KEY</span> <span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc_lock</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
    	<span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">index_port</span><span class="p">,</span> <span class="n">SMC37c669_CONFIG_OFF_KEY</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function reads an SMC37c669 Super I/O controller</span>
<span class="cm">**	configuration register.  This function assumes that the</span>
<span class="cm">**	device is already in configuration mode.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      index:</span>
<span class="cm">**          Index value of configuration register to read</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Data read from configuration register</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__init</span> <span class="nf">SMC37c669_read_config</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

    <span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">index_port</span><span class="p">,</span> <span class="n">index</span> <span class="p">);</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">rb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">data_port</span> <span class="p">);</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function writes an SMC37c669 Super I/O controller</span>
<span class="cm">**	configuration register.  This function assumes that the</span>
<span class="cm">**	device is already in configuration mode.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      index:</span>
<span class="cm">**          Index of configuration register to write</span>
<span class="cm">**       </span>
<span class="cm">**      data:</span>
<span class="cm">**          Data to be written</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMC37c669_write_config</span><span class="p">(</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">index</span><span class="p">,</span> 
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">index_port</span><span class="p">,</span> <span class="n">index</span> <span class="p">);</span>
    <span class="n">wb</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">SMC37c669</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">,</span> <span class="n">data</span> <span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function initializes the local device</span>
<span class="cm">**	configuration storage.  This function assumes</span>
<span class="cm">**	that the device is already in configuration</span>
<span class="cm">**	mode.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      None</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      Local storage for device configuration information</span>
<span class="cm">**	is initialized.</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMC37c669_init_local_config</span> <span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">SMC37c669_SERIAL_BASE_ADDRESS_REGISTER</span> <span class="n">uart_base</span><span class="p">;</span>
    <span class="n">SMC37c669_SERIAL_IRQ_REGISTER</span> <span class="n">uart_irqs</span><span class="p">;</span>
    <span class="n">SMC37c669_PARALLEL_BASE_ADDRESS_REGISTER</span> <span class="n">ppt_base</span><span class="p">;</span>
    <span class="n">SMC37c669_PARALLEL_FDC_IRQ_REGISTER</span> <span class="n">ppt_fdc_irqs</span><span class="p">;</span>
    <span class="n">SMC37c669_PARALLEL_FDC_DRQ_REGISTER</span> <span class="n">ppt_fdc_drqs</span><span class="p">;</span>
    <span class="n">SMC37c669_FDC_BASE_ADDRESS_REGISTER</span> <span class="n">fdc_base</span><span class="p">;</span>
    <span class="n">SMC37c669_IDE_ADDRESS_REGISTER</span> <span class="n">ide_base</span><span class="p">;</span>
    <span class="n">SMC37c669_IDE_ADDRESS_REGISTER</span> <span class="n">ide_alt</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">** Get serial port 1 base address </span>
<span class="cm">*/</span>
    <span class="n">uart_base</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL0_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get IRQs for serial ports 1 &amp; 2</span>
<span class="cm">*/</span>
    <span class="n">uart_irqs</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL_IRQ_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Store local configuration information for serial port 1</span>
<span class="cm">*/</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">SERIAL_0</span><span class="p">].</span><span class="n">port1</span> <span class="o">=</span> <span class="n">uart_base</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">SERIAL_0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> 
	<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> 
	    <span class="n">SMC37c669_DEVICE_IRQ</span><span class="p">(</span> <span class="n">uart_irqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart1_irq</span> <span class="p">)</span> 
	<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get serial port 2 base address</span>
<span class="cm">*/</span>
    <span class="n">uart_base</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_SERIAL1_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Store local configuration information for serial port 2</span>
<span class="cm">*/</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">SERIAL_1</span><span class="p">].</span><span class="n">port1</span> <span class="o">=</span> <span class="n">uart_base</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">SERIAL_1</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> 
	<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span> 
	    <span class="n">SMC37c669_DEVICE_IRQ</span><span class="p">(</span> <span class="n">uart_irqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">uart2_irq</span> <span class="p">)</span> 
	<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get parallel port base address</span>
<span class="cm">*/</span>
    <span class="n">ppt_base</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get IRQs for parallel port and floppy controller</span>
<span class="cm">*/</span>
    <span class="n">ppt_fdc_irqs</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_IRQ_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get DRQs for parallel port and floppy controller</span>
<span class="cm">*/</span>
    <span class="n">ppt_fdc_drqs</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_PARALLEL_FDC_DRQ_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Store local configuration information for parallel port</span>
<span class="cm">*/</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">PARALLEL_0</span><span class="p">].</span><span class="n">port1</span> <span class="o">=</span> <span class="n">ppt_base</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_2</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">PARALLEL_0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span>
	<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span>
	    <span class="n">SMC37c669_DEVICE_IRQ</span><span class="p">(</span> <span class="n">ppt_fdc_irqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_irq</span> <span class="p">)</span>
	<span class="p">);</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">PARALLEL_0</span><span class="p">].</span><span class="n">drq</span> <span class="o">=</span>
	<span class="n">SMC37c669_xlate_drq</span><span class="p">(</span>
	    <span class="n">SMC37c669_DEVICE_DRQ</span><span class="p">(</span> <span class="n">ppt_fdc_drqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">ppt_drq</span> <span class="p">)</span>
	<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get floppy controller base address</span>
<span class="cm">*/</span>
    <span class="n">fdc_base</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span> 
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_FDC_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Store local configuration information for floppy controller</span>
<span class="cm">*/</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">FLOPPY_0</span><span class="p">].</span><span class="n">port1</span> <span class="o">=</span> <span class="n">fdc_base</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">FLOPPY_0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span>
	<span class="n">SMC37c669_xlate_irq</span><span class="p">(</span>
	    <span class="n">SMC37c669_DEVICE_IRQ</span><span class="p">(</span> <span class="n">ppt_fdc_irqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_irq</span> <span class="p">)</span>
	<span class="p">);</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">FLOPPY_0</span><span class="p">].</span><span class="n">drq</span> <span class="o">=</span>
	<span class="n">SMC37c669_xlate_drq</span><span class="p">(</span>
	    <span class="n">SMC37c669_DEVICE_DRQ</span><span class="p">(</span> <span class="n">ppt_fdc_drqs</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">fdc_drq</span> <span class="p">)</span>
	<span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get IDE controller base address</span>
<span class="cm">*/</span>
    <span class="n">ide_base</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_IDE_BASE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Get IDE alternate status base address</span>
<span class="cm">*/</span>
    <span class="n">ide_alt</span><span class="p">.</span><span class="n">as_uchar</span> <span class="o">=</span>
	<span class="n">SMC37c669_read_config</span><span class="p">(</span> <span class="n">SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX</span> <span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">** Store local configuration information for IDE controller</span>
<span class="cm">*/</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">IDE_0</span><span class="p">].</span><span class="n">port1</span> <span class="o">=</span> <span class="n">ide_base</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">IDE_0</span><span class="p">].</span><span class="n">port2</span> <span class="o">=</span> <span class="n">ide_alt</span><span class="p">.</span><span class="n">by_field</span><span class="p">.</span><span class="n">addr9_4</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">local_config</span><span class="p">[</span><span class="n">IDE_0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function returns a pointer to the local shadow</span>
<span class="cm">**	configuration of the requested device function.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      func:</span>
<span class="cm">**          Which device function</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns a pointer to the DEVICE_CONFIG structure for the</span>
<span class="cm">**	requested function, otherwise, NULL.</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">DEVICE_CONFIG</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">SMC37c669_get_config</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">func</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">DEVICE_CONFIG</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span> <span class="n">func</span> <span class="p">)</span> <span class="p">{</span>
    	<span class="k">case</span> <span class="n">SERIAL_0</span>:
	    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_0</span> <span class="p">];</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SERIAL_1</span>:
	    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_config</span><span class="p">[</span> <span class="n">SERIAL_1</span> <span class="p">];</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PARALLEL_0</span>:
	    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_config</span><span class="p">[</span> <span class="n">PARALLEL_0</span> <span class="p">];</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLOPPY_0</span>:
	    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_config</span><span class="p">[</span> <span class="n">FLOPPY_0</span> <span class="p">];</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IDE_0</span>:
	    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local_config</span><span class="p">[</span> <span class="n">IDE_0</span> <span class="p">];</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">cp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function translates IRQs back and forth between ISA</span>
<span class="cm">**	IRQs and SMC37c669 device IRQs.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      irq:</span>
<span class="cm">**          The IRQ to translate</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns the translated IRQ, otherwise, returns -1.</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_xlate_irq</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">irq</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">translated_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_IS_DEVICE_IRQ</span><span class="p">(</span> <span class="n">irq</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** We are translating a device IRQ to an ISA IRQ</span>
<span class="cm">*/</span>
    	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="n">irq</span> <span class="o">==</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_irq</span> <span class="p">)</span> <span class="p">{</span>
	    	<span class="n">translated_irq</span> <span class="o">=</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** We are translating an ISA IRQ to a device IRQ</span>
<span class="cm">*/</span>
    	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="n">irq</span> <span class="o">==</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_irq</span> <span class="p">)</span> <span class="p">{</span>
	    	<span class="n">translated_irq</span> <span class="o">=</span> <span class="n">SMC37c669_irq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">translated_irq</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">**++</span>
<span class="cm">**  FUNCTIONAL DESCRIPTION:</span>
<span class="cm">**</span>
<span class="cm">**      This function translates DMA channels back and forth between</span>
<span class="cm">**	ISA DMA channels and SMC37c669 device DMA channels.</span>
<span class="cm">**</span>
<span class="cm">**  FORMAL PARAMETERS:</span>
<span class="cm">**</span>
<span class="cm">**      drq:</span>
<span class="cm">**          The DMA channel to translate</span>
<span class="cm">**</span>
<span class="cm">**  RETURN VALUE:</span>
<span class="cm">**</span>
<span class="cm">**      Returns the translated DMA channel, otherwise, returns -1</span>
<span class="cm">**</span>
<span class="cm">**  SIDE EFFECTS:</span>
<span class="cm">**</span>
<span class="cm">**      {@description or none@}</span>
<span class="cm">**</span>
<span class="cm">**--</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">SMC37c669_xlate_drq</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">drq</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">translated_drq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">SMC37c669_IS_DEVICE_DRQ</span><span class="p">(</span> <span class="n">drq</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** We are translating a device DMA channel to an ISA DMA channel</span>
<span class="cm">*/</span>
    	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_drq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_drq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="n">drq</span> <span class="o">==</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_drq</span> <span class="p">)</span> <span class="p">{</span>
	    	<span class="n">translated_drq</span> <span class="o">=</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_drq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
<span class="cm">/*</span>
<span class="cm">** We are translating an ISA DMA channel to a device DMA channel</span>
<span class="cm">*/</span>
    	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_drq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_drq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span> <span class="n">drq</span> <span class="o">==</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isa_drq</span> <span class="p">)</span> <span class="p">{</span>
	    	<span class="n">translated_drq</span> <span class="o">=</span> <span class="n">SMC37c669_drq_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">device_drq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">translated_drq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int __init smcc669_init ( void )</span>
<span class="c">{</span>
<span class="c">    struct INODE *ip;</span>

<span class="c">    allocinode( smc_ddb.name, 1, &amp;ip );</span>
<span class="c">    ip-&gt;dva = &amp;smc_ddb;</span>
<span class="c">    ip-&gt;attr = ATTR$M_WRITE | ATTR$M_READ;</span>
<span class="c">    ip-&gt;len[0] = 0x30;</span>
<span class="c">    ip-&gt;misc = 0;</span>
<span class="c">    INODE_UNLOCK( ip );</span>

<span class="c">    return msg_success;</span>
<span class="c">}</span>
<span class="c"></span>
<span class="c">int __init smcc669_open( struct FILE *fp, char *info, char *next, char *mode )</span>
<span class="c">{</span>
<span class="c">    struct INODE *ip;</span>
<span class="c">/*</span>
<span class="c">** Allow multiple readers but only one writer.  ip-&gt;misc keeps track</span>
<span class="c">** of the number of writers</span>
<span class="c">*/</span>
<span class="c">    ip = fp-&gt;ip;</span>
<span class="c">    INODE_LOCK( ip );</span>
<span class="c">    if ( fp-&gt;mode &amp; ATTR$M_WRITE ) {</span>
<span class="c">	if ( ip-&gt;misc ) {</span>
<span class="c">	    INODE_UNLOCK( ip );</span>
<span class="c">	    return msg_failure;	    /* too many writers */</span>
<span class="c">	}</span>
<span class="c">	ip-&gt;misc++;</span>
<span class="c">    }</span>
<span class="c">/*</span>
<span class="c">** Treat the information field as a byte offset</span>
<span class="c">*/</span>
<span class="c">    *fp-&gt;offset = xtoi( info );</span>
<span class="c">    INODE_UNLOCK( ip );</span>

<span class="c">    return msg_success;</span>
<span class="c">}</span>
<span class="c"></span>
<span class="c">int __init smcc669_close( struct FILE *fp )</span>
<span class="c">{</span>
<span class="c">    struct INODE *ip;</span>

<span class="c">    ip = fp-&gt;ip;</span>
<span class="c">    if ( fp-&gt;mode &amp; ATTR$M_WRITE ) {</span>
<span class="c">	INODE_LOCK( ip );</span>
<span class="c">	ip-&gt;misc--;</span>
<span class="c">	INODE_UNLOCK( ip );</span>
<span class="c">    }</span>
<span class="c">    return msg_success;</span>
<span class="c">}</span>
<span class="c"></span>
<span class="c">int __init smcc669_read( struct FILE *fp, int size, int number, unsigned char *buf )</span>
<span class="c">{</span>
<span class="c">    int i;</span>
<span class="c">    int length;</span>
<span class="c">    int nbytes;</span>
<span class="c">    struct INODE *ip;</span>

<span class="c">/*</span>
<span class="c">** Always access a byte at a time</span>
<span class="c">*/</span>
<span class="c">    ip = fp-&gt;ip;</span>
<span class="c">    length = size * number;</span>
<span class="c">    nbytes = 0;</span>

<span class="c">    SMC37c669_config_mode( TRUE );</span>
<span class="c">    for ( i = 0; i &lt; length; i++ ) {</span>
<span class="c">	if ( !inrange( *fp-&gt;offset, 0, ip-&gt;len[0] ) ) </span>
<span class="c">	    break;</span>
<span class="c">	*buf++ = SMC37c669_read_config( *fp-&gt;offset );</span>
<span class="c">	*fp-&gt;offset += 1;</span>
<span class="c">	nbytes++;</span>
<span class="c">    }</span>
<span class="c">    SMC37c669_config_mode( FALSE );</span>
<span class="c">    return nbytes;</span>
<span class="c">}</span>
<span class="c"></span>
<span class="c">int __init smcc669_write( struct FILE *fp, int size, int number, unsigned char *buf )</span>
<span class="c">{</span>
<span class="c">    int i;</span>
<span class="c">    int length;</span>
<span class="c">    int nbytes;</span>
<span class="c">    struct INODE *ip;</span>
<span class="c">/*</span>
<span class="c">** Always access a byte at a time</span>
<span class="c">*/</span>
<span class="c">    ip = fp-&gt;ip;</span>
<span class="c">    length = size * number;</span>
<span class="c">    nbytes = 0;</span>

<span class="c">    SMC37c669_config_mode( TRUE );</span>
<span class="c">    for ( i = 0; i &lt; length; i++ ) {</span>
<span class="c">	if ( !inrange( *fp-&gt;offset, 0, ip-&gt;len[0] ) ) </span>
<span class="c">	    break;</span>
<span class="c">	SMC37c669_write_config( *fp-&gt;offset, *buf );</span>
<span class="c">	*fp-&gt;offset += 1;</span>
<span class="c">	buf++;</span>
<span class="c">	nbytes++;</span>
<span class="c">    }</span>
<span class="c">    SMC37c669_config_mode( FALSE );</span>
<span class="c">    return nbytes;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">SMC37c669_dump_registers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x29</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;-- CR%02x : %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SMC37c669_read_config</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="p">}</span>
<span class="cm">/*+</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> * = SMC_init - SMC37c669 Super I/O controller initialization                 =</span>
<span class="cm"> * ============================================================================</span>
<span class="cm"> *</span>
<span class="cm"> * OVERVIEW:</span>
<span class="cm"> *</span>
<span class="cm"> *      This routine configures and enables device functions on the</span>
<span class="cm"> *      SMC37c669 Super I/O controller.</span>
<span class="cm"> *</span>
<span class="cm"> * FORM OF CALL:</span>
<span class="cm"> *</span>
<span class="cm"> *      SMC_init( );</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> *</span>
<span class="cm"> *      Nothing</span>
<span class="cm"> *</span>
<span class="cm"> * ARGUMENTS:</span>
<span class="cm"> *</span>
<span class="cm"> *      None</span>
<span class="cm"> *</span>
<span class="cm"> * SIDE EFFECTS:</span>
<span class="cm"> *</span>
<span class="cm"> *      None</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">SMC669_Init</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">index</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">SMC37c669_CONFIG_REGS</span> <span class="o">*</span><span class="n">SMC_base</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="n">SMC_base</span> <span class="o">=</span> <span class="n">SMC37c669_detect</span><span class="p">(</span> <span class="n">index</span> <span class="p">)</span> <span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
<span class="cp">#if SMC_DEBUG</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
	<span class="n">SMC37c669_dump_registers</span><span class="p">(</span> <span class="p">);</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
        <span class="n">SMC37c669_display_device_info</span><span class="p">(</span> <span class="p">);</span>
<span class="cp">#endif</span>
        <span class="n">SMC37c669_disable_device</span><span class="p">(</span> <span class="n">SERIAL_0</span> <span class="p">);</span>
        <span class="n">SMC37c669_configure_device</span><span class="p">(</span>
            <span class="n">SERIAL_0</span><span class="p">,</span>
            <span class="n">COM1_BASE</span><span class="p">,</span>
            <span class="n">COM1_IRQ</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span>
        <span class="p">);</span>
        <span class="n">SMC37c669_enable_device</span><span class="p">(</span> <span class="n">SERIAL_0</span> <span class="p">);</span>

        <span class="n">SMC37c669_disable_device</span><span class="p">(</span> <span class="n">SERIAL_1</span> <span class="p">);</span>
        <span class="n">SMC37c669_configure_device</span><span class="p">(</span>
            <span class="n">SERIAL_1</span><span class="p">,</span>
            <span class="n">COM2_BASE</span><span class="p">,</span>
            <span class="n">COM2_IRQ</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">1</span>
        <span class="p">);</span>
        <span class="n">SMC37c669_enable_device</span><span class="p">(</span> <span class="n">SERIAL_1</span> <span class="p">);</span>

        <span class="n">SMC37c669_disable_device</span><span class="p">(</span> <span class="n">PARALLEL_0</span> <span class="p">);</span>
        <span class="n">SMC37c669_configure_device</span><span class="p">(</span>
            <span class="n">PARALLEL_0</span><span class="p">,</span>
            <span class="n">PARP_BASE</span><span class="p">,</span>
            <span class="n">PARP_IRQ</span><span class="p">,</span>
            <span class="n">PARP_DRQ</span>
        <span class="p">);</span>
        <span class="n">SMC37c669_enable_device</span><span class="p">(</span> <span class="n">PARALLEL_0</span> <span class="p">);</span>

        <span class="n">SMC37c669_disable_device</span><span class="p">(</span> <span class="n">FLOPPY_0</span> <span class="p">);</span>
        <span class="n">SMC37c669_configure_device</span><span class="p">(</span>
            <span class="n">FLOPPY_0</span><span class="p">,</span>
            <span class="n">FDC_BASE</span><span class="p">,</span>
            <span class="n">FDC_IRQ</span><span class="p">,</span>
            <span class="n">FDC_DRQ</span>
        <span class="p">);</span>
        <span class="n">SMC37c669_enable_device</span><span class="p">(</span> <span class="n">FLOPPY_0</span> <span class="p">);</span>
          
	<span class="cm">/* Wake up sometimes forgotten floppy, especially on DP264. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xc</span><span class="p">,</span> <span class="mh">0x3f2</span><span class="p">);</span>

        <span class="n">SMC37c669_disable_device</span><span class="p">(</span> <span class="n">IDE_0</span> <span class="p">);</span>

<span class="cp">#if SMC_DEBUG</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">TRUE</span> <span class="p">);</span>
	<span class="n">SMC37c669_dump_registers</span><span class="p">(</span> <span class="p">);</span>
	<span class="n">SMC37c669_config_mode</span><span class="p">(</span> <span class="n">FALSE</span> <span class="p">);</span>
        <span class="n">SMC37c669_display_device_info</span><span class="p">(</span> <span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span> <span class="s">&quot;SMC37c669 Super I/O Controller found @ 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SMC_base</span> <span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="cp">#if SMC_DEBUG</span>
        <span class="n">printk</span><span class="p">(</span> <span class="s">&quot;No SMC37c669 Super I/O Controller found</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
