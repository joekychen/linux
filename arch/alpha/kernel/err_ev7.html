<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › err_ev7.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>err_ev7.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/arch/alpha/kernel/err_ev7.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2000 Jeff Wiedemeier (Compaq Computer Corporation)</span>
<span class="cm"> *</span>
<span class="cm"> *	Error handling code supporting Alpha systems</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/err_common.h&gt;</span>
<span class="cp">#include &lt;asm/err_ev7.h&gt;</span>

<span class="cp">#include &quot;err_impl.h&quot;</span>
<span class="cp">#include &quot;proto.h&quot;</span>

<span class="k">struct</span> <span class="n">ev7_lf_subpackets</span> <span class="o">*</span>
<span class="nf">ev7_collect_logout_frame_subpackets</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="n">el_ptr</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ev7_lf_subpackets</span> <span class="o">*</span><span class="n">lf_subpackets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="n">subpacket</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A Marvel machine check frame is always packaged in an</span>
<span class="cm">	 * el_subpacket of class HEADER, type LOGOUT_FRAME.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">EL_CLASS__HEADER</span> <span class="o">||</span> 
	    <span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EL_TYPE__HEADER__LOGOUT_FRAME</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It is a logout frame header. Look at the one subpacket.</span>
<span class="cm">	 */</span>
	<span class="n">el_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">el_ptr</span> <span class="o">+</span> <span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * It has to be class PAL, type LOGOUT_FRAME.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">EL_CLASS__PAL</span> <span class="o">||</span>
	    <span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">EL_TYPE__PAL__LOGOUT_FRAME</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">logout</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_logout_subpacket</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process the subpackets.</span>
<span class="cm">	 */</span>
	<span class="n">subpacket</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">el_ptr</span> <span class="o">+</span> <span class="n">el_ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">subpacket</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">logout</span><span class="o">-&gt;</span><span class="n">subpacket_count</span><span class="p">;</span>
	     <span class="n">subpacket</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)</span>
		     <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">subpacket</span> <span class="o">+</span> <span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * All subpackets should be class PAL.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">EL_CLASS__PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s**UNEXPECTED SUBPACKET CLASS %d &quot;</span>
			       <span class="s">&quot;IN LOGOUT FRAME (packet %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Remember the subpacket.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__EV7_PROCESSOR</span>:
			<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">ev7</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_processor_subpacket</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EL_TYPE__PAL__EV7_RBOX</span>:
			<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">rbox</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_rbox_subpacket</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EL_TYPE__PAL__EV7_ZBOX</span>:
			<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">zbox</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_zbox_subpacket</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EL_TYPE__PAL__EV7_IO</span>:
			<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_io_subpacket</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__AIRMOVER_FAN</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__VOLTAGE</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__INTRUSION</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__POWER_SUPPLY</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__LAN</span>:
		<span class="k">case</span> <span class="n">EL_TYPE__PAL__ENV__HOT_PLUG</span>:
			<span class="n">lf_subpackets</span><span class="o">-&gt;</span><span class="n">env</span><span class="p">[</span><span class="n">ev7_lf_env_index</span><span class="p">(</span><span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)]</span> <span class="o">=</span>
 				<span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_environmental_subpacket</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">subpacket</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
				
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t know what kind of frame this is.</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">lf_subpackets</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ev7_machine_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="n">el_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)</span><span class="n">la_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">saved_err_prefix</span> <span class="o">=</span> <span class="n">err_print_prefix</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sync the processor</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">draina</span><span class="p">();</span>

	<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">KERN_CRIT</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s*CPU %s Error (Vector 0x%x) reported on CPU %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span> 
	       <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">SCB_Q_PROCERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Correctable&quot;</span> <span class="o">:</span> <span class="s">&quot;Uncorrectable&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vector</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">el_process_subpacket</span><span class="p">(</span><span class="n">el_ptr</span><span class="p">);</span>
	<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">saved_err_prefix</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Release the logout frame </span>
<span class="cm">	 */</span>
	<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_ev7_processor_subpacket_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span>	<span class="s">&quot;I_STAT&quot;</span><span class="p">,</span>	<span class="s">&quot;DC_STAT&quot;</span><span class="p">,</span>
	<span class="s">&quot;C_ADDR&quot;</span><span class="p">,</span>		<span class="s">&quot;C_SYNDROME_1&quot;</span><span class="p">,</span>	<span class="s">&quot;C_SYNDROME_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;C_STAT&quot;</span><span class="p">,</span>		<span class="s">&quot;C_STS&quot;</span><span class="p">,</span>	<span class="s">&quot;MM_STAT&quot;</span><span class="p">,</span>
	<span class="s">&quot;EXC_ADDR&quot;</span><span class="p">,</span>		<span class="s">&quot;IER_CM&quot;</span><span class="p">,</span>	<span class="s">&quot;ISUM&quot;</span><span class="p">,</span>
	<span class="s">&quot;PAL_BASE&quot;</span><span class="p">,</span>		<span class="s">&quot;I_CTL&quot;</span><span class="p">,</span>	<span class="s">&quot;PROCESS_CONTEXT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CBOX_CTL&quot;</span><span class="p">,</span>		<span class="s">&quot;CBOX_STP_CTL&quot;</span><span class="p">,</span>	<span class="s">&quot;CBOX_ACC_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;CBOX_LCL_SET&quot;</span><span class="p">,</span>		<span class="s">&quot;CBOX_GLB_SET&quot;</span><span class="p">,</span>	<span class="s">&quot;BBOX_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;BBOX_ERR_STS&quot;</span><span class="p">,</span>		<span class="s">&quot;BBOX_ERR_IDX&quot;</span><span class="p">,</span>	<span class="s">&quot;CBOX_DDP_ERR_STS&quot;</span><span class="p">,</span>
	<span class="s">&quot;BBOX_DAT_RMP&quot;</span><span class="p">,</span>		<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_ev7_zbox_subpacket_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span> 	
	<span class="s">&quot;ZBOX(0): DRAM_ERR_STATUS_2 / DRAM_ERR_STATUS_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0): DRAM_ERROR_CTL    / DRAM_ERR_STATUS_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0): DIFT_TIMEOUT      / DRAM_ERR_ADR&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0): FRC_ERR_ADR       / DRAM_MAPPER_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0): reserved          / DIFT_ERR_STATUS&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(1): DRAM_ERR_STATUS_2 / DRAM_ERR_STATUS_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(1): DRAM_ERROR_CTL    / DRAM_ERR_STATUS_3&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(1): DIFT_TIMEOUT      / DRAM_ERR_ADR&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(1): FRC_ERR_ADR       / DRAM_MAPPER_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(1): reserved          / DIFT_ERR_STATUS&quot;</span><span class="p">,</span>
	<span class="s">&quot;CBOX_CTL&quot;</span><span class="p">,</span>		<span class="s">&quot;CBOX_STP_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0)_ERROR_PA&quot;</span><span class="p">,</span>	<span class="s">&quot;ZBOX(1)_ERROR_PA&quot;</span><span class="p">,</span>
	<span class="s">&quot;ZBOX(0)_ORED_SYNDROME&quot;</span><span class="p">,</span><span class="s">&quot;ZBOX(1)_ORED_SYNDROME&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_ev7_rbox_subpacket_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_CFG&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_N_CFG&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBOX_S_CFG&quot;</span><span class="p">,</span>		<span class="s">&quot;RBOX_E_CFG&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_W_CFG&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBOX_N_ERR&quot;</span><span class="p">,</span>		<span class="s">&quot;RBOX_S_ERR&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_E_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBOX_W_ERR&quot;</span><span class="p">,</span>		<span class="s">&quot;RBOX_IO_CFG&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_IO_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBOX_L_ERR&quot;</span><span class="p">,</span>		<span class="s">&quot;RBOX_WHOAMI&quot;</span><span class="p">,</span>	<span class="s">&quot;RBOX_IMASL&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBOX_INTQ&quot;</span><span class="p">,</span>		<span class="s">&quot;RBOX_INT&quot;</span><span class="p">,</span>	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_ev7_io_subpacket_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span>	<span class="s">&quot;IO_ASIC_REV&quot;</span><span class="p">,</span>	<span class="s">&quot;IO_SYS_REV&quot;</span><span class="p">,</span>
	<span class="s">&quot;IO7_UPH&quot;</span><span class="p">,</span>		<span class="s">&quot;HPI_CTL&quot;</span><span class="p">,</span>	<span class="s">&quot;CRD_CTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;HEI_CTL&quot;</span><span class="p">,</span>		<span class="s">&quot;PO7_ERROR_SUM&quot;</span><span class="p">,</span><span class="s">&quot;PO7_UNCRR_SYM&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO7_CRRCT_SYM&quot;</span><span class="p">,</span>	<span class="s">&quot;PO7_UGBGE_SYM&quot;</span><span class="p">,</span><span class="s">&quot;PO7_ERR_PKT0&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO7_ERR_PKT1&quot;</span><span class="p">,</span>		<span class="s">&quot;reserved&quot;</span><span class="p">,</span>	<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO0_ERR_SUM&quot;</span><span class="p">,</span>		<span class="s">&quot;PO0_TLB_ERR&quot;</span><span class="p">,</span>	<span class="s">&quot;PO0_SPL_COMPLT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO0_TRANS_SUM&quot;</span><span class="p">,</span>	<span class="s">&quot;PO0_FIRST_ERR&quot;</span><span class="p">,</span><span class="s">&quot;PO0_MULT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO1_ERR_SUM&quot;</span><span class="p">,</span>		<span class="s">&quot;PO1_TLB_ERR&quot;</span><span class="p">,</span>	<span class="s">&quot;PO1_SPL_COMPLT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO1_TRANS_SUM&quot;</span><span class="p">,</span>	<span class="s">&quot;PO1_FIRST_ERR&quot;</span><span class="p">,</span><span class="s">&quot;PO1_MULT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO2_ERR_SUM&quot;</span><span class="p">,</span>		<span class="s">&quot;PO2_TLB_ERR&quot;</span><span class="p">,</span>	<span class="s">&quot;PO2_SPL_COMPLT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO2_TRANS_SUM&quot;</span><span class="p">,</span>	<span class="s">&quot;PO2_FIRST_ERR&quot;</span><span class="p">,</span><span class="s">&quot;PO2_MULT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO3_ERR_SUM&quot;</span><span class="p">,</span>		<span class="s">&quot;PO3_TLB_ERR&quot;</span><span class="p">,</span>	<span class="s">&quot;PO3_SPL_COMPLT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PO3_TRANS_SUM&quot;</span><span class="p">,</span>	<span class="s">&quot;PO3_FIRST_ERR&quot;</span><span class="p">,</span><span class="s">&quot;PO3_MULT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>
	<span class="s">&quot;DM CSR PH&quot;</span><span class="p">,</span>		<span class="s">&quot;reserved&quot;</span><span class="p">,</span>	
	<span class="nb">NULL</span>
<span class="p">};</span>
	
<span class="k">static</span> <span class="k">struct</span> <span class="n">el_subpacket_annotation</span> <span class="n">el_ev7_pal_annotations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__PAL</span><span class="p">,</span>
			     <span class="n">EL_TYPE__PAL__EV7_PROCESSOR</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;EV7 Processor Subpacket&quot;</span><span class="p">,</span>
			     <span class="n">el_ev7_processor_subpacket_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__PAL</span><span class="p">,</span>
			     <span class="n">EL_TYPE__PAL__EV7_ZBOX</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;EV7 ZBOX Subpacket&quot;</span><span class="p">,</span>
			     <span class="n">el_ev7_zbox_subpacket_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__PAL</span><span class="p">,</span>
			     <span class="n">EL_TYPE__PAL__EV7_RBOX</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;EV7 RBOX Subpacket&quot;</span><span class="p">,</span>
			     <span class="n">el_ev7_rbox_subpacket_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__PAL</span><span class="p">,</span>
			     <span class="n">EL_TYPE__PAL__EV7_IO</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;EV7 IO Subpacket&quot;</span><span class="p">,</span>
			     <span class="n">el_ev7_io_subpacket_annotation</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span>
<span class="nf">ev7_process_pal_subpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ev7_pal_subpacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">EL_CLASS__PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  ** Unexpected header CLASS %d TYPE %d, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="n">header</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ev7_pal_subpacket</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">data_start</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EL_TYPE__PAL__LOGOUT_FRAME</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s*** MCHK occurred on LPID %lld (RBOX %llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">whami</span><span class="p">,</span> 
		       <span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">rbox_whami</span><span class="p">);</span>
		<span class="n">el_print_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  EXC_ADDR: %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		         <span class="s">&quot;  HALT_CODE: %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">exc_addr</span><span class="p">,</span>
		       <span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">halt_code</span><span class="p">);</span>
		<span class="n">el_process_subpackets</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>
                                      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">logout</span><span class="p">.</span><span class="n">subpacket_count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  ** PAL TYPE %d SUBPACKET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">el_annotate_subpacket</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">header</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">el_subpacket_handler</span> <span class="n">ev7_pal_subpacket_handler</span> <span class="o">=</span>
	<span class="n">SUBPACKET_HANDLER_INIT</span><span class="p">(</span><span class="n">EL_CLASS__PAL</span><span class="p">,</span> <span class="n">ev7_process_pal_subpacket</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">ev7_register_error_handlers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">el_ev7_pal_annotations</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cdl_register_subpacket_annotation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el_ev7_pal_annotations</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">cdl_register_subpacket_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev7_pal_subpacket_handler</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
