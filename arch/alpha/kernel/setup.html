<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › setup.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>setup.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/alpha/kernel/setup.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/* 2.3.x bootmem, 1999 Andrea Arcangeli &lt;andrea@suse.de&gt; */</span>

<span class="cm">/*</span>
<span class="cm"> * Bootup setup stuff.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/root_dev.h&gt;</span>
<span class="cp">#include &lt;linux/initrd.h&gt;</span>
<span class="cp">#include &lt;linux/eisa.h&gt;</span>
<span class="cp">#include &lt;linux/pfn.h&gt;</span>
<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/reboot.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">atomic_notifier_head</span> <span class="n">panic_notifier_list</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">alpha_panic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">alpha_panic_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">alpha_panic_event</span><span class="p">,</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">INT_MAX</span> <span class="cm">/* try to do it first */</span>
<span class="p">};</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/mmu_context.h&gt;</span>
<span class="cp">#include &lt;asm/console.h&gt;</span>

<span class="cp">#include &quot;proto.h&quot;</span>
<span class="cp">#include &quot;pci_impl.h&quot;</span>


<span class="k">struct</span> <span class="n">hwrpb_struct</span> <span class="o">*</span><span class="n">hwrpb</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hwrpb</span><span class="p">);</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">srm_hae</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">alpha_l1i_cacheshape</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alpha_l1d_cacheshape</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alpha_l2_cacheshape</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alpha_l3_cacheshape</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
<span class="cm">/* 0=minimum, 1=verbose, 2=all */</span>
<span class="cm">/* These can be overridden via the command line, ie &quot;verbose_mcheck=2&quot;) */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alpha_verbose_mcheck</span> <span class="o">=</span> <span class="n">CONFIG_VERBOSE_MCHECK_ON</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_NUMA</span>
<span class="k">struct</span> <span class="n">cpumask</span> <span class="n">node_to_cpumask_map</span><span class="p">[</span><span class="n">MAX_NUMNODES</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">node_to_cpumask_map</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Which processor we booted from.  */</span>
<span class="kt">int</span> <span class="n">boot_cpuid</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Using SRM callbacks for initial console output. This works from</span>
<span class="cm"> * setup_arch() time through the end of time_init(), as those places</span>
<span class="cm"> * are under our (Alpha) control.</span>

<span class="cm"> * &quot;srmcons&quot; specified in the boot command arguments allows us to</span>
<span class="cm"> * see kernel messages during the period of time before the true</span>
<span class="cm"> * console device is &quot;registered&quot; during console_init(). </span>
<span class="cm"> * As of this version (2.5.59), console_init() will call</span>
<span class="cm"> * disable_early_printk() as the last action before initializing</span>
<span class="cm"> * the console drivers. That&#39;s the last possible time srmcons can be </span>
<span class="cm"> * unregistered without interfering with console behavior.</span>
<span class="cm"> *</span>
<span class="cm"> * By default, OFF; set it with a bootcommand arg of &quot;srmcons&quot; or </span>
<span class="cm"> * &quot;console=srm&quot;. The meaning of these two args is:</span>
<span class="cm"> *     &quot;srmcons&quot;     - early callback prints </span>
<span class="cm"> *     &quot;console=srm&quot; - full callback based console, including early prints</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">srmcons_output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Enforce a memory size limit; useful for testing. By default, none. */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_size_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Set AGP GART window size (0 means disabled). */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">alpha_agpgart_size</span> <span class="o">=</span> <span class="n">DEFAULT_AGP_APER_SIZE</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ALPHA_GENERIC</span>
<span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="n">alpha_mv</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">alpha_using_srm</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">alpha_using_srm</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">get_sysvec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">get_sysvec_byname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">get_sysnames</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">**</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">determine_cpu_caches</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">__initdata</span> <span class="n">command_line</span><span class="p">[</span><span class="n">COMMAND_LINE_SIZE</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * The format of &quot;screen_info&quot; is strange, and due to early</span>
<span class="cm"> * i386-setup code. This is just enough to make the console</span>
<span class="cm"> * code think we&#39;re on a VGA color display.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">screen_info</span> <span class="n">screen_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">orig_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_y</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_video_cols</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_video_lines</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_video_isVGA</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_video_points</span> <span class="o">=</span> <span class="mi">16</span>
<span class="p">};</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">screen_info</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The direct map I/O window, if any.  This should be the same</span>
<span class="cm"> * for all busses, since it&#39;s used by virt_to_bus.</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__direct_map_base</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__direct_map_size</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__direct_map_base</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__direct_map_size</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Declare all of the machine vectors.</span>
<span class="cm"> */</span>

<span class="cm">/* GCC 2.7.2 (on alpha at least) is lame.  It does not support either </span>
<span class="cm">   __attribute__((weak)) or #pragma weak.  Bypass it and talk directly</span>
<span class="cm">   to the assembler.  */</span>

<span class="cp">#define WEAK(X) \</span>
<span class="cp">	extern struct alpha_machine_vector X; \</span>
<span class="cp">	asm(&quot;.weak &quot;#X)</span>

<span class="n">WEAK</span><span class="p">(</span><span class="n">alcor_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">alphabook1_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">avanti_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">cabriolet_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">clipper_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">dp264_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">eb164_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">eb64p_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">eb66_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">eb66p_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">eiger_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">jensen_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">lx164_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">lynx_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">marvel_ev7_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">miata_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">mikasa_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">mikasa_primo_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">monet_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">nautilus_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">noname_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">noritake_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">noritake_primo_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">p2k_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">pc164_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">privateer_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">rawhide_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">ruffian_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">rx164_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">sable_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">sable_gamma_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">shark_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">sx164_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">takara_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">titan_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">webbrick_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">wildfire_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">xl_mv</span><span class="p">);</span>
<span class="n">WEAK</span><span class="p">(</span><span class="n">xlt_mv</span><span class="p">);</span>

<span class="cp">#undef WEAK</span>

<span class="cm">/*</span>
<span class="cm"> * I/O resources inherited from PeeCees.  Except for perhaps the</span>
<span class="cm"> * turbochannel alphas, everyone has these on some sort of SuperIO chip.</span>
<span class="cm"> *</span>
<span class="cm"> * ??? If this becomes less standard, move the struct out into the</span>
<span class="cm"> * machine vector.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">reserve_std_resources</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">resource</span> <span class="n">standard_io_resources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rtc&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1f</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pic1&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x3f</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;timer&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x5f</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;keyboard&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x6f</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma page reg&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x8f</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pic2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xbf</span> <span class="p">},</span>
        	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dma2&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0xdf</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">io</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hose_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose_head</span><span class="p">;</span> <span class="n">hose</span><span class="p">;</span> <span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">io</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fix up for the Jensen&#39;s queer RTC placement.  */</span>
	<span class="n">standard_io_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">standard_io_resources</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">RTC_PORT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">standard_io_resources</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">request_resource</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">standard_io_resources</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PFN_MAX		PFN_DOWN(0x80000000)</span>
<span class="cp">#define for_each_mem_cluster(memdesc, _cluster, i)		\</span>
<span class="cp">	for ((_cluster) = (memdesc)-&gt;cluster, (i) = 0;		\</span>
<span class="cp">	     (i) &lt; (memdesc)-&gt;numclusters; (i)++, (_cluster)++)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span>
<span class="nf">get_mem_size_limit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;K&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;k&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
                <span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;m&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
                <span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;G&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">from</span> <span class="o">==</span> <span class="sc">&#39;g&#39;</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">end</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>
                <span class="n">from</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span> <span class="cm">/* Return the PFN of the limit. */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
<span class="kt">void</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">move_initrd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">initrd_end</span> <span class="o">-</span> <span class="n">initrd_start</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">__alloc_bootmem</span><span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">start</span> <span class="o">||</span> <span class="n">__pa</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">mem_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">initrd_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">initrd_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span><span class="p">;</span>
	<span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;initrd moved to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef CONFIG_DISCONTIGMEM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">setup_memory</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">kernel_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memclust_struct</span> <span class="o">*</span> <span class="n">cluster</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">memdesc_struct</span> <span class="o">*</span> <span class="n">memdesc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_kernel_pfn</span><span class="p">,</span> <span class="n">end_kernel_pfn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bootmap_size</span><span class="p">,</span> <span class="n">bootmap_pages</span><span class="p">,</span> <span class="n">bootmap_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Find free clusters, and init and free the bootmem accordingly.  */</span>
	<span class="n">memdesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">memdesc_struct</span> <span class="o">*</span><span class="p">)</span>
	  <span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">mddt_offset</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwrpb</span><span class="p">);</span>

	<span class="n">for_each_mem_cluster</span><span class="p">(</span><span class="n">memdesc</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;memcluster %lu, usage %01lx, start %8lu, end %8lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">,</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">,</span>
		       <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">numpages</span><span class="p">);</span>

		<span class="cm">/* Bit 0 is console/PALcode reserved.  Bit 1 is</span>
<span class="cm">		   non-volatile memory -- we might want to mark</span>
<span class="cm">		   this for later.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">end</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">numpages</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max_low_pfn</span><span class="p">)</span>
			<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Except for the NUMA systems (wildfire, marvel) all of the </span>
<span class="cm">	 * Alpha systems we run on support 32GB of memory or less.</span>
<span class="cm">	 * Since the NUMA systems introduce large holes in memory addressing,</span>
<span class="cm">	 * we can get into a situation where there is not enough contiguous</span>
<span class="cm">	 * memory for the memory map. </span>
<span class="cm">	 *</span>
<span class="cm">	 * Limit memory to the first 32GB to limit the NUMA systems to </span>
<span class="cm">	 * memory on their first node (wildfire) or 2 (marvel) to avoid </span>
<span class="cm">	 * not being able to produce the memory map. In order to access </span>
<span class="cm">	 * all of the memory on the NUMA systems, build with discontiguous</span>
<span class="cm">	 * memory support.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the user specified a memory limit, let that memory limit stand.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_size_limit</span><span class="p">)</span> 
		<span class="n">mem_size_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32ul</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_size_limit</span> <span class="o">&amp;&amp;</span> <span class="n">max_low_pfn</span> <span class="o">&gt;=</span> <span class="n">mem_size_limit</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;setup: forcing memory size to %ldK (from %ldK).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mem_size_limit</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">10</span><span class="p">),</span>
		       <span class="n">max_low_pfn</span>    <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">10</span><span class="p">));</span>
		<span class="n">max_low_pfn</span> <span class="o">=</span> <span class="n">mem_size_limit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the bounds of kernel memory.  */</span>
	<span class="n">start_kernel_pfn</span> <span class="o">=</span> <span class="n">PFN_DOWN</span><span class="p">(</span><span class="n">KERNEL_START_PHYS</span><span class="p">);</span>
	<span class="n">end_kernel_pfn</span> <span class="o">=</span> <span class="n">PFN_UP</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">kernel_end</span><span class="p">));</span>
	<span class="n">bootmap_start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

 <span class="nl">try_again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_low_pfn</span> <span class="o">&lt;=</span> <span class="n">end_kernel_pfn</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;not enough memory to boot&quot;</span><span class="p">);</span>

	<span class="cm">/* We need to know how many physically contiguous pages</span>
<span class="cm">	   we&#39;ll need for the bootmap.  */</span>
	<span class="n">bootmap_pages</span> <span class="o">=</span> <span class="n">bootmem_bootmap_pages</span><span class="p">(</span><span class="n">max_low_pfn</span><span class="p">);</span>

	<span class="cm">/* Now find a good region where to allocate the bootmap.  */</span>
	<span class="n">for_each_mem_cluster</span><span class="p">(</span><span class="n">memdesc</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">numpages</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">max_low_pfn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max_low_pfn</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">max_low_pfn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">start_kernel_pfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">end_kernel_pfn</span>
			    <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">-</span> <span class="n">end_kernel_pfn</span> <span class="o">&gt;=</span> <span class="n">bootmap_pages</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bootmap_start</span> <span class="o">=</span> <span class="n">end_kernel_pfn</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start_kernel_pfn</span><span class="p">)</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">start_kernel_pfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end_kernel_pfn</span><span class="p">)</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">end_kernel_pfn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">bootmap_pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bootmap_start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bootmap_start</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_low_pfn</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the bootmap and mark the whole MM as reserved.  */</span>
	<span class="n">bootmap_size</span> <span class="o">=</span> <span class="n">init_bootmem</span><span class="p">(</span><span class="n">bootmap_start</span><span class="p">,</span> <span class="n">max_low_pfn</span><span class="p">);</span>

	<span class="cm">/* Mark the free regions.  */</span>
	<span class="n">for_each_mem_cluster</span><span class="p">(</span><span class="n">memdesc</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">numpages</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">max_low_pfn</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max_low_pfn</span><span class="p">)</span>
			<span class="n">end</span> <span class="o">=</span> <span class="n">max_low_pfn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">start_kernel_pfn</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">end_kernel_pfn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_bootmem</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
					     <span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start_kernel_pfn</span><span class="p">)</span>
					      <span class="o">-</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start</span><span class="p">)));</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;freeing pages %ld:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">start</span><span class="p">,</span> <span class="n">start_kernel_pfn</span><span class="p">);</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">end_kernel_pfn</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">start_kernel_pfn</span><span class="p">)</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">start_kernel_pfn</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end_kernel_pfn</span><span class="p">)</span>
			<span class="n">start</span> <span class="o">=</span> <span class="n">end_kernel_pfn</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">free_bootmem</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;freeing pages %ld:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reserve the bootmap memory.  */</span>
	<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">bootmap_start</span><span class="p">),</span> <span class="n">bootmap_size</span><span class="p">,</span>
			<span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;reserving pages %ld:%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bootmap_start</span><span class="p">,</span> <span class="n">bootmap_start</span><span class="o">+</span><span class="n">PFN_UP</span><span class="p">(</span><span class="n">bootmap_size</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_BLK_DEV_INITRD</span>
	<span class="n">initrd_start</span> <span class="o">=</span> <span class="n">INITRD_START</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initrd_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">initrd_end</span> <span class="o">=</span> <span class="n">initrd_start</span><span class="o">+</span><span class="n">INITRD_SIZE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Initial ramdisk at: 0x%p (%lu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">initrd_start</span><span class="p">,</span> <span class="n">INITRD_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">initrd_end</span> <span class="o">&gt;</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">max_low_pfn</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">move_initrd</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">max_low_pfn</span><span class="p">)))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;initrd extends beyond end of memory &quot;</span>
				       <span class="s">&quot;(0x%08lx &gt; 0x%p)</span><span class="se">\n</span><span class="s">disabling initrd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">initrd_end</span><span class="p">,</span>
				       <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">PFN_PHYS</span><span class="p">(</span><span class="n">max_low_pfn</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reserve_bootmem</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">initrd_start</span><span class="p">),</span>
					<span class="n">INITRD_SIZE</span><span class="p">,</span> <span class="n">BOOTMEM_DEFAULT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_BLK_DEV_INITRD */</span><span class="cp"></span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">setup_memory</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_DISCONTIGMEM */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__init</span>
<span class="nf">page_is_ram</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">memclust_struct</span> <span class="o">*</span> <span class="n">cluster</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">memdesc_struct</span> <span class="o">*</span> <span class="n">memdesc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memdesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">memdesc_struct</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">mddt_offset</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hwrpb</span><span class="p">);</span>
	<span class="n">for_each_mem_cluster</span><span class="p">(</span><span class="n">memdesc</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfn</span> <span class="o">&gt;=</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span>  <span class="o">&amp;&amp;</span>
		    <span class="n">pfn</span> <span class="o">&lt;</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">start_pfn</span> <span class="o">+</span> <span class="n">cluster</span><span class="o">-&gt;</span><span class="n">numpages</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">cluster</span><span class="o">-&gt;</span><span class="n">usage</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">register_cpus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_possible_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpu</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">register_cpu</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">arch_initcall</span><span class="p">(</span><span class="n">register_cpus</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">setup_arch</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">_end</span><span class="p">[];</span>

	<span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">vec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type_name</span><span class="p">,</span> <span class="o">*</span><span class="n">var_name</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kernel_end</span> <span class="o">=</span> <span class="n">_end</span><span class="p">;</span> <span class="cm">/* end of kernel */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">command_line</span><span class="p">;</span>

	<span class="n">hwrpb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hwrpb_struct</span><span class="o">*</span><span class="p">)</span> <span class="n">__va</span><span class="p">(</span><span class="n">INIT_HWRPB</span><span class="o">-&gt;</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">boot_cpuid</span> <span class="o">=</span> <span class="n">hard_smp_processor_id</span><span class="p">();</span>

        <span class="cm">/*</span>
<span class="cm">	 * Pre-process the system type to make sure it will be valid.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This may restore real CABRIO and EB66+ family names, ie</span>
<span class="cm">	 * EB64+ and EB66.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Oh, and &quot;white box&quot; AS800 (aka DIGITAL Server 3000 series)</span>
<span class="cm">	 * and AS1200 (DIGITAL Server 5000 series) have the type as</span>
<span class="cm">	 * the negative of the real one.</span>
<span class="cm">	 */</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span><span class="p">);</span>
		<span class="n">hwrpb_update_checksum</span><span class="p">(</span><span class="n">hwrpb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register a call for panic conditions. */</span>
	<span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">panic_notifier_list</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">alpha_panic_block</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ALPHA_GENERIC</span>
	<span class="cm">/* Assume that we&#39;ve booted from SRM if we haven&#39;t booted from MILO.</span>
<span class="cm">	   Detect the later by looking for &quot;MILO&quot; in the system serial nr.  */</span>
	<span class="n">alpha_using_srm</span> <span class="o">=</span> <span class="n">strncmp</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">,</span> <span class="s">&quot;MILO&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* If we are using SRM, we want to allow callbacks</span>
<span class="cm">	   as early as possible, so do this NOW, and then</span>
<span class="cm">	   they should work immediately thereafter.</span>
<span class="cm">	*/</span>
	<span class="n">kernel_end</span> <span class="o">=</span> <span class="n">callback_init</span><span class="p">(</span><span class="n">kernel_end</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Locate the command line.</span>
<span class="cm">	 */</span>
	<span class="cm">/* Hack for Jensen... since we&#39;re restricted to 8 or 16 chars for</span>
<span class="cm">	   boot flags depending on the boot mode, we need some shorthand.</span>
<span class="cm">	   This should do for installation.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">COMMAND_LINE</span><span class="p">,</span> <span class="s">&quot;INSTALL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="s">&quot;root=/dev/fd0 load_ramdisk=1&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">command_line</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">COMMAND_LINE</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">command_line</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">boot_command_line</span><span class="p">,</span> <span class="n">command_line</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cmdline_p</span> <span class="o">=</span> <span class="n">command_line</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Process command-line arguments.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">p</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;alpha_mv=&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vec</span> <span class="o">=</span> <span class="n">get_sysvec_byname</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">9</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;cycle=&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">est_cycle_freq</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;mem=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_size_limit</span> <span class="o">=</span> <span class="n">get_mem_size_limit</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;srmcons&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srmcons_output</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;console=srm&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srmcons_output</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;gartsize=&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alpha_agpgart_size</span> <span class="o">=</span>
				<span class="n">get_mem_size_limit</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">9</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;verbose_mcheck=&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alpha_verbose_mcheck</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Replace the command line, now that we&#39;ve killed it with strsep.  */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="n">boot_command_line</span><span class="p">);</span>

	<span class="cm">/* If we want SRM console printk echoing early, do it now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span> <span class="o">&amp;&amp;</span> <span class="n">srmcons_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">register_srm_console</span><span class="p">();</span>

		<span class="cm">/*</span>
<span class="cm">		 * If &quot;console=srm&quot; was specified, clear the srmcons_output</span>
<span class="cm">		 * flag now so that time.c won&#39;t unregister_srm_console</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srmcons_output</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">srmcons_output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
	<span class="cm">/* If we&#39;re using SRM, make sysrq-b halt back to the prom,</span>
<span class="cm">	   not auto-reboot.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">__sysrq_get_key_op</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">);</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">machine_halt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify and reconfigure for the current system.</span>
<span class="cm">	 */</span>
	<span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">percpu_struct</span><span class="o">*</span><span class="p">)((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span> <span class="o">+</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">processor_offset</span><span class="p">);</span>

	<span class="n">get_sysnames</span><span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_variation</span><span class="p">,</span>
		     <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">var_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">var_name</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="n">var_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">get_sysvec</span><span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_variation</span><span class="p">,</span>
				 <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Unsupported system type: %s%s%s (%ld %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">type_name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">var_name</span> <span class="o">?</span> <span class="s">&quot; variation &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">var_name</span><span class="p">,</span>
		      <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_variation</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">alpha_mv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alpha_mv</span> <span class="o">=</span> <span class="o">*</span><span class="n">vec</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Booting &quot;</span>
<span class="cp">#ifdef CONFIG_ALPHA_GENERIC</span>
	       <span class="s">&quot;GENERIC &quot;</span>
<span class="cp">#endif</span>
	       <span class="s">&quot;on %s%s%s using machine vector %s from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">type_name</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">var_name</span> <span class="o">?</span> <span class="s">&quot; variation &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
	       <span class="n">var_name</span><span class="p">,</span> <span class="n">alpha_mv</span><span class="p">.</span><span class="n">vector_name</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">alpha_using_srm</span> <span class="o">?</span> <span class="s">&quot;SRM&quot;</span> <span class="o">:</span> <span class="s">&quot;MILO&quot;</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Major Options: &quot;</span>
<span class="cp">#ifdef CONFIG_SMP</span>
	       <span class="s">&quot;SMP &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ALPHA_EV56</span>
	       <span class="s">&quot;EV56 &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ALPHA_EV67</span>
	       <span class="s">&quot;EV67 &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ALPHA_LEGACY_START_ADDRESS</span>
	       <span class="s">&quot;LEGACY_START &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	       <span class="s">&quot;VERBOSE_MCHECK &quot;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_DISCONTIGMEM</span>
	       <span class="s">&quot;DISCONTIGMEM &quot;</span>
<span class="cp">#ifdef CONFIG_NUMA</span>
	       <span class="s">&quot;NUMA &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_DEBUG_SPINLOCK</span>
	       <span class="s">&quot;DEBUG_SPINLOCK &quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
	       <span class="s">&quot;MAGIC_SYSRQ &quot;</span>
<span class="cp">#endif</span>
	       <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Command line: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command_line</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Sync up the HAE.</span>
<span class="cm">	 * Save the SRM&#39;s current value for restoration.</span>
<span class="cm">	 */</span>
	<span class="n">srm_hae</span> <span class="o">=</span> <span class="o">*</span><span class="n">alpha_mv</span><span class="p">.</span><span class="n">hae_register</span><span class="p">;</span>
	<span class="n">__set_hae</span><span class="p">(</span><span class="n">alpha_mv</span><span class="p">.</span><span class="n">hae_cache</span><span class="p">);</span>

	<span class="cm">/* Reset enable correctable error reports.  */</span>
	<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>

	<span class="cm">/* Find our memory.  */</span>
	<span class="n">setup_memory</span><span class="p">(</span><span class="n">kernel_end</span><span class="p">);</span>

	<span class="cm">/* First guess at cpu cache sizes.  Do this before init_arch.  */</span>
	<span class="n">determine_cpu_caches</span><span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="cm">/* Initialize the machine.  Usually has to do with setting up</span>
<span class="cm">	   DMA windows and the like.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_mv</span><span class="p">.</span><span class="n">init_arch</span><span class="p">)</span>
		<span class="n">alpha_mv</span><span class="p">.</span><span class="n">init_arch</span><span class="p">();</span>

	<span class="cm">/* Reserve standard resources.  */</span>
	<span class="n">reserve_std_resources</span><span class="p">();</span>

	<span class="cm">/* </span>
<span class="cm">	 * Give us a default console.  TGA users will see nothing until</span>
<span class="cm">	 * chr_dev_init is called, rather late in the boot sequence.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_VT</span>
<span class="cp">#if defined(CONFIG_VGA_CONSOLE)</span>
	<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vga_con</span><span class="p">;</span>
<span class="cp">#elif defined(CONFIG_DUMMY_CONSOLE)</span>
	<span class="n">conswitchp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_con</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

	<span class="cm">/* Default root filesystem to sda2.  */</span>
	<span class="n">ROOT_DEV</span> <span class="o">=</span> <span class="n">Root_SDA2</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_EISA</span>
	<span class="cm">/* FIXME:  only set this when we actually have EISA in this box? */</span>
	<span class="n">EISA_bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

 	<span class="cm">/*</span>
<span class="cm">	 * Check ASN in HWRPB for validity, report if bad.</span>
<span class="cm">	 * FIXME: how was this failing?  Should we trust it instead,</span>
<span class="cm">	 * and copy the value into alpha_mv.max_asn?</span>
<span class="cm"> 	 */</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">max_asn</span> <span class="o">!=</span> <span class="n">MAX_ASN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Max ASN from HWRPB is bad (0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">max_asn</span><span class="p">);</span>
 	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify the flock of penguins.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">setup_smp</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="n">paging_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">sys_unknown</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">systype_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;0&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADU&quot;</span><span class="p">,</span> <span class="s">&quot;Cobra&quot;</span><span class="p">,</span> <span class="s">&quot;Ruby&quot;</span><span class="p">,</span> <span class="s">&quot;Flamingo&quot;</span><span class="p">,</span> <span class="s">&quot;Mannequin&quot;</span><span class="p">,</span> <span class="s">&quot;Jensen&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pelican&quot;</span><span class="p">,</span> <span class="s">&quot;Morgan&quot;</span><span class="p">,</span> <span class="s">&quot;Sable&quot;</span><span class="p">,</span> <span class="s">&quot;Medulla&quot;</span><span class="p">,</span> <span class="s">&quot;Noname&quot;</span><span class="p">,</span>
	<span class="s">&quot;Turbolaser&quot;</span><span class="p">,</span> <span class="s">&quot;Avanti&quot;</span><span class="p">,</span> <span class="s">&quot;Mustang&quot;</span><span class="p">,</span> <span class="s">&quot;Alcor&quot;</span><span class="p">,</span> <span class="s">&quot;Tradewind&quot;</span><span class="p">,</span>
	<span class="s">&quot;Mikasa&quot;</span><span class="p">,</span> <span class="s">&quot;EB64&quot;</span><span class="p">,</span> <span class="s">&quot;EB66&quot;</span><span class="p">,</span> <span class="s">&quot;EB64+&quot;</span><span class="p">,</span> <span class="s">&quot;AlphaBook1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Rawhide&quot;</span><span class="p">,</span> <span class="s">&quot;K2&quot;</span><span class="p">,</span> <span class="s">&quot;Lynx&quot;</span><span class="p">,</span> <span class="s">&quot;XL&quot;</span><span class="p">,</span> <span class="s">&quot;EB164&quot;</span><span class="p">,</span> <span class="s">&quot;Noritake&quot;</span><span class="p">,</span>
	<span class="s">&quot;Cortex&quot;</span><span class="p">,</span> <span class="s">&quot;29&quot;</span><span class="p">,</span> <span class="s">&quot;Miata&quot;</span><span class="p">,</span> <span class="s">&quot;XXM&quot;</span><span class="p">,</span> <span class="s">&quot;Takara&quot;</span><span class="p">,</span> <span class="s">&quot;Yukon&quot;</span><span class="p">,</span>
	<span class="s">&quot;Tsunami&quot;</span><span class="p">,</span> <span class="s">&quot;Wildfire&quot;</span><span class="p">,</span> <span class="s">&quot;CUSCO&quot;</span><span class="p">,</span> <span class="s">&quot;Eiger&quot;</span><span class="p">,</span> <span class="s">&quot;Titan&quot;</span><span class="p">,</span> <span class="s">&quot;Marvel&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">unofficial_names</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;100&quot;</span><span class="p">,</span> <span class="s">&quot;Ruffian&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">api_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;200&quot;</span><span class="p">,</span> <span class="s">&quot;Nautilus&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">eb164_names</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;EB164&quot;</span><span class="p">,</span> <span class="s">&quot;PC164&quot;</span><span class="p">,</span> <span class="s">&quot;LX164&quot;</span><span class="p">,</span> <span class="s">&quot;SX164&quot;</span><span class="p">,</span> <span class="s">&quot;RX164&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eb164_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">alcor_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Alcor&quot;</span><span class="p">,</span> <span class="s">&quot;Maverick&quot;</span><span class="p">,</span> <span class="s">&quot;Bret&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">alcor_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">eb64p_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;EB64+&quot;</span><span class="p">,</span> <span class="s">&quot;Cabriolet&quot;</span><span class="p">,</span> <span class="s">&quot;AlphaPCI64&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eb64p_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">eb66_names</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;EB66&quot;</span><span class="p">,</span> <span class="s">&quot;EB66+&quot;</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">eb66_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">marvel_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Marvel/EV7&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">marvel_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">rawhide_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Dodge&quot;</span><span class="p">,</span> <span class="s">&quot;Wrangler&quot;</span><span class="p">,</span> <span class="s">&quot;Durango&quot;</span><span class="p">,</span> <span class="s">&quot;Tincup&quot;</span><span class="p">,</span> <span class="s">&quot;DaVinci&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rawhide_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">titan_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;DEFAULT&quot;</span><span class="p">,</span> <span class="s">&quot;Privateer&quot;</span><span class="p">,</span> <span class="s">&quot;Falcon&quot;</span><span class="p">,</span> <span class="s">&quot;Granite&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">titan_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">tsunami_names</span><span class="p">[][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;DP264&quot;</span><span class="p">,</span> <span class="s">&quot;Warhol&quot;</span><span class="p">,</span> <span class="s">&quot;Windjammer&quot;</span><span class="p">,</span> <span class="s">&quot;Monet&quot;</span><span class="p">,</span> <span class="s">&quot;Clipper&quot;</span><span class="p">,</span>
	<span class="s">&quot;Goldrush&quot;</span><span class="p">,</span> <span class="s">&quot;Webbrick&quot;</span><span class="p">,</span> <span class="s">&quot;Catamaran&quot;</span><span class="p">,</span> <span class="s">&quot;Brisbane&quot;</span><span class="p">,</span> <span class="s">&quot;Melbourne&quot;</span><span class="p">,</span>
	<span class="s">&quot;Flying Clipper&quot;</span><span class="p">,</span> <span class="s">&quot;Shark&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tsunami_indices</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">get_sysvec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">variation</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">systype_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* 0 */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* ADU */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Cobra */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Ruby */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Flamingo */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Mannequin */</span>
		<span class="o">&amp;</span><span class="n">jensen_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> 		<span class="cm">/* Pelican */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Morgan */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Sable -- see below.  */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Medulla */</span>
		<span class="o">&amp;</span><span class="n">noname_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Turbolaser */</span>
		<span class="o">&amp;</span><span class="n">avanti_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Mustang */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Alcor, Bret, Maverick. HWRPB inaccurate? */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Tradewind */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Mikasa -- see below.  */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* EB64 */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* EB66 -- see variation.  */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* EB64+ -- see variation.  */</span>
		<span class="o">&amp;</span><span class="n">alphabook1_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">rawhide_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* K2 */</span>
		<span class="o">&amp;</span><span class="n">lynx_mv</span><span class="p">,</span>	<span class="cm">/* Lynx */</span>
		<span class="o">&amp;</span><span class="n">xl_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* EB164 -- see variation.  */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Noritake -- see below.  */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Cortex */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* 29 */</span>
		<span class="o">&amp;</span><span class="n">miata_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* XXM */</span>
		<span class="o">&amp;</span><span class="n">takara_mv</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Yukon */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Tsunami -- see variation.  */</span>
		<span class="o">&amp;</span><span class="n">wildfire_mv</span><span class="p">,</span>	<span class="cm">/* Wildfire */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* CUSCO */</span>
		<span class="o">&amp;</span><span class="n">eiger_mv</span><span class="p">,</span>	<span class="cm">/* Eiger */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Titan */</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* Marvel */</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">unofficial_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* 100 */</span>
		<span class="o">&amp;</span><span class="n">ruffian_mv</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">api_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* 200 */</span>
		<span class="o">&amp;</span><span class="n">nautilus_mv</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">alcor_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> 
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">alcor_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xlt_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xlt_mv</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">eb164_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">eb164_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pc164_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lx164_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sx164_mv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx164_mv</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">eb64p_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">eb64p_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cabriolet_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cabriolet_mv</span>		<span class="cm">/* AlphaPCI64 */</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">eb66_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">eb66_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eb66p_mv</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">marvel_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">marvel_ev7_mv</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">titan_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">titan_mv</span><span class="p">,</span>		<span class="cm">/* default   */</span>
		<span class="o">&amp;</span><span class="n">privateer_mv</span><span class="p">,</span>		<span class="cm">/* privateer */</span>
		<span class="o">&amp;</span><span class="n">titan_mv</span><span class="p">,</span>		<span class="cm">/* falcon    */</span>
		<span class="o">&amp;</span><span class="n">privateer_mv</span><span class="p">,</span>		<span class="cm">/* granite   */</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">tsunami_vecs</span><span class="p">[]</span>  <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>		<span class="cm">/* dp264 */</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>		<span class="cm">/* warhol */</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>		<span class="cm">/* windjammer */</span>
		<span class="o">&amp;</span><span class="n">monet_mv</span><span class="p">,</span>		<span class="cm">/* monet */</span>
		<span class="o">&amp;</span><span class="n">clipper_mv</span><span class="p">,</span>		<span class="cm">/* clipper */</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>		<span class="cm">/* goldrush */</span>
		<span class="o">&amp;</span><span class="n">webbrick_mv</span><span class="p">,</span>		<span class="cm">/* webbrick */</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>		<span class="cm">/* catamaran */</span>
		<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* brisbane? */</span>
		<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* melbourne? */</span>
		<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* flying clipper? */</span>
		<span class="o">&amp;</span><span class="n">shark_mv</span><span class="p">,</span>		<span class="cm">/* shark */</span>
	<span class="p">};</span>

	<span class="cm">/* ??? Do we need to distinguish between Rawhides?  */</span>

	<span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">vec</span><span class="p">;</span>

	<span class="cm">/* Search the system tables first... */</span>
	<span class="n">vec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">systype_vecs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">systype_vecs</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">ST_API_BIAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_API_BIAS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">api_vecs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">api_vecs</span><span class="p">[</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_API_BIAS</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unofficial_vecs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vec</span> <span class="o">=</span> <span class="n">unofficial_vecs</span><span class="p">[</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;ve not found one, try for a variation.  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Member ID is a bit-field. */</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">member</span> <span class="o">=</span> <span class="p">(</span><span class="n">variation</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">cpu</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="cm">/* make it usable */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ST_DEC_ALCOR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">alcor_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">alcor_vecs</span><span class="p">[</span><span class="n">alcor_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_EB164</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb164_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">eb164_vecs</span><span class="p">[</span><span class="n">eb164_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="cm">/* PC164 may show as EB164 variation with EV56 CPU,</span>
<span class="cm">			   but, since no true EB164 had anything but EV5... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">eb164_mv</span> <span class="o">&amp;&amp;</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">EV56_CPU</span><span class="p">)</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pc164_mv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_EB64P</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb64p_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">eb64p_vecs</span><span class="p">[</span><span class="n">eb64p_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_EB66</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb66_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">eb66_vecs</span><span class="p">[</span><span class="n">eb66_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_MARVEL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">marvel_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">marvel_vecs</span><span class="p">[</span><span class="n">marvel_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_TITAN</span>:
			<span class="n">vec</span> <span class="o">=</span> <span class="n">titan_vecs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* default */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">titan_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">titan_vecs</span><span class="p">[</span><span class="n">titan_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_TSUNAMI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tsunami_indices</span><span class="p">))</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="n">tsunami_vecs</span><span class="p">[</span><span class="n">tsunami_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_1000</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">EV5_CPU</span> <span class="o">||</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">EV56_CPU</span><span class="p">)</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mikasa_primo_mv</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mikasa_mv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_NORITAKE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">EV5_CPU</span> <span class="o">||</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">EV56_CPU</span><span class="p">)</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">noritake_primo_mv</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">noritake_mv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ST_DEC_2100_A500</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">EV5_CPU</span> <span class="o">||</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">EV56_CPU</span><span class="p">)</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sable_gamma_mv</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">vec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sable_mv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">get_sysvec_byname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">all_vecs</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">&amp;</span><span class="n">alcor_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">alphabook1_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">avanti_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cabriolet_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">clipper_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dp264_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eb164_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eb64p_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eb66_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eb66p_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">eiger_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">jensen_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">lx164_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">lynx_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">miata_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mikasa_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">mikasa_primo_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">monet_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">nautilus_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">noname_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">noritake_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">noritake_primo_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">p2k_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">pc164_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">privateer_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">rawhide_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ruffian_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">rx164_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sable_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sable_gamma_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">shark_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">sx164_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">takara_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">webbrick_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">wildfire_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">xl_mv</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">xlt_mv</span>
	<span class="p">};</span>

	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">all_vecs</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">alpha_machine_vector</span> <span class="o">*</span><span class="n">mv</span> <span class="o">=</span> <span class="n">all_vecs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">mv</span><span class="o">-&gt;</span><span class="n">vector_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">get_sysnames</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">variation</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cpu</span><span class="p">,</span>
	     <span class="kt">char</span> <span class="o">**</span><span class="n">type_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">variation_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">member</span><span class="p">;</span>

	<span class="cm">/* If not in the tables, make it UNKNOWN,</span>
<span class="cm">	   else set type name to family */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">systype_names</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">type_name</span> <span class="o">=</span> <span class="n">systype_names</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">ST_API_BIAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_API_BIAS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">api_names</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">type_name</span> <span class="o">=</span> <span class="n">api_names</span><span class="p">[</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_API_BIAS</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&gt;</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unofficial_names</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">type_name</span> <span class="o">=</span> <span class="n">unofficial_names</span><span class="p">[</span><span class="n">type</span> <span class="o">-</span> <span class="n">ST_UNOFFICIAL_BIAS</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">type_name</span> <span class="o">=</span> <span class="n">sys_unknown</span><span class="p">;</span>
		<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">sys_unknown</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set variation to &quot;0&quot;; if variation is zero, done.  */</span>
	<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">systype_names</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">variation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">member</span> <span class="o">=</span> <span class="p">(</span><span class="n">variation</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span> <span class="cm">/* member ID is a bit-field */</span>

	<span class="n">cpu</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="cm">/* make it usable */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* select by family */</span>
	<span class="nl">default:</span> <span class="cm">/* default to variation &quot;0&quot; for now */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_EB164</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb164_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">eb164_names</span><span class="p">[</span><span class="n">eb164_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="cm">/* PC164 may show as EB164 variation, but with EV56 CPU,</span>
<span class="cm">		   so, since no true EB164 had anything but EV5... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eb164_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cpu</span> <span class="o">==</span> <span class="n">EV56_CPU</span><span class="p">)</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">eb164_names</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* make it PC164 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_ALCOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">alcor_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">alcor_names</span><span class="p">[</span><span class="n">alcor_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_EB64P</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb64p_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">eb64p_names</span><span class="p">[</span><span class="n">eb64p_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_EB66</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eb66_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">eb66_names</span><span class="p">[</span><span class="n">eb66_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_MARVEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">marvel_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">marvel_names</span><span class="p">[</span><span class="n">marvel_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_RAWHIDE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rawhide_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">rawhide_names</span><span class="p">[</span><span class="n">rawhide_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_TITAN</span>:
		<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">titan_names</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">titan_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">titan_names</span><span class="p">[</span><span class="n">titan_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ST_DEC_TSUNAMI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tsunami_indices</span><span class="p">))</span>
			<span class="o">*</span><span class="n">variation_name</span> <span class="o">=</span> <span class="n">tsunami_names</span><span class="p">[</span><span class="n">tsunami_indices</span><span class="p">[</span><span class="n">member</span><span class="p">]];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A change was made to the HWRPB via an ECO and the following code</span>
<span class="cm"> * tracks a part of the ECO.  In HWRPB versions less than 5, the ECO</span>
<span class="cm"> * was not implemented in the console firmware.  If it&#39;s revision 5 or</span>
<span class="cm"> * greater we can get the name of the platform as an ASCII string from</span>
<span class="cm"> * the HWRPB.  That&#39;s what this function does.  It checks the revision</span>
<span class="cm"> * level and if the string is in the HWRPB it returns the address of</span>
<span class="cm"> * the string--a pointer to the name of the platform.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *      - Pointer to a ASCII string if it&#39;s in the HWRPB</span>
<span class="cm"> *      - Pointer to a blank string if the data is not in the HWRPB.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">platform_string</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsr_struct</span> <span class="o">*</span><span class="n">dsr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">unk_system_string</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;N/A&quot;</span><span class="p">;</span>

	<span class="cm">/* Go to the console for the string pointer.</span>
<span class="cm">	 * If the rpb_vers is not 5 or greater the rpb</span>
<span class="cm">	 * is old and does not have this data in it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">unk_system_string</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The Dynamic System Recognition struct</span>
<span class="cm">		 * has the system platform name starting</span>
<span class="cm">		 * after the character count of the string.</span>
<span class="cm">		 */</span>
		<span class="n">dsr</span> <span class="o">=</span>  <span class="p">((</span><span class="k">struct</span> <span class="n">dsr_struct</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span> <span class="o">+</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">dsr_offset</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">dsr</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsr</span><span class="o">-&gt;</span><span class="n">sysname_off</span> <span class="o">+</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_nr_processors</span><span class="p">(</span><span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="n">cpubase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">cpubase</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">processor_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x1cc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1cc</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">show_cache_size</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">which</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shape</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">seq_printf</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t\t</span><span class="s">: n/a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shape</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t\t</span><span class="s">: unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t\t</span><span class="s">: %dK, %d-way, %db line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">which</span><span class="p">,</span> <span class="n">shape</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">shape</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">,</span>
			    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">shape</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">show_cpuinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="k">struct</span> <span class="n">unaligned_stat</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">pc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="n">cpu_names</span><span class="p">[][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;EV3&quot;</span><span class="p">,</span> <span class="s">&quot;EV4&quot;</span><span class="p">,</span> <span class="s">&quot;Simulate&quot;</span><span class="p">,</span> <span class="s">&quot;LCA4&quot;</span><span class="p">,</span> <span class="s">&quot;EV5&quot;</span><span class="p">,</span> <span class="s">&quot;EV45&quot;</span><span class="p">,</span> <span class="s">&quot;EV56&quot;</span><span class="p">,</span>
		<span class="s">&quot;EV6&quot;</span><span class="p">,</span> <span class="s">&quot;PCA56&quot;</span><span class="p">,</span> <span class="s">&quot;PCA57&quot;</span><span class="p">,</span> <span class="s">&quot;EV67&quot;</span><span class="p">,</span> <span class="s">&quot;EV68CB&quot;</span><span class="p">,</span> <span class="s">&quot;EV68AL&quot;</span><span class="p">,</span>
		<span class="s">&quot;EV68CX&quot;</span><span class="p">,</span> <span class="s">&quot;EV7&quot;</span><span class="p">,</span> <span class="s">&quot;EV79&quot;</span><span class="p">,</span> <span class="s">&quot;EV69&quot;</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu_index</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cpu_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">systype_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sysvariation_name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_processors</span><span class="p">;</span>

	<span class="n">cpu_index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cpu_name</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cpu_names</span><span class="p">))</span>
		<span class="n">cpu_name</span> <span class="o">=</span> <span class="n">cpu_names</span><span class="p">[</span><span class="n">cpu_index</span><span class="p">];</span>

	<span class="n">get_sysnames</span><span class="p">(</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_type</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_variation</span><span class="p">,</span>
		     <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">systype_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysvariation_name</span><span class="p">);</span>

	<span class="n">nr_processors</span> <span class="o">=</span> <span class="n">get_nr_processors</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">nr_processors</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;cpu</span><span class="se">\t\t\t</span><span class="s">: Alpha</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpu model</span><span class="se">\t\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpu variation</span><span class="se">\t\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpu revision</span><span class="se">\t\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpu serial number</span><span class="se">\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;system type</span><span class="se">\t\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;system variation</span><span class="se">\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;system revision</span><span class="se">\t\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;system serial number</span><span class="se">\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cycle frequency [Hz]</span><span class="se">\t</span><span class="s">: %lu %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;timer frequency [Hz]</span><span class="se">\t</span><span class="s">: %lu.%02lu</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;page size [bytes]</span><span class="se">\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;phys. address bits</span><span class="se">\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;max. addr. space #</span><span class="se">\t</span><span class="s">: %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;BogoMIPS</span><span class="se">\t\t</span><span class="s">: %lu.%02lu</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;kernel unaligned acc</span><span class="se">\t</span><span class="s">: %ld (pc=%lx,va=%lx)</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;user unaligned acc</span><span class="se">\t</span><span class="s">: %ld (pc=%lx,va=%lx)</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;platform string</span><span class="se">\t\t</span><span class="s">: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpus detected</span><span class="se">\t\t</span><span class="s">: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cpu_name</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">variation</span><span class="p">,</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">cpu</span><span class="o">-&gt;</span><span class="n">serial_no</span><span class="p">,</span>
		       <span class="n">systype_name</span><span class="p">,</span> <span class="n">sysvariation_name</span><span class="p">,</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">sys_revision</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">,</span>
		       <span class="n">est_cycle_freq</span> <span class="o">?</span> <span class="o">:</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">cycle_freq</span><span class="p">,</span>
		       <span class="n">est_cycle_freq</span> <span class="o">?</span> <span class="s">&quot;est.&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">intr_freq</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">,</span>
		       <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">intr_freq</span> <span class="o">/</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span>
		       <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">pagesize</span><span class="p">,</span>
		       <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">pa_bits</span><span class="p">,</span>
		       <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">max_asn</span><span class="p">,</span>
		       <span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">500000</span><span class="o">/</span><span class="n">HZ</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">loops_per_jiffy</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="n">HZ</span><span class="p">))</span> <span class="o">%</span> <span class="mi">100</span><span class="p">,</span>
		       <span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">,</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pc</span><span class="p">,</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span><span class="p">,</span>
		       <span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">,</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pc</span><span class="p">,</span> <span class="n">unaligned</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">va</span><span class="p">,</span>
		       <span class="n">platform_string</span><span class="p">(),</span> <span class="n">nr_processors</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SMP</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;cpus active</span><span class="se">\t\t</span><span class="s">: %u</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;cpu active mask</span><span class="se">\t\t</span><span class="s">: %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">num_online_cpus</span><span class="p">(),</span> <span class="n">cpumask_bits</span><span class="p">(</span><span class="n">cpu_possible_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="n">show_cache_size</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;L1 Icache&quot;</span><span class="p">,</span> <span class="n">alpha_l1i_cacheshape</span><span class="p">);</span>
	<span class="n">show_cache_size</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;L1 Dcache&quot;</span><span class="p">,</span> <span class="n">alpha_l1d_cacheshape</span><span class="p">);</span>
	<span class="n">show_cache_size</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;L2 cache&quot;</span><span class="p">,</span> <span class="n">alpha_l2_cacheshape</span><span class="p">);</span>
	<span class="n">show_cache_size</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&quot;L3 cache&quot;</span><span class="p">,</span> <span class="n">alpha_l3_cacheshape</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">read_mem_block</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stride</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">nloads</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">stride</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
	<span class="s">&quot;	rpcc    %0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;1:	ldl	%3,0(%2)</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	subq	%1,1,%1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* Next two XORs introduce an explicit data dependency between</span>
<span class="cm">	   consecutive loads in the loop, which will give us true load</span>
<span class="cm">	   latency. */</span>
	<span class="s">&quot;	xor	%3,%2,%2</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	xor	%3,%2,%2</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	addq	%2,%4,%2</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	bne	%1,1b</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	rpcc	%3</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;	subl	%3,%0,%0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="o">:</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">cnt</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">nloads</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;=&amp;r&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
	<span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">stride</span><span class="p">),</span> <span class="s">&quot;1&quot;</span> <span class="p">(</span><span class="n">nloads</span><span class="p">),</span> <span class="s">&quot;2&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">cnt</span> <span class="o">/</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">stride</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CSHAPE(totalsize, linesize, assoc) \</span>
<span class="cp">  ((totalsize &amp; ~0xff) | (linesize &lt;&lt; 4) | assoc)</span>

<span class="cm">/* ??? EV5 supports up to 64M, but did the systems with more than</span>
<span class="cm">   16M of BCACHE ever exist? */</span>
<span class="cp">#define MAX_BCACHE_SIZE	16*1024*1024</span>

<span class="cm">/* Note that the offchip caches are direct mapped on all Alphas. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">external_cache_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">minsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">prev_cycles</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stride</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">minsize</span><span class="p">,</span> <span class="n">maxsize</span> <span class="o">=</span> <span class="n">MAX_BCACHE_SIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_low_pfn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span>
		<span class="n">maxsize</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">max_low_pfn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Get the first block cached. */</span>
	<span class="n">read_mem_block</span><span class="p">(</span><span class="n">__va</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">stride</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">maxsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get an average load latency in cycles. */</span>
		<span class="n">cycles</span> <span class="o">=</span> <span class="n">read_mem_block</span><span class="p">(</span><span class="n">__va</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">stride</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cycles</span> <span class="o">&gt;</span> <span class="n">prev_cycles</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Fine, we exceed the cache. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%ldK Bcache detected; load hit latency %d &quot;</span>
			       <span class="s">&quot;cycles, load miss latency %d cycles</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">,</span> <span class="n">prev_cycles</span><span class="p">,</span> <span class="n">cycles</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Try to get the next block cached. */</span>
		<span class="n">read_mem_block</span><span class="p">(</span><span class="n">__va</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">stride</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">prev_cycles</span> <span class="o">=</span> <span class="n">cycles</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No BCACHE found. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">determine_cpu_caches</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">L1I</span><span class="p">,</span> <span class="n">L1D</span><span class="p">,</span> <span class="n">L2</span><span class="p">,</span> <span class="n">L3</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EV4_CPU</span>:
	<span class="k">case</span> <span class="n">EV45_CPU</span>:
	  <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">EV4_CPU</span><span class="p">)</span>
			<span class="n">L1I</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">L1I</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">L1D</span> <span class="o">=</span> <span class="n">L1I</span><span class="p">;</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	
		<span class="cm">/* BIU_CTL is a write-only Abox register.  PALcode has a</span>
<span class="cm">		   shadow copy, and may be available from some versions</span>
<span class="cm">		   of the CSERVE PALcall.  If we can get it, then</span>

<span class="cm">			unsigned long biu_ctl, size;</span>
<span class="cm">			size = 128*1024 * (1 &lt;&lt; ((biu_ctl &gt;&gt; 28) &amp; 7));</span>
<span class="cm">			L2 = CSHAPE (size, 5, 1);</span>

<span class="cm">		   Unfortunately, we can&#39;t rely on that.</span>
<span class="cm">		*/</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="n">external_cache_probe</span><span class="p">(</span><span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="p">}</span>

	<span class="k">case</span> <span class="n">LCA4_CPU</span>:
	  <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">car</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">L1I</span> <span class="o">=</span> <span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">car</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="n">phys_to_virt</span> <span class="p">(</span><span class="mh">0x120000078UL</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">car</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
		<span class="cm">/* No typo -- 8 byte cacheline size.  Whodathunk.  */</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="p">(</span><span class="n">car</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">CSHAPE</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="p">}</span>

	<span class="k">case</span> <span class="n">EV5_CPU</span>:
	<span class="k">case</span> <span class="n">EV56_CPU</span>:
	  <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sc_ctl</span><span class="p">,</span> <span class="n">width</span><span class="p">;</span>

		<span class="n">L1I</span> <span class="o">=</span> <span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Check the line size of the Scache.  */</span>
		<span class="n">sc_ctl</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span> <span class="n">phys_to_virt</span> <span class="p">(</span><span class="mh">0xfffff000a8UL</span><span class="p">);</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">sc_ctl</span> <span class="o">&amp;</span> <span class="mh">0x1000</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="n">CSHAPE</span> <span class="p">(</span><span class="mi">96</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* BC_CONTROL and BC_CONFIG are write-only IPRs.  PALcode</span>
<span class="cm">		   has a shadow copy, and may be available from some versions</span>
<span class="cm">		   of the CSERVE PALcall.  If we can get it, then</span>

<span class="cm">			unsigned long bc_control, bc_config, size;</span>
<span class="cm">			size = 1024*1024 * (1 &lt;&lt; ((bc_config &amp; 7) - 1));</span>
<span class="cm">			L3 = (bc_control &amp; 1 ? CSHAPE (size, width, 1) : -1);</span>

<span class="cm">		   Unfortunately, we can&#39;t rely on that.</span>
<span class="cm">		*/</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="n">external_cache_probe</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="p">}</span>

	<span class="k">case</span> <span class="n">PCA56_CPU</span>:
	<span class="k">case</span> <span class="n">PCA57_CPU</span>:
	  <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">PCA56_CPU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">L1I</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">L1I</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		unsigned long cbox_config, size;</span>

<span class="c">		cbox_config = *(vulp) phys_to_virt (0xfffff00008UL);</span>
<span class="c">		size = 512*1024 * (1 &lt;&lt; ((cbox_config &gt;&gt; 12) &amp; 3));</span>

<span class="c">		L2 = ((cbox_config &gt;&gt; 31) &amp; 1 ? CSHAPE (size, 6, 1) : -1);</span>
<span class="cp">#else</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="n">external_cache_probe</span><span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	  <span class="p">}</span>

	<span class="k">case</span> <span class="n">EV6_CPU</span>:
	<span class="k">case</span> <span class="n">EV67_CPU</span>:
	<span class="k">case</span> <span class="n">EV68CB_CPU</span>:
	<span class="k">case</span> <span class="n">EV68AL_CPU</span>:
	<span class="k">case</span> <span class="n">EV68CX_CPU</span>:
	<span class="k">case</span> <span class="n">EV69_CPU</span>:
		<span class="n">L1I</span> <span class="o">=</span> <span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="n">external_cache_probe</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">EV7_CPU</span>:
	<span class="k">case</span> <span class="n">EV79_CPU</span>:
		<span class="n">L1I</span> <span class="o">=</span> <span class="n">L1D</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">L2</span> <span class="o">=</span> <span class="n">CSHAPE</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">L3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Nothing known about this cpu type.  */</span>
		<span class="n">L1I</span> <span class="o">=</span> <span class="n">L1D</span> <span class="o">=</span> <span class="n">L2</span> <span class="o">=</span> <span class="n">L3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alpha_l1i_cacheshape</span> <span class="o">=</span> <span class="n">L1I</span><span class="p">;</span>
	<span class="n">alpha_l1d_cacheshape</span> <span class="o">=</span> <span class="n">L1D</span><span class="p">;</span>
	<span class="n">alpha_l2_cacheshape</span> <span class="o">=</span> <span class="n">L2</span><span class="p">;</span>
	<span class="n">alpha_l3_cacheshape</span> <span class="o">=</span> <span class="n">L3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We show only CPU #0 info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">c_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span> <span class="o">+</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">processor_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">c_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">c_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">cpuinfo_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>	<span class="o">=</span> <span class="n">c_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>	<span class="o">=</span> <span class="n">c_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>	<span class="o">=</span> <span class="n">c_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>	<span class="o">=</span> <span class="n">show_cpuinfo</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">alpha_panic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 1</span>
	<span class="cm">/* FIXME FIXME FIXME */</span>
	<span class="cm">/* If we are using SRM and serial console, just hard halt here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span> <span class="o">&amp;&amp;</span> <span class="n">srmcons_output</span><span class="p">)</span>
		<span class="n">__halt</span><span class="p">();</span>
<span class="cp">#endif</span>
        <span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">add_pcspkr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pd</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;pcspkr&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">platform_device_put</span><span class="p">(</span><span class="n">pd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">device_initcall</span><span class="p">(</span><span class="n">add_pcspkr</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
