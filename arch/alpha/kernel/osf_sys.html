<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › osf_sys.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>osf_sys.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/alpha/kernel/osf_sys.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This file handles some of the stranger OSF/1 system call interfaces.</span>
<span class="cm"> * Some of the system calls expect a non-C calling standard, others have</span>
<span class="cm"> * special parameter blocks..</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/utsname.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/timex.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>
<span class="cp">#include &lt;linux/mman.h&gt;</span>
<span class="cp">#include &lt;linux/shm.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/file.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/ipc.h&gt;</span>
<span class="cp">#include &lt;linux/namei.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/vfs.h&gt;</span>
<span class="cp">#include &lt;linux/rcupdate.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/fpu.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/sysinfo.h&gt;</span>
<span class="cp">#include &lt;asm/thread_info.h&gt;</span>
<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Brk needs to return an error.  Still support Linux&#39;s brk(0) query idiom,</span>
<span class="cm"> * which OSF programs just shouldn&#39;t be doing.  We&#39;re still not quite</span>
<span class="cm"> * identical to OSF as we don&#39;t return 0 on success, but doing otherwise</span>
<span class="cm"> * would require changes to libc.  Hopefully this is good enough.</span>
<span class="cm"> */</span>
<span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">osf_brk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">brk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">sys_brk</span><span class="p">(</span><span class="n">brk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brk</span> <span class="o">&amp;&amp;</span> <span class="n">brk</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/*</span>
<span class="cm"> * This is pure guess-work..</span>
<span class="cm"> */</span>
<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">osf_set_program_attributes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">text_start</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">text_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bss_start</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bss_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>

	<span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">end_code</span> <span class="o">=</span> <span class="n">bss_start</span> <span class="o">+</span> <span class="n">bss_len</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">start_brk</span> <span class="o">=</span> <span class="n">bss_start</span> <span class="o">+</span> <span class="n">bss_len</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">brk</span> <span class="o">=</span> <span class="n">bss_start</span> <span class="o">+</span> <span class="n">bss_len</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;set_program_attributes(%lx %lx %lx %lx)\n&quot;,</span>
<span class="c">		text_start, text_len, bss_start, bss_len);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * OSF/1 directory handling functions...</span>
<span class="cm"> *</span>
<span class="cm"> * The &quot;getdents()&quot; interface is much more sane: the &quot;basep&quot; stuff is</span>
<span class="cm"> * braindamage (it can&#39;t really handle filesystems where the directory</span>
<span class="cm"> * offset differences aren&#39;t the same as &quot;d_reclen&quot;).</span>
<span class="cm"> */</span>
<span class="cp">#define NAME_OFFSET	offsetof (struct osf_dirent, d_name)</span>

<span class="k">struct</span> <span class="n">osf_dirent</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d_ino</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">d_reclen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">d_namlen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">d_name</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osf_dirent_callback</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">osf_dirent</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dirent</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="n">basep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">osf_filldir</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">__buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">namlen</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span>
	    <span class="n">u64</span> <span class="n">ino</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osf_dirent</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dirent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osf_dirent_callback</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">osf_dirent_callback</span> <span class="o">*</span><span class="p">)</span> <span class="n">__buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reclen</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">NAME_OFFSET</span> <span class="o">+</span> <span class="n">namlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d_ino</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* only used if we fail */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reclen</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">d_ino</span> <span class="o">=</span> <span class="n">ino</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">d_ino</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ino</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">d_ino</span> <span class="o">!=</span> <span class="n">ino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">basep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">basep</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">Efault</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">basep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dirent</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dirent</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">d_ino</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_ino</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">namlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_namlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="n">reclen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_reclen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namlen</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dirent</span><span class="o">-&gt;</span><span class="n">d_name</span> <span class="o">+</span> <span class="n">namlen</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Efault</span><span class="p">;</span>
	<span class="n">dirent</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">dirent</span> <span class="o">+</span> <span class="n">reclen</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">dirent</span> <span class="o">=</span> <span class="n">dirent</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">reclen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">Efault:</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">osf_getdirentries</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">osf_dirent</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">dirent</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">basep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">osf_dirent_callback</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="n">file</span> <span class="o">=</span> <span class="n">fget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">.</span><span class="n">dirent</span> <span class="o">=</span> <span class="n">dirent</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">basep</span> <span class="o">=</span> <span class="n">basep</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_readdir</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">osf_filldir</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">buf</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="n">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#undef NAME_OFFSET</span>

<span class="n">SYSCALL_DEFINE6</span><span class="p">(</span><span class="n">osf_mmap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (flags &amp; (_MAP_HASSEMAPHORE | _MAP_INHERIT | _MAP_UNALIGNED))</span>
<span class="c">		printk(&quot;%s: unimplemented OSF mmap flags %04lx\n&quot;, </span>
<span class="c">			current-&gt;comm, flags);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">+</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">len</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_mmap_pgoff</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">off</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">osf_stat</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">st_dev</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad1</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">st_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">st_nlink</span><span class="p">;</span>
	<span class="kt">short</span>		<span class="n">st_nlink_reserved</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">st_uid</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">st_gid</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_rdev</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_ldev</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">st_size</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_uatime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad3</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_umtime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad4</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_uctime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad5</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_pad6</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">st_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">st_gen</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">st_spare</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span>	<span class="n">st_ino</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_ino_reserved</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_atime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_atime_reserved</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_mtime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_mtime_reserved</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_ctime</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">st_ctime_reserved</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">st_blksize</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">st_blocks</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The OSF/1 statfs structure is much larger, but this should</span>
<span class="cm"> * match the beginning, at least.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">osf_statfs</span> <span class="p">{</span>
	<span class="kt">short</span> <span class="n">f_type</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">f_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_fsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_bsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_bfree</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_bavail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_files</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_ffree</span><span class="p">;</span>
	<span class="n">__kernel_fsid_t</span> <span class="n">f_fsid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">osf_statfs64</span> <span class="p">{</span>
	<span class="kt">short</span> <span class="n">f_type</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">f_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad5</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad6</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_pad7</span><span class="p">;</span>
	<span class="n">__kernel_fsid_t</span> <span class="n">f_fsid</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">f_namemax</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">f_reserved1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f_spare</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">f_pad8</span><span class="p">[</span><span class="mi">90</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">f_pad9</span><span class="p">[</span><span class="mi">90</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">mount_info</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">u_long</span> <span class="n">f_flags2</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_spare2</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">f_fsize</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_bsize</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_blocks</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_bfree</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_bavail</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_files</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">f_ffree</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">linux_to_osf_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">kstat</span> <span class="o">*</span><span class="n">lstat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_stat</span> <span class="n">__user</span> <span class="o">*</span><span class="n">osf_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osf_stat</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">tmp</span><span class="p">.</span><span class="n">st_dev</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_mode</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_nlink</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">nlink</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_uid</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_gid</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_rdev</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ldev</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_size</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_uatime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_umtime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_uctime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ino</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">ino</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_atime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">atime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_mtime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">mtime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_ctime</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">ctime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_blksize</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">blksize</span><span class="p">;</span>
	<span class="n">tmp</span><span class="p">.</span><span class="n">st_blocks</span>	<span class="o">=</span> <span class="n">lstat</span><span class="o">-&gt;</span><span class="n">blocks</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">osf_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">linux_to_osf_statfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">linux_stat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_statfs</span> <span class="n">__user</span> <span class="o">*</span><span class="n">osf_stat</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osf_statfs</span> <span class="n">tmp_stat</span><span class="p">;</span>

	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_type</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* mount flags */</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_fsize</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_frsize</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bsize</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_blocks</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bavail</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_files</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_ffree</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_fsid</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufsiz</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_stat</span><span class="p">))</span>
		<span class="n">bufsiz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">osf_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_stat</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">linux_to_osf_statfs64</span><span class="p">(</span><span class="k">struct</span> <span class="n">kstatfs</span> <span class="o">*</span><span class="n">linux_stat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_statfs64</span> <span class="n">__user</span> <span class="o">*</span><span class="n">osf_stat</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osf_statfs64</span> <span class="n">tmp_stat</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_type</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_type</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_fsize</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_frsize</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bsize</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bsize</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_blocks</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_blocks</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bfree</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bfree</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_bavail</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_bavail</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_files</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_files</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_ffree</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_ffree</span><span class="p">;</span>
	<span class="n">tmp_stat</span><span class="p">.</span><span class="n">f_fsid</span> <span class="o">=</span> <span class="n">linux_stat</span><span class="o">-&gt;</span><span class="n">f_fsid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufsiz</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_stat</span><span class="p">))</span>
		<span class="n">bufsiz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_stat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">osf_stat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_stat</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_statfs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">osf_statfs</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">linux_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">user_statfs</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">linux_to_osf_statfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>	
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_stat</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_stat</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_stat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">linux_to_osf_stat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_lstat</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_stat</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_lstat</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">linux_to_osf_stat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_fstat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">osf_stat</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstat</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">vfs_fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">linux_to_osf_stat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_fstatfs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">osf_statfs</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">linux_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">fd_statfs</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">linux_to_osf_statfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_statfs64</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">osf_statfs64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">linux_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">user_statfs</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">linux_to_osf_statfs64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_fstatfs64</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">osf_statfs64</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kstatfs</span> <span class="n">linux_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">fd_statfs</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">linux_to_osf_statfs64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">linux_stat</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">bufsiz</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Uhh.. OSF/1 mount parameters aren&#39;t exactly obvious..</span>
<span class="cm"> *</span>
<span class="cm"> * Although to be frank, neither are the native Linux/i386 ones..</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ufs_args</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">exroot</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cdfs_args</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">exroot</span><span class="p">;</span>

	<span class="cm">/* This has lots more here, which Linux handles with the option block</span>
<span class="cm">	   but I&#39;m too lazy to do the translation into ASCII.  */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">procfs_args</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">uid_t</span> <span class="n">exroot</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * We can&#39;t actually handle ufs yet, so we translate UFS mounts to</span>
<span class="cm"> * ext2fs mounts. I wouldn&#39;t mind a UFS filesystem, but the UFS</span>
<span class="cm"> * layout is so braindead it&#39;s a major headache doing it.</span>
<span class="cm"> *</span>
<span class="cm"> * Just how long ago was it written? OTOH our UFS driver may be still</span>
<span class="cm"> * unhappy with OSF UFS. [CHECKME]</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">osf_ufs_mount</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dirname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ufs_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdfs_args</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">devname</span> <span class="o">=</span> <span class="n">getname</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">do_mount</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="s">&quot;ext2&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">putname</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">osf_cdfs_mount</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dirname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdfs_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdfs_args</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">devname</span> <span class="o">=</span> <span class="n">getname</span><span class="p">(</span><span class="n">tmp</span><span class="p">.</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">devname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">do_mount</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="s">&quot;iso9660&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">putname</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">osf_procfs_mount</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dirname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">procfs_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">procfs_args</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_mount</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">osf_mount</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">typenr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
		<span class="kt">int</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">name</span> <span class="o">=</span> <span class="n">getname</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">typenr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osf_ufs_mount</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osf_cdfs_mount</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">osf_procfs_mount</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;osf_mount(%ld, %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">typenr</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">putname</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">osf_utsname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">64</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">96</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">128</span><span class="p">,</span> <span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">machine</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>	
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE0</span><span class="p">(</span><span class="n">getpagesize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE0</span><span class="p">(</span><span class="n">getdtablesize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysctl_nr_open</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For compatibility with OSF/1 only.  Use utsname(2) instead.</span>
<span class="cm"> */</span>
<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_getdomainname</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">namelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">namelen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__put_user</span><span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">domainname</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following stuff should move into a header file should it ever</span>
<span class="cm"> * be labeled &quot;officially supported.&quot;  Right now, there is just enough</span>
<span class="cm"> * support to avoid applications (such as tar) printing error</span>
<span class="cm"> * messages.  The attributes are not really implemented.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Values for Property list entry flag</span>
<span class="cm"> */</span>
<span class="cp">#define PLE_PROPAGATE_ON_COPY		0x1	</span><span class="cm">/* cp(1) will copy entry</span>
<span class="cm">						   by default */</span><span class="cp"></span>
<span class="cp">#define PLE_FLAG_MASK			0x1	</span><span class="cm">/* Valid flag values */</span><span class="cp"></span>
<span class="cp">#define PLE_FLAG_ALL			-1	</span><span class="cm">/* All flag value */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">proplistname_args</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pl_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pl_numnames</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">pl_names</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">pl_args</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">setargs</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">follow</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fsetargs</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">fd</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">fset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">getargs</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">follow</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">proplistname_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">name_args</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">min_buf_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">get</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fgetargs</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">fd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">proplistname_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">name_args</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">nbytes</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">min_buf_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">fget</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delargs</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">follow</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">proplistname_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">name_args</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">del</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdelargs</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">fd</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">proplistname_args</span> <span class="n">__user</span> <span class="o">*</span><span class="n">name_args</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">fdel</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">pl_code</span> <span class="p">{</span>
	<span class="n">PL_SET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PL_FSET</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">PL_GET</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">PL_FGET</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">PL_DEL</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">PL_FDEL</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">};</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_proplist_syscall</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pl_code</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span>
		<span class="k">union</span> <span class="n">pl_args</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">min_buf_size_ptr</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL_SET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">.</span><span class="n">nbytes</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_FSET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">fset</span><span class="p">.</span><span class="n">nbytes</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_GET</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">min_buf_size_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">.</span><span class="n">min_buf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_buf_size_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_FGET</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">get_user</span><span class="p">(</span><span class="n">min_buf_size_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">fget</span><span class="p">.</span><span class="n">min_buf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_buf_size_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_DEL</span>:
	<span class="k">case</span> <span class="n">PL_FDEL</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_sigstack</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sigstack</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uss</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sigstack</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uoss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">usp</span> <span class="o">=</span> <span class="n">rdusp</span><span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oss_sp</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">oss_os</span> <span class="o">=</span> <span class="n">on_sig_stack</span><span class="p">(</span><span class="n">usp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uss</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ss_sp</span><span class="p">;</span>

		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">ss_sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uss</span><span class="o">-&gt;</span><span class="n">ss_sp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* If the current stack was set with sigaltstack, don&#39;t</span>
<span class="cm">		   swap stacks while we are on it.  */</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">&amp;&amp;</span> <span class="n">on_sig_stack</span><span class="p">(</span><span class="n">usp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Since we don&#39;t know the extent of the stack, and we don&#39;t</span>
<span class="cm">		   track onstack-ness, but rather calculate it, we must </span>
<span class="cm">		   presume a size.  Ho hum this interface is lossy.  */</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ss_sp</span> <span class="o">-</span> <span class="n">SIGSTKSZ</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span> <span class="o">=</span> <span class="n">SIGSTKSZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uoss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">uoss</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">uoss</span><span class="p">))</span>
		    <span class="o">||</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">oss_sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uoss</span><span class="o">-&gt;</span><span class="n">ss_sp</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">oss_os</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uoss</span><span class="o">-&gt;</span><span class="n">ss_onstack</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_sysinfo</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sysinfo_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">sysname</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">nodename</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
		<span class="n">utsname</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">machine</span><span class="p">,</span>
		<span class="s">&quot;alpha&quot;</span><span class="p">,</span>	<span class="cm">/* instruction set architecture */</span>
		<span class="s">&quot;dummy&quot;</span><span class="p">,</span>	<span class="cm">/* hardware serial number */</span>
		<span class="s">&quot;dummy&quot;</span><span class="p">,</span>	<span class="cm">/* hardware manufacturer */</span>
		<span class="s">&quot;dummy&quot;</span><span class="p">,</span>	<span class="cm">/* secure RPC domain */</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">command</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sysinfo_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Digital UNIX has a few unpublished interfaces here */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sysinfo(%d)&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">sysinfo_table</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uts_sem</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">osf_getsysinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">percpu_struct</span> <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GSI_IEEE_FP_CONTROL</span>:
		<span class="cm">/* Return current software fp control &amp; status bits.  */</span>
		<span class="cm">/* Note that DU doesn&#39;t verify available space here.  */</span>

 		<span class="n">w</span> <span class="o">=</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ieee_state</span> <span class="o">&amp;</span> <span class="n">IEEE_SW_MASK</span><span class="p">;</span>
 		<span class="n">w</span> <span class="o">=</span> <span class="n">swcr_update_status</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rdfpcr</span><span class="p">());</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GSI_IEEE_STATE_AT_SIGNAL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Not sure anybody will ever use this weird stuff.  These</span>
<span class="cm">		 * ops can be used (under OSF/1) to set the fpcr that should</span>
<span class="cm">		 * be used when a signal handler starts executing.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

 	<span class="k">case</span> <span class="n">GSI_UACPROC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&gt;&gt;</span> <span class="n">ALPHA_UAC_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">UAC_BITMASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GSI_PROC_TYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">percpu_struct</span><span class="o">*</span><span class="p">)</span>
		  <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">hwrpb</span> <span class="o">+</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">processor_offset</span><span class="p">);</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">cpu</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">__user</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GSI_GET_HWRPB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hwrpb</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">hwrpb</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">osf_setsysinfo</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SSI_IEEE_FP_CONTROL</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">swcr</span><span class="p">,</span> <span class="n">fpcr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

		<span class="cm">/* </span>
<span class="cm">		 * Alpha Architecture Handbook 4.7.7.3:</span>
<span class="cm">		 * To be fully IEEE compiant, we must track the current IEEE</span>
<span class="cm">		 * exception state in software, because spurious bits can be</span>
<span class="cm">		 * set in the trap shadow of a software-complete insn.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">swcr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ieee_state</span><span class="p">;</span>

		<span class="cm">/* Update softare trap enable bits.  */</span>
		<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IEEE_SW_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">swcr</span> <span class="o">&amp;</span> <span class="n">IEEE_SW_MASK</span><span class="p">);</span>

		<span class="cm">/* Update the real fpcr.  */</span>
		<span class="n">fpcr</span> <span class="o">=</span> <span class="n">rdfpcr</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">FPCR_DYN_MASK</span><span class="p">;</span>
		<span class="n">fpcr</span> <span class="o">|=</span> <span class="n">ieee_swcr_to_fpcr</span><span class="p">(</span><span class="n">swcr</span><span class="p">);</span>
		<span class="n">wrfpcr</span><span class="p">(</span><span class="n">fpcr</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SSI_IEEE_RAISE_EXCEPTION</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">exc</span><span class="p">,</span> <span class="n">swcr</span><span class="p">,</span> <span class="n">fpcr</span><span class="p">,</span> <span class="n">fex</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ieee_state</span><span class="p">;</span>
		<span class="n">exc</span> <span class="o">&amp;=</span> <span class="n">IEEE_STATUS_MASK</span><span class="p">;</span>

		<span class="cm">/* Update softare trap enable bits.  */</span>
 		<span class="n">swcr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IEEE_SW_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">exc</span><span class="p">;</span>
		<span class="o">*</span><span class="n">state</span> <span class="o">|=</span> <span class="n">exc</span><span class="p">;</span>

		<span class="cm">/* Update the real fpcr.  */</span>
		<span class="n">fpcr</span> <span class="o">=</span> <span class="n">rdfpcr</span><span class="p">();</span>
		<span class="n">fpcr</span> <span class="o">|=</span> <span class="n">ieee_swcr_to_fpcr</span><span class="p">(</span><span class="n">swcr</span><span class="p">);</span>
		<span class="n">wrfpcr</span><span class="p">(</span><span class="n">fpcr</span><span class="p">);</span>

 		<span class="cm">/* If any exceptions set by this call, and are unmasked,</span>
<span class="cm">		   send a signal.  Old exceptions are not signaled.  */</span>
		<span class="n">fex</span> <span class="o">=</span> <span class="p">(</span><span class="n">exc</span> <span class="o">&gt;&gt;</span> <span class="n">IEEE_STATUS_TO_EXCSUM_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">swcr</span><span class="p">;</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">fex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">si_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_DNO</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_INE</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_UNF</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_OVF</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_DZE</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fex</span> <span class="o">&amp;</span> <span class="n">IEEE_TRAP_ENABLE_INV</span><span class="p">)</span> <span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>

			<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">si_code</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  <span class="cm">/* FIXME */</span>
 			<span class="n">send_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
 		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SSI_IEEE_STATE_AT_SIGNAL</span>:
	<span class="k">case</span> <span class="n">SSI_IEEE_IGNORE_STATE_AT_SIGNAL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Not sure anybody will ever use this weird stuff.  These</span>
<span class="cm">		 * ops can be used (under OSF/1) to set the fpcr that should</span>
<span class="cm">		 * be used when a signal handler starts executing.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

 	<span class="k">case</span> <span class="n">SSI_NVPAIRS</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
		
 		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

 			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
 				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">))</span>
 				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
 			<span class="k">switch</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
 			<span class="k">case</span> <span class="n">SSIN_UACPROC</span>:
			<span class="nl">again:</span>
				<span class="n">old</span> <span class="o">=</span> <span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
				<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">UAC_BITMASK</span> <span class="o">&lt;&lt;</span> <span class="n">ALPHA_UAC_SHIFT</span><span class="p">);</span>
				<span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">|</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">UAC_BITMASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ALPHA_UAC_SHIFT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
					    <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
 				<span class="k">break</span><span class="p">;</span>
 
 			<span class="nl">default:</span>
 				<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
 			<span class="p">}</span>
 		<span class="p">}</span>
 		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
 
	<span class="k">case</span> <span class="n">SSI_LMF</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Translations due to the fact that OSF&#39;s time_t is an int.  Which</span>
<span class="cm">   affects all sorts of things, like timeval and itimerval.  */</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="n">sys_tz</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">timeval32</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">tv_sec</span><span class="p">,</span> <span class="n">tv_usec</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">itimerval32</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">it_interval</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">it_value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">get_tv32</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">put_tv32</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">o</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">get_it32</span><span class="p">(</span><span class="k">struct</span> <span class="n">itimerval</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="k">struct</span> <span class="n">itimerval32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__get_user</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">put_it32</span><span class="p">(</span><span class="k">struct</span> <span class="n">itimerval32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="k">struct</span> <span class="n">itimerval</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">o</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_interval</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">|</span>
		 <span class="n">__put_user</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">it_value</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">jiffies_to_timeval32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jiffies</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">value</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">%</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1000000L</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">value</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_gettimeofday</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timezone</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ktv</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_tv32</span><span class="p">(</span><span class="n">tv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ktv</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">tz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_tz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sys_tz</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_settimeofday</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timezone</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">kts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timezone</span> <span class="n">ktz</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_tv32</span><span class="p">((</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kts</span><span class="p">,</span> <span class="n">tv</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktz</span><span class="p">,</span> <span class="n">tz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tz</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kts</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">do_sys_settimeofday</span><span class="p">(</span><span class="n">tv</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">kts</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tz</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ktz</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_getitimer</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="k">struct</span> <span class="n">itimerval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">itimerval</span> <span class="n">kit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_getitimer</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">put_it32</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kit</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_setitimer</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="k">struct</span> <span class="n">itimerval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">itimerval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">itimerval</span> <span class="n">kin</span><span class="p">,</span> <span class="n">kout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_it32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="n">in</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kin</span><span class="p">));</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">do_setitimer</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kin</span><span class="p">,</span> <span class="n">out</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">kout</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">||</span> <span class="o">!</span><span class="n">out</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_it32</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kout</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_utimes</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tvs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">tv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tvs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_tv32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktvs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tvs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span>
		    <span class="n">get_tv32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ktvs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">tvs</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ktvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_usec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="mi">1000000</span> <span class="o">||</span>
		    <span class="n">ktvs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_usec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="mi">1000000</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">tv</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tv_usec</span><span class="p">;</span>
		<span class="n">tv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">tv</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ktvs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">tv_usec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">do_utimes</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">tvs</span> <span class="o">?</span> <span class="n">tv</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE5</span><span class="p">(</span><span class="n">osf_select</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fd_set</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">fd_set</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">outp</span><span class="p">,</span>
		<span class="n">fd_set</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">tvp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">end_time</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">time_t</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>

		<span class="n">to</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">end_time</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">tvp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tvp</span><span class="p">))</span>
		    <span class="o">||</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="p">))</span> <span class="p">{</span>
		    	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">usec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">poll_select_set_timeout</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span> <span class="o">*</span> <span class="n">NSEC_PER_USEC</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		

	<span class="p">}</span>

	<span class="cm">/* OSF does not copy back the remaining time.  */</span>
	<span class="k">return</span> <span class="n">core_sys_select</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">outp</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">rusage32</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval32</span> <span class="n">ru_utime</span><span class="p">;</span>	<span class="cm">/* user time used */</span>
	<span class="k">struct</span> <span class="n">timeval32</span> <span class="n">ru_stime</span><span class="p">;</span>	<span class="cm">/* system time used */</span>
	<span class="kt">long</span>	<span class="n">ru_maxrss</span><span class="p">;</span>		<span class="cm">/* maximum resident set size */</span>
	<span class="kt">long</span>	<span class="n">ru_ixrss</span><span class="p">;</span>		<span class="cm">/* integral shared memory size */</span>
	<span class="kt">long</span>	<span class="n">ru_idrss</span><span class="p">;</span>		<span class="cm">/* integral unshared data size */</span>
	<span class="kt">long</span>	<span class="n">ru_isrss</span><span class="p">;</span>		<span class="cm">/* integral unshared stack size */</span>
	<span class="kt">long</span>	<span class="n">ru_minflt</span><span class="p">;</span>		<span class="cm">/* page reclaims */</span>
	<span class="kt">long</span>	<span class="n">ru_majflt</span><span class="p">;</span>		<span class="cm">/* page faults */</span>
	<span class="kt">long</span>	<span class="n">ru_nswap</span><span class="p">;</span>		<span class="cm">/* swaps */</span>
	<span class="kt">long</span>	<span class="n">ru_inblock</span><span class="p">;</span>		<span class="cm">/* block input operations */</span>
	<span class="kt">long</span>	<span class="n">ru_oublock</span><span class="p">;</span>		<span class="cm">/* block output operations */</span>
	<span class="kt">long</span>	<span class="n">ru_msgsnd</span><span class="p">;</span>		<span class="cm">/* messages sent */</span>
	<span class="kt">long</span>	<span class="n">ru_msgrcv</span><span class="p">;</span>		<span class="cm">/* messages received */</span>
	<span class="kt">long</span>	<span class="n">ru_nsignals</span><span class="p">;</span>		<span class="cm">/* signals received */</span>
	<span class="kt">long</span>	<span class="n">ru_nvcsw</span><span class="p">;</span>		<span class="cm">/* voluntary context switches */</span>
	<span class="kt">long</span>	<span class="n">ru_nivcsw</span><span class="p">;</span>		<span class="cm">/* involuntary &quot; */</span>
<span class="p">};</span>

<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_getrusage</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">who</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rusage32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">ru</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rusage32</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">who</span> <span class="o">!=</span> <span class="n">RUSAGE_SELF</span> <span class="o">&amp;&amp;</span> <span class="n">who</span> <span class="o">!=</span> <span class="n">RUSAGE_CHILDREN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">who</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RUSAGE_SELF</span>:
		<span class="n">jiffies_to_timeval32</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">);</span>
		<span class="n">jiffies_to_timeval32</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">stime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">);</span>
		<span class="n">r</span><span class="p">.</span><span class="n">ru_minflt</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">min_flt</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">ru_majflt</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">maj_flt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RUSAGE_CHILDREN</span>:
		<span class="n">jiffies_to_timeval32</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">cutime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">);</span>
		<span class="n">jiffies_to_timeval32</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">cstime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">);</span>
		<span class="n">r</span><span class="p">.</span><span class="n">ru_minflt</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">cmin_flt</span><span class="p">;</span>
		<span class="n">r</span><span class="p">.</span><span class="n">ru_majflt</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">cmaj_flt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">osf_wait4</span><span class="p">,</span> <span class="n">pid_t</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">ustatus</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">rusage32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rusage</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ur</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sys_wait4</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">ustatus</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		
	<span class="n">set_fs</span> <span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sys_wait4</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">rusage</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">set_fs</span> <span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ur</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ur</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">ustatus</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_utime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_stime</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_maxrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_maxrss</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_ixrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_ixrss</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_idrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_idrss</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_isrss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_isrss</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_minflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_minflt</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_majflt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_majflt</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_nswap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_nswap</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_inblock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_inblock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_oublock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_oublock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_msgsnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_msgsnd</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_msgrcv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_msgrcv</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_nsignals</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_nsignals</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_nvcsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_nvcsw</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ru_nivcsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ur</span><span class="o">-&gt;</span><span class="n">ru_nivcsw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I don&#39;t know what the parameters are: the first one</span>
<span class="cm"> * seems to be a timeval pointer, and I suspect the second</span>
<span class="cm"> * one is the time remaining.. Ho humm.. No documentation.</span>
<span class="cm"> */</span>
<span class="n">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">osf_usleep_thread</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">timeval32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">remain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ticks</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_tv32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">sleep</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>

	<span class="n">ticks</span> <span class="o">=</span> <span class="n">timeval_to_jiffies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

	<span class="n">ticks</span> <span class="o">=</span> <span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">ticks</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jiffies_to_timeval</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_tv32</span><span class="p">(</span><span class="n">remain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fault:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">timex32</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modes</span><span class="p">;</span>	<span class="cm">/* mode selector */</span>
	<span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>		<span class="cm">/* time offset (usec) */</span>
	<span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>		<span class="cm">/* frequency offset (scaled ppm) */</span>
	<span class="kt">long</span> <span class="n">maxerror</span><span class="p">;</span>		<span class="cm">/* maximum error (usec) */</span>
	<span class="kt">long</span> <span class="n">esterror</span><span class="p">;</span>		<span class="cm">/* estimated error (usec) */</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>		<span class="cm">/* clock command/status */</span>
	<span class="kt">long</span> <span class="n">constant</span><span class="p">;</span>		<span class="cm">/* pll time constant */</span>
	<span class="kt">long</span> <span class="n">precision</span><span class="p">;</span>		<span class="cm">/* clock precision (usec) (read only) */</span>
	<span class="kt">long</span> <span class="n">tolerance</span><span class="p">;</span>		<span class="cm">/* clock frequency tolerance (ppm)</span>
<span class="cm">				 * (read only)</span>
<span class="cm">				 */</span>
	<span class="k">struct</span> <span class="n">timeval32</span> <span class="n">time</span><span class="p">;</span>	<span class="cm">/* (read only) */</span>
	<span class="kt">long</span> <span class="n">tick</span><span class="p">;</span>		<span class="cm">/* (modified) usecs between clock ticks */</span>

	<span class="kt">long</span> <span class="n">ppsfreq</span><span class="p">;</span>           <span class="cm">/* pps frequency (scaled ppm) (ro) */</span>
	<span class="kt">long</span> <span class="n">jitter</span><span class="p">;</span>            <span class="cm">/* pps jitter (us) (ro) */</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>              <span class="cm">/* interval duration (s) (shift) (ro) */</span>
	<span class="kt">long</span> <span class="n">stabil</span><span class="p">;</span>            <span class="cm">/* pps stability (scaled ppm) (ro) */</span>
	<span class="kt">long</span> <span class="n">jitcnt</span><span class="p">;</span>            <span class="cm">/* jitter limit exceeded (ro) */</span>
	<span class="kt">long</span> <span class="n">calcnt</span><span class="p">;</span>            <span class="cm">/* calibration intervals (ro) */</span>
	<span class="kt">long</span> <span class="n">errcnt</span><span class="p">;</span>            <span class="cm">/* calibration errors (ro) */</span>
	<span class="kt">long</span> <span class="n">stbcnt</span><span class="p">;</span>            <span class="cm">/* stability limit exceeded (ro) */</span>

	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span> <span class="kt">int</span>  <span class="o">:</span><span class="mi">32</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">SYSCALL_DEFINE1</span><span class="p">(</span><span class="n">old_adjtimex</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timex32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">txc_p</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">timex</span> <span class="n">txc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* copy relevant bits of struct timex. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">,</span> <span class="n">txc_p</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">.</span><span class="n">tick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc_p</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">)</span> <span class="o">-</span> 
			   <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">,</span> <span class="n">time</span><span class="p">)))</span>
	  <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">do_adjtimex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc</span><span class="p">);</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="cm">/* copy back to timex32 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">txc_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc_p</span><span class="o">-&gt;</span><span class="n">tick</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">.</span><span class="n">tick</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">)</span> <span class="o">-</span> 
			  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timex32</span><span class="p">,</span> <span class="n">tick</span><span class="p">)))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">put_tv32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txc_p</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txc</span><span class="p">.</span><span class="n">time</span><span class="p">)))</span>
	  <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get an address range which is currently unmapped.  Similar to the</span>
<span class="cm">   generic version except that we know how to honor ADDR_LIMIT_32BIT.  */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="n">arch_get_unmapped_area_1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span>
		         <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span> <span class="o">=</span> <span class="n">find_vma</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* At this point:  (!vma || addr &lt; vma-&gt;vm_end). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">addr</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vma</span> <span class="o">||</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">;</span>
		<span class="n">vma</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="n">arch_get_unmapped_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pgoff</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* &quot;32 bit&quot; actually means 31 bit, since pointers sign extend.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span> <span class="o">&amp;</span> <span class="n">ADDR_LIMIT_32BIT</span><span class="p">)</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">TASK_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_FIXED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* First, see if the given suggestion fits.</span>

<span class="cm">	   The OSF/1 loader (/sbin/loader) relies on us returning an</span>
<span class="cm">	   address larger than the requested if one exists, which is</span>
<span class="cm">	   a terribly broken way to program.</span>

<span class="cm">	   That said, I can see the use in being able to suggest not</span>
<span class="cm">	   merely specific addresses, but regions of memory -- perhaps</span>
<span class="cm">	   this feature should be incorporated into all ports?  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">arch_get_unmapped_area_1</span> <span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Next, try allocating at TASK_UNMAPPED_BASE.  */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">arch_get_unmapped_area_1</span> <span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">TASK_UNMAPPED_BASE</span><span class="p">),</span>
					 <span class="n">len</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Finally, try allocating in low memory.  */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">arch_get_unmapped_area_1</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OSF4_COMPAT</span>

<span class="cm">/* Clear top 32 bits of iov_len in the user&#39;s buffer for</span>
<span class="cm">   compatibility with old versions of OSF/1 where iov_len</span>
<span class="cm">   was defined as int. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="n">osf_fix_iov_len</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="n">__user</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">iov_len_high</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">iov</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iov_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iov_len_high</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_readv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">personality</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span><span class="p">)</span> <span class="o">==</span> <span class="n">PER_OSF4</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osf_fix_iov_len</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sys_readv</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">osf_writev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">personality</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">personality</span><span class="p">)</span> <span class="o">==</span> <span class="n">PER_OSF4</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">osf_fix_iov_len</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sys_writev</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
