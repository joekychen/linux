<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › core_cia.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core_cia.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/arch/alpha/kernel/core_cia.c</span>
<span class="cm"> *</span>
<span class="cm"> * Written by David A Rusling (david.rusling@reo.mts.dec.com).</span>
<span class="cm"> * December 1995.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1995  David A Rusling</span>
<span class="cm"> *	Copyright (C) 1997, 1998  Jay Estabrook</span>
<span class="cm"> *	Copyright (C) 1998, 1999, 2000  Richard Henderson</span>
<span class="cm"> *</span>
<span class="cm"> * Code common to all CIA core logic chips.</span>
<span class="cm"> */</span>

<span class="cp">#define __EXTERN_INLINE inline</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/core_cia.h&gt;</span>
<span class="cp">#undef __EXTERN_INLINE</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/mce.h&gt;</span>

<span class="cp">#include &quot;proto.h&quot;</span>
<span class="cp">#include &quot;pci_impl.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * NOTE: Herein lie back-to-back mb instructions.  They are magic. </span>
<span class="cm"> * One plausible explanation is that the i/o controller does not properly</span>
<span class="cm"> * handle the system transaction.  Another involves timing.  Ho hum.</span>
<span class="cm"> */</span>

<span class="cp">#define DEBUG_CONFIG 0</span>
<span class="cp">#if DEBUG_CONFIG</span>
<span class="cp"># define DBGC(args)	printk args</span>
<span class="cp">#else</span>
<span class="cp"># define DBGC(args)</span>
<span class="cp">#endif</span>

<span class="cp">#define vip	volatile int  *</span>

<span class="cm">/*</span>
<span class="cm"> * Given a bus, device, and function number, compute resulting</span>
<span class="cm"> * configuration space address.  It is therefore not safe to have</span>
<span class="cm"> * concurrent invocations to configuration space access routines, but</span>
<span class="cm"> * there really shouldn&#39;t be any need for this.</span>
<span class="cm"> *</span>
<span class="cm"> * Type 0:</span>
<span class="cm"> *</span>
<span class="cm"> *  3 3|3 3 2 2|2 2 2 2|2 2 2 2|1 1 1 1|1 1 1 1|1 1 </span>
<span class="cm"> *  3 2|1 0 9 8|7 6 5 4|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> * | | |D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|D|F|F|F|R|R|R|R|R|R|0|0|</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *</span>
<span class="cm"> *	31:11	Device select bit.</span>
<span class="cm"> * 	10:8	Function number</span>
<span class="cm"> * 	 7:2	Register number</span>
<span class="cm"> *</span>
<span class="cm"> * Type 1:</span>
<span class="cm"> *</span>
<span class="cm"> *  3 3|3 3 2 2|2 2 2 2|2 2 2 2|1 1 1 1|1 1 1 1|1 1 </span>
<span class="cm"> *  3 2|1 0 9 8|7 6 5 4|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> * | | | | | | | | | | |B|B|B|B|B|B|B|B|D|D|D|D|D|F|F|F|R|R|R|R|R|R|0|1|</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *</span>
<span class="cm"> *	31:24	reserved</span>
<span class="cm"> *	23:16	bus number (8 bits = 128 possible buses)</span>
<span class="cm"> *	15:11	Device number (5 bits)</span>
<span class="cm"> *	10:8	function number</span>
<span class="cm"> *	 7:2	register number</span>
<span class="cm"> *  </span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	The function number selects which function of a multi-function device </span>
<span class="cm"> *	(e.g., SCSI and Ethernet).</span>
<span class="cm"> * </span>
<span class="cm"> *	The register selects a DWORD (32 bit) register offset.  Hence it</span>
<span class="cm"> *	doesn&#39;t get shifted by 2 bits as we want to &quot;drop&quot; the bottom two</span>
<span class="cm"> *	bits.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mk_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_fn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pci_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">bus_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="o">*</span><span class="n">type1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pci_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">device_fn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">where</span><span class="p">;</span>

	<span class="n">DBGC</span><span class="p">((</span><span class="s">&quot;mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x,&quot;</span>
	      <span class="s">&quot; returning address 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="n">bus</span><span class="p">,</span> <span class="n">device_fn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">*</span><span class="n">pci_addr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">conf_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cia_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGC</span><span class="p">((</span><span class="s">&quot;conf_read(addr=0x%lx, type1=%d) &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type1</span><span class="p">));</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset status register to avoid losing errors.  */</span>
	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span> <span class="cm">/* re-read to force write */</span>

	<span class="cm">/* If Type1 access, must set CIA CFG. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cia_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">draina</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Access configuration space.  */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mb</span><span class="p">();</span>  <span class="cm">/* magic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* If Type1 access, must reset IOC CFG so normal IO space ops work.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span> <span class="o">=</span> <span class="n">cia_cfg</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DBGC</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">conf_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">cia_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBGC</span><span class="p">((</span><span class="s">&quot;conf_write(addr=0x%lx, type1=%d) &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">type1</span><span class="p">));</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset status register to avoid losing errors.  */</span>
	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span> <span class="cm">/* re-read to force write */</span>

	<span class="cm">/* If Type1 access, must set CIA CFG.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cia_cfg</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">draina</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Access configuration space.  */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span> <span class="cm">/* read back to force the write */</span>

	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* If Type1 access, must reset IOC CFG so normal IO space ops work.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span> <span class="o">=</span> <span class="n">cia_cfg</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DBGC</span><span class="p">((</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">cia_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pci_addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">CIA_CONF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">conf_read</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">type1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">shift</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">cia_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		 <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pci_addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">CIA_CONF</span><span class="p">;</span>
	<span class="n">conf_write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span> <span class="n">type1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">cia_pci_ops</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> 	<span class="n">cia_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">cia_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * CIA Pass 1 and PYXIS Pass 1 and 2 have a broken scatter-gather tlb.</span>
<span class="cm"> * It cannot be invalidated.  Rather than hard code the pass numbers,</span>
<span class="cm"> * actually try the tbia to see if it works.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">cia_pci_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_TBIA</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* Flush all locked and unlocked.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_TBIA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On PYXIS, even if the tbia works, we cannot use it. It effectively locks</span>
<span class="cm"> * the chip (as well as direct write to the tag registers) if there is a</span>
<span class="cm"> * SG DMA operation in progress. This is true at least for PYXIS rev. 1,</span>
<span class="cm"> * so always use the method below.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * This is the method NT and NetBSD use.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate mappings, and put the chip into DMA loopback mode to read a</span>
<span class="cm"> * garbage page.  This works by causing TLB misses, causing old entries to</span>
<span class="cm"> * be purged to make room for the new entries coming in for the garbage page.</span>
<span class="cm"> */</span>

<span class="cp">#define CIA_BROKEN_TBIA_BASE	0x30000000</span>
<span class="cp">#define CIA_BROKEN_TBIA_SIZE	1024</span>

<span class="cm">/* Always called with interrupts disabled */</span>
<span class="kt">void</span>
<span class="nf">cia_pci_tbi_try2</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span>
		 <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/* Put the chip into PCI loopback mode.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span> <span class="o">=</span> <span class="n">ctrl</span> <span class="o">|</span> <span class="n">CIA_CTRL_PCI_LOOP_EN</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Read from PCI dense memory space at TBI_ADDR, skipping 32k on</span>
<span class="cm">	   each read.  This forces SG TLB misses.  NetBSD claims that the</span>
<span class="cm">	   TLB entries are not quite LRU, meaning that we need to read more</span>
<span class="cm">	   times than there are actual tags.  The 2117x docs claim strict</span>
<span class="cm">	   round-robin.  Oh well, we&#39;ve come this far...  */</span>
	<span class="cm">/* Even better - as seen on the PYXIS rev 1 the TLB tags 0-3 can</span>
<span class="cm">	   be filled by the TLB misses *only once* after being invalidated</span>
<span class="cm">	   (by tbia or direct write). Next misses won&#39;t update them even</span>
<span class="cm">	   though the lock bits are cleared. Tags 4-7 are &quot;quite LRU&quot; though,</span>
<span class="cm">	   so use them and read at window 3 base exactly 4 times. Reading</span>
<span class="cm">	   more sometimes makes the chip crazy.  -ink */</span>

	<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">cia_ioremap</span><span class="p">(</span><span class="n">CIA_BROKEN_TBIA_BASE</span><span class="p">,</span> <span class="mi">32768</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mh">0x00000</span><span class="p">);</span>
	<span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mh">0x08000</span><span class="p">);</span>
	<span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mh">0x18000</span><span class="p">);</span>

	<span class="n">cia_iounmap</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">);</span>

	<span class="cm">/* Restore normal PCI operation.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cia_prepare_tbia_workaround</span><span class="p">(</span><span class="kt">int</span> <span class="n">window</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ppte</span><span class="p">,</span> <span class="n">pte</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Use minimal 1K map. */</span>
	<span class="n">ppte</span> <span class="o">=</span> <span class="n">__alloc_bootmem</span><span class="p">(</span><span class="n">CIA_BROKEN_TBIA_SIZE</span><span class="p">,</span> <span class="mi">32768</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ppte</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIA_BROKEN_TBIA_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ppte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_BASE</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">=</span> <span class="n">CIA_BROKEN_TBIA_BASE</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_MASK</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
	  <span class="o">=</span> <span class="p">(</span><span class="n">CIA_BROKEN_TBIA_SIZE</span><span class="o">*</span><span class="mi">1024</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Tn_BASE</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ppte</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">verify_tb_operation</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">page</span><span class="p">[</span><span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">]</span>
		<span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">)))</span>
		<span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">struct</span> <span class="n">pci_iommu_arena</span> <span class="o">*</span><span class="n">arena</span> <span class="o">=</span> <span class="n">pci_isa_hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">addr0</span><span class="p">,</span> <span class="n">tag0</span><span class="p">,</span> <span class="n">pte0</span><span class="p">,</span> <span class="n">data0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">use_tbia_try2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bus_addr</span><span class="p">;</span>

	<span class="cm">/* pyxis -- tbia is broken */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_isa_hose</span><span class="o">-&gt;</span><span class="n">dense_io_base</span><span class="p">)</span>
		<span class="n">use_tbia_try2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Put the chip into PCI loopback mode.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span> <span class="o">=</span> <span class="n">ctrl</span> <span class="o">|</span> <span class="n">CIA_CTRL_PCI_LOOP_EN</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Write a valid entry directly into the TLB registers.  */</span>

	<span class="n">addr0</span> <span class="o">=</span> <span class="n">arena</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>
	<span class="n">tag0</span> <span class="o">=</span> <span class="n">addr0</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pte0</span> <span class="o">=</span> <span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">tag0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TBn_PAGEm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">pte0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TBn_PAGEm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TBn_PAGEm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TBn_PAGEm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Get a usable bus address */</span>
	<span class="n">bus_addr</span> <span class="o">=</span> <span class="n">cia_ioremap</span><span class="p">(</span><span class="n">addr0</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* First, verify we can read back what we&#39;ve written.  If</span>
<span class="cm">	   this fails, we can&#39;t be sure of any of the other testing</span>
<span class="cm">	   we&#39;re going to do, so bail.  */</span>
	<span class="cm">/* ??? Actually, we could do the work with machine checks.</span>
<span class="cm">	   By passing this register update test, we pretty much</span>
<span class="cm">	   guarantee that cia_pci_tbi_try1 works.  If this test</span>
<span class="cm">	   fails, cia_pci_tbi_try2 might still work.  */</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">tag0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed tb register update test &quot;</span>
		       <span class="s">&quot;(tag0 %#x != %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">tag0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed tb register update test &quot;</span>
		       <span class="s">&quot;(tag1 %#x != 0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TBn_PAGEm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">pte0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed tb register update test &quot;</span>
		       <span class="s">&quot;(pte0 %#x != %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">pte0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: passed tb register update test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Second, verify we can actually do I/O through this entry.  */</span>

	<span class="n">data0</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
	<span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data0</span><span class="p">;</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed sg loopback i/o read test (mcheck)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">data0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed sg loopback i/o read test &quot;</span>
		       <span class="s">&quot;(%#x != %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">data0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: passed sg loopback i/o read test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Third, try to invalidate the TLB.  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">use_tbia_try2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cia_pci_tbi</span><span class="p">(</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">use_tbia_try2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed tbia test; workaround available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: passed tbia test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fourth, verify the TLB snoops the EV5&#39;s caches when</span>
<span class="cm">	   doing a tlb fill.  */</span>

	<span class="n">data0</span> <span class="o">=</span> <span class="mh">0x5adda15e</span><span class="p">;</span>
	<span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data0</span><span class="p">;</span>
	<span class="n">arena</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte0</span><span class="p">;</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed pte write cache snoop test (mcheck)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">data0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed pte write cache snoop test &quot;</span>
		       <span class="s">&quot;(%#x != %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">data0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: passed pte write cache snoop test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Fifth, verify that a previously invalid PTE entry gets</span>
<span class="cm">	   filled from the page table.  */</span>

	<span class="n">data0</span> <span class="o">=</span> <span class="mh">0xabcdef12</span><span class="p">;</span>
	<span class="n">page</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data0</span><span class="p">;</span>
	<span class="n">arena</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">pte0</span><span class="p">;</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed valid tag invalid pte reload test &quot;</span>
		       <span class="s">&quot;(mcheck; workaround available)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Work around this bug by aligning new allocations</span>
<span class="cm">		   on 4 page boundaries.  */</span>
		<span class="n">arena</span><span class="o">-&gt;</span><span class="n">align_entry</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">data0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: failed valid tag invalid pte reload test &quot;</span>
		       <span class="s">&quot;(%#x != %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">data0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: passed valid tag invalid pte reload test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Sixth, verify machine checks are working.  Test invalid</span>
<span class="cm">	   pte under the same valid tag as we used above.  */</span>

	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">cia_readl</span><span class="p">(</span><span class="n">bus_addr</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: %s pci machine check test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mcheck_taken</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;passed&quot;</span> <span class="o">:</span> <span class="s">&quot;failed&quot;</span><span class="p">);</span>

	<span class="cm">/* Clean up after the tests.  */</span>
	<span class="n">arena</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">arena</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_tbia_try2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alpha_mv</span><span class="p">.</span><span class="n">mv_pci_tbi</span> <span class="o">=</span> <span class="n">cia_pci_tbi_try2</span><span class="p">;</span>

		<span class="cm">/* Tags 0-3 must be disabled if we use this workaraund. */</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_TB_TAGn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: tbia workaround enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">alpha_mv</span><span class="p">.</span><span class="n">mv_pci_tbi</span><span class="p">(</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">hose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="cm">/* unmap the bus addr */</span>
	<span class="n">cia_iounmap</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">);</span>

	<span class="cm">/* Restore normal PCI operation.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: disabling sg translation window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W0_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W1_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pci_isa_hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">alpha_mv</span><span class="p">.</span><span class="n">mv_pci_tbi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(ALPHA_RESTORE_SRM_SETUP)</span>
<span class="cm">/* Save CIA configuration data as the console had it set up.  */</span>
<span class="k">struct</span> 
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hae_mem</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hae_io</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci_dac_offset</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cia_ctrl</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cia_cnfg</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">t_base</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">window</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">}</span> <span class="n">saved_config</span> <span class="n">__attribute</span><span class="p">((</span><span class="n">common</span><span class="p">));</span>

<span class="kt">void</span>
<span class="nf">cia_save_srm_settings</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_pyxis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Save some important registers. */</span>
	<span class="n">saved_config</span><span class="p">.</span><span class="n">err_mask</span>       <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_ERR_MASK</span><span class="p">;</span>
	<span class="n">saved_config</span><span class="p">.</span><span class="n">cia_ctrl</span>       <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">saved_config</span><span class="p">.</span><span class="n">hae_mem</span>        <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_MEM</span><span class="p">;</span>
	<span class="n">saved_config</span><span class="p">.</span><span class="n">hae_io</span>         <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_IO</span><span class="p">;</span>
	<span class="n">saved_config</span><span class="p">.</span><span class="n">pci_dac_offset</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W_DAC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pyxis</span><span class="p">)</span>
	    <span class="n">saved_config</span><span class="p">.</span><span class="n">cia_cnfg</span>   <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CNFG</span><span class="p">;</span>
	<span class="k">else</span>
	    <span class="n">saved_config</span><span class="p">.</span><span class="n">cia_cnfg</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Save DMA windows configuration. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_base</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	    <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_mask</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	    <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t_base</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Tn_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cia_restore_srm_settings</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_base</span><span class="p">;</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Wn_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">w_mask</span><span class="p">;</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_Tn_BASE</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_MEM</span>   <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">hae_mem</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_IO</span>    <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">hae_io</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W_DAC</span> <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">pci_dac_offset</span><span class="p">;</span>	
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_ERR_MASK</span>  <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">err_mask</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span>  <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">cia_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saved_config</span><span class="p">.</span><span class="n">cia_cnfg</span><span class="p">)</span> <span class="cm">/* Must be pyxis. */</span>
	    <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CNFG</span>  <span class="o">=</span> <span class="n">saved_config</span><span class="p">.</span><span class="n">cia_cnfg</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* ALPHA_RESTORE_SRM_SETUP */</span><span class="cp"></span>
<span class="cp">#define cia_save_srm_settings(p)	do {} while (0)</span>
<span class="cp">#define cia_restore_srm_settings()	do {} while (0)</span>
<span class="cp">#endif </span><span class="cm">/* ALPHA_RESTORE_SRM_SETUP */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">do_init_arch</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_pyxis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">cia_rev</span><span class="p">,</span> <span class="n">tbia_window</span><span class="p">;</span>

	<span class="n">cia_rev</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_REV</span> <span class="o">&amp;</span> <span class="n">CIA_REV_MASK</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pci: cia revision %d%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">cia_rev</span><span class="p">,</span> <span class="n">is_pyxis</span> <span class="o">?</span> <span class="s">&quot; (pyxis)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span><span class="p">)</span>
		<span class="n">cia_save_srm_settings</span><span class="p">(</span><span class="n">is_pyxis</span><span class="p">);</span>

	<span class="cm">/* Set up error reporting.  */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_ERR_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CIA_ERR_CPU_PE</span> <span class="o">|</span> <span class="n">CIA_ERR_MEM_NEM</span> <span class="o">|</span> <span class="n">CIA_ERR_PA_PTE_INV</span>
		  <span class="o">|</span> <span class="n">CIA_ERR_RCVD_MAS_ABT</span> <span class="o">|</span> <span class="n">CIA_ERR_RCVD_TAR_ABT</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_ERR_MASK</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Clear all currently pending errors.  */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Turn on mchecks.  */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">CIA_CTRL_FILL_ERR_EN</span> <span class="o">|</span> <span class="n">CIA_CTRL_MCHK_ERR_EN</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CTRL</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Clear the CFG register, which gets used for PCI config space</span>
<span class="cm">	   accesses.  That is the way we want to use it, and we do not</span>
<span class="cm">	   want to depend on what ARC or SRM might have left behind.  */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CFG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 
	<span class="cm">/* Zero the HAEs.  */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_MEM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_HAE_IO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For PYXIS, we always use BWX bus and i/o accesses.  To that end,</span>
<span class="cm">	   make sure they&#39;re enabled on the controller.  At the same time,</span>
<span class="cm">	   enable the monster window.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_pyxis</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CNFG</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">CIA_CNFG_IOA_BWEN</span> <span class="o">|</span> <span class="n">CIA_CNFG_PCI_MWEN</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_CNFG</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Synchronize with all previous changes.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_REV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create our single hose.</span>
<span class="cm">	 */</span>

	<span class="n">pci_isa_hose</span> <span class="o">=</span> <span class="n">hose</span> <span class="o">=</span> <span class="n">alloc_pci_controller</span><span class="p">();</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">is_pyxis</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">hae_mem</span> <span class="o">=</span> <span class="n">alloc_resource</span><span class="p">();</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span> <span class="o">=</span> <span class="n">hae_mem</span><span class="p">;</span>

		<span class="n">hae_mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hae_mem</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">CIA_MEM_R1_MASK</span><span class="p">;</span>
		<span class="n">hae_mem</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">pci_hae0_name</span><span class="p">;</span>
		<span class="n">hae_mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="n">hae_mem</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to request HAE_MEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_mem_base</span> <span class="o">=</span> <span class="n">CIA_SPARSE_MEM</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_mem_base</span> <span class="o">=</span> <span class="n">CIA_DENSE_MEM</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_io_base</span> <span class="o">=</span> <span class="n">CIA_IO</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_mem_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_mem_base</span> <span class="o">=</span> <span class="n">CIA_BW_MEM</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_io_base</span> <span class="o">=</span> <span class="n">CIA_BW_IO</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the PCI to main memory translation windows.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Window 0 is S/G 8MB at 8MB (for isa)</span>
<span class="cm">	 * Window 1 is S/G 1MB at 768MB (for tbia) (unused for CIA rev 1)</span>
<span class="cm">	 * Window 2 is direct access 2GB at 2GB</span>
<span class="cm">	 * Window 3 is DAC access 4GB at 8GB (or S/G for tbia if CIA rev 1)</span>
<span class="cm">	 *</span>
<span class="cm">	 * ??? NetBSD hints that page tables must be aligned to 32K,</span>
<span class="cm">	 * possibly due to a hardware bug.  This is over-aligned</span>
<span class="cm">	 * from the 8K alignment one would expect for an 8MB window. </span>
<span class="cm">	 * No description of what revisions affected.</span>
<span class="cm">	 */</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span> <span class="o">=</span> <span class="n">iommu_arena_new</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>

	<span class="n">__direct_map_base</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">__direct_map_size</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W0_BASE</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W0_MASK</span> <span class="o">=</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_T0_BASE</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W2_BASE</span> <span class="o">=</span> <span class="n">__direct_map_base</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W2_MASK</span> <span class="o">=</span> <span class="p">(</span><span class="n">__direct_map_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_T2_BASE</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* On PYXIS we have the monster window, selected by bit 40, so</span>
<span class="cm">	   there is no need for window3 to be enabled.</span>

<span class="cm">	   On CIA, we don&#39;t have true arbitrary addressing -- bits &lt;39:32&gt;</span>
<span class="cm">	   are compared against W_DAC.  We can, however, directly map 4GB,</span>
<span class="cm">	   which is better than before.  However, due to assumptions made</span>
<span class="cm">	   elsewhere, we should not claim that we support DAC unless that</span>
<span class="cm">	   4GB covers all of physical memory.</span>

<span class="cm">	   On CIA rev 1, apparently W1 and W2 can&#39;t be used for SG. </span>
<span class="cm">	   At least, there are reports that it doesn&#39;t work for Alcor. </span>
<span class="cm">	   In that case, we have no choice but to use W3 for the TBIA </span>
<span class="cm">	   workaround, which means we can&#39;t use DAC at all. */</span> 

	<span class="n">tbia_window</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_pyxis</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W3_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cia_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W1_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbia_window</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_low_pfn</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mh">0x100000000UL</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W3_BASE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W3_BASE</span> <span class="o">=</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W3_MASK</span> <span class="o">=</span> <span class="mh">0xfff00000</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_T3_BASE</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">alpha_mv</span><span class="p">.</span><span class="n">pci_dac_offset</span> <span class="o">=</span> <span class="mh">0x200000000UL</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W_DAC</span> <span class="o">=</span> <span class="n">alpha_mv</span><span class="p">.</span><span class="n">pci_dac_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare workaround for apparently broken tbia. */</span>
	<span class="n">cia_prepare_tbia_workaround</span><span class="p">(</span><span class="n">tbia_window</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">cia_init_arch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_init_arch</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">pyxis_init_arch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* On pyxis machines we can precisely calculate the</span>
<span class="cm">	   CPU clock frequency using pyxis real time counter.</span>
<span class="cm">	   It&#39;s especially useful for SX164 with broken RTC.</span>

<span class="cm">	   Both CPU and chipset are driven by the single 16.666M</span>
<span class="cm">	   or 16.667M crystal oscillator. PYXIS_RT_COUNT clock is</span>
<span class="cm">	   66.66 MHz. -ink */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cc0</span><span class="p">,</span> <span class="n">cc1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pyxis_cc</span><span class="p">;</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;rpcc %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">cc0</span><span class="p">));</span>
	<span class="n">pyxis_cc</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">PYXIS_RT_COUNT</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span> <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">PYXIS_RT_COUNT</span> <span class="o">-</span> <span class="n">pyxis_cc</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;rpcc %0&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">cc1</span><span class="p">));</span>
	<span class="n">cc1</span> <span class="o">-=</span> <span class="n">cc0</span><span class="p">;</span>
	<span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">cycle_freq</span> <span class="o">=</span> <span class="p">((</span><span class="n">cc1</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000000UL</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hwrpb_update_checksum</span><span class="p">(</span><span class="n">hwrpb</span><span class="p">);</span>

	<span class="n">do_init_arch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cia_kill_arch</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span><span class="p">)</span>
		<span class="n">cia_restore_srm_settings</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">cia_init_pci</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Must delay this from init_arch, as we need machine checks.  */</span>
	<span class="n">verify_tb_operation</span><span class="p">();</span>
	<span class="n">common_init_pci</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cia_pci_clr_err</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">jd</span><span class="p">;</span>

	<span class="n">jd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span> <span class="o">=</span> <span class="n">jd</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_CIA_ERR</span><span class="p">;</span>		<span class="cm">/* re-read to force write.  */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cia_decode_pci_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_CIA_sysdata_mcheck</span> <span class="o">*</span><span class="n">cia</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pci_cmd_desc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Interrupt Acknowledge&quot;</span><span class="p">,</span> <span class="s">&quot;Special Cycle&quot;</span><span class="p">,</span> <span class="s">&quot;I/O Read&quot;</span><span class="p">,</span>
		<span class="s">&quot;I/O Write&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0x4&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0x5&quot;</span><span class="p">,</span> <span class="s">&quot;Memory Read&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Write&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0x8&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0x9&quot;</span><span class="p">,</span>
		<span class="s">&quot;Configuration Read&quot;</span><span class="p">,</span> <span class="s">&quot;Configuration Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read Multiple&quot;</span><span class="p">,</span> <span class="s">&quot;Dual Address Cycle&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read Line&quot;</span><span class="p">,</span> <span class="s">&quot;Memory Write and Invalidate&quot;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CIA_ERR_COR_ERR</span>
			    <span class="o">|</span> <span class="n">CIA_ERR_UN_COR_ERR</span>
			    <span class="o">|</span> <span class="n">CIA_ERR_MEM_NEM</span>
			    <span class="o">|</span> <span class="n">CIA_ERR_PA_PTE_INV</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">window_desc</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;No window active&quot;</span><span class="p">,</span> <span class="s">&quot;Window 0 hit&quot;</span><span class="p">,</span> <span class="s">&quot;Window 1 hit&quot;</span><span class="p">,</span>
			<span class="s">&quot;Window 2 hit&quot;</span><span class="p">,</span> <span class="s">&quot;Window 3 hit&quot;</span><span class="p">,</span> <span class="s">&quot;Monster window hit&quot;</span>
		<span class="p">};</span>

		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">window</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lock</span><span class="p">,</span> <span class="n">dac</span><span class="p">;</span>
	
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">pci_cmd_desc</span><span class="p">[</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">];</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">window</span> <span class="o">=</span> <span class="n">window_desc</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W_DAC</span> <span class="o">&amp;</span> <span class="mh">0xFFUL</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA machine check: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  DMA command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI address: %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  %s, Lock: %d, DAC: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">window</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CIA_ERR_PERR</span>
				   <span class="o">|</span> <span class="n">CIA_ERR_PCI_ADDR_PE</span>
				   <span class="o">|</span> <span class="n">CIA_ERR_RCVD_MAS_ABT</span>
				   <span class="o">|</span> <span class="n">CIA_ERR_RCVD_TAR_ABT</span>
				   <span class="o">|</span> <span class="n">CIA_ERR_IOA_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">master_st_desc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Idle&quot;</span><span class="p">,</span> <span class="s">&quot;Drive bus&quot;</span><span class="p">,</span> <span class="s">&quot;Address step cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Address cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Data cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Last read data cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Last write data cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Read stop cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Write stop cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Read turnaround cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Write turnaround cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xB&quot;</span><span class="p">,</span>
			<span class="s">&quot;Reserved 0xC&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xD&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xE&quot;</span><span class="p">,</span>
			<span class="s">&quot;Unknown state&quot;</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">target_st_desc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;Idle&quot;</span><span class="p">,</span> <span class="s">&quot;Busy&quot;</span><span class="p">,</span> <span class="s">&quot;Read data cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Write data cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Read stop cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Write stop cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Read turnaround cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Write turnaround cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Read wait cycle&quot;</span><span class="p">,</span> <span class="s">&quot;Write wait cycle&quot;</span><span class="p">,</span>
			<span class="s">&quot;Reserved 0xA&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xB&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xC&quot;</span><span class="p">,</span>
			<span class="s">&quot;Reserved 0xD&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved 0xE&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown state&quot;</span>
		<span class="p">};</span>

		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dac</span><span class="p">;</span>

		<span class="n">master</span> <span class="o">=</span> <span class="n">master_st_desc</span><span class="p">[(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">target_st_desc</span><span class="p">[(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">pci_cmd_desc</span><span class="p">[(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
		<span class="n">dac</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">CIA_IOC_PCI_W_DAC</span> <span class="o">&amp;</span> <span class="mh">0xFFUL</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">|=</span> <span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA machine check: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Master state: %s, Target state: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">master</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI address: %#010lx, DAC: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">addr</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA machine check: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Unknown PCI error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI_ERR0 = %#08lx&quot;</span><span class="p">,</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err0</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI_ERR1 = %#08lx&quot;</span><span class="p">,</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  PCI_ERR2 = %#08lx&quot;</span><span class="p">,</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">pci_err2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cia_decode_mem_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_CIA_sysdata_mcheck</span> <span class="o">*</span><span class="n">cia</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_port_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_port_mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem_port_cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">seq_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">set_select</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* If this is a DMA command, also decode the PCI bits.  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA machine check: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">mem_port_addr</span> <span class="o">=</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err0</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">mem_port_addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&amp;</span> <span class="mh">0x83UL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">mem_port_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x06</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;WRITE BLOCK or WRITE BLOCK LOCK&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;READ MISS or READ MISS MODIFY&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mh">0x1C</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;BC VICTIM&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;READ MISS MODIFY&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x18</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;DMA READ or DMA READ MODIFY&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x12</span><span class="p">)</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;DMA WRITE&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mem_port_cmd</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;Idle&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;DMA READ or DMA WRITE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2</span>: <span class="k">case</span> <span class="mh">0x3</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;READ MISS (or READ MISS MODIFY) with victim&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span>: <span class="k">case</span> <span class="mh">0x5</span>: <span class="k">case</span> <span class="mh">0x6</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;READ MISS (or READ MISS MODIFY) with no victim&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x8</span>: <span class="k">case</span> <span class="mh">0x9</span>: <span class="k">case</span> <span class="mh">0xB</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;Refresh&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xC</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;Idle, waiting for DMA pending read&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xE</span>: <span class="k">case</span> <span class="mh">0xF</span>:
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;Idle, ras precharge&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">seq_state</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">mem_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 0 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 1 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 2 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 3 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 4 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 5 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 6 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 7 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 8 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set 9 selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0A</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set A selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0B</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set B selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0C</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set C selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0D</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set D selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0E</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set E selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0F</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Set F selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;No set selected&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1F</span>: <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Refresh cycle&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>   <span class="n">set_select</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Memory port command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem_port_cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Memory port address: %#010lx, mask: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">mem_port_addr</span><span class="p">,</span> <span class="n">mem_port_mask</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Memory sequencer state: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seq_state</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Memory set: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">set_select</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cia_decode_ecc_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_CIA_sysdata_mcheck</span> <span class="o">*</span><span class="n">cia</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">syn</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="n">cia_decode_mem_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="n">syn</span> <span class="o">=</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_syn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">syn</span> <span class="o">==</span> <span class="p">(</span><span class="n">syn</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">syn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">KERN_CRIT</span> <span class="s">&quot;  ECC syndrome %#x -- check bit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">syn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="k">const</span> <span class="n">data_bit</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0xCE</span><span class="p">,</span> <span class="mh">0xCB</span><span class="p">,</span> <span class="mh">0xD3</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">,</span>
			<span class="mh">0xD6</span><span class="p">,</span> <span class="mh">0xD9</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">,</span>
			<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span>
			<span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
			<span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
			<span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span>
			<span class="mh">0xE3</span><span class="p">,</span> <span class="mh">0xE5</span><span class="p">,</span> <span class="mh">0xE6</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">,</span>
			<span class="mh">0xEA</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">,</span> <span class="mh">0xF4</span><span class="p">,</span>
			<span class="mh">0x4F</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span>
			<span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span>
			<span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">,</span>
			<span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">,</span>
			<span class="mh">0x8F</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span>
			<span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">,</span> <span class="mh">0x9D</span><span class="p">,</span>
			<span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>
			<span class="mh">0x6B</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x75</span>
		<span class="p">};</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_bit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">syn</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">KERN_CRIT</span> <span class="s">&quot;  ECC syndrome %#x -- data bit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">KERN_CRIT</span> <span class="s">&quot;  ECC syndrome %#x -- unknown bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span> <span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">syn</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cia_decode_parity_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_CIA_sysdata_mcheck</span> <span class="o">*</span><span class="n">cia</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">cmd_desc</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;NOP&quot;</span><span class="p">,</span> <span class="s">&quot;LOCK&quot;</span><span class="p">,</span> <span class="s">&quot;FETCH&quot;</span><span class="p">,</span> <span class="s">&quot;FETCH_M&quot;</span><span class="p">,</span> <span class="s">&quot;MEMORY BARRIER&quot;</span><span class="p">,</span>
		<span class="s">&quot;SET DIRTY&quot;</span><span class="p">,</span> <span class="s">&quot;WRITE BLOCK&quot;</span><span class="p">,</span> <span class="s">&quot;WRITE BLOCK LOCK&quot;</span><span class="p">,</span>
		<span class="s">&quot;READ MISS0&quot;</span><span class="p">,</span> <span class="s">&quot;READ MISS1&quot;</span><span class="p">,</span> <span class="s">&quot;READ MISS MOD0&quot;</span><span class="p">,</span>
		<span class="s">&quot;READ MISS MOD1&quot;</span><span class="p">,</span> <span class="s">&quot;BCACHE VICTIM&quot;</span><span class="p">,</span> <span class="s">&quot;Spare&quot;</span><span class="p">,</span>
		<span class="s">&quot;READ MISS MOD STC0&quot;</span><span class="p">,</span> <span class="s">&quot;READ MISS MOD STC1&quot;</span>
	<span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">par</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">cia</span><span class="o">-&gt;</span><span class="n">cpu_err0</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cpu_err1</span> <span class="o">&amp;</span> <span class="mh">0x83UL</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_desc</span><span class="p">[(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cpu_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">];</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cpu_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
	<span class="n">par</span> <span class="o">=</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cpu_err1</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA machine check: System bus parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Command: %s, Parity bit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Address: %#010lx, Mask: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cia_decode_mchk</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">com</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_CIA_sysdata_mcheck</span> <span class="o">*</span><span class="n">cia</span><span class="p">;</span>

	<span class="n">com</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">la_ptr</span><span class="p">;</span>
	<span class="n">cia</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">la_ptr</span> <span class="o">+</span> <span class="n">com</span><span class="o">-&gt;</span><span class="n">sys_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alpha_verbose_mcheck</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ffs</span><span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* CIA_ERR_COR_ERR */</span>
		<span class="n">cia_decode_ecc_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;Corrected ECC error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* CIA_ERR_UN_COR_ERR */</span>
		<span class="n">cia_decode_ecc_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;Uncorrected ECC error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* CIA_ERR_CPU_PE */</span>
		<span class="n">cia_decode_parity_error</span><span class="p">(</span><span class="n">cia</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* CIA_ERR_MEM_NEM */</span>
		<span class="n">cia_decode_mem_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;Access to nonexistent memory&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* CIA_ERR_PCI_SERR */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI bus system error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* CIA_ERR_PERR */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI data parity error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* CIA_ERR_PCI_ADDR_PE */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI address parity error&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* CIA_ERR_RCVD_MAS_ABT */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI master abort&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* CIA_ERR_RCVD_TAR_ABT */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI target abort&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* CIA_ERR_PA_PTE_INV */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;PCI invalid PTE&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* CIA_ERR_FROM_WRT_ERR */</span>
		<span class="n">cia_decode_mem_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;Write to flash ROM attempted&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* CIA_ERR_IOA_TIMEOUT */</span>
		<span class="n">cia_decode_pci_error</span><span class="p">(</span><span class="n">cia</span><span class="p">,</span> <span class="s">&quot;I/O timeout&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_CORR_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;Correctable ECC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_UN_CORR_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;Uncorrectable ECC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_CPU_PE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;System bus parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_MEM_NEM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;Access to nonexistent memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_PERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;PCI data parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_PCI_ADDR_PE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;PCI address parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_RCVD_MAS_ABT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;PCI master abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_RCVD_TAR_ABT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;PCI target abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_PA_PTE_INV</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;PCI invalid PTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_FROM_WRT_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;Write to flash ROM attempted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cia</span><span class="o">-&gt;</span><span class="n">cia_err</span> <span class="o">&amp;</span> <span class="n">CIA_ERR_LOST_IOA_TIMEOUT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;CIA lost machine check: &quot;</span>
		       <span class="s">&quot;I/O timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cia_machine_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">expected</span><span class="p">;</span>

	<span class="cm">/* Clear the error before any reporting.  */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">mb</span><span class="p">();</span>  <span class="cm">/* magic */</span>
	<span class="n">draina</span><span class="p">();</span>
	<span class="n">cia_pci_clr_err</span><span class="p">();</span>
	<span class="n">wrmces</span><span class="p">(</span><span class="n">rdmces</span><span class="p">());</span>	<span class="cm">/* reset machine check pending flag.  */</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">expected</span> <span class="o">=</span> <span class="n">mcheck_expected</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">expected</span> <span class="o">&amp;&amp;</span> <span class="n">vector</span> <span class="o">==</span> <span class="mh">0x660</span><span class="p">)</span>
		<span class="n">expected</span> <span class="o">=</span> <span class="n">cia_decode_mchk</span><span class="p">(</span><span class="n">la_ptr</span><span class="p">);</span>
	<span class="n">process_mcheck_info</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">la_ptr</span><span class="p">,</span> <span class="s">&quot;CIA&quot;</span><span class="p">,</span> <span class="n">expected</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
