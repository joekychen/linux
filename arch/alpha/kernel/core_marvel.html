<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › core_marvel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core_marvel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/arch/alpha/kernel/core_marvel.c</span>
<span class="cm"> *</span>
<span class="cm"> * Code common to all Marvel based systems.</span>
<span class="cm"> */</span>

<span class="cp">#define __EXTERN_INLINE inline</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/core_marvel.h&gt;</span>
<span class="cp">#undef __EXTERN_INLINE</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/gct.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/tlbflush.h&gt;</span>
<span class="cp">#include &lt;asm/rtc.h&gt;</span>
<span class="cp">#include &lt;asm/vga.h&gt;</span>

<span class="cp">#include &quot;proto.h&quot;</span>
<span class="cp">#include &quot;pci_impl.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * Debug helpers</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUG_CONFIG 0</span>

<span class="cp">#if DEBUG_CONFIG</span>
<span class="cp"># define DBG_CFG(args) printk args</span>
<span class="cp">#else</span>
<span class="cp"># define DBG_CFG(args)</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Private data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Helper functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">))</span>
<span class="n">read_ev7_csr</span><span class="p">(</span><span class="kt">int</span> <span class="n">pe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ev7_csr</span> <span class="o">*</span><span class="n">ev7csr</span> <span class="o">=</span> <span class="n">EV7_CSR_KERN</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q</span><span class="p">;</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">ev7csr</span><span class="o">-&gt;</span><span class="n">csr</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">))</span>
<span class="n">write_ev7_csr</span><span class="p">(</span><span class="kt">int</span> <span class="n">pe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ev7_csr</span> <span class="o">*</span><span class="n">ev7csr</span> <span class="o">=</span> <span class="n">EV7_CSR_KERN</span><span class="p">(</span><span class="n">pe</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">mb</span><span class="p">();</span>
	<span class="n">ev7csr</span><span class="o">-&gt;</span><span class="n">csr</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">mk_resource_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">pe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	
	<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;PCI %s PE %d PORT %d&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">alloc_bootmem</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span>
<span class="nf">marvel_next_io7</span><span class="p">(</span><span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">prev</span> <span class="o">?</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">:</span> <span class="n">io7_head</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span>
<span class="nf">marvel_find_io7</span><span class="p">(</span><span class="kt">int</span> <span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">io7</span> <span class="o">=</span> <span class="n">io7_head</span><span class="p">;</span> <span class="n">io7</span> <span class="o">&amp;&amp;</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span> <span class="o">!=</span> <span class="n">pe</span><span class="p">;</span> <span class="n">io7</span> <span class="o">=</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">io7</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">alloc_io7</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">insp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">marvel_find_io7</span><span class="p">(</span><span class="n">pe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;IO7 at PE %d already allocated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">io7</span> <span class="o">=</span> <span class="n">alloc_bootmem</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">io7</span><span class="p">));</span>
	<span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span> <span class="o">=</span> <span class="n">pe</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">h</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">h</span><span class="p">].</span><span class="n">io7</span> <span class="o">=</span> <span class="n">io7</span><span class="p">;</span>
		<span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">h</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
		<span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">h</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* default to disabled */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Insert in pe sorted order.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">io7_head</span><span class="p">)</span>			<span class="cm">/* empty list */</span>
		<span class="n">io7_head</span> <span class="o">=</span> <span class="n">io7</span><span class="p">;</span>	
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io7_head</span><span class="o">-&gt;</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* insert at head */</span>
		<span class="n">io7</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">io7_head</span><span class="p">;</span>
		<span class="n">io7_head</span> <span class="o">=</span> <span class="n">io7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* insert at position */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">insp</span> <span class="o">=</span> <span class="n">io7_head</span><span class="p">;</span> <span class="n">insp</span><span class="p">;</span> <span class="n">insp</span> <span class="o">=</span> <span class="n">insp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">insp</span><span class="o">-&gt;</span><span class="n">pe</span> <span class="o">==</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Too many IO7s at PE %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				       <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">insp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">||</span> 
			    <span class="n">insp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">pe</span> <span class="o">&gt;</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* insert here */</span>
				<span class="n">io7</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">insp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">insp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">io7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">insp</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* couldn&#39;t insert ?!? */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Failed to insert IO7 at PE %d &quot;</span>
			       <span class="s">&quot; - adding at head of list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">);</span>
			<span class="n">io7</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">io7_head</span><span class="p">;</span>
			<span class="n">io7_head</span> <span class="o">=</span> <span class="n">io7</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="n">io7</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">io7_clear_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">io7_port7_csrs</span> <span class="o">*</span><span class="n">p7csrs</span><span class="p">;</span>
	<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * First the IO ports.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csrs</span> <span class="o">=</span> <span class="n">IO7_CSRS_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

		<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_ERR_SUM</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
		<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TLB_ERR</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
		<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_SPL_COMPLT</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
		<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TRANS_SUM</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Then the common ones.</span>
<span class="cm">	 */</span>
	<span class="n">p7csrs</span> <span class="o">=</span> <span class="n">IO7_PORT7_CSRS_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">);</span>

	<span class="n">p7csrs</span><span class="o">-&gt;</span><span class="n">PO7_ERROR_SUM</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="n">p7csrs</span><span class="o">-&gt;</span><span class="n">PO7_UNCRR_SYM</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
	<span class="n">p7csrs</span><span class="o">-&gt;</span><span class="n">PO7_CRRCT_SYM</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1UL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * IO7 PCI, PCI/X, AGP configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">io7_init_hose</span><span class="p">(</span><span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">hose_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">alloc_pci_controller</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="n">io7_port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">];</span>
	<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span> <span class="o">=</span> <span class="n">IO7_CSRS_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hose_index</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* arbitrary */</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t have an isa or legacy hose, but glibc expects to be</span>
<span class="cm">	 * able to use the bus == 0 / dev == 0 form of the iobase syscall</span>
<span class="cm">	 * to determine information about the i/o system. Since XFree86 </span>
<span class="cm">	 * relies on glibc&#39;s determination to tell whether or not to use</span>
<span class="cm">	 * sparse access, we need to point the pci_isa_hose at a real hose</span>
<span class="cm">	 * so at least that determination is correct.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_isa_hose</span> <span class="o">=</span> <span class="n">hose</span><span class="p">;</span>

	<span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">csrs</span> <span class="o">=</span> <span class="n">csrs</span><span class="p">;</span>
	<span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span> <span class="o">=</span> <span class="n">io7_port</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span> <span class="o">=</span> <span class="n">alloc_resource</span><span class="p">();</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span> <span class="o">=</span> <span class="n">alloc_resource</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Base addresses for userland consumption. Since these are going</span>
<span class="cm">	 * to be mapped, they are pure physical addresses.</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_mem_base</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_mem_base</span> <span class="o">=</span> <span class="n">IO7_MEM_PHYS</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_io_base</span> <span class="o">=</span> <span class="n">IO7_IO_PHYS</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Base addresses and resource ranges for kernel consumption.</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">config_space_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">IO7_CONF_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">IO7_IO_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">IO7_IO_SPACE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">mk_resource_name</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s">&quot;IO&quot;</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">IO7_MEM_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">IO7_MEM_SPACE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">mk_resource_name</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="s">&quot;MEM&quot;</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to request IO on hose %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to request MEM on hose %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save the existing DMA window settings for later restoration.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">saved_wbase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WBASE</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">csr</span><span class="p">;</span>
		<span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">saved_wmask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WMASK</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">csr</span><span class="p">;</span>
		<span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">saved_tbase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TBASE</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">csr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the PCI to main memory translation windows.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Window 0 is scatter-gather 8MB at 8MB</span>
<span class="cm">	 * Window 1 is direct access 1GB at 2GB</span>
<span class="cm">	 * Window 2 is scatter-gather (up-to) 1GB at 3GB</span>
<span class="cm">	 * Window 3 is disabled</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * TBIA before modifying windows.</span>
<span class="cm">	 */</span>
	<span class="n">marvel_pci_tbi</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up window 0 for scatter-gather 8MB at 8MB.</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span> <span class="o">=</span> <span class="n">iommu_arena_new_node</span><span class="p">(</span><span class="n">marvel_cpuid_to_nid</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">),</span>
					    <span class="n">hose</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">align_entry</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* cache line boundary */</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WBASE</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> 
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">|</span> <span class="n">wbase_m_ena</span> <span class="o">|</span> <span class="n">wbase_m_sg</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WMASK</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">wbase_m_addr</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TBASE</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up window 1 for direct-mapped 1GB at 2GB.</span>
<span class="cm">	 */</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WBASE</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="n">__direct_map_base</span> <span class="o">|</span> <span class="n">wbase_m_ena</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WMASK</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__direct_map_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">wbase_m_addr</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TBASE</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up window 2 for scatter-gather (up-to) 1GB at 3GB.</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span> <span class="o">=</span> <span class="n">iommu_arena_new_node</span><span class="p">(</span><span class="n">marvel_cpuid_to_nid</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">),</span>
					    <span class="n">hose</span><span class="p">,</span> <span class="mh">0xc0000000</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">align_entry</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* cache line boundary */</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WBASE</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> 
		<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">|</span> <span class="n">wbase_m_ena</span> <span class="o">|</span> <span class="n">wbase_m_sg</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WMASK</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">wbase_m_addr</span><span class="p">;</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_TBASE</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable window 3.</span>
<span class="cm">	 */</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_WBASE</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that the AGP Monster Window is disabled.</span>
<span class="cm">	 */</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_CTRL</span><span class="p">.</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">61</span><span class="p">);</span>

<span class="cp">#if 1</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FIXME: disabling master aborts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_MSK_HEI</span><span class="p">.</span><span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3UL</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * TBIA after modifying windows.</span>
<span class="cm">	 */</span>
	<span class="n">marvel_pci_tbi</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">marvel_init_io7</span><span class="p">(</span><span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Initializing IO7 at PID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the Port 7 CSR pointer.</span>
<span class="cm">	 */</span>
	<span class="n">io7</span><span class="o">-&gt;</span><span class="n">csrs</span> <span class="o">=</span> <span class="n">IO7_PORT7_CSRS_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init this IO7&#39;s hoses.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IO7_NUM_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span> <span class="o">=</span> <span class="n">IO7_CSRS_KERN</span><span class="p">(</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">pe</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_CACHE_CTL</span><span class="p">.</span><span class="n">csr</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">io7_init_hose</span><span class="p">(</span><span class="n">io7</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">marvel_io7_present</span><span class="p">(</span><span class="n">gct6_node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">GCT_TYPE_HOSE</span> <span class="o">||</span>
	    <span class="n">node</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">!=</span> <span class="n">GCT_SUBTYPE_IO_PORT_MODULE</span><span class="p">)</span> 
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Found an IO7 at PID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>

	<span class="n">alloc_io7</span><span class="p">(</span><span class="n">pe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">marvel_find_console_vga_hose</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">pu64</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">hwrpb</span> <span class="o">+</span> <span class="n">hwrpb</span><span class="o">-&gt;</span><span class="n">ctbt_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pu64</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TERM_TYPE == graphics */</span>
		<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">pu64</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* TERM_OUT_LOC, hose # */</span>
		<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pid</span><span class="p">,</span> <span class="n">port</span><span class="p">;</span>

		<span class="cm">/* FIXME - encoding is going to have to change for Marvel</span>
<span class="cm">		 *         since hose will be able to overflow a byte...</span>
<span class="cm">		 *         need to fix this decode when the console </span>
<span class="cm">		 *         changes its encoding</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;console graphics is on hose %d (console)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The console&#39;s hose numbering is:</span>
<span class="cm">		 *</span>
<span class="cm">		 *	hose&lt;n:2&gt;: PID</span>
<span class="cm">		 *	hose&lt;1:0&gt;: PORT</span>
<span class="cm">		 *</span>
<span class="cm">		 * We need to find the hose at that pid and port</span>
<span class="cm">		 */</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">port</span> <span class="o">=</span> <span class="n">h</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">io7</span> <span class="o">=</span> <span class="n">marvel_find_io7</span><span class="p">(</span><span class="n">pid</span><span class="p">)))</span>
			<span class="n">hose</span> <span class="o">=</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">hose</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Console graphics on hose %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">pci_vga_hose</span> <span class="o">=</span> <span class="n">hose</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">gct6_search_struct</span> <span class="n">gct_wanted_node_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">GCT_TYPE_HOSE</span><span class="p">,</span> <span class="n">GCT_SUBTYPE_IO_PORT_MODULE</span><span class="p">,</span> <span class="n">marvel_io7_present</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * In case the GCT is not complete, let the user specify PIDs with IO7s</span>
<span class="cm"> * at boot time. Syntax is &#39;io7=a,b,c,...,n&#39; where a-n are the PIDs (decimal)</span>
<span class="cm"> * where IO7s are connected</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">marvel_specify_io7</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pchar</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pchar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pchar</span> <span class="o">!=</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;User-specified IO7 at PID %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
			<span class="n">io7</span> <span class="o">=</span> <span class="n">alloc_io7</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">io7</span><span class="p">)</span> <span class="n">marvel_init_io7</span><span class="p">(</span><span class="n">io7</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pchar</span> <span class="o">==</span> <span class="n">str</span><span class="p">)</span> <span class="n">pchar</span><span class="o">++</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">pchar</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;io7=&quot;</span><span class="p">,</span> <span class="n">marvel_specify_io7</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">marvel_init_arch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>

	<span class="cm">/* With multiple PCI busses, we play with I/O as physical addrs.  */</span>
	<span class="n">ioport_resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span><span class="p">;</span>

	<span class="cm">/* PCI DMA Direct Mapping is 1GB at 2GB.  */</span>
	<span class="n">__direct_map_base</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="n">__direct_map_size</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">;</span>

	<span class="cm">/* Parse the config tree.  */</span>
	<span class="n">gct6_find_nodes</span><span class="p">(</span><span class="n">GCT_NODE_PTR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">gct_wanted_node_list</span><span class="p">);</span>

	<span class="cm">/* Init the io7s.  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">io7</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="nb">NULL</span> <span class="o">!=</span> <span class="p">(</span><span class="n">io7</span> <span class="o">=</span> <span class="n">marvel_next_io7</span><span class="p">(</span><span class="n">io7</span><span class="p">));</span> <span class="p">)</span> 
		<span class="n">marvel_init_io7</span><span class="p">(</span><span class="n">io7</span><span class="p">);</span>

	<span class="cm">/* Check for graphic console location (if any).  */</span>
	<span class="n">marvel_find_console_vga_hose</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">marvel_kill_arch</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * PCI Configuration Space access functions</span>
<span class="cm"> *</span>
<span class="cm"> * Configuration space addresses have the following format:</span>
<span class="cm"> *</span>
<span class="cm"> * 	|2 2 2 2|1 1 1 1|1 1 1 1|1 1 </span>
<span class="cm"> * 	|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0</span>
<span class="cm"> * 	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> * 	|B|B|B|B|B|B|B|B|D|D|D|D|D|F|F|F|R|R|R|R|R|R|R|R|</span>
<span class="cm"> * 	+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *</span>
<span class="cm"> *	 n:24	reserved for hose base</span>
<span class="cm"> *	23:16	bus number (8 bits = 128 possible buses)</span>
<span class="cm"> *	15:11	Device number (5 bits)</span>
<span class="cm"> *	10:8	function number</span>
<span class="cm"> *	 7:2	register number</span>
<span class="cm"> *  </span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	IO7 determines whether to use a type 0 or type 1 config cycle</span>
<span class="cm"> *	based on the bus number. Therefore the bus number must be set </span>
<span class="cm"> *	to 0 for the root bus on any hose.</span>
<span class="cm"> *	</span>
<span class="cm"> *	The function number selects which function of a multi-function device </span>
<span class="cm"> *	(e.g., SCSI and Ethernet).</span>
<span class="cm"> * </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">build_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus</span><span class="p">,</span> 
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">config_space_base</span> <span class="o">|</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">where</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">mk_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span> <span class="o">=</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="n">io7_port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* Check for enabled.  */</span>
	<span class="n">io7_port</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io7_port</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* No parent means peer PCI bus. */</span>
		<span class="cm">/* Don&#39;t support idsel &gt; 20 on primary bus.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devfn</span> <span class="o">&gt;=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">build_conf_addr</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">);</span>

	<span class="n">DBG_CFG</span><span class="p">((</span><span class="s">&quot;mk_conf_addr: returning pci_addr 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">marvel_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		   <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:	
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">__kernel_ldbu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vucp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:	
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">__kernel_ldwu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vusp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:	
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">PCIBIOS_FUNC_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">marvel_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">__kernel_stb</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">vucp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">__kernel_ldbu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vucp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">__kernel_stw</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">vusp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">__kernel_ldwu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vusp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">PCIBIOS_FUNC_NOT_SUPPORTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">marvel_pci_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">marvel_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> 	<span class="n">marvel_write_config</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Other PCI helper functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">marvel_pci_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">csrs</span><span class="p">;</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_SG_TBIA</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_SG_TBIA</span><span class="p">.</span><span class="n">csr</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * RTC Support</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">marvel_rtc_access_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__marvel_access_rtc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_rtc_access_info</span> <span class="o">*</span><span class="n">rtc_access</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__r0</span> <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$0&quot;</span><span class="p">);</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__r16</span> <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$16&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">rtc_access</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__r17</span> <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$17&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">rtc_access</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__r18</span> <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;$18&quot;</span><span class="p">)</span> <span class="o">=</span> <span class="n">rtc_access</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	
	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span>
		<span class="s">&quot;call_pal %4 # cserve rtc&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__r16</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__r17</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__r18</span><span class="p">),</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">__r0</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">PAL_cserve</span><span class="p">),</span> <span class="s">&quot;0&quot;</span><span class="p">(</span><span class="n">__r16</span><span class="p">),</span> <span class="s">&quot;1&quot;</span><span class="p">(</span><span class="n">__r17</span><span class="p">),</span> <span class="s">&quot;2&quot;</span><span class="p">(</span><span class="n">__r18</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;$1&quot;</span><span class="p">,</span> <span class="s">&quot;$22&quot;</span><span class="p">,</span> <span class="s">&quot;$23&quot;</span><span class="p">,</span> <span class="s">&quot;$24&quot;</span><span class="p">,</span> <span class="s">&quot;$25&quot;</span><span class="p">);</span>

	<span class="n">rtc_access</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">__r0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">__marvel_rtc_io</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">marvel_rtc_access_info</span> <span class="n">rtc_access</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x70</span>:					<span class="cm">/* RTC_PORT(0) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="n">index</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x71</span>:					<span class="cm">/* RTC_PORT(1) */</span>
		<span class="n">rtc_access</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">rtc_access</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">bcd2bin</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
		<span class="n">rtc_access</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="o">!</span><span class="n">write</span><span class="p">;</span>	<span class="cm">/* GET/PUT_TOY */</span>

		<span class="n">__marvel_access_rtc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_access</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">bin2bcd</span><span class="p">(</span><span class="n">rtc_access</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Illegal RTC port %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * IO map support.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">marvel_ioremap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baddr</span><span class="p">,</span> <span class="n">last</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vm_struct</span> <span class="o">*</span><span class="n">area</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust the address.</span>
<span class="cm">	 */</span> 
	<span class="n">FIXUP_MEMADDR_VGA</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the hose.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose_head</span><span class="p">;</span> <span class="n">hose</span><span class="p">;</span> <span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span> 
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have the hose - calculate the bus limits.</span>
<span class="cm">	 */</span>
	<span class="n">baddr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">baddr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Is it direct-mapped?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">baddr</span> <span class="o">&gt;=</span> <span class="n">__direct_map_base</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
	    <span class="p">((</span><span class="n">baddr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">__direct_map_base</span> <span class="o">+</span> <span class="n">__direct_map_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">IDENT_ADDR</span> <span class="o">|</span> <span class="p">(</span><span class="n">baddr</span> <span class="o">-</span> <span class="n">__direct_map_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm">	 * Check the scatter-gather arena.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span> <span class="o">&amp;&amp;</span>
	    <span class="n">baddr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">&amp;&amp;</span>
	    <span class="n">last</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Adjust the limits (mappings must be page aligned)</span>
<span class="cm">		 */</span>
		<span class="n">baddr</span> <span class="o">-=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>
		<span class="n">last</span> <span class="o">-=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>
		<span class="n">baddr</span> <span class="o">&amp;=</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">-</span> <span class="n">baddr</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Map it.</span>
<span class="cm">		 */</span>
		<span class="n">area</span> <span class="o">=</span> <span class="n">get_vm_area</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">VM_IOREMAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">area</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">ptes</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span> 
		    <span class="n">baddr</span> <span class="o">&lt;=</span> <span class="n">last</span><span class="p">;</span> 
		    <span class="n">baddr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">vaddr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfn</span> <span class="o">=</span> <span class="n">ptes</span><span class="p">[</span><span class="n">baddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pfn</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ioremap failed... pte not valid...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pfn</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* make it a true pfn */</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">__alpha_remap_area_pages</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span>
						     <span class="n">pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span> 
						     <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;FAILED to map...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">flush_tlb_all</span><span class="p">();</span>

		<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">area</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>

		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assume it was already a reasonable address */</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">baddr</span> <span class="o">+</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">vaddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">marvel_iounmap</span><span class="p">(</span><span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">VMALLOC_START</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">PAGE_MASK</span> <span class="o">&amp;</span> <span class="n">addr</span><span class="p">));</span> 
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">marvel_is_mmio</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">VMALLOC_START</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF000000UL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define __marvel_is_port_kbd(a)	(((a) == 0x60) || ((a) == 0x64))</span>
<span class="cp">#define __marvel_is_port_rtc(a)	(((a) == 0x70) || ((a) == 0x71))</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">marvel_ioportmap</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">FIXUP_IOADDR_VGA</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">marvel_ioread8</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__marvel_is_port_kbd</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">__marvel_is_port_rtc</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">__marvel_rtc_io</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">marvel_is_ioaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">__kernel_ldbu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">vucp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* this should catch other legacy addresses</span>
<span class="cm">		   that would normally fail on MARVEL,</span>
<span class="cm">		   because there really is nothing there...</span>
<span class="cm">		*/</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">marvel_iowrite8</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__marvel_is_port_kbd</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">__marvel_is_port_rtc</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> 
		<span class="n">__marvel_rtc_io</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">marvel_is_ioaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">__kernel_stb</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">vucp</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_ALPHA_GENERIC</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_ioremap</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_iounmap</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_is_mmio</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_ioportmap</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_ioread8</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">marvel_iowrite8</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * NUMA Support</span>
<span class="cm"> */</span>
<span class="cm">/**********</span>
<span class="cm"> * FIXME - for now each cpu is a node by itself </span>
<span class="cm"> *              -- no real support for striped mode </span>
<span class="cm"> **********</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">marvel_pa_to_nid</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpuid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">43</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> 	<span class="cm">/* I/O */</span> 
		<span class="n">cpuid</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">35</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* mem */</span>
		<span class="n">cpuid</span> <span class="o">=</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="mi">34</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pa</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">37</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">marvel_cpuid_to_nid</span><span class="p">(</span><span class="n">cpuid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">marvel_cpuid_to_nid</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpuid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">marvel_node_mem_start</span><span class="p">(</span><span class="kt">int</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">;</span>

	<span class="n">pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">nid</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">nid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pa</span> <span class="o">&lt;&lt;=</span> <span class="mi">34</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pa</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">marvel_node_mem_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">nid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">16UL</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span> <span class="cm">/* 16GB */</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * AGP GART Support.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/agp_backend.h&gt;</span>
<span class="cp">#include &lt;asm/agp_backend.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_iommu_arena</span> <span class="o">*</span><span class="n">arena</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">pg_start</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">pg_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">marvel_agp_setup</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="o">*</span><span class="n">aper</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alpha_agpgart_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aper</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aper</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aper</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="p">;</span>
	<span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span> <span class="o">=</span> <span class="n">alpha_agpgart_size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span> <span class="o">=</span> <span class="n">iommu_reserve</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span><span class="p">,</span>
				       <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to reserve AGP memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">aper</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">bus_base</span> <span class="o">=</span> 
		<span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">+</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span> <span class="o">=</span> <span class="n">aper</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">marvel_agp_cleanup</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="o">*</span><span class="n">aper</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">iommu_release</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Attempted to release bound AGP memory - unbinding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">iommu_unbind</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">iommu_release</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span><span class="p">,</span> 
				       <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to release AGP memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">aper</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">agp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">marvel_agp_configure</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="p">)</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">csrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="p">)</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">io7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">agp_pll</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check the requested mode against the PLL setting.</span>
<span class="cm">	 * The agpgart_be code has not programmed the card yet,</span>
<span class="cm">	 * so we can still tweak mode here.</span>
<span class="cm">	 */</span>
	<span class="n">agp_pll</span> <span class="o">=</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">csrs</span><span class="o">-&gt;</span><span class="n">POx_RST</span><span class="p">[</span><span class="n">IO7_AGP_PORT</span><span class="p">].</span><span class="n">csr</span><span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">IO7_PLL_RNGB</span><span class="p">(</span><span class="n">agp_pll</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4</span>:				<span class="cm">/* 2x only */</span>
		<span class="cm">/* </span>
<span class="cm">		 * The PLL is only programmed for 2x, so adjust the</span>
<span class="cm">		 * rate to 2x, if necessary.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> 
			<span class="n">new_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x6</span>:				<span class="cm">/* 1x / 4x */</span>
		<span class="cm">/*</span>
<span class="cm">		 * The PLL is programmed for 1x or 4x.  Don&#39;t go faster</span>
<span class="cm">		 * than requested, so if the requested rate is 2x, use 1x.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> 
			<span class="n">new_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>				<span class="cm">/* ??????? */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t know what this PLL setting is, take the requested</span>
<span class="cm">		 * rate, but warn the user.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unknown PLL setting RNGB=%lx (PLL6_CTL=%016lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">IO7_PLL_RNGB</span><span class="p">(</span><span class="n">agp_pll</span><span class="p">),</span> <span class="n">agp_pll</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the new rate, if necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Requested AGP Rate %dX not compatible &quot;</span>
		       <span class="s">&quot;with PLL setting - using %dX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span>
		       <span class="n">new_rate</span><span class="p">);</span>

		<span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">new_rate</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Enabling AGP on hose %d: %dX%s RQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	       <span class="n">agp</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span> 
	       <span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">sba</span> <span class="o">?</span> <span class="s">&quot; - SBA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rq</span><span class="p">);</span>

	<span class="n">csrs</span><span class="o">-&gt;</span><span class="n">AGP_CMD</span><span class="p">.</span><span class="n">csr</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">lw</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">marvel_agp_bind_memory</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="o">*</span><span class="n">aper</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iommu_bind</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">pg_start</span><span class="p">,</span> 
			  <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">marvel_agp_unbind_memory</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">pg_start</span><span class="p">,</span> <span class="k">struct</span> <span class="n">agp_memory</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="o">*</span><span class="n">aper</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iommu_unbind</span><span class="p">(</span><span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="p">,</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">pg_start</span> <span class="o">+</span> <span class="n">pg_start</span><span class="p">,</span>
			    <span class="n">mem</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">marvel_agp_translate</span><span class="p">(</span><span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">marvel_agp_aperture</span> <span class="o">*</span><span class="n">aper</span> <span class="o">=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baddr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">dma_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">bus_base</span> <span class="o">||</span>
	    <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">bus_base</span> <span class="o">+</span> <span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: addr out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pte</span> <span class="o">=</span> <span class="n">aper</span><span class="o">-&gt;</span><span class="n">arena</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">[</span><span class="n">baddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: pte not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="k">return</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">alpha_agp_ops</span> <span class="n">marvel_agp_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">setup</span>		<span class="o">=</span> <span class="n">marvel_agp_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span>	<span class="o">=</span> <span class="n">marvel_agp_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure</span>	<span class="o">=</span> <span class="n">marvel_agp_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span>		<span class="o">=</span> <span class="n">marvel_agp_bind_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span>		<span class="o">=</span> <span class="n">marvel_agp_unbind_memory</span><span class="p">,</span>
	<span class="p">.</span><span class="n">translate</span>	<span class="o">=</span> <span class="n">marvel_agp_translate</span>
<span class="p">};</span>

<span class="n">alpha_agp_info</span> <span class="o">*</span>
<span class="nf">marvel_agp_info</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>
	<span class="n">io7_ioport_csrs</span> <span class="o">*</span><span class="n">csrs</span><span class="p">;</span>
	<span class="n">alpha_agp_info</span> <span class="o">*</span><span class="n">agp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io7</span> <span class="o">*</span><span class="n">io7</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the first IO7 with an AGP card.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME -- there should be a better way (we want to be able to</span>
<span class="cm">	 * specify and what if the agp card is not video???)</span>
<span class="cm">	 */</span>
	<span class="n">hose</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">io7</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">(</span><span class="n">io7</span> <span class="o">=</span> <span class="n">marvel_next_io7</span><span class="p">(</span><span class="n">io7</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
		<span class="n">vuip</span> <span class="n">addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">IO7_AGP_PORT</span><span class="p">].</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">h</span> <span class="o">=</span> <span class="n">io7</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">IO7_AGP_PORT</span><span class="p">].</span><span class="n">hose</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">build_conf_addr</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span> <span class="o">!=</span> <span class="mh">0xffffffffu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hose</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hose</span> <span class="o">||</span> <span class="o">!</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MARVEL - using hose %d as AGP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Get the csrs from the hose.</span>
<span class="cm">	 */</span>
	<span class="n">csrs</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">io7_port</span> <span class="o">*</span><span class="p">)</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sysdata</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">csrs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the info structure.</span>
<span class="cm">	 */</span>
	<span class="n">agp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">agp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agp</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill it in.</span>
<span class="cm">	 */</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">hose</span> <span class="o">=</span> <span class="n">hose</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">marvel_agp_ops</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Aperture - not configured until ops.setup().</span>
<span class="cm">	 */</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">bus_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">aperture</span><span class="p">.</span><span class="n">sysdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Capabilities.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: IO7 reports through AGP_STAT that it can support a read queue</span>
<span class="cm">	 *       depth of 17 (rq = 0x10). It actually only supports a depth of</span>
<span class="cm">	 * 	 16 (rq = 0xf).</span>
<span class="cm">	 */</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">.</span><span class="n">lw</span> <span class="o">=</span> <span class="n">csrs</span><span class="o">-&gt;</span><span class="n">AGP_STAT</span><span class="p">.</span><span class="n">csr</span><span class="p">;</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">.</span><span class="n">bits</span><span class="p">.</span><span class="n">rq</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Mode.</span>
<span class="cm">	 */</span>
	<span class="n">agp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">lw</span> <span class="o">=</span> <span class="n">csrs</span><span class="o">-&gt;</span><span class="n">AGP_CMD</span><span class="p">.</span><span class="n">csr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">agp</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
