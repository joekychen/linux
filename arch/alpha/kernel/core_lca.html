<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › core_lca.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core_lca.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/arch/alpha/kernel/core_lca.c</span>
<span class="cm"> *</span>
<span class="cm"> * Written by David Mosberger (davidm@cs.arizona.edu) with some code</span>
<span class="cm"> * taken from Dave Rusling&#39;s (david.rusling@reo.mts.dec.com) 32-bit</span>
<span class="cm"> * bios code.</span>
<span class="cm"> *</span>
<span class="cm"> * Code common to all LCA core logic chips.</span>
<span class="cm"> */</span>

<span class="cp">#define __EXTERN_INLINE inline</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/core_lca.h&gt;</span>
<span class="cp">#undef __EXTERN_INLINE</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>

<span class="cp">#include &quot;proto.h&quot;</span>
<span class="cp">#include &quot;pci_impl.h&quot;</span>


<span class="cm">/*</span>
<span class="cm"> * BIOS32-style PCI interface:</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Machine check reasons.  Defined according to PALcode sources</span>
<span class="cm"> * (osf.h and platform.h).</span>
<span class="cm"> */</span>
<span class="cp">#define MCHK_K_TPERR		0x0080</span>
<span class="cp">#define MCHK_K_TCPERR		0x0082</span>
<span class="cp">#define MCHK_K_HERR		0x0084</span>
<span class="cp">#define MCHK_K_ECC_C		0x0086</span>
<span class="cp">#define MCHK_K_ECC_NC		0x0088</span>
<span class="cp">#define MCHK_K_UNKNOWN		0x008A</span>
<span class="cp">#define MCHK_K_CACKSOFT		0x008C</span>
<span class="cp">#define MCHK_K_BUGCHECK		0x008E</span>
<span class="cp">#define MCHK_K_OS_BUGCHECK	0x0090</span>
<span class="cp">#define MCHK_K_DCPERR		0x0092</span>
<span class="cp">#define MCHK_K_ICPERR		0x0094</span>


<span class="cm">/*</span>
<span class="cm"> * Platform-specific machine-check reasons:</span>
<span class="cm"> */</span>
<span class="cp">#define MCHK_K_SIO_SERR		0x204	</span><span class="cm">/* all platforms so far */</span><span class="cp"></span>
<span class="cp">#define MCHK_K_SIO_IOCHK	0x206	</span><span class="cm">/* all platforms so far */</span><span class="cp"></span>
<span class="cp">#define MCHK_K_DCSR		0x208	</span><span class="cm">/* all but Noname */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * Given a bus, device, and function number, compute resulting</span>
<span class="cm"> * configuration space address and setup the LCA_IOC_CONF register</span>
<span class="cm"> * accordingly.  It is therefore not safe to have concurrent</span>
<span class="cm"> * invocations to configuration space access routines, but there</span>
<span class="cm"> * really shouldn&#39;t be any need for this.</span>
<span class="cm"> *</span>
<span class="cm"> * Type 0:</span>
<span class="cm"> *</span>
<span class="cm"> *  3 3|3 3 2 2|2 2 2 2|2 2 2 2|1 1 1 1|1 1 1 1|1 1 </span>
<span class="cm"> *  3 2|1 0 9 8|7 6 5 4|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> * | | | | | | | | | | | | | | | | | | | | | | | |F|F|F|R|R|R|R|R|R|0|0|</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *</span>
<span class="cm"> *	31:11	Device select bit.</span>
<span class="cm"> * 	10:8	Function number</span>
<span class="cm"> * 	 7:2	Register number</span>
<span class="cm"> *</span>
<span class="cm"> * Type 1:</span>
<span class="cm"> *</span>
<span class="cm"> *  3 3|3 3 2 2|2 2 2 2|2 2 2 2|1 1 1 1|1 1 1 1|1 1 </span>
<span class="cm"> *  3 2|1 0 9 8|7 6 5 4|3 2 1 0|9 8 7 6|5 4 3 2|1 0 9 8|7 6 5 4|3 2 1 0</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> * | | | | | | | | | | |B|B|B|B|B|B|B|B|D|D|D|D|D|F|F|F|R|R|R|R|R|R|0|1|</span>
<span class="cm"> * +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *</span>
<span class="cm"> *	31:24	reserved</span>
<span class="cm"> *	23:16	bus number (8 bits = 128 possible buses)</span>
<span class="cm"> *	15:11	Device number (5 bits)</span>
<span class="cm"> *	10:8	function number</span>
<span class="cm"> *	 7:2	register number</span>
<span class="cm"> *  </span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	The function number selects which function of a multi-function device </span>
<span class="cm"> *	(e.g., SCSI and Ethernet).</span>
<span class="cm"> * </span>
<span class="cm"> *	The register selects a DWORD (32 bit) register offset.  Hence it</span>
<span class="cm"> *	doesn&#39;t get shifted by 2 bits as we want to &quot;drop&quot; the bottom two</span>
<span class="cm"> *	bits.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mk_conf_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_fn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pci_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus</span> <span class="o">=</span> <span class="n">pbus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device_fn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">func</span> <span class="o">=</span> <span class="n">device_fn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="cm">/* Type 0 configuration cycle.  */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_CONF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">11</span> <span class="o">+</span> <span class="n">device</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">func</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">where</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Type 1 configuration cycle.  */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_CONF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">device_fn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">where</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pci_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">conf_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stat0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Reset status register to avoid losing errors.  */</span>
	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Access configuration space.  */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">draina</span><span class="p">();</span>

	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">LCA_IOC_STAT0_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">((</span><span class="n">stat0</span> <span class="o">&gt;&gt;</span> <span class="n">LCA_IOC_STAT0_CODE_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">LCA_IOC_STAT0_CODE_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lca.c:conf_read: got stat0=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reset error status.  */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="cm">/* Reset machine check.  */</span>
		<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>

		<span class="n">value</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">conf_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">stat0</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>	<span class="cm">/* avoid getting hit by machine check */</span>

	<span class="cm">/* Reset status register to avoid losing errors.  */</span>
	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Access configuration space.  */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">draina</span><span class="p">();</span>

	<span class="n">stat0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">LCA_IOC_STAT0_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">((</span><span class="n">stat0</span> <span class="o">&gt;&gt;</span> <span class="n">LCA_IOC_STAT0_CODE_SHIFT</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="n">LCA_IOC_STAT0_CODE_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;lca.c:conf_write: got stat0=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reset error status.  */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_STAT0</span> <span class="o">=</span> <span class="n">stat0</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>

		<span class="cm">/* Reset machine check. */</span>
		<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">lca_read_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pci_addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">LCA_CONF</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">conf_read</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">shift</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">lca_write_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devfn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span>
		 <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pci_addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mk_conf_addr</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">devfn</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PCIBIOS_DEVICE_NOT_FOUND</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pci_addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">LCA_CONF</span><span class="p">;</span>
	<span class="n">conf_write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">where</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pci_ops</span> <span class="n">lca_pci_ops</span> <span class="o">=</span> 
<span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">lca_read_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span>	<span class="n">lca_write_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">lca_pci_tbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">start</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_TBIA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">lca_init_arch</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_controller</span> <span class="o">*</span><span class="n">hose</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create our single hose.</span>
<span class="cm">	 */</span>

	<span class="n">pci_isa_hose</span> <span class="o">=</span> <span class="n">hose</span> <span class="o">=</span> <span class="n">alloc_pci_controller</span><span class="p">();</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">io_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ioport_resource</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">mem_space</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_mem_base</span> <span class="o">=</span> <span class="n">LCA_SPARSE_MEM</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_mem_base</span> <span class="o">=</span> <span class="n">LCA_DENSE_MEM</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sparse_io_base</span> <span class="o">=</span> <span class="n">LCA_IO</span> <span class="o">-</span> <span class="n">IDENT_ADDR</span><span class="p">;</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the PCI to main memory translation windows.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Mimic the SRM settings for the direct-map window.</span>
<span class="cm">	 *   Window 0 is scatter-gather 8MB at 8MB (for isa).</span>
<span class="cm">	 *   Window 1 is direct access 1GB at 1GB.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that we do not try to save any of the DMA window CSRs</span>
<span class="cm">	 * before setting them, since we cannot read those CSRs on LCA.</span>
<span class="cm">	 */</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span> <span class="o">=</span> <span class="n">iommu_arena_new</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_pci</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__direct_map_base</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">;</span>
	<span class="n">__direct_map_size</span> <span class="o">=</span> <span class="mh">0x40000000</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_W_BASE0</span> <span class="o">=</span> <span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">dma_base</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3UL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_W_MASK0</span> <span class="o">=</span> <span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_T_BASE0</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">sg_isa</span><span class="o">-&gt;</span><span class="n">ptes</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_W_BASE1</span> <span class="o">=</span> <span class="n">__direct_map_base</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2UL</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_W_MASK1</span> <span class="o">=</span> <span class="p">(</span><span class="n">__direct_map_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff00000</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_T_BASE1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_TB_ENA</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">lca_pci_tbi</span><span class="p">(</span><span class="n">hose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable PCI parity for now.  The NCR53c810 chip has</span>
<span class="cm">	 * troubles meeting the PCI spec which results in</span>
<span class="cm">	 * data parity errors.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vulp</span><span class="p">)</span><span class="n">LCA_IOC_PAR_DIS</span> <span class="o">=</span> <span class="mi">1UL</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Finally, set up for restoring the correct HAE if using SRM.</span>
<span class="cm">	 * Again, since we cannot read many of the CSRs on the LCA,</span>
<span class="cm">	 * one of which happens to be the HAE, we save the value that</span>
<span class="cm">	 * the SRM will expect...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_using_srm</span><span class="p">)</span>
		<span class="n">srm_hae</span> <span class="o">=</span> <span class="mh">0x80000000UL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Constants used during machine-check handling.  I suppose these</span>
<span class="cm"> * could be moved into lca.h but I don&#39;t see much reason why anybody</span>
<span class="cm"> * else would want to use them.</span>
<span class="cm"> */</span>

<span class="cp">#define ESR_EAV		(1UL&lt;&lt; 0)	</span><span class="cm">/* error address valid */</span><span class="cp"></span>
<span class="cp">#define ESR_CEE		(1UL&lt;&lt; 1)	</span><span class="cm">/* correctable error */</span><span class="cp"></span>
<span class="cp">#define ESR_UEE		(1UL&lt;&lt; 2)	</span><span class="cm">/* uncorrectable error */</span><span class="cp"></span>
<span class="cp">#define ESR_WRE		(1UL&lt;&lt; 3)	</span><span class="cm">/* write-error */</span><span class="cp"></span>
<span class="cp">#define ESR_SOR		(1UL&lt;&lt; 4)	</span><span class="cm">/* error source */</span><span class="cp"></span>
<span class="cp">#define ESR_CTE		(1UL&lt;&lt; 7)	</span><span class="cm">/* cache-tag error */</span><span class="cp"></span>
<span class="cp">#define ESR_MSE		(1UL&lt;&lt; 9)	</span><span class="cm">/* multiple soft errors */</span><span class="cp"></span>
<span class="cp">#define ESR_MHE		(1UL&lt;&lt;10)	</span><span class="cm">/* multiple hard errors */</span><span class="cp"></span>
<span class="cp">#define ESR_NXM		(1UL&lt;&lt;12)	</span><span class="cm">/* non-existent memory */</span><span class="cp"></span>

<span class="cp">#define IOC_ERR		(  1&lt;&lt;4)	</span><span class="cm">/* ioc logs an error */</span><span class="cp"></span>
<span class="cp">#define IOC_CMD_SHIFT	0</span>
<span class="cp">#define IOC_CMD		(0xf&lt;&lt;IOC_CMD_SHIFT)</span>
<span class="cp">#define IOC_CODE_SHIFT	8</span>
<span class="cp">#define IOC_CODE	(0xf&lt;&lt;IOC_CODE_SHIFT)</span>
<span class="cp">#define IOC_LOST	(  1&lt;&lt;5)</span>
<span class="cp">#define IOC_P_NBR	((__u32) ~((1&lt;&lt;13) - 1))</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mem_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">esr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    %s %s error to %s occurred at address %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_CEE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Correctable&quot;</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_UEE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Uncorrectable&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">),</span>
	       <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_WRE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_SOR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;memory&quot;</span> <span class="o">:</span> <span class="s">&quot;b-cache&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">ear</span> <span class="o">&amp;</span> <span class="mh">0x1ffffff8</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_CTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    A b-cache tag parity error was detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_MSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    Several other correctable errors occurred.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_MHE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    Several other uncorrectable errors occurred.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_NXM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    Attempted to access non-existent memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ioc_error</span><span class="p">(</span><span class="n">__u32</span> <span class="n">stat0</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">stat1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pci_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Interrupt Acknowledge&quot;</span><span class="p">,</span> <span class="s">&quot;Special&quot;</span><span class="p">,</span> <span class="s">&quot;I/O Read&quot;</span><span class="p">,</span> <span class="s">&quot;I/O Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Rsvd 1&quot;</span><span class="p">,</span> <span class="s">&quot;Rsvd 2&quot;</span><span class="p">,</span> <span class="s">&quot;Memory Read&quot;</span><span class="p">,</span> <span class="s">&quot;Memory Write&quot;</span><span class="p">,</span> <span class="s">&quot;Rsvd3&quot;</span><span class="p">,</span>
		<span class="s">&quot;Rsvd4&quot;</span><span class="p">,</span> <span class="s">&quot;Configuration Read&quot;</span><span class="p">,</span> <span class="s">&quot;Configuration Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read Multiple&quot;</span><span class="p">,</span> <span class="s">&quot;Dual Address&quot;</span><span class="p">,</span> <span class="s">&quot;Memory Read Line&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Write and Invalidate&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">err_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;exceeded retry limit&quot;</span><span class="p">,</span> <span class="s">&quot;no device&quot;</span><span class="p">,</span> <span class="s">&quot;bad data parity&quot;</span><span class="p">,</span>
		<span class="s">&quot;target abort&quot;</span><span class="p">,</span> <span class="s">&quot;bad address parity&quot;</span><span class="p">,</span> <span class="s">&quot;page table read error&quot;</span><span class="p">,</span>
		<span class="s">&quot;invalid page&quot;</span><span class="p">,</span> <span class="s">&quot;data error&quot;</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">IOC_CODE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IOC_CODE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cmd</span>  <span class="o">=</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">IOC_CMD</span><span class="p">)</span>  <span class="o">&gt;&gt;</span> <span class="n">IOC_CMD_SHIFT</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    %s initiated PCI %s cycle to address %x&quot;</span>
	       <span class="s">&quot; failed due to %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">code</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">?</span> <span class="s">&quot;PCI&quot;</span> <span class="o">:</span> <span class="s">&quot;CPU&quot;</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">[</span><span class="n">cmd</span><span class="p">],</span> <span class="n">stat1</span><span class="p">,</span> <span class="n">err_name</span><span class="p">[</span><span class="n">code</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">code</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    (Error occurred at PCI memory address %x.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IOC_P_NBR</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat0</span> <span class="o">&amp;</span> <span class="n">IOC_LOST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;    Other PCI errors occurred simultaneously.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lca_machine_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">reason</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">el_lca</span> <span class="n">el</span><span class="p">;</span>

	<span class="n">el</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="p">)</span> <span class="n">la_ptr</span><span class="p">;</span>

	<span class="n">wrmces</span><span class="p">(</span><span class="n">rdmces</span><span class="p">());</span>	<span class="cm">/* reset machine check pending flag */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;LCA machine check: vector=%#lx pc=%#lx code=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">vector</span><span class="p">,</span> <span class="n">get_irq_regs</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The first quadword after the common header always seems to</span>
<span class="cm">	 * be the machine check reason---don&#39;t know why this isn&#39;t</span>
<span class="cm">	 * part of the common header instead.  In the case of a long</span>
<span class="cm">	 * logout frame, the upper 32 bits is the machine check</span>
<span class="cm">	 * revision level, which we ignore for now.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MCHK_K_TPERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;tag parity error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_TCPERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;tag control parity error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_HERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;access to non-existent memory&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_ECC_C</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;correctable ECC error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_ECC_NC</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;non-correctable ECC error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_CACKSOFT</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;MCHK_K_CACKSOFT&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_BUGCHECK</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;illegal exception in PAL mode&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_OS_BUGCHECK</span>: <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;callsys in kernel mode&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_DCPERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;d-cache parity error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_ICPERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;i-cache parity error&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_SIO_SERR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;SIO SERR occurred on PCI bus&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_SIO_IOCHK</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;SIO IOCHK occurred on ISA bus&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_DCSR</span>:	<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;MCHK_K_DCSR&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MCHK_K_UNKNOWN</span>:
	<span class="nl">default:</span>		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_lca_mcheck_short</span><span class="p">)</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span>
		       <span class="s">&quot;  Reason: %s (short frame%s, dc_stat=%#lx):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reason</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">?</span> <span class="s">&quot;, retryable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dc_stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_EAV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_error</span><span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">esr</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ear</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ioc_stat0</span> <span class="o">&amp;</span> <span class="n">IOC_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc_error</span><span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ioc_stat0</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ioc_stat1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_lca_mcheck_long</span><span class="p">)</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Reason: %s (long frame%s):</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reason</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">?</span> <span class="s">&quot;, retryable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span>
		       <span class="s">&quot;    reason: %#lx  exc_addr: %#lx  dc_stat: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">exc_addr</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">dc_stat</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;    car: %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">car</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">esr</span> <span class="o">&amp;</span> <span class="n">ESR_EAV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mem_error</span><span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">esr</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ear</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ioc_stat0</span> <span class="o">&amp;</span> <span class="n">IOC_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ioc_error</span><span class="p">(</span><span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ioc_stat0</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">ioc_stat1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;  Unknown errorlog size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Dump the logout area to give all info.  */</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alpha_verbose_mcheck</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">la_ptr</span><span class="p">;</span>
		<span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">el</span><span class="p">.</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot; +%8lx %016lx %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following routines are needed to support the SPEED changing</span>
<span class="cm"> * necessary to successfully manage the thermal problem on the AlphaBook1.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">lca_clock_print</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">long</span>    <span class="n">pmr_reg</span><span class="p">;</span>

        <span class="n">pmr_reg</span> <span class="o">=</span> <span class="n">LCA_READ_PMR</span><span class="p">;</span>

        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Status of clock control:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Primary clock divisor</span><span class="se">\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LCA_GET_PRIMARY</span><span class="p">(</span><span class="n">pmr_reg</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Override clock divisor</span><span class="se">\t</span><span class="s">0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">LCA_GET_OVERRIDE</span><span class="p">(</span><span class="n">pmr_reg</span><span class="p">));</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">Interrupt override is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">pmr_reg</span> <span class="o">&amp;</span> <span class="n">LCA_PMR_INTO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span> 
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">DMA override is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">pmr_reg</span> <span class="o">&amp;</span> <span class="n">LCA_PMR_DMAO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span> 

<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">lca_get_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">long</span>    <span class="n">pmr_reg</span><span class="p">;</span>

        <span class="n">pmr_reg</span> <span class="o">=</span> <span class="n">LCA_READ_PMR</span><span class="p">;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">LCA_GET_PRIMARY</span><span class="p">(</span><span class="n">pmr_reg</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">lca_clock_fiddle</span><span class="p">(</span><span class="kt">int</span> <span class="n">divisor</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">long</span>    <span class="n">pmr_reg</span><span class="p">;</span>

        <span class="n">pmr_reg</span> <span class="o">=</span> <span class="n">LCA_READ_PMR</span><span class="p">;</span>
        <span class="n">LCA_SET_PRIMARY_CLOCK</span><span class="p">(</span><span class="n">pmr_reg</span><span class="p">,</span> <span class="n">divisor</span><span class="p">);</span>
	<span class="cm">/* lca_norm_clock = divisor; */</span>
        <span class="n">LCA_WRITE_PMR</span><span class="p">(</span><span class="n">pmr_reg</span><span class="p">);</span>
        <span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
