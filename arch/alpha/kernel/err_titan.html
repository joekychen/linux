<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › kernel › err_titan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>err_titan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	linux/arch/alpha/kernel/err_titan.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2000 Jeff Wiedemeier (Compaq Computer Corporation)</span>
<span class="cm"> *</span>
<span class="cm"> *	Error handling code supporting TITAN systems</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/core_titan.h&gt;</span>
<span class="cp">#include &lt;asm/hwrpb.h&gt;</span>
<span class="cp">#include &lt;asm/smp.h&gt;</span>
<span class="cp">#include &lt;asm/err_common.h&gt;</span>
<span class="cp">#include &lt;asm/err_ev6.h&gt;</span>
<span class="cp">#include &lt;asm/irq_regs.h&gt;</span>

<span class="cp">#include &quot;err_impl.h&quot;</span>
<span class="cp">#include &quot;proto.h&quot;</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">titan_parse_c_misc</span><span class="p">(</span><span class="n">u64</span> <span class="n">c_misc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nxs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_REPORT</span><span class="p">;</span>

<span class="cp">#define TITAN__CCHIP_MISC__NXM		(1UL &lt;&lt; 28)</span>
<span class="cp">#define TITAN__CCHIP_MISC__NXS__S	(29)</span>
<span class="cp">#define TITAN__CCHIP_MISC__NXS__M	(0x7)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c_misc</span> <span class="o">&amp;</span> <span class="n">TITAN__CCHIP_MISC__NXM</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">nxs</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">c_misc</span><span class="p">,</span> <span class="n">TITAN__CCHIP_MISC__NXS</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">nxs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* CPU 0 */</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* CPU 1 */</span>
	<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* CPU 2 */</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* CPU 3 */</span>
		<span class="n">src</span> <span class="o">=</span> <span class="s">&quot;CPU&quot;</span><span class="p">;</span>
		<span class="cm">/* num is already the CPU number */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* Pchip 0 */</span>
	<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* Pchip 1 */</span>
		<span class="n">src</span> <span class="o">=</span> <span class="s">&quot;Pchip&quot;</span><span class="p">;</span>
		<span class="n">nxs</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span><span class="cm">/* reserved */</span>
		<span class="n">src</span> <span class="o">=</span> <span class="s">&quot;Unknown, NXS =&quot;</span><span class="p">;</span>
		<span class="cm">/* leave num untouched */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Non-existent memory access from: %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">nxs</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">titan_parse_p_serror</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u64</span> <span class="n">serror</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_REPORT</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serror_src</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;GPCI&quot;</span><span class="p">,</span> <span class="s">&quot;APCI&quot;</span><span class="p">,</span> <span class="s">&quot;AGP HP&quot;</span><span class="p">,</span> <span class="s">&quot;AGP LP&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">serror_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;DMA Read&quot;</span><span class="p">,</span> <span class="s">&quot;DMA RMW&quot;</span><span class="p">,</span> <span class="s">&quot;SGTE Read&quot;</span><span class="p">,</span> <span class="s">&quot;Reserved&quot;</span>
	<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

<span class="cp">#define TITAN__PCHIP_SERROR__LOST_UECC	(1UL &lt;&lt; 0)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__UECC	(1UL &lt;&lt; 1)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__CRE	(1UL &lt;&lt; 2)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__NXIO	(1UL &lt;&lt; 3)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__LOST_CRE	(1UL &lt;&lt; 4)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__ECCMASK	(TITAN__PCHIP_SERROR__UECC |	  \</span>
<span class="cp">					 TITAN__PCHIP_SERROR__CRE)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__ERRMASK	(TITAN__PCHIP_SERROR__LOST_UECC | \</span>
<span class="cp">					 TITAN__PCHIP_SERROR__UECC |	  \</span>
<span class="cp">					 TITAN__PCHIP_SERROR__CRE |	  \</span>
<span class="cp">					 TITAN__PCHIP_SERROR__NXIO |	  \</span>
<span class="cp">					 TITAN__PCHIP_SERROR__LOST_CRE)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__SRC__S	(52)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__SRC__M	(0x3)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__CMD__S	(54)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__CMD__M	(0x3)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__SYN__S	(56)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__SYN__M	(0xff)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__ADDR__S	(15)</span>
<span class="cp">#define TITAN__PCHIP_SERROR__ADDR__M	(0xffffffffUL)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__ERRMASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  PChip %d SERROR: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> <span class="n">serror</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__ECCMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    %sorrectable ECC Error:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;      Source: %-6s  Command: %-8s  Syndrome: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;      Address: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__UECC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Unc&quot;</span> <span class="o">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span>
		       <span class="n">serror_src</span><span class="p">[</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">serror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_SERROR__SRC</span><span class="p">)],</span>
		       <span class="n">serror_cmd</span><span class="p">[</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">serror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_SERROR__CMD</span><span class="p">)],</span>
		       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">EXTRACT</span><span class="p">(</span><span class="n">serror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_SERROR__SYN</span><span class="p">),</span>
		       <span class="n">EXTRACT</span><span class="p">(</span><span class="n">serror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_SERROR__ADDR</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__NXIO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Non Existent I/O Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__LOST_UECC</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Lost Uncorrectable ECC Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_SERROR__LOST_CRE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Lost Correctable ECC Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">titan_parse_p_perror</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u64</span> <span class="n">perror</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_REPORT</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">perror_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Interrupt Acknowledge&quot;</span><span class="p">,</span> <span class="s">&quot;Special Cycle&quot;</span><span class="p">,</span>
		<span class="s">&quot;I/O Read&quot;</span><span class="p">,</span>		<span class="s">&quot;I/O Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read&quot;</span><span class="p">,</span>		<span class="s">&quot;Memory Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
		<span class="s">&quot;Configuration Read&quot;</span><span class="p">,</span>	<span class="s">&quot;Configuration Write&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read Multiple&quot;</span><span class="p">,</span>	<span class="s">&quot;Dual Address Cycle&quot;</span><span class="p">,</span>
		<span class="s">&quot;Memory Read Line&quot;</span><span class="p">,</span>	<span class="s">&quot;Memory Write and Invalidate&quot;</span>
	<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

<span class="cp">#define TITAN__PCHIP_PERROR__LOST	(1UL &lt;&lt; 0)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__SERR	(1UL &lt;&lt; 1)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__PERR	(1UL &lt;&lt; 2)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__DCRTO	(1UL &lt;&lt; 3)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__SGE	(1UL &lt;&lt; 4)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__APE	(1UL &lt;&lt; 5)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__TA		(1UL &lt;&lt; 6)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__DPE	(1UL &lt;&lt; 7)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__NDS	(1UL &lt;&lt; 8)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__IPTPR	(1UL &lt;&lt; 9)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__IPTPW	(1UL &lt;&lt; 10)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__ERRMASK	(TITAN__PCHIP_PERROR__LOST |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__SERR |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__PERR |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__DCRTO |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__SGE |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__APE |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__TA |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__DPE |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__NDS |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__IPTPR |	\</span>
<span class="cp">					 TITAN__PCHIP_PERROR__IPTPW)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__DAC	(1UL &lt;&lt; 47)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__MWIN	(1UL &lt;&lt; 48)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__CMD__S	(52)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__CMD__M	(0x0f)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__ADDR__S	(14)</span>
<span class="cp">#define TITAN__PCHIP_PERROR__ADDR__M	(0x1fffffffful)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__ERRMASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">perror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_PERROR__CMD</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">perror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_PERROR__ADDR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initializing the BIOS on a video card on a bus without</span>
<span class="cm">	 * a south bridge (subtractive decode agent) can result in </span>
<span class="cm">	 * master aborts as the BIOS probes the capabilities of the</span>
<span class="cm">	 * card. XFree86 does such initialization. If the error</span>
<span class="cm">	 * is a master abort (No DevSel as PCI Master) and the command</span>
<span class="cm">	 * is an I/O read or write below the address where we start</span>
<span class="cm">	 * assigning PCI I/O spaces (SRM uses 0x1000), then mark the</span>
<span class="cm">	 * error as dismissable so starting XFree86 doesn&#39;t result</span>
<span class="cm">	 * in a series of uncorrectable errors being reported. Also</span>
<span class="cm">	 * dismiss master aborts to VGA frame buffer space</span>
<span class="cm">	 * (0xA0000 - 0xC0000) and legacy BIOS space (0xC0000 - 0x100000)</span>
<span class="cm">	 * for the same reason.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also mark the error dismissible if it looks like the right</span>
<span class="cm">	 * error but only the Lost bit is set. Since the BIOS initialization</span>
<span class="cm">	 * can cause multiple master aborts and the error interrupt can</span>
<span class="cm">	 * be handled on a different CPU than the BIOS code is run on,</span>
<span class="cm">	 * it is possible for a second master abort to occur between the</span>
<span class="cm">	 * time the PALcode reads PERROR and the time it writes PERROR</span>
<span class="cm">	 * to acknowledge the error. If this timing happens, a second</span>
<span class="cm">	 * error will be signalled after the first, and if no additional</span>
<span class="cm">	 * errors occur, will look like a Lost error with no additional </span>
<span class="cm">	 * errors on the same transaction as the previous error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__NDS</span><span class="p">)</span> <span class="o">||</span> 
	     <span class="p">((</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__ERRMASK</span><span class="p">)</span> <span class="o">==</span> 
	      <span class="n">TITAN__PCHIP_PERROR__LOST</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x1000</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">(((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mh">0xA0000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x100000</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_DISMISS</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  PChip %d %cPERROR: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">which</span><span class="p">,</span> 
	       <span class="n">port</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">:</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="n">perror</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__IPTPW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Invalid Peer-to-Peer Write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__IPTPR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Invalid Peer-to-Peer Read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__NDS</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    No DEVSEL as PCI Master [Master Abort]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__DPE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Data Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__TA</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Target Abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__APE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Address Parity Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__SGE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Scatter-Gather Error, Invalid PTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__DCRTO</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Delayed-Completion Retry Timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__PERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    PERR Asserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__SERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    SERR Asserted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__LOST</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Lost Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Command: 0x%x - %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;      Address: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span>
	       <span class="n">cmd</span><span class="p">,</span> <span class="n">perror_cmd</span><span class="p">[</span><span class="n">cmd</span><span class="p">],</span>
	       <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__DAC</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Dual Address Cycle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_PERROR__MWIN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Hit in Monster Window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">titan_parse_p_agperror</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u64</span> <span class="n">agperror</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_REPORT</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">agperror_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Read (low-priority)&quot;</span><span class="p">,</span>	<span class="s">&quot;Read (high-priority)&quot;</span><span class="p">,</span>
		<span class="s">&quot;Write (low-priority)&quot;</span><span class="p">,</span>	<span class="s">&quot;Write (high-priority)&quot;</span><span class="p">,</span>
		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>		<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
		<span class="s">&quot;Flush&quot;</span><span class="p">,</span>		<span class="s">&quot;Fence&quot;</span>
	<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

<span class="cp">#define TITAN__PCHIP_AGPERROR__LOST	(1UL &lt;&lt; 0)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__LPQFULL	(1UL &lt;&lt; 1)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__HPQFULL	(1UL &lt;&lt; 2)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__RESCMD	(1UL &lt;&lt; 3)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__IPTE	(1UL &lt;&lt; 4)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__PTP	(1UL &lt;&lt; 5)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__NOWINDOW	(1UL &lt;&lt; 6)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__ERRMASK	(TITAN__PCHIP_AGPERROR__LOST |    \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__LPQFULL | \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__HPQFULL | \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__RESCMD |  \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__IPTE |    \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__PTP |     \</span>
<span class="cp">					 TITAN__PCHIP_AGPERROR__NOWINDOW)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__DAC	(1UL &lt;&lt; 48)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__MWIN	(1UL &lt;&lt; 49)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__FENCE	(1UL &lt;&lt; 59)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__CMD__S	(50)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__CMD__M	(0x07)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__ADDR__S	(15)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__ADDR__M  (0xffffffffUL)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__LEN__S	(53)</span>
<span class="cp">#define TITAN__PCHIP_AGPERROR__LEN__M	(0x3f)</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__ERRMASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">agperror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_AGPERROR__CMD</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">agperror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_AGPERROR__ADDR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">EXTRACT</span><span class="p">(</span><span class="n">agperror</span><span class="p">,</span> <span class="n">TITAN__PCHIP_AGPERROR__LEN</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  PChip %d AGPERROR: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">,</span>
	       <span class="n">which</span><span class="p">,</span> <span class="n">agperror</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__NOWINDOW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    No Window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__PTP</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Peer-to-Peer set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__IPTE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Invalid PTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__RESCMD</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Reserved Command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__HPQFULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    HP Transaction Received while Queue Full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__LPQFULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    LP Transaction Received while Queue Full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__LOST</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s    Lost Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Command: 0x%x - %s, %d Quadwords%s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;      Address: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">agperror_cmd</span><span class="p">[</span><span class="n">cmd</span><span class="p">],</span> <span class="n">len</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__FENCE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;, FENCE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__DAC</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Dual Address Cycle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agperror</span> <span class="o">&amp;</span> <span class="n">TITAN__PCHIP_AGPERROR__MWIN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s      Hit in Monster Window</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_print_prefix</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>	

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">titan_parse_p_chip</span><span class="p">(</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span> <span class="n">u64</span> <span class="n">serror</span><span class="p">,</span> <span class="n">u64</span> <span class="n">gperror</span><span class="p">,</span> 
		   <span class="n">u64</span> <span class="n">aperror</span><span class="p">,</span> <span class="n">u64</span> <span class="n">agperror</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_serror</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">serror</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_perror</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gperror</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_perror</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">aperror</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_agperror</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">agperror</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">titan_process_logout_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">mchk_header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="n">tmchk</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mchk_header</span> <span class="o">+</span> <span class="n">mchk_header</span><span class="o">-&gt;</span><span class="n">sys_offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_c_misc</span><span class="p">(</span><span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">c_misc</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_chip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p0_serror</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p0_gperror</span><span class="p">,</span>
				     <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p0_aperror</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p0_agperror</span><span class="p">,</span> 
				     <span class="n">print</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_parse_p_chip</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p1_serror</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p1_gperror</span><span class="p">,</span>
				     <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p1_aperror</span><span class="p">,</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">p1_agperror</span><span class="p">,</span> 
				     <span class="n">print</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">titan_machine_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">mchk_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="p">)</span><span class="n">la_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="n">tmchk</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mchk_header</span> <span class="o">+</span> <span class="n">mchk_header</span><span class="o">-&gt;</span><span class="n">sys_offset</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">irqmask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mask of Titan interrupt sources which are reported as machine checks</span>
<span class="cm">	 *</span>
<span class="cm">	 * 63 - CChip Error</span>
<span class="cm">	 * 62 - PChip 0 H_Error</span>
<span class="cm">	 * 61 - PChip 1 H_Error</span>
<span class="cm">	 * 60 - PChip 0 C_Error</span>
<span class="cm">	 * 59 - PChip 1 C_Error</span>
<span class="cm">	 */</span>
<span class="cp">#define TITAN_MCHECK_INTERRUPT_MASK	0xF800000000000000UL</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sync the processor</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">draina</span><span class="p">();</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Only handle system errors here </span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vector</span> <span class="o">!=</span> <span class="n">SCB_Q_SYSMCHK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vector</span> <span class="o">!=</span> <span class="n">SCB_Q_SYSERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ev6_machine_check</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">la_ptr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* </span>
<span class="cm">	 * It&#39;s a system error, handle it here</span>
<span class="cm">	 *</span>
<span class="cm">	 * The PALcode has already cleared the error, so just parse it</span>
<span class="cm">	 */</span>
	
	<span class="cm">/* </span>
<span class="cm">	 * Parse the logout frame without printing first. If the only error(s)</span>
<span class="cm">	 * found are classified as &quot;dismissable&quot;, then just dismiss them and</span>
<span class="cm">	 * don&#39;t print any message</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">titan_process_logout_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> 
	    <span class="n">MCHK_DISPOSITION_DISMISS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">saved_err_prefix</span> <span class="o">=</span> <span class="n">err_print_prefix</span><span class="p">;</span>
		<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">KERN_CRIT</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Either a nondismissable error was detected or no</span>
<span class="cm">		 * recognized error was detected  in the logout frame </span>
<span class="cm">		 * -- report the error in either case</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span>
		       <span class="s">&quot;*System %s Error (Vector 0x%x) reported on CPU %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">SCB_Q_SYSERR</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;Correctable&quot;</span><span class="o">:</span><span class="s">&quot;Uncorrectable&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vector</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">smp_processor_id</span><span class="p">());</span>
		
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
		<span class="n">titan_process_logout_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="n">alpha_verbose_mcheck</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alpha_verbose_mcheck</span><span class="p">)</span>
			<span class="n">dik_show_regs</span><span class="p">(</span><span class="n">get_irq_regs</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

		<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">saved_err_prefix</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Convert any pending interrupts which report as system</span>
<span class="cm">		 * machine checks to interrupts</span>
<span class="cm">		 */</span>
		<span class="n">irqmask</span> <span class="o">=</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">c_dirx</span> <span class="o">&amp;</span> <span class="n">TITAN_MCHECK_INTERRUPT_MASK</span><span class="p">;</span>
		<span class="n">titan_dispatch_irqs</span><span class="p">(</span><span class="n">irqmask</span><span class="p">);</span>
	<span class="p">}</span>	


	<span class="cm">/* </span>
<span class="cm">	 * Release the logout frame </span>
<span class="cm">	 */</span>
	<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Subpacket Annotations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_titan_pchip0_extended_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span> 	<span class="s">&quot;P0_SCTL&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_SERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_APCTL&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_APERREN&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_AGPERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_ASPRST&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_AWSBA0&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_AWSBA1&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_AWSBA2&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_AWSBA3&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_AWSM0&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_AWSM1&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_AWSM2&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_AWSM3&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_ATBA0&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_ATBA1&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_ATBA2&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_ATBA3&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_GPCTL&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_GPERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GSPRST&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_GWSBA0&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_GWSBA1&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GWSBA2&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_GWSBA3&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_GWSM0&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GWSM1&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_GWSM2&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_GWSM3&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GTBA0&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_GTBA1&quot;</span><span class="p">,</span>	<span class="s">&quot;P0_GTBA2&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GTBA3&quot;</span><span class="p">,</span>		<span class="nb">NULL</span> 
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_titan_pchip1_extended_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span> 	<span class="s">&quot;P1_SCTL&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_SERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_APCTL&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_APERREN&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_AGPERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_ASPRST&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_AWSBA0&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_AWSBA1&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_AWSBA2&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_AWSBA3&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_AWSM0&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_AWSM1&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_AWSM2&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_AWSM3&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_ATBA0&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_ATBA1&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_ATBA2&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_ATBA3&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_GPCTL&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_GPERREN&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GSPRST&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_GWSBA0&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_GWSBA1&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GWSBA2&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_GWSBA3&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_GWSM0&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GWSM1&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_GWSM2&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_GWSM3&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GTBA0&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_GTBA1&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_GTBA2&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GTBA3&quot;</span><span class="p">,</span>		<span class="nb">NULL</span> 
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">el_titan_memory_extended_annotation</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Subpacket Header&quot;</span><span class="p">,</span> 	<span class="s">&quot;AAR0&quot;</span><span class="p">,</span>		<span class="s">&quot;AAR1&quot;</span><span class="p">,</span>
	<span class="s">&quot;AAR2&quot;</span><span class="p">,</span>			<span class="s">&quot;AAR3&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_SCTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;P0_GPCTL&quot;</span><span class="p">,</span>		<span class="s">&quot;P0_APCTL&quot;</span><span class="p">,</span>	<span class="s">&quot;P1_SCTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;P1_GPCTL&quot;</span><span class="p">,</span>		<span class="s">&quot;P1_SCTL&quot;</span><span class="p">,</span>	<span class="nb">NULL</span> 
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">el_subpacket_annotation</span> <span class="n">el_titan_annotations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">,</span>
			     <span class="n">EL_TYPE__REGATTA__TITAN_PCHIP0_EXTENDED</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;Titan PChip 0 Extended Frame&quot;</span><span class="p">,</span>
			     <span class="n">el_titan_pchip0_extended_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">,</span>
			     <span class="n">EL_TYPE__REGATTA__TITAN_PCHIP1_EXTENDED</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;Titan PChip 1 Extended Frame&quot;</span><span class="p">,</span>
			     <span class="n">el_titan_pchip1_extended_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">,</span>
			     <span class="n">EL_TYPE__REGATTA__TITAN_MEMORY_EXTENDED</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;Titan Memory Extended Frame&quot;</span><span class="p">,</span>
			     <span class="n">el_titan_memory_extended_annotation</span><span class="p">),</span>
	<span class="n">SUBPACKET_ANNOTATION</span><span class="p">(</span><span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">,</span>
			     <span class="n">EL_TYPE__TERMINATION__TERMINATION</span><span class="p">,</span>
			     <span class="mi">1</span><span class="p">,</span>
			     <span class="s">&quot;Termination Subpacket&quot;</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span>
<span class="nf">el_process_regatta_subpacket</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  ** Unexpected header CLASS %d TYPE %d, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="n">header</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EL_TYPE__REGATTA__PROCESSOR_ERROR_FRAME</span>:
	<span class="k">case</span> <span class="n">EL_TYPE__REGATTA__SYSTEM_ERROR_FRAME</span>:
	<span class="k">case</span> <span class="n">EL_TYPE__REGATTA__ENVIRONMENTAL_FRAME</span>:
	<span class="k">case</span> <span class="n">EL_TYPE__REGATTA__PROCESSOR_DBL_ERROR_HALT</span>:
	<span class="k">case</span> <span class="n">EL_TYPE__REGATTA__SYSTEM_DBL_ERROR_HALT</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  ** Occurred on CPU %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">regatta_frame</span><span class="p">.</span><span class="n">cpuid</span><span class="p">);</span>
		<span class="n">privateer_process_logout_frame</span><span class="p">((</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">by_type</span><span class="p">.</span><span class="n">regatta_frame</span><span class="p">.</span><span class="n">data_start</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  ** REGATTA TYPE %d SUBPACKET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">err_print_prefix</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">el_annotate_subpacket</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_subpacket</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">header</span> <span class="o">+</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span> 

<span class="k">static</span> <span class="k">struct</span> <span class="n">el_subpacket_handler</span> <span class="n">titan_subpacket_handler</span> <span class="o">=</span> 
	<span class="n">SUBPACKET_HANDLER_INIT</span><span class="p">(</span><span class="n">EL_CLASS__REGATTA_FAMILY</span><span class="p">,</span> 
			       <span class="n">el_process_regatta_subpacket</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">titan_register_error_handlers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span> <span class="p">(</span><span class="n">el_titan_annotations</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cdl_register_subpacket_annotation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">el_titan_annotations</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">cdl_register_subpacket_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">titan_subpacket_handler</span><span class="p">);</span>

	<span class="n">ev6_register_error_handlers</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Privateer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">privateer_process_680_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">mchk_header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_VERBOSE_MCHECK</span>
	<span class="k">struct</span> <span class="n">el_PRIVATEER_envdata_mcheck</span> <span class="o">*</span><span class="n">emchk</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">el_PRIVATEER_envdata_mcheck</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mchk_header</span> <span class="o">+</span> <span class="n">mchk_header</span><span class="o">-&gt;</span><span class="n">sys_offset</span><span class="p">);</span>

	<span class="cm">/* TODO - categorize errors, for now, no error */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">print</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* TODO - decode instead of just dumping... */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  Summary Flags:         %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
 	         <span class="s">&quot;  CChip DIRx:            %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  System Management IR:  %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  CPU IR:                %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  Power Supply IR:       %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  LM78 Fault Status:     %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  System Doors:          %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  Temperature Warning:   %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  Fan Control:           %016llx</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;  Fatal Power Down Code: %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">err_print_prefix</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">summary</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">c_dirx</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">smir</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">cpuir</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">psir</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">sys_doors</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">temp_warn</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">fan_ctrl</span><span class="p">,</span>
	       <span class="n">emchk</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_VERBOSE_MCHECK */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">privateer_process_logout_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">mchk_header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_common_EV6_mcheck</span> <span class="o">*</span><span class="n">ev6mchk</span> <span class="o">=</span> 
		<span class="p">(</span><span class="k">struct</span> <span class="n">el_common_EV6_mcheck</span> <span class="o">*</span><span class="p">)</span><span class="n">mchk_header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MCHK_DISPOSITION_UNKNOWN_ERROR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Machine check codes</span>
<span class="cm">	 */</span>
<span class="cp">#define PRIVATEER_MCHK__CORR_ECC		0x86	</span><span class="cm">/* 630 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__DC_TAG_PERR		0x9E	</span><span class="cm">/* 630 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__PAL_BUGCHECK		0x8E	</span><span class="cm">/* 670 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__OS_BUGCHECK		0x90	</span><span class="cm">/* 670 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__PROC_HRD_ERR		0x98	</span><span class="cm">/* 670 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__ISTREAM_CMOV_PRX	0xA0	</span><span class="cm">/* 670 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__ISTREAM_CMOV_FLT	0xA2	</span><span class="cm">/* 670 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__SYS_HRD_ERR		0x202	</span><span class="cm">/* 660 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__SYS_CORR_ERR		0x204	</span><span class="cm">/* 620 */</span><span class="cp"></span>
<span class="cp">#define PRIVATEER_MCHK__SYS_ENVIRON		0x206	</span><span class="cm">/* 680 */</span><span class="cp"></span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ev6mchk</span><span class="o">-&gt;</span><span class="n">MCHK_Code</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Vector 630 - Processor, Correctable</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__CORR_ECC</span>:
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__DC_TAG_PERR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Fall through to vector 670 for processing...</span>
<span class="cm">		 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Vector 670 - Processor, Uncorrectable</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__PAL_BUGCHECK</span>:
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__OS_BUGCHECK</span>:
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__PROC_HRD_ERR</span>:
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__ISTREAM_CMOV_PRX</span>:
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__ISTREAM_CMOV_FLT</span>:
		<span class="n">status</span> <span class="o">|=</span> <span class="n">ev6_process_logout_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Vector 620 - System, Correctable</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__SYS_CORR_ERR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Fall through to vector 660 for processing...</span>
<span class="cm">		 */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Vector 660 - System, Uncorrectable</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__SYS_HRD_ERR</span>:
		<span class="n">status</span> <span class="o">|=</span> <span class="n">titan_process_logout_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Vector 680 - System, Environmental</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">PRIVATEER_MCHK__SYS_ENVIRON</span>:	<span class="cm">/* System, Environmental */</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">privateer_process_680_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="n">print</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Unknown</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">MCHK_DISPOSITION_REPORT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s** Unknown Error, frame follows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			       <span class="n">err_print_prefix</span><span class="p">);</span>
			<span class="n">mchk_dump_logout_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">privateer_machine_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">la_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="n">mchk_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">el_common</span> <span class="o">*</span><span class="p">)</span><span class="n">la_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="n">tmchk</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">el_TITAN_sysdata_mcheck</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">la_ptr</span> <span class="o">+</span> <span class="n">mchk_header</span><span class="o">-&gt;</span><span class="n">sys_offset</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">irqmask</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">saved_err_prefix</span> <span class="o">=</span> <span class="n">err_print_prefix</span><span class="p">;</span>

<span class="cp">#define PRIVATEER_680_INTERRUPT_MASK		(0xE00UL)</span>
<span class="cp">#define PRIVATEER_HOTPLUG_INTERRUPT_MASK	(0xE00UL)</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sync the processor.</span>
<span class="cm">	 */</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">draina</span><span class="p">();</span>

	<span class="cm">/* </span>
<span class="cm">	 * Only handle system events here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">!=</span> <span class="n">SCB_Q_SYSEVENT</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">titan_machine_check</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">la_ptr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Report the event - System Events should be reported even if no</span>
<span class="cm">	 * error is indicated since the event could indicate the return</span>
<span class="cm">	 * to normal status.</span>
<span class="cm">	 */</span>
	<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">KERN_CRIT</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s*System Event (Vector 0x%x) reported on CPU %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	       <span class="n">err_print_prefix</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">vector</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">smp_processor_id</span><span class="p">());</span>
	<span class="n">privateer_process_680_frame</span><span class="p">(</span><span class="n">mchk_header</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">err_print_prefix</span> <span class="o">=</span> <span class="n">saved_err_prefix</span><span class="p">;</span>
	
	<span class="cm">/* </span>
<span class="cm">	 * Convert any pending interrupts which report as 680 machine</span>
<span class="cm">	 * checks to interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">irqmask</span> <span class="o">=</span> <span class="n">tmchk</span><span class="o">-&gt;</span><span class="n">c_dirx</span> <span class="o">&amp;</span> <span class="n">PRIVATEER_680_INTERRUPT_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dispatch the interrupt(s).</span>
<span class="cm">	 */</span>
	<span class="n">titan_dispatch_irqs</span><span class="p">(</span><span class="n">irqmask</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Release the logout frame.</span>
<span class="cm">	 */</span>
	<span class="n">wrmces</span><span class="p">(</span><span class="mh">0x7</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
