<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › lib › memcpy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>memcpy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/alpha/lib/memcpy.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1995  Linus Torvalds</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This is a reasonably optimized memcpy() routine.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Note that the C code is written to be optimized into good assembly. However,</span>
<span class="cm"> * at this point gcc is unable to sanely compile &quot;if (n &gt;= 0)&quot;, resulting in a</span>
<span class="cm"> * explicit compare against 0 (instead of just using the proper &quot;blt reg, xx&quot; or</span>
<span class="cm"> * &quot;bge reg, xx&quot;). I hope alpha-gcc will be fixed to notice this eventually..</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * This should be done in one go with ldq_u*2/mask/stq_u. Do it</span>
<span class="cm"> * with a macro so that we can fix it up later..</span>
<span class="cm"> */</span>
<span class="cp">#define ALIGN_DEST_TO8_UP(d,s,n) \</span>
<span class="cp">	while (d &amp; 7) { \</span>
<span class="cp">		if (n &lt;= 0) return; \</span>
<span class="cp">		n--; \</span>
<span class="cp">		*(char *) d = *(char *) s; \</span>
<span class="cp">		d++; s++; \</span>
<span class="cp">	}</span>
<span class="cp">#define ALIGN_DEST_TO8_DN(d,s,n) \</span>
<span class="cp">	while (d &amp; 7) { \</span>
<span class="cp">		if (n &lt;= 0) return; \</span>
<span class="cp">		n--; \</span>
<span class="cp">		d--; s--; \</span>
<span class="cp">		*(char *) d = *(char *) s; \</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * This should similarly be done with ldq_u*2/mask/stq. The destination</span>
<span class="cm"> * is aligned, but we don&#39;t fill in a full quad-word</span>
<span class="cm"> */</span>
<span class="cp">#define DO_REST_UP(d,s,n) \</span>
<span class="cp">	while (n &gt; 0) { \</span>
<span class="cp">		n--; \</span>
<span class="cp">		*(char *) d = *(char *) s; \</span>
<span class="cp">		d++; s++; \</span>
<span class="cp">	}</span>
<span class="cp">#define DO_REST_DN(d,s,n) \</span>
<span class="cp">	while (n &gt; 0) { \</span>
<span class="cp">		n--; \</span>
<span class="cp">		d--; s--; \</span>
<span class="cp">		*(char *) d = *(char *) s; \</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * This should be done with ldq/mask/stq. The source and destination are</span>
<span class="cm"> * aligned, but we don&#39;t fill in a full quad-word</span>
<span class="cm"> */</span>
<span class="cp">#define DO_REST_ALIGNED_UP(d,s,n) DO_REST_UP(d,s,n)</span>
<span class="cp">#define DO_REST_ALIGNED_DN(d,s,n) DO_REST_DN(d,s,n)</span>

<span class="cm">/*</span>
<span class="cm"> * This does unaligned memory copies. We want to avoid storing to</span>
<span class="cm"> * an unaligned address, as that would do a read-modify-write cycle.</span>
<span class="cm"> * We also want to avoid double-reading the unaligned reads.</span>
<span class="cm"> *</span>
<span class="cm"> * Note the ordering to try to avoid load (and address generation) latencies.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__memcpy_unaligned_up</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span>
					  <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ALIGN_DEST_TO8_UP</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>			<span class="cm">/* to avoid compare against 8 in the loop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">low_word</span><span class="p">,</span> <span class="n">high_word</span><span class="p">;</span>
		<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldq_u %0,%1&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">low_word</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">));</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldq_u %0,%1&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">high_word</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">s</span><span class="o">+</span><span class="mi">8</span><span class="p">)));</span>
			<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;extql %1,%2,%0&quot;</span>
				<span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">low_word</span><span class="p">)</span>
				<span class="o">:</span><span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">low_word</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">s</span><span class="p">));</span>
			<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;extqh %1,%2,%0&quot;</span>
				<span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
				<span class="o">:</span><span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">high_word</span><span class="p">),</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">s</span><span class="p">));</span>
			<span class="n">s</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span> <span class="n">low_word</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">low_word</span> <span class="o">=</span> <span class="n">high_word</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">DO_REST_UP</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__memcpy_unaligned_dn</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span>
					  <span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* I don&#39;t understand AXP assembler well enough for this. -Tim */</span>
	<span class="n">s</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">--</span><span class="n">d</span> <span class="o">=</span> <span class="o">*</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">--</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Hmm.. Strange. The __asm__ here is there to make gcc use an integer register</span>
<span class="cm"> * for the load-store. I don&#39;t know why, but it would seem that using a floating</span>
<span class="cm"> * point register for the move seems to slow things down (very small difference,</span>
<span class="cm"> * though).</span>
<span class="cm"> *</span>
<span class="cm"> * Note the ordering to try to avoid load (and address generation) latencies.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__memcpy_aligned_up</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span>
					<span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ALIGN_DEST_TO8_UP</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldq %0,%1&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">));</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">DO_REST_ALIGNED_UP</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__memcpy_aligned_dn</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">,</span>
					<span class="kt">long</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">ALIGN_DEST_TO8_DN</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
	<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;ldq %0,%1&quot;</span><span class="o">:</span><span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;m&quot;</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">));</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">DO_REST_ALIGNED_DN</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span> <span class="nf">memcpy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dest</span> <span class="o">^</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__memcpy_aligned_up</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dest</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src</span><span class="p">,</span>
				     <span class="n">n</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__memcpy_unaligned_up</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dest</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">src</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* For backward modules compatibility, define __memcpy.  */</span>
<span class="n">asm</span><span class="p">(</span><span class="s">&quot;__memcpy = memcpy; .globl __memcpy&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
