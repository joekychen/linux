<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › include › asm › core_t2.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>core_t2.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __ALPHA_T2__H__</span>
<span class="cp">#define __ALPHA_T2__H__</span>

<span class="cm">/* Fit everything into one 128MB HAE window. */</span>
<span class="cp">#define T2_ONE_HAE_WINDOW 1</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;asm/compiler.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * T2 is the internal name for the core logic chipset which provides</span>
<span class="cm"> * memory controller and PCI access for the SABLE-based systems.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is based on:</span>
<span class="cm"> *</span>
<span class="cm"> * SABLE I/O Specification</span>
<span class="cm"> * Revision/Update Information: 1.3</span>
<span class="cm"> *</span>
<span class="cm"> * jestabro@amt.tay1.dec.com Initial Version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define T2_MEM_R1_MASK 0x07ffffff  </span><span class="cm">/* Mem sparse region 1 mask is 27 bits */</span><span class="cp"></span>

<span class="cm">/* GAMMA-SABLE is a SABLE with EV5-based CPUs */</span>
<span class="cm">/* All LYNX machines, EV4 or EV5, use the GAMMA bias also */</span>
<span class="cp">#define _GAMMA_BIAS		0x8000000000UL</span>

<span class="cp">#if defined(CONFIG_ALPHA_GENERIC)</span>
<span class="cp">#define GAMMA_BIAS		alpha_mv.sys.t2.gamma_bias</span>
<span class="cp">#elif defined(CONFIG_ALPHA_GAMMA)</span>
<span class="cp">#define GAMMA_BIAS		_GAMMA_BIAS</span>
<span class="cp">#else</span>
<span class="cp">#define GAMMA_BIAS		0</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Memory spaces:</span>
<span class="cm"> */</span>
<span class="cp">#define T2_CONF		        (IDENT_ADDR + GAMMA_BIAS + 0x390000000UL)</span>
<span class="cp">#define T2_IO			(IDENT_ADDR + GAMMA_BIAS + 0x3a0000000UL)</span>
<span class="cp">#define T2_SPARSE_MEM		(IDENT_ADDR + GAMMA_BIAS + 0x200000000UL)</span>
<span class="cp">#define T2_DENSE_MEM	        (IDENT_ADDR + GAMMA_BIAS + 0x3c0000000UL)</span>

<span class="cp">#define T2_IOCSR		(IDENT_ADDR + GAMMA_BIAS + 0x38e000000UL)</span>
<span class="cp">#define T2_CERR1		(IDENT_ADDR + GAMMA_BIAS + 0x38e000020UL)</span>
<span class="cp">#define T2_CERR2		(IDENT_ADDR + GAMMA_BIAS + 0x38e000040UL)</span>
<span class="cp">#define T2_CERR3		(IDENT_ADDR + GAMMA_BIAS + 0x38e000060UL)</span>
<span class="cp">#define T2_PERR1		(IDENT_ADDR + GAMMA_BIAS + 0x38e000080UL)</span>
<span class="cp">#define T2_PERR2		(IDENT_ADDR + GAMMA_BIAS + 0x38e0000a0UL)</span>
<span class="cp">#define T2_PSCR			(IDENT_ADDR + GAMMA_BIAS + 0x38e0000c0UL)</span>
<span class="cp">#define T2_HAE_1		(IDENT_ADDR + GAMMA_BIAS + 0x38e0000e0UL)</span>
<span class="cp">#define T2_HAE_2		(IDENT_ADDR + GAMMA_BIAS + 0x38e000100UL)</span>
<span class="cp">#define T2_HBASE		(IDENT_ADDR + GAMMA_BIAS + 0x38e000120UL)</span>
<span class="cp">#define T2_WBASE1		(IDENT_ADDR + GAMMA_BIAS + 0x38e000140UL)</span>
<span class="cp">#define T2_WMASK1		(IDENT_ADDR + GAMMA_BIAS + 0x38e000160UL)</span>
<span class="cp">#define T2_TBASE1		(IDENT_ADDR + GAMMA_BIAS + 0x38e000180UL)</span>
<span class="cp">#define T2_WBASE2		(IDENT_ADDR + GAMMA_BIAS + 0x38e0001a0UL)</span>
<span class="cp">#define T2_WMASK2		(IDENT_ADDR + GAMMA_BIAS + 0x38e0001c0UL)</span>
<span class="cp">#define T2_TBASE2		(IDENT_ADDR + GAMMA_BIAS + 0x38e0001e0UL)</span>
<span class="cp">#define T2_TLBBR		(IDENT_ADDR + GAMMA_BIAS + 0x38e000200UL)</span>
<span class="cp">#define T2_IVR			(IDENT_ADDR + GAMMA_BIAS + 0x38e000220UL)</span>
<span class="cp">#define T2_HAE_3		(IDENT_ADDR + GAMMA_BIAS + 0x38e000240UL)</span>
<span class="cp">#define T2_HAE_4		(IDENT_ADDR + GAMMA_BIAS + 0x38e000260UL)</span>

<span class="cm">/* The CSRs below are T3/T4 only */</span>
<span class="cp">#define T2_WBASE3		(IDENT_ADDR + GAMMA_BIAS + 0x38e000280UL)</span>
<span class="cp">#define T2_WMASK3		(IDENT_ADDR + GAMMA_BIAS + 0x38e0002a0UL)</span>
<span class="cp">#define T2_TBASE3		(IDENT_ADDR + GAMMA_BIAS + 0x38e0002c0UL)</span>

<span class="cp">#define T2_TDR0			(IDENT_ADDR + GAMMA_BIAS + 0x38e000300UL)</span>
<span class="cp">#define T2_TDR1			(IDENT_ADDR + GAMMA_BIAS + 0x38e000320UL)</span>
<span class="cp">#define T2_TDR2			(IDENT_ADDR + GAMMA_BIAS + 0x38e000340UL)</span>
<span class="cp">#define T2_TDR3			(IDENT_ADDR + GAMMA_BIAS + 0x38e000360UL)</span>
<span class="cp">#define T2_TDR4			(IDENT_ADDR + GAMMA_BIAS + 0x38e000380UL)</span>
<span class="cp">#define T2_TDR5			(IDENT_ADDR + GAMMA_BIAS + 0x38e0003a0UL)</span>
<span class="cp">#define T2_TDR6			(IDENT_ADDR + GAMMA_BIAS + 0x38e0003c0UL)</span>
<span class="cp">#define T2_TDR7			(IDENT_ADDR + GAMMA_BIAS + 0x38e0003e0UL)</span>

<span class="cp">#define T2_WBASE4		(IDENT_ADDR + GAMMA_BIAS + 0x38e000400UL)</span>
<span class="cp">#define T2_WMASK4		(IDENT_ADDR + GAMMA_BIAS + 0x38e000420UL)</span>
<span class="cp">#define T2_TBASE4		(IDENT_ADDR + GAMMA_BIAS + 0x38e000440UL)</span>

<span class="cp">#define T2_AIR			(IDENT_ADDR + GAMMA_BIAS + 0x38e000460UL)</span>
<span class="cp">#define T2_VAR			(IDENT_ADDR + GAMMA_BIAS + 0x38e000480UL)</span>
<span class="cp">#define T2_DIR			(IDENT_ADDR + GAMMA_BIAS + 0x38e0004a0UL)</span>
<span class="cp">#define T2_ICE			(IDENT_ADDR + GAMMA_BIAS + 0x38e0004c0UL)</span>

<span class="cp">#ifndef T2_ONE_HAE_WINDOW</span>
<span class="cp">#define T2_HAE_ADDRESS		T2_HAE_1</span>
<span class="cp">#endif</span>

<span class="cm">/*  T2 CSRs are in the non-cachable primary IO space from 3.8000.0000 to</span>
<span class="cm"> 3.8fff.ffff</span>
<span class="cm"> *</span>
<span class="cm"> *  +--------------+ 3 8000 0000</span>
<span class="cm"> *  | CPU 0 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8100 0000</span>
<span class="cm"> *  | CPU 1 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8200 0000</span>
<span class="cm"> *  | CPU 2 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8300 0000</span>
<span class="cm"> *  | CPU 3 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8400 0000</span>
<span class="cm"> *  | CPU Reserved |</span>
<span class="cm"> *  +--------------+ 3 8700 0000</span>
<span class="cm"> *  | Mem Reserved |</span>
<span class="cm"> *  +--------------+ 3 8800 0000</span>
<span class="cm"> *  | Mem 0 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8900 0000</span>
<span class="cm"> *  | Mem 1 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8a00 0000</span>
<span class="cm"> *  | Mem 2 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8b00 0000</span>
<span class="cm"> *  | Mem 3 CSRs   |</span>
<span class="cm"> *  +--------------+ 3 8c00 0000</span>
<span class="cm"> *  | Mem Reserved |</span>
<span class="cm"> *  +--------------+ 3 8e00 0000</span>
<span class="cm"> *  | PCI Bridge   |</span>
<span class="cm"> *  +--------------+ 3 8f00 0000</span>
<span class="cm"> *  | Expansion IO |</span>
<span class="cm"> *  +--------------+ 3 9000 0000</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define T2_CPU0_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x380000000L)</span>
<span class="cp">#define T2_CPU1_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x381000000L)</span>
<span class="cp">#define T2_CPU2_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x382000000L)</span>
<span class="cp">#define T2_CPU3_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x383000000L)</span>

<span class="cp">#define T2_CPUn_BASE(n)		(T2_CPU0_BASE + (((n)&amp;3) * 0x001000000L))</span>

<span class="cp">#define T2_MEM0_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x388000000L)</span>
<span class="cp">#define T2_MEM1_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x389000000L)</span>
<span class="cp">#define T2_MEM2_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x38a000000L)</span>
<span class="cp">#define T2_MEM3_BASE            (IDENT_ADDR + GAMMA_BIAS + 0x38b000000L)</span>


<span class="cm">/*</span>
<span class="cm"> * Sable CPU Module CSRS</span>
<span class="cm"> *</span>
<span class="cm"> * These are CSRs for hardware other than the CPU chip on the CPU module.</span>
<span class="cm"> * The CPU module has Backup Cache control logic, Cbus control logic, and</span>
<span class="cm"> * interrupt control logic on it.  There is a duplicate tag store to speed</span>
<span class="cm"> * up maintaining cache coherency.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">sable_cpu_csr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bcc</span><span class="p">;</span>     <span class="kt">long</span> <span class="n">fill_00</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Backup Cache Control */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bcce</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_01</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Backup Cache Correctable Error */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bccea</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_02</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* B-Cache Corr Err Address Latch */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bcue</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_03</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* B-Cache Uncorrectable Error */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bcuea</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_04</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* B-Cache Uncorr Err Addr Latch */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dter</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_05</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Duplicate Tag Error */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbctl</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_06</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CBus Control */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbe</span><span class="p">;</span>     <span class="kt">long</span> <span class="n">fill_07</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CBus Error */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbeal</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_08</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CBus Error Addr Latch low */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cbeah</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_09</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CBus Error Addr Latch high */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pmbx</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_10</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Processor Mailbox */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ipir</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_11</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Inter-Processor Int Request */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sic</span><span class="p">;</span>     <span class="kt">long</span> <span class="n">fill_12</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* System Interrupt Clear */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adlk</span><span class="p">;</span>    <span class="kt">long</span> <span class="n">fill_13</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Address Lock (LDxL/STxC) */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">madrl</span><span class="p">;</span>   <span class="kt">long</span> <span class="n">fill_14</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CBus Miss Address */</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rev</span><span class="p">;</span>     <span class="kt">long</span> <span class="n">fill_15</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* CMIC Revision */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Data structure for handling T2 machine checks:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elcf_fid</span><span class="p">;</span>	<span class="cm">/* Frame ID (from above) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elcf_size</span><span class="p">;</span>	<span class="cm">/* Size of frame in bytes */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">el_t2_procdata_mcheck</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_paltemp</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/* PAL TEMP REGS. */</span>
	<span class="cm">/* EV4-specific fields */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_exc_addr</span><span class="p">;</span>	<span class="cm">/* Addr of excepting insn. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_exc_sum</span><span class="p">;</span>	<span class="cm">/* Summary of arith traps. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_exc_mask</span><span class="p">;</span>	<span class="cm">/* Exception mask (from exc_sum). */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_iccsr</span><span class="p">;</span>	<span class="cm">/* IBox hardware enables. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_pal_base</span><span class="p">;</span>	<span class="cm">/* Base address for PALcode. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_hier</span><span class="p">;</span>	<span class="cm">/* Hardware Interrupt Enable. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_hirr</span><span class="p">;</span>	<span class="cm">/* Hardware Interrupt Request. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_mm_csr</span><span class="p">;</span>	<span class="cm">/* D-stream fault info. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_dc_stat</span><span class="p">;</span>	<span class="cm">/* D-cache status (ECC/Parity Err). */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_dc_addr</span><span class="p">;</span>	<span class="cm">/* EV3 Phys Addr for ECC/DPERR. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_abox_ctl</span><span class="p">;</span>	<span class="cm">/* ABox Control Register. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_biu_stat</span><span class="p">;</span>	<span class="cm">/* BIU Status. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_biu_addr</span><span class="p">;</span>	<span class="cm">/* BUI Address. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_biu_ctl</span><span class="p">;</span>	<span class="cm">/* BIU Control. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_fill_syndrome</span><span class="p">;</span> <span class="cm">/* For correcting ECC errors. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_fill_addr</span><span class="p">;</span><span class="cm">/* Cache block which was being read. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_va</span><span class="p">;</span>	<span class="cm">/* Effective VA of fault or miss. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">elfmc_bc_tag</span><span class="p">;</span>	<span class="cm">/* Backup Cache Tag Probe Results. */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sable processor specific Machine Check Data segment.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">el_t2_logout_header</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_size</span><span class="p">;</span>	<span class="cm">/* size in bytes of logout area. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_sbz1</span><span class="o">:</span><span class="mi">31</span><span class="p">;</span>	<span class="cm">/* Should be zero. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_retry</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Retry flag. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_procoffset</span><span class="p">;</span> <span class="cm">/* Processor-specific offset. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_sysoffset</span><span class="p">;</span>	 <span class="cm">/* Offset of system-specific. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_error_type</span><span class="p">;</span>	<span class="cm">/* PAL error type code. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">elfl_frame_rev</span><span class="p">;</span>		<span class="cm">/* PAL Frame revision. */</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">el_t2_sysdata_mcheck</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_bcc</span><span class="p">;</span>	      <span class="cm">/* CSR 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_bcce</span><span class="p">;</span>	      <span class="cm">/* CSR 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_bccea</span><span class="p">;</span>      <span class="cm">/* CSR 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_bcue</span><span class="p">;</span>	      <span class="cm">/* CSR 3 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_bcuea</span><span class="p">;</span>      <span class="cm">/* CSR 4 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_dter</span><span class="p">;</span>	      <span class="cm">/* CSR 5 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_cbctl</span><span class="p">;</span>      <span class="cm">/* CSR 6 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_cbe</span><span class="p">;</span>	      <span class="cm">/* CSR 7 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_cbeal</span><span class="p">;</span>      <span class="cm">/* CSR 8 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_cbeah</span><span class="p">;</span>      <span class="cm">/* CSR 9 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_pmbx</span><span class="p">;</span>	      <span class="cm">/* CSR 10 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_ipir</span><span class="p">;</span>	      <span class="cm">/* CSR 11 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_sic</span><span class="p">;</span>	      <span class="cm">/* CSR 12 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_adlk</span><span class="p">;</span>	      <span class="cm">/* CSR 13 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_madrl</span><span class="p">;</span>      <span class="cm">/* CSR 14 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">elcmc_crrev4</span><span class="p">;</span>     <span class="cm">/* CSR 15 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sable memory error frame - sable pfms section 3.42</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_data_memory</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">el_t2_frame_header</span> <span class="n">elcm_hdr</span><span class="p">;</span>	<span class="cm">/* ID$MEM-FERR = 0x08 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">elcm_module</span><span class="p">;</span>	<span class="cm">/* Module id. */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">elcm_res04</span><span class="p">;</span>	<span class="cm">/* Reserved. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_merr</span><span class="p">;</span>	<span class="cm">/* CSR0: Error Reg 1. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_mcmd1</span><span class="p">;</span>	<span class="cm">/* CSR1: Command Trap 1. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_mcmd2</span><span class="p">;</span>	<span class="cm">/* CSR2: Command Trap 2. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_mconf</span><span class="p">;</span>	<span class="cm">/* CSR3: Configuration. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_medc1</span><span class="p">;</span>	<span class="cm">/* CSR4: EDC Status 1. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_medc2</span><span class="p">;</span>	<span class="cm">/* CSR5: EDC Status 2. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_medcc</span><span class="p">;</span>	<span class="cm">/* CSR6: EDC Control. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_msctl</span><span class="p">;</span>	<span class="cm">/* CSR7: Stream Buffer Control. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_mref</span><span class="p">;</span>	<span class="cm">/* CSR8: Refresh Control. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcm_filter</span><span class="p">;</span>	<span class="cm">/* CSR9: CRD Filter Control. */</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Sable other CPU error frame - sable pfms section 3.43</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_data_other_cpu</span> <span class="p">{</span>
	<span class="kt">short</span>	      <span class="n">elco_cpuid</span><span class="p">;</span>	<span class="cm">/* CPU ID */</span>
	<span class="kt">short</span>	      <span class="n">elco_res02</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_bcc</span><span class="p">;</span>	<span class="cm">/* CSR 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_bcce</span><span class="p">;</span>	<span class="cm">/* CSR 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_bccea</span><span class="p">;</span>	<span class="cm">/* CSR 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_bcue</span><span class="p">;</span>	<span class="cm">/* CSR 3 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_bcuea</span><span class="p">;</span>	<span class="cm">/* CSR 4 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_dter</span><span class="p">;</span>	<span class="cm">/* CSR 5 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_cbctl</span><span class="p">;</span>	<span class="cm">/* CSR 6 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_cbe</span><span class="p">;</span>	<span class="cm">/* CSR 7 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_cbeal</span><span class="p">;</span>	<span class="cm">/* CSR 8 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_cbeah</span><span class="p">;</span>	<span class="cm">/* CSR 9 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_pmbx</span><span class="p">;</span>	<span class="cm">/* CSR 10 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_ipir</span><span class="p">;</span>	<span class="cm">/* CSR 11 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_sic</span><span class="p">;</span>	<span class="cm">/* CSR 12 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_adlk</span><span class="p">;</span>	<span class="cm">/* CSR 13 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_madrl</span><span class="p">;</span>	<span class="cm">/* CSR 14 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elco_crrev4</span><span class="p">;</span>	<span class="cm">/* CSR 15 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sable other CPU error frame - sable pfms section 3.44</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_data_t2</span><span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="n">elct_hdr</span><span class="p">;</span>	<span class="cm">/* ID$T2-FRAME */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_iocsr</span><span class="p">;</span>	<span class="cm">/* IO Control and Status Register */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_cerr1</span><span class="p">;</span>	<span class="cm">/* Cbus Error Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_cerr2</span><span class="p">;</span>	<span class="cm">/* Cbus Error Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_cerr3</span><span class="p">;</span>	<span class="cm">/* Cbus Error Register 3 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_perr1</span><span class="p">;</span>	<span class="cm">/* PCI Error Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_perr2</span><span class="p">;</span>	<span class="cm">/* PCI Error Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_hae0_1</span><span class="p">;</span>	<span class="cm">/* High Address Extension Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_hae0_2</span><span class="p">;</span>	<span class="cm">/* High Address Extension Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_hbase</span><span class="p">;</span>	<span class="cm">/* High Base Register */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_wbase1</span><span class="p">;</span>	<span class="cm">/* Window Base Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_wmask1</span><span class="p">;</span>	<span class="cm">/* Window Mask Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tbase1</span><span class="p">;</span>	<span class="cm">/* Translated Base Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_wbase2</span><span class="p">;</span>	<span class="cm">/* Window Base Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_wmask2</span><span class="p">;</span>	<span class="cm">/* Window Mask Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tbase2</span><span class="p">;</span>	<span class="cm">/* Translated Base Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr0</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr1</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr2</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 2 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr3</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 3 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr4</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 4 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr5</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 5 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr6</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 6 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elct_tdr7</span><span class="p">;</span>	<span class="cm">/* TLB Data Register 7 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sable error log data structure - sable pfms section 3.40</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_data_corrected</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_biu_stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_biu_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_biu_ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_fill_syndrome</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_fill_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elcpb_bc_tag</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sable error log data structure</span>
<span class="cm"> * Note there are 4 memory slots on sable (see t2.h)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_frame_mcheck</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="n">elfmc_header</span><span class="p">;</span>	<span class="cm">/* ID$P-FRAME_MCHECK */</span>
	<span class="k">struct</span> <span class="n">el_t2_logout_header</span> <span class="n">elfmc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_t2_procdata_mcheck</span> <span class="n">elfmc_procdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_t2_sysdata_mcheck</span> <span class="n">elfmc_sysdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_t2_data_t2</span> <span class="n">elfmc_t2data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_t2_data_memory</span> <span class="n">elfmc_memdata</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="n">elfmc_footer</span><span class="p">;</span>	<span class="cm">/* empty */</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Sable error log data structures on memory errors</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_t2_frame_corrected</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="n">elfcc_header</span><span class="p">;</span>	<span class="cm">/* ID$P-BC-COR */</span>
	<span class="k">struct</span> <span class="n">el_t2_logout_header</span> <span class="n">elfcc_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_t2_data_corrected</span> <span class="n">elfcc_procdata</span><span class="p">;</span>
<span class="cm">/*	struct el_t2_data_t2 elfcc_t2data;		*/</span>
<span class="cm">/*	struct el_t2_data_memory elfcc_memdata[4];	*/</span>
	<span class="k">struct</span> <span class="n">el_t2_frame_header</span> <span class="n">elfcc_footer</span><span class="p">;</span>	<span class="cm">/* empty */</span>
<span class="p">};</span>


<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#ifndef __EXTERN_INLINE</span>
<span class="cp">#define __EXTERN_INLINE extern inline</span>
<span class="cp">#define __IO_EXTERN_INLINE</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * I/O functions:</span>
<span class="cm"> *</span>
<span class="cm"> * T2 (the core logic PCI/memory support chipset for the SABLE</span>
<span class="cm"> * series of processors uses a sparse address mapping scheme to</span>
<span class="cm"> * get at PCI memory and I/O.</span>
<span class="cm"> */</span>

<span class="cp">#define vip	volatile int *</span>
<span class="cp">#define vuip	volatile unsigned int *</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">t2_inb</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extbl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t2_outb</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_insbl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">t2_inw</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extwl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t2_outw</span><span class="p">(</span><span class="n">u16</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_inswl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">t2_inl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">t2_outl</span><span class="p">(</span><span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_IO</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Memory functions.</span>
<span class="cm"> *</span>
<span class="cm"> * For reading and writing 8 and 16 bit quantities we need to</span>
<span class="cm"> * go through one of the three sparse address mapping regions</span>
<span class="cm"> * and use the HAE_MEM CSR to provide some bits of the address.</span>
<span class="cm"> * The following few routines use only sparse address region 1</span>
<span class="cm"> * which gives 1Gbyte of accessible space which relates exactly</span>
<span class="cm"> * to the amount of PCI memory mapping *into* system address space.</span>
<span class="cm"> * See p 6-17 of the specification but it looks something like this:</span>
<span class="cm"> *</span>
<span class="cm"> * 21164 Address:</span>
<span class="cm"> *</span>
<span class="cm"> *          3         2         1</span>
<span class="cm"> * 9876543210987654321098765432109876543210</span>
<span class="cm"> * 1ZZZZ0.PCI.QW.Address............BBLL</span>
<span class="cm"> *</span>
<span class="cm"> * ZZ = SBZ</span>
<span class="cm"> * BB = Byte offset</span>
<span class="cm"> * LL = Transfer length</span>
<span class="cm"> *</span>
<span class="cm"> * PCI Address:</span>
<span class="cm"> *</span>
<span class="cm"> * 3         2         1</span>
<span class="cm"> * 10987654321098765432109876543210</span>
<span class="cm"> * HHH....PCI.QW.Address........ 00</span>
<span class="cm"> *</span>
<span class="cm"> * HHH = 31:29 HAE_MEM CSR</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifdef T2_ONE_HAE_WINDOW</span>
<span class="cp">#define t2_set_hae</span>
<span class="cp">#else</span>
<span class="cp">#define t2_set_hae { \</span>
<span class="cp">	unsigned long msb = addr &gt;&gt; 27; \</span>
<span class="cp">	addr &amp;= T2_MEM_R1_MASK; \</span>
<span class="cp">	set_hae(msb); \</span>
<span class="cp">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: take T2_DENSE_MEM off in each readX/writeX routine, since</span>
<span class="cm"> *       they may be called directly, rather than through the</span>
<span class="cm"> *       ioreadNN/iowriteNN routines.</span>
<span class="cm"> */</span>

<span class="n">__EXTERN_INLINE</span> <span class="n">u8</span> <span class="nf">t2_readb</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extbl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="n">u16</span> <span class="nf">t2_readw</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extwl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On SABLE with T2, we must use SPARSE memory even for 32-bit access,</span>
<span class="cm"> * because we cannot access all of DENSE without changing its HAE.</span>
<span class="cm"> */</span>
<span class="n">__EXTERN_INLINE</span> <span class="n">u32</span> <span class="nf">t2_readl</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="n">u64</span> <span class="nf">t2_readq</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">work</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">work</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="n">r0</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)(</span><span class="n">work</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)(</span><span class="n">work</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">r1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">r0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">t2_writeb</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_insbl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">t2_writew</span><span class="p">(</span><span class="n">u16</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_inswl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On SABLE with T2, we must use SPARSE memory even for 32-bit access,</span>
<span class="cm"> * because we cannot access all of DENSE without changing its HAE.</span>
<span class="cm"> */</span>
<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">t2_writel</span><span class="p">(</span><span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">t2_writeq</span><span class="p">(</span><span class="n">u64</span> <span class="n">b</span><span class="p">,</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span> <span class="o">-</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">work</span><span class="p">;</span>

	<span class="n">t2_set_hae</span><span class="p">;</span>

	<span class="n">work</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">T2_SPARSE_MEM</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">work</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)(</span><span class="n">work</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">t2_ioportmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">T2_IO</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">t2_ioremap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> 
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">T2_DENSE_MEM</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">int</span> <span class="nf">t2_is_ioaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">int</span> <span class="nf">t2_is_mmio</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">T2_DENSE_MEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* New-style ioread interface.  The mmio routines are so ugly for T2 that</span>
<span class="cm">   it doesn&#39;t make sense to merge the pio and mmio routines.  */</span>

<span class="cp">#define IOPORT(OS, NS)							\</span>
<span class="cp">__EXTERN_INLINE unsigned int t2_ioread##NS(void __iomem *xaddr)		\</span>
<span class="cp">{									\</span>
<span class="cp">	if (t2_is_mmio(xaddr))						\</span>
<span class="cp">		return t2_read##OS(xaddr);				\</span>
<span class="cp">	else								\</span>
<span class="cp">		return t2_in##OS((unsigned long)xaddr - T2_IO);		\</span>
<span class="cp">}									\</span>
<span class="cp">__EXTERN_INLINE void t2_iowrite##NS(u##NS b, void __iomem *xaddr)	\</span>
<span class="cp">{									\</span>
<span class="cp">	if (t2_is_mmio(xaddr))						\</span>
<span class="cp">		t2_write##OS(b, xaddr);					\</span>
<span class="cp">	else								\</span>
<span class="cp">		t2_out##OS(b, (unsigned long)xaddr - T2_IO);		\</span>
<span class="cp">}</span>

<span class="n">IOPORT</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">IOPORT</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">IOPORT</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

<span class="cp">#undef IOPORT</span>

<span class="cp">#undef vip</span>
<span class="cp">#undef vuip</span>

<span class="cp">#undef __IO_PREFIX</span>
<span class="cp">#define __IO_PREFIX		t2</span>
<span class="cp">#define t2_trivial_rw_bw	0</span>
<span class="cp">#define t2_trivial_rw_lq	0</span>
<span class="cp">#define t2_trivial_io_bw	0</span>
<span class="cp">#define t2_trivial_io_lq	0</span>
<span class="cp">#define t2_trivial_iounmap	1</span>
<span class="cp">#include &lt;asm/io_trivial.h&gt;</span>

<span class="cp">#ifdef __IO_EXTERN_INLINE</span>
<span class="cp">#undef __EXTERN_INLINE</span>
<span class="cp">#undef __IO_EXTERN_INLINE</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __ALPHA_T2__H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
