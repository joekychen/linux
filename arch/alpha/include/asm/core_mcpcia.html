<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › alpha › include › asm › core_mcpcia.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>core_mcpcia.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef __ALPHA_MCPCIA__H__</span>
<span class="cp">#define __ALPHA_MCPCIA__H__</span>

<span class="cm">/* Define to experiment with fitting everything into one 128MB HAE window.</span>
<span class="cm">   One window per bus, that is.  */</span>
<span class="cp">#define MCPCIA_ONE_HAE_WINDOW 1</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;asm/compiler.h&gt;</span>
<span class="cp">#include &lt;asm/mce.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * MCPCIA is the internal name for a core logic chipset which provides</span>
<span class="cm"> * PCI access for the RAWHIDE family of systems.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is based on:</span>
<span class="cm"> *</span>
<span class="cm"> * RAWHIDE System Programmer&#39;s Manual</span>
<span class="cm"> * 16-May-96</span>
<span class="cm"> * Rev. 1.4</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*------------------------------------------------------------------------**</span>
<span class="cm">**                                                                        **</span>
<span class="cm">**  I/O procedures                                                        **</span>
<span class="cm">**                                                                        **</span>
<span class="cm">**      inport[b|w|t|l], outport[b|w|t|l] 8:16:24:32 IO xfers             **</span>
<span class="cm">**	inportbxt: 8 bits only                                            **</span>
<span class="cm">**      inport:    alias of inportw                                       **</span>
<span class="cm">**      outport:   alias of outportw                                      **</span>
<span class="cm">**                                                                        **</span>
<span class="cm">**      inmem[b|w|t|l], outmem[b|w|t|l] 8:16:24:32 ISA memory xfers       **</span>
<span class="cm">**	inmembxt: 8 bits only                                             **</span>
<span class="cm">**      inmem:    alias of inmemw                                         **</span>
<span class="cm">**      outmem:   alias of outmemw                                        **</span>
<span class="cm">**                                                                        **</span>
<span class="cm">**------------------------------------------------------------------------*/</span>


<span class="cm">/* MCPCIA ADDRESS BIT DEFINITIONS</span>
<span class="cm"> *</span>
<span class="cm"> *  3333 3333 3322 2222 2222 1111 1111 11</span>
<span class="cm"> *  9876 5432 1098 7654 3210 9876 5432 1098 7654 3210</span>
<span class="cm"> *  ---- ---- ---- ---- ---- ---- ---- ---- ---- ----</span>
<span class="cm"> *  1                                             000</span>
<span class="cm"> *  ---- ---- ---- ---- ---- ---- ---- ---- ---- ----</span>
<span class="cm"> *  |                                             |\|</span>
<span class="cm"> *  |                               Byte Enable --+ |</span>
<span class="cm"> *  |                             Transfer Length --+</span>
<span class="cm"> *  +-- IO space, not cached</span>
<span class="cm"> *</span>
<span class="cm"> *   Byte      Transfer</span>
<span class="cm"> *   Enable    Length    Transfer  Byte    Address</span>
<span class="cm"> *   adr&lt;6:5&gt;  adr&lt;4:3&gt;  Length    Enable  Adder</span>
<span class="cm"> *   ---------------------------------------------</span>
<span class="cm"> *      00        00      Byte      1110   0x000</span>
<span class="cm"> *      01        00      Byte      1101   0x020</span>
<span class="cm"> *      10        00      Byte      1011   0x040</span>
<span class="cm"> *      11        00      Byte      0111   0x060</span>
<span class="cm"> *</span>
<span class="cm"> *      00        01      Word      1100   0x008</span>
<span class="cm"> *      01        01      Word      1001   0x028 &lt;= Not supported in this code.</span>
<span class="cm"> *      10        01      Word      0011   0x048</span>
<span class="cm"> *</span>
<span class="cm"> *      00        10      Tribyte   1000   0x010</span>
<span class="cm"> *      01        10      Tribyte   0001   0x030</span>
<span class="cm"> *</span>
<span class="cm"> *      10        11      Longword  0000   0x058</span>
<span class="cm"> *</span>
<span class="cm"> *      Note that byte enables are asserted low.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define MCPCIA_MAX_HOSES 4</span>

<span class="cp">#define MCPCIA_MID(m)		((unsigned long)(m) &lt;&lt; 33)</span>

<span class="cm">/* Dodge has PCI0 and PCI1 at MID 4 and 5 respectively. </span>
<span class="cm">   Durango adds PCI2 and PCI3 at MID 6 and 7 respectively.  */</span>
<span class="cp">#define MCPCIA_HOSE2MID(h)	((h) + 4)</span>

<span class="cp">#define MCPCIA_MEM_MASK 0x07ffffff </span><span class="cm">/* SPARSE Mem region mask is 27 bits */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Memory spaces:</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_SPARSE(m)	(IDENT_ADDR + 0xf000000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_DENSE(m)		(IDENT_ADDR + 0xf100000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_IO(m)		(IDENT_ADDR + 0xf180000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_CONF(m)		(IDENT_ADDR + 0xf1c0000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_CSR(m)		(IDENT_ADDR + 0xf1e0000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_IO_IACK(m)	(IDENT_ADDR + 0xf1f0000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_DENSE_IO(m)	(IDENT_ADDR + 0xe1fc000000UL + MCPCIA_MID(m))</span>
<span class="cp">#define MCPCIA_DENSE_CONF(m)	(IDENT_ADDR + 0xe1fe000000UL + MCPCIA_MID(m))</span>

<span class="cm">/*</span>
<span class="cm"> *  General Registers</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_REV(m)		(MCPCIA_CSR(m) + 0x000)</span>
<span class="cp">#define MCPCIA_WHOAMI(m)	(MCPCIA_CSR(m) + 0x040)</span>
<span class="cp">#define MCPCIA_PCI_LAT(m)	(MCPCIA_CSR(m) + 0x080)</span>
<span class="cp">#define MCPCIA_CAP_CTRL(m)	(MCPCIA_CSR(m) + 0x100)</span>
<span class="cp">#define MCPCIA_HAE_MEM(m)	(MCPCIA_CSR(m) + 0x400)</span>
<span class="cp">#define MCPCIA_HAE_IO(m)	(MCPCIA_CSR(m) + 0x440)</span>
<span class="cp">#define _MCPCIA_IACK_SC(m)	(MCPCIA_CSR(m) + 0x480)</span>
<span class="cp">#define MCPCIA_HAE_DENSE(m)	(MCPCIA_CSR(m) + 0x4C0)</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt Control registers</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_INT_CTL(m)	(MCPCIA_CSR(m) + 0x500)</span>
<span class="cp">#define MCPCIA_INT_REQ(m)	(MCPCIA_CSR(m) + 0x540)</span>
<span class="cp">#define MCPCIA_INT_TARG(m)	(MCPCIA_CSR(m) + 0x580)</span>
<span class="cp">#define MCPCIA_INT_ADR(m)	(MCPCIA_CSR(m) + 0x5C0)</span>
<span class="cp">#define MCPCIA_INT_ADR_EXT(m)	(MCPCIA_CSR(m) + 0x600)</span>
<span class="cp">#define MCPCIA_INT_MASK0(m)	(MCPCIA_CSR(m) + 0x640)</span>
<span class="cp">#define MCPCIA_INT_MASK1(m)	(MCPCIA_CSR(m) + 0x680)</span>
<span class="cp">#define MCPCIA_INT_ACK0(m)	(MCPCIA_CSR(m) + 0x10003f00)</span>
<span class="cp">#define MCPCIA_INT_ACK1(m)	(MCPCIA_CSR(m) + 0x10003f40)</span>

<span class="cm">/*</span>
<span class="cm"> * Performance Monitor registers</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_PERF_MON(m)	(MCPCIA_CSR(m) + 0x300)</span>
<span class="cp">#define MCPCIA_PERF_CONT(m)	(MCPCIA_CSR(m) + 0x340)</span>

<span class="cm">/*</span>
<span class="cm"> * Diagnostic Registers</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_CAP_DIAG(m)	(MCPCIA_CSR(m) + 0x700)</span>
<span class="cp">#define MCPCIA_TOP_OF_MEM(m)	(MCPCIA_CSR(m) + 0x7C0)</span>

<span class="cm">/*</span>
<span class="cm"> * Error registers</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_MC_ERR0(m)	(MCPCIA_CSR(m) + 0x800)</span>
<span class="cp">#define MCPCIA_MC_ERR1(m)	(MCPCIA_CSR(m) + 0x840)</span>
<span class="cp">#define MCPCIA_CAP_ERR(m)	(MCPCIA_CSR(m) + 0x880)</span>
<span class="cp">#define MCPCIA_PCI_ERR1(m)	(MCPCIA_CSR(m) + 0x1040)</span>
<span class="cp">#define MCPCIA_MDPA_STAT(m)	(MCPCIA_CSR(m) + 0x4000)</span>
<span class="cp">#define MCPCIA_MDPA_SYN(m)	(MCPCIA_CSR(m) + 0x4040)</span>
<span class="cp">#define MCPCIA_MDPA_DIAG(m)	(MCPCIA_CSR(m) + 0x4080)</span>
<span class="cp">#define MCPCIA_MDPB_STAT(m)	(MCPCIA_CSR(m) + 0x8000)</span>
<span class="cp">#define MCPCIA_MDPB_SYN(m)	(MCPCIA_CSR(m) + 0x8040)</span>
<span class="cp">#define MCPCIA_MDPB_DIAG(m)	(MCPCIA_CSR(m) + 0x8080)</span>

<span class="cm">/*</span>
<span class="cm"> * PCI Address Translation Registers.</span>
<span class="cm"> */</span>
<span class="cp">#define MCPCIA_SG_TBIA(m)	(MCPCIA_CSR(m) + 0x1300)</span>
<span class="cp">#define MCPCIA_HBASE(m)		(MCPCIA_CSR(m) + 0x1340)</span>

<span class="cp">#define MCPCIA_W0_BASE(m)	(MCPCIA_CSR(m) + 0x1400)</span>
<span class="cp">#define MCPCIA_W0_MASK(m)	(MCPCIA_CSR(m) + 0x1440)</span>
<span class="cp">#define MCPCIA_T0_BASE(m)	(MCPCIA_CSR(m) + 0x1480)</span>

<span class="cp">#define MCPCIA_W1_BASE(m)	(MCPCIA_CSR(m) + 0x1500)</span>
<span class="cp">#define MCPCIA_W1_MASK(m)	(MCPCIA_CSR(m) + 0x1540)</span>
<span class="cp">#define MCPCIA_T1_BASE(m)	(MCPCIA_CSR(m) + 0x1580)</span>

<span class="cp">#define MCPCIA_W2_BASE(m)	(MCPCIA_CSR(m) + 0x1600)</span>
<span class="cp">#define MCPCIA_W2_MASK(m)	(MCPCIA_CSR(m) + 0x1640)</span>
<span class="cp">#define MCPCIA_T2_BASE(m)	(MCPCIA_CSR(m) + 0x1680)</span>

<span class="cp">#define MCPCIA_W3_BASE(m)	(MCPCIA_CSR(m) + 0x1700)</span>
<span class="cp">#define MCPCIA_W3_MASK(m)	(MCPCIA_CSR(m) + 0x1740)</span>
<span class="cp">#define MCPCIA_T3_BASE(m)	(MCPCIA_CSR(m) + 0x1780)</span>

<span class="cm">/* Hack!  Only words for bus 0.  */</span>

<span class="cp">#ifndef MCPCIA_ONE_HAE_WINDOW</span>
<span class="cp">#define MCPCIA_HAE_ADDRESS	MCPCIA_HAE_MEM(4)</span>
<span class="cp">#endif</span>
<span class="cp">#define MCPCIA_IACK_SC		_MCPCIA_IACK_SC(4)</span>

<span class="cm">/* </span>
<span class="cm"> * The canonical non-remaped I/O and MEM addresses have these values</span>
<span class="cm"> * subtracted out.  This is arranged so that folks manipulating ISA</span>
<span class="cm"> * devices can use their familiar numbers and have them map to bus 0.</span>
<span class="cm"> */</span>

<span class="cp">#define MCPCIA_IO_BIAS		MCPCIA_IO(4)</span>
<span class="cp">#define MCPCIA_MEM_BIAS		MCPCIA_DENSE(4)</span>

<span class="cm">/* Offset between ram physical addresses and pci64 DAC bus addresses.  */</span>
<span class="cp">#define MCPCIA_DAC_OFFSET	(1UL &lt;&lt; 40)</span>

<span class="cm">/*</span>
<span class="cm"> * Data structure for handling MCPCIA machine checks:</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">el_MCPCIA_uncorrected_frame_mcheck</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">el_common</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">el_common_EV5_uncorrectable_mcheck</span> <span class="n">procdata</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#ifdef __KERNEL__</span>

<span class="cp">#ifndef __EXTERN_INLINE</span>
<span class="cp">#define __EXTERN_INLINE extern inline</span>
<span class="cp">#define __IO_EXTERN_INLINE</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * I/O functions:</span>
<span class="cm"> *</span>
<span class="cm"> * MCPCIA, the RAWHIDE family PCI/memory support chipset for the EV5 (21164)</span>
<span class="cm"> * and EV56 (21164a) processors, can use either a sparse address mapping</span>
<span class="cm"> * scheme, or the so-called byte-word PCI address space, to get at PCI memory</span>
<span class="cm"> * and I/O.</span>
<span class="cm"> *</span>
<span class="cm"> * Unfortunately, we can&#39;t use BWIO with EV5, so for now, we always use SPARSE.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Memory functions.  64-bit and 32-bit accesses are done through</span>
<span class="cm"> * dense memory space, everything else through sparse space.</span>
<span class="cm"> *</span>
<span class="cm"> * For reading and writing 8 and 16 bit quantities we need to</span>
<span class="cm"> * go through one of the three sparse address mapping regions</span>
<span class="cm"> * and use the HAE_MEM CSR to provide some bits of the address.</span>
<span class="cm"> * The following few routines use only sparse address region 1</span>
<span class="cm"> * which gives 1Gbyte of accessible space which relates exactly</span>
<span class="cm"> * to the amount of PCI memory mapping *into* system address space.</span>
<span class="cm"> * See p 6-17 of the specification but it looks something like this:</span>
<span class="cm"> *</span>
<span class="cm"> * 21164 Address:</span>
<span class="cm"> *</span>
<span class="cm"> *          3         2         1</span>
<span class="cm"> * 9876543210987654321098765432109876543210</span>
<span class="cm"> * 1ZZZZ0.PCI.QW.Address............BBLL</span>
<span class="cm"> *</span>
<span class="cm"> * ZZ = SBZ</span>
<span class="cm"> * BB = Byte offset</span>
<span class="cm"> * LL = Transfer length</span>
<span class="cm"> *</span>
<span class="cm"> * PCI Address:</span>
<span class="cm"> *</span>
<span class="cm"> * 3         2         1</span>
<span class="cm"> * 10987654321098765432109876543210</span>
<span class="cm"> * HHH....PCI.QW.Address........ 00</span>
<span class="cm"> *</span>
<span class="cm"> * HHH = 31:29 HAE_MEM CSR</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define vip	volatile int __force *</span>
<span class="cp">#define vuip	volatile unsigned int __force *</span>

<span class="cp">#ifndef MCPCIA_ONE_HAE_WINDOW</span>
<span class="cp">#define MCPCIA_FROB_MMIO						\</span>
<span class="cp">	if (__mcpcia_is_mmio(hose)) {					\</span>
<span class="cp">		set_hae(hose &amp; 0xffffffff);				\</span>
<span class="cp">		hose = hose - MCPCIA_DENSE(4) + MCPCIA_SPARSE(4);	\</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
<span class="cp">#define MCPCIA_FROB_MMIO						\</span>
<span class="cp">	if (__mcpcia_is_mmio(hose)) {					\</span>
<span class="cp">		hose = hose - MCPCIA_DENSE(4) + MCPCIA_SPARSE(4);	\</span>
<span class="cp">	}</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__mcpcia_is_mmio</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x80000000UL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mcpcia_ioread8</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hose</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">MCPCIA_FROB_MMIO</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hose</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extbl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">mcpcia_iowrite8</span><span class="p">(</span><span class="n">u8</span> <span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hose</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">MCPCIA_FROB_MMIO</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_insbl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hose</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mcpcia_ioread16</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hose</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">MCPCIA_FROB_MMIO</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hose</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__kernel_extwl</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">mcpcia_iowrite16</span><span class="p">(</span><span class="n">u16</span> <span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hose</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MCPCIA_MEM_MASK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w</span><span class="p">;</span>

	<span class="n">MCPCIA_FROB_MMIO</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">__kernel_inswl</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">hose</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">mcpcia_ioread32</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__mcpcia_is_mmio</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfffful</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="nf">mcpcia_iowrite32</span><span class="p">(</span><span class="n">u32</span> <span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">xaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">__mcpcia_is_mmio</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfffful</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x18</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vuip</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">mcpcia_ioportmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">MCPCIA_IO_BIAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">mcpcia_ioremap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">MCPCIA_MEM_BIAS</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">int</span> <span class="nf">mcpcia_is_ioaddr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">MCPCIA_SPARSE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">__EXTERN_INLINE</span> <span class="kt">int</span> <span class="nf">mcpcia_is_mmio</span><span class="p">(</span><span class="k">const</span> <span class="k">volatile</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">xaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">xaddr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__mcpcia_is_mmio</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#undef MCPCIA_FROB_MMIO</span>

<span class="cp">#undef vip</span>
<span class="cp">#undef vuip</span>

<span class="cp">#undef __IO_PREFIX</span>
<span class="cp">#define __IO_PREFIX		mcpcia</span>
<span class="cp">#define mcpcia_trivial_rw_bw	2</span>
<span class="cp">#define mcpcia_trivial_rw_lq	1</span>
<span class="cp">#define mcpcia_trivial_io_bw	0</span>
<span class="cp">#define mcpcia_trivial_io_lq	0</span>
<span class="cp">#define mcpcia_trivial_iounmap	1</span>
<span class="cp">#include &lt;asm/io_trivial.h&gt;</span>

<span class="cp">#ifdef __IO_EXTERN_INLINE</span>
<span class="cp">#undef __EXTERN_INLINE</span>
<span class="cp">#undef __IO_EXTERN_INLINE</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="cm">/* __KERNEL__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* __ALPHA_MCPCIA__H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
