<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › platform › coldfire › m532x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>m532x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	linux/arch/m68knommu/platform/532x/config.c</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1999-2002, Greg Ungerer (gerg@snapgear.com)</span>
<span class="cm"> *	Copyright (C) 2000, Lineo (www.lineo.com)</span>
<span class="cm"> *	Yaroslav Vinogradov yaroslav.vinogradov@freescale.com</span>
<span class="cm"> *	Copyright Freescale Semiconductor, Inc 2006</span>
<span class="cm"> *	Copyright (c) 2006, emlix, Sebastian Hess &lt;shess@hessware.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cm">/***************************************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/param.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/coldfire.h&gt;</span>
<span class="cp">#include &lt;asm/mcfsim.h&gt;</span>
<span class="cp">#include &lt;asm/mcfuart.h&gt;</span>
<span class="cp">#include &lt;asm/mcfdma.h&gt;</span>
<span class="cp">#include &lt;asm/mcfgpio.h&gt;</span>
<span class="cp">#include &lt;asm/mcfwdebug.h&gt;</span>

<span class="cm">/***************************************************************************/</span>

<span class="k">struct</span> <span class="n">mcf_gpio_chip</span> <span class="n">mcf_gpio_chips</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">MCFGPS</span><span class="p">(</span><span class="n">PIRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">MCFEPORT_EPDDR</span><span class="p">,</span> <span class="n">MCFEPORT_EPDR</span><span class="p">,</span> <span class="n">MCFEPORT_EPPDR</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">FECH</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">FECL</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">SSI</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">BUSCTL</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">BE</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">PWM</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">FECI2C</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">UART</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">QSPI</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">TIMER</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">LCDDATAH</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">LCDDATAM</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">LCDDATAL</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">LCDCTLH</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">MCFGPF</span><span class="p">(</span><span class="n">LCDCTLL</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcf_gpio_chips_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mcf_gpio_chips</span><span class="p">);</span>

<span class="cm">/***************************************************************************/</span>

<span class="cp">#if IS_ENABLED(CONFIG_SPI_COLDFIRE_QSPI)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">m532x_qspi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* setup QSPS pins for QSPI with gpio CS control */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x01f0</span><span class="p">,</span> <span class="n">MCF_GPIO_PAR_QSPI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* IS_ENABLED(CONFIG_SPI_COLDFIRE_QSPI) */</span><span class="cp"></span>

<span class="cm">/***************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">m532x_uarts_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* UART GPIO initialization */</span>
	<span class="n">MCF_GPIO_PAR_UART</span> <span class="o">|=</span> <span class="mh">0x0FFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">m532x_fec_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set multi-function pins to ethernet mode for fec0 */</span>
	<span class="n">MCF_GPIO_PAR_FECI2C</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MCF_GPIO_PAR_FECI2C_PAR_MDC_EMDC</span> <span class="o">|</span>
		<span class="n">MCF_GPIO_PAR_FECI2C_PAR_MDIO_EMDIO</span><span class="p">);</span>
	<span class="n">MCF_GPIO_PAR_FEC</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_GPIO_PAR_FEC_PAR_FEC_7W_FEC</span> <span class="o">|</span>
		<span class="n">MCF_GPIO_PAR_FEC_PAR_FEC_MII_FEC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************/</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">config_BSP</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">commandp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if !defined(CONFIG_BOOTPARAM)</span>
	<span class="cm">/* Copy command line from FLASH to local buffer... */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">commandp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">commandp</span><span class="p">,</span> <span class="s">&quot;kcl &quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">commandp</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mh">0x4004</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">commandp</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">commandp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">mach_sched_init</span> <span class="o">=</span> <span class="n">hw_timer_init</span><span class="p">;</span>
	<span class="n">m532x_uarts_init</span><span class="p">();</span>
	<span class="n">m532x_fec_init</span><span class="p">();</span>
<span class="cp">#if IS_ENABLED(CONFIG_SPI_COLDFIRE_QSPI)</span>
	<span class="n">m532x_qspi_init</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_BDM_DISABLE</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable the BDM clocking.  This also turns off most of the rest of</span>
<span class="cm">	 * the BDM device.  This is good for EMC reasons. This option is not</span>
<span class="cm">	 * incompatible with the memory protection option.</span>
<span class="cm">	 */</span>
	<span class="n">wdebug</span><span class="p">(</span><span class="n">MCFDEBUG_CSR</span><span class="p">,</span> <span class="n">MCFDEBUG_CSR_PSTCLK</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* Board initialization */</span>
<span class="cm">/***************************************************************************/</span>
<span class="cm">/* </span>
<span class="cm"> * PLL min/max specifications</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_FVCO	500000	</span><span class="cm">/* KHz */</span><span class="cp"></span>
<span class="cp">#define MAX_FSYS	80000 	</span><span class="cm">/* KHz */</span><span class="cp"></span>
<span class="cp">#define MIN_FSYS	58333 	</span><span class="cm">/* KHz */</span><span class="cp"></span>
<span class="cp">#define FREF		16000   </span><span class="cm">/* KHz */</span><span class="cp"></span>


<span class="cp">#define MAX_MFD		135     </span><span class="cm">/* Multiplier */</span><span class="cp"></span>
<span class="cp">#define MIN_MFD		88      </span><span class="cm">/* Multiplier */</span><span class="cp"></span>
<span class="cp">#define BUSDIV		6       </span><span class="cm">/* Divider */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Low Power Divider specifications</span>
<span class="cm"> */</span>
<span class="cp">#define MIN_LPD		(1 &lt;&lt; 0)    </span><span class="cm">/* Divider (not encoded) */</span><span class="cp"></span>
<span class="cp">#define MAX_LPD		(1 &lt;&lt; 15)   </span><span class="cm">/* Divider (not encoded) */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_LPD	(1 &lt;&lt; 1)	</span><span class="cm">/* Divider (not encoded) */</span><span class="cp"></span>

<span class="cp">#define SYS_CLK_KHZ	80000</span>
<span class="cp">#define SYSTEM_PERIOD	12.5</span>
<span class="cm">/*</span>
<span class="cm"> *  SDRAM Timing Parameters</span>
<span class="cm"> */</span>  
<span class="cp">#define SDRAM_BL	8	</span><span class="cm">/* # of beats in a burst */</span><span class="cp"></span>
<span class="cp">#define SDRAM_TWR	2	</span><span class="cm">/* in clocks */</span><span class="cp"></span>
<span class="cp">#define SDRAM_CASL	2.5	</span><span class="cm">/* CASL in clocks */</span><span class="cp"></span>
<span class="cp">#define SDRAM_TRCD	2	</span><span class="cm">/* in clocks */</span><span class="cp"></span>
<span class="cp">#define SDRAM_TRP	2	</span><span class="cm">/* in clocks */</span><span class="cp"></span>
<span class="cp">#define SDRAM_TRFC	7	</span><span class="cm">/* in clocks */</span><span class="cp"></span>
<span class="cp">#define SDRAM_TREFI	7800	</span><span class="cm">/* in ns */</span><span class="cp"></span>

<span class="cp">#define EXT_SRAM_ADDRESS	(0xC0000000)</span>
<span class="cp">#define FLASH_ADDRESS		(0x00000000)</span>
<span class="cp">#define SDRAM_ADDRESS		(0x40000000)</span>

<span class="cp">#define NAND_FLASH_ADDRESS	(0xD0000000)</span>

<span class="kt">int</span> <span class="n">sys_clk_khz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">sys_clk_mhz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">wtm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">scm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">gpio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">fbcs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">sdramc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">clock_pll</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fsys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">clock_limp</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">clock_exit_limp</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span>  <span class="n">get_sys_clock</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sysinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sys_clk_khz</span> <span class="o">=</span> <span class="n">clock_pll</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sys_clk_mhz</span> <span class="o">=</span> <span class="n">sys_clk_khz</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
	
	<span class="n">wtm_init</span><span class="p">();</span>
	<span class="n">scm_init</span><span class="p">();</span>
	<span class="n">gpio_init</span><span class="p">();</span>
	<span class="n">fbcs_init</span><span class="p">();</span>
	<span class="n">sdramc_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wtm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Disable watchdog timer */</span>
	<span class="n">MCF_WTM_WCR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MCF_SCM_BCR_GBW		(0x00000100)</span>
<span class="cp">#define MCF_SCM_BCR_GBR		(0x00000200)</span>

<span class="kt">void</span> <span class="nf">scm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* All masters are trusted */</span>
	<span class="n">MCF_SCM_MPR</span> <span class="o">=</span> <span class="mh">0x77777777</span><span class="p">;</span>
    
	<span class="cm">/* Allow supervisor/user, read/write, and trusted/untrusted</span>
<span class="cm">	   access to all slaves */</span>
	<span class="n">MCF_SCM_PACRA</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MCF_SCM_PACRB</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MCF_SCM_PACRC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MCF_SCM_PACRD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MCF_SCM_PACRE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MCF_SCM_PACRF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable bursts */</span>
	<span class="n">MCF_SCM_BCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_SCM_BCR_GBR</span> <span class="o">|</span> <span class="n">MCF_SCM_BCR_GBW</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">fbcs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MCF_GPIO_PAR_CS</span> <span class="o">=</span> <span class="mh">0x0000003E</span><span class="p">;</span>

	<span class="cm">/* Latch chip select */</span>
	<span class="n">MCF_FBCS1_CSAR</span> <span class="o">=</span> <span class="mh">0x10080000</span><span class="p">;</span>

	<span class="n">MCF_FBCS1_CSCR</span> <span class="o">=</span> <span class="mh">0x002A3780</span><span class="p">;</span>
	<span class="n">MCF_FBCS1_CSMR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_FBCS_CSMR_BAM_2M</span> <span class="o">|</span> <span class="n">MCF_FBCS_CSMR_V</span><span class="p">);</span>

	<span class="cm">/* Initialize latch to drive signals to inactive states */</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="mh">0x10080000</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="cm">/* External SRAM */</span>
	<span class="n">MCF_FBCS1_CSAR</span> <span class="o">=</span> <span class="n">EXT_SRAM_ADDRESS</span><span class="p">;</span>
	<span class="n">MCF_FBCS1_CSCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_FBCS_CSCR_PS_16</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_AA</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_SBM</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_WS</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">MCF_FBCS1_CSMR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_FBCS_CSMR_BAM_512K</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSMR_V</span><span class="p">);</span>

	<span class="cm">/* Boot Flash connected to FBCS0 */</span>
	<span class="n">MCF_FBCS0_CSAR</span> <span class="o">=</span> <span class="n">FLASH_ADDRESS</span><span class="p">;</span>
	<span class="n">MCF_FBCS0_CSCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_FBCS_CSCR_PS_16</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_BEM</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_AA</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_SBM</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSCR_WS</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
	<span class="n">MCF_FBCS0_CSMR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_FBCS_CSMR_BAM_32M</span>
			<span class="o">|</span> <span class="n">MCF_FBCS_CSMR_V</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sdramc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the SDRAM has already been initialized</span>
<span class="cm">	 * by a run control tool</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">MCF_SDRAMC_SDCR</span> <span class="o">&amp;</span> <span class="n">MCF_SDRAMC_SDCR_REF</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* SDRAM chip select initialization */</span>
		
		<span class="cm">/* Initialize SDRAM chip select */</span>
		<span class="n">MCF_SDRAMC_SDCS0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
			<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCS_BA</span><span class="p">(</span><span class="n">SDRAM_ADDRESS</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCS_CSSZ</span><span class="p">(</span><span class="n">MCF_SDRAMC_SDCS_CSSZ_32MBYTE</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Basic configuration and initialization</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDCFG1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_SRD2RW</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDRAM_CASL</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_SWT2RD</span><span class="p">(</span><span class="n">SDRAM_TWR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_RDLAT</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDRAM_CASL</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_ACT2RW</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDRAM_TRCD</span> <span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_PRE2ACT</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDRAM_TRP</span> <span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_REF2ACT</span><span class="p">((</span><span class="kt">int</span><span class="p">)(((</span><span class="n">SDRAM_TRFC</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG1_WTLAT</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
	<span class="n">MCF_SDRAMC_SDCFG2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG2_BRD2PRE</span><span class="p">(</span><span class="n">SDRAM_BL</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG2_BWT2RW</span><span class="p">(</span><span class="n">SDRAM_BL</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">SDRAM_TWR</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG2_BRD2WT</span><span class="p">((</span><span class="kt">int</span><span class="p">)((</span><span class="n">SDRAM_CASL</span><span class="o">+</span><span class="n">SDRAM_BL</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCFG2_BL</span><span class="p">(</span><span class="n">SDRAM_BL</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

            
	<span class="cm">/*</span>
<span class="cm">	 * Precharge and enable write to SDMR</span>
<span class="cm">	 */</span>
        <span class="n">MCF_SDRAMC_SDCR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_MODE_EN</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_CKE</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_DDR</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_MUX</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_RCNT</span><span class="p">((</span><span class="kt">int</span><span class="p">)(((</span><span class="n">SDRAM_TREFI</span><span class="o">/</span><span class="p">(</span><span class="n">SYSTEM_PERIOD</span><span class="o">*</span><span class="mi">64</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_PS_16</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_IPALL</span><span class="p">);</span>            

	<span class="cm">/*</span>
<span class="cm">	 * Write extended mode register</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDMR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_BNKAD_LEMR</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_AD</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_CMD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write mode register and reset DLL</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDMR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_BNKAD_LMR</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_AD</span><span class="p">(</span><span class="mh">0x163</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_CMD</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Execute a PALL command</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">|=</span> <span class="n">MCF_SDRAMC_SDCR_IPALL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Perform two REF cycles</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">|=</span> <span class="n">MCF_SDRAMC_SDCR_IREF</span><span class="p">;</span>
	<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">|=</span> <span class="n">MCF_SDRAMC_SDCR_IREF</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write mode register and clear reset DLL</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDMR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_BNKAD_LMR</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_AD</span><span class="p">(</span><span class="mh">0x063</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDMR_CMD</span><span class="p">);</span>
				
	<span class="cm">/*</span>
<span class="cm">	 * Enable auto refresh and lock SDMR</span>
<span class="cm">	 */</span>
	<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCF_SDRAMC_SDCR_MODE_EN</span><span class="p">;</span>
	<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_REF</span>
		<span class="o">|</span> <span class="n">MCF_SDRAMC_SDCR_DQS_OE</span><span class="p">(</span><span class="mh">0xC</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gpio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Enable UART0 pins */</span>
	<span class="n">MCF_GPIO_PAR_UART</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_GPIO_PAR_UART_PAR_URXD0</span>
		<span class="o">|</span> <span class="n">MCF_GPIO_PAR_UART_PAR_UTXD0</span><span class="p">);</span>

	<span class="cm">/* Initialize TIN3 as a GPIO output to enable the write</span>
<span class="cm">	   half of the latch */</span>
	<span class="n">MCF_GPIO_PAR_TIMER</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="n">MCFGPIO_PDDR_TIMER</span><span class="p">);</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">MCFGPIO_PCLRR_TIMER</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">clock_pll</span><span class="p">(</span><span class="kt">int</span> <span class="n">fsys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fref</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">mfd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fref</span> <span class="o">=</span> <span class="n">FREF</span><span class="p">;</span>
        
	<span class="k">if</span> <span class="p">(</span><span class="n">fsys</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Return current PLL output */</span>
		<span class="n">mfd</span> <span class="o">=</span> <span class="n">MCF_PLL_PFDR</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">fref</span> <span class="o">*</span> <span class="n">mfd</span> <span class="o">/</span> <span class="p">(</span><span class="n">BUSDIV</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Check bounds of requested system clock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsys</span> <span class="o">&gt;</span> <span class="n">MAX_FSYS</span><span class="p">)</span>
		<span class="n">fsys</span> <span class="o">=</span> <span class="n">MAX_FSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fsys</span> <span class="o">&lt;</span> <span class="n">MIN_FSYS</span><span class="p">)</span>
		<span class="n">fsys</span> <span class="o">=</span> <span class="n">MIN_FSYS</span><span class="p">;</span>

	<span class="cm">/* Multiplying by 100 when calculating the temp value,</span>
<span class="cm">	   and then dividing by 100 to calculate the mfd allows</span>
<span class="cm">	   for exact values without needing to include floating</span>
<span class="cm">	   point libraries. */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">fsys</span> <span class="o">/</span> <span class="n">fref</span><span class="p">;</span>
	<span class="n">mfd</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">BUSDIV</span> <span class="o">*</span> <span class="n">temp</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
    	    	    	
	<span class="cm">/* Determine the output frequency for selected values */</span>
	<span class="n">fout</span> <span class="o">=</span> <span class="p">(</span><span class="n">fref</span> <span class="o">*</span> <span class="n">mfd</span> <span class="o">/</span> <span class="p">(</span><span class="n">BUSDIV</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the SDRAM has already been initialized.</span>
<span class="cm">	 * If it has then the SDRAM needs to be put into self refresh</span>
<span class="cm">	 * mode before reprogramming the PLL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MCF_SDRAMC_SDCR</span> <span class="o">&amp;</span> <span class="n">MCF_SDRAMC_SDCR_REF</span><span class="p">)</span>
		<span class="cm">/* Put SDRAM into self refresh mode */</span>
		<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MCF_SDRAMC_SDCR_CKE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the PLL to generate the new system clock frequency.</span>
<span class="cm">	 * The device must be put into LIMP mode to reprogram the PLL.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enter LIMP mode */</span>
	<span class="n">clock_limp</span><span class="p">(</span><span class="n">DEFAULT_LPD</span><span class="p">);</span>
     					
	<span class="cm">/* Reprogram PLL for desired fsys */</span>
	<span class="n">MCF_PLL_PODR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_PLL_PODR_CPUDIV</span><span class="p">(</span><span class="n">BUSDIV</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_PLL_PODR_BUSDIV</span><span class="p">(</span><span class="n">BUSDIV</span><span class="p">));</span>
						
	<span class="n">MCF_PLL_PFDR</span> <span class="o">=</span> <span class="n">mfd</span><span class="p">;</span>
		
	<span class="cm">/* Exit LIMP mode */</span>
	<span class="n">clock_exit_limp</span><span class="p">();</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Return the SDRAM to normal operation if it is in use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MCF_SDRAMC_SDCR</span> <span class="o">&amp;</span> <span class="n">MCF_SDRAMC_SDCR_REF</span><span class="p">)</span>
		<span class="cm">/* Exit self refresh mode */</span>
		<span class="n">MCF_SDRAMC_SDCR</span> <span class="o">|=</span> <span class="n">MCF_SDRAMC_SDCR_CKE</span><span class="p">;</span>

	<span class="cm">/* Errata - workaround for SDRAM opeartion after exiting LIMP mode */</span>
	<span class="n">MCF_SDRAMC_LIMP_FIX</span> <span class="o">=</span> <span class="n">MCF_SDRAMC_REFRESH</span><span class="p">;</span>

	<span class="cm">/* wait for DQS logic to relock */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="n">fout</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">clock_limp</span><span class="p">(</span><span class="kt">int</span> <span class="n">div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Check bounds of divider */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&lt;</span> <span class="n">MIN_LPD</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">MIN_LPD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div</span> <span class="o">&gt;</span> <span class="n">MAX_LPD</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">MAX_LPD</span><span class="p">;</span>
    
	<span class="cm">/* Save of the current value of the SSIDIV so we don&#39;t</span>
<span class="cm">	   overwrite the value*/</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_CCM_CDR</span> <span class="o">&amp;</span> <span class="n">MCF_CCM_CDR_SSIDIV</span><span class="p">(</span><span class="mh">0xF</span><span class="p">));</span>
      
	<span class="cm">/* Apply the divider to the system clock */</span>
	<span class="n">MCF_CCM_CDR</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">0</span>
		<span class="o">|</span> <span class="n">MCF_CCM_CDR_LPDIV</span><span class="p">(</span><span class="n">div</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">MCF_CCM_CDR_SSIDIV</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>
    
	<span class="n">MCF_CCM_MISCCR</span> <span class="o">|=</span> <span class="n">MCF_CCM_MISCCR_LIMP</span><span class="p">;</span>
    
	<span class="k">return</span> <span class="p">(</span><span class="n">FREF</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">div</span><span class="p">)));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">clock_exit_limp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fout</span><span class="p">;</span>
	
	<span class="cm">/* Exit LIMP mode */</span>
	<span class="n">MCF_CCM_MISCCR</span> <span class="o">=</span> <span class="p">(</span><span class="n">MCF_CCM_MISCCR</span> <span class="o">&amp;</span> <span class="o">~</span> <span class="n">MCF_CCM_MISCCR_LIMP</span><span class="p">);</span>

	<span class="cm">/* Wait for PLL to lock */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">MCF_CCM_MISCCR</span> <span class="o">&amp;</span> <span class="n">MCF_CCM_MISCCR_PLL_LOCK</span><span class="p">))</span>
		<span class="p">;</span>
	
	<span class="n">fout</span> <span class="o">=</span> <span class="n">get_sys_clock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">fout</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_sys_clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">;</span>
	
	<span class="cm">/* Test to see if device is in LIMP mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MCF_CCM_MISCCR</span> <span class="o">&amp;</span> <span class="n">MCF_CCM_MISCCR_LIMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">MCF_CCM_CDR</span> <span class="o">&amp;</span> <span class="n">MCF_CCM_CDR_LPDIV</span><span class="p">(</span><span class="mh">0xF</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">FREF</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">divider</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">FREF</span> <span class="o">*</span> <span class="n">MCF_PLL_PFDR</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">BUSDIV</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
