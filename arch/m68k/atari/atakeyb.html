<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › atari › atakeyb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atakeyb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Atari Keyboard driver for 680x0 Linux</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Atari support by Robert de Vries</span>
<span class="cm"> * enhanced by Bjoern Brauel and Roman Hodek</span>
<span class="cm"> *</span>
<span class="cm"> * 2.6 and input cleanup (removed autorepeat stuff) for 2.6.21</span>
<span class="cm"> * 06/07 Michael Schmitz</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/keyboard.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/kd.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kbd_kern.h&gt;</span>

<span class="cp">#include &lt;asm/atariints.h&gt;</span>
<span class="cp">#include &lt;asm/atarihw.h&gt;</span>
<span class="cp">#include &lt;asm/atarikb.h&gt;</span>
<span class="cp">#include &lt;asm/atari_joystick.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>


<span class="cm">/* Hook for MIDI serial driver */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">atari_MIDI_interrupt_hook</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cm">/* Hook for keyboard inputdev  driver */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">atari_input_keyboard_interrupt_hook</span><span class="p">)</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">char</span><span class="p">);</span>
<span class="cm">/* Hook for mouse inputdev  driver */</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">atari_input_mouse_interrupt_hook</span><span class="p">)</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">atari_input_keyboard_interrupt_hook</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">atari_input_mouse_interrupt_hook</span><span class="p">);</span>

<span class="cm">/* variables for IKBD self test: */</span>

<span class="cm">/* state: 0: off; &gt;0: in progress; &gt;1: 0xf1 received */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">ikbd_self_test</span><span class="p">;</span>
<span class="cm">/* timestamp when last received a char */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">self_test_last_rcv</span><span class="p">;</span>
<span class="cm">/* bitmap of keys reported as broken */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">broken_keys</span><span class="p">[</span><span class="mi">128</span><span class="o">/</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="cp">#define BREAK_MASK	(0x80)</span>

<span class="cm">/*</span>
<span class="cm"> * ++roman: The following changes were applied manually:</span>
<span class="cm"> *</span>
<span class="cm"> *  - The Alt (= Meta) key works in combination with Shift and</span>
<span class="cm"> *    Control, e.g. Alt+Shift+a sends Meta-A (0xc1), Alt+Control+A sends</span>
<span class="cm"> *    Meta-Ctrl-A (0x81) ...</span>
<span class="cm"> *</span>
<span class="cm"> *  - The parentheses on the keypad send &#39;(&#39; and &#39;)&#39; with all</span>
<span class="cm"> *    modifiers (as would do e.g. keypad &#39;+&#39;), but they cannot be used as</span>
<span class="cm"> *    application keys (i.e. sending Esc O c).</span>
<span class="cm"> *</span>
<span class="cm"> *  - HELP and UNDO are mapped to be F21 and F24, resp, that send the</span>
<span class="cm"> *    codes &quot;\E[M&quot; and &quot;\E[P&quot;. (This is better than the old mapping to</span>
<span class="cm"> *    F11 and F12, because these codes are on Shift+F1/2 anyway.) This</span>
<span class="cm"> *    way, applications that allow their own keyboard mappings</span>
<span class="cm"> *    (e.g. tcsh, X Windows) can be configured to use them in the way</span>
<span class="cm"> *    the label suggests (providing help or undoing).</span>
<span class="cm"> *</span>
<span class="cm"> *  - Console switching is done with Alt+Fx (consoles 1..10) and</span>
<span class="cm"> *    Shift+Alt+Fx (consoles 11..20).</span>
<span class="cm"> *</span>
<span class="cm"> *  - The misc. special function implemented in the kernel are mapped</span>
<span class="cm"> *    to the following key combinations:</span>
<span class="cm"> *</span>
<span class="cm"> *      ClrHome          -&gt; Home/Find</span>
<span class="cm"> *      Shift + ClrHome  -&gt; End/Select</span>
<span class="cm"> *      Shift + Up       -&gt; Page Up</span>
<span class="cm"> *      Shift + Down     -&gt; Page Down</span>
<span class="cm"> *      Alt + Help       -&gt; show system status</span>
<span class="cm"> *      Shift + Help     -&gt; show memory info</span>
<span class="cm"> *      Ctrl + Help      -&gt; show registers</span>
<span class="cm"> *      Ctrl + Alt + Del -&gt; Reboot</span>
<span class="cm"> *      Alt + Undo       -&gt; switch to last console</span>
<span class="cm"> *      Shift + Undo     -&gt; send interrupt</span>
<span class="cm"> *      Alt + Insert     -&gt; stop/start output (same as ^S/^Q)</span>
<span class="cm"> *      Alt + Up         -&gt; Scroll back console (if implemented)</span>
<span class="cm"> *      Alt + Down       -&gt; Scroll forward console (if implemented)</span>
<span class="cm"> *      Alt + CapsLock   -&gt; NumLock</span>
<span class="cm"> *</span>
<span class="cm"> * ++Andreas:</span>
<span class="cm"> *</span>
<span class="cm"> *  - Help mapped to K_HELP</span>
<span class="cm"> *  - Undo mapped to K_UNDO (= K_F246)</span>
<span class="cm"> *  - Keypad Left/Right Parenthesis mapped to new K_PPAREN[LR]</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="n">kb_state_t</span> <span class="p">{</span>
	<span class="n">KEYBOARD</span><span class="p">,</span> <span class="n">AMOUSE</span><span class="p">,</span> <span class="n">RMOUSE</span><span class="p">,</span> <span class="n">JOYSTICK</span><span class="p">,</span> <span class="n">CLOCK</span><span class="p">,</span> <span class="n">RESYNC</span>
<span class="p">}</span> <span class="n">KB_STATE_T</span><span class="p">;</span>

<span class="cp">#define	IS_SYNC_CODE(sc)	((sc) &gt;= 0x04 &amp;&amp; (sc) &lt;= 0xfb)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">keyboard_state</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">KB_STATE_T</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span> <span class="n">KEYBOARD_STATE</span><span class="p">;</span>

<span class="n">KEYBOARD_STATE</span> <span class="n">kb_state</span><span class="p">;</span>

<span class="cm">/* ++roman: If a keyboard overrun happened, we can&#39;t tell in general how much</span>
<span class="cm"> * bytes have been lost and in which state of the packet structure we are now.</span>
<span class="cm"> * This usually causes keyboards bytes to be interpreted as mouse movements</span>
<span class="cm"> * and vice versa, which is very annoying. It seems better to throw away some</span>
<span class="cm"> * bytes (that are usually mouse bytes) than to misinterpret them. Therefore I</span>
<span class="cm"> * introduced the RESYNC state for IKBD data. In this state, the bytes up to</span>
<span class="cm"> * one that really looks like a key event (0x04..0xf2) or the start of a mouse</span>
<span class="cm"> * packet (0xf8..0xfb) are thrown away, but at most 2 bytes. This at least</span>
<span class="cm"> * speeds up the resynchronization of the event structure, even if maybe a</span>
<span class="cm"> * mouse movement is lost. However, nothing is perfect. For bytes 0x01..0x03,</span>
<span class="cm"> * it&#39;s really hard to decide whether they&#39;re mouse or keyboard bytes. Since</span>
<span class="cm"> * overruns usually occur when moving the Atari mouse rapidly, they&#39;re seen as</span>
<span class="cm"> * mouse bytes here. If this is wrong, only a make code of the keyboard gets</span>
<span class="cm"> * lost, which isn&#39;t too bad. Losing a break code would be disastrous,</span>
<span class="cm"> * because then the keyboard repeat strikes...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">atari_keyboard_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">acia_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scancode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">break_flag</span><span class="p">;</span>

<span class="nl">repeat:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span> <span class="o">&amp;</span> <span class="n">ACIA_IRQ</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atari_MIDI_interrupt_hook</span><span class="p">)</span>
			<span class="n">atari_MIDI_interrupt_hook</span><span class="p">();</span>
	<span class="n">acia_stat</span> <span class="o">=</span> <span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span><span class="p">;</span>
	<span class="cm">/* check out if the interrupt came from this ACIA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">acia_stat</span> <span class="o">|</span> <span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ACIA_IRQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acia_stat</span> <span class="o">&amp;</span> <span class="n">ACIA_OVRN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* a very fast typist or a slow system, give a warning */</span>
		<span class="cm">/* ...happens often if interrupts were disabled for too long */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Keyboard overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">acia</span><span class="p">.</span><span class="n">key_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ikbd_self_test</span><span class="p">)</span>
			<span class="cm">/* During self test, don&#39;t do resyncing, just process the code */</span>
			<span class="k">goto</span> <span class="n">interpret_scancode</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_SYNC_CODE</span><span class="p">(</span><span class="n">scancode</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This code seem already to be the start of a new packet or a</span>
<span class="cm">			 * single scancode */</span>
			<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">interpret_scancode</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Go to RESYNC state and skip this byte */</span>
			<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">RESYNC</span><span class="p">;</span>
			<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* skip max. 1 another byte */</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acia_stat</span> <span class="o">&amp;</span> <span class="n">ACIA_RDRF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* received a character */</span>
		<span class="n">scancode</span> <span class="o">=</span> <span class="n">acia</span><span class="p">.</span><span class="n">key_data</span><span class="p">;</span>	<span class="cm">/* get it or reset the ACIA, I&#39;ll get it! */</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_tasklet</span><span class="p">);</span>
	<span class="nl">interpret_scancode:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KEYBOARD</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">scancode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0xF7</span>:
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">AMOUSE</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0xF8</span>:
			<span class="k">case</span> <span class="mh">0xF9</span>:
			<span class="k">case</span> <span class="mh">0xFA</span>:
			<span class="k">case</span> <span class="mh">0xFB</span>:
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">RMOUSE</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0xFC</span>:
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CLOCK</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0xFE</span>:
			<span class="k">case</span> <span class="mh">0xFF</span>:
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">JOYSTICK</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0xF1</span>:
				<span class="cm">/* during self-test, note that 0xf1 received */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ikbd_self_test</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">++</span><span class="n">ikbd_self_test</span><span class="p">;</span>
					<span class="n">self_test_last_rcv</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* FALL THROUGH */</span>

			<span class="nl">default:</span>
				<span class="n">break_flag</span> <span class="o">=</span> <span class="n">scancode</span> <span class="o">&amp;</span> <span class="n">BREAK_MASK</span><span class="p">;</span>
				<span class="n">scancode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BREAK_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ikbd_self_test</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Scancodes sent during the self-test stand for broken</span>
<span class="cm">					 * keys (keys being down). The code *should* be a break</span>
<span class="cm">					 * code, but nevertheless some AT keyboard interfaces send</span>
<span class="cm">					 * make codes instead. Therefore, simply ignore</span>
<span class="cm">					 * break_flag...</span>
<span class="cm">					 */</span>
					<span class="kt">int</span> <span class="n">keyval</span><span class="p">,</span> <span class="n">keytyp</span><span class="p">;</span>

					<span class="n">set_bit</span><span class="p">(</span><span class="n">scancode</span><span class="p">,</span> <span class="n">broken_keys</span><span class="p">);</span>
					<span class="n">self_test_last_rcv</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
					<span class="cm">/* new Linux scancodes; approx. */</span>
					<span class="n">keyval</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
					<span class="n">keytyp</span> <span class="o">=</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">keyval</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xf0</span><span class="p">;</span>
					<span class="n">keyval</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">keyval</span><span class="p">);</span>

					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Key with scancode %d &quot;</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">keytyp</span> <span class="o">==</span> <span class="n">KT_LATIN</span> <span class="o">||</span> <span class="n">keytyp</span> <span class="o">==</span> <span class="n">KT_LETTER</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">keyval</span> <span class="o">&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(&#39;^%c&#39;) &quot;</span><span class="p">,</span> <span class="n">keyval</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">);</span>
						<span class="k">else</span>
							<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(&#39;%c&#39;) &quot;</span><span class="p">,</span> <span class="n">keyval</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;is broken -- will be ignored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">scancode</span><span class="p">,</span> <span class="n">broken_keys</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">atari_input_keyboard_interrupt_hook</span><span class="p">)</span>
					<span class="n">atari_input_keyboard_interrupt_hook</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">scancode</span><span class="p">,</span> <span class="o">!</span><span class="n">break_flag</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">AMOUSE</span>:
			<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
				<span class="cm">/* not yet used */</span>
				<span class="cm">/* wake up someone waiting for this */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RMOUSE</span>:
			<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">atari_input_mouse_interrupt_hook</span><span class="p">)</span>
					<span class="n">atari_input_mouse_interrupt_hook</span><span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">JOYSTICK</span>:
			<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
			<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
<span class="cp">#ifdef FIXED_ATARI_JOYSTICK</span>
			<span class="n">atari_joystick_interrupt</span><span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLOCK</span>:
			<span class="n">kb_state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">scancode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
				<span class="cm">/* wake up someone waiting for this.</span>
<span class="cm">				   But will this ever be used, as Linux keeps its own time.</span>
<span class="cm">				   Perhaps for synchronization purposes? */</span>
				<span class="cm">/* wake_up_interruptible(&amp;clock_wait); */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RESYNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">IS_SYNC_CODE</span><span class="p">(</span><span class="n">scancode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">interpret_scancode</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (acia_stat &amp; ACIA_CTS)</span>
<span class="c">		/* cannot happen */;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acia_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACIA_FE</span> <span class="o">|</span> <span class="n">ACIA_PE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error in keyboard communication</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* handle_scancode() can take a lot of time, so check again if</span>
<span class="cm">	 * some character arrived</span>
<span class="cm">	 */</span>
	<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I write to the keyboard without using interrupts, I poll instead.</span>
<span class="cm"> * This takes for the maximum length string allowed (7) at 7812.5 baud</span>
<span class="cm"> * 8 data 1 start 1 stop bit: 9.0 ms</span>
<span class="cm"> * If this takes too long for normal operation, interrupt driven writing</span>
<span class="cm"> * is the solution. (I made a feeble attempt in that direction but I</span>
<span class="cm"> * kept it simple for now.)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ikbd_write</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">acia_stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;ikbd: maximum string length exceeded&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acia_stat</span> <span class="o">=</span> <span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acia_stat</span> <span class="o">&amp;</span> <span class="n">ACIA_TDRE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acia</span><span class="p">.</span><span class="n">key_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Reset (without touching the clock) */</span>
<span class="kt">void</span> <span class="nf">ikbd_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if all&#39;s well code 0xF1 is returned, else the break codes of</span>
<span class="cm">	 * all keys making contact</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/* Set mouse button action */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_button_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">mode</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set relative mouse position reporting */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_rel_pos</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x08</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ikbd_mouse_rel_pos</span><span class="p">);</span>

<span class="cm">/* Set absolute mouse position reporting */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_abs_pos</span><span class="p">(</span><span class="kt">int</span> <span class="n">xmax</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ymax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">xmax</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">xmax</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ymax</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">ymax</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set mouse keycode mode */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_kbd_mode</span><span class="p">(</span><span class="kt">int</span> <span class="n">dx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set mouse threshold */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_thresh</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ikbd_mouse_thresh</span><span class="p">);</span>

<span class="cm">/* Set mouse scale */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_scale</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Interrogate mouse position */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_pos_get</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0D</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* wait for returning bytes */</span>
<span class="p">}</span>

<span class="cm">/* Load mouse position */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_pos_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">x</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">x</span><span class="o">&amp;</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">y</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">y</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set Y=0 at bottom */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_y0_bot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0F</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set Y=0 at top */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_y0_top</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x10</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ikbd_mouse_y0_top</span><span class="p">);</span>

<span class="cm">/* Resume */</span>
<span class="kt">void</span> <span class="nf">ikbd_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x11</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disable mouse */</span>
<span class="kt">void</span> <span class="nf">ikbd_mouse_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x12</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ikbd_mouse_disable</span><span class="p">);</span>

<span class="cm">/* Pause output */</span>
<span class="kt">void</span> <span class="nf">ikbd_pause</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x13</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set joystick event reporting */</span>
<span class="kt">void</span> <span class="nf">ikbd_joystick_event_on</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x14</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set joystick interrogation mode */</span>
<span class="kt">void</span> <span class="nf">ikbd_joystick_event_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x15</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Joystick interrogation */</span>
<span class="kt">void</span> <span class="nf">ikbd_joystick_get_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x16</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* This disables all other ikbd activities !!!! */</span>
<span class="c">/* Set joystick monitoring */</span>
<span class="c">void ikbd_joystick_monitor(int rate)</span>
<span class="c">{</span>
<span class="c">	static const char cmd[2] = { 0x17, rate };</span>

<span class="c">	ikbd_write(cmd, 2);</span>

<span class="c">	kb_state.state = JOYSTICK_MONITOR;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* some joystick routines not in yet (0x18-0x19) */</span>

<span class="cm">/* Disable joysticks */</span>
<span class="kt">void</span> <span class="nf">ikbd_joystick_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1A</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Time-of-day clock set */</span>
<span class="kt">void</span> <span class="nf">ikbd_clock_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="kt">int</span> <span class="n">month</span><span class="p">,</span> <span class="kt">int</span> <span class="n">day</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hour</span><span class="p">,</span> <span class="kt">int</span> <span class="n">minute</span><span class="p">,</span> <span class="kt">int</span> <span class="n">second</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Interrogate time-of-day clock */</span>
<span class="kt">void</span> <span class="nf">ikbd_clock_get</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">year</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">month</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">day</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hour</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">minute</span><span class="p">,</span> <span class="kt">int</span> <span class="n">second</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1C</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Memory load */</span>
<span class="kt">void</span> <span class="nf">ikbd_mem_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Attempt to write data into keyboard memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Memory read */</span>
<span class="kt">void</span> <span class="nf">ikbd_mem_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="n">address</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">address</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* receive data and put it in data */</span>
<span class="p">}</span>

<span class="cm">/* Controller execute */</span>
<span class="kt">void</span> <span class="nf">ikbd_exec</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">address</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span> <span class="n">address</span><span class="o">&amp;</span><span class="mh">0xFF</span> <span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Status inquiries (0x87-0x9A) not yet implemented */</span>

<span class="cm">/* Set the state of the caps lock led. */</span>
<span class="kt">void</span> <span class="nf">atari_kbd_leds</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">254</span> <span class="o">+</span> <span class="p">((</span><span class="n">leds</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">ikbd_write</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The original code sometimes left the interrupt line of</span>
<span class="cm"> * the ACIAs low forever. I hope, it is fixed now.</span>
<span class="cm"> *</span>
<span class="cm"> * Martin Rogge, 20 Aug 1995</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atari_keyb_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">atari_keyb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atari_keyb_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">KEYBOARD</span><span class="p">;</span>
	<span class="n">kb_state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MFP_ACIA</span><span class="p">,</span> <span class="n">atari_keyboard_interrupt</span><span class="p">,</span>
			    <span class="n">IRQ_TYPE_SLOW</span><span class="p">,</span> <span class="s">&quot;keyboard,mouse,MIDI&quot;</span><span class="p">,</span>
			    <span class="n">atari_keyboard_interrupt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">atari_turnoff_irq</span><span class="p">(</span><span class="n">IRQ_MFP_ACIA</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* reset IKBD ACIA */</span>
		<span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span> <span class="o">=</span> <span class="n">ACIA_RESET</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_IKBD</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ACIA_RHTID</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">acia</span><span class="p">.</span><span class="n">key_data</span><span class="p">;</span>

		<span class="cm">/* reset MIDI ACIA */</span>
		<span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span> <span class="o">=</span> <span class="n">ACIA_RESET</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_MIDI</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ACIA_RHTID</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">acia</span><span class="p">.</span><span class="n">mid_data</span><span class="p">;</span>

		<span class="cm">/* divide 500kHz by 64 gives 7812.5 baud */</span>
		<span class="cm">/* 8 data no parity 1 start 1 stop bit */</span>
		<span class="cm">/* receive interrupt enabled */</span>
		<span class="cm">/* RTS low (except if switch selected), transmit interrupt disabled */</span>
		<span class="n">acia</span><span class="p">.</span><span class="n">key_ctrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">ACIA_DIV64</span><span class="o">|</span><span class="n">ACIA_D8N1S</span><span class="o">|</span><span class="n">ACIA_RIE</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_IKBD</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ACIA_RHTID</span> <span class="o">:</span> <span class="n">ACIA_RLTID</span><span class="p">);</span>

		<span class="n">acia</span><span class="p">.</span><span class="n">mid_ctrl</span> <span class="o">=</span> <span class="n">ACIA_DIV16</span> <span class="o">|</span> <span class="n">ACIA_D8N1S</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">atari_switches</span> <span class="o">&amp;</span> <span class="n">ATARI_SWITCH_MIDI</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ACIA_RHTID</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* make sure the interrupt line is up */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">st_mfp</span><span class="p">.</span><span class="n">par_dt_reg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* enable ACIA Interrupts */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">active_edge</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
	<span class="n">atari_turnon_irq</span><span class="p">(</span><span class="n">IRQ_MFP_ACIA</span><span class="p">);</span>

	<span class="n">ikbd_self_test</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ikbd_reset</span><span class="p">();</span>
	<span class="cm">/* wait for a period of inactivity (here: 0.25s), then assume the IKBD&#39;s</span>
<span class="cm">	 * self-test is finished */</span>
	<span class="n">self_test_last_rcv</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">self_test_last_rcv</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">4</span><span class="p">))</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="cm">/* if not incremented: no 0xf1 received */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ikbd_self_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;WARNING: keyboard self test failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ikbd_self_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ikbd_mouse_disable</span><span class="p">();</span>
	<span class="n">ikbd_joystick_disable</span><span class="p">();</span>

<span class="cp">#ifdef FIXED_ATARI_JOYSTICK</span>
	<span class="n">atari_joystick_init</span><span class="p">();</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>flag init done</p></td><td class="code"><div class="highlight"><pre>	<span class="n">atari_keyb_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">atari_keyb_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
