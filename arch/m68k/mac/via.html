<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › mac › via.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>via.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	6522 Versatile Interface Adapter (VIA)</span>
<span class="cm"> *</span>
<span class="cm"> *	There are two of these on the Mac II. Some IRQs are vectored</span>
<span class="cm"> *	via them as are assorted bits and bobs - eg RTC, ADB.</span>
<span class="cm"> *</span>
<span class="cm"> * CSA: Motorola seems to have removed documentation on the 6522 from</span>
<span class="cm"> * their web site; try</span>
<span class="cm"> *     http://nerini.drf.com/vectrex/other/text/chips/6522/</span>
<span class="cm"> *     http://www.zymurgy.net/classic/vic20/vicdet1.htm</span>
<span class="cm"> * and</span>
<span class="cm"> *     http://193.23.168.87/mikro_laborversuche/via_iobaustein/via6522_1.html</span>
<span class="cm"> * for info.  A full-text web search on 6522 AND VIA will probably also</span>
<span class="cm"> * net some usefulness. &lt;cananian@alumni.princeton.edu&gt; 20apr1999</span>
<span class="cm"> *</span>
<span class="cm"> * Additional data is here (the SY6522 was used in the Mac II etc):</span>
<span class="cm"> *     http://www.6502.org/documents/datasheets/synertek/synertek_sy6522.pdf</span>
<span class="cm"> *     http://www.6502.org/documents/datasheets/synertek/synertek_sy6522_programming_reference.pdf</span>
<span class="cm"> *</span>
<span class="cm"> * PRAM/RTC access algorithms are from the NetBSD RTC toolkit version 1.08b</span>
<span class="cm"> * by Erik Vogan and adapted to Linux by Joshua M. Thompson (funaho@jurai.org)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>

<span class="cp">#include &lt;asm/bootinfo.h&gt;</span>
<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/macints.h&gt;</span>
<span class="cp">#include &lt;asm/mac_via.h&gt;</span>
<span class="cp">#include &lt;asm/mac_psc.h&gt;</span>
<span class="cp">#include &lt;asm/mac_oss.h&gt;</span>

<span class="k">volatile</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">via1</span><span class="p">,</span> <span class="o">*</span><span class="n">via2</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">rbv_present</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">via_alt_mapping</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">via_alt_mapping</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__u8</span> <span class="n">rbv_clear</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Globals for accessing the VIA chip registers without having to</span>
<span class="cm"> * check if we&#39;re hitting a real VIA or an RBV. Normally you could</span>
<span class="cm"> * just hit the combined register (ie, vIER|rIER) but that seems to</span>
<span class="cm"> * break on AV Macs...probably because they actually decode more than</span>
<span class="cm"> * eight address bits. Why can&#39;t Apple engineers at least be</span>
<span class="cm"> * _consistently_ lazy?                          - 1999-05-21 (jmt)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">gIER</span><span class="p">,</span><span class="n">gIFR</span><span class="p">,</span><span class="n">gBufA</span><span class="p">,</span><span class="n">gBufB</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Timer defs.</span>
<span class="cm"> */</span>

<span class="cp">#define TICK_SIZE		10000</span>
<span class="cp">#define MAC_CLOCK_TICK		(783300/HZ)		</span><span class="cm">/* ticks per HZ */</span><span class="cp"></span>
<span class="cp">#define MAC_CLOCK_LOW		(MAC_CLOCK_TICK&amp;0xFF)</span>
<span class="cp">#define MAC_CLOCK_HIGH		(MAC_CLOCK_TICK&gt;&gt;8)</span>


<span class="cm">/*</span>
<span class="cm"> * On Macs with a genuine VIA chip there is no way to mask an individual slot</span>
<span class="cm"> * interrupt. This limitation also seems to apply to VIA clone logic cores in</span>
<span class="cm"> * Quadra-like ASICs. (RBV and OSS machines don&#39;t have this limitation.)</span>
<span class="cm"> *</span>
<span class="cm"> * We used to fake it by configuring the relevent VIA pin as an output</span>
<span class="cm"> * (to mask the interrupt) or input (to unmask). That scheme did not work on</span>
<span class="cm"> * (at least) the Quadra 700. A NuBus card&#39;s /NMRQ signal is an open-collector</span>
<span class="cm"> * circuit (see Designing Cards and Drivers for Macintosh II and Macintosh SE,</span>
<span class="cm"> * p. 10-11 etc) but VIA outputs are not (see datasheet).</span>
<span class="cm"> *</span>
<span class="cm"> * Driving these outputs high must cause the VIA to source current and the</span>
<span class="cm"> * card to sink current when it asserts /NMRQ. Current will flow but the pin</span>
<span class="cm"> * voltage is uncertain and so the /NMRQ condition may still cause a transition</span>
<span class="cm"> * at the VIA2 CA1 input (which explains the lost interrupts). A side effect</span>
<span class="cm"> * is that a disabled slot IRQ can never be tested as pending or not.</span>
<span class="cm"> *</span>
<span class="cm"> * Driving these outputs low doesn&#39;t work either. All the slot /NMRQ lines are</span>
<span class="cm"> * (active low) OR&#39;d together to generate the CA1 (aka &quot;SLOTS&quot;) interrupt (see</span>
<span class="cm"> * The Guide To Macintosh Family Hardware, 2nd edition p. 167). If we drive a</span>
<span class="cm"> * disabled /NMRQ line low, the falling edge immediately triggers a CA1</span>
<span class="cm"> * interrupt and all slot interrupts after that will generate no transition</span>
<span class="cm"> * and therefore no interrupt, even after being re-enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * So we make the VIA port A I/O lines inputs and use nubus_disabled to keep</span>
<span class="cm"> * track of their states. When any slot IRQ becomes disabled we mask the CA1</span>
<span class="cm"> * umbrella interrupt. Only when all slot IRQs become enabled do we unmask</span>
<span class="cm"> * the CA1 interrupt. It must remain enabled even when cards have no interrupt</span>
<span class="cm"> * handler registered. Drivers must therefore disable a slot interrupt at the</span>
<span class="cm"> * device before they call free_irq (like shared and autovector interrupts).</span>
<span class="cm"> *</span>
<span class="cm"> * There is also a related problem when MacOS is used to boot Linux. A network</span>
<span class="cm"> * card brought up by a MacOS driver may raise an interrupt while Linux boots.</span>
<span class="cm"> * This can be fatal since it can&#39;t be handled until the right driver loads</span>
<span class="cm"> * (if such a driver exists at all). Apparently related to this hardware</span>
<span class="cm"> * limitation, &quot;Designing Cards and Drivers&quot;, p. 9-8, says that a slot</span>
<span class="cm"> * interrupt with no driver would crash MacOS (the book was written before</span>
<span class="cm"> * the appearance of Macs with RBV or OSS).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">nubus_disabled</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">via_debug_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the VIAs</span>
<span class="cm"> *</span>
<span class="cm"> * First we figure out where they actually _are_ as well as what type of</span>
<span class="cm"> * VIA we have for VIA2 (it could be a real VIA or an RBV or even an OSS.)</span>
<span class="cm"> * Then we pretty much clear them out and disable all IRQ sources.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: the OSS is actually &quot;detected&quot; here and not in oss_init(). It just</span>
<span class="cm"> *	 seems more logical to do it here since via_init() needs to know</span>
<span class="cm"> *	 these things anyways.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">via_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* IIci, IIsi, IIvx, IIvi (P6xx), LC series */</span>

		<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
			<span class="n">via1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">VIA1_BASE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_IIFX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">via2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">rbv_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">oss_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">via2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">RBV_BASE</span><span class="p">;</span>
				<span class="n">rbv_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">oss_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_LCIII</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rbv_clear</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* on most RBVs (&amp; unlike the VIAs), you   */</span>
				<span class="cm">/* need to set bit 7 when you write to IFR */</span>
				<span class="cm">/* in order for your clear to occur.       */</span>
				<span class="n">rbv_clear</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gIER</span> <span class="o">=</span> <span class="n">rIER</span><span class="p">;</span>
			<span class="n">gIFR</span> <span class="o">=</span> <span class="n">rIFR</span><span class="p">;</span>
			<span class="n">gBufA</span> <span class="o">=</span> <span class="n">rSIFR</span><span class="p">;</span>
			<span class="n">gBufB</span> <span class="o">=</span> <span class="n">rBufB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Quadra and early MacIIs agree on the VIA locations */</span>

		<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
		<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
			<span class="n">via1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">VIA1_BASE</span><span class="p">;</span>
			<span class="n">via2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">VIA2_BASE</span><span class="p">;</span>
			<span class="n">rbv_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">oss_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rbv_clear</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="n">gIER</span> <span class="o">=</span> <span class="n">vIER</span><span class="p">;</span>
			<span class="n">gIFR</span> <span class="o">=</span> <span class="n">vIFR</span><span class="p">;</span>
			<span class="n">gBufA</span> <span class="o">=</span> <span class="n">vBufA</span><span class="p">;</span>
			<span class="n">gBufB</span> <span class="o">=</span> <span class="n">vBufB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;UNKNOWN VIA TYPE&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;VIA1 at %p is a 6522 or clone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">via1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;VIA2 at %p is &quot;</span><span class="p">,</span> <span class="n">via2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbv_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;an RBV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oss_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;an OSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;a 6522 or clone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG_VIA</span>
	<span class="n">via_debug_dump</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Shut down all IRQ sources, reset the timers, and</span>
<span class="cm">	 * kill the timer latch on VIA1.</span>
<span class="cm">	 */</span>

	<span class="n">via1</span><span class="p">[</span><span class="n">vIER</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vIFR</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1LL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1LH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1CL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1CH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT2CL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT2CH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xC0</span><span class="p">;</span> <span class="cm">/* setup T1 timer with no PB7 output */</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* disable port A &amp; B latches */</span>

	<span class="cm">/*</span>
<span class="cm">	 * SE/30: disable video IRQ</span>
<span class="cm">	 * XXX: testing for SE/30 VBL</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">MAC_MODEL_SE30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vDirB</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vBufB</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the RTC bits to a known state: all lines to outputs and</span>
<span class="cm">	 * RTC disabled (yes that&#39;s 0 to enable and 1 to disable).</span>
<span class="cm">	 */</span>

	<span class="n">via1</span><span class="p">[</span><span class="n">vDirB</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VIA1B_vRTCEnb</span> <span class="o">|</span> <span class="n">VIA1B_vRTCClk</span> <span class="o">|</span> <span class="n">VIA1B_vRTCData</span><span class="p">);</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vBufB</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">VIA1B_vRTCEnb</span> <span class="o">|</span> <span class="n">VIA1B_vRTCClk</span><span class="p">);</span>

	<span class="cm">/* Everything below this point is VIA2/RBV only... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oss_present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span> <span class="o">==</span> <span class="n">MAC_VIA_QUADRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_PB1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_PB2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span>    <span class="o">!=</span> <span class="n">MAC_MODEL_C660</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span>    <span class="o">!=</span> <span class="n">MAC_MODEL_Q840</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">via_alt_mapping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vDirB</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vBufB</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">via_alt_mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now initialize VIA2. For RBV we just kill all interrupts;</span>
<span class="cm">	 * for a regular VIA we also reset the timers and stuff.</span>
<span class="cm">	 */</span>

	<span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="n">via2</span><span class="p">[</span><span class="n">gIFR</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span> <span class="o">|</span> <span class="n">rbv_clear</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbv_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT1LL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT1LH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT1CL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT1CH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT2CL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vT2CH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xC0</span><span class="p">;</span> <span class="cm">/* setup T1 timer with no PB7 output */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* disable port A &amp; B latches */</span>
	<span class="p">}</span>

	<span class="cm">/* Everything below this point is VIA2 only... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rbv_present</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set vPCR for control line interrupts.</span>
<span class="cm">	 *</span>
<span class="cm">	 * CA1 (SLOTS IRQ), CB1 (ASC IRQ): negative edge trigger.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Macs with ESP SCSI have a negative edge triggered SCSI interrupt.</span>
<span class="cm">	 * Testing reveals that PowerBooks do too. However, the SE/30</span>
<span class="cm">	 * schematic diagram shows an active high NCR5380 IRQ line.</span>
<span class="cm">	 */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VIA2 vPCR is 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">via2</span><span class="p">[</span><span class="n">vPCR</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span> <span class="o">==</span> <span class="n">MAC_VIA_II</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CA2 (SCSI DRQ), CB2 (SCSI IRQ): indep. input, pos. edge */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vPCR</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* CA2 (SCSI DRQ), CB2 (SCSI IRQ): indep. input, neg. edge */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">vPCR</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start the 100 Hz clock</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">via_init_clock</span><span class="p">(</span><span class="n">irq_handler_t</span> <span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vACR</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1LL</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAC_CLOCK_LOW</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1LH</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAC_CLOCK_HIGH</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1CL</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAC_CLOCK_LOW</span><span class="p">;</span>
	<span class="n">via1</span><span class="p">[</span><span class="n">vT1CH</span><span class="p">]</span> <span class="o">=</span> <span class="n">MAC_CLOCK_HIGH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MAC_TIMER_1</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;timer&quot;</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register %s interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;timer&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Debugging dump, used in various places to see what&#39;s going on.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">via_debug_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIA1: DDRA = 0x%02X DDRB = 0x%02X ACR = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vDirA</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vDirB</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vACR</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;         PCR = 0x%02X  IFR = 0x%02X IER = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vPCR</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vIFR</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via1</span><span class="p">[</span><span class="n">vIER</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oss_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIA2: &lt;OSS&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rbv_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIA2:  IFR = 0x%02X  IER = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">rIFR</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">rIER</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;      SIFR = 0x%02X SIER = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">rSIFR</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;VIA2: DDRA = 0x%02X DDRB = 0x%02X ACR = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vDirB</span><span class="p">],</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vACR</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;         PCR = 0x%02X  IFR = 0x%02X IER = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vPCR</span><span class="p">],</span>
			<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vIFR</span><span class="p">],</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">vIER</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is always executed with interrupts disabled.</span>
<span class="cm"> *</span>
<span class="cm"> * TBI: get time offset between scheduling timer ticks</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">mac_gettimeoffset</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* read VIA1 timer 2 current value */</span>
	<span class="n">ticks</span> <span class="o">=</span> <span class="n">via1</span><span class="p">[</span><span class="n">vT1CL</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">via1</span><span class="p">[</span><span class="n">vT1CH</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* The probability of underflow is less than 2% */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="n">MAC_CLOCK_TICK</span> <span class="o">-</span> <span class="n">MAC_CLOCK_TICK</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span>
		<span class="cm">/* Check for pending timer interrupt in VIA1 IFR */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">via1</span><span class="p">[</span><span class="n">vIFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">TICK_SIZE</span><span class="p">;</span>

	<span class="n">ticks</span> <span class="o">=</span> <span class="n">MAC_CLOCK_TICK</span> <span class="o">-</span> <span class="n">ticks</span><span class="p">;</span>
	<span class="n">ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">*</span> <span class="mi">10000L</span> <span class="o">/</span> <span class="n">MAC_CLOCK_TICK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ticks</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flush the L2 cache on Macs that have it by flipping</span>
<span class="cm"> * the system into 24-bit mode for an instant.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">via_flush_cache</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">via2</span><span class="p">[</span><span class="n">gBufB</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA2B_vMode32</span><span class="p">;</span>
	<span class="n">via2</span><span class="p">[</span><span class="n">gBufB</span><span class="p">]</span> <span class="o">|=</span> <span class="n">VIA2B_vMode32</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the status of the L2 cache on a IIci</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">via_get_cache_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Safeguard against being called accidentally */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">via2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via_get_cache_disable called on a non-VIA machine!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">via2</span><span class="p">[</span><span class="n">gBufB</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VIA2B_vCDis</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize VIA2 for Nubus access</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">via_nubus_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unlock nubus transactions */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_PB1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_PB2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* set the line to be an output on non-RBV machines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbv_present</span><span class="p">)</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">vDirB</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="cm">/* this seems to be an ADB bit on PMU machines */</span>
		<span class="cm">/* according to MkLinux.  -- jmt               */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">gBufB</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the slot interrupts. On some hardware that&#39;s not possible.</span>
<span class="cm">	 * On some hardware it&#39;s unclear what all of these I/O lines do.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
	<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VIA2 vDirA is 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
		<span class="cm">/* RBV. Disable all the slot interrupts. SIER works like IER. */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">via_nubus_irq_startup</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_idx</span> <span class="o">=</span> <span class="n">IRQ_IDX</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
	<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
		<span class="cm">/* Make the port A line an input. Probably redundant. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span> <span class="o">==</span> <span class="n">MAC_VIA_II</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The top two bits are RAM size outputs. */</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xC0</span> <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq_idx</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Allow NuBus slots 9 through F. */</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
		<span class="n">via_irq_enable</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">via_nubus_irq_shutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
	<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
		<span class="cm">/* Ensure that the umbrella CA1 interrupt remains enabled. */</span>
		<span class="n">via_irq_enable</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
		<span class="n">via_irq_disable</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The generic VIA interrupt routines (shamelessly stolen from Alan Cox&#39;s</span>
<span class="cm"> * via6522.c :-), disable/pending masks added.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">via1_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq_bit</span><span class="p">,</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">via1</span><span class="p">[</span><span class="n">vIFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">via1</span><span class="p">[</span><span class="n">vIER</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">irq_num</span> <span class="o">=</span> <span class="n">VIA1_SOURCE_BASE</span><span class="p">;</span>
	<span class="n">irq_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">irq_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">via1</span><span class="p">[</span><span class="n">vIFR</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq_bit</span><span class="p">;</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq_num</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">irq_num</span><span class="p">;</span>
		<span class="n">irq_bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">events</span> <span class="o">&gt;=</span> <span class="n">irq_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via2_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq_bit</span><span class="p">,</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="n">via2</span><span class="p">[</span><span class="n">gIFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">irq_num</span> <span class="o">=</span> <span class="n">VIA2_SOURCE_BASE</span><span class="p">;</span>
	<span class="n">irq_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">irq_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">gIFR</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq_bit</span> <span class="o">|</span> <span class="n">rbv_clear</span><span class="p">;</span>
			<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">irq_num</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">irq_num</span><span class="p">;</span>
		<span class="n">irq_bit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">events</span> <span class="o">&gt;=</span> <span class="n">irq_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Dispatch Nubus interrupts. We are called as a secondary dispatch by the</span>
<span class="cm"> * VIA2 dispatcher as a fast interrupt handler.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">via_nubus_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">irq_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot_irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">slot_bit</span><span class="p">,</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">events</span> <span class="o">=</span> <span class="o">~</span><span class="n">via2</span><span class="p">[</span><span class="n">gBufA</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbv_present</span><span class="p">)</span>
		<span class="n">events</span> <span class="o">&amp;=</span> <span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">events</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">slot_irq</span> <span class="o">=</span> <span class="n">IRQ_NUBUS_F</span><span class="p">;</span>
		<span class="n">slot_bit</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">slot_bit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">events</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">slot_bit</span><span class="p">;</span>
				<span class="n">generic_handle_irq</span><span class="p">(</span><span class="n">slot_irq</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">--</span><span class="n">slot_irq</span><span class="p">;</span>
			<span class="n">slot_bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">events</span><span class="p">);</span>

 		<span class="cm">/* clear the CA1 interrupt and make certain there&#39;s no more. */</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">gIFR</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span> <span class="o">|</span> <span class="n">rbv_clear</span><span class="p">;</span>
		<span class="n">events</span> <span class="o">=</span> <span class="o">~</span><span class="n">via2</span><span class="p">[</span><span class="n">gBufA</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbv_present</span><span class="p">)</span>
			<span class="n">events</span> <span class="o">&amp;=</span> <span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">events</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">via2</span><span class="p">[</span><span class="n">vDirA</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">events</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register the interrupt dispatchers for VIA or RBV machines only.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">via_register_interrupts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">via_alt_mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* software interrupt */</span>
		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_AUTO_1</span><span class="p">,</span> <span class="n">via1_irq</span><span class="p">);</span>
		<span class="cm">/* via1 interrupt */</span>
		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_AUTO_6</span><span class="p">,</span> <span class="n">via1_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_AUTO_1</span><span class="p">,</span> <span class="n">via1_irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_AUTO_2</span><span class="p">,</span> <span class="n">via2_irq</span><span class="p">);</span>
	<span class="n">irq_set_chained_handler</span><span class="p">(</span><span class="n">IRQ_MAC_NUBUS</span><span class="p">,</span> <span class="n">via_nubus_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">via_irq_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_src</span>	<span class="o">=</span> <span class="n">IRQ_SRC</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq_idx</span>	<span class="o">=</span> <span class="n">IRQ_IDX</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_IRQUSE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;via_irq_enable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">IRQ_MAC_NUBUS</span> <span class="o">||</span> <span class="n">nubus_disabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
		<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
			<span class="n">nubus_disabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq_idx</span><span class="p">);</span>
			<span class="cm">/* Enable the CA1 interrupt when no slot is disabled. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nubus_disabled</span><span class="p">)</span>
				<span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
			<span class="cm">/* On RBV, enable the slot interrupt.</span>
<span class="cm">			 * SIER works like IER.</span>
<span class="cm">			 */</span>
			<span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">via_irq_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq_src</span>	<span class="o">=</span> <span class="n">IRQ_SRC</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">irq_idx</span>	<span class="o">=</span> <span class="n">IRQ_IDX</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_IRQUSE</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;via_irq_disable(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_CLR_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_CLR_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq_src</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">via_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MAC_VIA_II</span>:
		<span class="k">case</span> <span class="n">MAC_VIA_QUADRA</span>:
			<span class="n">nubus_disabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">irq_idx</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nubus_disabled</span><span class="p">)</span>
				<span class="n">via2</span><span class="p">[</span><span class="n">gIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_CLR_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MAC_VIA_IICI</span>:
			<span class="n">via2</span><span class="p">[</span><span class="n">rSIER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_CLR_BIT</span><span class="p">(</span><span class="n">irq_idx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">via1_set_head</span><span class="p">(</span><span class="kt">int</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vBufA</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VIA1A_vHeadSel</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">via1</span><span class="p">[</span><span class="n">vBufA</span><span class="p">]</span> <span class="o">|=</span> <span class="n">VIA1A_vHeadSel</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">via1_set_head</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">via2_scsi_drq_pending</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">via2</span><span class="p">[</span><span class="n">gIFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IRQ_IDX</span><span class="p">(</span><span class="n">IRQ_MAC_SCSIDRQ</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">via2_scsi_drq_pending</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
