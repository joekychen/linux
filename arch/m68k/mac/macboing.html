<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › mac › macboing.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>macboing.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	Mac bong noise generator. Note - we ought to put a boingy noise</span>
<span class="cm"> *	here 8)</span>
<span class="cm"> *</span>
<span class="cm"> *	----------------------------------------------------------------------</span>
<span class="cm"> *	16.11.98:</span>
<span class="cm"> *	rewrote some functions, added support for Enhanced ASC (Quadras)</span>
<span class="cm"> *	after the NetBSD asc.c console bell patch by Colin Wood/Frederick Bruck</span>
<span class="cm"> *	Juergen Mellinger (juergen.mellinger@t-online.de)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>

<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/mac_asc.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mac_asc_inited</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * dumb triangular wave table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u8</span> <span class="n">mac_asc_wave_tab</span><span class="p">[</span> <span class="mh">0x800</span> <span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Alan&#39;s original sine table; needs interpolating to 0x800</span>
<span class="cm"> * (hint: interpolate or hardwire [0 -&gt; Pi/2[, it&#39;s symmetric)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">signed</span> <span class="kt">char</span> <span class="n">sine_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">103</span><span class="p">,</span>  <span class="mi">121</span><span class="p">,</span>  <span class="mi">127</span><span class="p">,</span>  <span class="mi">121</span><span class="p">,</span>  <span class="mi">103</span><span class="p">,</span>  <span class="mi">75</span><span class="p">,</span>  <span class="mi">39</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">39</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="o">-</span><span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="o">-</span><span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">75</span><span class="p">,</span> <span class="o">-</span><span class="mi">39</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * where the ASC hides ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="n">__u8</span><span class="o">*</span> <span class="n">mac_asc_regs</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">void</span><span class="o">*</span> <span class="p">)</span><span class="mh">0x50F14000</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * sample rate; is this a good default value?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mac_asc_samplespersec</span> <span class="o">=</span> <span class="mi">11050</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mac_bell_duration</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mac_bell_phase</span><span class="p">;</span> <span class="cm">/* 0..2*Pi -&gt; 0..0x800 (wavetable size) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mac_bell_phasepersample</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * some function protos</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_init_asc</span><span class="p">(</span> <span class="kt">void</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_nosound</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_quadra_start_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_quadra_ring_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_av_start_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span> <span class="o">*</span><span class="n">mac_special_bell</span> <span class="p">)(</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * our timer to start/continue/stop the bell</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">mac_sound_timer</span><span class="p">,</span> <span class="n">mac_nosound</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Sort of initialize the sound chip (called from mac_mksound on the first</span>
<span class="cm"> * beep).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_init_asc</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * do some machine specific initialization</span>
<span class="cm">	 * BTW:</span>
<span class="cm">	 * the NetBSD Quadra patch identifies the Enhanced Apple Sound Chip via</span>
<span class="cm">	 *	mac_asc_regs[ 0x800 ] &amp; 0xF0 != 0</span>
<span class="cm">	 * this makes no sense here, because we have to set the default sample</span>
<span class="cm">	 * rate anyway if we want correct frequencies</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span> <span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_IIFX</span>:
			<span class="cm">/*</span>
<span class="cm">			 * The IIfx is always special ...</span>
<span class="cm">			 */</span>
			<span class="n">mac_asc_regs</span> <span class="o">=</span> <span class="p">(</span> <span class="kt">void</span><span class="o">*</span> <span class="p">)</span><span class="mh">0x50010000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * not sure about how correct this list is</span>
<span class="cm">			 * machines with the EASC enhanced apple sound chip</span>
<span class="cm">			 */</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_Q630</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_P475</span>:
			<span class="n">mac_special_bell</span> <span class="o">=</span> <span class="n">mac_quadra_start_bell</span><span class="p">;</span>
			<span class="n">mac_asc_samplespersec</span> <span class="o">=</span> <span class="mi">22150</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_C660</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q840</span>:
			<span class="cm">/*</span>
<span class="cm">			 * The Quadra 660AV and 840AV use the &quot;Singer&quot; custom ASIC for sound I/O.</span>
<span class="cm">			 * It appears to be similar to the &quot;AWACS&quot; custom ASIC in the Power Mac</span>
<span class="cm">			 * [678]100.  Because Singer and AWACS may have a similar hardware</span>
<span class="cm">			 * interface, this would imply that the code in drivers/sound/dmasound.c</span>
<span class="cm">			 * for AWACS could be used as a basis for Singer support.  All we have to</span>
<span class="cm">			 * do is figure out how to do DMA on the 660AV/840AV through the PSC and</span>
<span class="cm">			 * figure out where the Singer hardware sits in memory. (I&#39;d look in the</span>
<span class="cm">			 * vicinity of the AWACS location in a Power Mac [678]100 first, or the</span>
<span class="cm">			 * current location of the Apple Sound Chip--ASC--in other Macs.)  The</span>
<span class="cm">			 * Power Mac [678]100 info can be found in MkLinux Mach kernel sources.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Quoted from Apple&#39;s Tech Info Library, article number 16405:</span>
<span class="cm">			 *   &quot;Among desktop Macintosh computers, only the 660AV, 840AV, and Power</span>
<span class="cm">			 *   Macintosh models have 16-bit audio input and output capability</span>
<span class="cm">			 *   because of the AT&amp;T DSP3210 hardware circuitry and the 16-bit Singer</span>
<span class="cm">			 *   codec circuitry in the AVs.  The Audio Waveform Amplifier and</span>
<span class="cm">			 *   Converter (AWAC) chip in the Power Macintosh performs the same</span>
<span class="cm">			 *   16-bit I/O functionality.  The PowerBook 500 series computers</span>
<span class="cm">			 *   support 16-bit stereo output, but only mono input.&quot;</span>
<span class="cm">			 *</span>
<span class="cm">			 *   Technical Information Library (TIL) article number 16405. </span>
<span class="cm">			 *   http://support.apple.com/kb/TA32601 </span>
<span class="cm">			 *</span>
<span class="cm">			 * --David Kilzer</span>
<span class="cm">			 */</span>
			<span class="n">mac_special_bell</span> <span class="o">=</span> <span class="n">mac_av_start_bell</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MAC_MODEL_Q650</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q700</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q800</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q900</span>:
		<span class="k">case</span> <span class="n">MAC_MODEL_Q950</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Currently not implemented!</span>
<span class="cm">			 */</span>
			<span class="n">mac_special_bell</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/*</span>
<span class="cm">			 * Every switch needs a default</span>
<span class="cm">			 */</span>
			<span class="n">mac_special_bell</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * init the wave table with a simple triangular wave</span>
<span class="cm">	 * A sine wave would sure be nicer here ...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mac_asc_wave_tab</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">mac_asc_wave_tab</span><span class="p">[</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">-</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mac_asc_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called to make noise; current single entry to the boing driver.</span>
<span class="cm"> * Does the job for simple ASC, calls other routines else.</span>
<span class="cm"> * XXX Fixme:</span>
<span class="cm"> * Should be split into asc_mksound, easc_mksound, av_mksound and</span>
<span class="cm"> * function pointer set in mac_init_asc which would be called at</span>
<span class="cm"> * init time.</span>
<span class="cm"> * _This_ is rather ugly ...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_mksound</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">cfreq</span> <span class="o">=</span> <span class="p">(</span> <span class="n">freq</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">468</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">mac_special_bell</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Do nothing */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">mac_asc_inited</span> <span class="p">)</span>
		<span class="n">mac_init_asc</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">mac_special_bell</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mac_special_bell</span><span class="p">(</span> <span class="n">freq</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="mi">128</span> <span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">20000</span> <span class="o">||</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mac_nosound</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mac_sound_timer</span> <span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x800</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x800</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">mac_asc_wave_tab</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="o">*</span><span class="p">(</span> <span class="n">__u32</span><span class="o">*</span> <span class="p">)(</span> <span class="p">(</span> <span class="n">__u32</span> <span class="p">)</span><span class="n">mac_asc_regs</span> <span class="o">+</span> <span class="n">ASC_CONTROL</span> <span class="o">+</span> <span class="mh">0x814</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">i</span> <span class="p">)</span> <span class="o">=</span> <span class="n">cfreq</span><span class="p">;</span>

	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x807</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">ASC_VOLUME</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x805</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x80F</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">ASC_MODE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">ASC_MODE_SAMPLE</span><span class="p">;</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">ASC_ENABLE</span> <span class="p">]</span> <span class="o">=</span> <span class="n">ASC_ENABLE_SAMPLE</span><span class="p">;</span>

	<span class="n">mac_sound_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mac_sound_timer</span> <span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * regular ASC: stop whining ..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_nosound</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ignored</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="n">ASC_ENABLE</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * EASC entry; init EASC, don&#39;t load wavetable, schedule &#39;start whining&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_quadra_start_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">volume</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* if the bell is already ringing, ring longer */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">mac_bell_duration</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">mac_bell_duration</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_bell_duration</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">mac_bell_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mac_bell_phasepersample</span> <span class="o">=</span> <span class="p">(</span> <span class="n">freq</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">mac_asc_wave_tab</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">mac_asc_samplespersec</span><span class="p">;</span>
	<span class="cm">/* this is reasonably big for small frequencies */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* set the volume */</span>
	<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x806</span> <span class="p">]</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>

	<span class="cm">/* set up the ASC registers */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x801</span> <span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* select mono mode */</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x807</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* select sampled sound mode */</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x802</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* ??? */</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x801</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x803</span> <span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x803</span> <span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac_sound_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">mac_quadra_ring_bell</span><span class="p">;</span>
	<span class="n">mac_sound_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mac_sound_timer</span> <span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * EASC &#39;start/continue whining&#39;; I&#39;m not sure why the above function didn&#39;t</span>
<span class="cm"> * already load the wave table, or at least call this one...</span>
<span class="cm"> * This piece keeps reloading the wave table until done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_quadra_ring_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ignored</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mac_asc_samplespersec</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we neither want a sound buffer overflow nor underflow, so we need to match</span>
<span class="cm">	 * the number of samples per timer interrupt as exactly as possible.</span>
<span class="cm">	 * using the asc interrupt will give better results in the future</span>
<span class="cm">	 * ...and the possibility to use a real sample (a boingy noise, maybe...)</span>
<span class="cm">	 */</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mac_sound_timer</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">mac_bell_duration</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">mac_bell_phase</span> <span class="o">+=</span> <span class="n">mac_bell_phasepersample</span><span class="p">;</span>
			<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">mac_asc_wave_tab</span><span class="p">[</span> <span class="n">mac_bell_phase</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">mac_asc_wave_tab</span> <span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">];</span>
		<span class="p">}</span>
		<span class="n">mac_sound_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mac_sound_timer</span> <span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">mac_asc_regs</span><span class="p">[</span> <span class="mh">0x801</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AV code - please fill in.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_av_start_bell</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">volume</span> <span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
