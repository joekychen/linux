<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › q40 › q40ints.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>q40ints.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * arch/m68k/q40/q40ints.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999,2001 Richard Zidlicky</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * .. used to be loosely based on bvme6000ints.c</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>

<span class="cp">#include &lt;asm/q40_master.h&gt;</span>
<span class="cp">#include &lt;asm/q40ints.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Q40 IRQs are defined as follows:</span>
<span class="cm"> *            3,4,5,6,7,10,11,14,15 : ISA dev IRQs</span>
<span class="cm"> *            16-31: reserved</span>
<span class="cm"> *            32   : keyboard int</span>
<span class="cm"> *            33   : frame int (50/200 Hz periodic timer)</span>
<span class="cm"> *            34   : sample int (10/20 KHz periodic timer)</span>
<span class="cm"> *</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">q40_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">q40_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">q40_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">q40_ablecount</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">q40_state</span><span class="p">[</span><span class="mi">35</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">q40_irq_startup</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* test for ISA ints not implemented by HW */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="k">case</span> <span class="mi">2</span>: <span class="k">case</span> <span class="mi">8</span>: <span class="k">case</span> <span class="mi">9</span>:
	<span class="k">case</span> <span class="mi">11</span>: <span class="k">case</span> <span class="mi">12</span>: <span class="k">case</span> <span class="mi">13</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ISA IRQ %d not implemented by HW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="cm">/* FIXME return -ENXIO; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">q40_irq_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span> <span class="n">q40_irq_chip</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;q40&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_startup</span>	<span class="o">=</span> <span class="n">q40_irq_startup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_shutdown</span>	<span class="o">=</span> <span class="n">q40_irq_shutdown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_enable</span>	<span class="o">=</span> <span class="n">q40_irq_enable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irq_disable</span>	<span class="o">=</span> <span class="n">q40_irq_disable</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * void q40_init_IRQ (void)</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:	None</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:	Nothing</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called during kernel startup to initialize</span>
<span class="cm"> * the q40 IRQ handling routines.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">disabled</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">__init</span> <span class="nf">q40_init_IRQ</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m68k_setup_irq_controller</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q40_irq_chip</span><span class="p">,</span> <span class="n">handle_simple_irq</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				  <span class="n">Q40_IRQ_MAX</span><span class="p">);</span>

	<span class="cm">/* setup handler for ISA ints */</span>
	<span class="n">m68k_setup_auto_interrupt</span><span class="p">(</span><span class="n">q40_irq_handler</span><span class="p">);</span>

	<span class="n">m68k_irq_startup_irq</span><span class="p">(</span><span class="n">IRQ_AUTO_2</span><span class="p">);</span>
	<span class="n">m68k_irq_startup_irq</span><span class="p">(</span><span class="n">IRQ_AUTO_4</span><span class="p">);</span>

	<span class="cm">/* now enable some ints.. */</span>
	<span class="n">master_outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EXT_ENABLE_REG</span><span class="p">);</span>  <span class="cm">/* ISA IRQ 5-15 */</span>

	<span class="cm">/* make sure keyboard IRQ is disabled */</span>
	<span class="n">master_outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">KEY_IRQ_ENABLE_REG</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * this stuff doesn&#39;t really belong here..</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">ql_ticks</span><span class="p">;</span>              <span class="cm">/* 200Hz ticks since last jiffie */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sound_ticks</span><span class="p">;</span>

<span class="cp">#define SVOL 45</span>

<span class="kt">void</span> <span class="nf">q40_mksound</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hz</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* for now ignore hz, except that hz==0 switches off sound */</span>
	<span class="cm">/* simply alternate the ampl (128-SVOL)-(128+SVOL)-..-.. at 200Hz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_ticks</span><span class="p">)</span>
			<span class="n">sound_ticks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="o">*</span><span class="n">DAC_LEFT</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="o">*</span><span class="n">DAC_RIGHT</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* sound itself is done in q40_timer_int */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sound_ticks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sound_ticks</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* pretty long beep */</span>
	<span class="n">sound_ticks</span> <span class="o">=</span> <span class="n">ticks</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irq_handler_t</span> <span class="n">q40_timer_routine</span><span class="p">;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">q40_timer_int</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ql_ticks</span> <span class="o">=</span> <span class="n">ql_ticks</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sound_ticks</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sval</span><span class="o">=</span><span class="p">(</span><span class="n">sound_ticks</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">128</span><span class="o">-</span><span class="n">SVOL</span> <span class="o">:</span> <span class="mi">128</span><span class="o">+</span><span class="n">SVOL</span><span class="p">;</span>
		<span class="n">sound_ticks</span><span class="o">--</span><span class="p">;</span>
		<span class="o">*</span><span class="n">DAC_LEFT</span><span class="o">=</span><span class="n">sval</span><span class="p">;</span>
		<span class="o">*</span><span class="n">DAC_RIGHT</span><span class="o">=</span><span class="n">sval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ql_ticks</span><span class="p">)</span>
		<span class="n">q40_timer_routine</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">q40_sched_init</span> <span class="p">(</span><span class="n">irq_handler_t</span> <span class="n">timer_routine</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer_irq</span><span class="p">;</span>

	<span class="n">q40_timer_routine</span> <span class="o">=</span> <span class="n">timer_routine</span><span class="p">;</span>
	<span class="n">timer_irq</span> <span class="o">=</span> <span class="n">Q40_IRQ_FRAME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">timer_irq</span><span class="p">,</span> <span class="n">q40_timer_int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;timer&quot;</span><span class="p">,</span> <span class="n">q40_timer_int</span><span class="p">))</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t register timer int&quot;</span><span class="p">);</span>

	<span class="n">master_outb</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FRAME_CLEAR_REG</span><span class="p">);</span>
	<span class="n">master_outb</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FRAME_RATE_REG</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * tables to translate bits into IRQ numbers</span>
<span class="cm"> * it is a good idea to order the entries by priority</span>
<span class="cm"> *</span>
<span class="cm">*/</span>

<span class="k">struct</span> <span class="n">IRQ_TABLE</span><span class="p">{</span> <span class="kt">unsigned</span> <span class="n">mask</span><span class="p">;</span> <span class="kt">int</span> <span class="n">irq</span> <span class="p">;};</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static struct IRQ_TABLE iirqs[]={</span>
<span class="c">  {Q40_IRQ_FRAME_MASK,Q40_IRQ_FRAME},</span>
<span class="c">  {Q40_IRQ_KEYB_MASK,Q40_IRQ_KEYBOARD},</span>
<span class="c">  {0,0}};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">IRQ_TABLE</span> <span class="n">eirqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ3_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>	<span class="cm">/* ser 1 */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ4_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>	<span class="cm">/* ser 2 */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ14_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>	<span class="cm">/* IDE 1 */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ15_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">15</span> <span class="p">},</span>	<span class="cm">/* IDE 2 */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ6_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>	<span class="cm">/* floppy, handled elsewhere */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ7_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>	<span class="cm">/* par */</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ5_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
  <span class="p">{</span> <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">Q40_IRQ10_MASK</span><span class="p">,</span>	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
  <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* complain only this many times about spurious ints : */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ccleirq</span><span class="o">=</span><span class="mi">60</span><span class="p">;</span>    <span class="cm">/* ISA dev IRQs*/</span>
<span class="cm">/*static int cclirq=60;*/</span>     <span class="cm">/* internal */</span>

<span class="cm">/* FIXME: add shared ints,mask,unmask,probing.... */</span>

<span class="cp">#define IRQ_INPROGRESS 1</span>
<span class="cm">/*static unsigned short saved_mask;*/</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>static int do_tint=0;</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DEBUG_Q40INT</span>
<span class="cm">/*#define IP_USE_DISABLE *//* would be nice, but crashes ???? */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mext_disabled</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="cm">/* ext irq disabled by master chip? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aliased_irq</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>  <span class="cm">/* how many times inside handler ?*/</span>


<span class="cm">/* got interrupt, dispatch to ISA or keyboard/timer IRQs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">q40_irq_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">mir</span><span class="p">,</span> <span class="n">mer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>repeat:</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mir</span> <span class="o">=</span> <span class="n">master_inb</span><span class="p">(</span><span class="n">IIRQ_REG</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_BLK_DEV_FD</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mir</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ_EXT_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">master_inb</span><span class="p">(</span><span class="n">EIRQ_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ6_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">floppy_hardint</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">Q40_IRQ_SAMPLE</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mir</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ_FRAME_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">Q40_IRQ_FRAME</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">master_outb</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FRAME_CLEAR_REG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mir</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ_SER_MASK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mir</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ_EXT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mer</span> <span class="o">=</span> <span class="n">master_inb</span><span class="p">(</span><span class="n">EIRQ_REG</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">eirqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mer</span> <span class="o">&amp;</span> <span class="n">eirqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">irq</span> <span class="o">=</span> <span class="n">eirqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * There is a little mess wrt which IRQ really caused this irq request. The</span>
<span class="cm"> * main problem is that IIRQ_REG and EIRQ_REG reflect the state when they</span>
<span class="cm"> * are read - which is long after the request came in. In theory IRQs should</span>
<span class="cm"> * not just go away but they occasionally do</span>
<span class="cm"> */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">mext_disabled</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*aliased_irq++;*/</span>
					<span class="k">goto</span> <span class="n">iirq</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">q40_state</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IRQ_INPROGRESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* some handlers do local_irq_enable() for irq latency reasons, */</span>
					<span class="cm">/* however reentering an active irq handler is not permitted */</span>
<span class="cp">#ifdef IP_USE_DISABLE</span>
					<span class="cm">/* in theory this is the better way to do it because it still */</span>
					<span class="cm">/* lets through eg the serial irqs, unfortunately it crashes */</span>
					<span class="n">disable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
					<span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
					<span class="cm">/*printk(&quot;IRQ_INPROGRESS detected for irq %d, disabling - %s disabled\n&quot;,</span>
<span class="cm">						irq, disabled ? &quot;already&quot; : &quot;not yet&quot;); */</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">=</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x700</span><span class="p">))</span><span class="o">+</span><span class="mh">0x200</span><span class="p">);</span>
					<span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
					<span class="k">goto</span> <span class="n">iirq</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">q40_state</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IRQ_INPROGRESS</span><span class="p">;</span>
				<span class="n">do_IRQ</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="n">q40_state</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRQ_INPROGRESS</span><span class="p">;</span>

				<span class="cm">/* naively enable everything, if that fails than    */</span>
				<span class="cm">/* this function will be reentered immediately thus */</span>
				<span class="cm">/* getting another chance to disable the IRQ        */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef IP_USE_DISABLE</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">enable_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">);</span>
					<span class="p">}</span>
<span class="cp">#else</span>
					<span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="cm">/*printk(&quot;reenabling irq %d\n&quot;, irq); */</span>
<span class="cp">#endif</span>
				<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>used to do 'goto repeat;' here, this delayed bh processing too long</p></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mer</span> <span class="o">&amp;&amp;</span> <span class="n">ccleirq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aliased_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ISA interrupt from unknown source? EIRQ_REG = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mer</span><span class="p">);</span>
			<span class="n">ccleirq</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
 <span class="nl">iirq:</span>
	<span class="n">mir</span> <span class="o">=</span> <span class="n">master_inb</span><span class="p">(</span><span class="n">IIRQ_REG</span><span class="p">);</span>
	<span class="cm">/* should test whether keyboard irq is really enabled, doing it in defhand */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mir</span> <span class="o">&amp;</span> <span class="n">Q40_IRQ_KEYB_MASK</span><span class="p">)</span>
		<span class="n">do_IRQ</span><span class="p">(</span><span class="n">Q40_IRQ_KEYBOARD</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">q40_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mext_disabled</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mext_disabled</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;q40_irq_enable : nested disable/enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mext_disabled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">master_outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EXT_ENABLE_REG</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">q40_irq_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">irq_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* disable ISA iqs : only do something if the driver has been</span>
<span class="cm">	 * verified to be Q40 &quot;compatible&quot; - right now IDE, NE2K</span>
<span class="cm">	 * Any driver should not attempt to sleep across disable_irq !!</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EXT_ENABLE_REG</span><span class="p">);</span>
		<span class="n">mext_disabled</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mext_disabled</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;disable_irq nesting count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mext_disabled</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
