<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/arch/m68k/kernel/traps.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1993, 1994 by Hamish Macdonald</span>
<span class="cm"> *</span>
<span class="cm"> *  68040 fixes by Michael Rausch</span>
<span class="cm"> *  68040 fixes by Martin Apel</span>
<span class="cm"> *  68040 fixes and writeback by Richard Zidlicky</span>
<span class="cm"> *  68060 fixes by Roman Hodek</span>
<span class="cm"> *  68060 fixes by Jesper Skov</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Sets up all exception vectors</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/linkage.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/kallsyms.h&gt;</span>

<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/fpu.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/traps.h&gt;</span>
<span class="cp">#include &lt;asm/pgalloc.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/siginfo.h&gt;</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vec_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">VEC_RESETSP</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RESET SP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESETPC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;RESET PC&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_BUSERR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;BUS ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_ADDRERR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ADDRESS ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_ILLEGAL</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ILLEGAL INSTRUCTION&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_ZERODIV</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;ZERO DIVIDE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_CHK</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;CHK&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAPcc&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_PRIV</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;PRIVILEGE VIOLATION&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRACE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRACE&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_LINE10</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LINE 1010&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_LINE11</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LINE 1111&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV12</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 12&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_COPROC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;COPROCESSOR PROTOCOL VIOLATION&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FORMAT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FORMAT ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_UNINT</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNINITIALIZED INTERRUPT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV16</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 16&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV17</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 17&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV18</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 18&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV19</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 19&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV20</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 20&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV21</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 21&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV22</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 22&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV23</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 23&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_SPUR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SPURIOUS INTERRUPT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT1</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 1 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT2</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 2 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT3</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 3 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT4</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 4 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT5</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 5 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT6</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 6 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_INT7</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;LEVEL 7 INT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_SYS</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SYSCALL&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP1</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP2</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP3</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #3&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP4</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #4&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP5</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #5&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP6</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #6&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP7</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #7&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP8</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #8&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP9</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #9&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP10</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #10&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP11</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #11&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP12</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #12&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP13</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #13&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP14</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #14&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_TRAP15</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;TRAP #15&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPBRUC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP BSUN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPIR</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP INEXACT&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPDIVZ</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP DIV BY 0&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPUNDER</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP UNDERFLOW&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPOE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP OPERAND ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPOVER</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP OVERFLOW&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPNAN</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP SNAN&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_FPUNSUP</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;FPCP UNSUPPORTED OPERATION&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_MMUCFG</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;MMU CONFIGURATION ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_MMUILL</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;MMU ILLEGAL OPERATION ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_MMUACC</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;MMU ACCESS LEVEL VIOLATION ERROR&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV59</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 59&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_UNIMPEA</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 60&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_UNIMPII</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 61&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV62</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 62&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">VEC_RESV63</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;UNASSIGNED RESERVED 63&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">space_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;Space 0&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">USER_DATA</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;User Data&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">USER_PROGRAM</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;User Program&quot;</span><span class="p">,</span>
<span class="cp">#ifndef CONFIG_SUN3</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;Space 3&quot;</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">[</span><span class="n">FC_CONTROL</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Control&quot;</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;Space 4&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SUPER_DATA</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Super Data&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SUPER_PROGRAM</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Super Program&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CPU_SPACE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;CPU&quot;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">die_if_kernel</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>
<span class="n">asmlinkage</span> <span class="kt">int</span> <span class="n">do_page_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">error_code</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">send_fault_sig</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="n">trap_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">);</span>

<span class="cp">#if defined (CONFIG_M68060)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">access_error060</span> <span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fslw</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span> <span class="cm">/* is really FSLW for access error */</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;fslw=%#lx, fa=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fslw</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">effaddr</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_BPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* branch prediction error -&gt; clear branch cache */</span>
		<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span><span class="s">&quot;movec %/cacr,%/d0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				      <span class="s">&quot;orl   #0x00400000,%/d0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				      <span class="s">&quot;movec %/d0,%/cacr&quot;</span>
				      <span class="o">:</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;d0&quot;</span> <span class="p">);</span>
		<span class="cm">/* return if there&#39;s no other error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_ERR_BITS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_SEE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU060_DESC_ERR</span> <span class="o">|</span> <span class="n">MMU060_WP</span> <span class="o">|</span> <span class="n">MMU060_SP</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">errorcode</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">effaddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_MA</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

		<span class="n">errorcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_DESC_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__flush_tlb040_one</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">errorcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="n">MMU060_W</span><span class="p">)</span>
			<span class="n">errorcode</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;errorcode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">errorcode</span> <span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">do_page_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU060_SEE</span><span class="p">)){</span>
		<span class="cm">/* Software Emulation Error.</span>
<span class="cm">		 * fault during mem_read/mem_write in ifpsp060/os.S</span>
<span class="cm">		 */</span>
		<span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fslw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU060_RE</span><span class="o">|</span><span class="n">MMU060_WE</span><span class="p">))</span> <span class="o">||</span>
		   <span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;pc=%#lx, fa=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">effaddr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span> <span class="s">&quot;68060 access error, fslw=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fslw</span> <span class="p">);</span>
		<span class="n">trap_c</span><span class="p">(</span> <span class="n">fp</span> <span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_M68060 */</span><span class="cp"></span>

<span class="cp">#if defined (CONFIG_M68040)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">probe040</span><span class="p">(</span><span class="kt">int</span> <span class="n">iswrite</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wbs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmusr</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">MAKE_MM_SEG</span><span class="p">(</span><span class="n">wbs</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iswrite</span><span class="p">)</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;.chip 68040; ptestw (%0); .chip 68k&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;.chip 68040; ptestr (%0); .chip 68k&quot;</span> <span class="o">:</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;.chip 68040; movec %%mmusr,%0; .chip 68k&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span> <span class="p">(</span><span class="n">mmusr</span><span class="p">));</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mmusr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">do_040writeback1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wbs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wba</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wbd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="cm">/* set_fs can not be moved, otherwise put_user() may oops */</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">MAKE_MM_SEG</span><span class="p">(</span><span class="n">wbs</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wbs</span> <span class="o">&amp;</span> <span class="n">WBSIZ_040</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BA_SIZE_BYTE</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">wbd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BA_SIZE_WORD</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">wbd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="p">(</span><span class="kt">short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BA_SIZE_LONG</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">wbd</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">wba</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set_fs can not be moved, otherwise put_user() may oops */</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>


<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;do_040writeback1, res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">res</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* after an exception in a writeback the stack frame corresponding</span>
<span class="cm"> * to that exception is discarded, set a few bits in the old frame</span>
<span class="cm"> * to simulate what it should look like</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">fix_xframe040</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wba</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">wbs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span> <span class="o">=</span> <span class="n">wba</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">ssw</span> <span class="o">=</span> <span class="n">wbs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wba</span> <span class="o">!=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">faddr</span><span class="p">)</span>
	    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">ssw</span> <span class="o">|=</span> <span class="n">MA_040</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">do_040writebacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (fp-&gt;un.fmt7.wb1s &amp; WBV_040)</span>
<span class="c">		printk(&quot;access_error040: cannot handle 1st writeback. oops.\n&quot;);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">&amp;</span> <span class="n">WBV_040</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">&amp;</span> <span class="n">WBTT_040</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">do_040writeback1</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span><span class="p">,</span>
				       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">fix_xframe040</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do the 2nd wb only if the first one was successful (except for a kernel wb) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">&amp;</span> <span class="n">WBV_040</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">do_040writeback1</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span><span class="p">,</span>
				       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		    <span class="p">{</span>
			<span class="n">fix_xframe040</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span><span class="p">);</span>

			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span><span class="p">;</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">WBV_040</span><span class="p">);</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span><span class="p">;</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2d</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3d</span><span class="p">;</span>
		    <span class="p">}</span>
		<span class="k">else</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called from sigreturn(), must ensure userspace code didn&#39;t</span>
<span class="cm"> * manipulate exception frame to circumvent protection, then complete</span>
<span class="cm"> * pending writebacks</span>
<span class="cm"> * we just clear TM2 to turn it into a userspace access</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">berr_040cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">4</span><span class="p">;</span>

	<span class="n">do_040writebacks</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">access_error040</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ssw</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">ssw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmusr</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ssw=%#x, fa=%#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssw</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;wb1s=%#x, wb2s=%#x, wb3s=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb1s</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;wb2a=%lx, wb3a=%lx, wb2d=%lx, wb3d=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span><span class="p">,</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2d</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3d</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">ATC_040</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">errorcode</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The MMU status has to be determined AFTER the address</span>
<span class="cm">		 * has been corrected if there was a misaligned access (MA).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">MA_040</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span>

		<span class="cm">/* MMU error, get the MMUSR info for this access */</span>
		<span class="n">mmusr</span> <span class="o">=</span> <span class="n">probe040</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW_040</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ssw</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mmusr = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmusr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">errorcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="n">MMU_R_040</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* clear the invalid atc entry */</span>
			<span class="n">__flush_tlb040_one</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">errorcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* despite what documentation seems to say, RMW</span>
<span class="cm">		 * accesses have always both the LK and RW bits set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW_040</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">LK_040</span><span class="p">))</span>
			<span class="n">errorcode</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_page_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;do_page_fault() !=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">)){</span>
				<span class="cm">/* delay writebacks after signal delivery */</span>
<span class="cp">#ifdef DEBUG</span>
			        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;.. was usermode - return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* disable writeback into user space from kernel</span>
<span class="cm">			 * (if do_page_fault didn&#39;t fix the mapping,</span>
<span class="cm">                         * the writeback won&#39;t do good)</span>
<span class="cm">			 */</span>
<span class="nl">disable_wb:</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.. disabling wb2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span> <span class="o">==</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">)</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBV_040</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span> <span class="o">==</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">)</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WBV_040</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* In case of a bus error we either kill the process or expect</span>
<span class="cm">		 * the kernel to catch the fault, which then is also responsible</span>
<span class="cm">		 * for cleaning up the mess.</span>
<span class="cm">		 */</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">signo</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">faddr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;68040 bus error (ssw=%x, faddr=%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssw</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disable_wb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">do_040writebacks</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_M68040 */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SUN3)</span>
<span class="cp">#include &lt;asm/sun3mmu.h&gt;</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">mmu_emu_handle_fault</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/* sun3 version of bus_error030 */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bus_error030</span> <span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buserr_type</span> <span class="o">=</span> <span class="n">sun3_get_buserr</span> <span class="p">();</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ssw</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">ssw</span><span class="p">;</span>
	<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_sun3_map_test_start</span><span class="p">,</span> <span class="n">_sun3_map_test_end</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC</span> <span class="o">|</span> <span class="n">FB</span><span class="p">))</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">FC</span> <span class="o">?</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mh">0xa</span> <span class="o">?</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span> <span class="o">-</span> <span class="mi">2</span>
			<span class="o">:</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mh">0xa</span> <span class="o">?</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Data %s fault at %#010lx in %s (pc=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
			<span class="n">space_names</span><span class="p">[</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">],</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if this page should be demand-mapped. This needs to go before</span>
<span class="cm">	 * the testing for a bad kernel-space access (demand-mapping applies</span>
<span class="cm">	 * to kernel accesses too).</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buserr_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SUN3_BUSERR_PROTERR</span> <span class="o">|</span> <span class="n">SUN3_BUSERR_INVALID</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmu_emu_handle_fault</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for kernel-space pagefault (BAD). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="n">PS_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kernel fault must be a data fault to user space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">((</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">)</span> <span class="o">==</span> <span class="n">USER_DATA</span><span class="p">)))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>try checking the kernel mappings before surrender</p></td><td class="code"><div class="highlight"><pre>		     <span class="k">if</span> <span class="p">(</span><span class="n">mmu_emu_handle_fault</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			  <span class="k">return</span><span class="p">;</span>
			<span class="cm">/* instruction fault or kernel data fault! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC</span> <span class="o">|</span> <span class="n">FB</span><span class="p">))</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* was this fault incurred testing bus mappings? */</span>
				<span class="k">if</span><span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_sun3_map_test_start</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				   <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_sun3_map_test_end</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Data %s fault at %#010lx in %s (pc=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
					<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
					<span class="n">space_names</span><span class="p">[</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">],</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;BAD KERNEL BUSERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* user fault */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC</span> <span class="o">|</span> <span class="n">FB</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">))</span>
			<span class="cm">/* not an instruction fault or data fault! BAD */</span>
			<span class="n">panic</span> <span class="p">(</span><span class="s">&quot;USER BUSERR w/o instruction or data fault&quot;</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="cm">/* First handle the data fault, if any.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>errorcode bit 0:    0 -> no page        1 -> protection fault
errorcode bit 1:    0 -> read fault     1 -> write fault</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>(buserr<em>type &amp; SUN3</em>BUSERR<em>PROTERR)    -> protection fault
(buserr</em>type &amp; SUN3<em>BUSERR</em>INVALID)    -> invalid page fault</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">buserr_type</span> <span class="o">&amp;</span> <span class="n">SUN3_BUSERR_PROTERR</span><span class="p">)</span>
			<span class="n">errorcode</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buserr_type</span> <span class="o">&amp;</span> <span class="n">SUN3_BUSERR_INVALID</span><span class="p">)</span>
			<span class="n">errorcode</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;*** unexpected busfault type=%#04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buserr_type</span><span class="p">);</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;invalid %s access at %#lx from pc %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">die_if_kernel</span> <span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">buserr_type</span><span class="p">);</span>
			<span class="n">force_sig</span> <span class="p">(</span><span class="n">SIGBUS</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>todo: wtf is RM bit? --m</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">||</span> <span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RM</span><span class="p">)</span>
			<span class="n">errorcode</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>

		<span class="cm">/* Handle page fault. */</span>
		<span class="n">do_page_fault</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">);</span>

		<span class="cm">/* Retry the data fault now. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now handle the instruction fault. */</span>

	<span class="cm">/* Get the fault address. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mh">0xA</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">FC</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buserr_type</span> <span class="o">&amp;</span> <span class="n">SUN3_BUSERR_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmu_emu_handle_fault</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">do_page_fault</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;protection fault on insn access (segv).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">force_sig</span> <span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
       <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#if defined(CPU_M68020_OR_M68030)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">bus_error030</span> <span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mmusr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ssw</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">ssw</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">desc</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;pid = %x  &quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;SSW=%#06x  &quot;</span><span class="p">,</span> <span class="n">ssw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC</span> <span class="o">|</span> <span class="n">FB</span><span class="p">))</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">FC</span> <span class="o">?</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mh">0xa</span> <span class="o">?</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span> <span class="o">-</span> <span class="mi">2</span>
			<span class="o">:</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mh">0xa</span> <span class="o">?</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Data %s fault at %#010lx in %s (pc=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
			<span class="n">space_names</span><span class="p">[</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">],</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* ++andreas: If a data fault and an instruction fault happen</span>
<span class="cm">	   at the same time map in both pages.  */</span>

	<span class="cm">/* First handle the data fault, if any.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ptestr %3,%2@,#7,%0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;pmove %%psr,%1&quot;</span>
			      <span class="o">:</span> <span class="s">&quot;=a&amp;&quot;</span> <span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
			      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">ssw</span><span class="p">));</span>
<span class="cp">#else</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ptestr %2,%1@,#7</span><span class="se">\n\t</span><span class="s">&quot;</span>
			      <span class="s">&quot;pmove %%psr,%0&quot;</span>
			      <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">ssw</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">mmusr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mmusr is %#x for addr %#lx in task %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mmusr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;descriptor address is %#lx, contents %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__va</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>
<span class="cp">#endif</span>

		<span class="n">errorcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="n">MMU_I</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RM</span><span class="p">))</span>
			<span class="n">errorcode</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU_I</span> <span class="o">|</span> <span class="n">MMU_WP</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Data %s fault at %#010lx in %s (pc=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
				       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span>
				       <span class="n">space_names</span><span class="p">[</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">],</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">buserr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Don&#39;t try to do anything further if an exception was</span>
<span class="cm">			   handled. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">do_page_fault</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">errorcode</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="n">MMU_I</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* probably a 020 cas fault */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">send_fault_sig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unexpected bus error (%#x,%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ssw</span><span class="p">,</span> <span class="n">mmusr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU_B</span><span class="o">|</span><span class="n">MMU_L</span><span class="o">|</span><span class="n">MMU_S</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;invalid %s access at %#lx from pc %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
			<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="n">mmusr</span><span class="p">);</span>
			<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			static volatile long tlong;</span>
<span class="cp">#endif</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;weird %s access at %#lx from pc %#lx (ssw is %#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			       <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">ssw</span><span class="p">);</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ptestr #1,%1@,#0</span><span class="se">\n\t</span><span class="s">&quot;</span>
				      <span class="s">&quot;pmove %%psr,%0&quot;</span>
				      <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
				      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
			<span class="n">mmusr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;level 0 mmusr is %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mmusr</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			asm volatile (&quot;pmove %%tt0,%0&quot;</span>
<span class="c">				      : &quot;=m&quot; (tlong));</span>
<span class="c">			printk(&quot;tt0 is %#lx, &quot;, tlong);</span>
<span class="c">			asm volatile (&quot;pmove %%tt1,%0&quot;</span>
<span class="c">				      : &quot;=m&quot; (tlong));</span>
<span class="c">			printk(&quot;tt1 is %#lx\n&quot;, tlong);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown SIGSEGV - 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="n">mmusr</span><span class="p">);</span>
			<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* setup an ATC entry for the access about to be retried */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RM</span><span class="p">))</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ploadw %1,%0@&quot;</span> <span class="o">:</span> <span class="cm">/* no outputs */</span>
				      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">ssw</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ploadr %1,%0@&quot;</span> <span class="o">:</span> <span class="cm">/* no outputs */</span>
				      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="s">&quot;d&quot;</span> <span class="p">(</span><span class="n">ssw</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Now handle the instruction fault. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FC</span><span class="o">|</span><span class="n">FB</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="n">PS_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
	<span class="nl">buserr:</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;BAD KERNEL BUSERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGKILL</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the fault address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">FC</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">addr</span> <span class="o">^</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Insn fault on same page as data fault.  But we</span>
<span class="cm">		   should still create the ATC entry.  */</span>
		<span class="k">goto</span> <span class="n">create_atc_entry</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ptestr #1,%2@,#7,%0</span><span class="se">\n\t</span><span class="s">&quot;</span>
		      <span class="s">&quot;pmove %%psr,%1&quot;</span>
		      <span class="o">:</span> <span class="s">&quot;=a&amp;&quot;</span> <span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ptestr #1,%1@,#7</span><span class="se">\n\t</span><span class="s">&quot;</span>
		      <span class="s">&quot;pmove %%psr,%0&quot;</span>
		      <span class="o">:</span> <span class="s">&quot;=m&quot;</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">mmusr</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;mmusr is %#x for addr %#lx in task %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mmusr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;descriptor address is %#lx, contents %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__va</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">desc</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="n">MMU_I</span><span class="p">)</span>
		<span class="n">do_page_fault</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MMU_B</span><span class="o">|</span><span class="n">MMU_L</span><span class="o">|</span><span class="n">MMU_S</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;invalid insn access at %#lx from pc %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown SIGSEGV - 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Oops&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="n">mmusr</span><span class="p">);</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">create_atc_entry:</span>
	<span class="cm">/* setup an ATC entry for the access about to be retried */</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ploadr #2,%0@&quot;</span> <span class="o">:</span> <span class="cm">/* no outputs */</span>
		      <span class="o">:</span> <span class="s">&quot;a&quot;</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CPU_M68020_OR_M68030 */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_SUN3 */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_COLDFIRE) &amp;&amp; defined(CONFIG_MMU)</span>
<span class="cp">#include &lt;asm/mcfmmu.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> *	The following table converts the FS encoding of a ColdFire</span>
<span class="cm"> *	exception stack frame into the error_code value needed by</span>
<span class="cm"> *	do_fault.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fs_err_code</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0000 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0001 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0010 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0011 */</span>
	<span class="mi">1</span><span class="p">,</span>  <span class="cm">/* 0100 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0101 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0110 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 0111 */</span>
	<span class="mi">2</span><span class="p">,</span>  <span class="cm">/* 1000 */</span>
	<span class="mi">3</span><span class="p">,</span>  <span class="cm">/* 1001 */</span>
	<span class="mi">2</span><span class="p">,</span>  <span class="cm">/* 1010 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 1011 */</span>
	<span class="mi">1</span><span class="p">,</span>  <span class="cm">/* 1100 */</span>
	<span class="mi">1</span><span class="p">,</span>  <span class="cm">/* 1101 */</span>
	<span class="mi">0</span><span class="p">,</span>  <span class="cm">/* 1110 */</span>
	<span class="mi">0</span>   <span class="cm">/* 1111 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">access_errorcf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmusr</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_page_fault</span><span class="p">;</span>

	<span class="n">mmusr</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">MMUSR</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">mmu_read</span><span class="p">(</span><span class="n">MMUAR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * error_code:</span>
<span class="cm">	 *	bit 0 == 0 means no page found, 1 means protection fault</span>
<span class="cm">	 *	bit 1 == 0 means read, 1 means write</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="mi">5</span>:  <span class="cm">/* 0101 TLB opword X miss */</span>
		<span class="n">need_page_fault</span> <span class="o">=</span> <span class="n">cf_tlb_miss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="mi">6</span>:  <span class="cm">/* 0110 TLB extension word X miss */</span>
		<span class="n">need_page_fault</span> <span class="o">=</span> <span class="n">cf_tlb_miss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:  <span class="cm">/* 1010 TLB W miss */</span>
		<span class="n">need_page_fault</span> <span class="o">=</span> <span class="n">cf_tlb_miss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>: <span class="cm">/* 1110 TLB R miss */</span>
		<span class="n">need_page_fault</span> <span class="o">=</span> <span class="n">cf_tlb_miss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* 0000 Normal  */</span>
		<span class="cm">/* 0001 Reserved */</span>
		<span class="cm">/* 0010 Interrupt during debug service routine */</span>
		<span class="cm">/* 0011 Reserved */</span>
		<span class="cm">/* 0100 X Protection */</span>
		<span class="cm">/* 0111 IFP in emulator mode */</span>
		<span class="cm">/* 1000 W Protection*/</span>
		<span class="cm">/* 1001 Write error*/</span>
		<span class="cm">/* 1011 Reserved*/</span>
		<span class="cm">/* 1100 R Protection*/</span>
		<span class="cm">/* 1101 R Protection*/</span>
		<span class="cm">/* 1111 OEP in emulator mode*/</span>
		<span class="n">need_page_fault</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_page_fault</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">fs_err_code</span><span class="p">[</span><span class="n">fs</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fs</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mmusr</span> <span class="o">&amp;</span> <span class="n">MMUSR_WF</span><span class="p">))</span> <span class="cm">/* rd-mod-wr access */</span>
			<span class="n">err_code</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* bit1 - write, bit0 - protection */</span>
		<span class="n">do_page_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COLDFIRE CONFIG_MMU */</span><span class="cp"></span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">buserr_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Only set esp0 if coming from user mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">))</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">esp0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fp</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;*** Bus Error *** Format is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_COLDFIRE) &amp;&amp; defined(CONFIG_MMU)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CPU_IS_COLDFIRE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fs</span><span class="p">;</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="mh">0xc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="k">case</span> <span class="mh">0x6</span>:
		<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="k">case</span> <span class="mh">0x9</span>:
		<span class="k">case</span> <span class="mh">0xa</span>:
		<span class="k">case</span> <span class="mh">0xd</span>:
		<span class="k">case</span> <span class="mh">0xe</span>:
		<span class="k">case</span> <span class="mh">0xf</span>:
			<span class="n">access_errorcf</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COLDFIRE &amp;&amp; CONFIG_MMU */</span><span class="cp"></span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if defined (CONFIG_M68060)</span>
	<span class="k">case</span> <span class="mi">4</span>:				<span class="cm">/* 68060 access error */</span>
	  <span class="n">access_error060</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined (CONFIG_M68040)</span>
	<span class="k">case</span> <span class="mh">0x7</span>:			<span class="cm">/* 68040 access error */</span>
	  <span class="n">access_error040</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#if defined (CPU_M68020_OR_M68030)</span>
	<span class="k">case</span> <span class="mh">0xa</span>:
	<span class="k">case</span> <span class="mh">0xb</span>:
	  <span class="n">bus_error030</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	  <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
	  <span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;bad frame format&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown SIGSEGV - 4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	  <span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">kstack_depth_to_print</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">show_trace</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">endstack</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Call Trace:&quot;</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack</span> <span class="o">+</span> <span class="n">THREAD_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">endstack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">THREAD_SIZE</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">stack</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">endstack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">stack</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the address is either in the text segment of the</span>
<span class="cm">		 * kernel, or in the region which contains vmalloc&#39;ed</span>
<span class="cm">		 * memory, it *may* be the address of a calling</span>
<span class="cm">		 * routine; if so, print it so that someone tracing</span>
<span class="cm">		 * down the cause of the crash will be able to figure</span>
<span class="cm">		 * out the call path that was taken.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__kernel_text_address</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef CONFIG_KALLSYMS</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">       &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; [&lt;%08lx&gt;] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">u16</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">print_modules</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PC: [&lt;%08lx&gt;] %pS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SR: %04x  SP: %p  a2: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">sr</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;d0: %08lx    d1: %08lx    d2: %08lx    d3: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;d4: %08lx    d5: %08lx    a0: %08lx    a1: %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d4</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">d5</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Process %s (pid: %d, task=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Frame format=%X &quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;instr addr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt2</span><span class="p">.</span><span class="n">iaddr</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;eff addr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt3</span><span class="p">.</span><span class="n">effaddr</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4</span>:
		<span class="n">printk</span><span class="p">((</span><span class="n">CPU_IS_060</span> <span class="o">?</span> <span class="s">&quot;fault addr=%08lx fslw=%08lx</span><span class="se">\n</span><span class="s">&quot;</span>
			<span class="o">:</span> <span class="s">&quot;eff addr=%08lx pc=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">effaddr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;eff addr=%08lx ssw=%04x faddr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">effaddr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">ssw</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">faddr</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wb 1 stat/addr/data: %04x %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb1s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb1a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb1dpd0</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wb 2 stat/addr/data: %04x %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb2d</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wb 3 stat/addr/data: %04x %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3s</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3a</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb3d</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;push data: %08lx %08lx %08lx %08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">wb1dpd0</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">pd1</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">pd2</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">pd3</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x9</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;instr addr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt9</span><span class="p">.</span><span class="n">iaddr</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt9</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xa</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ssw=%04x isc=%04x isb=%04x daddr=%08lx dobuf=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">ssw</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">isc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">isb</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">dobuf</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xb</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ssw=%04x isc=%04x isb=%04x daddr=%08lx dobuf=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">ssw</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">isc</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">isb</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">dobuf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;baddr=%08lx dibuf=%08lx ver=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">dibuf</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">ver</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">show_stack</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Code:&quot;</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cp</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Bad PC value.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="s">&quot; %04x&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;%04x&gt;&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">show_stack</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">stack</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">endstack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stack</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">)</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">esp0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">stack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">stack</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">endstack</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack</span> <span class="o">+</span> <span class="n">THREAD_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">THREAD_SIZE</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Stack from %08lx:&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">stack</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">stack</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">kstack_depth_to_print</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">endstack</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">       &quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08lx&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">show_trace</span><span class="p">(</span><span class="n">stack</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The architecture-independent backtrace generator</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dump_stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stack</span><span class="p">;</span>

	<span class="n">show_trace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stack</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dump_stack</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The vector number returned in the frame pointer may also contain</span>
<span class="cm"> * the &quot;fs&quot; (Fault Status) bits on ColdFire. These are in the bottom</span>
<span class="cm"> * 2 bits, and upper 2 bits. So we need to mask out the real vector</span>
<span class="cm"> * number before using it in comparisons. You don&#39;t need to do this on</span>
<span class="cm"> * real 68k parts, but it won&#39;t hurt either.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">bad_super_trap</span> <span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">vector</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vec_names</span><span class="p">))</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;*** %s ***   FORMAT=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vec_names</span><span class="p">[</span><span class="n">vector</span><span class="p">],</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;*** Exception %d ***   FORMAT=%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vector</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">VEC_ADDRERR</span> <span class="o">&amp;&amp;</span> <span class="n">CPU_IS_020_OR_030</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ssw</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">ssw</span><span class="p">;</span>

		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;SSW=%#06x  &quot;</span><span class="p">,</span> <span class="n">ssw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RC</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Pipe stage C instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xA</span> <span class="o">?</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RB</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Pipe stage B instruction fault at %#010lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xA</span> <span class="o">?</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">baddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DF</span><span class="p">)</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Data %s fault at %#010lx in %s (pc=%#lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">RW</span> <span class="o">?</span> <span class="s">&quot;read&quot;</span> <span class="o">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="n">space_names</span><span class="p">[</span><span class="n">ssw</span> <span class="o">&amp;</span> <span class="n">DFC</span><span class="p">],</span>
				<span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Current process id is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
	<span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;BAD KERNEL TRAP&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">trap_c</span><span class="p">(</span><span class="k">struct</span> <span class="n">frame</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vector</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">vector</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="n">PS_S</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">VEC_TRACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* traced a trapping instruction on a 68020/30,</span>
<span class="cm">			 * real exception will be executed afterwards.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle_kernel_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">))</span>
			<span class="n">bad_super_trap</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* send the appropriate signal to the user program */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">VEC_ADDRERR</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGBUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_ILLEGAL</span>:
	    <span class="k">case</span> <span class="n">VEC_LINE10</span>:
	    <span class="k">case</span> <span class="n">VEC_LINE11</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_PRIV</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_PRVOPC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_COPROC</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_COPROC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_TRAP1</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP2</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP3</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP4</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP5</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP6</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP7</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP8</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP9</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP10</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP11</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP12</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP13</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP14</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLTRP</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_FPBRUC</span>:
	    <span class="k">case</span> <span class="n">VEC_FPOE</span>:
	    <span class="k">case</span> <span class="n">VEC_FPNAN</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_FPIR</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_FPDIVZ</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_FPUNDER</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_FPOVER</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_ZERODIV</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_INTDIV</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_CHK</span>:
	    <span class="k">case</span> <span class="n">VEC_TRAP</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_INTOVF</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_TRACE</span>:		<span class="cm">/* ptrace single step */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_TRACE</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">VEC_TRAP15</span>:		<span class="cm">/* breakpoint */</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_BRKPT</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nl">default:</span>
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">ptregs</span><span class="p">.</span><span class="n">pc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">2</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt2</span><span class="p">.</span><span class="n">iaddr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">7</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt7</span><span class="p">.</span><span class="n">effaddr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">9</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmt9</span><span class="p">.</span><span class="n">iaddr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">10</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmta</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">11</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">un</span><span class="p">.</span><span class="n">fmtb</span><span class="p">.</span><span class="n">daddr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">force_sig_info</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">die_if_kernel</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">sr</span> <span class="o">&amp;</span> <span class="n">PS_S</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">console_verbose</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">show_registers</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">set_esp0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ssp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">esp0</span> <span class="o">=</span> <span class="n">ssp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called if an error occur while accessing</span>
<span class="cm"> * user-space from the fpsp040 code.</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">fpsp040_die</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_M68KFPU_EMU</span>
<span class="n">asmlinkage</span> <span class="kt">void</span> <span class="nf">fpemu_signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">signal</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
