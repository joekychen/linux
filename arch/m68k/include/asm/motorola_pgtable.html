<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › include › asm › motorola_pgtable.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>motorola_pgtable.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _MOTOROLA_PGTABLE_H</span>
<span class="cp">#define _MOTOROLA_PGTABLE_H</span>


<span class="cm">/*</span>
<span class="cm"> * Definitions for MMU descriptors</span>
<span class="cm"> */</span>
<span class="cp">#define _PAGE_PRESENT	0x001</span>
<span class="cp">#define _PAGE_SHORT	0x002</span>
<span class="cp">#define _PAGE_RONLY	0x004</span>
<span class="cp">#define _PAGE_READWRITE	0x000</span>
<span class="cp">#define _PAGE_ACCESSED	0x008</span>
<span class="cp">#define _PAGE_DIRTY	0x010</span>
<span class="cp">#define _PAGE_SUPER	0x080	</span><span class="cm">/* 68040 supervisor only */</span><span class="cp"></span>
<span class="cp">#define _PAGE_GLOBAL040	0x400	</span><span class="cm">/* 68040 global bit, used for kva descs */</span><span class="cp"></span>
<span class="cp">#define _PAGE_NOCACHE030 0x040	</span><span class="cm">/* 68030 no-cache mode */</span><span class="cp"></span>
<span class="cp">#define _PAGE_NOCACHE	0x060	</span><span class="cm">/* 68040 cache mode, non-serialized */</span><span class="cp"></span>
<span class="cp">#define _PAGE_NOCACHE_S	0x040	</span><span class="cm">/* 68040 no-cache mode, serialized */</span><span class="cp"></span>
<span class="cp">#define _PAGE_CACHE040	0x020	</span><span class="cm">/* 68040 cache mode, cachable, copyback */</span><span class="cp"></span>
<span class="cp">#define _PAGE_CACHE040W	0x000	</span><span class="cm">/* 68040 cache mode, cachable, write-through */</span><span class="cp"></span>

<span class="cp">#define _DESCTYPE_MASK	0x003</span>

<span class="cp">#define _CACHEMASK040	(~0x060)</span>
<span class="cp">#define _TABLE_MASK	(0xfffffe00)</span>

<span class="cp">#define _PAGE_TABLE	(_PAGE_SHORT)</span>
<span class="cp">#define _PAGE_CHG_MASK  (PAGE_MASK | _PAGE_ACCESSED | _PAGE_DIRTY | _PAGE_NOCACHE)</span>

<span class="cp">#define _PAGE_PROTNONE	0x004</span>
<span class="cp">#define _PAGE_FILE	0x008	</span><span class="cm">/* pagecache or swap? */</span><span class="cp"></span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cm">/* This is the cache mode to be used for pages containing page descriptors for</span>
<span class="cm"> * processors &gt;= &#39;040. It is in pte_mknocache(), and the variable is defined</span>
<span class="cm"> * and initialized in head.S */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">m68k_pgtable_cachemode</span><span class="p">;</span>

<span class="cm">/* This is the cache mode for normal pages, for supervisor access on</span>
<span class="cm"> * processors &gt;= &#39;040. It is used in pte_mkcache(), and the variable is</span>
<span class="cm"> * defined and initialized in head.S */</span>

<span class="cp">#if defined(CPU_M68060_ONLY) &amp;&amp; defined(CONFIG_060_WRITETHROUGH)</span>
<span class="cp">#define m68k_supervisor_cachemode _PAGE_CACHE040W</span>
<span class="cp">#elif defined(CPU_M68040_OR_M68060_ONLY)</span>
<span class="cp">#define m68k_supervisor_cachemode _PAGE_CACHE040</span>
<span class="cp">#elif defined(CPU_M68020_OR_M68030_ONLY)</span>
<span class="cp">#define m68k_supervisor_cachemode 0</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">m68k_supervisor_cachemode</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CPU_M68040_OR_M68060_ONLY)</span>
<span class="cp">#define mm_cachebits _PAGE_CACHE040</span>
<span class="cp">#elif defined(CPU_M68020_OR_M68030_ONLY)</span>
<span class="cp">#define mm_cachebits 0</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mm_cachebits</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define PAGE_NONE	__pgprot(_PAGE_PROTNONE | _PAGE_ACCESSED | mm_cachebits)</span>
<span class="cp">#define PAGE_SHARED	__pgprot(_PAGE_PRESENT | _PAGE_ACCESSED | mm_cachebits)</span>
<span class="cp">#define PAGE_COPY	__pgprot(_PAGE_PRESENT | _PAGE_RONLY | _PAGE_ACCESSED | mm_cachebits)</span>
<span class="cp">#define PAGE_READONLY	__pgprot(_PAGE_PRESENT | _PAGE_RONLY | _PAGE_ACCESSED | mm_cachebits)</span>
<span class="cp">#define PAGE_KERNEL	__pgprot(_PAGE_PRESENT | _PAGE_DIRTY | _PAGE_ACCESSED | mm_cachebits)</span>

<span class="cm">/* Alternate definitions that are compile time constants, for</span>
<span class="cm">   initializing protection_map.  The cachebits are fixed later.  */</span>
<span class="cp">#define PAGE_NONE_C	__pgprot(_PAGE_PROTNONE | _PAGE_ACCESSED)</span>
<span class="cp">#define PAGE_SHARED_C	__pgprot(_PAGE_PRESENT | _PAGE_ACCESSED)</span>
<span class="cp">#define PAGE_COPY_C	__pgprot(_PAGE_PRESENT | _PAGE_RONLY | _PAGE_ACCESSED)</span>
<span class="cp">#define PAGE_READONLY_C	__pgprot(_PAGE_PRESENT | _PAGE_RONLY | _PAGE_ACCESSED)</span>

<span class="cm">/*</span>
<span class="cm"> * The m68k can&#39;t do page protection for execute, and considers that the same are read.</span>
<span class="cm"> * Also, write permissions imply read permissions. This is the closest we can get..</span>
<span class="cm"> */</span>
<span class="cp">#define __P000	PAGE_NONE_C</span>
<span class="cp">#define __P001	PAGE_READONLY_C</span>
<span class="cp">#define __P010	PAGE_COPY_C</span>
<span class="cp">#define __P011	PAGE_COPY_C</span>
<span class="cp">#define __P100	PAGE_READONLY_C</span>
<span class="cp">#define __P101	PAGE_READONLY_C</span>
<span class="cp">#define __P110	PAGE_COPY_C</span>
<span class="cp">#define __P111	PAGE_COPY_C</span>

<span class="cp">#define __S000	PAGE_NONE_C</span>
<span class="cp">#define __S001	PAGE_READONLY_C</span>
<span class="cp">#define __S010	PAGE_SHARED_C</span>
<span class="cp">#define __S011	PAGE_SHARED_C</span>
<span class="cp">#define __S100	PAGE_READONLY_C</span>
<span class="cp">#define __S101	PAGE_READONLY_C</span>
<span class="cp">#define __S110	PAGE_SHARED_C</span>
<span class="cp">#define __S111	PAGE_SHARED_C</span>

<span class="cm">/*</span>
<span class="cm"> * Conversion functions: convert a page and protection to a page entry,</span>
<span class="cm"> * and a page entry and page directory to the page they refer to.</span>
<span class="cm"> */</span>
<span class="cp">#define mk_pte(page, pgprot) pfn_pte(page_to_pfn(page), (pgprot))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_modify</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">,</span> <span class="n">pgprot_t</span> <span class="n">newprot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_PAGE_CHG_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">pgprot_val</span><span class="p">(</span><span class="n">newprot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pmd_set</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptbl</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">ptep</span><span class="p">)</span> <span class="o">|</span> <span class="n">_PAGE_TABLE</span> <span class="o">|</span> <span class="n">_PAGE_ACCESSED</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">pmdp</span><span class="o">-&gt;</span><span class="n">pmd</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ptbl</span><span class="p">;</span>
		<span class="n">ptbl</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pte_t</span><span class="p">)</span><span class="o">*</span><span class="n">PTRS_PER_PTE</span><span class="o">/</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pgd_set</span><span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="n">pgdp</span><span class="p">,</span> <span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pgd_val</span><span class="p">(</span><span class="o">*</span><span class="n">pgdp</span><span class="p">)</span> <span class="o">=</span> <span class="n">_PAGE_TABLE</span> <span class="o">|</span> <span class="n">_PAGE_ACCESSED</span> <span class="o">|</span> <span class="n">__pa</span><span class="p">(</span><span class="n">pmdp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define __pte_page(pte) ((unsigned long)__va(pte_val(pte) &amp; PAGE_MASK))</span>
<span class="cp">#define __pmd_page(pmd) ((unsigned long)__va(pmd_val(pmd) &amp; _TABLE_MASK))</span>
<span class="cp">#define __pgd_page(pgd) ((unsigned long)__va(pgd_val(pgd) &amp; _TABLE_MASK))</span>


<span class="cp">#define pte_none(pte)		(!pte_val(pte))</span>
<span class="cp">#define pte_present(pte)	(pte_val(pte) &amp; (_PAGE_PRESENT | _PAGE_PROTNONE))</span>
<span class="cp">#define pte_clear(mm,addr,ptep)		({ pte_val(*(ptep)) = 0; })</span>

<span class="cp">#define pte_page(pte)		virt_to_page(__va(pte_val(pte)))</span>
<span class="cp">#define pte_pfn(pte)		(pte_val(pte) &gt;&gt; PAGE_SHIFT)</span>
<span class="cp">#define pfn_pte(pfn, prot)	__pte(((pfn) &lt;&lt; PAGE_SHIFT) | pgprot_val(prot))</span>

<span class="cp">#define pmd_none(pmd)		(!pmd_val(pmd))</span>
<span class="cp">#define pmd_bad(pmd)		((pmd_val(pmd) &amp; _DESCTYPE_MASK) != _PAGE_TABLE)</span>
<span class="cp">#define pmd_present(pmd)	(pmd_val(pmd) &amp; _PAGE_TABLE)</span>
<span class="cp">#define pmd_clear(pmdp) ({			\</span>
<span class="cp">	unsigned long *__ptr = pmdp-&gt;pmd;	\</span>
<span class="cp">	short __i = 16;				\</span>
<span class="cp">	while (--__i &gt;= 0)			\</span>
<span class="cp">		*__ptr++ = 0;			\</span>
<span class="cp">})</span>
<span class="cp">#define pmd_page(pmd)		virt_to_page(__va(pmd_val(pmd)))</span>


<span class="cp">#define pgd_none(pgd)		(!pgd_val(pgd))</span>
<span class="cp">#define pgd_bad(pgd)		((pgd_val(pgd) &amp; _DESCTYPE_MASK) != _PAGE_TABLE)</span>
<span class="cp">#define pgd_present(pgd)	(pgd_val(pgd) &amp; _PAGE_TABLE)</span>
<span class="cp">#define pgd_clear(pgdp)		({ pgd_val(*pgdp) = 0; })</span>
<span class="cp">#define pgd_page(pgd)		(mem_map + ((unsigned long)(__va(pgd_val(pgd)) - PAGE_OFFSET) &gt;&gt; PAGE_SHIFT))</span>

<span class="cp">#define pte_ERROR(e) \</span>
<span class="cp">	printk(&quot;%s:%d: bad pte %08lx.\n&quot;, __FILE__, __LINE__, pte_val(e))</span>
<span class="cp">#define pmd_ERROR(e) \</span>
<span class="cp">	printk(&quot;%s:%d: bad pmd %08lx.\n&quot;, __FILE__, __LINE__, pmd_val(e))</span>
<span class="cp">#define pgd_ERROR(e) \</span>
<span class="cp">	printk(&quot;%s:%d: bad pgd %08lx.\n&quot;, __FILE__, __LINE__, pgd_val(e))</span>


<span class="cm">/*</span>
<span class="cm"> * The following only work if pte_present() is true.</span>
<span class="cm"> * Undefined behaviour if not..</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pte_write</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>		<span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_PAGE_RONLY</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pte_dirty</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>		<span class="p">{</span> <span class="k">return</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_PAGE_DIRTY</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pte_young</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>		<span class="p">{</span> <span class="k">return</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_PAGE_ACCESSED</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pte_file</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>		<span class="p">{</span> <span class="k">return</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_PAGE_FILE</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pte_special</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_wrprotect</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">|=</span> <span class="n">_PAGE_RONLY</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkclean</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_DIRTY</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkold</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_ACCESSED</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkwrite</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_RONLY</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkdirty</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">|=</span> <span class="n">_PAGE_DIRTY</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkyoung</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">|=</span> <span class="n">_PAGE_ACCESSED</span><span class="p">;</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mknocache</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_CACHEMASK040</span><span class="p">)</span> <span class="o">|</span> <span class="n">m68k_pgtable_cachemode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pte</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkcache</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte_val</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_CACHEMASK040</span><span class="p">)</span> <span class="o">|</span> <span class="n">m68k_supervisor_cachemode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pte</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pte_mkspecial</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>	<span class="p">{</span> <span class="k">return</span> <span class="n">pte</span><span class="p">;</span> <span class="p">}</span>

<span class="cp">#define PAGE_DIR_OFFSET(tsk,address) pgd_offset((tsk),(address))</span>

<span class="cp">#define pgd_index(address)     ((address) &gt;&gt; PGDIR_SHIFT)</span>

<span class="cm">/* to find an entry in a page-table-directory */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pgd_t</span> <span class="o">*</span><span class="nf">pgd_offset</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgd</span> <span class="o">+</span> <span class="n">pgd_index</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define swapper_pg_dir kernel_pg_dir</span>
<span class="k">extern</span> <span class="n">pgd_t</span> <span class="n">kernel_pg_dir</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pgd_t</span> <span class="o">*</span><span class="nf">pgd_offset_k</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kernel_pg_dir</span> <span class="o">+</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="n">PGDIR_SHIFT</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Find an entry in the second-level page table.. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pmd_t</span> <span class="o">*</span><span class="nf">pmd_offset</span><span class="p">(</span><span class="n">pgd_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__pgd_page</span><span class="p">(</span><span class="o">*</span><span class="n">dir</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="n">PMD_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PTRS_PER_PMD</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Find an entry in the third-level page table.. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="o">*</span><span class="nf">pte_offset_kernel</span><span class="p">(</span><span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pte_t</span> <span class="o">*</span><span class="p">)</span><span class="n">__pmd_page</span><span class="p">(</span><span class="o">*</span><span class="n">pmdp</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PTRS_PER_PTE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define pte_offset_map(pmdp,address) ((pte_t *)__pmd_page(*pmdp) + (((address) &gt;&gt; PAGE_SHIFT) &amp; (PTRS_PER_PTE - 1)))</span>
<span class="cp">#define pte_unmap(pte)		((void)0)</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate and free page tables. The xxx_kernel() versions are</span>
<span class="cm"> * used to allocate a kernel page table - this turns on ASN bits</span>
<span class="cm"> * if any.</span>
<span class="cm"> */</span>

<span class="cm">/* Prior to calling these routines, the page should have been flushed</span>
<span class="cm"> * from both the cache and ATC, or the CPU might not notice that the</span>
<span class="cm"> * cache setting for the page has been changed. -jskov</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">nocache_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CPU_IS_040_OR_060</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgd_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
		<span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">;</span>
		<span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">;</span>

		<span class="n">dir</span> <span class="o">=</span> <span class="n">pgd_offset_k</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">pmdp</span> <span class="o">=</span> <span class="n">pmd_offset</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">ptep</span> <span class="o">=</span> <span class="n">pte_offset_kernel</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptep</span> <span class="o">=</span> <span class="n">pte_mknocache</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cache_page</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CPU_IS_040_OR_060</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pgd_t</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
		<span class="n">pmd_t</span> <span class="o">*</span><span class="n">pmdp</span><span class="p">;</span>
		<span class="n">pte_t</span> <span class="o">*</span><span class="n">ptep</span><span class="p">;</span>

		<span class="n">dir</span> <span class="o">=</span> <span class="n">pgd_offset_k</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">pmdp</span> <span class="o">=</span> <span class="n">pmd_offset</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">ptep</span> <span class="o">=</span> <span class="n">pte_offset_kernel</span><span class="p">(</span><span class="n">pmdp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptep</span> <span class="o">=</span> <span class="n">pte_mkcache</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define PTE_FILE_MAX_BITS	28</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pte_to_pgoff</span><span class="p">(</span><span class="n">pte_t</span> <span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pte</span><span class="p">.</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">pte_t</span> <span class="nf">pgoff_to_pte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pte_t</span> <span class="n">pte</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">_PAGE_FILE</span> <span class="p">};</span>
	<span class="k">return</span> <span class="n">pte</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encode and de-code a swap entry (must be !pte_none(e) &amp;&amp; !pte_present(e)) */</span>
<span class="cp">#define __swp_type(x)		(((x).val &gt;&gt; 4) &amp; 0xff)</span>
<span class="cp">#define __swp_offset(x)		((x).val &gt;&gt; 12)</span>
<span class="cp">#define __swp_entry(type, offset) ((swp_entry_t) { ((type) &lt;&lt; 4) | ((offset) &lt;&lt; 12) })</span>
<span class="cp">#define __pte_to_swp_entry(pte)	((swp_entry_t) { pte_val(pte) })</span>
<span class="cp">#define __swp_entry_to_pte(x)	((pte_t) { (x).val })</span>

<span class="cp">#endif	</span><span class="cm">/* !__ASSEMBLY__ */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* _MOTOROLA_PGTABLE_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
