<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m68k › include › asm › sun3mmu.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sun3mmu.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Definitions for Sun3 custom MMU.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef __SUN3_MMU_H__</span>
<span class="cp">#define __SUN3_MMU_H__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;asm/movs.h&gt;</span>
<span class="cp">#include &lt;asm/sun3-head.h&gt;</span>

<span class="cm">/* MMU characteristics. */</span>
<span class="cp">#define SUN3_SEGMAPS_PER_CONTEXT	2048</span>
<span class="cp">#define SUN3_PMEGS_NUM			256</span>
<span class="cp">#define SUN3_CONTEXTS_NUM               8</span>

<span class="cp">#define SUN3_PMEG_SIZE_BITS	 17</span>
<span class="cp">#define SUN3_PMEG_SIZE		 (1 &lt;&lt; SUN3_PMEG_SIZE_BITS)</span>
<span class="cp">#define SUN3_PMEG_MASK		 (SUN3_PMEG_SIZE - 1)</span>

<span class="cp">#define SUN3_PTE_SIZE_BITS       13</span>
<span class="cp">#define SUN3_PTE_SIZE		 (1 &lt;&lt; SUN3_PTE_SIZE_BITS)</span>
<span class="cp">#define SUN3_PTE_MASK		 (SUN3_PTE_SIZE - 1)</span>

<span class="cp">#define SUN3_CONTROL_MASK       (0x0FFFFFFC)</span>
<span class="cp">#define SUN3_INVALID_PMEG	255</span>
<span class="cp">#define SUN3_INVALID_CONTEXT 255</span>

<span class="cp">#define AC_IDPROM     0x00000000    </span><span class="cm">/* 34  ID PROM, R/O, byte, 32 bytes      */</span><span class="cp"></span>
<span class="cp">#define AC_PAGEMAP    0x10000000    </span><span class="cm">/* 3   Pagemap R/W, long                 */</span><span class="cp"></span>
<span class="cp">#define AC_SEGMAP     0x20000000    </span><span class="cm">/* 3   Segment map, byte                 */</span><span class="cp"></span>
<span class="cp">#define AC_CONTEXT    0x30000000    </span><span class="cm">/* 34c current mmu-context               */</span><span class="cp"></span>
<span class="cp">#define AC_SENABLE    0x40000000    </span><span class="cm">/* 34c system dvma/cache/reset enable reg*/</span><span class="cp"></span>
<span class="cp">#define AC_UDVMA_ENB  0x50000000    </span><span class="cm">/* 34  Not used on Sun boards, byte      */</span><span class="cp"></span>
<span class="cp">#define AC_BUS_ERROR  0x60000000    </span><span class="cm">/* 34  Cleared on read, byte.            */</span><span class="cp"></span>
<span class="cp">#define AC_SYNC_ERR   0x60000000    </span><span class="cm">/*   c fault type                        */</span><span class="cp"></span>
<span class="cp">#define AC_SYNC_VA    0x60000004    </span><span class="cm">/*   c fault virtual address             */</span><span class="cp"></span>
<span class="cp">#define AC_ASYNC_ERR  0x60000008    </span><span class="cm">/*   c asynchronous fault type           */</span><span class="cp"></span>
<span class="cp">#define AC_ASYNC_VA   0x6000000c    </span><span class="cm">/*   c async fault virtual address       */</span><span class="cp"></span>
<span class="cp">#define AC_LEDS       0x70000000    </span><span class="cm">/* 34  Zero turns on LEDs, byte          */</span><span class="cp"></span>
<span class="cp">#define AC_CACHETAGS  0x80000000    </span><span class="cm">/* 34c direct access to the VAC tags     */</span><span class="cp"></span>
<span class="cp">#define AC_CACHEDDATA 0x90000000    </span><span class="cm">/* 3 c direct access to the VAC data     */</span><span class="cp"></span>
<span class="cp">#define AC_UDVMA_MAP  0xD0000000    </span><span class="cm">/* 4   Not used on Sun boards, byte      */</span><span class="cp"></span>
<span class="cp">#define AC_VME_VECTOR 0xE0000000    </span><span class="cm">/* 4   For non-Autovector VME, byte      */</span><span class="cp"></span>
<span class="cp">#define AC_BOOT_SCC   0xF0000000    </span><span class="cm">/* 34  bypass to access Zilog 8530. byte.*/</span><span class="cp"></span>

<span class="cp">#define SUN3_PAGE_CHG_MASK (SUN3_PAGE_PGNUM_MASK \</span>
<span class="cp">			    | SUN3_PAGE_ACCESSED | SUN3_PAGE_MODIFIED)</span>

<span class="cm">/* Bus access type within PTE. */</span>
<span class="cp">#define SUN3_PAGE_TYPE_MASK   (0x0c000000)</span>
<span class="cp">#define SUN3_PAGE_TYPE_MEMORY (0x00000000)</span>
<span class="cp">#define SUN3_PAGE_TYPE_IO     (0x04000000)</span>
<span class="cp">#define SUN3_PAGE_TYPE_VME16  (0x08000000)</span>
<span class="cp">#define SUN3_PAGE_TYPE_VME32  (0x0c000000)</span>

<span class="cm">/* Mask for page number within PTE. */</span>
<span class="cp">#define SUN3_PAGE_PGNUM_MASK (0x0007FFFF)</span>

<span class="cm">/* Bits within bus-error register. */</span>
<span class="cp">#define SUN3_BUSERR_WATCHDOG	(0x01)</span>
<span class="cp">#define SUN3_BUSERR_unused	(0x02)</span>
<span class="cp">#define SUN3_BUSERR_FPAENERR	(0x04)</span>
<span class="cp">#define SUN3_BUSERR_FPABERR	(0x08)</span>
<span class="cp">#define SUN3_BUSERR_VMEBERR	(0x10)</span>
<span class="cp">#define SUN3_BUSERR_TIMEOUT	(0x20)</span>
<span class="cp">#define SUN3_BUSERR_PROTERR	(0x40)</span>
<span class="cp">#define SUN3_BUSERR_INVALID	(0x80)</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cm">/* Read bus error status register (implicitly clearing it). */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sun3_get_buserr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sfc</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">GET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
	<span class="n">SET_SFC</span> <span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
	<span class="n">GET_CONTROL_BYTE</span> <span class="p">(</span><span class="n">AC_BUS_ERROR</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">SET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read segmap from hardware MMU. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sun3_get_segmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="n">sfc</span><span class="p">;</span>

        <span class="n">GET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
        <span class="n">SET_SFC</span> <span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
        <span class="n">GET_CONTROL_BYTE</span> <span class="p">(</span><span class="n">AC_SEGMAP</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SUN3_CONTROL_MASK</span><span class="p">),</span> <span class="n">c</span><span class="p">);</span>
        <span class="n">SET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write segmap to hardware MMU. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sun3_put_segmap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sfc</span><span class="p">;</span>

        <span class="n">GET_DFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
        <span class="n">SET_DFC</span> <span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
        <span class="n">SET_CONTROL_BYTE</span> <span class="p">(</span><span class="n">AC_SEGMAP</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SUN3_CONTROL_MASK</span><span class="p">),</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">SET_DFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>

        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read PTE from hardware MMU. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sun3_get_pte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sfc</span><span class="p">;</span>

        <span class="n">GET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
        <span class="n">SET_SFC</span> <span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
        <span class="n">GET_CONTROL_WORD</span> <span class="p">(</span><span class="n">AC_PAGEMAP</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SUN3_CONTROL_MASK</span><span class="p">),</span> <span class="n">entry</span><span class="p">);</span>
        <span class="n">SET_SFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write PTE to hardware MMU. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sun3_put_pte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sfc</span><span class="p">;</span>

        <span class="n">GET_DFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
        <span class="n">SET_DFC</span> <span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
        <span class="n">SET_CONTROL_WORD</span> <span class="p">(</span><span class="n">AC_PAGEMAP</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SUN3_CONTROL_MASK</span><span class="p">),</span> <span class="n">entry</span><span class="p">);</span>
	<span class="n">SET_DFC</span> <span class="p">(</span><span class="n">sfc</span><span class="p">);</span>

        <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get current context */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sun3_get_context</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sfc</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">GET_SFC</span><span class="p">(</span><span class="n">sfc</span><span class="p">);</span>
	<span class="n">SET_SFC</span><span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
	<span class="n">GET_CONTROL_BYTE</span><span class="p">(</span><span class="n">AC_CONTEXT</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">SET_SFC</span><span class="p">(</span><span class="n">sfc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set alternate context */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sun3_put_context</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dfc</span><span class="p">;</span>
	<span class="n">GET_DFC</span><span class="p">(</span><span class="n">dfc</span><span class="p">);</span>
	<span class="n">SET_DFC</span><span class="p">(</span><span class="n">FC_CONTROL</span><span class="p">);</span>
	<span class="n">SET_CONTROL_BYTE</span><span class="p">(</span><span class="n">AC_CONTEXT</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">SET_DFC</span><span class="p">(</span><span class="n">dfc</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sun3_ioremap</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">sun3_map_test</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* !__ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#endif	</span><span class="cm">/* !__SUN3_MMU_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
