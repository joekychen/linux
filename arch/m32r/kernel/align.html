<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m32r › kernel › align.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>align.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * align.c - address exception handler for M32R</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 Hitoshi Yamamoto</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r0</span> <span class="o">+</span> <span class="n">nr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r4</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r7</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">7</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">13</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r0</span> <span class="o">+</span> <span class="n">nr</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r4</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r7</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">7</span><span class="p">))</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">+</span> <span class="p">(</span><span class="n">nr</span> <span class="o">-</span> <span class="mi">13</span><span class="p">))</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define REG1(insn)	(((insn) &amp; 0x0f00) &gt;&gt; 8)</span>
<span class="cp">#define REG2(insn)	((insn) &amp; 0x000f)</span>
<span class="cp">#define PSW_BC		0x100</span>

<span class="cm">/* O- instruction */</span>
<span class="cp">#define ISA_LD1		0x20c0	</span><span class="cm">/* ld Rdest, @Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_LD2		0x20e0	</span><span class="cm">/* ld Rdest, @Rsrc+ */</span><span class="cp"></span>
<span class="cp">#define ISA_LDH		0x20a0	</span><span class="cm">/* ldh Rdest, @Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_LDUH	0x20b0	</span><span class="cm">/* lduh Rdest, @Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_ST1		0x2040	</span><span class="cm">/* st Rsrc1, @Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_ST2		0x2060	</span><span class="cm">/* st Rsrc1, @+Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_ST3		0x2070	</span><span class="cm">/* st Rsrc1, @-Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_STH1	0x2020	</span><span class="cm">/* sth Rsrc1, @Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_STH2	0x2030	</span><span class="cm">/* sth Rsrc1, @Rsrc2+ */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ISA_DUAL_ISSUE</span>

<span class="cm">/* OS instruction */</span>
<span class="cp">#define ISA_ADD		0x00a0	</span><span class="cm">/* add Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_ADDI	0x4000	</span><span class="cm">/* addi Rdest, #imm8 */</span><span class="cp"></span>
<span class="cp">#define ISA_ADDX	0x0090	</span><span class="cm">/* addx Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_AND		0x00c0	</span><span class="cm">/* and Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_CMP		0x0040	</span><span class="cm">/* cmp Rsrc1, Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_CMPEQ	0x0060	</span><span class="cm">/* cmpeq Rsrc1, Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_CMPU	0x0050	</span><span class="cm">/* cmpu Rsrc1, Rsrc2 */</span><span class="cp"></span>
<span class="cp">#define ISA_CMPZ	0x0070	</span><span class="cm">/* cmpz Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_LDI		0x6000	</span><span class="cm">/* ldi Rdest, #imm8 */</span><span class="cp"></span>
<span class="cp">#define ISA_MV		0x1080	</span><span class="cm">/* mv Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_NEG		0x0030	</span><span class="cm">/* neg Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_NOP		0x7000	</span><span class="cm">/* nop */</span><span class="cp"></span>
<span class="cp">#define ISA_NOT		0x00b0	</span><span class="cm">/* not Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_OR		0x00e0	</span><span class="cm">/* or Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_SUB		0x0020	</span><span class="cm">/* sub Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_SUBX	0x0010	</span><span class="cm">/* subx Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_XOR		0x00d0	</span><span class="cm">/* xor Rdest, Rsrc */</span><span class="cp"></span>

<span class="cm">/* -S instruction */</span>
<span class="cp">#define ISA_MUL		0x1060	</span><span class="cm">/* mul Rdest, Rsrc */</span><span class="cp"></span>
<span class="cp">#define ISA_MULLO_A0	0x3010	</span><span class="cm">/* mullo Rsrc1, Rsrc2, A0 */</span><span class="cp"></span>
<span class="cp">#define ISA_MULLO_A1	0x3090	</span><span class="cm">/* mullo Rsrc1, Rsrc2, A1 */</span><span class="cp"></span>
<span class="cp">#define ISA_MVFACMI_A0	0x50f2	</span><span class="cm">/* mvfacmi Rdest, A0 */</span><span class="cp"></span>
<span class="cp">#define ISA_MVFACMI_A1	0x50f6	</span><span class="cm">/* mvfacmi Rdest, A1 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_addi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">imm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="n">imm</span><span class="p">;</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ldi</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">imm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">imm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_add</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_addx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;</span> <span class="n">PSW_BC</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* C bit set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_and</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cmp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">)))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cmpeq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span> <span class="o">==</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">)))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cmpu</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">))</span>
		<span class="o">&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">)))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_cmpz</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">)))</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_neg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_not</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="o">~</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_or</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_sub</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">-=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_subx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">-=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">-=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;</span> <span class="n">PSW_BC</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* C bit set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">|=</span> <span class="n">PSW_BC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">psw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PSW_BC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_xor</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">^=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mul</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="n">reg1</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">reg2</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;mul	%0, %1;		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span>
	<span class="p">);</span>

	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mullo_a0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="n">reg1</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">reg2</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;mullo		%0, %1, a0;	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mvfachi	%0, a0;		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mvfaclo	%1, a0;		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span>
	<span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc0h</span> <span class="o">=</span> <span class="n">reg1</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc0l</span> <span class="o">=</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mullo_a1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="n">reg1</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>
	<span class="n">reg2</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn</span><span class="p">));</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;mullo		%0, %1, a0;	</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mvfachi	%0, a0;		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="s">&quot;mvfaclo	%1, a0;		</span><span class="se">\n\t</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">reg1</span><span class="p">),</span> <span class="s">&quot;+r&quot;</span> <span class="p">(</span><span class="n">reg2</span><span class="p">)</span>
	<span class="p">);</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc1h</span> <span class="o">=</span> <span class="n">reg1</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc1l</span> <span class="o">=</span> <span class="n">reg2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mvfacmi_a0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc0h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc0l</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_mvfacmi_a1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc1h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">acc1l</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_m32r2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISA_NOP</span><span class="p">)</span>	<span class="cm">/* nop */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISA_ADDI</span>:		<span class="cm">/* addi Rdest, #imm8 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_addi</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_LDI</span>:		<span class="cm">/* ldi Rdest, #imm8 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_ldi</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x70f0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISA_ADD</span>:		<span class="cm">/* add Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_add</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_ADDX</span>:		<span class="cm">/* addx Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_addx</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_AND</span>:		<span class="cm">/* and Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_and</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_CMP</span>:		<span class="cm">/* cmp Rsrc1, Rsrc2 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_cmp</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_CMPEQ</span>:		<span class="cm">/* cmpeq Rsrc1, Rsrc2 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_cmpeq</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_CMPU</span>:		<span class="cm">/* cmpu Rsrc1, Rsrc2 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_cmpu</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_CMPZ</span>:		<span class="cm">/* cmpz Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_cmpz</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_MV</span>:		<span class="cm">/* mv Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mv</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_NEG</span>:		<span class="cm">/* neg Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_neg</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_NOT</span>:		<span class="cm">/* not Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_not</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_OR</span>:		<span class="cm">/* or Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_or</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_SUB</span>:		<span class="cm">/* sub Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_sub</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_SUBX</span>:		<span class="cm">/* subx Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_subx</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_XOR</span>:		<span class="cm">/* xor Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_xor</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_MUL</span>:		<span class="cm">/* mul Rdest, Rsrc */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mul</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_MULLO_A0</span>:	<span class="cm">/* mullo Rsrc1, Rsrc2 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mullo_a0</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_MULLO_A1</span>:	<span class="cm">/* mullo Rsrc1, Rsrc2 */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mullo_a1</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x70ff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISA_MVFACMI_A0</span>:	<span class="cm">/* mvfacmi Rdest */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mvfacmi_a0</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISA_MVFACMI_A1</span>:	<span class="cm">/* mvfacmi Rdest */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_mvfacmi_a1</span><span class="p">(</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_ISA_DUAL_ISSUE */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * ld   : ?010 dest 1100 src</span>
<span class="cm"> *        0010 dest 1110 src : ld Rdest, @Rsrc+</span>
<span class="cm"> * ldh  : ?010 dest 1010 src</span>
<span class="cm"> * lduh : ?010 dest 1011 src</span>
<span class="cm"> * st   : ?010 src1 0100 src2</span>
<span class="cm"> *        0010 src1 0110 src2 : st Rsrc1, @+Rsrc2</span>
<span class="cm"> *        0010 src1 0111 src2 : st Rsrc1, @-Rsrc2</span>
<span class="cm"> * sth  : ?010 src1 0010 src2</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">insn_check</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">insn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ucp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 32bit insn</span>
<span class="cm">	 *  ld Rdest, @(disp16, Rsrc)</span>
<span class="cm">	 *  st Rdest, @(disp16, Rsrc)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 32bit insn */</span>
		<span class="o">*</span><span class="n">ucp</span> <span class="o">+=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">bpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>			<span class="cm">/* 16bit insn */</span>
<span class="cp">#ifdef CONFIG_ISA_DUAL_ISSUE</span>
		<span class="cm">/* parallel exec check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bpc</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">insn</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">emu_m32r2</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">insn</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">bpc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_ISA_DUAL_ISSUE */</span><span class="cp"></span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">bpc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_ld</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">insn32</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">src</span><span class="p">;</span>

	<span class="n">insn16</span> <span class="o">=</span> <span class="n">insn32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn16</span><span class="p">);</span>
	<span class="n">ucp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn_check</span><span class="p">(</span><span class="n">insn32</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x0040</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">ucp</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* ldh sign check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x00f0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00a0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0xffff0000</span><span class="p">;</span>

	<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn16</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* ld increment check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0xf0f0</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISA_LD2</span><span class="p">)</span>	<span class="cm">/* ld Rdest, @Rsrc+ */</span>
		<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">ucp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emu_st</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">insn32</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ucp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">src2</span><span class="p">;</span>

	<span class="n">insn16</span> <span class="o">=</span> <span class="n">insn32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">src2</span> <span class="o">=</span> <span class="n">REG2</span><span class="p">(</span><span class="n">insn16</span><span class="p">);</span>

	<span class="n">ucp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn_check</span><span class="p">(</span><span class="n">insn32</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x0040</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">get_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">REG1</span><span class="p">(</span><span class="n">insn16</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* st inc/dec check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0xf0e0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x2060</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x0010</span><span class="p">)</span>
			<span class="n">ucp</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ucp</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ucp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ucp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* sth inc check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0xf0f0</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISA_STH2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">set_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ucp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">handle_unaligned_access</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">insn32</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">insn16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">insn16</span> <span class="o">=</span> <span class="n">insn32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* ld or st check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x2000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* insn alignment check */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">bpc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">insn16</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span>	<span class="cm">/* ld */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_ld</span><span class="p">(</span><span class="n">insn32</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">else</span>			<span class="cm">/* st */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">emu_st</span><span class="p">(</span><span class="n">insn32</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
