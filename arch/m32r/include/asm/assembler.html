<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › m32r › include › asm › assembler.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>assembler.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_M32R_ASSEMBLER_H</span>
<span class="cp">#define _ASM_M32R_ASSEMBLER_H</span>

<span class="cm">/*</span>
<span class="cm"> * linux/asm-m32r/assembler.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004  Hirokazu Takata &lt;takata at linux-m32r.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains M32R architecture specific macro definitions.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/stringify.h&gt;</span>

<span class="cp">#undef __STR</span>

<span class="cp">#ifdef __ASSEMBLY__</span>
<span class="cp">#define __STR(x) x</span>
<span class="cp">#else</span>
<span class="cp">#define __STR(x) __stringify(x)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SMP</span>
<span class="cp">#define M32R_LOCK	__STR(lock)</span>
<span class="cp">#define M32R_UNLOCK	__STR(unlock)</span>
<span class="cp">#else</span>
<span class="cp">#define M32R_LOCK	__STR(ld)</span>
<span class="cp">#define M32R_UNLOCK	__STR(st)</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __ASSEMBLY__</span>
<span class="cp">#undef ENTRY</span>
<span class="cp">#define ENTRY(name) ENTRY_M name</span>
	<span class="p">.</span><span class="n">macro</span>  <span class="n">ENTRY_M</span> <span class="n">name</span>
	<span class="p">.</span><span class="n">global</span> <span class="err">\</span><span class="n">name</span>
	<span class="n">ALIGN</span>
<span class="err">\</span><span class="n">name</span><span class="o">:</span>
	<span class="p">.</span><span class="n">endm</span>
<span class="cp">#endif</span>


<span class="cm">/**</span>
<span class="cm"> * LDIMM - load immediate value</span>
<span class="cm"> * STI - enable interruption</span>
<span class="cm"> * CLI - disable interruption</span>
<span class="cm"> */</span>

<span class="cp">#ifdef __ASSEMBLY__</span>

<span class="cp">#define LDIMM(reg,x) LDIMM reg x</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">LDIMM</span> <span class="n">reg</span> <span class="n">x</span>
	<span class="n">seth</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">#</span><span class="n">high</span><span class="p">(</span><span class="err">\</span><span class="n">x</span><span class="p">)</span>
	<span class="n">or3</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">#</span><span class="n">low</span><span class="p">(</span><span class="err">\</span><span class="n">x</span><span class="p">)</span>
	<span class="p">.</span><span class="n">endm</span>

<span class="cp">#if !(defined(CONFIG_CHIP_M32102) || defined(CONFIG_CHIP_M32104))</span>
<span class="cp">#define ENABLE_INTERRUPTS(reg) ENABLE_INTERRUPTS reg</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">ENABLE_INTERRUPTS</span> <span class="n">reg</span>
	<span class="n">setpsw</span>  <span class="err">#</span><span class="mh">0x40</span>	    <span class="o">-&gt;</span>	<span class="n">nop</span>
	<span class="p">;</span> <span class="n">WORKAROUND</span><span class="o">:</span> <span class="s">&quot;-&gt; nop&quot;</span> <span class="n">is</span> <span class="n">a</span> <span class="n">workaround</span> <span class="k">for</span> <span class="n">the</span> <span class="n">M32700</span><span class="p">(</span><span class="n">TS1</span><span class="p">).</span>
	<span class="p">.</span><span class="n">endm</span>

<span class="cp">#define DISABLE_INTERRUPTS(reg) DISABLE_INTERRUPTS reg</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">DISABLE_INTERRUPTS</span> <span class="n">reg</span>
	<span class="n">clrpsw</span>  <span class="err">#</span><span class="mh">0x40</span>	    <span class="o">-&gt;</span>	<span class="n">nop</span>
	<span class="p">;</span> <span class="n">WORKAROUND</span><span class="o">:</span> <span class="s">&quot;-&gt; nop&quot;</span> <span class="n">is</span> <span class="n">a</span> <span class="n">workaround</span> <span class="k">for</span> <span class="n">the</span> <span class="n">M32700</span><span class="p">(</span><span class="n">TS1</span><span class="p">).</span>
	<span class="p">.</span><span class="n">endm</span>
<span class="cp">#else	</span><span class="cm">/* CONFIG_CHIP_M32102 || CONFIG_CHIP_M32104 */</span><span class="cp"></span>
<span class="cp">#define ENABLE_INTERRUPTS(reg) ENABLE_INTERRUPTS reg</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">ENABLE_INTERRUPTS</span> <span class="n">reg</span>
	<span class="n">mvfc</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">or3</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0040</span>
	<span class="n">mvtc</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="n">psw</span>
	<span class="p">.</span><span class="n">endm</span>

<span class="cp">#define DISABLE_INTERRUPTS(reg) DISABLE_INTERRUPTS reg</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">DISABLE_INTERRUPTS</span> <span class="n">reg</span>
	<span class="n">mvfc</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">and3</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xffbf</span>
	<span class="n">mvtc</span>	<span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="n">psw</span>
	<span class="p">.</span><span class="n">endm</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_CHIP_M32102 */</span><span class="cp"></span>

	<span class="p">.</span><span class="n">macro</span>	<span class="n">SAVE_ALL</span>
	<span class="n">push</span>	<span class="n">r0</span>		<span class="p">;</span> <span class="n">orig_r0</span>
	<span class="n">push</span>	<span class="n">sp</span>		<span class="p">;</span> <span class="n">spi</span> <span class="p">(</span><span class="n">r15</span><span class="p">)</span>
	<span class="n">push</span>	<span class="n">lr</span>		<span class="p">;</span> <span class="n">r14</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfc</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">cr3</span>	<span class="p">;</span> <span class="n">spu</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfc</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">bbpc</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfc</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">bbpsw</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfc</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">bpc</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfc</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">push</span>	<span class="n">r13</span>
<span class="cp">#if defined(CONFIG_ISA_M32R2) &amp;&amp; defined(CONFIG_ISA_DSP_LEVEL2)</span>
	<span class="n">mvfaclo</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a1</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfachi</span> <span class="n">r13</span><span class="p">,</span> <span class="n">a1</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfaclo</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a0</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfachi</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a0</span>
	<span class="n">push</span>	<span class="n">r13</span>
<span class="cp">#elif defined(CONFIG_ISA_M32R2) || defined(CONFIG_ISA_M32R)</span>
	<span class="n">mvfaclo</span>	<span class="n">r13</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">mvfachi</span>	<span class="n">r13</span>
	<span class="n">push</span>	<span class="n">r13</span>
	<span class="n">ldi</span>	<span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="mi">0</span>
	<span class="n">push</span>	<span class="n">r13</span>		<span class="p">;</span> <span class="n">dummy</span> <span class="n">push</span> <span class="n">acc1h</span>
	<span class="n">push</span>	<span class="n">r13</span>		<span class="p">;</span> <span class="n">dummy</span> <span class="n">push</span> <span class="n">acc1l</span>
<span class="cp">#else</span>
<span class="cp">#error unknown isa configuration</span>
<span class="cp">#endif</span>
	<span class="n">ldi</span>	<span class="n">r13</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">1</span>
	<span class="n">push</span>	<span class="n">r13</span>		<span class="p">;</span> <span class="n">syscall_nr</span> <span class="p">(</span><span class="k">default</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="n">push</span>	<span class="n">r12</span>
	<span class="n">push</span>	<span class="n">r11</span>
	<span class="n">push</span>	<span class="n">r10</span>
	<span class="n">push</span>	<span class="n">r9</span>
	<span class="n">push</span>	<span class="n">r8</span>
	<span class="n">push</span>	<span class="n">r7</span>
	<span class="n">push</span>	<span class="n">r3</span>
	<span class="n">push</span>	<span class="n">r2</span>
	<span class="n">push</span>	<span class="n">r1</span>
	<span class="n">push</span>	<span class="n">r0</span>
	<span class="n">addi</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">4</span>		<span class="p">;</span> <span class="n">room</span> <span class="k">for</span> <span class="n">implicit</span> <span class="n">pt_regs</span> <span class="n">parameter</span>
	<span class="n">push</span>	<span class="n">r6</span>
	<span class="n">push</span>	<span class="n">r5</span>
	<span class="n">push</span>	<span class="n">r4</span>
	<span class="p">.</span><span class="n">endm</span>

	<span class="p">.</span><span class="n">macro</span>	<span class="n">RESTORE_ALL</span>
	<span class="n">pop</span>	<span class="n">r4</span>
	<span class="n">pop</span>	<span class="n">r5</span>
	<span class="n">pop</span>	<span class="n">r6</span>
	<span class="n">addi</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
	<span class="n">pop</span>	<span class="n">r0</span>
	<span class="n">pop</span>	<span class="n">r1</span>
	<span class="n">pop</span>	<span class="n">r2</span>
	<span class="n">pop</span>	<span class="n">r3</span>
	<span class="n">pop</span>	<span class="n">r7</span>
	<span class="n">pop</span>	<span class="n">r8</span>
	<span class="n">pop</span>	<span class="n">r9</span>
	<span class="n">pop</span>	<span class="n">r10</span>
	<span class="n">pop</span>	<span class="n">r11</span>
	<span class="n">pop</span>	<span class="n">r12</span>
	<span class="n">addi</span>	<span class="n">r15</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>		<span class="p">;</span> <span class="n">Skip</span> <span class="n">syscall</span> <span class="n">number</span>
<span class="cp">#if defined(CONFIG_ISA_M32R2) &amp;&amp; defined(CONFIG_ISA_DSP_LEVEL2)</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtachi</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a0</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtaclo</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a0</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtachi</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a1</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtaclo</span>	<span class="n">r13</span><span class="p">,</span> <span class="n">a1</span>
<span class="cp">#elif defined(CONFIG_ISA_M32R2) || defined(CONFIG_ISA_M32R)</span>
	<span class="n">pop</span>	<span class="n">r13</span>		<span class="p">;</span> <span class="n">dummy</span> <span class="n">pop</span> <span class="n">acc1h</span>
	<span class="n">pop</span>	<span class="n">r13</span>		<span class="p">;</span> <span class="n">dummy</span> <span class="n">pop</span> <span class="n">acc1l</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtachi</span>	<span class="n">r13</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">mvtaclo</span>	<span class="n">r13</span>
<span class="cp">#else</span>
<span class="cp">#error unknown isa configuration</span>
<span class="cp">#endif</span>
	<span class="n">pop</span>	<span class="n">r14</span>
	<span class="n">mvtc</span>	<span class="n">r14</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">pop</span>	<span class="n">r14</span>
	<span class="n">mvtc</span>	<span class="n">r14</span><span class="p">,</span> <span class="n">bpc</span>
	<span class="n">addi</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">8</span>		<span class="p">;</span> <span class="n">Skip</span> <span class="n">bbpsw</span><span class="p">,</span> <span class="n">bbpc</span>
	<span class="n">pop</span>	<span class="n">r14</span>
	<span class="n">mvtc</span>	<span class="n">r14</span><span class="p">,</span> <span class="n">cr3</span>	<span class="p">;</span> <span class="n">spu</span>
	<span class="n">pop</span>	<span class="n">r13</span>
	<span class="n">pop</span>	<span class="n">lr</span>		<span class="p">;</span> <span class="n">r14</span>
	<span class="n">pop</span>	<span class="n">sp</span>		<span class="p">;</span> <span class="n">spi</span> <span class="p">(</span><span class="n">r15</span><span class="p">)</span>
	<span class="n">addi</span>	<span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>		<span class="p">;</span> <span class="n">Skip</span> <span class="n">orig_r0</span>
	<span class="p">.</span><span class="n">fillinsn</span>
<span class="mi">1</span><span class="o">:</span>	<span class="n">rte</span>
	<span class="p">.</span><span class="n">section</span> <span class="p">.</span><span class="n">fixup</span><span class="p">,</span><span class="s">&quot;ax&quot;</span>
<span class="mi">2</span><span class="o">:</span>	<span class="n">bl</span>	<span class="n">do_exit</span>
	<span class="p">.</span><span class="n">previous</span>
	<span class="p">.</span><span class="n">section</span> <span class="n">__ex_table</span><span class="p">,</span><span class="s">&quot;a&quot;</span>
	<span class="n">ALIGN</span>
	<span class="p">.</span><span class="kt">long</span>	<span class="mi">1</span><span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="n">b</span>
	<span class="p">.</span><span class="n">previous</span>
	<span class="p">.</span><span class="n">endm</span>

<span class="cp">#define GET_CURRENT(reg)  get_current reg</span>
	<span class="p">.</span><span class="n">macro</span> <span class="n">get_current</span> <span class="n">reg</span>
	<span class="n">ldi</span>  <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">8192</span>
	<span class="n">and</span>  <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="n">sp</span>
	<span class="p">.</span><span class="n">endm</span>

<span class="cp">#if !(defined(CONFIG_CHIP_M32102) || defined(CONFIG_CHIP_M32104))</span>
	<span class="p">.</span><span class="n">macro</span>	<span class="n">SWITCH_TO_KERNEL_STACK</span>
	<span class="p">;</span> <span class="k">switch</span> <span class="n">to</span> <span class="n">kernel</span> <span class="n">stack</span> <span class="p">(</span><span class="n">spi</span><span class="p">)</span>
	<span class="n">clrpsw</span>	<span class="err">#</span><span class="mh">0x80</span>	    <span class="o">-&gt;</span>	<span class="n">nop</span>
	<span class="p">.</span><span class="n">endm</span>
<span class="cp">#else	</span><span class="cm">/* CONFIG_CHIP_M32102 || CONFIG_CHIP_M32104 */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">macro</span>	<span class="n">SWITCH_TO_KERNEL_STACK</span>
	<span class="n">push</span>	<span class="n">r0</span>		<span class="p">;</span> <span class="n">save</span> <span class="n">r0</span> <span class="k">for</span> <span class="n">working</span>
	<span class="n">mvfc</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">and3</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x00ff7f</span>
	<span class="n">mvtc</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">psw</span>
	<span class="n">slli</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span>
	<span class="n">bltz</span>	<span class="n">r0</span><span class="p">,</span> <span class="mf">1f</span>		<span class="p">;</span> <span class="n">check</span> <span class="n">BSM</span><span class="o">-</span><span class="n">bit</span>
<span class="p">;</span>
	<span class="p">;;</span> <span class="n">called</span> <span class="n">from</span> <span class="n">kernel</span> <span class="n">context</span><span class="o">:</span> <span class="n">previous</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">spi</span>
	<span class="n">pop</span>	<span class="n">r0</span>		<span class="p">;</span> <span class="n">retrieve</span> <span class="n">r0</span>
	<span class="n">bra</span>	<span class="mf">2f</span>
	<span class="p">.</span><span class="n">fillinsn</span>
<span class="mi">1</span><span class="o">:</span>
	<span class="p">;;</span> <span class="n">called</span> <span class="n">from</span> <span class="n">user</span> <span class="n">context</span><span class="o">:</span> <span class="n">previous</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">spu</span>
	<span class="n">mvfc</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">cr3</span>		<span class="p">;</span> <span class="n">spu</span>
	<span class="n">addi</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">#</span><span class="mi">4</span>
	<span class="n">mvtc</span>	<span class="n">r0</span><span class="p">,</span> <span class="n">cr3</span>		<span class="p">;</span> <span class="n">spu</span>
	<span class="n">ld</span>	<span class="n">r0</span><span class="p">,</span> <span class="err">@</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">r0</span><span class="p">)</span>	<span class="p">;</span> <span class="n">retrieve</span> <span class="n">r0</span>
	<span class="p">.</span><span class="n">fillinsn</span>
<span class="mi">2</span><span class="o">:</span>
	<span class="p">.</span><span class="n">endm</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_CHIP_M32102 || CONFIG_CHIP_M32104 */</span><span class="cp"></span>

<span class="cp">#endif	</span><span class="cm">/* __ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#endif	</span><span class="cm">/* _ASM_M32R_ASSEMBLER_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
