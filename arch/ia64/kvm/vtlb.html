<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kvm › vtlb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vtlb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * vtlb.c: guest virtual tlb handling module.</span>
<span class="cm"> * Copyright (c) 2004, Intel Corporation.</span>
<span class="cm"> *  Yaozu Dong (Eddie Dong) &lt;Eddie.dong@intel.com&gt;</span>
<span class="cm"> *  Xuefei Xu (Anthony Xu) &lt;anthony.xu@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007, Intel Corporation.</span>
<span class="cm"> *  Xuefei Xu (Anthony Xu) &lt;anthony.xu@intel.com&gt;</span>
<span class="cm"> *  Xiantao Zhang &lt;xiantao.zhang@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;vcpu.h&quot;</span>

<span class="cp">#include &lt;linux/rwsem.h&gt;</span>

<span class="cp">#include &lt;asm/tlb.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * Check to see if the address rid:va is translated by the TLB</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__is_tr_translated</span><span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">trp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">==</span> <span class="n">rid</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">va</span><span class="o">-</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">vadr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PSIZE</span><span class="p">(</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Only for GUEST TR format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__is_tr_overlap</span><span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">trp</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sva</span><span class="p">,</span> <span class="n">u64</span> <span class="n">eva</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">sa1</span><span class="p">,</span> <span class="n">ea1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">||</span> <span class="n">trp</span><span class="o">-&gt;</span><span class="n">rid</span> <span class="o">!=</span> <span class="n">rid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sa1</span> <span class="o">=</span> <span class="n">trp</span><span class="o">-&gt;</span><span class="n">vadr</span><span class="p">;</span>
	<span class="n">ea1</span> <span class="o">=</span> <span class="n">sa1</span> <span class="o">+</span> <span class="n">PSIZE</span><span class="p">(</span><span class="n">trp</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">eva</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sva</span> <span class="o">&gt;</span> <span class="n">ea1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sa1</span> <span class="o">&gt;</span> <span class="n">eva</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">machine_tlb_purge</span><span class="p">(</span><span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ia64_ptcl</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">local_flush_tlb_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">count0</span><span class="p">,</span> <span class="n">count1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride0</span><span class="p">,</span> <span class="n">stride1</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span>    <span class="o">=</span> <span class="n">current_vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptce_base</span><span class="p">;</span>
	<span class="n">count0</span>  <span class="o">=</span> <span class="n">current_vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptce_count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">count1</span>  <span class="o">=</span> <span class="n">current_vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptce_count</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">stride0</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptce_stride</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">stride1</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptce_stride</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">count1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ia64_ptce</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">stride1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">stride0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ia64_srlz_i</span><span class="p">();</span>          <span class="cm">/* srlz.i implies srlz.d */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vhpt_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">vhpt_ref</span> <span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_rr</span>    <span class="n">vrr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_pta</span>   <span class="n">vpta</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">ia64_psr</span>   <span class="n">vpsr</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
	<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vrr</span><span class="p">.</span><span class="n">ve</span> <span class="o">&amp;</span> <span class="n">vpta</span><span class="p">.</span><span class="n">ve</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DATA_REF</span>:
		<span class="k">case</span> <span class="n">NA_REF</span>:
			<span class="k">return</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">dt</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INST_REF</span>:
			<span class="k">return</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">dt</span> <span class="o">&amp;&amp;</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">it</span> <span class="o">&amp;&amp;</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">ic</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RSE_REF</span>:
			<span class="k">return</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">dt</span> <span class="o">&amp;&amp;</span> <span class="n">vpsr</span><span class="p">.</span><span class="n">rt</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="nf">vsa_thash</span><span class="p">(</span><span class="k">union</span> <span class="n">ia64_pta</span> <span class="n">vpta</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vrr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">index</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">pfn_bits</span><span class="p">;</span>

	<span class="n">pfn_bits</span> <span class="o">=</span> <span class="n">vpta</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pfn</span> <span class="o">=</span> <span class="n">REGION_OFFSET</span><span class="p">(</span><span class="n">va</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">_REGION_PAGE_SIZE</span><span class="p">(</span><span class="n">vrr</span><span class="p">);</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">_REGION_ID</span><span class="p">(</span><span class="n">vrr</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">((</span><span class="n">rid</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">pfn_bits</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">pfn</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">pfn_bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="p">((</span><span class="n">rid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">pfn</span> <span class="o">&gt;&gt;</span> <span class="n">pfn_bits</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)((</span><span class="n">vpta</span><span class="p">.</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="n">PTA_BASE_SHIFT</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="nf">__vtr_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">trp</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rid</span><span class="p">;</span>

	<span class="n">rid</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span> <span class="o">&amp;</span> <span class="n">RR_RID_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">D_TLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtr_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtrs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">i</span> <span class="o">&lt;</span> <span class="n">NDTRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">trp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__is_tr_translated</span><span class="p">(</span><span class="n">trp</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">trp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itr_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itrs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">&lt;</span> <span class="n">NITRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">trp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__is_tr_translated</span><span class="p">(</span><span class="n">trp</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">trp</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vhpt_insert</span><span class="p">(</span><span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">u64</span> <span class="n">gpte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">rr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ps</span><span class="p">,</span> <span class="n">gpaddr</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>

	 <span class="n">gpaddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">gpte</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">ifa</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_thash</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
	<span class="n">ia64_mf</span><span class="p">();</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">=</span> <span class="n">pte</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_FLAGS_RV_MASK</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">itir</span> <span class="o">=</span> <span class="n">rr</span><span class="p">.</span><span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">ia64_ttag</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">gpaddr</span> <span class="o">=</span> <span class="n">gpaddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mark_pages_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">i</span><span class="p">,</span> <span class="n">dirty_pages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base_gfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte</span><span class="o">&amp;</span><span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">vmm_spinlock_t</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__kvm_va</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dirty_log_lock_pa</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dirty_bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">KVM_MEM_DIRTY_LOG_BASE</span><span class="p">;</span>

	<span class="n">dirty_pages</span> <span class="o">&lt;&lt;=</span> <span class="n">ps</span> <span class="o">&lt;=</span> <span class="n">PAGE_SHIFT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ps</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">vmm_spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dirty_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* avoid RMW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">base_gfn</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">dirty_bitmap</span><span class="p">))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">base_gfn</span> <span class="o">+</span> <span class="n">i</span> <span class="p">,</span> <span class="n">dirty_bitmap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vmm_spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">thash_vhpt_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">phy_pte</span><span class="p">,</span> <span class="n">psr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">mrr</span><span class="p">;</span>

	<span class="n">mrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
	<span class="n">phy_pte</span> <span class="o">=</span> <span class="n">translate_phy_pte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">mrr</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vhpt_insert</span><span class="p">(</span><span class="n">phy_pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">phy_pte</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PAGE_FLAGS_RV_MASK</span><span class="p">;</span>
		<span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_clear_ic</span><span class="p">();</span>
		<span class="n">ia64_itc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">phy_pte</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
		<span class="n">paravirt_dv_serialize_data</span><span class="p">();</span>
		<span class="n">ia64_set_psr</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pte</span><span class="o">&amp;</span><span class="n">VTLB_PTE_IO</span><span class="p">))</span>
		<span class="n">mark_pages_dirty</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *   vhpt lookup</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="nf">vhpt_lookup</span><span class="p">(</span><span class="n">u64</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_thash</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">ia64_ttag</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">guest_vhpt_lookup</span><span class="p">(</span><span class="n">u64</span> <span class="n">iha</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">pte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">__vtr_lookup</span><span class="p">(</span><span class="n">current_vcpu</span><span class="p">,</span> <span class="n">iha</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">thash_vhpt_insert</span><span class="p">(</span><span class="n">current_vcpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">page_flags</span><span class="p">,</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">itir</span><span class="p">,</span> <span class="n">iha</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;rsm psr.ic|psr.i;;&quot;</span>
			<span class="s">&quot;srlz.d;;&quot;</span>
			<span class="s">&quot;ld8.s r9=[%1];;&quot;</span>
			<span class="s">&quot;tnat.nz p6,p7=r9;;&quot;</span>
			<span class="s">&quot;(p6) mov %0=1;&quot;</span>
			<span class="s">&quot;(p6) mov r9=r0;&quot;</span>
			<span class="s">&quot;(p7) extr.u r9=r9,0,53;;&quot;</span>
			<span class="s">&quot;(p7) mov %0=r0;&quot;</span>
			<span class="s">&quot;(p7) st8 [%2]=r9;;&quot;</span>
			<span class="s">&quot;ssm psr.ic;;&quot;</span>
			<span class="s">&quot;srlz.d;;&quot;</span>
			<span class="s">&quot;ssm psr.i;;&quot;</span>
			<span class="s">&quot;srlz.d;;&quot;</span>
			<span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">iha</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">pte</span><span class="p">)</span><span class="o">:</span><span class="s">&quot;memory&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  purge software guest tlb</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vtlb_purge</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">curadr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">psbits</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">rr_ps</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_cb</span> <span class="o">*</span><span class="n">hcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">;</span>

	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">psbits</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[(</span><span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">)]);</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">va</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">psbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curadr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">rr_ps</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">psbits</span><span class="p">);</span>
		<span class="n">psbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">rr_ps</span><span class="p">);</span>
		<span class="n">num</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">ps</span> <span class="o">&lt;</span> <span class="n">rr_ps</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">ps</span> <span class="o">-</span> <span class="n">rr_ps</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">PSIZE</span><span class="p">(</span><span class="n">rr_ps</span><span class="p">);</span>
		<span class="n">vrr</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">rr_ps</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">vsa_thash</span><span class="p">(</span><span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">,</span> <span class="n">curadr</span><span class="p">,</span> <span class="n">vrr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">==</span> <span class="n">tag</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">==</span> <span class="n">rr_ps</span><span class="p">)</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
			<span class="n">curadr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">num</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  purge VHPT and machine TLB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vhpt_purge</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">start</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">rr</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">va</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PSIZE</span><span class="p">(</span><span class="n">rr</span><span class="p">.</span><span class="n">ps</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">ps</span> <span class="o">&lt;</span> <span class="n">rr</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">ps</span> <span class="o">-</span> <span class="n">rr</span><span class="p">.</span><span class="n">ps</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_thash</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
		<span class="n">tag</span> <span class="o">=</span> <span class="n">ia64_ttag</span><span class="p">(</span><span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">==</span> <span class="n">tag</span><span class="p">)</span>
			<span class="n">cur</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">num</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">machine_tlb_purge</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Insert an entry into hash TLB or VHPT.</span>
<span class="cm"> * NOTES:</span>
<span class="cm"> *  1: When inserting VHPT to thash, &quot;va&quot; is a must covered</span>
<span class="cm"> *  address by the inserted machine VHPT entry.</span>
<span class="cm"> *  2: The format of entry is always in TLB.</span>
<span class="cm"> *  3: The caller need to make sure the new entry will not overlap</span>
<span class="cm"> *     with any existed entry.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">vtlb_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_cb</span> <span class="o">*</span><span class="n">hcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">;</span>

	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">])</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">vrr</span><span class="p">.</span><span class="n">ps</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">vsa_thash</span><span class="p">(</span><span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vrr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">=</span> <span class="n">pte</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">itir</span> <span class="o">=</span> <span class="n">itir</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vtr_find_overlap</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span>  <span class="o">*</span><span class="n">trp</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">end</span><span class="p">,</span> <span class="n">rid</span><span class="p">;</span>

	<span class="n">rid</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span> <span class="o">&amp;</span> <span class="n">RR_RID_MASK</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">va</span> <span class="o">+</span> <span class="n">PSIZE</span><span class="p">(</span><span class="n">ps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">D_TLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtr_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtrs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">&lt;</span> <span class="n">NDTRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">trp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__is_tr_overlap</span><span class="p">(</span><span class="n">trp</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itr_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">trp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itrs</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">&lt;</span> <span class="n">NITRS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">trp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">__is_tr_overlap</span><span class="p">(</span><span class="n">trp</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Purge entries in VTLB and VHPT</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">thash_purge_entries</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tc_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">))</span>
		<span class="n">vtlb_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">vhpt_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">thash_purge_entries_remote</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">old_va</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">REGION_OFFSET</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tc_regions</span><span class="p">,</span> <span class="n">old_va</span><span class="p">))</span>
		<span class="n">vtlb_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">vhpt_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">translate_phy_pte</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ps</span><span class="p">,</span> <span class="n">ps_mask</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">maddr</span><span class="p">,</span> <span class="n">io_mask</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">pte_flags</span> <span class="n">phy_pte</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">ps_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">phy_pte</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="o">*</span><span class="n">pte</span><span class="p">;</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ps_mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">va</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ps_mask</span><span class="p">);</span>
	<span class="n">maddr</span> <span class="o">=</span> <span class="n">kvm_get_mpt_entry</span><span class="p">(</span><span class="n">paddr</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="n">io_mask</span> <span class="o">=</span> <span class="n">maddr</span> <span class="o">&amp;</span> <span class="n">GPFN_IO_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io_mask</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">io_mask</span> <span class="o">!=</span> <span class="n">GPFN_PHYS_MMIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pte</span> <span class="o">|=</span> <span class="n">VTLB_PTE_IO</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">maddr</span> <span class="o">=</span> <span class="p">((</span><span class="n">maddr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
	<span class="n">phy_pte</span><span class="p">.</span><span class="n">ppn</span> <span class="o">=</span> <span class="n">maddr</span> <span class="o">&gt;&gt;</span> <span class="n">ARCH_PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">phy_pte</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Purge overlap TCs and then insert the new entry to emulate itc ops.</span>
<span class="cm"> * Notes: Only TC entry can purge and insert.</span>
<span class="cm"> */</span>
<span class="kt">void</span>  <span class="nf">thash_purge_and_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span>
						<span class="n">u64</span> <span class="n">ifa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ps</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phy_pte</span><span class="p">,</span> <span class="n">io_mask</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">,</span> <span class="n">mrr</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
	<span class="n">mrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="n">ifa</span><span class="p">);</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">io_mask</span> <span class="o">=</span> <span class="n">kvm_get_mpt_entry</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GPFN_IO_MASK</span><span class="p">;</span>
	<span class="n">phy_pte</span> <span class="o">=</span> <span class="n">translate_phy_pte</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>

	<span class="cm">/* Ensure WB attribute if pte is related to a normal mem page,</span>
<span class="cm">	 * which is required by vga acceleration since qemu maps shared</span>
<span class="cm">	 * vram buffer with WB.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">VTLB_PTE_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">_PAGE_MA_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_PAGE_MA_NAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">io_mask</span> <span class="o">!=</span> <span class="n">GPFN_PHYS_MMIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_MA_MASK</span><span class="p">;</span>
		<span class="n">phy_pte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">_PAGE_MA_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vtlb_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">vhpt_purge</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ps</span> <span class="o">!=</span> <span class="n">mrr</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">VTLB_PTE_IO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vtlb_insert</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
		<span class="n">vcpu_quick_region_set</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">tc_regions</span><span class="p">),</span> <span class="n">ifa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">VTLB_PTE_IO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&gt;=</span> <span class="n">mrr</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span>
		<span class="n">vhpt_insert</span><span class="p">(</span><span class="n">phy_pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pte</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">psr</span><span class="p">;</span>
		<span class="n">phy_pte</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PAGE_FLAGS_RV_MASK</span><span class="p">;</span>
		<span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_clear_ic</span><span class="p">();</span>
		<span class="n">ia64_itc</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">phy_pte</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
		<span class="n">paravirt_dv_serialize_data</span><span class="p">();</span>
		<span class="n">ia64_set_psr</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pte</span><span class="o">&amp;</span><span class="n">VTLB_PTE_IO</span><span class="p">))</span>
		<span class="n">mark_pages_dirty</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Purge all TCs or VHPT entries including those in Hash table.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">thash_purge_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_cb</span>  <span class="o">*</span><span class="n">vtlb</span><span class="p">,</span> <span class="o">*</span><span class="n">vhpt</span><span class="p">;</span>
	<span class="n">vtlb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">;</span>
	<span class="n">vhpt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">vtlb</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vtlb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">itir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">++</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">vhpt</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vhpt</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">itir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">++</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">local_flush_tlb_all</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lookup the hash table and its collision chain to find an entry</span>
<span class="cm"> * covering this address rid:va or the entry.</span>
<span class="cm"> *</span>
<span class="cm"> * INPUT:</span>
<span class="cm"> *  in: TLB format for both VHPT &amp; TLB.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="nf">vtlb_lookup</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span>  <span class="o">*</span><span class="n">cch</span><span class="p">;</span>
	<span class="n">u64</span>    <span class="n">psbits</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">thash_cb</span> <span class="o">*</span><span class="n">hcb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">;</span>

	<span class="n">cch</span> <span class="o">=</span> <span class="n">__vtr_lookup</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">is_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cch</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">cch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_quick_region_check</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">tc_regions</span><span class="p">,</span> <span class="n">va</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">psbits</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[(</span><span class="n">va</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">)]);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">psbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ps</span> <span class="o">=</span> <span class="n">__ffs</span><span class="p">(</span><span class="n">psbits</span><span class="p">);</span>
		<span class="n">psbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ps</span><span class="p">);</span>
		<span class="n">vrr</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span>
		<span class="n">cch</span> <span class="o">=</span> <span class="n">vsa_thash</span><span class="p">(</span><span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">vrr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cch</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">==</span> <span class="n">tag</span> <span class="o">&amp;&amp;</span> <span class="n">cch</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">==</span> <span class="n">ps</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cch</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize internal control data before service.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">thash_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">thash_cb</span> <span class="o">*</span><span class="n">hcb</span><span class="p">,</span> <span class="n">u64</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>

	<span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcb</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
	<span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">.</span><span class="n">vf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">.</span><span class="n">ve</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hcb</span><span class="o">-&gt;</span><span class="n">pta</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">hcb</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hcb</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">itir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">etag</span> <span class="o">=</span> <span class="n">INVALID_TI_TAG</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">head</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">kvm_get_mpt_entry</span><span class="p">(</span><span class="n">u64</span> <span class="n">gpfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">KVM_P2M_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpfn</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">KVM_P2M_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">current_vcpu</span><span class="p">,</span> <span class="s">&quot;Invalid gpfn =%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpfn</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">gpfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">kvm_lookup_mpa</span><span class="p">(</span><span class="n">u64</span> <span class="n">gpfn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">maddr</span><span class="p">;</span>
	<span class="n">maddr</span> <span class="o">=</span> <span class="n">kvm_get_mpt_entry</span><span class="p">(</span><span class="n">gpfn</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">maddr</span><span class="o">&amp;</span><span class="n">_PAGE_PPN_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">kvm_gpa_to_mpa</span><span class="p">(</span><span class="n">u64</span> <span class="n">gpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">pte</span> <span class="o">=</span> <span class="n">kvm_lookup_mpa</span><span class="p">(</span><span class="n">gpa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">gpa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch guest bundle code.</span>
<span class="cm"> * INPUT:</span>
<span class="cm"> *  gip: guest ip</span>
<span class="cm"> *  pbundle: used to return fetched bundle.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fetch_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">gip</span><span class="p">,</span> <span class="n">IA64_BUNDLE</span> <span class="o">*</span><span class="n">pbundle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span>     <span class="n">gpip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* guest physical IP*/</span>
	<span class="n">u64</span>     <span class="o">*</span><span class="n">vpa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span>    <span class="o">*</span><span class="n">tlb</span><span class="p">;</span>
	<span class="n">u64</span>     <span class="n">maddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* I-side physical mode */</span>
		<span class="n">gpip</span> <span class="o">=</span> <span class="n">gip</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tlb</span> <span class="o">=</span> <span class="n">vtlb_lookup</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gip</span><span class="p">,</span> <span class="n">I_TLB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlb</span><span class="p">)</span>
			<span class="n">gpip</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ppn</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">gip</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSIZE</span><span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maddr</span> <span class="o">=</span> <span class="n">kvm_gpa_to_mpa</span><span class="p">(</span><span class="n">gpip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tlb</span> <span class="o">=</span> <span class="n">vhpt_lookup</span><span class="p">(</span><span class="n">gip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tlb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ia64_ptcl</span><span class="p">(</span><span class="n">gip</span><span class="p">,</span> <span class="n">ARCH_PAGE_SHIFT</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">maddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ppn</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span>
					<span class="o">|</span> <span class="p">(</span><span class="n">gip</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSIZE</span><span class="p">(</span><span class="n">tlb</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">vpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">__kvm_va</span><span class="p">(</span><span class="n">maddr</span><span class="p">);</span>

	<span class="n">pbundle</span><span class="o">-&gt;</span><span class="n">i64</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">vpa</span><span class="o">++</span><span class="p">;</span>
	<span class="n">pbundle</span><span class="o">-&gt;</span><span class="n">i64</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">vpa</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IA64_NO_FAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_init_vhpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">VHPT_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">thash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">,</span> <span class="n">VHPT_SHIFT</span><span class="p">);</span>
	<span class="n">ia64_set_pta</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">.</span><span class="n">pta</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
	<span class="cm">/*Enable VHPT here?*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_init_vtlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">VTLB_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">thash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">,</span> <span class="n">VTLB_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
