<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kvm › process.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>process.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * process.c: handle interruption inject for guests.</span>
<span class="cm"> * Copyright (c) 2005, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  	Shaofan Li (Susue Li) &lt;susie.li@intel.com&gt;</span>
<span class="cm"> *  	Xiaoyan Feng (Fleming Feng)  &lt;fleming.feng@intel.com&gt;</span>
<span class="cm"> *  	Xuefei Xu (Anthony Xu) (Anthony.xu@intel.com)</span>
<span class="cm"> *  	Xiantao Zhang (xiantao.zhang@intel.com)</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;vcpu.h&quot;</span>

<span class="cp">#include &lt;asm/pal.h&gt;</span>
<span class="cp">#include &lt;asm/sal.h&gt;</span>
<span class="cp">#include &lt;asm/fpswa.h&gt;</span>
<span class="cp">#include &lt;asm/kregs.h&gt;</span>
<span class="cp">#include &lt;asm/tlb.h&gt;</span>

<span class="n">fpswa_interface_t</span> <span class="o">*</span><span class="n">vmm_fpswa_interface</span><span class="p">;</span>

<span class="cp">#define IA64_VHPT_TRANS_VECTOR			0x0000</span>
<span class="cp">#define IA64_INST_TLB_VECTOR			0x0400</span>
<span class="cp">#define IA64_DATA_TLB_VECTOR			0x0800</span>
<span class="cp">#define IA64_ALT_INST_TLB_VECTOR		0x0c00</span>
<span class="cp">#define IA64_ALT_DATA_TLB_VECTOR		0x1000</span>
<span class="cp">#define IA64_DATA_NESTED_TLB_VECTOR		0x1400</span>
<span class="cp">#define IA64_INST_KEY_MISS_VECTOR		0x1800</span>
<span class="cp">#define IA64_DATA_KEY_MISS_VECTOR		0x1c00</span>
<span class="cp">#define IA64_DIRTY_BIT_VECTOR			0x2000</span>
<span class="cp">#define IA64_INST_ACCESS_BIT_VECTOR		0x2400</span>
<span class="cp">#define IA64_DATA_ACCESS_BIT_VECTOR		0x2800</span>
<span class="cp">#define IA64_BREAK_VECTOR			0x2c00</span>
<span class="cp">#define IA64_EXTINT_VECTOR			0x3000</span>
<span class="cp">#define IA64_PAGE_NOT_PRESENT_VECTOR		0x5000</span>
<span class="cp">#define IA64_KEY_PERMISSION_VECTOR		0x5100</span>
<span class="cp">#define IA64_INST_ACCESS_RIGHTS_VECTOR		0x5200</span>
<span class="cp">#define IA64_DATA_ACCESS_RIGHTS_VECTOR		0x5300</span>
<span class="cp">#define IA64_GENEX_VECTOR			0x5400</span>
<span class="cp">#define IA64_DISABLED_FPREG_VECTOR		0x5500</span>
<span class="cp">#define IA64_NAT_CONSUMPTION_VECTOR		0x5600</span>
<span class="cp">#define IA64_SPECULATION_VECTOR		0x5700 </span><span class="cm">/* UNUSED */</span><span class="cp"></span>
<span class="cp">#define IA64_DEBUG_VECTOR			0x5900</span>
<span class="cp">#define IA64_UNALIGNED_REF_VECTOR		0x5a00</span>
<span class="cp">#define IA64_UNSUPPORTED_DATA_REF_VECTOR	0x5b00</span>
<span class="cp">#define IA64_FP_FAULT_VECTOR			0x5c00</span>
<span class="cp">#define IA64_FP_TRAP_VECTOR			0x5d00</span>
<span class="cp">#define IA64_LOWERPRIV_TRANSFER_TRAP_VECTOR 	0x5e00</span>
<span class="cp">#define IA64_TAKEN_BRANCH_TRAP_VECTOR		0x5f00</span>
<span class="cp">#define IA64_SINGLE_STEP_TRAP_VECTOR		0x6000</span>

<span class="cm">/* SDM vol2 5.5 - IVA based interruption handling */</span>
<span class="cp">#define INITIAL_PSR_VALUE_AT_INTERRUPTION (IA64_PSR_UP | IA64_PSR_MFL |\</span>
<span class="cp">			IA64_PSR_MFH | IA64_PSR_PK | IA64_PSR_DT |    	\</span>
<span class="cp">			IA64_PSR_RT | IA64_PSR_MC|IA64_PSR_IT)</span>

<span class="cp">#define DOMN_PAL_REQUEST    0x110000</span>
<span class="cp">#define DOMN_SAL_REQUEST    0x110001</span>

<span class="k">static</span> <span class="n">u64</span> <span class="n">vec2off</span><span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="mh">0xc00</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="mh">0x1400</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">,</span>
	<span class="mh">0x1c00</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mh">0x2400</span><span class="p">,</span> <span class="mh">0x2800</span><span class="p">,</span> <span class="mh">0x2c00</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x3400</span><span class="p">,</span> <span class="mh">0x3800</span><span class="p">,</span> <span class="mh">0x3c00</span><span class="p">,</span>
	<span class="mh">0x4000</span><span class="p">,</span> <span class="mh">0x4400</span><span class="p">,</span> <span class="mh">0x4800</span><span class="p">,</span> <span class="mh">0x4c00</span><span class="p">,</span> <span class="mh">0x5000</span><span class="p">,</span> <span class="mh">0x5100</span><span class="p">,</span> <span class="mh">0x5200</span><span class="p">,</span> <span class="mh">0x5300</span><span class="p">,</span> <span class="mh">0x5400</span><span class="p">,</span>
	<span class="mh">0x5500</span><span class="p">,</span> <span class="mh">0x5600</span><span class="p">,</span> <span class="mh">0x5700</span><span class="p">,</span> <span class="mh">0x5800</span><span class="p">,</span> <span class="mh">0x5900</span><span class="p">,</span> <span class="mh">0x5a00</span><span class="p">,</span> <span class="mh">0x5b00</span><span class="p">,</span> <span class="mh">0x5c00</span><span class="p">,</span> <span class="mh">0x5d00</span><span class="p">,</span>
	<span class="mh">0x5e00</span><span class="p">,</span> <span class="mh">0x5f00</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">,</span> <span class="mh">0x6100</span><span class="p">,</span> <span class="mh">0x6200</span><span class="p">,</span> <span class="mh">0x6300</span><span class="p">,</span> <span class="mh">0x6400</span><span class="p">,</span> <span class="mh">0x6500</span><span class="p">,</span> <span class="mh">0x6600</span><span class="p">,</span>
	<span class="mh">0x6700</span><span class="p">,</span> <span class="mh">0x6800</span><span class="p">,</span> <span class="mh">0x6900</span><span class="p">,</span> <span class="mh">0x6a00</span><span class="p">,</span> <span class="mh">0x6b00</span><span class="p">,</span> <span class="mh">0x6c00</span><span class="p">,</span> <span class="mh">0x6d00</span><span class="p">,</span> <span class="mh">0x6e00</span><span class="p">,</span> <span class="mh">0x6f00</span><span class="p">,</span>
	<span class="mh">0x7000</span><span class="p">,</span> <span class="mh">0x7100</span><span class="p">,</span> <span class="mh">0x7200</span><span class="p">,</span> <span class="mh">0x7300</span><span class="p">,</span> <span class="mh">0x7400</span><span class="p">,</span> <span class="mh">0x7500</span><span class="p">,</span> <span class="mh">0x7600</span><span class="p">,</span> <span class="mh">0x7700</span><span class="p">,</span> <span class="mh">0x7800</span><span class="p">,</span>
	<span class="mh">0x7900</span><span class="p">,</span> <span class="mh">0x7a00</span><span class="p">,</span> <span class="mh">0x7b00</span><span class="p">,</span> <span class="mh">0x7c00</span><span class="p">,</span> <span class="mh">0x7d00</span><span class="p">,</span> <span class="mh">0x7e00</span><span class="p">,</span> <span class="mh">0x7f00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">collect_interruption</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ipsr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vdcr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vifs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpsr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">vcpu_get_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu_bsw0</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Sync mpsr id/da/dd/ss/ed bits to vipsr</span>
<span class="cm">		 * since after guest do rfi, we still want these bits on in</span>
<span class="cm">		 * mpsr</span>
<span class="cm">		 */</span>

		<span class="n">ipsr</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">;</span>
		<span class="n">vpsr</span> <span class="o">=</span> <span class="n">vpsr</span> <span class="o">|</span> <span class="p">(</span><span class="n">ipsr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IA64_PSR_ID</span> <span class="o">|</span> <span class="n">IA64_PSR_DA</span>
					<span class="o">|</span> <span class="n">IA64_PSR_DD</span> <span class="o">|</span> <span class="n">IA64_PSR_SS</span>
					<span class="o">|</span> <span class="n">IA64_PSR_ED</span><span class="p">));</span>
		<span class="n">vcpu_set_ipsr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

		<span class="cm">/* Currently, for trap, we do not advance IIP to next</span>
<span class="cm">		 * instruction. That&#39;s because we assume caller already</span>
<span class="cm">		 * set up IIP correctly</span>
<span class="cm">		 */</span>

		<span class="n">vcpu_set_iip</span><span class="p">(</span><span class="n">vcpu</span> <span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">);</span>

		<span class="cm">/* set vifs.v to zero */</span>
		<span class="n">vifs</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifs</span><span class="p">);</span>
		<span class="n">vifs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IA64_IFS_V</span><span class="p">;</span>
		<span class="n">vcpu_set_ifs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vifs</span><span class="p">);</span>

		<span class="n">vcpu_set_iipa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr_iipa</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">vdcr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dcr</span><span class="p">);</span>

	<span class="cm">/* Set guest psr</span>
<span class="cm">	 * up/mfl/mfh/pk/dt/rt/mc/it keeps unchanged</span>
<span class="cm">	 * be: set to the value of dcr.be</span>
<span class="cm">	 * pp: set to the value of dcr.pp</span>
<span class="cm">	 */</span>
	<span class="n">vpsr</span> <span class="o">&amp;=</span> <span class="n">INITIAL_PSR_VALUE_AT_INTERRUPTION</span><span class="p">;</span>
	<span class="n">vpsr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vdcr</span> <span class="o">&amp;</span> <span class="n">IA64_DCR_BE</span><span class="p">);</span>

	<span class="cm">/* VDCR pp bit position is different from VPSR pp bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdcr</span> <span class="o">&amp;</span> <span class="n">IA64_DCR_PP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpsr</span> <span class="o">|=</span> <span class="n">IA64_PSR_PP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vpsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IA64_PSR_PP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcpu_set_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">inject_guest_interruption</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">viva</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_isr</span> <span class="n">pt_isr</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="cm">/* clear cr.isr.ir (incomplete register frame)*/</span>
	<span class="n">pt_isr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr_isr</span><span class="p">);</span>
	<span class="n">pt_isr</span><span class="p">.</span><span class="n">ir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr_isr</span><span class="p">)</span> <span class="o">=</span> <span class="n">pt_isr</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="n">collect_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">viva</span> <span class="o">=</span> <span class="n">vcpu_get_iva</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">=</span> <span class="n">viva</span> <span class="o">+</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">vcpu_get_itir_on_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">rr</span><span class="p">,</span> <span class="n">rr1</span><span class="p">;</span>

	<span class="n">rr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
	<span class="n">rr1</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rr1</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">rr</span><span class="p">.</span><span class="n">ps</span><span class="p">;</span>
	<span class="n">rr1</span><span class="p">.</span><span class="n">rid</span> <span class="o">=</span> <span class="n">rr</span><span class="p">.</span><span class="n">rid</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rr1</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set vIFA &amp; vITIR &amp; vIHA, when vPSR.ic =1</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *  set_ifa: if true, set vIFA</span>
<span class="cm"> *  set_itir: if true, set vITIR</span>
<span class="cm"> *  set_iha: if true, set vIHA</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">set_ifa_itir_iha</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">set_ifa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set_itir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set_iha</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">vpsr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="cm">/* Vol2, Table 8-1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_ifa</span><span class="p">)</span>
			<span class="n">vcpu_set_ifa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_itir</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">vcpu_get_itir_on_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="n">vcpu_set_itir</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set_iha</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">vcpu_thash</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="n">vcpu_set_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data TLB Fault</span>
<span class="cm"> *  @ Data TLB vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dtlb_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic, IFA, ITIR, IHA */</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_DATA_TLB_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Instruction TLB Fault</span>
<span class="cm"> *  @ Instruction TLB vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">itlb_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic, IFA, ITIR, IHA */</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_INST_TLB_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data Nested TLB Fault</span>
<span class="cm"> *  @ Data Nested TLB Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">nested_dtlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_DATA_NESTED_TLB_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Alternate Data TLB Fault</span>
<span class="cm"> *  @ Alternate Data TLB vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">alt_dtlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_ALT_DATA_TLB_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data TLB Fault</span>
<span class="cm"> *  @ Data TLB vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">alt_itlb</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_ALT_INST_TLB_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with:</span>
<span class="cm"> *  VHPT Translation Vector</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_vhpt_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic, IFA, ITIR, IHA*/</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_VHPT_TRANS_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VHPT Instruction Fault</span>
<span class="cm"> *  @ VHPT Translation vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ivhpt_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_vhpt_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * VHPT Data Fault</span>
<span class="cm"> *  @ VHPT Translation vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dvhpt_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_vhpt_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deal with:</span>
<span class="cm"> *  General Exception vector</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">_general_exception</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_GENEX_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Illegal Operation Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">illegal_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Illegal Dependency Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">illegal_dep</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reserved Register/Field Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rsv_reg_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Privileged Operation Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">privilege_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unimplement Data Address Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">unimpl_daddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Privileged Register Fault</span>
<span class="cm"> *  @ General Exception Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">privilege_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_general_exception</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with</span>
<span class="cm"> *  Nat consumption vector</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *  vaddr: Optional, if t == REGISTER</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_nat_consumption_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">tlb_miss_type</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic &amp;&amp; t == DATA/INST, IFA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">DATA</span> <span class="o">||</span> <span class="n">t</span> <span class="o">==</span> <span class="n">INSTRUCTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IFA */</span>
		<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_NAT_CONSUMPTION_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Instruction Nat Page Consumption Fault</span>
<span class="cm"> *  @ Nat Consumption Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">inat_page_consumption</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_nat_consumption_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">INSTRUCTION</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register Nat Consumption Fault</span>
<span class="cm"> *  @ Nat Consumption Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rnat_consumption</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_nat_consumption_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REGISTER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Data Nat Page Consumption Fault</span>
<span class="cm"> *  @ Nat Consumption Vector</span>
<span class="cm"> * Refer to SDM Vol2 Table 5-6 &amp; 8-1</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dnat_page_consumption</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_nat_consumption_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with</span>
<span class="cm"> *  Page not present vector</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__page_not_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic, IFA, ITIR */</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_PAGE_NOT_PRESENT_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">data_page_not_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__page_not_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">inst_page_not_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__page_not_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Deal with</span>
<span class="cm"> *  Data access rights vector</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">data_access_rights</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If vPSR.ic, IFA, ITIR */</span>
	<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">IA64_DATA_ACCESS_RIGHTS_VECTOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">fpswa_ret_t</span> <span class="nf">vmm_fp_emulate</span><span class="p">(</span><span class="kt">int</span> <span class="n">fp_fault</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bundle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ipsr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fpsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">isr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ifs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fp_state_t</span> <span class="n">fp_state</span><span class="p">;</span>
	<span class="n">fpswa_ret_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>

	<span class="kt">uint64_t</span> <span class="n">old_rr7</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="mi">7UL</span><span class="o">&lt;&lt;</span><span class="mi">61</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmm_fpswa_interface</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">fpswa_ret_t</span><span class="p">)</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp_state_t</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * compute fp_state.  only FP registers f6 - f11 are used by the</span>
<span class="cm">	 * vmm, so set those bits in the mask and set the low volatile</span>
<span class="cm">	 * pointer to point to these registers.</span>
<span class="cm">	 */</span>
	<span class="n">fp_state</span><span class="p">.</span><span class="n">bitmask_low64</span> <span class="o">=</span> <span class="mh">0xfc0</span><span class="p">;</span>  <span class="cm">/* bit6..bit11 */</span>

	<span class="n">fp_state</span><span class="p">.</span><span class="n">fp_state_low_volatile</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp_state_low_volatile_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">;</span>

   <span class="cm">/*</span>
<span class="cm">	 * unsigned long (*EFI_FPSWA) (</span>
<span class="cm">	 *      unsigned long    trap_type,</span>
<span class="cm">	 *      void             *Bundle,</span>
<span class="cm">	 *      unsigned long    *pipsr,</span>
<span class="cm">	 *      unsigned long    *pfsr,</span>
<span class="cm">	 *      unsigned long    *pisr,</span>
<span class="cm">	 *      unsigned long    *ppreds,</span>
<span class="cm">	 *      unsigned long    *pifs,</span>
<span class="cm">	 *      void             *fp_state);</span>
<span class="cm">	 */</span>
	<span class="cm">/*Call host fpswa interface directly to virtualize</span>
<span class="cm">	 *guest fpswa request!</span>
<span class="cm">	 */</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="mi">7UL</span> <span class="o">&lt;&lt;</span> <span class="mi">61</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">host</span><span class="p">.</span><span class="n">rr</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">vmm_fpswa_interface</span><span class="o">-&gt;</span><span class="n">fpswa</span><span class="p">)</span> <span class="p">(</span><span class="n">fp_fault</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span>
			<span class="n">ipsr</span><span class="p">,</span> <span class="n">fpsr</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">ifs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_state</span><span class="p">);</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="mi">7UL</span> <span class="o">&lt;&lt;</span> <span class="mi">61</span><span class="p">,</span> <span class="n">old_rr7</span><span class="p">);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle floating-point assist faults and traps for domain.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vmm_handle_fpu_swa</span><span class="p">(</span><span class="kt">int</span> <span class="n">fp_fault</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>
	<span class="n">IA64_BUNDLE</span> <span class="n">bundle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fault_ip</span><span class="p">;</span>
	<span class="n">fpswa_ret_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fault_ip</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * When the FP trap occurs, the trapping instruction is completed.</span>
<span class="cm">	 * If ipsr.ri == 0, there is the trapping instruction in previous</span>
<span class="cm">	 * bundle.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp_fault</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">fault_ip</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fetch_code</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">fault_ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bundle</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bundle</span><span class="p">.</span><span class="n">i64</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bundle</span><span class="p">.</span><span class="n">i64</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vmm_fp_emulate</span><span class="p">(</span><span class="n">fp_fault</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bundle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reflect_interruption</span><span class="p">(</span><span class="n">u64</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">u64</span> <span class="n">isr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">iim</span><span class="p">,</span>
		<span class="n">u64</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">vector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

	<span class="n">vector</span> <span class="o">=</span> <span class="n">vec2off</span><span class="p">[</span><span class="n">vec</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vector</span> <span class="o">!=</span> <span class="n">IA64_DATA_NESTED_TLB_VECTOR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Interruption with vector :0x%lx occurs &quot;</span>
						<span class="s">&quot;with psr.ic = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>: 	<span class="cm">/*IA64_FP_FAULT_VECTOR*/</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vmm_handle_fpu_swa</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_increment_iip</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:	<span class="cm">/*IA64_FP_TRAP_VECTOR*/</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">vmm_handle_fpu_swa</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">isr</span><span class="p">)</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">iipa</span><span class="p">)</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="n">IA64_BREAK_VECTOR</span> <span class="o">||</span> <span class="n">vector</span> <span class="o">==</span> <span class="n">IA64_SPECULATION_VECTOR</span><span class="p">)</span>
		<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">iim</span><span class="p">)</span> <span class="o">=</span> <span class="n">iim</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">set_ifa_itir_iha</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">inject_guest_interruption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvm_trans_pal_call_args</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpa</span><span class="p">,</span> <span class="n">poff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Depends on caller to provide the DTR or DTC mapping.*/</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">vtlb_lookup</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="n">gpa</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">vhpt_lookup</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">gpa</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">gpaddr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">poff</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">gpa</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">|</span> <span class="n">poff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">arg</span> <span class="o">=</span> <span class="n">kvm_gpa_to_mpa</span><span class="p">(</span><span class="n">arg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pal_call_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gr28</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gr29</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gr30</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="cm">/*FIXME:For static and stacked convention, firmware</span>
<span class="cm">	 * has put the parameters in gr28-gr31 before</span>
<span class="cm">	 * break to vmm  !!*/</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">gr28</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PAL_PERF_MON_INFO</span>:
	<span class="k">case</span> <span class="n">PAL_HALT_INFO</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr29</span> <span class="o">=</span>  <span class="n">kvm_trans_pal_call_args</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gr29</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr30</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PAL_BRAND_INFO</span>:
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr29</span> <span class="o">=</span> <span class="n">gr29</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr30</span> <span class="o">=</span> <span class="n">kvm_trans_pal_call_args</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">gr30</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr29</span> <span class="o">=</span> <span class="n">gr29</span><span class="p">;</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr30</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr28</span> <span class="o">=</span> <span class="n">gr28</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">gr31</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_PAL_CALL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_pal_call_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">==</span> <span class="n">EXIT_REASON_PAL_CALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">v0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">pal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">v2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Mis-set for exit reason!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_sal_call_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in0</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in1</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">33</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">34</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">35</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in4</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in5</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">37</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in6</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">38</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">in7</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">39</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_SAL_CALL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_sal_call_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">==</span> <span class="n">EXIT_REASON_SAL_CALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">r8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">r9</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">r10</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sal_data</span><span class="p">.</span><span class="n">ret</span><span class="p">.</span><span class="n">r11</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Mis-set for exit reason!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>  <span class="nf">kvm_ia64_handle_break</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cpl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allow hypercalls only when cpl = 0.  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iim</span> <span class="o">==</span> <span class="n">DOMN_PAL_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
			<span class="n">set_pal_call_data</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">vmm_transition</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">get_pal_call_result</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">vcpu_increment_iip</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iim</span> <span class="o">==</span> <span class="n">DOMN_SAL_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
			<span class="n">set_sal_call_data</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">vmm_transition</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">get_sal_call_result</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">vcpu_increment_iip</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">reflect_interruption</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">iim</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">check_pending_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">mask</span><span class="p">,</span> <span class="n">h_pending</span><span class="p">,</span> <span class="n">h_inservice</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">isr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">vpsr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">h_pending</span> <span class="o">=</span> <span class="n">highest_pending_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_pending</span> <span class="o">==</span> <span class="n">NULL_VECTOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">NULL_VECTOR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h_inservice</span> <span class="o">=</span> <span class="n">highest_inservice_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">irq_masked</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">h_pending</span><span class="p">,</span> <span class="n">h_inservice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_I</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IRQ_NO_MASKED</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr</span> <span class="o">=</span> <span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_RI</span><span class="p">;</span>
		<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">h_pending</span><span class="p">);</span>
		<span class="n">reflect_interruption</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span> <span class="cm">/* EXT IRQ */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">IRQ_MASKED_BY_INSVC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vhpi</span><span class="p">))</span>
			<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">NULL_VECTOR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* masked by vpsr.i or vtpr.*/</span>
		<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">h_pending</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generate_exirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>  <span class="n">vpsr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">isr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">isr</span> <span class="o">=</span> <span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">))</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Trying to inject one IRQ with psr.ic=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">reflect_interruption</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span> <span class="cm">/* EXT IRQ */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vhpi_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint64_t</span>    <span class="n">threshold</span><span class="p">,</span> <span class="n">vhpi</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_tpr</span>       <span class="n">vtpr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">vpsr</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">vtpr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tpr</span><span class="p">);</span>

	<span class="n">threshold</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="n">vpsr</span><span class="p">.</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vtpr</span><span class="p">.</span><span class="n">mmi</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">vtpr</span><span class="p">.</span><span class="n">mic</span><span class="p">;</span>
	<span class="n">vhpi</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vhpi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vhpi</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* interrupt actived*/</span>
		<span class="n">generate_exirq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">leave_hypervisor_tail</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">timer_check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">timer_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_get_itc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itm</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">vcpu_pend_interrupt</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itv</span><span class="p">)</span>
							<span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
					<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">timer_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">)</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itm</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_new_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_new_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">irq_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">check_pending_irq</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">irq_check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">irq_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vhpi_detection</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">handle_lds</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">|=</span> <span class="n">IA64_PSR_ED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">physical_tlb_miss</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vadr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pte</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">rr</span><span class="p">;</span>

	<span class="n">rr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="n">vadr</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span>  <span class="n">vadr</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">;</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">pte</span> <span class="o">|</span> <span class="n">PHY_PAGE_WB</span><span class="p">;</span>
	<span class="n">thash_vhpt_insert</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">rr</span><span class="p">.</span><span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_page_fault</span><span class="p">(</span><span class="n">u64</span> <span class="n">vadr</span> <span class="p">,</span> <span class="n">u64</span> <span class="n">vec</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">u64</span> <span class="n">vhpt_adr</span><span class="p">,</span> <span class="n">gppa</span><span class="p">,</span> <span class="n">pteval</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_isr</span> <span class="n">misr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_pta</span> <span class="n">vpta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">misr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">cr_isr</span><span class="p">);</span>

	<span class="n">type</span> <span class="o">=</span> <span class="n">vec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vadr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="mi">62</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__gpfn_is_io</span><span class="p">((</span><span class="n">vadr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">emulate_io_inst</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">((</span><span class="n">vadr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">physical_tlb_miss</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">vtlb_lookup</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">D_TLB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gppa</span> <span class="o">=</span> <span class="p">(</span><span class="n">vadr</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ppn</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__gpfn_is_io</span><span class="p">(</span><span class="n">gppa</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pl</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">&gt;&gt;</span>
						<span class="n">IA64_PSR_CPL0_BIT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
					<span class="n">emulate_io_inst</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">gppa</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
					<span class="n">data_access_rights</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">thash_vhpt_insert</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">page_flags</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">itir</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">D_TLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">misr</span><span class="p">.</span><span class="n">sp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handle_lds</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rr</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
		<span class="n">itir</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RR_RID_MASK</span> <span class="o">|</span> <span class="n">RR_PS_MASK</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vhpt_enabled</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">rs</span> <span class="o">?</span> <span class="n">RSE_REF</span> <span class="o">:</span> <span class="n">DATA_REF</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
				<span class="n">alt_dtlb</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="cm">/* avoid recursively walking (short format) VHPT */</span>

		<span class="n">vhpt_adr</span> <span class="o">=</span> <span class="n">vcpu_thash</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">guest_vhpt_lookup</span><span class="p">(</span><span class="n">vhpt_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pteval</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* VHPT successfully read.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pteval</span> <span class="o">&amp;</span> <span class="n">_PAGE_P</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
					<span class="n">dtlb_fault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pteval</span> <span class="o">&amp;</span> <span class="n">_PAGE_MA_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_PAGE_MA_ST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">thash_purge_and_insert</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pteval</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span>
								<span class="n">vadr</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
				<span class="n">dtlb_fault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Can&#39;t read VHPT.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
				<span class="n">dvhpt_fault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">I_TLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_IC</span><span class="p">))</span>
			<span class="n">misr</span><span class="p">.</span><span class="n">ni</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vhpt_enabled</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">INST_REF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">alt_itlb</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

		<span class="n">vhpt_adr</span> <span class="o">=</span> <span class="n">vcpu_thash</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">guest_vhpt_lookup</span><span class="p">(</span><span class="n">vhpt_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pteval</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* VHPT successfully read.  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pteval</span> <span class="o">&amp;</span> <span class="n">_PAGE_P</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pteval</span> <span class="o">&amp;</span> <span class="n">_PAGE_MA_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">_PAGE_MA_ST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
					<span class="n">itlb_fault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
					<span class="k">return</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rr</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
				<span class="n">itir</span> <span class="o">=</span> <span class="n">rr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RR_RID_MASK</span> <span class="o">|</span> <span class="n">RR_PS_MASK</span><span class="p">);</span>
				<span class="n">thash_purge_and_insert</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pteval</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span>
							<span class="n">vadr</span><span class="p">,</span> <span class="n">I_TLB</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
				<span class="n">inst_page_not_present</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">misr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">ivhpt_fault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_vexirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">vpsr</span><span class="p">,</span> <span class="n">isr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">isr</span> <span class="o">=</span> <span class="n">vpsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_RI</span><span class="p">;</span>
	<span class="n">reflect_interruption</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span> <span class="cm">/*EXT IRQ*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ia64_handle_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_EXTERNAL_INTERRUPT</span><span class="p">;</span>
	<span class="n">vmm_transition</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>

	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">timer_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptc_ga_remote_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">oldrid</span><span class="p">,</span> <span class="n">moldrid</span><span class="p">,</span> <span class="n">oldpsbits</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_ptc_g</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptc_g_data</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="n">oldrid</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rr</span><span class="p">;</span>
	<span class="n">oldpsbits</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="n">REGION_NUMBER</span><span class="p">(</span><span class="n">vaddr</span><span class="p">)]);</span>
	<span class="n">moldrid</span> <span class="o">=</span> <span class="n">ia64_get_rr</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rr</span><span class="p">));</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">);</span>
	<span class="n">thash_purge_entries_remote</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vaddr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">);</span>

	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">oldrid</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">psbits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="n">oldpsbits</span><span class="p">;</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">moldrid</span><span class="p">);</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcpu_do_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*Re-init VHPT and VTLB once from resume*/</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">VHPT_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">thash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">,</span> <span class="n">VHPT_SHIFT</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">VTLB_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">thash_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vtlb</span><span class="p">,</span> <span class="n">VTLB_SHIFT</span><span class="p">);</span>

	<span class="n">ia64_set_pta</span><span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vhpt</span><span class="p">.</span><span class="n">pta</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vmm_sanity_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmm_sanity</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">!=</span> <span class="n">EXIT_REASON_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Failed to do vmm sanity check,&quot;</span>
			<span class="s">&quot;it maybe caused by crashed vmm!!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_do_resume_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vmm_sanity_check</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span> <span class="cm">/*Guarantee vcpu running on healthy vmm!*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">KVM_REQ_RESUME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vcpu_do_resume</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">KVM_REQ_TLB_FLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">thash_purge_all</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">KVM_REQ_PTC_G</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">requests</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptc_g_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ptc_ga_remote_func</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="o">--</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">ptc_g_count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vmm_transition</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_SAVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vpd</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vmm_trampoline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">guest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_RESTORE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vpd</span><span class="p">,</span>
						<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kvm_do_resume_op</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vmm_panic_handler</span><span class="p">(</span><span class="n">u64</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>
	<span class="n">vmm_sanity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Unexpected interruption occurs in VMM, vector:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vec2off</span><span class="p">[</span><span class="n">vec</span><span class="p">]);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
