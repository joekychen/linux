<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kvm › vcpu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vcpu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * kvm_vcpu.c: handling all virtual cpu related thing.</span>
<span class="cm"> * Copyright (c) 2005, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Shaofan Li (Susue Li) &lt;susie.li@intel.com&gt;</span>
<span class="cm"> *  Yaozu Dong (Eddie Dong) (Eddie.dong@intel.com)</span>
<span class="cm"> *  Xuefei Xu (Anthony Xu) (Anthony.xu@intel.com)</span>
<span class="cm"> *  Xiantao Zhang &lt;xiantao.zhang@intel.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kvm_host.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/ia64regs.h&gt;</span>
<span class="cp">#include &lt;asm/gcc_intrin.h&gt;</span>
<span class="cp">#include &lt;asm/kregs.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/tlb.h&gt;</span>

<span class="cp">#include &quot;asm-offsets.h&quot;</span>
<span class="cp">#include &quot;vcpu.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Special notes:</span>
<span class="cm"> * - Index by it/dt/rt sequence</span>
<span class="cm"> * - Only existing mode transitions are allowed in this table</span>
<span class="cm"> * - RSE is placed at lazy mode when emulating guest partial mode</span>
<span class="cm"> * - If gva happens to be rr0 and rr4, only allowed case is identity</span>
<span class="cm"> *   mapping (gva=gpa), or panic! (How?)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">mm_switch_table</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*  2004/09/12(Kevin): Allow switch to self */</span>
	<span class="cm">/*</span>
<span class="cm">	 *  (it,dt,rt): (0,0,0) -&gt; (1,1,1)</span>
<span class="cm">	 *  This kind of transition usually occurs in the very early</span>
<span class="cm">	 *  stage of Linux boot up procedure. Another case is in efi</span>
<span class="cm">	 *  and pal calls. (see &quot;arch/ia64/kernel/head.S&quot;)</span>
<span class="cm">	 *</span>
<span class="cm">	 *  (it,dt,rt): (0,0,0) -&gt; (0,1,1)</span>
<span class="cm">	 *  This kind of transition is found when OSYa exits efi boot</span>
<span class="cm">	 *  service. Due to gva = gpa in this case (Same region),</span>
<span class="cm">	 *  data access can be satisfied though itlb entry for physical</span>
<span class="cm">	 *  emulation is hit.</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="n">SW_SELF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_P2V</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 *  (it,dt,rt): (0,1,1) -&gt; (1,1,1)</span>
<span class="cm">	 *  This kind of transition is found in OSYa.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  (it,dt,rt): (0,1,1) -&gt; (0,0,0)</span>
<span class="cm">	 *  This kind of transition is found in OSYa</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="n">SW_NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_SELF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_P2V</span><span class="p">},</span>
	<span class="cm">/* (1,0,0)-&gt;(1,1,1) */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_P2V</span><span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 *  (it,dt,rt): (1,0,1) -&gt; (1,1,1)</span>
<span class="cm">	 *  This kind of transition usually occurs when Linux returns</span>
<span class="cm">	 *  from the low level TLB miss handlers.</span>
<span class="cm">	 *  (see &quot;arch/ia64/kernel/ivt.S&quot;)</span>
<span class="cm">	 */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_SELF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_P2V</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 *  (it,dt,rt): (1,1,1) -&gt; (1,0,1)</span>
<span class="cm">	 *  This kind of transition usually occurs in Linux low level</span>
<span class="cm">	 *  TLB miss handler. (see &quot;arch/ia64/kernel/ivt.S&quot;)</span>
<span class="cm">	 *</span>
<span class="cm">	 *  (it,dt,rt): (1,1,1) -&gt; (0,0,0)</span>
<span class="cm">	 *  This kind of transition usually occurs in pal and efi calls,</span>
<span class="cm">	 *  which requires running in physical mode.</span>
<span class="cm">	 *  (see &quot;arch/ia64/kernel/head.S&quot;)</span>
<span class="cm">	 *  (1,1,1)-&gt;(1,0,0)</span>
<span class="cm">	 */</span>

	<span class="p">{</span><span class="n">SW_V2P</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_V2P</span><span class="p">,</span> <span class="n">SW_V2P</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">SW_SELF</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">physical_mode_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span>  <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">=</span> <span class="n">GUEST_IN_PHY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">switch_to_physical_rid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="cm">/* Save original virtual mode rr[0] and rr[4] */</span>
	<span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_clear_ic</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">VRN0</span><span class="o">&lt;&lt;</span><span class="n">VRN_SHIFT</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_rr0</span><span class="p">);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">VRN4</span><span class="o">&lt;&lt;</span><span class="n">VRN_SHIFT</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_rr4</span><span class="p">);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>

	<span class="n">ia64_set_psr</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">switch_to_virtual_rid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_clear_ic</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">VRN0</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr0</span><span class="p">);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">VRN4</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr4</span><span class="p">);</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>
	<span class="n">ia64_set_psr</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mm_switch_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">opsr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">npsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mm_switch_table</span><span class="p">[</span><span class="n">MODE_IND</span><span class="p">(</span><span class="n">opsr</span><span class="p">)][</span><span class="n">MODE_IND</span><span class="p">(</span><span class="n">npsr</span><span class="p">)];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">switch_mm_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">old_psr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">new_psr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">act</span><span class="p">;</span>
	<span class="n">act</span> <span class="o">=</span> <span class="n">mm_switch_action</span><span class="p">(</span><span class="n">old_psr</span><span class="p">,</span> <span class="n">new_psr</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">act</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SW_V2P</span>:
		<span class="cm">/*printk(&quot;V -&gt; P mode transition: (0x%lx -&gt; 0x%lx)\n&quot;,</span>
<span class="cm">		old_psr.val, new_psr.val);*/</span>
		<span class="n">switch_to_physical_rid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set rse to enforced lazy, to prevent active rse</span>
<span class="cm">		 *save/restor when guest physical mode.</span>
<span class="cm">		 */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">GUEST_IN_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SW_P2V</span>:
		<span class="n">switch_to_virtual_rid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * recover old mode which is saved when entering</span>
<span class="cm">		 * guest physical mode</span>
<span class="cm">		 */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GUEST_IN_PHY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SW_SELF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SW_NOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Sanity check */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In physical mode, insert tc/tr for region 0 and 4 uses</span>
<span class="cm"> * RID[0] and RID[4] which is for physical mode emulation.</span>
<span class="cm"> * However what those inserted tc/tr wants is rid for</span>
<span class="cm"> * virtual mode. So original virtual rid needs to be restored</span>
<span class="cm"> * before insert.</span>
<span class="cm"> *</span>
<span class="cm"> * Operations which required such switch include:</span>
<span class="cm"> *  - insertions (itc.*, itr.*)</span>
<span class="cm"> *  - purges (ptc.* and ptr.*)</span>
<span class="cm"> *  - tpa</span>
<span class="cm"> *  - tak</span>
<span class="cm"> *  - thash?, ttag?</span>
<span class="cm"> * All above needs actual virtual rid for destination entry.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">check_mm_mode_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">old_psr</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">new_psr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">old_psr</span><span class="p">.</span><span class="n">dt</span> <span class="o">!=</span> <span class="n">new_psr</span><span class="p">.</span><span class="n">dt</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">old_psr</span><span class="p">.</span><span class="n">it</span> <span class="o">!=</span> <span class="n">new_psr</span><span class="p">.</span><span class="n">it</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">(</span><span class="n">old_psr</span><span class="p">.</span><span class="n">rt</span> <span class="o">!=</span> <span class="n">new_psr</span><span class="p">.</span><span class="n">rt</span><span class="p">))</span>
		<span class="n">switch_mm_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">old_psr</span><span class="p">,</span> <span class="n">new_psr</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * In physical mode, insert tc/tr for region 0 and 4 uses</span>
<span class="cm"> * RID[0] and RID[4] which is for physical mode emulation.</span>
<span class="cm"> * However what those inserted tc/tr wants is rid for</span>
<span class="cm"> * virtual mode. So original virtual rid needs to be restored</span>
<span class="cm"> * before insert.</span>
<span class="cm"> *</span>
<span class="cm"> * Operations which required such switch include:</span>
<span class="cm"> *  - insertions (itc.*, itr.*)</span>
<span class="cm"> *  - purges (ptc.* and ptr.*)</span>
<span class="cm"> *  - tpa</span>
<span class="cm"> *  - tak</span>
<span class="cm"> *  - thash?, ttag?</span>
<span class="cm"> * All above needs actual virtual rid for destination entry.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">prepare_if_physical_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">GUEST_PHY_EMUL</span><span class="p">;</span>
		<span class="n">switch_to_virtual_rid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Recover always follows prepare */</span>
<span class="kt">void</span> <span class="nf">recover_if_physical_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
		<span class="n">switch_to_physical_rid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GUEST_PHY_EMUL</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RPT(x)	((u16) &amp;((struct kvm_pt_regs *)0)-&gt;x)</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">gr_info</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> 	<span class="cm">/* r0 is read-only : WE SHOULD NEVER GET THIS */</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r1</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r2</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r3</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r4</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r5</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r6</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r7</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r8</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r9</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r10</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r11</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r12</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r13</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r14</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r15</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r16</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r17</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r18</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r19</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r20</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r21</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r22</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r23</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r24</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r25</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r26</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r27</span><span class="p">),</span>
	<span class="n">RPT</span><span class="p">(</span><span class="n">r28</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r29</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r30</span><span class="p">),</span> <span class="n">RPT</span><span class="p">(</span><span class="n">r31</span><span class="p">)</span>
<span class="p">};</span>

<span class="cp">#define IA64_FIRST_STACKED_GR   32</span>
<span class="cp">#define IA64_FIRST_ROTATING_FR  32</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">rotate_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sor</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rrb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg</span> <span class="o">+=</span> <span class="n">rrb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">sor</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">-=</span> <span class="n">sor</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the (rotated) index for floating point register</span>
<span class="cm"> * be in the REGNUM (REGNUM must range from 32-127,</span>
<span class="cm"> * result is in the range from 0-95.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">fph_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
						<span class="kt">long</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rrb_fr</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rotate_reg</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="n">rrb_fr</span><span class="p">,</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="n">IA64_FIRST_ROTATING_FR</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The inverse of the above: given bspstore and the number of</span>
<span class="cm"> * registers, calculate ar.bsp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="nf">kvm_rse_skip_regs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
							<span class="kt">long</span> <span class="n">num_regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_regs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">-=</span> <span class="mh">0x3e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mh">0x3f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;=</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">delta</span> <span class="o">-=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">num_regs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_rse_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bsp</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">bspstore</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_vcpu</span> <span class="o">+</span> <span class="n">VMM_RBS_OFFSET</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nat_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_rsc</span><span class="p">,</span> <span class="n">new_rsc</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">sof</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">sor</span> <span class="o">=</span> <span class="p">(((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">rrb_gr</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ridx</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">sor</span><span class="p">)</span>
		<span class="n">ridx</span> <span class="o">=</span> <span class="n">rotate_reg</span><span class="p">(</span><span class="n">sor</span><span class="p">,</span> <span class="n">rrb_gr</span><span class="p">,</span> <span class="n">ridx</span><span class="p">);</span>

	<span class="n">old_rsc</span> <span class="o">=</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">);</span>
	<span class="n">new_rsc</span> <span class="o">=</span> <span class="n">old_rsc</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x3</span><span class="p">));</span>
	<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">,</span> <span class="n">new_rsc</span><span class="p">);</span>

	<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_BSPSTORE</span><span class="p">);</span>
	<span class="n">bsp</span> <span class="o">=</span> <span class="n">kbs</span> <span class="o">+</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">loadrs</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">kvm_rse_skip_regs</span><span class="p">(</span><span class="n">bsp</span><span class="p">,</span> <span class="o">-</span><span class="n">sof</span> <span class="o">+</span> <span class="n">ridx</span><span class="p">);</span>
	<span class="n">nat_mask</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">rnat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">bspstore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia64_flushrs</span><span class="p">();</span>
		<span class="n">ia64_mf</span><span class="p">();</span>
		<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_BSPSTORE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nat</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bspstore</span> <span class="o">&lt;</span> <span class="n">rnat_addr</span><span class="p">)</span>
			<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">!!</span><span class="p">(</span><span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RNAT</span><span class="p">)</span>
							<span class="o">&amp;</span> <span class="n">nat_mask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">!!</span><span class="p">((</span><span class="o">*</span><span class="n">rnat_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">nat_mask</span><span class="p">);</span>
		<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">,</span> <span class="n">old_rsc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_rse_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bsp</span><span class="p">,</span> <span class="o">*</span><span class="n">bspstore</span><span class="p">,</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_vcpu</span> <span class="o">+</span> <span class="n">VMM_RBS_OFFSET</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nat_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">old_rsc</span><span class="p">,</span> <span class="n">new_rsc</span><span class="p">,</span> <span class="n">psr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rnat</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">sof</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">sor</span> <span class="o">=</span> <span class="p">(((</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">rrb_gr</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ridx</span> <span class="o">=</span> <span class="n">r1</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ridx</span> <span class="o">&lt;</span> <span class="n">sor</span><span class="p">)</span>
		<span class="n">ridx</span> <span class="o">=</span> <span class="n">rotate_reg</span><span class="p">(</span><span class="n">sor</span><span class="p">,</span> <span class="n">rrb_gr</span><span class="p">,</span> <span class="n">ridx</span><span class="p">);</span>

	<span class="n">old_rsc</span> <span class="o">=</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">);</span>
	<span class="cm">/* put RSC to lazy mode, and set loadrs 0 */</span>
	<span class="n">new_rsc</span> <span class="o">=</span> <span class="n">old_rsc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x3fff0003</span><span class="p">);</span>
	<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">,</span> <span class="n">new_rsc</span><span class="p">);</span>
	<span class="n">bsp</span> <span class="o">=</span> <span class="n">kbs</span> <span class="o">+</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">loadrs</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">);</span> <span class="cm">/* 16 + 3 */</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">kvm_rse_skip_regs</span><span class="p">(</span><span class="n">bsp</span><span class="p">,</span> <span class="o">-</span><span class="n">sof</span> <span class="o">+</span> <span class="n">ridx</span><span class="p">);</span>
	<span class="n">nat_mask</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">rnat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_BSPSTORE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">bspstore</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ia64_flushrs</span><span class="p">();</span>
		<span class="n">ia64_mf</span><span class="p">();</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_BSPSTORE</span><span class="p">);</span>
		<span class="n">rnat</span> <span class="o">=</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RNAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bspstore</span> <span class="o">&lt;</span> <span class="n">rnat_addr</span><span class="p">)</span>
			<span class="n">rnat</span> <span class="o">=</span> <span class="n">rnat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">nat_mask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">rnat_addr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rnat_addr</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">nat_mask</span><span class="p">);</span>

		<span class="n">ia64_mf</span><span class="p">();</span>
		<span class="n">ia64_loadrs</span><span class="p">();</span>
		<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RNAT</span><span class="p">,</span> <span class="n">rnat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rnat</span> <span class="o">=</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RNAT</span><span class="p">);</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bspstore</span> <span class="o">&lt;</span> <span class="n">rnat_addr</span><span class="p">)</span>
			<span class="n">rnat</span> <span class="o">=</span> <span class="n">rnat</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">nat_mask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">rnat_addr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rnat_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">nat_mask</span><span class="p">);</span>

		<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_BSPSTORE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">bspstore</span><span class="p">);</span>
		<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RNAT</span><span class="p">,</span> <span class="n">rnat</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="n">ia64_setreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">,</span> <span class="n">old_rsc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">getreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">unat</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="n">IA64_FIRST_STACKED_GR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_rse_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now look at registers in [0-31] range and init correct UNAT</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">eml_unat</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">+=</span> <span class="n">gr_info</span><span class="p">[</span><span class="n">regnum</span><span class="p">];</span>

	<span class="o">*</span><span class="n">val</span>  <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * do it only when requested</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nat</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nat</span>  <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">unat</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1UL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">nat</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bitmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">unat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First takes care of stacked registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="n">IA64_FIRST_STACKED_GR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_rse_reg</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now look at registers in [0-31] range and init correct UNAT</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">eml_unat</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * add offset from base of struct</span>
<span class="cm">	 * and do it !</span>
<span class="cm">	 */</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">gr_info</span><span class="p">[</span><span class="n">regnum</span><span class="p">];</span>

	<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to clear the corresponding UNAT bit to fully emulate the load</span>
<span class="cm">	 * UNAT bit_pos = GR[r3]{8:3} form EAS-2.4</span>
<span class="cm">	 */</span>
	<span class="n">bitmask</span>   <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nat</span><span class="p">)</span>
		<span class="o">*</span><span class="n">unat</span> <span class="o">|=</span> <span class="n">bitmask</span><span class="p">;</span>
	 <span class="k">else</span>
		<span class="o">*</span><span class="n">unat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bitmask</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">u64</span> <span class="nf">vcpu_get_gr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">getreg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_set_gr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">sof</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">sof</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">setreg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>	<span class="cm">/* FIXME: handle NATs later*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">getfpreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regnum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">fpval</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Take floating register rotation into consideration*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="n">IA64_FIRST_ROTATING_FR</span><span class="p">)</span>
		<span class="n">regnum</span> <span class="o">=</span> <span class="n">IA64_FIRST_ROTATING_FR</span> <span class="o">+</span> <span class="n">fph_index</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
<span class="cp">#define CASE_FIXED_FP(reg)			\</span>
<span class="cp">	case  (reg) :				\</span>
<span class="cp">		ia64_stf_spill(fpval, reg);	\</span>
<span class="cp">	break</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>

		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">18</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">27</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">29</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">34</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">37</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">38</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">39</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">41</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">43</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">46</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">47</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">49</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">51</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">52</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">53</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">54</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">56</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">57</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">58</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">59</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">61</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">62</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">63</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">65</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">67</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">68</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">69</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">71</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">72</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">73</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">74</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">75</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">76</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">77</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">78</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">79</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">81</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">82</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">83</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">84</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">85</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">86</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">87</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">88</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">89</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">91</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">92</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">93</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">94</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">95</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">96</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">97</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">98</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">99</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">101</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">102</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">103</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">104</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">105</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">106</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">107</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">108</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">109</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">110</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">111</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">112</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">113</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">114</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">115</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">116</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">117</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">118</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">119</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">121</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">122</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">124</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">126</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef CASE_FIXED_FP</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setfpreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regnum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">fpval</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Take floating register rotation into consideration*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="n">IA64_FIRST_ROTATING_FR</span><span class="p">)</span>
		<span class="n">regnum</span> <span class="o">=</span> <span class="n">IA64_FIRST_ROTATING_FR</span> <span class="o">+</span> <span class="n">fph_index</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>

<span class="cp">#define CASE_FIXED_FP(reg)			\</span>
<span class="cp">	case (reg) :				\</span>
<span class="cp">		ia64_ldf_fill(reg, fpval);	\</span>
<span class="cp">	break</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>

		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">14</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">18</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">21</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">23</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">27</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">28</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">29</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">31</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">34</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">35</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">37</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">38</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">39</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">41</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">43</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">46</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">47</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">48</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">49</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">51</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">52</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">53</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">54</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">56</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">57</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">58</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">59</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">61</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">62</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">63</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">65</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">67</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">68</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">69</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">71</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">72</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">73</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">74</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">75</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">76</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">77</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">78</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">79</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">81</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">82</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">83</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">84</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">85</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">86</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">87</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">88</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">89</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">90</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">91</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">92</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">93</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">94</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">95</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">96</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">97</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">98</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">99</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">101</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">102</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">103</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">104</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">105</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">106</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">107</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">108</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">109</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">110</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">111</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">112</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">113</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">114</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">115</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">116</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">117</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">118</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">119</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">121</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">122</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">123</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">124</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">126</span><span class="p">);</span>
		<span class="n">CASE_FIXED_FP</span><span class="p">(</span><span class="mi">127</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_get_fpreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">getfpreg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>   <span class="cm">/* FIXME: handle NATs later*/</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_set_fpreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">setfpreg</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>   <span class="cm">/* FIXME: handle NATs later*/</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The Altix RTC is mapped specially here for the vmm module</span>
<span class="cm"> */</span>
<span class="cp">#define SN_RTC_BASE	(u64 *)(KVM_VMM_BASE+(1UL&lt;&lt;KVM_VMM_SHIFT))</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">kvm_get_itc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_IA64_SGI_SN2) || defined(CONFIG_IA64_GENERIC)</span>
	<span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="p">)</span><span class="n">KVM_VM_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">is_sn2</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">SN_RTC_BASE</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_ITC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>
<span class="cm"> * lsapic timer</span>
<span class="cm"> ***********************************************************************/</span>
<span class="n">u64</span> <span class="nf">vcpu_get_itc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">guest_itc</span><span class="p">;</span>
	<span class="n">guest_itc</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itc_offset</span><span class="p">)</span> <span class="o">+</span> <span class="n">kvm_get_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">guest_itc</span> <span class="o">&gt;=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">)</span> <span class="o">=</span> <span class="n">guest_itc</span><span class="p">;</span>
		<span class="k">return</span>  <span class="n">guest_itc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">vcpu_set_itm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcpu_set_itc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="n">kvm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">itc_offset</span> <span class="o">=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">kvm_get_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vitv</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itv</span><span class="p">);</span>

	<span class="n">kvm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm</span> <span class="o">*</span><span class="p">)</span><span class="n">KVM_VM_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kvm_vcpu_is_bsp</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kvm</span><span class="o">-&gt;</span><span class="n">online_vcpus</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">vcpu</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">itc_offset</span><span class="p">)</span> <span class="o">=</span> <span class="n">itc_offset</span><span class="p">;</span>
			<span class="n">VMX</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itm</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vcpu_unpend_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vitv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vcpu_set_itm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itm</span><span class="p">));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">vcpu_get_itm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itm</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcpu_set_itm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vitv</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itv</span><span class="p">);</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itm</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">vcpu_get_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vcpu_unpend_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vitv</span><span class="p">);</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">timer_pending</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itc_check</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define  ITV_VECTOR(itv)    (itv&amp;0xff)</span>
<span class="cp">#define  ITV_IRQ_MASK(itv)  (itv&amp;(1&lt;&lt;16))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcpu_set_itv</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itv</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ITV_IRQ_MASK</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">timer_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu_pend_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ITV_VECTOR</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">timer_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcpu_set_eoi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vec</span><span class="p">;</span>

	<span class="n">vec</span> <span class="o">=</span> <span class="n">highest_inservice_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">NULL_VECTOR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">insvc</span><span class="p">[</span><span class="n">vec</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">])</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vec</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">));</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eoi</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_new_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* See Table 5-8 in SDM vol2 for the definition */</span>
<span class="kt">int</span> <span class="nf">irq_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h_pending</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h_inservice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_tpr</span> <span class="n">vtpr</span><span class="p">;</span>

	<span class="n">vtpr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tpr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_inservice</span> <span class="o">==</span> <span class="n">NMI_VECTOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_MASKED_BY_INSVC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_pending</span> <span class="o">==</span> <span class="n">NMI_VECTOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Non Maskable Interrupt */</span>
		<span class="k">return</span> <span class="n">IRQ_NO_MASKED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_inservice</span> <span class="o">==</span> <span class="n">ExtINT_VECTOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_MASKED_BY_INSVC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">h_pending</span> <span class="o">==</span> <span class="n">ExtINT_VECTOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vtpr</span><span class="p">.</span><span class="n">mmi</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mask all external IRQ */</span>
			<span class="k">return</span> <span class="n">IRQ_MASKED_BY_VTPR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">IRQ_NO_MASKED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_higher_irq</span><span class="p">(</span><span class="n">h_pending</span><span class="p">,</span> <span class="n">h_inservice</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_higher_class</span><span class="p">(</span><span class="n">h_pending</span><span class="p">,</span> <span class="n">vtpr</span><span class="p">.</span><span class="n">mic</span> <span class="o">+</span> <span class="p">(</span><span class="n">vtpr</span><span class="p">.</span><span class="n">mmi</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">IRQ_NO_MASKED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">IRQ_MASKED_BY_VTPR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_MASKED_BY_INSVC</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_pend_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">spsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">spsr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">spsr</span><span class="p">);</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_new_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_unpend_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">spsr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">spsr</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">spsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_new_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">update_vhpi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">vhpi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">NULL_VECTOR</span><span class="p">)</span>
		<span class="n">vhpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">NMI_VECTOR</span><span class="p">)</span>
		<span class="n">vhpi</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">ExtINT_VECTOR</span><span class="p">)</span>
		<span class="n">vhpi</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vhpi</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vhpi</span><span class="p">)</span> <span class="o">=</span> <span class="n">vhpi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vac</span><span class="p">).</span><span class="n">a_int</span><span class="p">)</span>
		<span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_SET_PENDING_INTERRUPT</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">vcpu_get_ivr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="n">h_inservice</span><span class="p">,</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">vec</span> <span class="o">=</span> <span class="n">highest_pending_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">h_inservice</span> <span class="o">=</span> <span class="n">highest_inservice_irq</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">irq_masked</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">h_inservice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vec</span> <span class="o">==</span> <span class="n">NULL_VECTOR</span> <span class="o">||</span> <span class="n">mask</span> <span class="o">==</span> <span class="n">IRQ_MASKED_BY_INSVC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vhpi</span><span class="p">))</span>
			<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">NULL_VECTOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IA64_SPURIOUS_INT_VECTOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">IRQ_MASKED_BY_VTPR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IA64_SPURIOUS_INT_VECTOR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">insvc</span><span class="p">[</span><span class="n">vec</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">])</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vec</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">));</span>
	<span class="n">vcpu_unpend_interrupt</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vec</span><span class="p">);</span>
	<span class="k">return</span>  <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">  Privileged operation emulation routines</span>
<span class="cm"> **************************************************************************/</span>
<span class="n">u64</span> <span class="nf">vcpu_thash</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_pta</span> <span class="n">vpta</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pval</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">vhpt_offset</span><span class="p">;</span>

	<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
	<span class="n">vhpt_offset</span> <span class="o">=</span> <span class="p">((</span><span class="n">vadr</span> <span class="o">&gt;&gt;</span> <span class="n">vrr</span><span class="p">.</span><span class="n">ps</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">size</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pval</span> <span class="o">=</span> <span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_THASH</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">vrr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
				<span class="n">vpta</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pval</span> <span class="o">=</span> <span class="p">(</span><span class="n">vadr</span> <span class="o">&amp;</span> <span class="n">VRN_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">vhpt_offset</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">size</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span>  <span class="n">pval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">vcpu_ttag</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">vrr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_pta</span> <span class="n">vpta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pval</span><span class="p">;</span>

	<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">vf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pval</span> <span class="o">=</span> <span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_TTAG</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">vrr</span><span class="p">.</span><span class="n">val</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span>  <span class="n">pval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u64</span> <span class="nf">vcpu_tak</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_pta</span> <span class="n">vpta</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">vpta</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_pta</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpta</span><span class="p">.</span><span class="n">vf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">key</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">vtlb_lookup</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
		<span class="n">key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">key</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_thash</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thash</span><span class="p">,</span> <span class="n">vadr</span><span class="p">;</span>

	<span class="n">vadr</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">thash</span> <span class="o">=</span> <span class="n">vcpu_thash</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">thash</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ttag</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="n">vadr</span><span class="p">;</span>

	<span class="n">vadr</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">vcpu_ttag</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vcpu_tpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vadr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">padr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">ia64_isr</span> <span class="n">visr</span><span class="p">,</span> <span class="n">pt_isr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">vpsr</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">pt_isr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cr_isr</span><span class="p">);</span>
	<span class="n">visr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">visr</span><span class="p">.</span><span class="n">ei</span> <span class="o">=</span> <span class="n">pt_isr</span><span class="p">.</span><span class="n">ei</span><span class="p">;</span>
	<span class="n">visr</span><span class="p">.</span><span class="n">ir</span> <span class="o">=</span> <span class="n">pt_isr</span><span class="p">.</span><span class="n">ir</span><span class="p">;</span>
	<span class="n">vpsr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
	<span class="n">visr</span><span class="p">.</span><span class="n">na</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">vhpt_lookup</span><span class="p">(</span><span class="n">vadr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">data_page_not_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ma</span> <span class="o">==</span> <span class="n">VA_MATTR_NATPAGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">dnat_page_consumption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">padr</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">gpaddr</span> <span class="o">&gt;&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">vadr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">IA64_NO_FAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">vtlb_lookup</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">data_page_not_present</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ma</span> <span class="o">==</span> <span class="n">VA_MATTR_NATPAGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">dnat_page_consumption</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
			<span class="o">*</span><span class="n">padr</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ppn</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">-</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">vadr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PSIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">IA64_NO_FAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vhpt_enabled</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">,</span> <span class="n">NA_REF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span><span class="p">.</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">alt_dtlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpsr</span><span class="p">.</span><span class="n">ic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcpu_set_isr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">visr</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
			<span class="n">dvhpt_fault</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vadr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
			<span class="n">nested_dtlb</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IA64_NO_FAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kvm_tpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r3</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu_tpa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IA64_FAULT</span><span class="p">;</span>

	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">IA64_NO_FAULT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_tak</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r3</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_tak</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M46</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************</span>
<span class="cm"> * Insert/Purge translation register/cache</span>
<span class="cm"> ************************************/</span>
<span class="kt">void</span> <span class="nf">vcpu_itc_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">thash_purge_and_insert</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">I_TLB</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_itc_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">thash_purge_and_insert</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_itr_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ps</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">rid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">p_itr</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PAGE_FLAGS_RV_MASK</span><span class="p">;</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span> <span class="o">&amp;</span> <span class="n">RR_RID_MASK</span><span class="p">;</span>
	<span class="n">p_itr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itrs</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="n">vcpu_set_tr</span><span class="p">(</span><span class="n">p_itr</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">rid</span><span class="p">);</span>
	<span class="n">vcpu_quick_region_set</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itr_regions</span><span class="p">),</span> <span class="n">va</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">vcpu_itr_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u64</span> <span class="n">pte</span><span class="p">,</span> <span class="n">u64</span> <span class="n">itir</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">gpfn</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ps</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">rid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="n">p_dtr</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">);</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PAGE_FLAGS_RV_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps</span> <span class="o">!=</span> <span class="n">_PAGE_SIZE_16M</span><span class="p">)</span>
		<span class="n">thash_purge_entries</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">gpfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">pte</span> <span class="o">&amp;</span> <span class="n">_PAGE_PPN_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__gpfn_is_io</span><span class="p">(</span><span class="n">gpfn</span><span class="p">))</span>
		<span class="n">pte</span> <span class="o">|=</span> <span class="n">VTLB_PTE_IO</span><span class="p">;</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">rid</span> <span class="o">=</span> <span class="n">rid</span> <span class="o">&amp;</span> <span class="n">RR_RID_MASK</span><span class="p">;</span>
	<span class="n">p_dtr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtrs</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="n">vcpu_set_tr</span><span class="p">((</span><span class="k">struct</span> <span class="n">thash_data</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtrs</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span>
							<span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">rid</span><span class="p">);</span>
	<span class="n">vcpu_quick_region_set</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dtr_regions</span><span class="p">),</span> <span class="n">va</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_ptr_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">va</span><span class="p">;</span>

	<span class="n">va</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">vtr_find_overlap</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">D_TLB</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">dtrs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">page_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">thash_purge_entries</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_ptr_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">va</span><span class="p">;</span>

	<span class="n">va</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">ifa</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">vtr_find_overlap</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">I_TLB</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">itrs</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">page_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">thash_purge_entries</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_ptc_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">va</span> <span class="o">=</span> <span class="n">PAGEALIGN</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">thash_purge_entries</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_ptc_e</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">thash_purge_all</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_ptc_ga</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_PTC_G</span><span class="p">;</span>

	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ptc_g_data</span><span class="p">.</span><span class="n">rr</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ptc_g_data</span><span class="p">.</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">va</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ptc_g_data</span><span class="p">.</span><span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span>
	<span class="n">vmm_transition</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="cm">/* Do Local Purge Here*/</span>
	<span class="n">vcpu_ptc_l</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">vcpu_ptc_g</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">u64</span> <span class="n">va</span><span class="p">,</span> <span class="n">u64</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcpu_ptc_ga</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">va</span><span class="p">,</span> <span class="n">ps</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptc_e</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_ptc_e</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptc_g</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_ptc_g</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptc_ga</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_ptc_ga</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptc_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_ptc_l</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptr_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_ptr_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ptr_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir</span><span class="p">;</span>

	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_ptr_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">itir_ps</span><span class="p">(</span><span class="n">itir</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_itr_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_itir</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_ifa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu_itr_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">kvm_itr_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_itir</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_ifa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu_itr_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_itc_d</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pte</span><span class="p">;</span>

	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_itir</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_ifa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_itc_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_itc_i</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">pte</span><span class="p">;</span>

	<span class="n">itir</span> <span class="o">=</span> <span class="n">vcpu_get_itir</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">ifa</span> <span class="o">=</span> <span class="n">vcpu_get_ifa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">pte</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M45</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_itc_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pte</span><span class="p">,</span> <span class="n">itir</span><span class="p">,</span> <span class="n">ifa</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************</span>
<span class="cm"> * Moves to semi-privileged registers</span>
<span class="cm"> *************************************/</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_ar_imm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M30</span><span class="p">.</span><span class="n">s</span><span class="p">)</span>
		<span class="n">imm</span> <span class="o">=</span> <span class="o">-</span><span class="n">inst</span><span class="p">.</span><span class="n">M30</span><span class="p">.</span><span class="n">imm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">imm</span> <span class="o">=</span> <span class="n">inst</span><span class="p">.</span><span class="n">M30</span><span class="p">.</span><span class="n">imm</span><span class="p">;</span>

	<span class="n">vcpu_set_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">imm</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_ar_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M29</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_ar_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_itc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M31</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">  struct kvm_vcpu protection key register access routines</span>
<span class="cm"> **************************************************************************/</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vcpu_get_pkr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ia64_get_pkr</span><span class="p">(</span><span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_set_pkr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ia64_set_pkr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************</span>
<span class="cm"> * Moves to privileged registers</span>
<span class="cm"> ********************************/</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vcpu_set_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ia64_rr</span> <span class="n">oldrr</span><span class="p">,</span> <span class="n">newrr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rrval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="n">oldrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">newrr</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vrr</span><span class="p">[</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="n">VRN_SHIFT</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="n">VRN_SHIFT</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VRN6</span>:
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vmm_rr</span> <span class="o">=</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_SWITCH_RR6</span><span class="p">;</span>
		<span class="n">vmm_transition</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VRN4</span>:
		<span class="n">rrval</span> <span class="o">=</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr4</span> <span class="o">=</span> <span class="n">rrval</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
			<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">rrval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VRN0</span>:
		<span class="n">rrval</span> <span class="o">=</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr0</span> <span class="o">=</span> <span class="n">rrval</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span>
			<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">rrval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ia64_set_rr</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">IA64_NO_FAULT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_dbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_ibr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_pmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_pmc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_pmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_pmd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_pkr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M42</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_pkr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_pkr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_pkr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_dbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_dbr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_ibr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_ibr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_pmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_pmc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vcpu_get_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: This could get called as a result of a rsvd-reg fault */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ia64_get_cpuid</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ia64_get_cpuid</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_cpuid</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r3</span><span class="p">,</span> <span class="n">r1</span><span class="p">;</span>

	<span class="n">r3</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">r1</span> <span class="o">=</span> <span class="n">vcpu_get_cpuid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M43</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_set_tpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvm_mov_to_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">r2</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M32</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcr</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">M32</span><span class="p">.</span><span class="n">cr3</span><span class="p">])</span> <span class="o">=</span> <span class="n">r2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M32</span><span class="p">.</span><span class="n">cr3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">vcpu_set_dcr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">vcpu_set_itm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">66</span>:
		<span class="n">vcpu_set_tpr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">67</span>:
		<span class="n">vcpu_set_eoi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">r2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">kvm_mov_from_cr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tgt</span> <span class="o">=</span> <span class="n">inst</span><span class="p">.</span><span class="n">M33</span><span class="p">.</span><span class="n">r1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M33</span><span class="p">.</span><span class="n">cr3</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">65</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_ivr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">67</span>:
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vcr</span><span class="p">[</span><span class="n">inst</span><span class="p">.</span><span class="n">M33</span><span class="p">.</span><span class="n">cr3</span><span class="p">]);</span>
		<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_set_psr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">old_psr</span><span class="p">,</span> <span class="n">new_psr</span><span class="p">;</span>

	<span class="n">old_psr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="cm">/* We only support guest as:</span>
<span class="cm">	 *  vpsr.pk = 0</span>
<span class="cm">	 *  vpsr.is = 0</span>
<span class="cm">	 * Otherwise panic</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IA64_PSR_PK</span> <span class="o">|</span> <span class="n">IA64_PSR_IS</span> <span class="o">|</span> <span class="n">IA64_PSR_VM</span><span class="p">))</span>
		<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Only support guests with vpsr.pk =0 &quot;</span>
				<span class="s">&quot;&amp; vpsr.is=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For those IA64_PSR bits: id/da/dd/ss/ed/ia</span>
<span class="cm">	 * Since these bits will become 0, after success execution of each</span>
<span class="cm">	 * instruction, we will change set them to mIA64_PSR</span>
<span class="cm">	 */</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span>
		<span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">IA64_PSR_ID</span> <span class="o">|</span> <span class="n">IA64_PSR_DA</span> <span class="o">|</span> <span class="n">IA64_PSR_DD</span> <span class="o">|</span>
			<span class="n">IA64_PSR_SS</span> <span class="o">|</span> <span class="n">IA64_PSR_ED</span> <span class="o">|</span> <span class="n">IA64_PSR_IA</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_psr</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_I</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* vpsr.i 0-&gt;1 */</span>
		<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">irq_check</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_psr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * All vIA64_PSR bits shall go to mPSR (v-&gt;tf-&gt;tf_special.psr)</span>
<span class="cm">	 * , except for the following bits:</span>
<span class="cm">	 *  ic/i/dt/si/rt/mc/it/bn/vm</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">=</span>  <span class="n">IA64_PSR_IC</span> <span class="o">+</span> <span class="n">IA64_PSR_I</span> <span class="o">+</span> <span class="n">IA64_PSR_DT</span> <span class="o">+</span> <span class="n">IA64_PSR_SI</span> <span class="o">+</span>
		<span class="n">IA64_PSR_RT</span> <span class="o">+</span> <span class="n">IA64_PSR_MC</span> <span class="o">+</span> <span class="n">IA64_PSR_IT</span> <span class="o">+</span> <span class="n">IA64_PSR_BN</span> <span class="o">+</span>
		<span class="n">IA64_PSR_VM</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">));</span>

	<span class="n">check_mm_mode_switch</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">old_psr</span><span class="p">,</span> <span class="n">new_psr</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vcpu_cover</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="n">vpsr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vpsr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vpsr</span><span class="p">.</span><span class="n">ic</span><span class="p">)</span>
		<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifs</span><span class="p">)</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="n">IA64_IFS_V</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">IA64_NO_FAULT</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/**************************************************************************</span>
<span class="cm">  VCPU banked general register access routines</span>
<span class="cm"> **************************************************************************/</span>
<span class="cp">#define vcpu_bsw0_unat(i, b0unat, b1unat, runat, VMM_PT_REGS_R16_SLOT)	\</span>
<span class="cp">	do {     							\</span>
<span class="cp">		__asm__ __volatile__ (					\</span>
<span class="cp">				&quot;;;extr.u %0 = %3,%6,16;;\n&quot;		\</span>
<span class="cp">				&quot;dep %1 = %0, %1, 0, 16;;\n&quot;		\</span>
<span class="cp">				&quot;st8 [%4] = %1\n&quot;			\</span>
<span class="cp">				&quot;extr.u %0 = %2, 16, 16;;\n&quot;		\</span>
<span class="cp">				&quot;dep %3 = %0, %3, %6, 16;;\n&quot;		\</span>
<span class="cp">				&quot;st8 [%5] = %3\n&quot;			\</span>
<span class="cp">				::&quot;r&quot;(i), &quot;r&quot;(*b1unat), &quot;r&quot;(*b0unat),	\</span>
<span class="cp">				&quot;r&quot;(*runat), &quot;r&quot;(b1unat), &quot;r&quot;(runat),	\</span>
<span class="cp">				&quot;i&quot;(VMM_PT_REGS_R16_SLOT) : &quot;memory&quot;);	\</span>
<span class="cp">	} while (0)</span>

<span class="kt">void</span> <span class="nf">vcpu_bsw0</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vbgr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vgr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">runat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">eml_unat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b0unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vbnat</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b1unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vnat</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_BN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">b1</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
			<span class="o">*</span><span class="n">r</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">b0</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vcpu_bsw0_unat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b0unat</span><span class="p">,</span> <span class="n">b1unat</span><span class="p">,</span> <span class="n">runat</span><span class="p">,</span>
				<span class="n">VMM_PT_REGS_R16_SLOT</span><span class="p">);</span>
		<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IA64_PSR_BN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define vcpu_bsw1_unat(i, b0unat, b1unat, runat, VMM_PT_REGS_R16_SLOT)	\</span>
<span class="cp">	do {             						\</span>
<span class="cp">		__asm__ __volatile__ (&quot;;;extr.u %0 = %3, %6, 16;;\n&quot;	\</span>
<span class="cp">				&quot;dep %1 = %0, %1, 16, 16;;\n&quot;		\</span>
<span class="cp">				&quot;st8 [%4] = %1\n&quot;			\</span>
<span class="cp">				&quot;extr.u %0 = %2, 0, 16;;\n&quot;		\</span>
<span class="cp">				&quot;dep %3 = %0, %3, %6, 16;;\n&quot;		\</span>
<span class="cp">				&quot;st8 [%5] = %3\n&quot;			\</span>
<span class="cp">				::&quot;r&quot;(i), &quot;r&quot;(*b0unat), &quot;r&quot;(*b1unat),	\</span>
<span class="cp">				&quot;r&quot;(*runat), &quot;r&quot;(b0unat), &quot;r&quot;(runat),	\</span>
<span class="cp">				&quot;i&quot;(VMM_PT_REGS_R16_SLOT) : &quot;memory&quot;);	\</span>
<span class="cp">	} while (0)</span>

<span class="kt">void</span> <span class="nf">vcpu_bsw1</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vbgr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vgr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">runat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">eml_unat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b0unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vbnat</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">b1unat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vnat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_BN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">b0</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
			<span class="o">*</span><span class="n">r</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">b1</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vcpu_bsw1_unat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">b0unat</span><span class="p">,</span> <span class="n">b1unat</span><span class="p">,</span> <span class="n">runat</span><span class="p">,</span>
				<span class="n">VMM_PT_REGS_R16_SLOT</span><span class="p">);</span>
		<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">|=</span> <span class="n">IA64_PSR_BN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_rfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">psr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">psr</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ipsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_BN</span><span class="p">)</span>
		<span class="n">vcpu_bsw1</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vcpu_bsw0</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vcpu_set_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">psr</span><span class="p">);</span>
	<span class="n">ifs</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ifs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifs</span> <span class="o">&gt;&gt;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="n">ifs</span><span class="p">;</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">=</span> <span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">iip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">   VPSR can&#39;t keep track of below bits of guest PSR</span>
<span class="cm">   This function gets guest PSR</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">vcpu_get_psr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">IA64_PSR_BE</span> <span class="o">|</span> <span class="n">IA64_PSR_UP</span> <span class="o">|</span> <span class="n">IA64_PSR_AC</span> <span class="o">|</span> <span class="n">IA64_PSR_MFL</span> <span class="o">|</span>
		<span class="n">IA64_PSR_MFH</span> <span class="o">|</span> <span class="n">IA64_PSR_CPL</span> <span class="o">|</span> <span class="n">IA64_PSR_RI</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_rsm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imm24</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">i2</span><span class="o">&lt;&lt;</span><span class="mi">21</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">imm</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">vcpu_get_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vpsr</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">imm24</span><span class="p">);</span>
	<span class="n">vcpu_set_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_ssm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpsr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">imm24</span> <span class="o">=</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">i2</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">inst</span><span class="p">.</span><span class="n">M44</span><span class="p">.</span><span class="n">imm</span><span class="p">;</span>

	<span class="n">vpsr</span> <span class="o">=</span> <span class="n">vcpu_get_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">vpsr</span> <span class="o">|=</span> <span class="n">imm24</span><span class="p">;</span>
	<span class="n">vcpu_set_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Generate Mask</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *  bit -- starting bit</span>
<span class="cm"> *  len -- how many bits</span>
<span class="cm"> */</span>
<span class="cp">#define MASK(bit,len)				   	\</span>
<span class="cp">({							\</span>
<span class="cp">		__u64	ret;				\</span>
<span class="cp">							\</span>
<span class="cp">		__asm __volatile(&quot;dep %0=-1, r0, %1, %2&quot;\</span>
<span class="cp">				: &quot;=r&quot; (ret):		\</span>
<span class="cp">		  &quot;M&quot; (bit),				\</span>
<span class="cp">		  &quot;M&quot; (len));				\</span>
<span class="cp">		ret;					\</span>
<span class="cp">})</span>

<span class="kt">void</span> <span class="nf">vcpu_set_psr_l</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcpu_get_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">vcpu_set_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_to_psr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M35</span><span class="p">.</span><span class="n">r2</span><span class="p">);</span>
	<span class="n">vcpu_set_psr_l</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_mov_from_psr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">INST64</span> <span class="n">inst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">vcpu_get_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MASK</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">vcpu_set_gr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">.</span><span class="n">M33</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_increment_iip</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">ipsr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vcpu_decrement_iip</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">ipsr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ipsr</span><span class="o">-&gt;</span><span class="n">ri</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Emulate a privileged operation.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * @param vcpu virtual cpu</span>
<span class="cm"> * @cause the reason cause virtualization fault</span>
<span class="cm"> * @opcode the instruction code which cause virtualization fault</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">kvm_emulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">,</span> <span class="n">cause</span><span class="p">,</span> <span class="n">opcode</span> <span class="p">;</span>
	<span class="n">INST64</span> <span class="n">inst</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">IA64_NO_FAULT</span><span class="p">;</span>
	<span class="n">cause</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cause</span><span class="p">);</span>
	<span class="n">opcode</span> <span class="o">=</span> <span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>
	<span class="n">inst</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Switch to actual virtual rid in rr0 and rr4,</span>
<span class="cm">	 * which is required by some tlb related instructions.</span>
<span class="cm">	 */</span>
	<span class="n">prepare_if_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENT_RSM</span>:
		<span class="n">kvm_rsm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_SSM</span>:
		<span class="n">kvm_ssm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_PSR</span>:
		<span class="n">kvm_mov_to_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_PSR</span>:
		<span class="n">kvm_mov_from_psr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_CR</span>:
		<span class="n">kvm_mov_from_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_CR</span>:
		<span class="n">kvm_mov_to_cr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_BSW_0</span>:
		<span class="n">vcpu_bsw0</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_BSW_1</span>:
		<span class="n">vcpu_bsw1</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_COVER</span>:
		<span class="n">vcpu_cover</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_RFI</span>:
		<span class="n">vcpu_rfi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ITR_D</span>:
		<span class="n">kvm_itr_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ITR_I</span>:
		<span class="n">kvm_itr_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTR_D</span>:
		<span class="n">kvm_ptr_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTR_I</span>:
		<span class="n">kvm_ptr_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ITC_D</span>:
		<span class="n">kvm_itc_d</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_ITC_I</span>:
		<span class="n">kvm_itc_i</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTC_L</span>:
		<span class="n">kvm_ptc_l</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTC_G</span>:
		<span class="n">kvm_ptc_g</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTC_GA</span>:
		<span class="n">kvm_ptc_ga</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_PTC_E</span>:
		<span class="n">kvm_ptc_e</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_RR</span>:
		<span class="n">kvm_mov_to_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_RR</span>:
		<span class="n">kvm_mov_from_rr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_THASH</span>:
		<span class="n">kvm_thash</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_TTAG</span>:
		<span class="n">kvm_ttag</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_TPA</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">kvm_tpa</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_TAK</span>:
		<span class="n">kvm_tak</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_AR_IMM</span>:
		<span class="n">kvm_mov_to_ar_imm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_AR</span>:
		<span class="n">kvm_mov_to_ar_reg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_AR</span>:
		<span class="n">kvm_mov_from_ar_reg</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_DBR</span>:
		<span class="n">kvm_mov_to_dbr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_IBR</span>:
		<span class="n">kvm_mov_to_ibr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_PMC</span>:
		<span class="n">kvm_mov_to_pmc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_PMD</span>:
		<span class="n">kvm_mov_to_pmd</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_TO_PKR</span>:
		<span class="n">kvm_mov_to_pkr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_DBR</span>:
		<span class="n">kvm_mov_from_dbr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_IBR</span>:
		<span class="n">kvm_mov_from_ibr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_PMC</span>:
		<span class="n">kvm_mov_from_pmc</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_PKR</span>:
		<span class="n">kvm_mov_from_pkr</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_MOV_FROM_CPUID</span>:
		<span class="n">kvm_mov_from_cpuid</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">inst</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENT_VMSW</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">IA64_FAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="cm">/*Assume all status is NO_FAULT ?*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">IA64_NO_FAULT</span> <span class="o">&amp;&amp;</span> <span class="n">cause</span> <span class="o">!=</span> <span class="n">EVENT_RFI</span><span class="p">)</span>
		<span class="n">vcpu_increment_iip</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>

	<span class="n">recover_if_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_vcpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">=</span> <span class="n">GUEST_IN_PHY</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vpsr</span><span class="p">)</span> <span class="o">=</span> <span class="n">IA64_PSR_BN</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">dcr</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* pta.size must not be 0.  The minimum is 15 (32k) */</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pta</span><span class="p">)</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itv</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">itm</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">last_itc</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">lid</span><span class="p">)</span> <span class="o">=</span> <span class="n">VCPU_LID</span><span class="p">(</span><span class="n">vcpu</span><span class="p">);</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">ivr</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">eoi</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">irr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">pmv</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">cmcv</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">lrr0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>   <span class="cm">/* default reset value? */</span>
	<span class="n">VCPU</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">lrr1</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>   <span class="cm">/* default reset value? */</span>
	<span class="n">update_vhpi</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">NULL_VECTOR</span><span class="p">);</span>
	<span class="n">VLSAPIC_XTP</span><span class="p">(</span><span class="n">vcpu</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>	<span class="cm">/* disabled */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">VLSAPIC_INSVC</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">kvm_init_all_rr</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>

	<span class="cm">/* WARNING: not allow co-exist of both virtual mode and physical</span>
<span class="cm">	 * mode in same region</span>
<span class="cm">	 */</span>

	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr0</span> <span class="o">=</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN0</span><span class="p">]));</span>
	<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr4</span> <span class="o">=</span> <span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN4</span><span class="p">]));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_physical_mode</span><span class="p">(</span><span class="n">vcpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">&amp;</span> <span class="n">GUEST_PHY_EMUL</span><span class="p">)</span>
			<span class="n">panic_vm</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="s">&quot;Machine Status conflicts!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN0</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_rr0</span><span class="p">);</span>
		<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
		<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN4</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_rr4</span><span class="p">);</span>
		<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN0</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr0</span><span class="p">);</span>
		<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
		<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN4</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
				<span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">metaphysical_saved_rr4</span><span class="p">);</span>
		<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN1</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
			<span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN1</span><span class="p">])));</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN2</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
			<span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN2</span><span class="p">])));</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN3</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
			<span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN3</span><span class="p">])));</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN5</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
			<span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN5</span><span class="p">])));</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="n">ia64_set_rr</span><span class="p">((</span><span class="n">VRN7</span> <span class="o">&lt;&lt;</span> <span class="n">VRN_SHIFT</span><span class="p">),</span>
			<span class="n">vrrtomrr</span><span class="p">(</span><span class="n">VMX</span><span class="p">(</span><span class="n">vcpu</span><span class="p">,</span> <span class="n">vrr</span><span class="p">[</span><span class="n">VRN7</span><span class="p">])));</span>
	<span class="n">ia64_dv_serialize_data</span><span class="p">();</span>
	<span class="n">ia64_srlz_d</span><span class="p">();</span>
	<span class="n">ia64_set_psr</span><span class="p">(</span><span class="n">psr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vmm_entry</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>

	<span class="n">ia64_call_vsa</span><span class="p">(</span><span class="n">PAL_VPS_RESTORE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">vpd</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kvm_init_vtlb</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">kvm_init_vhpt</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">init_vcpu</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">kvm_init_all_rr</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="n">vmm_reset_entry</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kvm_show_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">vcpu</span> <span class="o">=</span> <span class="n">current_vcpu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcpu</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;vcpu 0x%p vcpu %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">vcpu</span><span class="p">,</span> <span class="n">vcpu</span><span class="o">-&gt;</span><span class="n">vcpu_id</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;psr : %016lx ifs : %016lx ip  : [&lt;%016lx&gt;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;unat: %016lx pfs : %016lx rsc : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_unat</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_rsc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;rnat: %016lx bspstore: %016lx pr  : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ldrs: %016lx ccv : %016lx fpsr: %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">loadrs</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_ccv</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;csd : %016lx ssd : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_csd</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_ssd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;b0  : %016lx b6  : %016lx b7  : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">b6</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">b7</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;f6  : %05lx%016lx f7  : %05lx%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f7</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f7</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;f8  : %05lx%016lx f9  : %05lx%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f8</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f8</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f9</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f9</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;f10 : %05lx%016lx f11 : %05lx%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f10</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f10</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	       <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f11</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">f11</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r1  : %016lx r2  : %016lx r3  : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r8  : %016lx r9  : %016lx r10 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r8</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r9</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r10</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r11 : %016lx r12 : %016lx r13 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r11</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r12</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r13</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r14 : %016lx r15 : %016lx r16 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r14</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r15</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r17 : %016lx r18 : %016lx r19 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r17</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r18</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r19</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r20 : %016lx r21 : %016lx r22 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r20</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r21</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r22</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r23 : %016lx r24 : %016lx r25 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r23</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r24</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r25</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r26 : %016lx r27 : %016lx r28 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r26</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r27</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r28</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r29 : %016lx r30 : %016lx r31 : %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r29</span><span class="p">,</span>
							<span class="n">regs</span><span class="o">-&gt;</span><span class="n">r30</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">r31</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">panic_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">kvm_vcpu</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">kvm_pt_regs</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">vcpu_regs</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">exit_ctl_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">exit_data</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kvm_show_registers</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">exit_reason</span> <span class="o">=</span> <span class="n">EXIT_REASON_VM_PANIC</span><span class="p">;</span>
	<span class="n">vmm_transition</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
	<span class="cm">/*Never to return*/</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
