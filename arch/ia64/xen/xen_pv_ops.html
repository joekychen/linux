<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › xen › xen_pv_ops.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xen_pv_ops.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * arch/ia64/xen/xen_pv_ops.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Isaku Yamahata &lt;yamahata at valinux co jp&gt;</span>
<span class="cm"> *                    VA Linux Systems Japan K.K.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>

<span class="cp">#include &lt;asm/xen/hypervisor.h&gt;</span>
<span class="cp">#include &lt;asm/xen/xencomm.h&gt;</span>
<span class="cp">#include &lt;asm/xen/privop.h&gt;</span>

<span class="cp">#include &quot;irq_xen.h&quot;</span>
<span class="cp">#include &quot;time.h&quot;</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * general info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pv_info</span> <span class="n">xen_info</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">kernel_rpl</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* or 1: determin at runtime */</span>
	<span class="p">.</span><span class="n">paravirt_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Xen/ia64&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IA64_RSC_PL_SHIFT	2</span>
<span class="cp">#define IA64_RSC_PL_BIT_SIZE	2</span>
<span class="cp">#define IA64_RSC_PL_MASK	\</span>
<span class="cp">	(((1UL &lt;&lt; IA64_RSC_PL_BIT_SIZE) - 1) &lt;&lt; IA64_RSC_PL_SHIFT)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_info_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Xenified Linux/ia64 may run on pl = 1 or 2.</span>
<span class="cm">	 * determin at run time. */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rsc</span> <span class="o">=</span> <span class="n">ia64_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_RSC</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsc</span> <span class="o">&amp;</span> <span class="n">IA64_RSC_PL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">IA64_RSC_PL_SHIFT</span><span class="p">;</span>
	<span class="n">xen_info</span><span class="p">.</span><span class="n">kernel_rpl</span> <span class="o">=</span> <span class="n">rpl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_init_ops</span>
<span class="cm"> * initialization hooks.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_panic_hypercall</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ksp</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">HYPERVISOR_shutdown</span><span class="p">(</span><span class="n">SHUTDOWN_crash</span><span class="p">);</span>
	<span class="cm">/* we&#39;re never actually going to get here... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xen_panic_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unw_init_running</span><span class="p">(</span><span class="n">xen_panic_hypercall</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* we&#39;re never actually going to get here... */</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">xen_panic_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">xen_panic_event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* try to go last */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_pm_power_off</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">HYPERVISOR_shutdown</span><span class="p">(</span><span class="n">SHUTDOWN_poweroff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;Running on Xen! pl = %d start_info_pfn=0x%lx nr_pages=%ld &quot;</span>
	       <span class="s">&quot;flags=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">xen_info</span><span class="p">.</span><span class="n">kernel_rpl</span><span class="p">,</span>
	       <span class="n">HYPERVISOR_shared_info</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">start_info_pfn</span><span class="p">,</span>
	       <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">nr_pages</span><span class="p">,</span> <span class="n">xen_start_info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">xen_reserve_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">rsvd_region</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span>
		<span class="p">(</span><span class="n">HYPERVISOR_shared_info</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">start_info_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">));</span>
	<span class="n">region</span><span class="o">-&gt;</span><span class="n">end</span>   <span class="o">=</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_arch_setup_early</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">shared_info</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">xen_pv_domain</span><span class="p">());</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">HYPERVISOR_shared_info</span><span class="p">;</span>
	<span class="n">xen_start_info</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">arch</span><span class="p">.</span><span class="n">start_info_pfn</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Must be done before any hypercall.  */</span>
	<span class="n">xencomm_initialize</span><span class="p">();</span>

	<span class="n">xen_setup_features</span><span class="p">();</span>
	<span class="cm">/* Register a call for panic conditions. */</span>
	<span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">panic_notifier_list</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">xen_panic_block</span><span class="p">);</span>
	<span class="n">pm_power_off</span> <span class="o">=</span> <span class="n">xen_pm_power_off</span><span class="p">;</span>

	<span class="n">xen_ia64_enable_opt_feature</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_arch_setup_console</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmdline_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;xenboot&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;tty&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="cm">/* use hvc_xen */</span>
	<span class="n">add_preferred_console</span><span class="p">(</span><span class="s">&quot;hvc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#if !defined(CONFIG_VT) || !defined(CONFIG_DUMMY_CONSOLE)</span>
	<span class="n">conswitchp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">xen_arch_setup_nomca</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_post_smp_prepare_boot_cpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_setup_vcpu_info_placement</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef ASM_SUPPORTED</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init_or_module</span>
<span class="n">xen_patch_bundle</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sbundle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ebundle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="n">xen_patch_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_init_ops</span> <span class="n">xen_init_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">banner</span> <span class="o">=</span> <span class="n">xen_banner</span><span class="p">,</span>

	<span class="p">.</span><span class="n">reserve_memory</span> <span class="o">=</span> <span class="n">xen_reserve_memory</span><span class="p">,</span>

	<span class="p">.</span><span class="n">arch_setup_early</span> <span class="o">=</span> <span class="n">xen_arch_setup_early</span><span class="p">,</span>
	<span class="p">.</span><span class="n">arch_setup_console</span> <span class="o">=</span> <span class="n">xen_arch_setup_console</span><span class="p">,</span>
	<span class="p">.</span><span class="n">arch_setup_nomca</span> <span class="o">=</span> <span class="n">xen_arch_setup_nomca</span><span class="p">,</span>

	<span class="p">.</span><span class="n">post_smp_prepare_boot_cpu</span> <span class="o">=</span> <span class="n">xen_post_smp_prepare_boot_cpu</span><span class="p">,</span>
<span class="cp">#ifdef ASM_SUPPORTED</span>
	<span class="p">.</span><span class="n">patch_bundle</span> <span class="o">=</span> <span class="n">xen_patch_bundle</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">patch_branch</span> <span class="o">=</span> <span class="n">xen_patch_branch</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_fsys_data</span>
<span class="cm"> * addresses for fsys</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xen_fsyscall_table</span><span class="p">[</span><span class="n">NR_syscalls</span><span class="p">];</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">xen_fsys_bubble_down</span><span class="p">[];</span>
<span class="k">struct</span> <span class="n">pv_fsys_data</span> <span class="n">xen_fsys_data</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fsyscall_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">xen_fsyscall_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fsys_bubble_down</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">xen_fsys_bubble_down</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_patchdata</span>
<span class="cm"> * patchdata addresses</span>
<span class="cm"> */</span>

<span class="cp">#define DECLARE(name)							\</span>
<span class="cp">	extern unsigned long __xen_start_gate_##name##_patchlist[];	\</span>
<span class="cp">	extern unsigned long __xen_end_gate_##name##_patchlist[]</span>

<span class="n">DECLARE</span><span class="p">(</span><span class="n">fsyscall</span><span class="p">);</span>
<span class="n">DECLARE</span><span class="p">(</span><span class="n">brl_fsys_bubble_down</span><span class="p">);</span>
<span class="n">DECLARE</span><span class="p">(</span><span class="n">vtop</span><span class="p">);</span>
<span class="n">DECLARE</span><span class="p">(</span><span class="n">mckinley_e9</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__xen_start_gate_section</span><span class="p">[];</span>

<span class="cp">#define ASSIGN(name)							\</span>
<span class="cp">	.start_##name##_patchlist =					\</span>
<span class="cp">		(unsigned long)__xen_start_gate_##name##_patchlist,	\</span>
<span class="cp">	.end_##name##_patchlist =					\</span>
<span class="cp">		(unsigned long)__xen_end_gate_##name##_patchlist</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pv_patchdata</span> <span class="n">xen_patchdata</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ASSIGN</span><span class="p">(</span><span class="n">fsyscall</span><span class="p">),</span>
	<span class="n">ASSIGN</span><span class="p">(</span><span class="n">brl_fsys_bubble_down</span><span class="p">),</span>
	<span class="n">ASSIGN</span><span class="p">(</span><span class="n">vtop</span><span class="p">),</span>
	<span class="n">ASSIGN</span><span class="p">(</span><span class="n">mckinley_e9</span><span class="p">),</span>

	<span class="p">.</span><span class="n">gate_section</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">__xen_start_gate_section</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_cpu_ops</span>
<span class="cm"> * intrinsics hooks.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef ASM_SUPPORTED</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_set_itm_with_offset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ia64_cpu_local_tick() calls this with interrupt enabled. */</span>
	<span class="cm">/* WARN_ON(!irqs_disabled()); */</span>
	<span class="n">xen_set_itm</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">xen_get_itm_with_offset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unused at this moment */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s is called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="k">return</span> <span class="n">ia64_native_getreg</span><span class="p">(</span><span class="n">_IA64_REG_CR_ITM</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ia64_set_itc() is only called by</span>
<span class="cm"> * cpu_init() with ia64_set_itc(0) and ia64_sync_itc().</span>
<span class="cm"> * So XEN_MAPPEDRESG-&gt;itc_offset cal be considered as almost constant.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_set_itc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mitc</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">mitc</span> <span class="o">=</span> <span class="n">ia64_native_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_ITC</span><span class="p">);</span>
	<span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_offset</span> <span class="o">=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">mitc</span><span class="p">;</span>
	<span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_last</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">xen_get_itc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itc_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itc_last</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret_itc_last</span><span class="p">;</span>

	<span class="n">itc_offset</span> <span class="o">=</span> <span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_offset</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">itc_last</span> <span class="o">=</span> <span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_last</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ia64_native_getreg</span><span class="p">(</span><span class="n">_IA64_REG_AR_ITC</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">itc_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itc_last</span> <span class="o">&gt;=</span> <span class="n">res</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">itc_last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret_itc_last</span> <span class="o">=</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">XEN_MAPPEDREGS</span><span class="o">-&gt;</span><span class="n">itc_last</span><span class="p">,</span>
				       <span class="n">itc_last</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret_itc_last</span> <span class="o">!=</span> <span class="n">itc_last</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* ia64_itc_udelay() calls ia64_get_itc() with interrupt enabled.</span>
<span class="c">	   Should it be paravirtualized instead? */</span>
<span class="c">	WARN_ON(!irqs_disabled());</span>
<span class="c">	itc_offset = XEN_MAPPEDREGS-&gt;itc_offset;</span>
<span class="c">	itc_last = XEN_MAPPEDREGS-&gt;itc_last;</span>
<span class="c">	res = ia64_native_getreg(_IA64_REG_AR_ITC);</span>
<span class="c">	res += itc_offset;</span>
<span class="c">	if (itc_last &gt;= res)</span>
<span class="c">		res = itc_last + 1;</span>
<span class="c">	XEN_MAPPEDREGS-&gt;itc_last = res;</span>
<span class="c">	return res;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">xen_setreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">_IA64_REG_AR_KR0</span> <span class="p">...</span> <span class="n">_IA64_REG_AR_KR7</span>:
		<span class="n">xen_set_kr</span><span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="n">_IA64_REG_AR_KR0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_AR_ITC</span>:
		<span class="n">xen_set_itc</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_TPR</span>:
		<span class="n">xen_set_tpr</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_ITM</span>:
		<span class="n">xen_set_itm_with_offset</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_EOI</span>:
		<span class="n">xen_eoi</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ia64_native_setreg_func</span><span class="p">(</span><span class="n">regnum</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">xen_getreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">regnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">_IA64_REG_PSR</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">xen_get_psr</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_AR_ITC</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">xen_get_itc</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_ITM</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">xen_get_itm_with_offset</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_IVR</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">xen_get_ivr</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">_IA64_REG_CR_TPR</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">xen_get_tpr</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ia64_native_getreg_func</span><span class="p">(</span><span class="n">regnum</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* turning on interrupts is a bit more complicated.. write to the</span>
<span class="cm"> * memory-mapped virtual psr.i bit first (to avoid race condition),</span>
<span class="cm"> * then if any interrupts were pending, we have to execute a hyperprivop</span>
<span class="cm"> * to ensure the pending interrupt gets delivered; else we&#39;re done! */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_ssm_i</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">xen_get_virtual_psr_i</span><span class="p">();</span>
	<span class="n">xen_set_virtual_psr_i</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span> <span class="o">&amp;&amp;</span> <span class="n">xen_get_virtual_pend</span><span class="p">())</span>
		<span class="n">xen_hyper_ssm_i</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* turning off interrupts can be paravirtualized simply by writing</span>
<span class="cm"> * to a memory-mapped virtual psr.i bit (implemented as a 16-bit bool) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_rsm_i</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_set_virtual_psr_i</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">xen_get_psr_i</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xen_get_virtual_psr_i</span><span class="p">()</span> <span class="o">?</span> <span class="n">IA64_PSR_I</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_intrin_local_irq_restore</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_I</span><span class="p">)</span>
		<span class="n">xen_ssm_i</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">xen_rsm_i</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define __DEFINE_FUNC(name, code)					\</span>
<span class="cp">	extern const char xen_ ## name ## _direct_start[];		\</span>
<span class="cp">	extern const char xen_ ## name ## _direct_end[];		\</span>
<span class="cp">	asm (&quot;.align 32\n&quot;						\</span>
<span class="cp">	     &quot;.proc xen_&quot; #name &quot;\n&quot;					\</span>
<span class="cp">	     &quot;xen_&quot; #name &quot;:\n&quot;						\</span>
<span class="cp">	     &quot;xen_&quot; #name &quot;_direct_start:\n&quot;				\</span>
<span class="cp">	     code							\</span>
<span class="cp">	     &quot;xen_&quot; #name &quot;_direct_end:\n&quot;				\</span>
<span class="cp">	     &quot;br.cond.sptk.many b6\n&quot;					\</span>
<span class="cp">	     &quot;.endp xen_&quot; #name &quot;\n&quot;)</span>

<span class="cp">#define DEFINE_VOID_FUNC0(name, code)		\</span>
<span class="cp">	extern void				\</span>
<span class="cp">	xen_ ## name (void);			\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define DEFINE_VOID_FUNC1(name, code)		\</span>
<span class="cp">	extern void				\</span>
<span class="cp">	xen_ ## name (unsigned long arg);	\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define DEFINE_VOID_FUNC1_VOID(name, code)	\</span>
<span class="cp">	extern void				\</span>
<span class="cp">	xen_ ## name (void *arg);		\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define DEFINE_VOID_FUNC2(name, code)		\</span>
<span class="cp">	extern void				\</span>
<span class="cp">	xen_ ## name (unsigned long arg0,	\</span>
<span class="cp">		      unsigned long arg1);	\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define DEFINE_FUNC0(name, code)		\</span>
<span class="cp">	extern unsigned long			\</span>
<span class="cp">	xen_ ## name (void);			\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define DEFINE_FUNC1(name, type, code)		\</span>
<span class="cp">	extern unsigned long			\</span>
<span class="cp">	xen_ ## name (type arg);		\</span>
<span class="cp">	__DEFINE_FUNC(name, code)</span>

<span class="cp">#define XEN_PSR_I_ADDR_ADDR     (XSI_BASE + XSI_PSR_I_ADDR_OFS)</span>

<span class="cm">/*</span>
<span class="cm"> * static void xen_set_itm_with_offset(unsigned long val)</span>
<span class="cm"> *        xen_set_itm(val - XEN_MAPPEDREGS-&gt;itc_offset);</span>
<span class="cm"> */</span>
<span class="cm">/* 2 bundles */</span>
<span class="n">DEFINE_VOID_FUNC1</span><span class="p">(</span><span class="n">set_itm_with_offset</span><span class="p">,</span>
		  <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_BASE</span><span class="p">)</span> <span class="s">&quot; + &quot;</span>
		  <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_OFFSET_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;ld8 r3 = [r2]</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;sub r8 = r8, r3</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SET_ITM</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * static unsigned long xen_get_itm_with_offset(void)</span>
<span class="cm"> *    return ia64_native_getreg(_IA64_REG_CR_ITM) + XEN_MAPPEDREGS-&gt;itc_offset;</span>
<span class="cm"> */</span>
<span class="cm">/* 2 bundles */</span>
<span class="n">DEFINE_FUNC0</span><span class="p">(</span><span class="n">get_itm_with_offset</span><span class="p">,</span>
	     <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_BASE</span><span class="p">)</span> <span class="s">&quot; + &quot;</span>
	     <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_OFFSET_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;ld8 r3 = [r2]</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;mov r8 = cr.itm</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;add r8 = r8, r2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * static void xen_set_itc(unsigned long val)</span>
<span class="cm"> *	unsigned long mitc;</span>
<span class="cm"> *</span>
<span class="cm"> *	WARN_ON(!irqs_disabled());</span>
<span class="cm"> *	mitc = ia64_native_getreg(_IA64_REG_AR_ITC);</span>
<span class="cm"> *	XEN_MAPPEDREGS-&gt;itc_offset = val - mitc;</span>
<span class="cm"> *	XEN_MAPPEDREGS-&gt;itc_last = val;</span>
<span class="cm"> */</span>
<span class="cm">/* 2 bundles */</span>
<span class="n">DEFINE_VOID_FUNC1</span><span class="p">(</span><span class="n">set_itc</span><span class="p">,</span>
		  <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_BASE</span><span class="p">)</span> <span class="s">&quot; + &quot;</span>
		  <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_LAST_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;mov r3 = ar.itc</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;sub r3 = r8, r3</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;st8 [r2] = r8, &quot;</span>
		  <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_LAST_OFS</span><span class="p">)</span> <span class="s">&quot; - &quot;</span>
		  <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_OFFSET_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;st8 [r2] = r3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * static unsigned long xen_get_itc(void)</span>
<span class="cm"> *	unsigned long res;</span>
<span class="cm"> *	unsigned long itc_offset;</span>
<span class="cm"> *	unsigned long itc_last;</span>
<span class="cm"> *	unsigned long ret_itc_last;</span>
<span class="cm"> *</span>
<span class="cm"> *	itc_offset = XEN_MAPPEDREGS-&gt;itc_offset;</span>
<span class="cm"> *	do {</span>
<span class="cm"> *		itc_last = XEN_MAPPEDREGS-&gt;itc_last;</span>
<span class="cm"> *		res = ia64_native_getreg(_IA64_REG_AR_ITC);</span>
<span class="cm"> *		res += itc_offset;</span>
<span class="cm"> *		if (itc_last &gt;= res)</span>
<span class="cm"> *			res = itc_last + 1;</span>
<span class="cm"> *		ret_itc_last = cmpxchg(&amp;XEN_MAPPEDREGS-&gt;itc_last,</span>
<span class="cm"> *				       itc_last, res);</span>
<span class="cm"> *	} while (unlikely(ret_itc_last != itc_last));</span>
<span class="cm"> *	return res;</span>
<span class="cm"> */</span>
<span class="cm">/* 5 bundles */</span>
<span class="n">DEFINE_FUNC0</span><span class="p">(</span><span class="n">get_itc</span><span class="p">,</span>
	     <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_BASE</span><span class="p">)</span> <span class="s">&quot; + &quot;</span>
	     <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_OFFSET_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;ld8 r9 = [r2], &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_LAST_OFS</span><span class="p">)</span> <span class="s">&quot; - &quot;</span>
	     <span class="n">__stringify</span><span class="p">(</span><span class="n">XSI_ITC_OFFSET_OFS</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="cm">/* r9 = itc_offset */</span>
					<span class="cm">/* r2 = XSI_ITC_OFFSET */</span>
	     <span class="s">&quot;888:</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;mov r8 = ar.itc</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* res = ar.itc */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;ld8 r3 = [r2]</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r3 = itc_last */</span>
	     <span class="s">&quot;add r8 = r8, r9</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* res = ar.itc + itc_offset */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;cmp.gtu p6, p0 = r3, r8</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;(p6) add r8 = 1, r3</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* if (itc_last &gt; res) itc_last + 1 */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;mov ar.ccv = r8</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;cmpxchg8.acq r10 = [r2], r8, ar.ccv</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;cmp.ne p6, p0 = r10, r3</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;(p6) hint @pause</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;(p6) br.cond.spnt 888b</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">DEFINE_VOID_FUNC1_VOID</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span>
		       <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_FC</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * psr_i_addr_addr = XEN_PSR_I_ADDR_ADDR</span>
<span class="cm"> * masked_addr = *psr_i_addr_addr</span>
<span class="cm"> * pending_intr_addr = masked_addr - 1</span>
<span class="cm"> * if (val &amp; IA64_PSR_I) {</span>
<span class="cm"> *   masked = *masked_addr</span>
<span class="cm"> *   *masked_addr = 0:xen_set_virtual_psr_i(1)</span>
<span class="cm"> *   compiler barrier</span>
<span class="cm"> *   if (masked) {</span>
<span class="cm"> *      uint8_t pending = *pending_intr_addr;</span>
<span class="cm"> *      if (pending)</span>
<span class="cm"> *              XEN_HYPER_SSM_I</span>
<span class="cm"> *   }</span>
<span class="cm"> * } else {</span>
<span class="cm"> *   *masked_addr = 1:xen_set_virtual_psr_i(0)</span>
<span class="cm"> * }</span>
<span class="cm"> */</span>
<span class="cm">/* 6 bundles */</span>
<span class="n">DEFINE_VOID_FUNC1</span><span class="p">(</span><span class="n">intrin_local_irq_restore</span><span class="p">,</span>
		  <span class="cm">/* r8 = input value: 0 or IA64_PSR_I</span>
<span class="cm">		   * p6 =  (flags &amp; IA64_PSR_I)</span>
<span class="cm">		   *    = if clause</span>
<span class="cm">		   * p7 = !(flags &amp; IA64_PSR_I)</span>
<span class="cm">		   *    = else clause</span>
<span class="cm">		   */</span>
		  <span class="s">&quot;cmp.ne p6, p7 = r8, r0</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;mov r9 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XEN_PSR_I_ADDR_ADDR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* r9 = XEN_PSR_I_ADDR */</span>
		  <span class="s">&quot;ld8 r9 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>

		  <span class="cm">/* r10 = masked previous value */</span>
		  <span class="s">&quot;(p6)	ld1.acq r10 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>

		  <span class="cm">/* p8 = !masked interrupt masked previously? */</span>
		  <span class="s">&quot;(p6)	cmp.ne.unc p8, p0 = r10, r0</span><span class="se">\n</span><span class="s">&quot;</span>

		  <span class="cm">/* p7 = else clause */</span>
		  <span class="s">&quot;(p7)	mov r11 = 1</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* masked = 1 */</span>
		  <span class="s">&quot;(p7)	st1.rel [r9] = r11</span><span class="se">\n</span><span class="s">&quot;</span>

		  <span class="cm">/* p6 = if clause */</span>
		  <span class="cm">/* masked = 0</span>
<span class="cm">		   * r9 = masked_addr - 1</span>
<span class="cm">		   *    = pending_intr_addr</span>
<span class="cm">		   */</span>
		  <span class="s">&quot;(p8)	st1.rel [r9] = r0, -1</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* r8 = pending_intr */</span>
		  <span class="s">&quot;(p8)	ld1.acq r11 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* p9 = interrupt pending? */</span>
		  <span class="s">&quot;(p8)	cmp.ne.unc p9, p10 = r11, r0</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;(p10) mf</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* issue hypercall to trigger interrupt */</span>
		  <span class="s">&quot;(p9)	break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SSM_I</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">DEFINE_VOID_FUNC2</span><span class="p">(</span><span class="n">ptcga</span><span class="p">,</span>
		  <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_PTC_GA</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">DEFINE_VOID_FUNC2</span><span class="p">(</span><span class="n">set_rr</span><span class="p">,</span>
		  <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SET_RR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * tmp = XEN_MAPPEDREGS-&gt;interrupt_mask_addr = XEN_PSR_I_ADDR_ADDR;</span>
<span class="cm"> * tmp = *tmp</span>
<span class="cm"> * tmp = *tmp;</span>
<span class="cm"> * psr_i = tmp? 0: IA64_PSR_I;</span>
<span class="cm"> */</span>
<span class="cm">/* 4 bundles */</span>
<span class="n">DEFINE_FUNC0</span><span class="p">(</span><span class="n">get_psr_i</span><span class="p">,</span>
	     <span class="s">&quot;mov r9 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XEN_PSR_I_ADDR_ADDR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;ld8 r9 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>			<span class="cm">/* r9 = XEN_PSR_I_ADDR */</span>
	     <span class="s">&quot;mov r8 = 0</span><span class="se">\n</span><span class="s">&quot;</span>			<span class="cm">/* psr_i = 0 */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;ld1.acq r9 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r9 = XEN_PSR_I */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;cmp.eq.unc p6, p0 = r9, r0</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* p6 = (XEN_PSR_I != 0) */</span>
	     <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	     <span class="s">&quot;(p6) mov r8 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IA64_PSR_I_BIT</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="n">DEFINE_FUNC1</span><span class="p">(</span><span class="n">thash</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
	     <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_THASH</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">DEFINE_FUNC1</span><span class="p">(</span><span class="n">get_cpuid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
	     <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_GET_CPUID</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">DEFINE_FUNC1</span><span class="p">(</span><span class="n">get_pmd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
	     <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_GET_PMD</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">DEFINE_FUNC1</span><span class="p">(</span><span class="n">get_rr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
	     <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_GET_RR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * void xen_privop_ssm_i(void)</span>
<span class="cm"> *</span>
<span class="cm"> * int masked = !xen_get_virtual_psr_i();</span>
<span class="cm"> *	// masked = *(*XEN_MAPPEDREGS-&gt;interrupt_mask_addr)</span>
<span class="cm"> * xen_set_virtual_psr_i(1)</span>
<span class="cm"> *	// *(*XEN_MAPPEDREGS-&gt;interrupt_mask_addr) = 0</span>
<span class="cm"> * // compiler barrier</span>
<span class="cm"> * if (masked) {</span>
<span class="cm"> *	uint8_t* pend_int_addr =</span>
<span class="cm"> *		(uint8_t*)(*XEN_MAPPEDREGS-&gt;interrupt_mask_addr) - 1;</span>
<span class="cm"> *	uint8_t pending = *pend_int_addr;</span>
<span class="cm"> *	if (pending)</span>
<span class="cm"> *		XEN_HYPER_SSM_I</span>
<span class="cm"> * }</span>
<span class="cm"> */</span>
<span class="cm">/* 4 bundles */</span>
<span class="n">DEFINE_VOID_FUNC0</span><span class="p">(</span><span class="n">ssm_i</span><span class="p">,</span>
		  <span class="s">&quot;mov r8 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XEN_PSR_I_ADDR_ADDR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;ld8 r8 = [r8]</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r8 = XEN_PSR_I_ADDR */</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;ld1.acq r9 = [r8]</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r9 = XEN_PSR_I */</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;st1.rel [r8] = r0, -1</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* psr_i = 0. enable interrupt</span>
<span class="cm">						 * r8 = XEN_PSR_I_ADDR - 1</span>
<span class="cm">						 *    = pend_int_addr</span>
<span class="cm">						 */</span>
		  <span class="s">&quot;cmp.eq.unc p0, p6 = r9, r0</span><span class="se">\n</span><span class="s">&quot;</span><span class="cm">/* p6 = !XEN_PSR_I</span>
<span class="cm">						 * previously interrupt</span>
<span class="cm">						 * masked?</span>
<span class="cm">						 */</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;(p6) ld1.acq r8 = [r8]</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/* r8 = xen_pend_int */</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;(p6) cmp.eq.unc p6, p7 = r8, r0</span><span class="se">\n</span><span class="s">&quot;</span>	<span class="cm">/*interrupt pending?*/</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="cm">/* issue hypercall to get interrupt */</span>
		  <span class="s">&quot;(p7) break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SSM_I</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * psr_i_addr_addr = XEN_MAPPEDREGS-&gt;interrupt_mask_addr</span>
<span class="cm"> *		   = XEN_PSR_I_ADDR_ADDR;</span>
<span class="cm"> * psr_i_addr = *psr_i_addr_addr;</span>
<span class="cm"> * *psr_i_addr = 1;</span>
<span class="cm"> */</span>
<span class="cm">/* 2 bundles */</span>
<span class="n">DEFINE_VOID_FUNC0</span><span class="p">(</span><span class="n">rsm_i</span><span class="p">,</span>
		  <span class="s">&quot;mov r8 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">XEN_PSR_I_ADDR_ADDR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
						<span class="cm">/* r8 = XEN_PSR_I_ADDR */</span>
		  <span class="s">&quot;mov r9 = 1</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;ld8 r8 = [r8]</span><span class="se">\n</span><span class="s">&quot;</span>		<span class="cm">/* r8 = XEN_PSR_I */</span>
		  <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		  <span class="s">&quot;st1.rel [r8] = r9</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>	<span class="cm">/* XEN_PSR_I = 1 */</span>

<span class="k">extern</span> <span class="kt">void</span>
<span class="n">xen_set_rr0_to_rr4</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val1</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val3</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val4</span><span class="p">);</span>
<span class="n">__DEFINE_FUNC</span><span class="p">(</span><span class="n">set_rr0_to_rr4</span><span class="p">,</span>
	      <span class="s">&quot;break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SET_RR0_TO_RR4</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xen_getreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">regnum</span><span class="p">);</span>
<span class="cp">#define __DEFINE_GET_REG(id, privop)					\</span>
<span class="cp">	&quot;mov r2 = &quot; __stringify(_IA64_REG_ ## id) &quot;\n&quot;			\</span>
<span class="cp">	&quot;;;\n&quot;								\</span>
<span class="cp">	&quot;cmp.eq p6, p0 = r2, r8\n&quot;					\</span>
<span class="cp">	&quot;;;\n&quot;								\</span>
<span class="cp">	&quot;(p6) break &quot; __stringify(HYPERPRIVOP_GET_ ## privop) &quot;\n&quot;	\</span>
<span class="cp">	&quot;(p6) br.cond.sptk.many b6\n&quot;					\</span>
<span class="cp">	&quot;;;\n&quot;</span>

<span class="n">__DEFINE_FUNC</span><span class="p">(</span><span class="n">getreg</span><span class="p">,</span>
	      <span class="n">__DEFINE_GET_REG</span><span class="p">(</span><span class="n">PSR</span><span class="p">,</span> <span class="n">PSR</span><span class="p">)</span>

	      <span class="cm">/* get_itc */</span>
	      <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_AR_ITC</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;cmp.eq p6, p0 = r2, r8</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p6) br.cond.spnt xen_get_itc</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>

	      <span class="cm">/* get itm */</span>
	      <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_CR_ITM</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;cmp.eq p6, p0 = r2, r8</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p6) br.cond.spnt xen_get_itm_with_offset</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>

	      <span class="n">__DEFINE_GET_REG</span><span class="p">(</span><span class="n">CR_IVR</span><span class="p">,</span> <span class="n">IVR</span><span class="p">)</span>
	      <span class="n">__DEFINE_GET_REG</span><span class="p">(</span><span class="n">CR_TPR</span><span class="p">,</span> <span class="n">TPR</span><span class="p">)</span>

	      <span class="cm">/* fall back */</span>
	      <span class="s">&quot;movl r2 = ia64_native_getreg_func</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;mov b7 = r2</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;br.cond.sptk.many b7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">xen_setreg</span><span class="p">(</span><span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#define __DEFINE_SET_REG(id, privop)					\</span>
<span class="cp">	&quot;mov r2 = &quot; __stringify(_IA64_REG_ ## id) &quot;\n&quot;			\</span>
<span class="cp">	&quot;;;\n&quot;								\</span>
<span class="cp">	&quot;cmp.eq p6, p0 = r2, r9\n&quot;					\</span>
<span class="cp">	&quot;;;\n&quot;								\</span>
<span class="cp">	&quot;(p6) break &quot; __stringify(HYPERPRIVOP_ ## privop) &quot;\n&quot;		\</span>
<span class="cp">	&quot;(p6) br.cond.sptk.many b6\n&quot;					\</span>
<span class="cp">	&quot;;;\n&quot;</span>

<span class="n">__DEFINE_FUNC</span><span class="p">(</span><span class="n">setreg</span><span class="p">,</span>
	      <span class="cm">/* kr0 .. kr 7*/</span>
	      <span class="cm">/*</span>
<span class="cm">	       * if (_IA64_REG_AR_KR0 &lt;= regnum &amp;&amp;</span>
<span class="cm">	       *     regnum &lt;= _IA64_REG_AR_KR7) {</span>
<span class="cm">	       *     register __index asm (&quot;r8&quot;) = regnum - _IA64_REG_AR_KR0</span>
<span class="cm">	       *     register __val asm (&quot;r9&quot;) = val</span>
<span class="cm">	       *    &quot;break HYPERPRIVOP_SET_KR&quot;</span>
<span class="cm">	       * }</span>
<span class="cm">	       */</span>
	      <span class="s">&quot;mov r17 = r9</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_AR_KR0</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;cmp.ge p6, p0 = r9, r2</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;sub r17 = r17, r2</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p6) cmp.ge.unc p7, p0 = &quot;</span>
	      <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_AR_KR7</span><span class="p">)</span> <span class="s">&quot; - &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_AR_KR0</span><span class="p">)</span>
	      <span class="s">&quot;, r17</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p7) mov r9 = r8</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p7) mov r8 = r17</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p7) break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SET_KR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>

	      <span class="cm">/* set itm */</span>
	      <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_CR_ITM</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;cmp.eq p6, p0 = r2, r8</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p6) br.cond.spnt xen_set_itm_with_offset</span><span class="se">\n</span><span class="s">&quot;</span>

	      <span class="cm">/* set itc */</span>
	      <span class="s">&quot;mov r2 = &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">_IA64_REG_AR_ITC</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;cmp.eq p6, p0 = r2, r8</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;(p6) br.cond.spnt xen_set_itc</span><span class="se">\n</span><span class="s">&quot;</span>

	      <span class="n">__DEFINE_SET_REG</span><span class="p">(</span><span class="n">CR_TPR</span><span class="p">,</span> <span class="n">SET_TPR</span><span class="p">)</span>
	      <span class="n">__DEFINE_SET_REG</span><span class="p">(</span><span class="n">CR_EOI</span><span class="p">,</span> <span class="n">EOI</span><span class="p">)</span>

	      <span class="cm">/* fall back */</span>
	      <span class="s">&quot;movl r2 = ia64_native_setreg_func</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;mov b7 = r2</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="s">&quot;br.cond.sptk.many b7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pv_cpu_ops</span> <span class="n">xen_cpu_ops</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fc</span>		<span class="o">=</span> <span class="n">xen_fc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thash</span>		<span class="o">=</span> <span class="n">xen_thash</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_cpuid</span>	<span class="o">=</span> <span class="n">xen_get_cpuid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_pmd</span>	<span class="o">=</span> <span class="n">xen_get_pmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getreg</span>		<span class="o">=</span> <span class="n">xen_getreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setreg</span>		<span class="o">=</span> <span class="n">xen_setreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ptcga</span>		<span class="o">=</span> <span class="n">xen_ptcga</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rr</span>		<span class="o">=</span> <span class="n">xen_get_rr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rr</span>		<span class="o">=</span> <span class="n">xen_set_rr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rr0_to_rr4</span>	<span class="o">=</span> <span class="n">xen_set_rr0_to_rr4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ssm_i</span>		<span class="o">=</span> <span class="n">xen_ssm_i</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rsm_i</span>		<span class="o">=</span> <span class="n">xen_rsm_i</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_psr_i</span>	<span class="o">=</span> <span class="n">xen_get_psr_i</span><span class="p">,</span>
	<span class="p">.</span><span class="n">intrin_local_irq_restore</span>
			<span class="o">=</span> <span class="n">xen_intrin_local_irq_restore</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> * replacement of hand written assembly codes.</span>
<span class="cm"> */</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="n">xen_switch_to</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">xen_leave_syscall</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">xen_work_processed_syscall</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">char</span> <span class="n">xen_leave_kernel</span><span class="p">;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">pv_cpu_asm_switch</span> <span class="n">xen_cpu_asm_switch</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">switch_to</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xen_switch_to</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_syscall</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xen_leave_syscall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">work_processed_syscall</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xen_work_processed_syscall</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_kernel</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">xen_leave_kernel</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_iosapic_ops</span>
<span class="cm"> * iosapic read/write hooks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_pcat_compat_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irq_chip</span><span class="o">*</span>
<span class="nf">xen_iosapic_get_irq_chip</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">xen_iosapic_read</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iosapic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">physdev_apic</span> <span class="n">apic_op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">apic_op</span><span class="p">.</span><span class="n">apic_physbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iosapic</span> <span class="o">-</span>
					<span class="n">__IA64_UNCACHED_OFFSET</span><span class="p">;</span>
	<span class="n">apic_op</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_apic_read</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apic_op</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">apic_op</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xen_iosapic_write</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iosapic</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">physdev_apic</span> <span class="n">apic_op</span><span class="p">;</span>

	<span class="n">apic_op</span><span class="p">.</span><span class="n">apic_physbase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iosapic</span> <span class="o">-</span>
					<span class="n">__IA64_UNCACHED_OFFSET</span><span class="p">;</span>
	<span class="n">apic_op</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">apic_op</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">HYPERVISOR_physdev_op</span><span class="p">(</span><span class="n">PHYSDEVOP_apic_write</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apic_op</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pv_iosapic_ops</span> <span class="n">xen_iosapic_ops</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">pcat_compat_init</span> <span class="o">=</span> <span class="n">xen_pcat_compat_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">__get_irq_chip</span> <span class="o">=</span> <span class="n">xen_iosapic_get_irq_chip</span><span class="p">,</span>

	<span class="p">.</span><span class="n">__read</span> <span class="o">=</span> <span class="n">xen_iosapic_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">__write</span> <span class="o">=</span> <span class="n">xen_iosapic_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************</span>
<span class="cm"> * pv_ops initialization</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_setup_pv_ops</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xen_info_init</span><span class="p">();</span>
	<span class="n">pv_info</span> <span class="o">=</span> <span class="n">xen_info</span><span class="p">;</span>
	<span class="n">pv_init_ops</span> <span class="o">=</span> <span class="n">xen_init_ops</span><span class="p">;</span>
	<span class="n">pv_fsys_data</span> <span class="o">=</span> <span class="n">xen_fsys_data</span><span class="p">;</span>
	<span class="n">pv_patchdata</span> <span class="o">=</span> <span class="n">xen_patchdata</span><span class="p">;</span>
	<span class="n">pv_cpu_ops</span> <span class="o">=</span> <span class="n">xen_cpu_ops</span><span class="p">;</span>
	<span class="n">pv_iosapic_ops</span> <span class="o">=</span> <span class="n">xen_iosapic_ops</span><span class="p">;</span>
	<span class="n">pv_irq_ops</span> <span class="o">=</span> <span class="n">xen_irq_ops</span><span class="p">;</span>
	<span class="n">pv_time_ops</span> <span class="o">=</span> <span class="n">xen_time_ops</span><span class="p">;</span>

	<span class="n">paravirt_cpu_asm_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xen_cpu_asm_switch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef ASM_SUPPORTED</span>
<span class="cm">/***************************************************************************</span>
<span class="cm"> * binary pacthing</span>
<span class="cm"> * pv_init_ops.patch_bundle</span>
<span class="cm"> */</span>

<span class="cp">#define DEFINE_FUNC_GETREG(name, privop)				\</span>
<span class="cp">	DEFINE_FUNC0(get_ ## name,					\</span>
<span class="cp">		     &quot;break &quot;__stringify(HYPERPRIVOP_GET_ ## privop) &quot;\n&quot;)</span>

<span class="n">DEFINE_FUNC_GETREG</span><span class="p">(</span><span class="n">psr</span><span class="p">,</span> <span class="n">PSR</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_GETREG</span><span class="p">(</span><span class="n">eflag</span><span class="p">,</span> <span class="n">EFLAG</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_GETREG</span><span class="p">(</span><span class="n">ivr</span><span class="p">,</span> <span class="n">IVR</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_GETREG</span><span class="p">(</span><span class="n">tpr</span><span class="p">,</span> <span class="n">TPR</span><span class="p">);</span>

<span class="cp">#define DEFINE_FUNC_SET_KR(n)						\</span>
<span class="cp">	DEFINE_VOID_FUNC0(set_kr ## n,					\</span>
<span class="cp">			  &quot;;;\n&quot;					\</span>
<span class="cp">			  &quot;mov r9 = r8\n&quot;				\</span>
<span class="cp">			  &quot;mov r8 = &quot; #n &quot;\n&quot;				\</span>
<span class="cp">			  &quot;break &quot; __stringify(HYPERPRIVOP_SET_KR) &quot;\n&quot;)</span>

<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SET_KR</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>

<span class="cp">#define __DEFINE_FUNC_SETREG(name, privop)				\</span>
<span class="cp">	DEFINE_VOID_FUNC0(name,						\</span>
<span class="cp">			  &quot;break &quot;__stringify(HYPERPRIVOP_ ## privop) &quot;\n&quot;)</span>

<span class="cp">#define DEFINE_FUNC_SETREG(name, privop)			\</span>
<span class="cp">	__DEFINE_FUNC_SETREG(set_ ## name, SET_ ## privop)</span>

<span class="n">DEFINE_FUNC_SETREG</span><span class="p">(</span><span class="n">eflag</span><span class="p">,</span> <span class="n">EFLAG</span><span class="p">);</span>
<span class="n">DEFINE_FUNC_SETREG</span><span class="p">(</span><span class="n">tpr</span><span class="p">,</span> <span class="n">TPR</span><span class="p">);</span>
<span class="n">__DEFINE_FUNC_SETREG</span><span class="p">(</span><span class="n">eoi</span><span class="p">,</span> <span class="n">EOI</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">xen_check_events</span><span class="p">[];</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__xen_intrin_local_irq_restore_direct_start</span><span class="p">[];</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__xen_intrin_local_irq_restore_direct_end</span><span class="p">[];</span>
<span class="k">extern</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__xen_intrin_local_irq_restore_direct_reloc</span><span class="p">;</span>

<span class="n">asm</span> <span class="p">(</span>
	<span class="s">&quot;.align 32</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.proc xen_check_events</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;xen_check_events:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* masked = 0</span>
<span class="cm">	 * r9 = masked_addr - 1</span>
<span class="cm">	 *    = pending_intr_addr</span>
<span class="cm">	 */</span>
	<span class="s">&quot;st1.rel [r9] = r0, -1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* r8 = pending_intr */</span>
	<span class="s">&quot;ld1.acq r11 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* p9 = interrupt pending? */</span>
	<span class="s">&quot;cmp.ne p9, p10 = r11, r0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;(p10) mf</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* issue hypercall to trigger interrupt */</span>
	<span class="s">&quot;(p9) break &quot;</span> <span class="n">__stringify</span><span class="p">(</span><span class="n">HYPERPRIVOP_SSM_I</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;br.cond.sptk.many b6</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.endp xen_check_events</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.align 32</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.proc __xen_intrin_local_irq_restore_direct</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;__xen_intrin_local_irq_restore_direct:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;__xen_intrin_local_irq_restore_direct_start:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;cmp.ne p6, p7 = r8, r0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;mov r17 = ip</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* get ip to calc return address */</span>
	<span class="s">&quot;mov r9 = &quot;</span><span class="n">__stringify</span><span class="p">(</span><span class="n">XEN_PSR_I_ADDR_ADDR</span><span class="p">)</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* r9 = XEN_PSR_I_ADDR */</span>
	<span class="s">&quot;ld8 r9 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* r10 = masked previous value */</span>
	<span class="s">&quot;(p6) ld1.acq r10 = [r9]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;adds r17 =  1f - 1b, r17</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* calculate return address */</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* p8 = !masked interrupt masked previously? */</span>
	<span class="s">&quot;(p6) cmp.ne.unc p8, p0 = r10, r0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* p7 = else clause */</span>
	<span class="s">&quot;(p7) mov r11 = 1</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;(p8) mov b6 = r17</span><span class="se">\n</span><span class="s">&quot;</span> <span class="cm">/* set return address */</span>
	<span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* masked = 1 */</span>
	<span class="s">&quot;(p7) st1.rel [r9] = r11</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;[99:]</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;(p8) brl.cond.dptk.few xen_check_events</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="cm">/* pv calling stub is 5 bundles. fill nop to adjust return address */</span>
	<span class="s">&quot;{</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;nop 0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;nop 0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;nop 0</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;__xen_intrin_local_irq_restore_direct_end:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.endp __xen_intrin_local_irq_restore_direct</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;.align 8</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;__xen_intrin_local_irq_restore_direct_reloc:</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;data8 99b</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">paravirt_patch_bundle_elem</span> <span class="n">xen_patch_bundle_elems</span><span class="p">[]</span>
<span class="n">__initdata_or_module</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cp">#define XEN_PATCH_BUNDLE_ELEM(name, type)		\</span>
<span class="cp">	{						\</span>
<span class="cp">		(void*)xen_ ## name ## _direct_start,	\</span>
<span class="cp">		(void*)xen_ ## name ## _direct_end,	\</span>
<span class="cp">		PARAVIRT_PATCH_TYPE_ ## type,		\</span>
<span class="cp">	}</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">FC</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">thash</span><span class="p">,</span> <span class="n">THASH</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">get_cpuid</span><span class="p">,</span> <span class="n">GET_CPUID</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">get_pmd</span><span class="p">,</span> <span class="n">GET_PMD</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">ptcga</span><span class="p">,</span> <span class="n">PTCGA</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">get_rr</span><span class="p">,</span> <span class="n">GET_RR</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">set_rr</span><span class="p">,</span> <span class="n">SET_RR</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">set_rr0_to_rr4</span><span class="p">,</span> <span class="n">SET_RR0_TO_RR4</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">ssm_i</span><span class="p">,</span> <span class="n">SSM_I</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">rsm_i</span><span class="p">,</span> <span class="n">RSM_I</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM</span><span class="p">(</span><span class="n">get_psr_i</span><span class="p">,</span> <span class="n">GET_PSR_I</span><span class="p">),</span>
	<span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">__xen_intrin_local_irq_restore_direct_start</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">__xen_intrin_local_irq_restore_direct_end</span><span class="p">,</span>
		<span class="n">PARAVIRT_PATCH_TYPE_INTRIN_LOCAL_IRQ_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>

<span class="cp">#define XEN_PATCH_BUNDLE_ELEM_GETREG(name, reg)			\</span>
<span class="cp">	{							\</span>
<span class="cp">		xen_get_ ## name ## _direct_start,		\</span>
<span class="cp">		xen_get_ ## name ## _direct_end,		\</span>
<span class="cp">		PARAVIRT_PATCH_TYPE_GETREG + _IA64_REG_ ## reg, \</span>
<span class="cp">	}</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">psr</span><span class="p">,</span> <span class="n">PSR</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">eflag</span><span class="p">,</span> <span class="n">AR_EFLAG</span><span class="p">),</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">ivr</span><span class="p">,</span> <span class="n">CR_IVR</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">tpr</span><span class="p">,</span> <span class="n">CR_TPR</span><span class="p">),</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">itc</span><span class="p">,</span> <span class="n">AR_ITC</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_GETREG</span><span class="p">(</span><span class="n">itm_with_offset</span><span class="p">,</span> <span class="n">CR_ITM</span><span class="p">),</span>


<span class="cp">#define __XEN_PATCH_BUNDLE_ELEM_SETREG(name, reg)		\</span>
<span class="cp">	{							\</span>
<span class="cp">		xen_ ## name ## _direct_start,			\</span>
<span class="cp">		xen_ ## name ## _direct_end,			\</span>
<span class="cp">		PARAVIRT_PATCH_TYPE_SETREG + _IA64_REG_ ## reg, \</span>
<span class="cp">	}</span>

<span class="cp">#define XEN_PATCH_BUNDLE_ELEM_SETREG(name, reg)			\</span>
<span class="cp">	__XEN_PATCH_BUNDLE_ELEM_SETREG(set_ ## name, reg)</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr0</span><span class="p">,</span> <span class="n">AR_KR0</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr1</span><span class="p">,</span> <span class="n">AR_KR1</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr2</span><span class="p">,</span> <span class="n">AR_KR2</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr3</span><span class="p">,</span> <span class="n">AR_KR3</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr4</span><span class="p">,</span> <span class="n">AR_KR4</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr5</span><span class="p">,</span> <span class="n">AR_KR5</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr6</span><span class="p">,</span> <span class="n">AR_KR6</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">kr7</span><span class="p">,</span> <span class="n">AR_KR7</span><span class="p">),</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">eflag</span><span class="p">,</span> <span class="n">AR_EFLAG</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">tpr</span><span class="p">,</span> <span class="n">CR_TPR</span><span class="p">),</span>
	<span class="n">__XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">eoi</span><span class="p">,</span> <span class="n">CR_EOI</span><span class="p">),</span>

	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">itc</span><span class="p">,</span> <span class="n">AR_ITC</span><span class="p">),</span>
	<span class="n">XEN_PATCH_BUNDLE_ELEM_SETREG</span><span class="p">(</span><span class="n">itm_with_offset</span><span class="p">,</span> <span class="n">CR_ITM</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init_or_module</span>
<span class="nf">xen_patch_bundle</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sbundle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ebundle</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelems</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xen_patch_bundle_elems</span><span class="p">)</span> <span class="o">/</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">xen_patch_bundle_elems</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">paravirt_patch_bundle_elem</span> <span class="o">*</span><span class="n">found</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">__paravirt_patch_apply_bundle</span><span class="p">(</span><span class="n">sbundle</span><span class="p">,</span> <span class="n">ebundle</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
					     <span class="n">xen_patch_bundle_elems</span><span class="p">,</span> <span class="n">nelems</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">found</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* fallback */</span>
		<span class="k">return</span> <span class="n">ia64_native_patch_bundle</span><span class="p">(</span><span class="n">sbundle</span><span class="p">,</span> <span class="n">ebundle</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">used</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">used</span><span class="p">;</span>

	<span class="cm">/* relocation */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PARAVIRT_PATCH_TYPE_INTRIN_LOCAL_IRQ_RESTORE</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reloc</span> <span class="o">=</span>
			<span class="n">__xen_intrin_local_irq_restore_direct_reloc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reloc_offset</span> <span class="o">=</span> <span class="n">reloc</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
			<span class="n">__xen_intrin_local_irq_restore_direct_start</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sbundle</span> <span class="o">+</span> <span class="n">reloc_offset</span><span class="p">;</span>
		<span class="n">paravirt_patch_reloc_brl</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">xen_check_events</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="cm">/* nothing */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* ASM_SUPPOTED */</span><span class="cp"></span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">paravirt_patch_branch_target</span> <span class="n">xen_branch_target</span><span class="p">[]</span>
<span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define PARAVIRT_BR_TARGET(name, type)			\</span>
<span class="cp">	{						\</span>
<span class="cp">		&amp;xen_ ## name,				\</span>
<span class="cp">		PARAVIRT_PATCH_TYPE_BR_ ## type,	\</span>
<span class="cp">	}</span>
	<span class="n">PARAVIRT_BR_TARGET</span><span class="p">(</span><span class="n">switch_to</span><span class="p">,</span> <span class="n">SWITCH_TO</span><span class="p">),</span>
	<span class="n">PARAVIRT_BR_TARGET</span><span class="p">(</span><span class="n">leave_syscall</span><span class="p">,</span> <span class="n">LEAVE_SYSCALL</span><span class="p">),</span>
	<span class="n">PARAVIRT_BR_TARGET</span><span class="p">(</span><span class="n">work_processed_syscall</span><span class="p">,</span> <span class="n">WORK_PROCESSED_SYSCALL</span><span class="p">),</span>
	<span class="n">PARAVIRT_BR_TARGET</span><span class="p">(</span><span class="n">leave_kernel</span><span class="p">,</span> <span class="n">LEAVE_KERNEL</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">xen_patch_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tag</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__paravirt_patch_apply_branch</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">xen_branch_target</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">xen_branch_target</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
