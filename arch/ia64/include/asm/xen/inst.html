<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › include › asm › xen › inst.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>inst.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> * arch/ia64/include/asm/xen/inst.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Isaku Yamahata &lt;yamahata at valinux co jp&gt;</span>
<span class="cm"> *                    VA Linux Systems Japan K.K.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/xen/privop.h&gt;</span>

<span class="cp">#define ia64_ivt				xen_ivt</span>
<span class="cp">#define DO_SAVE_MIN				XEN_DO_SAVE_MIN</span>

<span class="cp">#define __paravirt_switch_to			xen_switch_to</span>
<span class="cp">#define __paravirt_leave_syscall		xen_leave_syscall</span>
<span class="cp">#define __paravirt_work_processed_syscall	xen_work_processed_syscall</span>
<span class="cp">#define __paravirt_leave_kernel			xen_leave_kernel</span>
<span class="cp">#define __paravirt_pending_syscall_end		xen_work_pending_syscall_end</span>
<span class="cp">#define __paravirt_work_processed_syscall_target \</span>
<span class="cp">						xen_work_processed_syscall</span>

<span class="cp">#define paravirt_fsyscall_table			xen_fsyscall_table</span>
<span class="cp">#define paravirt_fsys_bubble_down		xen_fsys_bubble_down</span>

<span class="cp">#define MOV_FROM_IFA(reg)	\</span>
<span class="cp">	movl reg = XSI_IFA;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_ITIR(reg)	\</span>
<span class="cp">	movl reg = XSI_ITIR;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_ISR(reg)	\</span>
<span class="cp">	movl reg = XSI_ISR;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_IHA(reg)	\</span>
<span class="cp">	movl reg = XSI_IHA;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_IPSR(pred, reg)	\</span>
<span class="cp">(pred)	movl reg = XSI_IPSR;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_IIM(reg)	\</span>
<span class="cp">	movl reg = XSI_IIM;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="cp">#define MOV_FROM_IIP(reg)	\</span>
<span class="cp">	movl reg = XSI_IIP;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	ld8 reg = [reg]</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__MOV_FROM_IVR</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">XEN_HYPER_GET_IVR</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">XEN_HYPER_GET_IVR</span>
		<span class="p">;;</span>
		<span class="n">mov</span> <span class="err">\</span><span class="n">reg</span> <span class="o">=</span> <span class="n">r8</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">;;</span>
	<span class="n">XEN_HYPER_GET_IVR</span>
	<span class="p">;;</span>
	<span class="n">mov</span> <span class="err">\</span><span class="n">reg</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">;;</span>
	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define MOV_FROM_IVR(reg, clob)	__MOV_FROM_IVR reg, clob</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__MOV_FROM_PSR</span> <span class="n">pred</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_GET_PSR</span><span class="p">;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_GET_PSR</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">reg</span> <span class="o">=</span> <span class="n">r8</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_GET_PSR</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">reg</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define MOV_FROM_PSR(pred, reg, clob)	__MOV_FROM_PSR pred, reg, clob</span>

<span class="cm">/* assuming ar.itc is read with interrupt disabled. */</span>
<span class="cp">#define MOV_FROM_ITC(pred, pred_clob, reg, clob)		\</span>
<span class="cp">(pred)	movl clob = XSI_ITC_OFFSET;				\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	ld8 clob = [clob];					\</span>
<span class="cp">(pred)	mov reg = ar.itc;					\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	add reg = reg, clob;					\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	movl clob = XSI_ITC_LAST;				\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	ld8 clob = [clob];					\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	cmp.geu.unc pred_clob, p0 = clob, reg;			\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred_clob)	add reg = 1, clob;				\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	movl clob = XSI_ITC_LAST;				\</span>
<span class="cp">	;;							\</span>
<span class="cp">(pred)	st8 [clob] = reg</span>


<span class="cp">#define MOV_TO_IFA(reg, clob)	\</span>
<span class="cp">	movl clob = XSI_IFA;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	st8 [clob] = reg	\</span>

<span class="cp">#define MOV_TO_ITIR(pred, reg, clob)	\</span>
<span class="cp">(pred)	movl clob = XSI_ITIR;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	st8 [clob] = reg</span>

<span class="cp">#define MOV_TO_IHA(pred, reg, clob)	\</span>
<span class="cp">(pred)	movl clob = XSI_IHA;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	st8 [clob] = reg</span>

<span class="cp">#define MOV_TO_IPSR(pred, reg, clob)	\</span>
<span class="cp">(pred)	movl clob = XSI_IPSR;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	st8 [clob] = reg;		\</span>
<span class="cp">	;;</span>

<span class="cp">#define MOV_TO_IFS(pred, reg, clob)	\</span>
<span class="cp">(pred)	movl clob = XSI_IFS;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	st8 [clob] = reg;		\</span>
<span class="cp">	;;</span>

<span class="cp">#define MOV_TO_IIP(reg, clob)	\</span>
<span class="cp">	movl clob = XSI_IIP;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	st8 [clob] = reg</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">____MOV_TO_KR</span> <span class="n">kr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob0</span><span class="p">,</span> <span class="n">clob1</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob0&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
		<span class="p">.</span><span class="n">error</span> <span class="s">&quot;clob0 \clob0 must not be r9&quot;</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob1&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">.</span><span class="n">error</span> <span class="s">&quot;clob1 \clob1 must not be r8&quot;</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
		<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;\clob1&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
			<span class="n">mov</span> <span class="err">\</span><span class="n">clob1</span> <span class="o">=</span> <span class="n">r9</span>
		<span class="p">.</span><span class="n">endif</span>
		<span class="n">mov</span> <span class="n">r9</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;\clob0&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">mov</span> <span class="err">\</span><span class="n">clob0</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">kr</span>
	<span class="p">;;</span>
	<span class="n">XEN_HYPER_SET_KR</span>

	<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
		<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;\clob1&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
			<span class="n">mov</span> <span class="n">r9</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob1</span>
		<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifnc</span> <span class="s">&quot;\clob0&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob0</span>
	<span class="p">.</span><span class="n">endif</span>
<span class="p">.</span><span class="n">endm</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__MOV_TO_KR</span> <span class="n">kr</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob0</span><span class="p">,</span> <span class="n">clob1</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob0&quot;</span><span class="p">,</span> <span class="s">&quot;r9&quot;</span>
		<span class="n">____MOV_TO_KR</span> <span class="err">\</span><span class="n">kr</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">clob1</span><span class="p">,</span> <span class="err">\</span><span class="n">clob0</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob1&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">____MOV_TO_KR</span> <span class="err">\</span><span class="n">kr</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">clob1</span><span class="p">,</span> <span class="err">\</span><span class="n">clob0</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="n">____MOV_TO_KR</span> <span class="err">\</span><span class="n">kr</span><span class="p">,</span> <span class="err">\</span><span class="n">reg</span><span class="p">,</span> <span class="err">\</span><span class="n">clob0</span><span class="p">,</span> <span class="err">\</span><span class="n">clob1</span>
<span class="p">.</span><span class="n">endm</span>

<span class="cp">#define MOV_TO_KR(kr, reg, clob0, clob1) \</span>
<span class="cp">	__MOV_TO_KR IA64_KR_ ## kr, reg, clob0, clob1</span>


<span class="p">.</span><span class="n">macro</span> <span class="n">__ITC_I</span> <span class="n">pred</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_I</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_I</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_I</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
	<span class="p">;;</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define ITC_I(pred, reg, clob)	__ITC_I pred, reg, clob</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__ITC_D</span> <span class="n">pred</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_D</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_D</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_ITC_D</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
	<span class="p">;;</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define ITC_D(pred, reg, clob)	__ITC_D pred, reg, clob</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__ITC_I_AND_D</span> <span class="n">pred_i</span><span class="p">,</span> <span class="n">pred_d</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred_i</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_I</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred_d</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_D</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred_i</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_I</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred_d</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_D</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred_i</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_I</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred_d</span><span class="p">)</span><span class="n">XEN_HYPER_ITC_D</span>
	<span class="p">;;</span>
	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
	<span class="p">;;</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define ITC_I_AND_D(pred_i, pred_d, reg, clob) \</span>
<span class="cp">	__ITC_I_AND_D pred_i, pred_d, reg, clob</span>

<span class="p">.</span><span class="n">macro</span> <span class="n">__THASH</span> <span class="n">pred</span><span class="p">,</span> <span class="n">reg0</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">clob</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg0&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg1</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_THASH</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endc</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">eg1&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_THASH</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">reg0</span> <span class="o">=</span> <span class="n">r8</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>
	<span class="p">.</span><span class="n">ifc</span> <span class="s">&quot;\clob&quot;</span><span class="p">,</span> <span class="s">&quot;r8&quot;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg1</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_THASH</span>
		<span class="p">;;</span>
		<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">reg0</span> <span class="o">=</span> <span class="n">r8</span>
		<span class="p">;;</span>
		<span class="p">.</span><span class="n">exitm</span>
	<span class="p">.</span><span class="n">endif</span>

	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">clob</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">reg1</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">XEN_HYPER_THASH</span>
	<span class="p">;;</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="err">\</span><span class="n">reg0</span> <span class="o">=</span> <span class="n">r8</span>
	<span class="p">(</span><span class="err">\</span><span class="n">pred</span><span class="p">)</span>	<span class="n">mov</span> <span class="n">r8</span> <span class="o">=</span> <span class="err">\</span><span class="n">clob</span>
	<span class="p">;;</span>
<span class="p">.</span><span class="n">endm</span>
<span class="cp">#define THASH(pred, reg0, reg1, clob) __THASH pred, reg0, reg1, clob</span>

<span class="cp">#define SSM_PSR_IC_AND_DEFAULT_BITS_AND_SRLZ_I(clob0, clob1)	\</span>
<span class="cp">	mov clob0 = 1;						\</span>
<span class="cp">	movl clob1 = XSI_PSR_IC;				\</span>
<span class="cp">	;;							\</span>
<span class="cp">	st4 [clob1] = clob0					\</span>
<span class="cp">	;;</span>

<span class="cp">#define SSM_PSR_IC_AND_SRLZ_D(clob0, clob1)	\</span>
<span class="cp">	;;					\</span>
<span class="cp">	srlz.d;					\</span>
<span class="cp">	mov clob1 = 1;				\</span>
<span class="cp">	movl clob0 = XSI_PSR_IC;		\</span>
<span class="cp">	;;					\</span>
<span class="cp">	st4 [clob0] = clob1</span>

<span class="cp">#define RSM_PSR_IC(clob)	\</span>
<span class="cp">	movl clob = XSI_PSR_IC;	\</span>
<span class="cp">	;;			\</span>
<span class="cp">	st4 [clob] = r0;	\</span>
<span class="cp">	;;</span>

<span class="cm">/* pred will be clobbered */</span>
<span class="cp">#define MASK_TO_PEND_OFS    (-1)</span>
<span class="cp">#define SSM_PSR_I(pred, pred_clob, clob)				\</span>
<span class="cp">(pred)	movl clob = XSI_PSR_I_ADDR					\</span>
<span class="cp">	;;								\</span>
<span class="cp">(pred)	ld8 clob = [clob]						\</span>
<span class="cp">	;;								\</span>
<span class="cp">	</span><span class="cm">/* if (pred) vpsr.i = 1 */</span><span class="cp">					\</span>
<span class="cp">	</span><span class="cm">/* if (pred) (vcpu-&gt;vcpu_info-&gt;evtchn_upcall_mask)=0 */</span><span class="cp">		\</span>
<span class="cp">(pred)	st1 [clob] = r0, MASK_TO_PEND_OFS				\</span>
<span class="cp">	;;								\</span>
<span class="cp">	</span><span class="cm">/* if (vcpu-&gt;vcpu_info-&gt;evtchn_upcall_pending) */</span><span class="cp">		\</span>
<span class="cp">(pred)	ld1 clob = [clob]						\</span>
<span class="cp">	;;								\</span>
<span class="cp">(pred)	cmp.ne.unc pred_clob, p0 = clob, r0				\</span>
<span class="cp">	;;								\</span>
<span class="cp">(pred_clob)XEN_HYPER_SSM_I	</span><span class="cm">/* do areal ssm psr.i */</span><span class="cp"></span>

<span class="cp">#define RSM_PSR_I(pred, clob0, clob1)	\</span>
<span class="cp">	movl clob0 = XSI_PSR_I_ADDR;	\</span>
<span class="cp">	mov clob1 = 1;			\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8 clob0 = [clob0];		\</span>
<span class="cp">	;;				\</span>
<span class="cp">(pred)	st1 [clob0] = clob1</span>

<span class="cp">#define RSM_PSR_I_IC(clob0, clob1, clob2)		\</span>
<span class="cp">	movl clob0 = XSI_PSR_I_ADDR;			\</span>
<span class="cp">	movl clob1 = XSI_PSR_IC;			\</span>
<span class="cp">	;;						\</span>
<span class="cp">	ld8 clob0 = [clob0];				\</span>
<span class="cp">	mov clob2 = 1;					\</span>
<span class="cp">	;;						\</span>
<span class="cp">	</span><span class="cm">/* note: clears both vpsr.i and vpsr.ic! */</span><span class="cp">	\</span>
<span class="cp">	st1 [clob0] = clob2;				\</span>
<span class="cp">	st4 [clob1] = r0;				\</span>
<span class="cp">	;;</span>

<span class="cp">#define RSM_PSR_DT		\</span>
<span class="cp">	XEN_HYPER_RSM_PSR_DT</span>

<span class="cp">#define RSM_PSR_BE_I(clob0, clob1)	\</span>
<span class="cp">	RSM_PSR_I(p0, clob0, clob1);	\</span>
<span class="cp">	rum psr.be</span>

<span class="cp">#define SSM_PSR_DT_AND_SRLZ_I	\</span>
<span class="cp">	XEN_HYPER_SSM_PSR_DT</span>

<span class="cp">#define BSW_0(clob0, clob1, clob2)			\</span>
<span class="cp">	;;						\</span>
<span class="cp">	</span><span class="cm">/* r16-r31 all now hold bank1 values */</span><span class="cp">		\</span>
<span class="cp">	mov clob2 = ar.unat;				\</span>
<span class="cp">	movl clob0 = XSI_BANK1_R16;			\</span>
<span class="cp">	movl clob1 = XSI_BANK1_R16 + 8;			\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r16, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r17, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r18, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r19, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r20, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r21, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r22, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r23, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r24, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r25, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r26, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r27, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r28, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r29, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">.mem.offset 0, 0; st8.spill [clob0] = r30, 16;		\</span>
<span class="cp">.mem.offset 8, 0; st8.spill [clob1] = r31, 16;		\</span>
<span class="cp">	;;						\</span>
<span class="cp">	mov clob1 = ar.unat;				\</span>
<span class="cp">	movl clob0 = XSI_B1NAT;				\</span>
<span class="cp">	;;						\</span>
<span class="cp">	st8 [clob0] = clob1;				\</span>
<span class="cp">	mov ar.unat = clob2;				\</span>
<span class="cp">	movl clob0 = XSI_BANKNUM;			\</span>
<span class="cp">	;;						\</span>
<span class="cp">	st4 [clob0] = r0</span>


	<span class="cm">/* FIXME: THIS CODE IS NOT NaT SAFE! */</span>
<span class="cp">#define XEN_BSW_1(clob)			\</span>
<span class="cp">	mov clob = ar.unat;		\</span>
<span class="cp">	movl r30 = XSI_B1NAT;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8 r30 = [r30];		\</span>
<span class="cp">	mov r31 = 1;			\</span>
<span class="cp">	;;				\</span>
<span class="cp">	mov ar.unat = r30;		\</span>
<span class="cp">	movl r30 = XSI_BANKNUM;		\</span>
<span class="cp">	;;				\</span>
<span class="cp">	st4 [r30] = r31;		\</span>
<span class="cp">	movl r30 = XSI_BANK1_R16;	\</span>
<span class="cp">	movl r31 = XSI_BANK1_R16+8;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r16 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r17 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r18 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r19 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r20 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r21 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r22 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r23 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r24 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r25 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r26 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r27 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r28 = [r30], 16;	\</span>
<span class="cp">	ld8.fill r29 = [r31], 16;	\</span>
<span class="cp">	;;				\</span>
<span class="cp">	ld8.fill r30 = [r30];		\</span>
<span class="cp">	ld8.fill r31 = [r31];		\</span>
<span class="cp">	;;				\</span>
<span class="cp">	mov ar.unat = clob</span>

<span class="cp">#define BSW_1(clob0, clob1)	XEN_BSW_1(clob1)</span>


<span class="cp">#define COVER	\</span>
<span class="cp">	XEN_HYPER_COVER</span>

<span class="cp">#define RFI			\</span>
<span class="cp">	XEN_HYPER_RFI;		\</span>
<span class="cp">	dv_serialize_data</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
