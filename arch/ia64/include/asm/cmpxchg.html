<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › include › asm › cmpxchg.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cmpxchg.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_IA64_CMPXCHG_H</span>
<span class="cp">#define _ASM_IA64_CMPXCHG_H</span>

<span class="cm">/*</span>
<span class="cm"> * Compare/Exchange, forked from asm/intrinsics.h</span>
<span class="cm"> * which was:</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 2002-2003 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __ASSEMBLY__</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cm">/* include compiler specific intrinsics */</span>
<span class="cp">#include &lt;asm/ia64regs.h&gt;</span>
<span class="cp">#ifdef __INTEL_COMPILER</span>
<span class="cp"># include &lt;asm/intel_intrin.h&gt;</span>
<span class="cp">#else</span>
<span class="cp"># include &lt;asm/gcc_intrin.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This function doesn&#39;t exist, so you&#39;ll get a linker error if</span>
<span class="cm"> * something tries to do an invalid xchg().</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ia64_xchg_called_with_bad_pointer</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define __xchg(x, ptr, size)						\</span>
<span class="cp">({									\</span>
<span class="cp">	unsigned long __xchg_result;					\</span>
<span class="cp">									\</span>
<span class="cp">	switch (size) {							\</span>
<span class="cp">	case 1:								\</span>
<span class="cp">		__xchg_result = ia64_xchg1((__u8 *)ptr, x);		\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 2:								\</span>
<span class="cp">		__xchg_result = ia64_xchg2((__u16 *)ptr, x);		\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 4:								\</span>
<span class="cp">		__xchg_result = ia64_xchg4((__u32 *)ptr, x);		\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 8:								\</span>
<span class="cp">		__xchg_result = ia64_xchg8((__u64 *)ptr, x);		\</span>
<span class="cp">		break;							\</span>
<span class="cp">	default:							\</span>
<span class="cp">		ia64_xchg_called_with_bad_pointer();			\</span>
<span class="cp">	}								\</span>
<span class="cp">	__xchg_result;							\</span>
<span class="cp">})</span>

<span class="cp">#define xchg(ptr, x)							\</span>
<span class="cp">((__typeof__(*(ptr))) __xchg((unsigned long) (x), (ptr), sizeof(*(ptr))))</span>

<span class="cm">/*</span>
<span class="cm"> * Atomic compare and exchange.  Compare OLD with MEM, if identical,</span>
<span class="cm"> * store NEW in MEM.  Return the initial value in MEM.  Success is</span>
<span class="cm"> * indicated by comparing RETURN with OLD.</span>
<span class="cm"> */</span>

<span class="cp">#define __HAVE_ARCH_CMPXCHG 1</span>

<span class="cm">/*</span>
<span class="cm"> * This function doesn&#39;t exist, so you&#39;ll get a linker error</span>
<span class="cm"> * if something tries to do an invalid cmpxchg().</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">ia64_cmpxchg_called_with_bad_pointer</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#define ia64_cmpxchg(sem, ptr, old, new, size)				\</span>
<span class="cp">({									\</span>
<span class="cp">	__u64 _o_, _r_;							\</span>
<span class="cp">									\</span>
<span class="cp">	switch (size) {							\</span>
<span class="cp">	case 1:								\</span>
<span class="cp">		_o_ = (__u8) (long) (old);				\</span>
<span class="cp">		break;							\</span>
<span class="cp">	case 2:								\</span>
<span class="cp">		_o_ = (__u16) (long) (old);				\</span>
<span class="cp">		break;							\</span>
<span class="cp">	case 4:								\</span>
<span class="cp">		_o_ = (__u32) (long) (old);				\</span>
<span class="cp">		break;							\</span>
<span class="cp">	case 8:								\</span>
<span class="cp">		_o_ = (__u64) (long) (old);				\</span>
<span class="cp">		break;							\</span>
<span class="cp">	default:							\</span>
<span class="cp">		break;							\</span>
<span class="cp">	}								\</span>
<span class="cp">	switch (size) {							\</span>
<span class="cp">	case 1:								\</span>
<span class="cp">		_r_ = ia64_cmpxchg1_##sem((__u8 *) ptr, new, _o_);	\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 2:								\</span>
<span class="cp">		_r_ = ia64_cmpxchg2_##sem((__u16 *) ptr, new, _o_);	\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 4:								\</span>
<span class="cp">		_r_ = ia64_cmpxchg4_##sem((__u32 *) ptr, new, _o_);	\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	case 8:								\</span>
<span class="cp">		_r_ = ia64_cmpxchg8_##sem((__u64 *) ptr, new, _o_);	\</span>
<span class="cp">		break;							\</span>
<span class="cp">									\</span>
<span class="cp">	default:							\</span>
<span class="cp">		_r_ = ia64_cmpxchg_called_with_bad_pointer();		\</span>
<span class="cp">		break;							\</span>
<span class="cp">	}								\</span>
<span class="cp">	(__typeof__(old)) _r_;						\</span>
<span class="cp">})</span>

<span class="cp">#define cmpxchg_acq(ptr, o, n)	\</span>
<span class="cp">	ia64_cmpxchg(acq, (ptr), (o), (n), sizeof(*(ptr)))</span>
<span class="cp">#define cmpxchg_rel(ptr, o, n)	\</span>
<span class="cp">	ia64_cmpxchg(rel, (ptr), (o), (n), sizeof(*(ptr)))</span>

<span class="cm">/* for compatibility with other platforms: */</span>
<span class="cp">#define cmpxchg(ptr, o, n)	cmpxchg_acq((ptr), (o), (n))</span>
<span class="cp">#define cmpxchg64(ptr, o, n)	cmpxchg_acq((ptr), (o), (n))</span>

<span class="cp">#define cmpxchg_local		cmpxchg</span>
<span class="cp">#define cmpxchg64_local		cmpxchg64</span>

<span class="cp">#ifdef CONFIG_IA64_DEBUG_CMPXCHG</span>
<span class="cp"># define CMPXCHG_BUGCHECK_DECL	int _cmpxchg_bugcheck_count = 128;</span>
<span class="cp"># define CMPXCHG_BUGCHECK(v)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (_cmpxchg_bugcheck_count-- &lt;= 0) {				\</span>
<span class="cp">		void *ip;						\</span>
<span class="cp">		extern int printk(const char *fmt, ...);		\</span>
<span class="cp">		ip = (void *) ia64_getreg(_IA64_REG_IP);		\</span>
<span class="cp">		printk(&quot;CMPXCHG_BUGCHECK: stuck at %p on word %p\n&quot;, ip, (v));\</span>
<span class="cp">		break;							\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_IA64_DEBUG_CMPXCHG */</span><span class="cp"></span>
<span class="cp"># define CMPXCHG_BUGCHECK_DECL</span>
<span class="cp"># define CMPXCHG_BUGCHECK(v)</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_IA64_DEBUG_CMPXCHG */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* !__ASSEMBLY__ */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _ASM_IA64_CMPXCHG_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
