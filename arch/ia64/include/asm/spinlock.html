<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › include › asm › spinlock.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>spinlock.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_IA64_SPINLOCK_H</span>
<span class="cp">#define _ASM_IA64_SPINLOCK_H</span>

<span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1998-2003 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> * Copyright (C) 1999 Walt Drummond &lt;drummond@valinux.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is used for SMP configurations only.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/intrinsics.h&gt;</span>

<span class="cp">#define arch_spin_lock_init(x)			((x)-&gt;lock = 0)</span>

<span class="cm">/*</span>
<span class="cm"> * Ticket locks are conceptually two parts, one indicating the current head of</span>
<span class="cm"> * the queue, and the other indicating the current tail. The lock is acquired</span>
<span class="cm"> * by atomically noting the tail and incrementing it by one (thus adding</span>
<span class="cm"> * ourself to the queue and noting our position), then waiting until the head</span>
<span class="cm"> * becomes equal to the the initial value of the tail.</span>
<span class="cm"> * The pad bits in the middle are used to prevent the next_ticket number</span>
<span class="cm"> * overflowing into the now_serving number.</span>
<span class="cm"> *</span>
<span class="cm"> *   31             17  16    15  14                    0</span>
<span class="cm"> *  +----------------------------------------------------+</span>
<span class="cm"> *  |  now_serving     | padding |   next_ticket         |</span>
<span class="cm"> *  +----------------------------------------------------+</span>
<span class="cm"> */</span>

<span class="cp">#define TICKET_SHIFT	17</span>
<span class="cp">#define TICKET_BITS	15</span>
<span class="cp">#define	TICKET_MASK	((1 &lt;&lt; TICKET_BITS) - 1)</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">__ticket_spin_lock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">ticket</span><span class="p">,</span> <span class="n">serve</span><span class="p">;</span>

	<span class="n">ticket</span> <span class="o">=</span> <span class="n">ia64_fetchadd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">acq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">ticket</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">ticket</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ia64_invala</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ld4.c.nc %0=[%1]&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">serve</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">serve</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">ticket</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">int</span> <span class="nf">__ticket_spin_trylock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ia64_cmpxchg</span><span class="p">(</span><span class="n">acq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">==</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">__ticket_spin_unlock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ld2.bias %0=[%1]&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">__ticket_spin_unlock_wait</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">ticket</span><span class="p">;</span>

	<span class="n">ia64_invala</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;ld4.c.nc %0=[%1]&quot;</span> <span class="o">:</span> <span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(((</span><span class="n">ticket</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">ticket</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__ticket_spin_is_locked</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">)</span> <span class="o">^</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__ticket_spin_is_contended</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">-</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">TICKET_SHIFT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TICKET_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">arch_spin_is_locked</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__ticket_spin_is_locked</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">arch_spin_is_contended</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__ticket_spin_is_contended</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#define arch_spin_is_contended	arch_spin_is_contended</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_lock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__ticket_spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">int</span> <span class="nf">arch_spin_trylock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__ticket_spin_trylock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_unlock</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__ticket_spin_unlock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span> <span class="nf">arch_spin_lock_flags</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span>
						  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">arch_spin_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_spin_unlock_wait</span><span class="p">(</span><span class="n">arch_spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__ticket_spin_unlock_wait</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define arch_read_can_lock(rw)		(*(volatile int *)(rw) &gt;= 0)</span>
<span class="cp">#define arch_write_can_lock(rw)	(*(volatile int *)(rw) == 0)</span>

<span class="cp">#ifdef ASM_SUPPORTED</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span>
<span class="nf">arch_read_lock_flags</span><span class="p">(</span><span class="n">arch_rwlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;tbit.nz p6, p0 = %1,%2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;br.few 3f</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fetchadd4.rel r2 = [%0], -1;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p6) ssm psr.i</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;hint @pause</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;ld4 r2 = [%0];;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;cmp4.lt p7,p0 = r2, r0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p7) br.cond.spnt.few 2b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p6) rsm psr.i</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;fetchadd4.acq r2 = [%0], 1;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;cmp4.lt p7,p0 = r2, r0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p7) br.cond.spnt.few 1b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">lock</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">IA64_PSR_I_BIT</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;p6&quot;</span><span class="p">,</span> <span class="s">&quot;p7&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define arch_read_lock(lock) arch_read_lock_flags(lock, 0)</span>

<span class="cp">#else </span><span class="cm">/* !ASM_SUPPORTED */</span><span class="cp"></span>

<span class="cp">#define arch_read_lock_flags(rw, flags) arch_read_lock(rw)</span>

<span class="cp">#define arch_read_lock(rw)								\</span>
<span class="cp">do {											\</span>
<span class="cp">	arch_rwlock_t *__read_lock_ptr = (rw);						\</span>
<span class="cp">											\</span>
<span class="cp">	while (unlikely(ia64_fetchadd(1, (int *) __read_lock_ptr, acq) &lt; 0)) {		\</span>
<span class="cp">		ia64_fetchadd(-1, (int *) __read_lock_ptr, rel);			\</span>
<span class="cp">		while (*(volatile int *)__read_lock_ptr &lt; 0)				\</span>
<span class="cp">			cpu_relax();							\</span>
<span class="cp">	}										\</span>
<span class="cp">} while (0)</span>

<span class="cp">#endif </span><span class="cm">/* !ASM_SUPPORTED */</span><span class="cp"></span>

<span class="cp">#define arch_read_unlock(rw)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	arch_rwlock_t *__read_lock_ptr = (rw);			\</span>
<span class="cp">	ia64_fetchadd(-1, (int *) __read_lock_ptr, rel);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#ifdef ASM_SUPPORTED</span>

<span class="k">static</span> <span class="n">__always_inline</span> <span class="kt">void</span>
<span class="nf">arch_write_lock_flags</span><span class="p">(</span><span class="n">arch_rwlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;tbit.nz p6, p0 = %1, %2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;mov ar.ccv = r0</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;dep r29 = -1, r0, 31, 1</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;br.few 3f;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p6) ssm psr.i</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;2:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;hint @pause</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;ld4 r2 = [%0];;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;cmp4.eq p0,p7 = r0, r2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p7) br.cond.spnt.few 2b</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p6) rsm psr.i</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;3:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;cmpxchg4.acq r2 = [%0], r29, ar.ccv;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;cmp4.eq p0,p7 = r0, r2</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;(p7) br.cond.spnt.few 1b;;</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="o">:</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">lock</span><span class="p">),</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">flags</span><span class="p">),</span> <span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">IA64_PSR_I_BIT</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;ar.ccv&quot;</span><span class="p">,</span> <span class="s">&quot;p6&quot;</span><span class="p">,</span> <span class="s">&quot;p7&quot;</span><span class="p">,</span> <span class="s">&quot;r2&quot;</span><span class="p">,</span> <span class="s">&quot;r29&quot;</span><span class="p">,</span> <span class="s">&quot;memory&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define arch_write_lock(rw) arch_write_lock_flags(rw, 0)</span>

<span class="cp">#define arch_write_trylock(rw)							\</span>
<span class="cp">({										\</span>
<span class="cp">	register long result;							\</span>
<span class="cp">										\</span>
<span class="cp">	__asm__ __volatile__ (							\</span>
<span class="cp">		&quot;mov ar.ccv = r0\n&quot;						\</span>
<span class="cp">		&quot;dep r29 = -1, r0, 31, 1;;\n&quot;					\</span>
<span class="cp">		&quot;cmpxchg4.acq %0 = [%1], r29, ar.ccv\n&quot;				\</span>
<span class="cp">		: &quot;=r&quot;(result) : &quot;r&quot;(rw) : &quot;ar.ccv&quot;, &quot;r29&quot;, &quot;memory&quot;);		\</span>
<span class="cp">	(result == 0);								\</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_write_unlock</span><span class="p">(</span><span class="n">arch_rwlock_t</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">x</span><span class="p">;</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">asm</span> <span class="k">volatile</span> <span class="p">(</span><span class="s">&quot;st1.rel.nta [%0] = r0</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="o">::</span> <span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;memory&quot;</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !ASM_SUPPORTED */</span><span class="cp"></span>

<span class="cp">#define arch_write_lock_flags(l, flags) arch_write_lock(l)</span>

<span class="cp">#define arch_write_lock(l)								\</span>
<span class="cp">({											\</span>
<span class="cp">	__u64 ia64_val, ia64_set_val = ia64_dep_mi(-1, 0, 31, 1);			\</span>
<span class="cp">	__u32 *ia64_write_lock_ptr = (__u32 *) (l);					\</span>
<span class="cp">	do {										\</span>
<span class="cp">		while (*ia64_write_lock_ptr)						\</span>
<span class="cp">			ia64_barrier();							\</span>
<span class="cp">		ia64_val = ia64_cmpxchg4_acq(ia64_write_lock_ptr, ia64_set_val, 0);	\</span>
<span class="cp">	} while (ia64_val);								\</span>
<span class="cp">})</span>

<span class="cp">#define arch_write_trylock(rw)						\</span>
<span class="cp">({									\</span>
<span class="cp">	__u64 ia64_val;							\</span>
<span class="cp">	__u64 ia64_set_val = ia64_dep_mi(-1, 0, 31,1);			\</span>
<span class="cp">	ia64_val = ia64_cmpxchg4_acq((__u32 *)(rw), ia64_set_val, 0);	\</span>
<span class="cp">	(ia64_val == 0);						\</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">arch_write_unlock</span><span class="p">(</span><span class="n">arch_rwlock_t</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">barrier</span><span class="p">();</span>
	<span class="n">x</span><span class="o">-&gt;</span><span class="n">write_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !ASM_SUPPORTED */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">arch_read_trylock</span><span class="p">(</span><span class="n">arch_rwlock_t</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">arch_rwlock_t</span> <span class="n">lock</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">word</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">old</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="n">old</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">write_lock</span> <span class="o">=</span> <span class="n">new</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">write_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">++</span><span class="n">new</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">read_counter</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ia64_cmpxchg4_acq</span><span class="p">((</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">x</span><span class="p">),</span> <span class="n">new</span><span class="p">.</span><span class="n">word</span><span class="p">,</span> <span class="n">old</span><span class="p">.</span><span class="n">word</span><span class="p">)</span> <span class="o">==</span> <span class="n">old</span><span class="p">.</span><span class="n">word</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define arch_spin_relax(lock)	cpu_relax()</span>
<span class="cp">#define arch_read_relax(lock)	cpu_relax()</span>
<span class="cp">#define arch_write_relax(lock)	cpu_relax()</span>

<span class="cp">#endif </span><span class="cm">/*  _ASM_IA64_SPINLOCK_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
