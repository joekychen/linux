<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › include › asm › sn › sn_sal.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>sn_sal.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef _ASM_IA64_SN_SN_SAL_H</span>
<span class="cp">#define _ASM_IA64_SN_SN_SAL_H</span>

<span class="cm">/*</span>
<span class="cm"> * System Abstraction Layer definitions for IA64</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2006 Silicon Graphics, Inc.  All rights reserved.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;asm/sal.h&gt;</span>
<span class="cp">#include &lt;asm/sn/sn_cpuid.h&gt;</span>
<span class="cp">#include &lt;asm/sn/arch.h&gt;</span>
<span class="cp">#include &lt;asm/sn/geo.h&gt;</span>
<span class="cp">#include &lt;asm/sn/nodepda.h&gt;</span>
<span class="cp">#include &lt;asm/sn/shub_mmr.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>SGI Specific Calls</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define  SN_SAL_POD_MODE                           0x02000001</span>
<span class="cp">#define  SN_SAL_SYSTEM_RESET                       0x02000002</span>
<span class="cp">#define  SN_SAL_PROBE                              0x02000003</span>
<span class="cp">#define  SN_SAL_GET_MASTER_NASID                   0x02000004</span>
<span class="cp">#define	 SN_SAL_GET_KLCONFIG_ADDR		   0x02000005</span>
<span class="cp">#define  SN_SAL_LOG_CE				   0x02000006</span>
<span class="cp">#define  SN_SAL_REGISTER_CE			   0x02000007</span>
<span class="cp">#define  SN_SAL_GET_PARTITION_ADDR		   0x02000009</span>
<span class="cp">#define  SN_SAL_XP_ADDR_REGION			   0x0200000f</span>
<span class="cp">#define  SN_SAL_NO_FAULT_ZONE_VIRTUAL		   0x02000010</span>
<span class="cp">#define  SN_SAL_NO_FAULT_ZONE_PHYSICAL		   0x02000011</span>
<span class="cp">#define  SN_SAL_PRINT_ERROR			   0x02000012</span>
<span class="cp">#define  SN_SAL_REGISTER_PMI_HANDLER		   0x02000014</span>
<span class="cp">#define  SN_SAL_SET_ERROR_HANDLING_FEATURES	   0x0200001a	</span><span class="c1">// reentrant</span>
<span class="cp">#define  SN_SAL_GET_FIT_COMPT			   0x0200001b	</span><span class="c1">// reentrant</span>
<span class="cp">#define  SN_SAL_GET_SAPIC_INFO                     0x0200001d</span>
<span class="cp">#define  SN_SAL_GET_SN_INFO                        0x0200001e</span>
<span class="cp">#define  SN_SAL_CONSOLE_PUTC                       0x02000021</span>
<span class="cp">#define  SN_SAL_CONSOLE_GETC                       0x02000022</span>
<span class="cp">#define  SN_SAL_CONSOLE_PUTS                       0x02000023</span>
<span class="cp">#define  SN_SAL_CONSOLE_GETS                       0x02000024</span>
<span class="cp">#define  SN_SAL_CONSOLE_GETS_TIMEOUT               0x02000025</span>
<span class="cp">#define  SN_SAL_CONSOLE_POLL                       0x02000026</span>
<span class="cp">#define  SN_SAL_CONSOLE_INTR                       0x02000027</span>
<span class="cp">#define  SN_SAL_CONSOLE_PUTB			   0x02000028</span>
<span class="cp">#define  SN_SAL_CONSOLE_XMIT_CHARS		   0x0200002a</span>
<span class="cp">#define  SN_SAL_CONSOLE_READC			   0x0200002b</span>
<span class="cp">#define  SN_SAL_SYSCTL_OP			   0x02000030</span>
<span class="cp">#define  SN_SAL_SYSCTL_MODID_GET	           0x02000031</span>
<span class="cp">#define  SN_SAL_SYSCTL_GET                         0x02000032</span>
<span class="cp">#define  SN_SAL_SYSCTL_IOBRICK_MODULE_GET          0x02000033</span>
<span class="cp">#define  SN_SAL_SYSCTL_IO_PORTSPEED_GET            0x02000035</span>
<span class="cp">#define  SN_SAL_SYSCTL_SLAB_GET                    0x02000036</span>
<span class="cp">#define  SN_SAL_BUS_CONFIG		   	   0x02000037</span>
<span class="cp">#define  SN_SAL_SYS_SERIAL_GET			   0x02000038</span>
<span class="cp">#define  SN_SAL_PARTITION_SERIAL_GET		   0x02000039</span>
<span class="cp">#define  SN_SAL_SYSCTL_PARTITION_GET               0x0200003a</span>
<span class="cp">#define  SN_SAL_SYSTEM_POWER_DOWN		   0x0200003b</span>
<span class="cp">#define  SN_SAL_GET_MASTER_BASEIO_NASID		   0x0200003c</span>
<span class="cp">#define  SN_SAL_COHERENCE                          0x0200003d</span>
<span class="cp">#define  SN_SAL_MEMPROTECT                         0x0200003e</span>
<span class="cp">#define  SN_SAL_SYSCTL_FRU_CAPTURE		   0x0200003f</span>

<span class="cp">#define  SN_SAL_SYSCTL_IOBRICK_PCI_OP		   0x02000042	</span><span class="c1">// reentrant</span>
<span class="cp">#define	 SN_SAL_IROUTER_OP			   0x02000043</span>
<span class="cp">#define  SN_SAL_SYSCTL_EVENT                       0x02000044</span>
<span class="cp">#define  SN_SAL_IOIF_INTERRUPT			   0x0200004a</span>
<span class="cp">#define  SN_SAL_HWPERF_OP			   0x02000050   </span><span class="c1">// lock</span>
<span class="cp">#define  SN_SAL_IOIF_ERROR_INTERRUPT		   0x02000051</span>
<span class="cp">#define  SN_SAL_IOIF_PCI_SAFE			   0x02000052</span>
<span class="cp">#define  SN_SAL_IOIF_SLOT_ENABLE		   0x02000053</span>
<span class="cp">#define  SN_SAL_IOIF_SLOT_DISABLE		   0x02000054</span>
<span class="cp">#define  SN_SAL_IOIF_GET_HUBDEV_INFO		   0x02000055</span>
<span class="cp">#define  SN_SAL_IOIF_GET_PCIBUS_INFO		   0x02000056</span>
<span class="cp">#define  SN_SAL_IOIF_GET_PCIDEV_INFO		   0x02000057</span>
<span class="cp">#define  SN_SAL_IOIF_GET_WIDGET_DMAFLUSH_LIST	   0x02000058	</span><span class="c1">// deprecated</span>
<span class="cp">#define  SN_SAL_IOIF_GET_DEVICE_DMAFLUSH_LIST	   0x0200005a</span>

<span class="cp">#define SN_SAL_IOIF_INIT			   0x0200005f</span>
<span class="cp">#define SN_SAL_HUB_ERROR_INTERRUPT		   0x02000060</span>
<span class="cp">#define SN_SAL_BTE_RECOVER			   0x02000061</span>
<span class="cp">#define SN_SAL_RESERVED_DO_NOT_USE		   0x02000062</span>
<span class="cp">#define SN_SAL_IOIF_GET_PCI_TOPOLOGY		   0x02000064</span>

<span class="cp">#define  SN_SAL_GET_PROM_FEATURE_SET		   0x02000065</span>
<span class="cp">#define  SN_SAL_SET_OS_FEATURE_SET		   0x02000066</span>
<span class="cp">#define  SN_SAL_INJECT_ERROR			   0x02000067</span>
<span class="cp">#define  SN_SAL_SET_CPU_NUMBER			   0x02000068</span>

<span class="cp">#define  SN_SAL_KERNEL_LAUNCH_EVENT		   0x02000069</span>
<span class="cp">#define  SN_SAL_WATCHLIST_ALLOC			   0x02000070</span>
<span class="cp">#define  SN_SAL_WATCHLIST_FREE			   0x02000071</span>

<span class="cm">/*</span>
<span class="cm"> * Service-specific constants</span>
<span class="cm"> */</span>

<span class="cm">/* Console interrupt manipulation */</span>
	<span class="cm">/* action codes */</span>
<span class="cp">#define SAL_CONSOLE_INTR_OFF    0       </span><span class="cm">/* turn the interrupt off */</span><span class="cp"></span>
<span class="cp">#define SAL_CONSOLE_INTR_ON     1       </span><span class="cm">/* turn the interrupt on */</span><span class="cp"></span>
<span class="cp">#define SAL_CONSOLE_INTR_STATUS 2	</span><span class="cm">/* retrieve the interrupt status */</span><span class="cp"></span>
	<span class="cm">/* interrupt specification &amp; status return codes */</span>
<span class="cp">#define SAL_CONSOLE_INTR_XMIT	1	</span><span class="cm">/* output interrupt */</span><span class="cp"></span>
<span class="cp">#define SAL_CONSOLE_INTR_RECV	2	</span><span class="cm">/* input interrupt */</span><span class="cp"></span>

<span class="cm">/* interrupt handling */</span>
<span class="cp">#define SAL_INTR_ALLOC		1</span>
<span class="cp">#define SAL_INTR_FREE		2</span>
<span class="cp">#define SAL_INTR_REDIRECT	3</span>

<span class="cm">/*</span>
<span class="cm"> * operations available on the generic SN_SAL_SYSCTL_OP</span>
<span class="cm"> * runtime service</span>
<span class="cm"> */</span>
<span class="cp">#define SAL_SYSCTL_OP_IOBOARD		0x0001  </span><span class="cm">/*  retrieve board type */</span><span class="cp"></span>
<span class="cp">#define SAL_SYSCTL_OP_TIO_JLCK_RST      0x0002  </span><span class="cm">/* issue TIO clock reset */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * IRouter (i.e. generalized system controller) operations</span>
<span class="cm"> */</span>
<span class="cp">#define SAL_IROUTER_OPEN	0	</span><span class="cm">/* open a subchannel */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_CLOSE	1	</span><span class="cm">/* close a subchannel */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_SEND	2	</span><span class="cm">/* send part of an IRouter packet */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_RECV	3	</span><span class="cm">/* receive part of an IRouter packet */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_INTR_STATUS	4	</span><span class="cm">/* check the interrupt status for</span>
<span class="cm">					 * an open subchannel</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_INTR_ON	5	</span><span class="cm">/* enable an interrupt */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_INTR_OFF	6	</span><span class="cm">/* disable an interrupt */</span><span class="cp"></span>
<span class="cp">#define SAL_IROUTER_INIT	7	</span><span class="cm">/* initialize IRouter driver */</span><span class="cp"></span>

<span class="cm">/* IRouter interrupt mask bits */</span>
<span class="cp">#define SAL_IROUTER_INTR_XMIT	SAL_CONSOLE_INTR_XMIT</span>
<span class="cp">#define SAL_IROUTER_INTR_RECV	SAL_CONSOLE_INTR_RECV</span>

<span class="cm">/*</span>
<span class="cm"> * Error Handling Features</span>
<span class="cm"> */</span>
<span class="cp">#define SAL_ERR_FEAT_MCA_SLV_TO_OS_INIT_SLV	0x1	</span><span class="c1">// obsolete</span>
<span class="cp">#define SAL_ERR_FEAT_LOG_SBES			0x2	</span><span class="c1">// obsolete</span>
<span class="cp">#define SAL_ERR_FEAT_MFR_OVERRIDE		0x4</span>
<span class="cp">#define SAL_ERR_FEAT_SBE_THRESHOLD		0xffff0000</span>

<span class="cm">/*</span>
<span class="cm"> * SAL Error Codes</span>
<span class="cm"> */</span>
<span class="cp">#define SALRET_MORE_PASSES	1</span>
<span class="cp">#define SALRET_OK		0</span>
<span class="cp">#define SALRET_NOT_IMPLEMENTED	(-1)</span>
<span class="cp">#define SALRET_INVALID_ARG	(-2)</span>
<span class="cp">#define SALRET_ERROR		(-3)</span>

<span class="cp">#define SN_SAL_FAKE_PROM			   0x02009999</span>

<span class="cm">/**</span>
<span class="cm">  * sn_sal_revision - get the SGI SAL revision number</span>
<span class="cm">  *</span>
<span class="cm">  * The SGI PROM stores its version in the sal_[ab]_rev_(major|minor).</span>
<span class="cm">  * This routine simply extracts the major and minor values and</span>
<span class="cm">  * presents them in a u32 format.</span>
<span class="cm">  *</span>
<span class="cm">  * For example, version 4.05 would be represented at 0x0405.</span>
<span class="cm">  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">sn_sal_rev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_systab</span> <span class="o">*</span><span class="n">systab</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">efi</span><span class="p">.</span><span class="n">sal_systab</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">systab</span><span class="o">-&gt;</span><span class="n">sal_b_rev_major</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">systab</span><span class="o">-&gt;</span><span class="n">sal_b_rev_minor</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the master console nasid, if the call fails, return an illegal</span>
<span class="cm"> * value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_get_console_nasid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_GET_MASTER_NASID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Master console nasid is in &#39;v0&#39; */</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the master baseio nasid, if the call fails, return an illegal</span>
<span class="cm"> * value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_get_master_baseio_nasid</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_GET_MASTER_BASEIO_NASID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Master baseio nasid is in &#39;v0&#39; */</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">ia64_sn_get_klconfig_addr</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_GET_KLCONFIG_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nasid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">?</span> <span class="n">__va</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the next console character.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_getc</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_GETC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* character is in &#39;v0&#39; */</span>
	<span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a character from the SAL console device, after a previous interrupt</span>
<span class="cm"> * or poll operation has given us to know that a character is available</span>
<span class="cm"> * to be read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_readc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_READC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* character is in &#39;v0&#39; */</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sends the given character to the console.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_putc</span><span class="p">(</span><span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_PUTC</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sends the given buffer to the console.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_putb</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_PUTB</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Print a platform error record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_plat_specific_err_print</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="p">...),</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_PRINT_ERROR</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">hook</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">rec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check for Platform errors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_plat_cpei_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_LOG_CE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set Error Handling Features	(Obsolete)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_plat_set_error_handling_features</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_SET_ERROR_HANDLING_FEATURES</span><span class="p">,</span>
		<span class="n">SAL_ERR_FEAT_LOG_SBES</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks for console input.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_check</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_POLL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* result is in &#39;v0&#39; */</span>
	<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Checks console interrupt status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_intr_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_INTR</span><span class="p">,</span> 
		 <span class="mi">0</span><span class="p">,</span> <span class="n">SAL_CONSOLE_INTR_STATUS</span><span class="p">,</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable an interrupt on the SAL console device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ia64_sn_console_intr_enable</span><span class="p">(</span><span class="n">u64</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_INTR</span><span class="p">,</span> 
		 <span class="n">intr</span><span class="p">,</span> <span class="n">SAL_CONSOLE_INTR_ON</span><span class="p">,</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable an interrupt on the SAL console device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ia64_sn_console_intr_disable</span><span class="p">(</span><span class="n">u64</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_INTR</span><span class="p">,</span> 
		 <span class="n">intr</span><span class="p">,</span> <span class="n">SAL_CONSOLE_INTR_OFF</span><span class="p">,</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sends a character buffer to the console asynchronously.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_console_xmit_chars</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_CONSOLE_XMIT_CHARS</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">len</span><span class="p">,</span>
		 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the iobrick module Id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_sysctl_iobrick_module_get</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_IOBRICK_MODULE_GET</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* result is in &#39;v0&#39; */</span>
	<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ia64_sn_pod_mode - call the SN_SAL_POD_MODE function</span>
<span class="cm"> *</span>
<span class="cm"> * SN_SAL_POD_MODE actually takes an argument, but it&#39;s always</span>
<span class="cm"> * 0 when we call it from the kernel, so we don&#39;t have to expose</span>
<span class="cm"> * it to the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_pod_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">isrv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">isrv</span><span class="p">,</span> <span class="n">SN_SAL_POD_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ia64_sn_probe_mem - read from memory safely</span>
<span class="cm"> * @addr: address to probe</span>
<span class="cm"> * @size: number bytes to read (1,2,4,8)</span>
<span class="cm"> * @data_ptr: address to store value read by probe (-1 returned if probe fails)</span>
<span class="cm"> *</span>
<span class="cm"> * Call into the SAL to do a memory read.  If the read generates a machine</span>
<span class="cm"> * check, this routine will recover gracefully and return -1 to the caller.</span>
<span class="cm"> * @addr is usually a kernel virtual address in uncached space (i.e. the</span>
<span class="cm"> * address starts with 0xc), but if called in physical mode, @addr should</span>
<span class="cm"> * be a physical address.</span>
<span class="cm"> *</span>
<span class="cm"> * Return values:</span>
<span class="cm"> *  0 - probe successful</span>
<span class="cm"> *  1 - probe failed (generated MCA)</span>
<span class="cm"> *  2 - Bad arg</span>
<span class="cm"> * &lt;0 - PAL error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_probe_mem</span><span class="p">(</span><span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">isrv</span><span class="p">;</span>

	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">isrv</span><span class="p">,</span> <span class="n">SN_SAL_PROBE</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="o">*</span><span class="p">((</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="o">*</span><span class="p">((</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="n">data_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">isrv</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Retrieve the system serial number as an ASCII string.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_sys_serial_get</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_SYS_SERIAL_GET</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">extern</span> <span class="kt">char</span> <span class="n">sn_system_serial_number_string</span><span class="p">[];</span>
<span class="k">extern</span> <span class="n">u64</span> <span class="n">sn_partition_serial_number</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">sn_system_serial_number</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sn_system_serial_number_string</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">(</span><span class="n">sn_system_serial_number_string</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ia64_sn_sys_serial_get</span><span class="p">(</span><span class="n">sn_system_serial_number_string</span><span class="p">);</span>
		<span class="k">return</span><span class="p">(</span><span class="n">sn_system_serial_number_string</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
	

<span class="cm">/*</span>
<span class="cm"> * Returns a unique id number for this system and partition (suitable for</span>
<span class="cm"> * use with license managers), based in part on the system serial number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_partition_serial_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall_reentrant</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_PARTITION_SERIAL_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">sn_partition_serial_number_val</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sn_partition_serial_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sn_partition_serial_number</span> <span class="o">=</span> <span class="n">ia64_sn_partition_serial_get</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sn_partition_serial_number</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the partition id of the nasid passed in as an argument,</span>
<span class="cm"> * or INVALID_PARTID if the partition id cannot be retrieved.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">partid_t</span>
<span class="nf">ia64_sn_sysctl_partition_get</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_PARTITION_GET</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">partid_t</span><span class="p">)</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the physical address of the partition&#39;s reserved page through</span>
<span class="cm"> * an iterative number of calls.</span>
<span class="cm"> *</span>
<span class="cm"> * On first call, &#39;cookie&#39; and &#39;len&#39; should be set to 0, and &#39;addr&#39;</span>
<span class="cm"> * set to the nasid of the partition whose reserved page&#39;s address is</span>
<span class="cm"> * being sought.</span>
<span class="cm"> * On subsequent calls, pass the values, that were passed back on the</span>
<span class="cm"> * previous call.</span>
<span class="cm"> *</span>
<span class="cm"> * While the return status equals SALRET_MORE_PASSES, keep calling</span>
<span class="cm"> * this function after first copying &#39;len&#39; bytes starting at &#39;addr&#39;</span>
<span class="cm"> * into &#39;buf&#39;. Once the return status equals SALRET_OK, &#39;addr&#39; will</span>
<span class="cm"> * be the physical address of the partition&#39;s reserved page. If the</span>
<span class="cm"> * return status equals neither of these, an error as occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">s64</span>
<span class="nf">sn_partition_reserved_page_pa</span><span class="p">(</span><span class="n">u64</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall_reentrant</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_GET_PARTITION_ADDR</span><span class="p">,</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">rv</span><span class="p">.</span><span class="n">v1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">rv</span><span class="p">.</span><span class="n">v2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register or unregister a physical address range being referenced across</span>
<span class="cm"> * a partition boundary for which certain SAL errors should be scanned for,</span>
<span class="cm"> * cleaned up and ignored.  This is of value for kernel partitioning code only.</span>
<span class="cm"> * Values for the operation argument:</span>
<span class="cm"> *	1 = register this address range with SAL</span>
<span class="cm"> *	0 = unregister this address range with SAL</span>
<span class="cm"> * </span>
<span class="cm"> * SAL maintains a reference count on an address range in case it is registered</span>
<span class="cm"> * multiple times.</span>
<span class="cm"> * </span>
<span class="cm"> * On success, returns the reference count of the address range after the SAL</span>
<span class="cm"> * call has performed the current registration/unregistration.  Returns a</span>
<span class="cm"> * negative value if an error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_register_xp_addr_region</span><span class="p">(</span><span class="n">u64</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_XP_ADDR_REGION</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">operation</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register or unregister an instruction range for which SAL errors should</span>
<span class="cm"> * be ignored.  If an error occurs while in the registered range, SAL jumps</span>
<span class="cm"> * to return_addr after ignoring the error.  Values for the operation argument:</span>
<span class="cm"> *	1 = register this instruction range with SAL</span>
<span class="cm"> *	0 = unregister this instruction range with SAL</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or a negative value if an error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_register_nofault_code</span><span class="p">(</span><span class="n">u64</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">end_addr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">return_addr</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="k">virtual</span><span class="p">,</span> <span class="kt">int</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">call</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">call</span> <span class="o">=</span> <span class="n">SN_SAL_NO_FAULT_ZONE_VIRTUAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">call</span> <span class="o">=</span> <span class="n">SN_SAL_NO_FAULT_ZONE_PHYSICAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ia64_sal_oemcall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">,</span> <span class="n">return_addr</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register or unregister a function to handle a PMI received by a CPU.</span>
<span class="cm"> * Before calling the registered handler, SAL sets r1 to the value that</span>
<span class="cm"> * was passed in as the global_pointer.</span>
<span class="cm"> *</span>
<span class="cm"> * If the handler pointer is NULL, then the currently registered handler</span>
<span class="cm"> * will be unregistered.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or a negative value if an error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_register_pmi_handler</span><span class="p">(</span><span class="n">u64</span> <span class="n">handler</span><span class="p">,</span> <span class="n">u64</span> <span class="n">global_pointer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_REGISTER_PMI_HANDLER</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
			 <span class="n">global_pointer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change or query the coherence domain for this partition. Each cpu-based</span>
<span class="cm"> * nasid is represented by a bit in an array of 64-bit words:</span>
<span class="cm"> *      0 = not in this partition&#39;s coherency domain</span>
<span class="cm"> *      1 = in this partition&#39;s coherency domain</span>
<span class="cm"> *</span>
<span class="cm"> * It is not possible for the local system&#39;s nasids to be removed from</span>
<span class="cm"> * the coherency domain.  Purpose of the domain arguments:</span>
<span class="cm"> *      new_domain = set the coherence domain to the given nasids</span>
<span class="cm"> *      old_domain = return the current coherence domain</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or a negative value if an error occurred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_change_coherence</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="n">new_domain</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">old_domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall_nolock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_COHERENCE</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">new_domain</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">old_domain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change memory access protections for a physical address range.</span>
<span class="cm"> * nasid_array is not used on Altix, but may be in future architectures.</span>
<span class="cm"> * Available memory protection access classes are defined after the function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_change_memprotect</span><span class="p">(</span><span class="n">u64</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">,</span> <span class="n">u64</span> <span class="n">perms</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">nasid_array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ia64_sal_oemcall_nolock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_MEMPROTECT</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nasid_array</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_0		0x14a080</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_1		0x2520c2</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_2		0x14a1ca</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_3		0x14a290</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_6		0x084080</span>
<span class="cp">#define SN_MEMPROT_ACCESS_CLASS_7		0x021080</span>

<span class="cm">/*</span>
<span class="cm"> * Turns off system power.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ia64_sn_power_down</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>
	<span class="n">SAL_CALL</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_SYSTEM_POWER_DOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="cm">/* never returns */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ia64_sn_fru_capture - tell the system controller to capture hw state</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will call the SAL which will tell the system controller(s)</span>
<span class="cm"> * to capture hw mmr information from each SHub in the system.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_fru_capture</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">isrv</span><span class="p">;</span>
        <span class="n">SAL_CALL</span><span class="p">(</span><span class="n">isrv</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_FRU_CAPTURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Performs an operation on a PCI bus or slot -- power up, power down</span>
<span class="cm"> * or reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_sysctl_iobrick_pci_op</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">u64</span> <span class="n">connection_type</span><span class="p">,</span> 
			      <span class="n">u64</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">char</span> <span class="n">slot</span><span class="p">,</span> 
			      <span class="n">u64</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_IOBRICK_PCI_OP</span><span class="p">,</span> <span class="n">connection_type</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
		 <span class="n">bus</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
	    	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Open a subchannel for sending arbitrary data to the system</span>
<span class="cm"> * controller network via the system controller device associated with</span>
<span class="cm"> * &#39;nasid&#39;.  Return the subchannel number or a negative error code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_open</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_OPEN</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close system controller subchannel &#39;subch&#39; previously opened on &#39;nasid&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_close</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_CLOSE</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read data from system controller associated with &#39;nasid&#39; on</span>
<span class="cm"> * subchannel &#39;subch&#39;.  The buffer to be filled is pointed to by</span>
<span class="cm"> * &#39;buf&#39;, and its capacity is in the integer pointed to by &#39;len&#39;.  The</span>
<span class="cm"> * referent of &#39;len&#39; is set to the number of bytes read by the SAL</span>
<span class="cm"> * call.  The return value is either SALRET_OK (for bytes read) or</span>
<span class="cm"> * SALRET_ERROR (for error or &quot;no data available&quot;).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_recv</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_RECV</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">len</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write data to the system controller network via the system</span>
<span class="cm"> * controller associated with &#39;nasid&#39; on suchannel &#39;subch&#39;.  The</span>
<span class="cm"> * buffer to be written out is pointed to by &#39;buf&#39;, and &#39;len&#39; is the</span>
<span class="cm"> * number of bytes to be written.  The return value is either the</span>
<span class="cm"> * number of bytes written (which could be zero) or a negative error</span>
<span class="cm"> * code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_send</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_SEND</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">len</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether any interrupts are pending for the system controller</span>
<span class="cm"> * associated with &#39;nasid&#39; and its subchannel &#39;subch&#39;.  The return</span>
<span class="cm"> * value is a mask of pending interrupts (SAL_IROUTER_INTR_XMIT and/or</span>
<span class="cm"> * SAL_IROUTER_INTR_RECV).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_intr</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_INTR_STATUS</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable the interrupt indicated by the intr parameter (either</span>
<span class="cm"> * SAL_IROUTER_INTR_XMIT or SAL_IROUTER_INTR_RECV).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_intr_enable</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">,</span> <span class="n">u64</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_INTR_ON</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable the interrupt indicated by the intr parameter (either</span>
<span class="cm"> * SAL_IROUTER_INTR_XMIT or SAL_IROUTER_INTR_RECV).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_intr_disable</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subch</span><span class="p">,</span> <span class="n">u64</span> <span class="n">intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_INTR_OFF</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">subch</span><span class="p">,</span> <span class="n">intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up a node as the point of contact for system controller</span>
<span class="cm"> * environmental event delivery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_sysctl_event_init</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
        <span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ask the system controller on the specified nasid to reset</span>
<span class="cm"> * the CX corelet clock.  Only valid on TIO nodes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_sysctl_tio_clock_reset</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_OP</span><span class="p">,</span> <span class="n">SAL_SYSCTL_OP_TIO_JLCK_RST</span><span class="p">,</span>
			<span class="n">nasid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">v0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the associated ioboard type for a given nasid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">ia64_sn_sysctl_ioboard_get</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ioboard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">isrv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">isrv</span><span class="p">,</span> <span class="n">SN_SAL_SYSCTL_OP</span><span class="p">,</span> <span class="n">SAL_SYSCTL_OP_IOBOARD</span><span class="p">,</span>
			   <span class="n">nasid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isrv</span><span class="p">.</span><span class="n">v0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ioboard</span> <span class="o">=</span> <span class="n">isrv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isrv</span><span class="p">.</span><span class="n">v1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ioboard</span> <span class="o">=</span> <span class="n">isrv</span><span class="p">.</span><span class="n">v1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">isrv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ia64_sn_get_fit_compt - read a FIT entry from the PROM header</span>
<span class="cm"> * @nasid: NASID of node to read</span>
<span class="cm"> * @index: FIT entry index to be retrieved (0..n)</span>
<span class="cm"> * @fitentry: 16 byte buffer where FIT entry will be stored.</span>
<span class="cm"> * @banbuf: optional buffer for retrieving banner</span>
<span class="cm"> * @banlen: length of banner buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Access to the physical PROM chips needs to be serialized since reads and</span>
<span class="cm"> * writes can&#39;t occur at the same time, so we need to call into the SAL when</span>
<span class="cm"> * we want to look at the FIT entries on the chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *	%SALRET_OK if ok</span>
<span class="cm"> *	%SALRET_INVALID_ARG if index too big</span>
<span class="cm"> *	%SALRET_NOT_IMPLEMENTED if running on older PROM</span>
<span class="cm"> *	??? if nasid invalid OR banner buffer not large enough</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_get_fit_compt</span><span class="p">(</span><span class="n">u64</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">u64</span> <span class="n">index</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fitentry</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">banbuf</span><span class="p">,</span>
		      <span class="n">u64</span> <span class="n">banlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_GET_FIT_COMPT</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">fitentry</span><span class="p">,</span>
			<span class="n">banbuf</span><span class="p">,</span> <span class="n">banlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the SAL components of the system controller</span>
<span class="cm"> * communication driver; specifically pass in a sizable buffer that</span>
<span class="cm"> * can be used for allocation of subchannel queues as new subchannels</span>
<span class="cm"> * are opened.  &quot;buf&quot; points to the buffer, and &quot;len&quot; specifies its</span>
<span class="cm"> * length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_irtr_init</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_REENTRANT</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IROUTER_OP</span><span class="p">,</span> <span class="n">SAL_IROUTER_INIT</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the nasid, subnode &amp; slice corresponding to a SAPIC ID</span>
<span class="cm"> *</span>
<span class="cm"> *  In:</span>
<span class="cm"> *	arg0 - SN_SAL_GET_SAPIC_INFO</span>
<span class="cm"> *	arg1 - sapicid (lid &gt;&gt; 16) </span>
<span class="cm"> *  Out:</span>
<span class="cm"> *	v0 - nasid</span>
<span class="cm"> *	v1 - subnode</span>
<span class="cm"> *	v2 - slice</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_get_sapic_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">sapicid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">subnode</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">slice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_GET_SAPIC_INFO</span><span class="p">,</span> <span class="n">sapicid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/***** BEGIN HACK - temp til old proms no longer supported ********/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_NOT_IMPLEMENTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nasid</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid</span> <span class="o">=</span> <span class="n">sapicid</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subnode</span><span class="p">)</span> <span class="o">*</span><span class="n">subnode</span> <span class="o">=</span> <span class="p">(</span><span class="n">sapicid</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slice</span><span class="p">)</span> <span class="o">*</span><span class="n">slice</span> <span class="o">=</span> <span class="p">(</span><span class="n">sapicid</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/***** END HACK *******/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nasid</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subnode</span><span class="p">)</span> <span class="o">*</span><span class="n">subnode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slice</span><span class="p">)</span> <span class="o">*</span><span class="n">slice</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/*</span>
<span class="cm"> * Returns information about the HUB/SHUB.</span>
<span class="cm"> *  In:</span>
<span class="cm"> *	arg0 - SN_SAL_GET_SN_INFO</span>
<span class="cm"> * 	arg1 - 0 (other values reserved for future use)</span>
<span class="cm"> *  Out:</span>
<span class="cm"> *	v0 </span>
<span class="cm"> *		[7:0]   - shub type (0=shub1, 1=shub2)</span>
<span class="cm"> *		[15:8]  - Log2 max number of nodes in entire system (includes</span>
<span class="cm"> *			  C-bricks, I-bricks, etc)</span>
<span class="cm"> *		[23:16] - Log2 of nodes per sharing domain			 </span>
<span class="cm"> * 		[31:24] - partition ID</span>
<span class="cm"> * 		[39:32] - coherency_id</span>
<span class="cm"> * 		[47:40] - regionsize</span>
<span class="cm"> *	v1 </span>
<span class="cm"> *		[15:0]  - nasid mask (ex., 0x7ff for 11 bit nasid)</span>
<span class="cm"> *	 	[23:15] - bit position of low nasid bit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span>
<span class="nf">ia64_sn_get_sn_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">shubtype</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">nasid_bitmask</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">nasid_shift</span><span class="p">,</span> 
		<span class="n">u8</span> <span class="o">*</span><span class="n">systemsize</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sharing_domain_size</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">partid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">coher</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret_stuff</span><span class="p">.</span><span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_GET_SN_INFO</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/***** BEGIN HACK - temp til old proms no longer supported ********/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_NOT_IMPLEMENTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nasid</span> <span class="o">=</span> <span class="n">get_sapicid</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
<span class="cp">#define SH_SHUB_ID_NODES_PER_BIT_MASK 0x001f000000000000UL</span>
<span class="cp">#define SH_SHUB_ID_NODES_PER_BIT_SHFT 48</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shubtype</span><span class="p">)</span> <span class="o">*</span><span class="n">shubtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nasid_bitmask</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid_bitmask</span> <span class="o">=</span> <span class="mh">0x7ff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nasid_shift</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid_shift</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">systemsize</span><span class="p">)</span> <span class="o">*</span><span class="n">systemsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sharing_domain_size</span><span class="p">)</span> <span class="o">*</span><span class="n">sharing_domain_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">partid</span><span class="p">)</span> <span class="o">*</span><span class="n">partid</span> <span class="o">=</span> <span class="n">ia64_sn_sysctl_partition_get</span><span class="p">(</span><span class="n">nasid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">coher</span><span class="p">)</span> <span class="o">*</span><span class="n">coher</span> <span class="o">=</span> <span class="n">nasid</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH1_SHUB_ID</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SH_SHUB_ID_NODES_PER_BIT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">SH_SHUB_ID_NODES_PER_BIT_SHFT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/***** END HACK *******/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shubtype</span><span class="p">)</span> <span class="o">*</span><span class="n">shubtype</span> <span class="o">=</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">systemsize</span><span class="p">)</span> <span class="o">*</span><span class="n">systemsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sharing_domain_size</span><span class="p">)</span> <span class="o">*</span><span class="n">sharing_domain_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">partid</span><span class="p">)</span> <span class="o">*</span><span class="n">partid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">coher</span><span class="p">)</span> <span class="o">*</span><span class="n">coher</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nasid_bitmask</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid_bitmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nasid_shift</span><span class="p">)</span> <span class="o">*</span><span class="n">nasid_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret_stuff</span><span class="p">.</span><span class="n">v1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="cm">/*</span>
<span class="cm"> * This is the access point to the Altix PROM hardware performance</span>
<span class="cm"> * and status monitoring interface. For info on using this, see</span>
<span class="cm"> * arch/ia64/include/asm/sn/sn2/sn_hwperf.h</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_hwperf_op</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">u64</span> <span class="n">opcode</span><span class="p">,</span> <span class="n">u64</span> <span class="n">a0</span><span class="p">,</span> <span class="n">u64</span> <span class="n">a1</span><span class="p">,</span> <span class="n">u64</span> <span class="n">a2</span><span class="p">,</span>
                  <span class="n">u64</span> <span class="n">a3</span><span class="p">,</span> <span class="n">u64</span> <span class="n">a4</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">v0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_HWPERF_OP</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nasid</span><span class="p">,</span>
		<span class="n">opcode</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_ioif_get_pci_topology</span><span class="p">(</span><span class="n">u64</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u64</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_IOIF_GET_PCI_TOPOLOGY</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BTE error recovery is implemented in SAL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_bte_recovery</span><span class="p">(</span><span class="n">nasid_t</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_BTE_RECOVER</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">nasid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_NOT_IMPLEMENTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_is_fake_prom</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_FAKE_PROM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_get_prom_feature_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">feature_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_GET_PROM_FEATURE_SET</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">feature_set</span> <span class="o">=</span> <span class="n">rv</span><span class="p">.</span><span class="n">v0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_set_os_feature</span><span class="p">(</span><span class="kt">int</span> <span class="n">feature</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_SET_OS_FEATURE_SET</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_inject_error</span><span class="p">(</span><span class="n">u64</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">ecc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">ret_stuff</span><span class="p">;</span>

	<span class="n">ia64_sal_oemcall_nolock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret_stuff</span><span class="p">,</span> <span class="n">SN_SAL_INJECT_ERROR</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">data</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ecc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret_stuff</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_set_cpu_number</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_SET_CPU_NUMBER</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ia64_sn_kernel_launch_event</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">SAL_CALL_NOLOCK</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_KERNEL_LAUNCH_EVENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">sn_watchlist_u</span> <span class="p">{</span>
	<span class="n">u64</span>     <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u64</span>	<span class="n">blade</span>	<span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
			<span class="n">size</span>	<span class="o">:</span> <span class="mi">32</span><span class="p">,</span>
			<span class="n">filler</span>	<span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_mq_watchlist_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">blade</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mq_size</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">intr_mmr_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">sn_watchlist_u</span> <span class="n">size_blade</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">watchlist</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mq</span><span class="p">;</span>
	<span class="n">size_blade</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">mq_size</span><span class="p">;</span>
	<span class="n">size_blade</span><span class="p">.</span><span class="n">blade</span> <span class="o">=</span> <span class="n">blade</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * bios returns watchlist number or negative error number.</span>
<span class="cm">	 */</span>
	<span class="n">ia64_sal_oemcall_nolock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_WATCHLIST_ALLOC</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			<span class="n">size_blade</span><span class="p">.</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">intr_mmr_offset</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">watchlist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">watchlist</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sn_mq_watchlist_free</span><span class="p">(</span><span class="kt">int</span> <span class="n">blade</span><span class="p">,</span> <span class="kt">int</span> <span class="n">watchlist_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_sal_retval</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">ia64_sal_oemcall_nolock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="p">,</span> <span class="n">SN_SAL_WATCHLIST_FREE</span><span class="p">,</span> <span class="n">blade</span><span class="p">,</span>
			<span class="n">watchlist_num</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* _ASM_IA64_SN_SN_SAL_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
