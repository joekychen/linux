<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › ptrace.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ptrace.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel support for the ptrace() and syscall tracing interfaces.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2005 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> * Copyright (C) 2006 Intel Co</span>
<span class="cm"> *  2006-08-12	- IA64 Native Utrace implementation support added by</span>
<span class="cm"> *	Anil S Keshavamurthy &lt;anil.s.keshavamurthy@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from the x86 and Alpha versions.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/user.h&gt;</span>
<span class="cp">#include &lt;linux/security.h&gt;</span>
<span class="cp">#include &lt;linux/audit.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/regset.h&gt;</span>
<span class="cp">#include &lt;linux/elf.h&gt;</span>
<span class="cp">#include &lt;linux/tracehook.h&gt;</span>

<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace_offsets.h&gt;</span>
<span class="cp">#include &lt;asm/rse.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/unwind.h&gt;</span>
<span class="cp">#ifdef CONFIG_PERFMON</span>
<span class="cp">#include &lt;asm/perfmon.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;entry.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Bits in the PSR that we allow ptrace() to change:</span>
<span class="cm"> *	be, up, ac, mfl, mfh (the user mask; five bits total)</span>
<span class="cm"> *	db (debug breakpoint fault; one bit)</span>
<span class="cm"> *	id (instruction debug fault disable; one bit)</span>
<span class="cm"> *	dd (data debug fault disable; one bit)</span>
<span class="cm"> *	ri (restart instruction; two bits)</span>
<span class="cm"> *	is (instruction set; one bit)</span>
<span class="cm"> */</span>
<span class="cp">#define IPSR_MASK (IA64_PSR_UM | IA64_PSR_DB | IA64_PSR_IS	\</span>
<span class="cp">		   | IA64_PSR_ID | IA64_PSR_DD | IA64_PSR_RI)</span>

<span class="cp">#define MASK(nbits)	((1UL &lt;&lt; (nbits)) - 1)	</span><span class="cm">/* mask with NBITS bits set */</span><span class="cp"></span>
<span class="cp">#define PFM_MASK	MASK(38)</span>

<span class="cp">#define PTRACE_DEBUG	0</span>

<span class="cp">#if PTRACE_DEBUG</span>
<span class="cp"># define dprintk(format...)	printk(format)</span>
<span class="cp"># define inline</span>
<span class="cp">#else</span>
<span class="cp"># define dprintk(format...)</span>
<span class="cp">#endif</span>

<span class="cm">/* Return TRUE if PT was created due to kernel-entry via a system-call.  */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">in_syscall</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Collect the NaT bits for r1-r31 from scratch_unat and return a NaT</span>
<span class="cm"> * bitset where bit i is set iff the NaT bit of register i is set.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">ia64_get_scratch_nat_bits</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scratch_unat</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#	define GET_BITS(first, last, unat)				\</span>
<span class="cp">	({								\</span>
<span class="cp">		unsigned long bit = ia64_unat_pos(&amp;pt-&gt;r##first);	\</span>
<span class="cp">		unsigned long nbits = (last - first + 1);		\</span>
<span class="cp">		unsigned long mask = MASK(nbits) &lt;&lt; first;		\</span>
<span class="cp">		unsigned long dist;					\</span>
<span class="cp">		if (bit &lt; first)					\</span>
<span class="cp">			dist = 64 + bit - first;			\</span>
<span class="cp">		else							\</span>
<span class="cp">			dist = bit - first;				\</span>
<span class="cp">		ia64_rotr(unat, dist) &amp; mask;				\</span>
<span class="cp">	})</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Registers that are stored consecutively in struct pt_regs</span>
<span class="cm">	 * can be handled in parallel.  If the register order in</span>
<span class="cm">	 * struct_pt_regs changes, this code MUST be updated.</span>
<span class="cm">	 */</span>
	<span class="n">val</span>  <span class="o">=</span> <span class="n">GET_BITS</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">GET_BITS</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

<span class="cp">#	undef GET_BITS</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the NaT bits for the scratch registers according to NAT and</span>
<span class="cm"> * return the resulting unat (assuming the scratch registers are</span>
<span class="cm"> * stored in PT).</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">ia64_put_scratch_nat_bits</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nat</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#	define PUT_BITS(first, last, nat)				\</span>
<span class="cp">	({								\</span>
<span class="cp">		unsigned long bit = ia64_unat_pos(&amp;pt-&gt;r##first);	\</span>
<span class="cp">		unsigned long nbits = (last - first + 1);		\</span>
<span class="cp">		unsigned long mask = MASK(nbits) &lt;&lt; first;		\</span>
<span class="cp">		long dist;						\</span>
<span class="cp">		if (bit &lt; first)					\</span>
<span class="cp">			dist = 64 + bit - first;			\</span>
<span class="cp">		else							\</span>
<span class="cp">			dist = bit - first;				\</span>
<span class="cp">		ia64_rotl(nat &amp; mask, dist);				\</span>
<span class="cp">	})</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scratch_unat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Registers that are stored consecutively in struct pt_regs</span>
<span class="cm">	 * can be handled in parallel.  If the register order in</span>
<span class="cm">	 * struct_pt_regs changes, this code MUST be updated.</span>
<span class="cm">	 */</span>
	<span class="n">scratch_unat</span>  <span class="o">=</span> <span class="n">PUT_BITS</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>
	<span class="n">scratch_unat</span> <span class="o">|=</span> <span class="n">PUT_BITS</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scratch_unat</span><span class="p">;</span>

<span class="cp">#	undef PUT_BITS</span>
<span class="p">}</span>

<span class="cp">#define IA64_MLX_TEMPLATE	0x2</span>
<span class="cp">#define IA64_MOVL_OPCODE	6</span>

<span class="kt">void</span>
<span class="nf">ia64_increment_ip</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w0</span><span class="p">,</span> <span class="n">ri</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">w0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">IA64_MLX_TEMPLATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rfi&#39;ing to slot 2 of an MLX bundle causes</span>
<span class="cm">			 * an illegal operation fault.  We don&#39;t want</span>
<span class="cm">			 * that to happen...</span>
<span class="cm">			 */</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ia64_decrement_ip</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">w0</span><span class="p">,</span> <span class="n">ri</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">get_user</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">w0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="n">IA64_MLX_TEMPLATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rfi&#39;ing to slot 2 of an MLX bundle causes</span>
<span class="cm">			 * an illegal operation fault.  We don&#39;t want</span>
<span class="cm">			 * that to happen...</span>
<span class="cm">			 */</span>
			<span class="n">ri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="n">ri</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is used to read an rnat bits that are stored on the</span>
<span class="cm"> * kernel backing store.  Since, in general, the alignment of the user</span>
<span class="cm"> * and kernel are different, this is not completely trivial.  In</span>
<span class="cm"> * essence, we need to construct the user RNAT based on up to two</span>
<span class="cm"> * kernel RNAT values and/or the RNAT value saved in the child&#39;s</span>
<span class="cm"> * pt_regs.</span>
<span class="cm"> *</span>
<span class="cm"> * user rbs</span>
<span class="cm"> *</span>
<span class="cm"> * +--------+ &lt;-- lowest address</span>
<span class="cm"> * | slot62 |</span>
<span class="cm"> * +--------+</span>
<span class="cm"> * |  rnat  | 0x....1f8</span>
<span class="cm"> * +--------+</span>
<span class="cm"> * | slot00 | \</span>
<span class="cm"> * +--------+ |</span>
<span class="cm"> * | slot01 | &gt; child_regs-&gt;ar_rnat</span>
<span class="cm"> * +--------+ |</span>
<span class="cm"> * | slot02 | /				kernel rbs</span>
<span class="cm"> * +--------+				+--------+</span>
<span class="cm"> *	    &lt;- child_regs-&gt;ar_bspstore	| slot61 | &lt;-- krbs</span>
<span class="cm"> * +- - - - +				+--------+</span>
<span class="cm"> *					| slot62 |</span>
<span class="cm"> * +- - - - +				+--------+</span>
<span class="cm"> *					|  rnat	 |</span>
<span class="cm"> * +- - - - +				+--------+</span>
<span class="cm"> *   vrnat				| slot00 |</span>
<span class="cm"> * +- - - - +				+--------+</span>
<span class="cm"> *					=	 =</span>
<span class="cm"> *					+--------+</span>
<span class="cm"> *					| slot00 | \</span>
<span class="cm"> *					+--------+ |</span>
<span class="cm"> *					| slot01 | &gt; child_stack-&gt;ar_rnat</span>
<span class="cm"> *					+--------+ |</span>
<span class="cm"> *					| slot02 | /</span>
<span class="cm"> *					+--------+</span>
<span class="cm"> *						  &lt;--- child_stack-&gt;ar_bspstore</span>
<span class="cm"> *</span>
<span class="cm"> * The way to think of this code is as follows: bit 0 in the user rnat</span>
<span class="cm"> * corresponds to some bit N (0 &lt;= N &lt;= 62) in one of the kernel rnat</span>
<span class="cm"> * value.  The kernel rnat value holding this bit is stored in</span>
<span class="cm"> * variable rnat0.  rnat1 is loaded with the kernel rnat value that</span>
<span class="cm"> * form the upper bits of the user rnat value.</span>
<span class="cm"> *</span>
<span class="cm"> * Boundary cases:</span>
<span class="cm"> *</span>
<span class="cm"> * o when reading the rnat &quot;below&quot; the first rnat slot on the kernel</span>
<span class="cm"> *   backing store, rnat0/rnat1 are set to 0 and the low order bits are</span>
<span class="cm"> *   merged in from pt-&gt;ar_rnat.</span>
<span class="cm"> *</span>
<span class="cm"> * o when reading the rnat &quot;above&quot; the last rnat slot on the kernel</span>
<span class="cm"> *   backing store, rnat0/rnat1 gets its value from sw-&gt;ar_rnat.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">get_rnat</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">,</span>
	  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">urnat_addr</span><span class="p">,</span>
	  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">urbs_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rnat0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rnat1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">urnat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">slot0_kaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">umask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kbsp</span><span class="p">,</span> <span class="o">*</span><span class="n">ubspstore</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat0_kaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat1_kaddr</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">num_regs</span><span class="p">,</span> <span class="n">nbits</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">kbsp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="n">ubspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urbs_end</span> <span class="o">&lt;</span> <span class="n">urnat_addr</span><span class="p">)</span>
		<span class="n">nbits</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">urnat_addr</span> <span class="o">-</span> <span class="mi">63</span><span class="p">,</span> <span class="n">urbs_end</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nbits</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * First, figure out which bit number slot 0 in user-land maps</span>
<span class="cm">	 * to in the kernel rnat.  Do this by figuring out how many</span>
<span class="cm">	 * register slots we&#39;re beyond the user&#39;s backingstore and</span>
<span class="cm">	 * then computing the equivalent address in kernel space.</span>
<span class="cm">	 */</span>
	<span class="n">num_regs</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">ubspstore</span><span class="p">,</span> <span class="n">urnat_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">slot0_kaddr</span> <span class="o">=</span> <span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">num_regs</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">slot0_kaddr</span><span class="p">);</span>
	<span class="n">rnat1_kaddr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">slot0_kaddr</span><span class="p">);</span>
	<span class="n">rnat0_kaddr</span> <span class="o">=</span> <span class="n">rnat1_kaddr</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ubspstore</span> <span class="o">+</span> <span class="mi">63</span> <span class="o">&gt;</span> <span class="n">urnat_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some bits need to be merged in from pt-&gt;ar_rnat */</span>
		<span class="n">umask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">ubspstore</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">urnat</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">&amp;</span> <span class="n">umask</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">umask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">urnat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnat0_kaddr</span> <span class="o">&gt;=</span> <span class="n">kbsp</span><span class="p">)</span>
		<span class="n">rnat0</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rnat0_kaddr</span> <span class="o">&gt;</span> <span class="n">krbs</span><span class="p">)</span>
		<span class="n">rnat0</span> <span class="o">=</span> <span class="o">*</span><span class="n">rnat0_kaddr</span><span class="p">;</span>
	<span class="n">urnat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rnat0</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnat1_kaddr</span> <span class="o">&gt;=</span> <span class="n">kbsp</span><span class="p">)</span>
		<span class="n">rnat1</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rnat1_kaddr</span> <span class="o">&gt;</span> <span class="n">krbs</span><span class="p">)</span>
		<span class="n">rnat1</span> <span class="o">=</span> <span class="o">*</span><span class="n">rnat1_kaddr</span><span class="p">;</span>
	<span class="n">urnat</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rnat1</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">urnat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The reverse of get_rnat.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">put_rnat</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">,</span>
	  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">urnat_addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">urnat</span><span class="p">,</span>
	  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">urbs_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rnat0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rnat1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">slot0_kaddr</span><span class="p">,</span> <span class="n">umask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">kbsp</span><span class="p">,</span> <span class="o">*</span><span class="n">ubspstore</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat0_kaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat1_kaddr</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">num_regs</span><span class="p">,</span> <span class="n">nbits</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfm</span><span class="p">,</span> <span class="o">*</span><span class="n">urbs_kargs</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">kbsp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="n">ubspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>

	<span class="n">urbs_kargs</span> <span class="o">=</span> <span class="n">urbs_end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_syscall</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If entered via syscall, don&#39;t allow user to set rnat bits</span>
<span class="cm">		 * for syscall args.</span>
<span class="cm">		 */</span>
		<span class="n">cfm</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">;</span>
		<span class="n">urbs_kargs</span> <span class="o">=</span> <span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">urbs_end</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">cfm</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urbs_kargs</span> <span class="o">&gt;=</span> <span class="n">urnat_addr</span><span class="p">)</span>
		<span class="n">nbits</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">urnat_addr</span> <span class="o">-</span> <span class="mi">63</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">urbs_kargs</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">nbits</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">urnat_addr</span> <span class="o">-</span> <span class="mi">63</span><span class="p">,</span> <span class="n">urbs_kargs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">nbits</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, figure out which bit number slot 0 in user-land maps</span>
<span class="cm">	 * to in the kernel rnat.  Do this by figuring out how many</span>
<span class="cm">	 * register slots we&#39;re beyond the user&#39;s backingstore and</span>
<span class="cm">	 * then computing the equivalent address in kernel space.</span>
<span class="cm">	 */</span>
	<span class="n">num_regs</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">ubspstore</span><span class="p">,</span> <span class="n">urnat_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">slot0_kaddr</span> <span class="o">=</span> <span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">num_regs</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">slot0_kaddr</span><span class="p">);</span>
	<span class="n">rnat1_kaddr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">slot0_kaddr</span><span class="p">);</span>
	<span class="n">rnat0_kaddr</span> <span class="o">=</span> <span class="n">rnat1_kaddr</span> <span class="o">-</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ubspstore</span> <span class="o">+</span> <span class="mi">63</span> <span class="o">&gt;</span> <span class="n">urnat_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some bits need to be place in pt-&gt;ar_rnat: */</span>
		<span class="n">umask</span> <span class="o">=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">ubspstore</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">umask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">urnat</span> <span class="o">&amp;</span> <span class="n">umask</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">umask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Note: Section 11.1 of the EAS guarantees that bit 63 of an</span>
<span class="cm">	 * rnat slot is ignored. so we don&#39;t have to clear it here.</span>
<span class="cm">	 */</span>
	<span class="n">rnat0</span> <span class="o">=</span> <span class="p">(</span><span class="n">urnat</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnat0_kaddr</span> <span class="o">&gt;=</span> <span class="n">kbsp</span><span class="p">)</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rnat0</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rnat0_kaddr</span> <span class="o">&gt;</span> <span class="n">krbs</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rnat0_kaddr</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">rnat0_kaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rnat0</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">));</span>

	<span class="n">rnat1</span> <span class="o">=</span> <span class="p">(</span><span class="n">urnat</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">shift</span><span class="p">));</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">63</span> <span class="o">-</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rnat1_kaddr</span> <span class="o">&gt;=</span> <span class="n">kbsp</span><span class="p">)</span>
		<span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rnat1</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rnat1_kaddr</span> <span class="o">&gt;</span> <span class="n">krbs</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rnat1_kaddr</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">rnat1_kaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rnat1</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">on_kernel_rbs</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bspstore</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">urbs_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rnat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span>
						      <span class="n">urbs_end</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">bspstore</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rnat_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read a word from the user-level backing store of task CHILD.  ADDR</span>
<span class="cm"> * is the user-level address to read the word from, VAL a pointer to</span>
<span class="cm"> * the return value, and USER_BSP gives the end of the user-level</span>
<span class="cm"> * backing store (i.e., it&#39;s the address that would be in ar.bsp after</span>
<span class="cm"> * the user executed a &quot;cover&quot; instruction).</span>
<span class="cm"> *</span>
<span class="cm"> * This routine takes care of accessing the kernel register backing</span>
<span class="cm"> * store for those registers that got spilled there.  It also takes</span>
<span class="cm"> * care of calculating the appropriate RNaT collection words.</span>
<span class="cm"> */</span>
<span class="kt">long</span>
<span class="nf">ia64_peek</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">child_stack</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_end</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bspstore</span><span class="p">,</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="o">*</span><span class="n">laddr</span><span class="p">,</span> <span class="o">*</span><span class="n">urbs_end</span><span class="p">,</span> <span class="o">*</span><span class="n">rnat_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">child_regs</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">copied</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">urbs_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">user_rbs_end</span><span class="p">;</span>
	<span class="n">laddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">child_regs</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">child_regs</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="n">krbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">child</span> <span class="o">+</span> <span class="n">IA64_RBS_OFFSET</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on_kernel_rbs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bspstore</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urbs_end</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Attempt to read the RBS in an area that&#39;s actually</span>
<span class="cm">		 * on the kernel RBS =&gt; read the corresponding bits in</span>
<span class="cm">		 * the kernel RBS.</span>
<span class="cm">		 */</span>
		<span class="n">rnat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">laddr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_rnat</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">child_stack</span><span class="p">,</span> <span class="n">krbs</span><span class="p">,</span> <span class="n">rnat_addr</span><span class="p">,</span> <span class="n">urbs_end</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">laddr</span> <span class="o">==</span> <span class="n">rnat_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* return NaT collection word itself */</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">laddr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ret</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * It is implementation dependent whether the</span>
<span class="cm">			 * data portion of a NaT value gets saved on a</span>
<span class="cm">			 * st8.spill or RSE spill (e.g., see EAS 2.6,</span>
<span class="cm">			 * 4.4.4.6 Register Spill and Fill).  To get</span>
<span class="cm">			 * consistent behavior across all possible</span>
<span class="cm">			 * IA-64 implementations, we return zero in</span>
<span class="cm">			 * this case.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">laddr</span> <span class="o">&lt;</span> <span class="n">urbs_end</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The desired word is on the kernel RBS and</span>
<span class="cm">			 * is not a NaT.</span>
<span class="cm">			 */</span>
			<span class="n">regnum</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">bspstore</span><span class="p">,</span> <span class="n">laddr</span><span class="p">);</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">copied</span> <span class="o">=</span> <span class="n">access_process_vm</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span>
<span class="nf">ia64_poke</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">child_stack</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_end</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">bspstore</span><span class="p">,</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="o">*</span><span class="n">laddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">urbs_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">user_rbs_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">child_regs</span><span class="p">;</span>

	<span class="n">laddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">child_regs</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">child_regs</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="n">krbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">child</span> <span class="o">+</span> <span class="n">IA64_RBS_OFFSET</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on_kernel_rbs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bspstore</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urbs_end</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Attempt to write the RBS in an area that&#39;s actually</span>
<span class="cm">		 * on the kernel RBS =&gt; write the corresponding bits</span>
<span class="cm">		 * in the kernel RBS.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ia64_rse_is_rnat_slot</span><span class="p">(</span><span class="n">laddr</span><span class="p">))</span>
			<span class="n">put_rnat</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">child_stack</span><span class="p">,</span> <span class="n">krbs</span><span class="p">,</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				 <span class="n">urbs_end</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">laddr</span> <span class="o">&lt;</span> <span class="n">urbs_end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">regnum</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">bspstore</span><span class="p">,</span> <span class="n">laddr</span><span class="p">);</span>
				<span class="o">*</span><span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">regnum</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">access_process_vm</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		   <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the address of the end of the user-level register backing</span>
<span class="cm"> * store.  This is the address that would have been stored in ar.bsp</span>
<span class="cm"> * if the user had executed a &quot;cover&quot; instruction right before</span>
<span class="cm"> * entering the kernel.  If CFMP is not NULL, it is used to return the</span>
<span class="cm"> * &quot;current frame mask&quot; that was active at the time the kernel was</span>
<span class="cm"> * entered.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">ia64_get_user_rbs_end</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">cfmp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="o">*</span><span class="n">bspstore</span><span class="p">,</span> <span class="n">cfm</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ndirty</span><span class="p">;</span>

	<span class="n">krbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">child</span> <span class="o">+</span> <span class="n">IA64_RBS_OFFSET</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">bspstore</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="n">ndirty</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">krbs</span> <span class="o">+</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">loadrs</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_syscall</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
		<span class="n">ndirty</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cfm</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cfm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">);</span>	<span class="cm">/* clear valid bit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cfmp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cfmp</span> <span class="o">=</span> <span class="n">cfm</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">bspstore</span><span class="p">,</span> <span class="n">ndirty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronize (i.e, write) the RSE backing store living in kernel</span>
<span class="cm"> * space to the VM of the CHILD task.  SW and PT are the pointers to</span>
<span class="cm"> * the switch_stack and pt_regs structures, respectively.</span>
<span class="cm"> * USER_RBS_END is the user-level address at which the backing store</span>
<span class="cm"> * ends.</span>
<span class="cm"> */</span>
<span class="kt">long</span>
<span class="nf">ia64_sync_user_rbs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* now copy word for word from kernel rbs to user rbs: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">user_rbs_start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">user_rbs_end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ia64_peek</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">user_rbs_end</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">access_process_vm</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">ia64_sync_kernel_rbs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">user_rbs_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* now copy word for word from user rbs to kernel rbs: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="n">user_rbs_start</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">user_rbs_end</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">access_process_vm</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ia64_poke</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">user_rbs_end</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">syncfunc_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_sync_rbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">urbs_end</span><span class="p">;</span>
	<span class="n">syncfunc_t</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="n">urbs_end</span> <span class="o">=</span> <span class="n">ia64_get_user_rbs_end</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">fn</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">,</span> <span class="n">urbs_end</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * when a thread is stopped (ptraced), debugger might change thread&#39;s user</span>
<span class="cm"> * stack (change memory directly), and we must avoid the RSE stored in kernel</span>
<span class="cm"> * to override user stack (user space&#39;s RSE is newer than kernel&#39;s in the</span>
<span class="cm"> * case). To workaround the issue, we copy kernel RSE to user RSE before the</span>
<span class="cm"> * task is stopped, so user RSE has updated data.  we then copy user RSE to</span>
<span class="cm"> * kernel after the task is resummed from traced stop and kernel will use the</span>
<span class="cm"> * newer RSE to return to user. TIF_RESTORE_RSE is the flag to indicate we need</span>
<span class="cm"> * synchronize user RSE to kernel.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ia64_ptrace_stop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_tsk_thread_flag</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">TIF_RESTORE_RSE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">set_notify_resume</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">unw_init_running</span><span class="p">(</span><span class="n">do_sync_rbs</span><span class="p">,</span> <span class="n">ia64_sync_user_rbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called to read back the register backing store.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ia64_sync_krbs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_tsk_thread_flag</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">TIF_RESTORE_RSE</span><span class="p">);</span>

	<span class="n">unw_init_running</span><span class="p">(</span><span class="n">do_sync_rbs</span><span class="p">,</span> <span class="n">ia64_sync_kernel_rbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * After PTRACE_ATTACH, a thread&#39;s register backing store area in user</span>
<span class="cm"> * space is assumed to contain correct data whenever the thread is</span>
<span class="cm"> * stopped.  arch_ptrace_stop takes care of this on tracing stops.</span>
<span class="cm"> * But if the child was already stopped for job control when we attach</span>
<span class="cm"> * to it, then it might not ever get into ptrace_stop by the time we</span>
<span class="cm"> * want to examine the user memory containing the RBS.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ptrace_attach_sync_user_rbs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the child is in TASK_STOPPED, we need to change that to</span>
<span class="cm">	 * TASK_TRACED momentarily while we operate on it.  This ensures</span>
<span class="cm">	 * that the child won&#39;t be woken up and return to user mode while</span>
<span class="cm">	 * we are doing the sync.  (It can only be woken up for SIGKILL.)</span>
<span class="cm">	 */</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TASK_STOPPED</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_and_set_tsk_thread_flag</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TIF_RESTORE_RSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_notify_resume</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>

			<span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_TRACED</span><span class="p">;</span>
			<span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="n">do_sync_rbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">ia64_sync_user_rbs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now move the child back into TASK_STOPPED if it should be in a</span>
<span class="cm">	 * job control stop, so that SIGCONT can be used to wake it up.</span>
<span class="cm">	 */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">TASK_TRACED</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">signal</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SIGNAL_STOP_STOPPED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">child</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_STOPPED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tasklist_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">thread_matches</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thread_rbs_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">thread_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ptrace_check_attach</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the thread is not in an attachable state, we&#39;ll</span>
<span class="cm">		 * ignore it.  The net effect is that if ADDR happens</span>
<span class="cm">		 * to overlap with the portion of the thread&#39;s</span>
<span class="cm">		 * register backing store that is currently residing</span>
<span class="cm">		 * on the thread&#39;s kernel stack, then ptrace() may end</span>
<span class="cm">		 * up accessing a stale value.  But if the thread</span>
<span class="cm">		 * isn&#39;t stopped, that&#39;s a problem anyhow, so we&#39;re</span>
<span class="cm">		 * doing as well as we can...</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">thread_regs</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">thread_rbs_end</span> <span class="o">=</span> <span class="n">ia64_get_user_rbs_end</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span> <span class="n">thread_regs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on_kernel_rbs</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">thread_regs</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">,</span> <span class="n">thread_rbs_end</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* looks like we&#39;ve got a winner */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write f32-f127 back to task-&gt;thread.fph if it has been modified.</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ia64_flush_fph</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">task_pt_regs</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent migrating this task while</span>
<span class="cm">	 * we&#39;re fiddling with the FPU state</span>
<span class="cm">	 */</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_is_local_fpu_owner</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">psr</span><span class="o">-&gt;</span><span class="n">mfh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psr</span><span class="o">-&gt;</span><span class="n">mfh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">;</span>
		<span class="n">ia64_save_fpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">preempt_enable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sync the fph state of the task so that it can be manipulated</span>
<span class="cm"> * through thread.fph.  If necessary, f32-f127 are written back to</span>
<span class="cm"> * thread.fph or, if the fph state hasn&#39;t been used before, thread.fph</span>
<span class="cm"> * is cleared to zeroes.  Also, access to f32-f127 is disabled to</span>
<span class="cm"> * ensure that the task picks up the state from thread.fph when it</span>
<span class="cm"> * executes again.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ia64_sync_fph</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">task_pt_regs</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>

	<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ia64_drop_fpu</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
	<span class="n">psr</span><span class="o">-&gt;</span><span class="n">dfh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change the machine-state of CHILD such that it will return via the normal</span>
<span class="cm"> * kernel exit-path, rather than the syscall-exit path.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">convert_to_non_syscall</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span>  <span class="o">*</span><span class="n">pt</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">info</span><span class="p">,</span> <span class="n">prev_info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">pr</span><span class="p">;</span>

	<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">unw_get_sp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">child</span> <span class="o">+</span> <span class="n">IA64_STK_OFFSET</span> <span class="o">-</span> <span class="n">sp</span><span class="p">)</span>
		    <span class="o">&lt;</span> <span class="n">IA64_PT_REGS_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace.%s: ran off the top of the kernel &quot;</span>
				<span class="s">&quot;stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_pr</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">prev_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unw_get_rp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace.%s: failed to read &quot;</span>
				<span class="s">&quot;predicate register (ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_is_intr_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_USER_STACK</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: at the time of this call, the target task is blocked</span>
<span class="cm">	 * in notify_resume_user() and by clearling PRED_LEAVE_SYSCALL</span>
<span class="cm">	 * (aka, &quot;pLvSys&quot;) we redirect execution from</span>
<span class="cm">	 * .work_pending_syscall_end to .work_processed_kernel.</span>
<span class="cm">	 */</span>
	<span class="n">unw_get_pr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="p">);</span>
	<span class="n">pr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_SYSCALL</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_LEAVE_SYSCALL</span><span class="p">));</span>
	<span class="n">pr</span> <span class="o">|=</span>  <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_NON_SYSCALL</span><span class="p">);</span>
	<span class="n">unw_set_pr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev_info</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>

	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)</span> <span class="o">|</span> <span class="n">cfm</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clear the memory that is NOT written on syscall-entry to</span>
<span class="cm">	 * ensure we do not leak kernel-state to user when execution</span>
<span class="cm">	 * resumes.</span>
<span class="cm">	 */</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">r3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">r14</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* clear r16-r31 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>	<span class="cm">/* clear f6-f11 */</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">b7</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ccv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_csd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ssd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_nat_bits</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">nat_bits</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nat_bits</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
		<span class="n">scratch_unat</span> <span class="o">=</span> <span class="n">ia64_put_scratch_nat_bits</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">nat_bits</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_set_ar</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">UNW_AR_UNAT</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace: failed to set ar.unat</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unw_get_gr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat</span><span class="p">);</span>
			<span class="n">unw_set_gr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">nat_bits</span> <span class="o">&gt;&gt;</span> <span class="n">regnum</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_ar</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">UNW_AR_UNAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch_unat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace: failed to read ar.unat</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nat_bits</span> <span class="o">=</span> <span class="n">ia64_get_scratch_nat_bits</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">scratch_unat</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unw_get_gr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">regnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat</span><span class="p">);</span>
			<span class="n">nat_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">regnum</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">nat_bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">access_uarea</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">ptrace_getregs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_all_user_regs</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ppr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">rnat</span><span class="p">,</span> <span class="n">bsp</span><span class="p">,</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">nat_bits</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="n">fpval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">ppr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_all_user_regs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ksp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ppr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace:unaligned register address %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_CR_IPSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psr</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_EC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_LC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_RNAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rnat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_BSP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_CFM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfm</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_NAT_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat_bits</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* control regs */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">psr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">);</span>

	<span class="cm">/* app regs */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_PFS</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_RSC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_BSPSTORE</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_unat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_UNAT</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ccv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_CCV</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_FPSR</span><span class="p">]);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_EC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_LC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">rnat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_RNAT</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">bsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_BSP</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">cfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cfm</span><span class="p">);</span>

	<span class="cm">/* gr1-gr3 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* gr4-gr7 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_access_gr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* gr8-gr11 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r8</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* gr12-gr15 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r12</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r14</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r15</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>

	<span class="cm">/* gr16-gr31 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* b0 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* b1-b5 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_access_br</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">__put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* b6-b7 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="cm">/* fr2-fr5 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_fr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">fpval</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* fr6-fr11 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_fpreg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* fp scratch regs(12-15) */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">f12</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ia64_fpreg</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* fr16-fr31 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_fr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fpval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fpval</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">fpval</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* fph */</span>

	<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">32</span><span class="p">])</span> <span class="o">*</span> <span class="mi">96</span><span class="p">);</span>

	<span class="cm">/*  preds */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">);</span>

	<span class="cm">/* nat bits */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">nat_bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">nat</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">retval</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">ptrace_setregs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_all_user_regs</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ppr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">psr</span><span class="p">,</span> <span class="n">rsc</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">lc</span><span class="p">,</span> <span class="n">rnat</span><span class="p">,</span> <span class="n">bsp</span><span class="p">,</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">nat_bits</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="n">fpval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpval</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fpval</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">ppr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_all_user_regs</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ksp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">child</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ppr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace:unaligned register address %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* control regs */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">psr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">);</span>

	<span class="cm">/* app regs */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_PFS</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_RSC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_BSPSTORE</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_unat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_UNAT</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ccv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_CCV</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_FPSR</span><span class="p">]);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">ec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_EC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_LC</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">rnat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_RNAT</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">bsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">[</span><span class="n">PT_AUR_BSP</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">cfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">cfm</span><span class="p">);</span>

	<span class="cm">/* gr1-gr3 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* gr4-gr7 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="cm">/* NaT bit will be set via PT_NAT_BITS: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_set_gr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* gr8-gr11 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* gr12-gr15 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>

	<span class="cm">/* gr16-gr31 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* b0 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* b1-b5 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">unw_set_br</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* b6-b7 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="cm">/* fr2-fr5 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fpval</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_set_fr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fpval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fr6-fr11 */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* fp scratch regs(12-15) */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">f12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* fr16-fr31 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fpval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">fpval</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_set_fr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fpval</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fph */</span>

	<span class="n">ia64_sync_fph</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">fr</span><span class="p">[</span><span class="mi">32</span><span class="p">])</span> <span class="o">*</span> <span class="mi">96</span><span class="p">);</span>

	<span class="cm">/* preds */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">);</span>

	<span class="cm">/* nat bits */</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">nat_bits</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ppr</span><span class="o">-&gt;</span><span class="n">nat</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_CR_IPSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_RSC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_EC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_LC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_RNAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rnat</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_AR_BSP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_CFM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PT_NAT_BITS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat_bits</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">retval</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">user_enable_single_step</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">child_psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>

	<span class="n">set_tsk_thread_flag</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TIF_SINGLESTEP</span><span class="p">);</span>
	<span class="n">child_psr</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">user_enable_block_step</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">child_psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>

	<span class="n">set_tsk_thread_flag</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TIF_SINGLESTEP</span><span class="p">);</span>
	<span class="n">child_psr</span><span class="o">-&gt;</span><span class="n">tb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">user_disable_single_step</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">child_psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">task_pt_regs</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>

	<span class="cm">/* make sure the single step/taken-branch trap bits are not set: */</span>
	<span class="n">clear_tsk_thread_flag</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">TIF_SINGLESTEP</span><span class="p">);</span>
	<span class="n">child_psr</span><span class="o">-&gt;</span><span class="n">ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">child_psr</span><span class="o">-&gt;</span><span class="n">tb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by kernel/ptrace.c when detaching..</span>
<span class="cm"> *</span>
<span class="cm"> * Make sure the single step bit is not set.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ptrace_disable</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">user_disable_single_step</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">long</span>
<span class="nf">arch_ptrace</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">long</span> <span class="n">request</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PTRACE_PEEKTEXT</span>:
	<span class="k">case</span> <span class="n">PTRACE_PEEKDATA</span>:
		<span class="cm">/* read word at location addr */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">access_process_vm</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="cm">/* ensure return value is not mistaken for error code */</span>
		<span class="n">force_successful_syscall_return</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* PTRACE_POKETEXT and PTRACE_POKEDATA is handled</span>
<span class="cm">	 * by the generic ptrace_request().</span>
<span class="cm">	 */</span>

	<span class="k">case</span> <span class="n">PTRACE_PEEKUSR</span>:
		<span class="cm">/* read the word at addr in the USER area */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="cm">/* ensure return value is not mistaken for error code */</span>
		<span class="n">force_successful_syscall_return</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PTRACE_POKEUSR</span>:
		<span class="cm">/* write the word at addr in the USER area */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">access_uarea</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PTRACE_OLD_GETSIGINFO</span>:
		<span class="cm">/* for backwards-compatibility */</span>
		<span class="k">return</span> <span class="n">ptrace_request</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PTRACE_GETSIGINFO</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PTRACE_OLD_SETSIGINFO</span>:
		<span class="cm">/* for backwards-compatibility */</span>
		<span class="k">return</span> <span class="n">ptrace_request</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">PTRACE_SETSIGINFO</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PTRACE_GETREGS</span>:
		<span class="k">return</span> <span class="n">ptrace_getregs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
				      <span class="p">(</span><span class="k">struct</span> <span class="n">pt_all_user_regs</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">PTRACE_SETREGS</span>:
		<span class="k">return</span> <span class="n">ptrace_setregs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span>
				      <span class="p">(</span><span class="k">struct</span> <span class="n">pt_all_user_regs</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ptrace_request</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* &quot;asmlinkage&quot; so the input arguments are preserved... */</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">syscall_trace_enter</span> <span class="p">(</span><span class="kt">long</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg3</span><span class="p">,</span>
		     <span class="kt">long</span> <span class="n">arg4</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg5</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg6</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg7</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SYSCALL_TRACE</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tracehook_report_syscall_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="cm">/* copy user rbs to kernel rbs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_RESTORE_RSE</span><span class="p">))</span>
		<span class="n">ia64_sync_krbs</span><span class="p">();</span>


	<span class="n">audit_syscall_entry</span><span class="p">(</span><span class="n">AUDIT_ARCH_IA64</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">r15</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* &quot;asmlinkage&quot; so the input arguments are preserved... */</span>

<span class="n">asmlinkage</span> <span class="kt">void</span>
<span class="nf">syscall_trace_leave</span> <span class="p">(</span><span class="kt">long</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg3</span><span class="p">,</span>
		     <span class="kt">long</span> <span class="n">arg4</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg5</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg6</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg7</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">step</span><span class="p">;</span>

	<span class="n">audit_syscall_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">step</span> <span class="o">=</span> <span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SINGLESTEP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">||</span> <span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SYSCALL_TRACE</span><span class="p">))</span>
		<span class="n">tracehook_report_syscall_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>

	<span class="cm">/* copy user rbs to kernel rbs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_RESTORE_RSE</span><span class="p">))</span>
		<span class="n">ia64_sync_krbs</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Utrace implementation starts here */</span>
<span class="k">struct</span> <span class="n">regset_get</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">regset_set</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">regset_getset</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">regset_get</span> <span class="n">get</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">regset_set</span> <span class="n">set</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_elf_gpreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r2</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">...</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* read NaT bit first: */</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">unw_get_gr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">unw_access_gr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nat</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">...</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r8</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>:
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r12</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r15</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_elf_breg</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">...</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>:
		<span class="k">return</span> <span class="n">unw_access_br</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
				     <span class="n">data</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>:
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_elf_areg</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">urbs_end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">ELF_AR_RSC_OFFSET</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">ELF_AR_SSD_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ELF_AR_RSC_OFFSET</span>:
			<span class="cm">/* force PL3 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
				<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rsc</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rsc</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_BSP_OFFSET</span>:
			<span class="cm">/*</span>
<span class="cm">			 * By convention, we use PT_AR_BSP to refer to</span>
<span class="cm">			 * the end of the user-level backing store.</span>
<span class="cm">			 * Use ia64_rse_skip_regs(PT_AR_BSP, -CFM.sof)</span>
<span class="cm">			 * to get the real value of ar.bsp at the time</span>
<span class="cm">			 * the kernel was entered.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Furthermore, when changing the contents of</span>
<span class="cm">			 * PT_AR_BSP (or PT_CFM) while the task is</span>
<span class="cm">			 * blocked in a system call, convert the state</span>
<span class="cm">			 * so that the non-system-call exit</span>
<span class="cm">			 * path is used.  This ensures that the proper</span>
<span class="cm">			 * state will be picked up when resuming</span>
<span class="cm">			 * execution.  However, it *also* means that</span>
<span class="cm">			 * once we write PT_AR_BSP/PT_CFM, it won&#39;t be</span>
<span class="cm">			 * possible to modify the syscall arguments of</span>
<span class="cm">			 * the pending system call any longer.  This</span>
<span class="cm">			 * shouldn&#39;t be an issue because modifying</span>
<span class="cm">			 * PT_AR_BSP/PT_CFM generally implies that</span>
<span class="cm">			 * we&#39;re either abandoning the pending system</span>
<span class="cm">			 * call or that we defer it&#39;s re-execution</span>
<span class="cm">			 * (e.g., due to GDB doing an inferior</span>
<span class="cm">			 * function call).</span>
<span class="cm">			 */</span>
			<span class="n">urbs_end</span> <span class="o">=</span> <span class="n">ia64_get_user_rbs_end</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">!=</span> <span class="n">urbs_end</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">in_syscall</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
						<span class="n">convert_to_non_syscall</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
								       <span class="n">pt</span><span class="p">,</span>
								       <span class="n">cfm</span><span class="p">);</span>
					<span class="cm">/*</span>
<span class="cm">					 * Simulate user-level write</span>
<span class="cm">					 * of ar.bsp:</span>
<span class="cm">					 */</span>
					<span class="n">pt</span><span class="o">-&gt;</span><span class="n">loadrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">urbs_end</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_BSPSTORE_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_RNAT_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_CCV_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ccv</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_UNAT_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_unat</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_FPSR_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_PFS_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_LC_OFFSET</span>:
			<span class="k">return</span> <span class="n">unw_access_ar</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">UNW_AR_LC</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					     <span class="n">write_access</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ELF_AR_EC_OFFSET</span>:
			<span class="k">return</span> <span class="n">unw_access_ar</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">UNW_AR_EC</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					     <span class="n">write_access</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ELF_AR_CSD_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_csd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_AR_SSD_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ssd</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">ELF_CR_IIP_OFFSET</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">ELF_CR_IPSR_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ELF_CR_IIP_OFFSET</span>:
			<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_CFM_OFFSET</span>:
			<span class="n">urbs_end</span> <span class="o">=</span> <span class="n">ia64_get_user_rbs_end</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">cfm</span> <span class="o">^</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PFM_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">in_syscall</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
						<span class="n">convert_to_non_syscall</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
								       <span class="n">pt</span><span class="p">,</span>
								       <span class="n">cfm</span><span class="p">);</span>
					<span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="p">((</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PFM_MASK</span><span class="p">)</span>
						      <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">PFM_MASK</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cfm</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ELF_CR_IPSR_OFFSET</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
				<span class="cm">/* psr.ri==3 is a reserved value: SDM 2:25 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_RI</span><span class="p">)</span> <span class="o">==</span> <span class="n">IA64_PSR_RI</span><span class="p">)</span>
					<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IA64_PSR_RI</span><span class="p">;</span>
				<span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">IPSR_MASK</span><span class="p">)</span>
					       <span class="o">|</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IPSR_MASK</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="n">IPSR_MASK</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">access_nat_bits</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span>
				       <span class="n">data</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">ELF_PR_OFFSET</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_elf_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">access_elf_gpreg</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;=</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">access_elf_breg</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">access_elf_areg</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">write_access</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_gpregs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regset_getset</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">elf_greg_t</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">min_copy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * coredump format:</span>
<span class="cm">	 *      r0-r31</span>
<span class="cm">	 *      NaT bits (for r0-r31; bit N == 1 iff rN is a NaT)</span>
<span class="cm">	 *      predicate registers (p0-p63)</span>
<span class="cm">	 *      b0-b7</span>
<span class="cm">	 *      ip cfm user-mask</span>
<span class="cm">	 *      ar.rsc ar.bsp ar.bspstore ar.rnat</span>
<span class="cm">	 *      ar.ccv ar.unat ar.fpsr ar.pfs ar.lc ar.ec</span>
<span class="cm">	 */</span>


	<span class="cm">/* Skip r0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">,</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* gr1 - gr15 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">min_copy</span> <span class="o">=</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_copy</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span>
				<span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* r16-r31 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span>
				<span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* nat, pr, b0 - b7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">min_copy</span> <span class="o">=</span> <span class="n">ELF_CR_IIP_OFFSET</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_copy</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span>
				<span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_NAT_OFFSET</span><span class="p">,</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ip cfm psr ar.rsc ar.bsp ar.bspstore ar.rnat</span>
<span class="cm">	 * ar.ccv ar.unat ar.fpsr ar.pfs ar.lc ar.ec ar.csd ar.ssd</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ELF_AR_END_OFFSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">min_copy</span> <span class="o">=</span> <span class="n">ELF_AR_END_OFFSET</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="o">:</span> <span class="n">ELF_AR_END_OFFSET</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_copy</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span>
				<span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_CR_IIP_OFFSET</span><span class="p">,</span> <span class="n">ELF_AR_END_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_gpregs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regset_getset</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">elf_greg_t</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip r0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin_ignore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* gr1-gr15 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* gr16-gr31 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pt</span> <span class="o">=</span> <span class="n">task_pt_regs</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">r16</span><span class="p">,</span>
				<span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* nat, pr, b0 - b7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_NAT_OFFSET</span><span class="p">,</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ip cfm psr ar.rsc ar.bsp ar.bspstore ar.rnat</span>
<span class="cm">	 * ar.ccv ar.unat ar.fpsr ar.pfs ar.lc ar.ec ar.csd ar.ssd</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ELF_AR_END_OFFSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_CR_IIP_OFFSET</span><span class="p">,</span> <span class="n">ELF_AR_END_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">access_elf_reg</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define ELF_FP_OFFSET(i)	(i * sizeof(elf_fpreg_t))</span>

<span class="kt">void</span> <span class="nf">do_fpregs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regset_getset</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
	<span class="n">elf_fpreg_t</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">min_copy</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip pos 0 and 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout_zero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
						      <span class="mi">0</span><span class="p">,</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fr2-fr31 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">-</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">);</span>

		<span class="n">min_copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_copy</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span>
				<span class="n">index</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_fr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">i</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fph */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">)</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span>
				<span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* Zero fill instead.  */</span>
			<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyout_zero</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
				<span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_fpregs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regset_getset</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">elf_fpreg_t</span> <span class="n">fpreg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip pos 0 and 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin_ignore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fr2-fr31 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
			 <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span>
				<span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* only write high part */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_fr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">start</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">fpreg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span><span class="p">[</span><span class="n">start</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
				<span class="o">=</span> <span class="n">fpreg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">start</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xFUL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* only write low part */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_fr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">end</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">fpreg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span><span class="p">[</span><span class="n">end</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="o">=</span> <span class="n">fpreg</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">+</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFUL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span>	<span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span> <span class="p">;</span> <span class="n">start</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">start</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unw_set_fr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">||</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fph */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ia64_sync_fph</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">user_regset_copyin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">kbuf</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">.</span><span class="n">ubuf</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span>
						<span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">do_regset_call</span><span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">call</span><span class="p">)(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
	       <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
	       <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
	       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
	       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">regset_getset</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">,</span> <span class="p">.</span><span class="n">regset</span> <span class="o">=</span> <span class="n">regset</span><span class="p">,</span>
				 <span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">,</span> <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span>
				 <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">kbuf</span> <span class="o">=</span> <span class="n">kbuf</span><span class="p">,</span> <span class="p">.</span><span class="n">ubuf</span> <span class="o">=</span> <span class="n">ubuf</span> <span class="p">},</span>
				 <span class="p">.</span><span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
		<span class="n">unw_init_running</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">ufi</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ufi</span><span class="p">));</span>
		<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="n">target</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">call</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">info</span><span class="p">.</span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gpregs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
	   <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
	   <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_regset_call</span><span class="p">(</span><span class="n">do_gpregs_get</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regset</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="n">kbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gpregs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_regset_call</span><span class="p">(</span><span class="n">do_gpregs_set</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regset</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="n">kbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_gpregs_writeback</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_sync_rbs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">ia64_sync_user_rbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called to write back the register backing store.</span>
<span class="cm"> * ptrace does this before it stops, so that a tracer reading the user</span>
<span class="cm"> * memory after the thread stops will get the current register data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gpregs_writeback</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		 <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">now</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_tsk_thread_flag</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">TIF_RESTORE_RSE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_notify_resume</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">do_regset_call</span><span class="p">(</span><span class="n">do_gpregs_writeback</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fpregs_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">128</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpregs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_regset_call</span><span class="p">(</span><span class="n">do_fpregs_get</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regset</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="n">kbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpregs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="o">*</span><span class="n">regset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">kbuf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_regset_call</span><span class="p">(</span><span class="n">do_fpregs_set</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">regset</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
		<span class="n">kbuf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">access_uarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_access</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* an invalid value */</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">regnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace: unaligned register address 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">PT_NAT_BITS</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PT_F2</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">PT_R7</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PT_B1</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">PT_AR_LC</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PT_CR_IPSR</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">PT_AR_SSD</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">PT_DBR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace: rejecting access to register &quot;</span>
					<span class="s">&quot;address 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PT_F32</span> <span class="p">...</span> <span class="p">(</span><span class="n">PT_F127</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_F32</span> <span class="o">+</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_F2</span> <span class="p">...</span> <span class="p">(</span><span class="n">PT_F5</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_F2</span> <span class="o">+</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_F10</span> <span class="p">...</span> <span class="p">(</span><span class="n">PT_F31</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_F10</span> <span class="o">+</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_F6</span> <span class="p">...</span> <span class="p">(</span><span class="n">PT_F9</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_F6</span> <span class="o">+</span> <span class="n">ELF_FP_OFFSET</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fpregs_set</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fpregs_get</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PT_NAT_BITS</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_NAT_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_R4</span> <span class="p">...</span> <span class="n">PT_R7</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_R4</span> <span class="o">+</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_B1</span> <span class="p">...</span> <span class="n">PT_B5</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_B1</span> <span class="o">+</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_EC</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_EC_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_LC</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_LC_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_CR_IPSR</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_CR_IPSR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_CR_IIP</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_CR_IIP_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_CFM</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_CFM_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_UNAT</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_UNAT_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_PFS</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_PFS_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_RSC</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_RSC_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_RNAT</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_RNAT_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_BSPSTORE</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_BSPSTORE_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_PR</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_PR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_B6</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_BSP</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_BSP_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_R1</span> <span class="p">...</span> <span class="n">PT_R3</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_R1</span> <span class="o">+</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_R12</span> <span class="p">...</span> <span class="n">PT_R15</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_R12</span> <span class="o">+</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_R8</span> <span class="p">...</span> <span class="n">PT_R11</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_R8</span> <span class="o">+</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_R16</span> <span class="p">...</span> <span class="n">PT_R31</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">PT_R16</span> <span class="o">+</span> <span class="n">ELF_GR_OFFSET</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_CCV</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_CCV_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_FPSR</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_FPSR_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_B0</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_B7</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_BR_OFFSET</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_CSD</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_CSD_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PT_AR_SSD</span>:
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ELF_AR_SSD_OFFSET</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gpregs_set</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">gpregs_get</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* access debug registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">PT_IBR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">PT_IBR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ibr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">-</span> <span class="n">PT_DBR</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ptrace: rejecting access to register &quot;</span>
				<span class="s">&quot;address 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PERFMON</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if debug registers are used by perfmon. This</span>
<span class="cm">	 * test must be done once we know that we can do the</span>
<span class="cm">	 * operation, i.e. the arguments are all valid, but</span>
<span class="cm">	 * before we start modifying the state.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Perfmon needs to keep a count of how many processes</span>
<span class="cm">	 * are trying to modify the debug registers for system</span>
<span class="cm">	 * wide monitoring sessions.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We also include read access here, because they may</span>
<span class="cm">	 * cause the PMU-installed debug register state</span>
<span class="cm">	 * (dbr[], ibr[]) to be reset. The two arrays are also</span>
<span class="cm">	 * used by perfmon, but we do not use</span>
<span class="cm">	 * IA64_THREAD_DBG_VALID. The registers are restored</span>
<span class="cm">	 * by the PMU context switch code.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pfm_use_debug_registers</span><span class="p">(</span><span class="n">child</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_DBG_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_THREAD_DBG_VALID</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">dbr</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ibr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ibr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">regnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">regnum</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">write_access</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t let the user set kernel-level breakpoints: */</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">7UL</span> <span class="o">&lt;&lt;</span> <span class="mi">56</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_access</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset</span> <span class="n">native_regsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">core_note_type</span> <span class="o">=</span> <span class="n">NT_PRSTATUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">ELF_NGREG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span> <span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_greg_t</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">gpregs_get</span><span class="p">,</span> <span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">gpregs_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">writeback</span> <span class="o">=</span> <span class="n">gpregs_writeback</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">core_note_type</span> <span class="o">=</span> <span class="n">NT_PRFPREG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">ELF_NFPREG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span> <span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_fpreg_t</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">fpregs_get</span><span class="p">,</span> <span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">fpregs_set</span><span class="p">,</span> <span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">fpregs_active</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset_view</span> <span class="n">user_ia64_view</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ia64&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">e_machine</span> <span class="o">=</span> <span class="n">EM_IA_64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regsets</span> <span class="o">=</span> <span class="n">native_regsets</span><span class="p">,</span> <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">native_regsets</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">user_regset_view</span> <span class="o">*</span><span class="nf">task_user_regset_view</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tsk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">user_ia64_view</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">syscall_get_set_args</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rw</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">syscall_get_set_args_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">syscall_get_set_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">krbs</span><span class="p">,</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">ndirty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cfm</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">;</span>
	<span class="n">krbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">+</span> <span class="n">IA64_RBS_OFFSET</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">ndirty</span> <span class="o">=</span> <span class="n">ia64_rse_num_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">krbs</span> <span class="o">+</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">loadrs</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">));</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_syscall</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> <span class="n">cfm</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span> <span class="n">ndirty</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">ia64_rse_skip_regs</span><span class="p">(</span><span class="n">krbs</span><span class="p">,</span>
				<span class="n">ndirty</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">rw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ia64_syscall_get_set_arguments</span><span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">syscall_get_set_args</span> <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span>
		<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span>
		<span class="p">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">,</span>
		<span class="p">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">regs</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rw</span> <span class="o">=</span> <span class="n">rw</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
		<span class="n">unw_init_running</span><span class="p">(</span><span class="n">syscall_get_set_args_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="n">ufi</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ufi</span><span class="p">));</span>
		<span class="n">unw_init_from_blocked_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
		<span class="n">syscall_get_set_args_cb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
