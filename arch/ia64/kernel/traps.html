<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › traps.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>traps.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Architecture-specific trap handling.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998-2003 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 05/12/00 grao &lt;goutham.rao@intel.com&gt; : added isr in siginfo for SIGFPE</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;		</span><span class="cm">/* For unblank_screen() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/module.h&gt;       </span><span class="cm">/* for EXPORT_SYMBOL */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/kprobes.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;		</span><span class="cm">/* for ssleep() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kdebug.h&gt;</span>

<span class="cp">#include &lt;asm/fpswa.h&gt;</span>
<span class="cp">#include &lt;asm/intrinsics.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>

<span class="n">fpswa_interface_t</span> <span class="o">*</span><span class="n">fpswa_interface</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">fpswa_interface</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">trap_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_boot_param</span><span class="o">-&gt;</span><span class="n">fpswa</span><span class="p">)</span>
		<span class="cm">/* FPSWA fixup: make the interface pointer a kernel virtual address: */</span>
		<span class="n">fpswa_interface</span> <span class="o">=</span> <span class="n">__va</span><span class="p">(</span><span class="n">ia64_boot_param</span><span class="o">-&gt;</span><span class="n">fpswa</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">die</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">lock_owner</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">lock_owner_depth</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">die</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">lock</span> <span class="o">=</span>	<span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">die</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
		<span class="p">.</span><span class="n">lock_owner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lock_owner_depth</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">die_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span> <span class="o">=</span> <span class="n">get_cpu</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">die</span><span class="p">.</span><span class="n">lock_owner</span> <span class="o">!=</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">console_verbose</span><span class="p">();</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">die</span><span class="p">.</span><span class="n">lock_owner</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
		<span class="n">die</span><span class="p">.</span><span class="n">lock_owner_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bust_spinlocks</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">die</span><span class="p">.</span><span class="n">lock_owner_depth</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s[%d]: %s %ld [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">str</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">++</span><span class="n">die_counter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_OOPS</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">SIGSEGV</span><span class="p">)</span>
	            <span class="o">!=</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="n">show_regs</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Recursive die() failure, output suppressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bust_spinlocks</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">die</span><span class="p">.</span><span class="n">lock_owner</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">add_taint</span><span class="p">(</span><span class="n">TAINT_DIE</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">die</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">panic_on_oops</span><span class="p">)</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;Fatal exception&quot;</span><span class="p">);</span>

  	<span class="n">do_exit</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">die_if_kernel</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">long</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="n">regs</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">die</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">__kprobes</span> <span class="nf">ia64_bad_break</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">break_num</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">siginfo_t</span> <span class="n">siginfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="n">code</span><span class="p">;</span>

	<span class="cm">/* SIGILL, SIGFPE, SIGSEGV, and SIGBUS want these field initialized: */</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">);</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="n">break_num</span><span class="p">;</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* clear __ISR_VALID */</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">break_num</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* unknown error (used by GCC for __builtin_abort()) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_BREAK</span><span class="p">,</span> <span class="s">&quot;break 0&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">break_num</span><span class="p">,</span> <span class="n">TRAP_BRKPT</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span>
			       	<span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;bugcheck!&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">break_num</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* integer divide by zero */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">FPE_INTDIV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* integer overflow */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">FPE_INTOVF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* range check/bounds check */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">FPE_FLTSUB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* null pointer dereference */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">SEGV_MAPERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* misaligned data */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">BUS_ADRALN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* decimal overflow */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__FPE_DECOVF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* decimal divide by zero */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__FPE_DECDIV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* packed decimal error */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__FPE_DECERR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* invalid ASCII digit */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__FPE_INVASC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* invalid decimal digit */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__FPE_INVDEC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">11</span>: <span class="cm">/* paragraph stack overflow */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__SEGV_PSTKOVF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mh">0x3f000</span> <span class="p">...</span> <span class="mh">0x3ffff</span>:	<span class="cm">/* bundle-update in progress */</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__ILL_BNDMOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">break_num</span> <span class="o">&lt;</span> <span class="mh">0x40000</span> <span class="o">||</span> <span class="n">break_num</span> <span class="o">&gt;</span> <span class="mh">0x100000</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">die_if_kernel</span><span class="p">(</span><span class="s">&quot;Bad break&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">break_num</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">break_num</span> <span class="o">&lt;</span> <span class="mh">0x80000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">__ILL_BREAK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_BREAK</span><span class="p">,</span> <span class="s">&quot;bad break&quot;</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">break_num</span><span class="p">,</span> <span class="n">TRAP_BRKPT</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span>
					<span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="n">TRAP_BRKPT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disabled_fph_fault() is called when a user-level process attempts to access f32..f127</span>
<span class="cm"> * and it doesn&#39;t own the fp-high register partition.  When this happens, we save the</span>
<span class="cm"> * current fph partition in the task_struct of the fpu-owner (if necessary) and then load</span>
<span class="cm"> * the fp-high partition of the current task (if necessary).  Note that the kernel has</span>
<span class="cm"> * access to fph by the time we get here, as the IVT&#39;s &quot;Disabled FP-Register&quot; handler takes</span>
<span class="cm"> * care of clearing psr.dfh.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">disabled_fph_fault</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="cm">/* first, grant user-level access to fph partition: */</span>
	<span class="n">psr</span><span class="o">-&gt;</span><span class="n">dfh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure that no other task gets in on this processor</span>
<span class="cm">	 * while we&#39;re claiming the FPU</span>
<span class="cm">	 */</span>
	<span class="n">preempt_disable</span><span class="p">();</span>
<span class="cp">#ifndef CONFIG_SMP</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">fpu_owner</span>
			<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">ia64_get_kr</span><span class="p">(</span><span class="n">IA64_KR_FPU_OWNER</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ia64_is_local_fpu_owner</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">preempt_enable_no_resched</span><span class="p">();</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fpu_owner</span><span class="p">)</span>
			<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">fpu_owner</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_SMP */</span><span class="cp"></span>
	<span class="n">ia64_set_local_fpu_owner</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ia64_load_fpu</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">);</span>
		<span class="n">psr</span><span class="o">-&gt;</span><span class="n">mfh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__ia64_init_fpu</span><span class="p">();</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set mfh because the state in thread.fph does not match the state in</span>
<span class="cm">		 * the fph partition.</span>
<span class="cm">		 */</span>
		<span class="n">psr</span><span class="o">-&gt;</span><span class="n">mfh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">preempt_enable_no_resched</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">fp_emulate</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fp_fault</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bundle</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ipsr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">fpsr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">isr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">pr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ifs</span><span class="p">,</span>
	    <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fp_state_t</span> <span class="n">fp_state</span><span class="p">;</span>
	<span class="n">fpswa_ret_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fpswa_interface</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fp_state_t</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * compute fp_state.  only FP registers f6 - f11 are used by the</span>
<span class="cm">	 * kernel, so set those bits in the mask and set the low volatile</span>
<span class="cm">	 * pointer to point to these registers.</span>
<span class="cm">	 */</span>
	<span class="n">fp_state</span><span class="p">.</span><span class="n">bitmask_low64</span> <span class="o">=</span> <span class="mh">0xfc0</span><span class="p">;</span>  <span class="cm">/* bit6..bit11 */</span>

	<span class="n">fp_state</span><span class="p">.</span><span class="n">fp_state_low_volatile</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp_state_low_volatile_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">f6</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * unsigned long (*EFI_FPSWA) (</span>
<span class="cm">	 *      unsigned long    trap_type,</span>
<span class="cm">	 *	void             *Bundle,</span>
<span class="cm">	 *	unsigned long    *pipsr,</span>
<span class="cm">	 *	unsigned long    *pfsr,</span>
<span class="cm">	 *	unsigned long    *pisr,</span>
<span class="cm">	 *	unsigned long    *ppreds,</span>
<span class="cm">	 *	unsigned long    *pifs,</span>
<span class="cm">	 *	void             *fp_state);</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fpswa_interface</span><span class="o">-&gt;</span><span class="n">fpswa</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">fp_fault</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">ipsr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">fpsr</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">isr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">pr</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fp_state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fpu_swa_msg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">DEFINE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">fpu_swa_msg</span><span class="p">,</span> <span class="n">cpulast</span><span class="p">);</span>
<span class="n">DECLARE_PER_CPU</span><span class="p">(</span><span class="k">struct</span> <span class="n">fpu_swa_msg</span><span class="p">,</span> <span class="n">cpulast</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fpu_swa_msg</span> <span class="n">last</span> <span class="n">__cacheline_aligned</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Handle floating-point assist faults and traps.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_fpu_swa</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fp_fault</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">exception</span><span class="p">,</span> <span class="n">bundle</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fault_ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">siginfo</span><span class="p">;</span>

	<span class="n">fault_ip</span> <span class="o">=</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp_fault</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">fault_ip</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">bundle</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">fault_ip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bundle</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPEMU_NOPRINT</span><span class="p">))</span>  <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">current_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fpu_swa_msg</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__get_cpu_var</span><span class="p">(</span><span class="n">cpulast</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">current_jiffies</span> <span class="o">&gt;</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">))</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cp</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">current_jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

			<span class="cm">/* minimize races by grabbing a copy of count BEFORE checking last.time. */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">last</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">barrier</span><span class="p">();</span>

			<span class="cm">/*</span>
<span class="cm">			 * Lower 4 bits are used as a count. Upper bits are a sequence</span>
<span class="cm">			 * number that is updated when count is reset. The cmpxchg will</span>
<span class="cm">			 * fail is seqno has changed. This minimizes mutiple cpus</span>
<span class="cm">			 * resetting the count.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_jiffies</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">.</span><span class="n">time</span><span class="p">)</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cmpxchg_acq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">));</span>

			<span class="cm">/* used fetchadd to atomically update the count */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">last</span><span class="p">.</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ia64_fetchadd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">last</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">acq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">last</span><span class="p">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">current_jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       			<span class="s">&quot;%s(%d): floating-point assist fault at ip %016lx, isr %016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       			<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">exception</span> <span class="o">=</span> <span class="n">fp_emulate</span><span class="p">(</span><span class="n">fp_fault</span><span class="p">,</span> <span class="n">bundle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ipsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_ifs</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fp_fault</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* emulation was successful */</span>
			<span class="n">ia64_increment_ip</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;handle_fpu_swa: fp_emulate() returned -1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* is next instruction a trap? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ia64_increment_ip</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>	<span class="cm">/* default code */</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x22</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* denormal operand gets the same si_code as underflow </span>
<span class="cm">				* see arch/i386/kernel/traps.c:math_error()  */</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x44</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTDIV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;handle_fpu_swa: fp_emulate() returned -1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* raise exception */</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">__SI_FAULT</span><span class="p">;</span>	<span class="cm">/* default code */</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x880</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTOVF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x1100</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTUND</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x2200</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTRES</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">illegal_op_return</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fkt</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">illegal_op_return</span>
<span class="nf">ia64_illegal_op_fault</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ec</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg3</span><span class="p">,</span>
		       <span class="kt">long</span> <span class="n">arg4</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg5</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg6</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg7</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">illegal_op_return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="cp">#ifdef CONFIG_IA64_BRL_EMU</span>
	<span class="p">{</span>
		<span class="k">extern</span> <span class="k">struct</span> <span class="n">illegal_op_return</span> <span class="n">ia64_emulate_brl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

		<span class="n">rv</span> <span class="o">=</span> <span class="n">ia64_emulate_brl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">ec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">.</span><span class="n">fkt</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;IA-64 Illegal operation fault&quot;</span><span class="p">);</span>
	<span class="n">rv</span><span class="p">.</span><span class="n">fkt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">die_if_kernel</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPC</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">);</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__kprobes</span>
<span class="nf">ia64_fault</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ifa</span><span class="p">,</span>
	    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iim</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">itir</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg5</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg6</span><span class="p">,</span>
	    <span class="kt">long</span> <span class="n">arg7</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">isr</span><span class="p">,</span> <span class="n">iip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">siginfo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">sig</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;IA-64 Illegal Operation fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;IA-64 Privileged Operation fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;IA-64 Privileged Register fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;IA-64 Reserved Register/Field fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;Disabled Instruction Set Transition fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;Unknown fault 5&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 6&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 7&quot;</span><span class="p">,</span> <span class="s">&quot;Illegal Hazard fault&quot;</span><span class="p">,</span>
		<span class="s">&quot;Unknown fault 9&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 10&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 11&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 12&quot;</span><span class="p">,</span>
		<span class="s">&quot;Unknown fault 13&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 14&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown fault 15&quot;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IA64_ISR_NA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">IA64_ISR_CODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IA64_ISR_CODE_LFETCH</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This fault was due to lfetch.fault, set &quot;ed&quot; bit in the psr to cancel</span>
<span class="cm">		 * the lfetch.</span>
<span class="cm">		 */</span>
		<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iip</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="mi">24</span>: <span class="cm">/* General Exception */</span>
		<span class="n">code</span> <span class="o">=</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;General Exception: %s%s&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">[</span><span class="n">code</span><span class="p">],</span>
			<span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">37</span><span class="p">))</span>
				       <span class="o">?</span> <span class="s">&quot; (RSE access)&quot;</span> <span class="o">:</span> <span class="s">&quot; (data access)&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
<span class="cp"># ifdef CONFIG_IA64_PRINT_HAZARDS</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s[%d]: possible hazard @ ip=%016lx (pr = %016lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span>
			       <span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">pr</span><span class="p">);</span>
<span class="cp"># endif</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">25</span>: <span class="cm">/* Disabled FP-Register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disabled_fph_fault</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Disabled FPL fault---not supposed to happen!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">26</span>: <span class="cm">/* NaT Consumption */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(((</span><span class="n">isr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* NaT page consumption */</span>
				<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">SEGV_ACCERR</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifa</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* register NaT consumption */</span>
				<span class="n">sig</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
				<span class="n">code</span> <span class="o">=</span> <span class="n">ILL_ILLOPN</span><span class="p">;</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span>
							<span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ia64_done_with_exception</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;NaT consumption&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">31</span>: <span class="cm">/* Unsupported Data Reference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_ILLOPN</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">iip</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="n">vector</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Unsupported data reference&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">29</span>: <span class="cm">/* Debug */</span>
	      <span class="k">case</span> <span class="mi">35</span>: <span class="cm">/* Taken Branch Trap */</span>
	      <span class="k">case</span> <span class="mi">36</span>: <span class="cm">/* Single Step Trap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fsys_mode</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">extern</span> <span class="kt">char</span> <span class="n">__kernel_syscall_via_break</span><span class="p">[];</span>
			<span class="cm">/*</span>
<span class="cm">			 * Got a trap in fsys-mode: Taken Branch Trap</span>
<span class="cm">			 * and Single Step trap need special handling;</span>
<span class="cm">			 * Debug trap is ignored (we disable it here</span>
<span class="cm">			 * and re-enable it in the lower-privilege trap).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vector</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_thread_flag</span><span class="p">(</span><span class="n">TIF_DB_DISABLED</span><span class="p">);</span>
				<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* re-do the system call via break 0x100000: */</span>
			<span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__kernel_syscall_via_break</span><span class="p">;</span>
			<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cpl</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vector</span><span class="p">)</span> <span class="p">{</span>
		      <span class="k">case</span> <span class="mi">29</span>:
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_HWBKPT</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ITANIUM</span>
			<span class="cm">/*</span>
<span class="cm">			 * Erratum 10 (IFA may contain incorrect address) now has</span>
<span class="cm">			 * &quot;NoFix&quot; status.  There are no plans for fixing this.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			  <span class="n">ifa</span> <span class="o">=</span> <span class="n">regs</span><span class="p">.</span><span class="n">cr_iip</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		      <span class="k">case</span> <span class="mi">35</span>: <span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_BRANCH</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		      <span class="k">case</span> <span class="mi">36</span>: <span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">TRAP_TRACE</span><span class="p">;</span> <span class="n">ifa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_die</span><span class="p">(</span><span class="n">DIE_FAULT</span><span class="p">,</span> <span class="s">&quot;ia64_fault&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span><span class="p">,</span> <span class="n">SIGTRAP</span><span class="p">)</span>
			       	<span class="o">==</span> <span class="n">NOTIFY_STOP</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGTRAP</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifa</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
		<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span>   <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
		<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGTRAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">32</span>: <span class="cm">/* fp fault */</span>
	      <span class="k">case</span> <span class="mi">33</span>: <span class="cm">/* fp trap */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">handle_fpu_swa</span><span class="p">((</span><span class="n">vector</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPEMU_SIGFPE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGFPE</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">FPE_FLTINV</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">iip</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="n">__ISR_VALID</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="n">isr</span><span class="p">;</span>
			<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGFPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">34</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Lower-Privilege Transfer Trap */</span>

			<span class="cm">/* If we disabled debug traps during an fsyscall,</span>
<span class="cm">			 * re-enable them here.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_DB_DISABLED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_thread_flag</span><span class="p">(</span><span class="n">TIF_DB_DISABLED</span><span class="p">);</span>
				<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">db</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Just clear PSR.lp and then return immediately:</span>
<span class="cm">			 * all the interesting work (e.g., signal delivery)</span>
<span class="cm">			 * is done in the kernel exit path.</span>
<span class="cm">			 */</span>
			<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Unimplemented Instr. Address Trap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGILL</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">ILL_BADIADDR</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_imm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">siginfo</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">iip</span><span class="p">;</span>
				<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">siginfo</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Unimplemented Instruction Address fault&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">45</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unexpected IA-32 exception (Trap 45)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  iip - 0x%lx, ifa - 0x%lx, isr - 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iip</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">46</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unexpected IA-32 intercept trap (Trap 46)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;  iip - 0x%lx, ifa - 0x%lx, isr - 0x%lx, iim - 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iip</span><span class="p">,</span> <span class="n">ifa</span><span class="p">,</span> <span class="n">isr</span><span class="p">,</span> <span class="n">iim</span><span class="p">);</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	      <span class="k">case</span> <span class="mi">47</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;IA-32 Interruption Fault (int 0x%lx)&quot;</span><span class="p">,</span> <span class="n">isr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Fault %lu&quot;</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">die_if_kernel</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
		<span class="n">force_sig</span><span class="p">(</span><span class="n">SIGILL</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
