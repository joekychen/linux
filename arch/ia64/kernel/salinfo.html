<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › salinfo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>salinfo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * salinfo.c</span>
<span class="cm"> *</span>
<span class="cm"> * Creates entries in /proc/sal for various system features.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003, 2006 Silicon Graphics, Inc.  All rights reserved.</span>
<span class="cm"> * Copyright (c) 2003 Hewlett-Packard Co</span>
<span class="cm"> *	Bjorn Helgaas &lt;bjorn.helgaas@hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 10/30/2001	jbarnes@sgi.com		copied much of Stephane&#39;s palinfo</span>
<span class="cm"> *					code to create this file</span>
<span class="cm"> * Oct 23 2003	kaos@sgi.com</span>
<span class="cm"> *   Replace IPI with set_cpus_allowed() to read a record from the required cpu.</span>
<span class="cm"> *   Redesign salinfo log processing to separate interrupt and user space</span>
<span class="cm"> *   contexts.</span>
<span class="cm"> *   Cache the record across multi-block reads from user space.</span>
<span class="cm"> *   Support &gt; 64 cpus.</span>
<span class="cm"> *   Delete module_exit and MOD_INC/DEC_COUNT, salinfo cannot be a module.</span>
<span class="cm"> *</span>
<span class="cm"> * Jan 28 2004	kaos@sgi.com</span>
<span class="cm"> *   Periodically check for outstanding MCA or INIT records.</span>
<span class="cm"> *</span>
<span class="cm"> * Dec  5 2004	kaos@sgi.com</span>
<span class="cm"> *   Standardize which records are cleared automatically.</span>
<span class="cm"> *</span>
<span class="cm"> * Aug 18 2005	kaos@sgi.com</span>
<span class="cm"> *   mca.c may not pass a buffer, a NULL buffer just indicates that a new</span>
<span class="cm"> *   record is available in SAL.</span>
<span class="cm"> *   Replace some NR_CPUS by cpus_online, for hotplug cpu.</span>
<span class="cm"> *</span>
<span class="cm"> * Jan  5 2006        kaos@sgi.com</span>
<span class="cm"> *   Handle hotplug cpus coming online.</span>
<span class="cm"> *   Handle hotplug cpus going offline while they still have outstanding records.</span>
<span class="cm"> *   Use the cpu_* macros consistently.</span>
<span class="cm"> *   Replace the counting semaphore with a mutex and a test if the cpumask is non-empty.</span>
<span class="cm"> *   Modify the locking to make the test for &quot;work to do&quot; an atomic operation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>

<span class="cp">#include &lt;asm/sal.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jesse Barnes &lt;jbarnes@sgi.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;/proc interface to IA-64 SAL features&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">salinfo_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* name of the proc entry */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">feature</span><span class="p">;</span>        <span class="cm">/* feature bit */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">entry</span><span class="p">;</span>		<span class="cm">/* registered entry (removal) */</span>
<span class="p">}</span> <span class="n">salinfo_entry_t</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * List {name,feature} pairs for every entry in /proc/sal/&lt;feature&gt;</span>
<span class="cm"> * that this module exports</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">salinfo_entry_t</span> <span class="n">salinfo_entries</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;bus_lock&quot;</span><span class="p">,</span>           <span class="n">IA64_SAL_PLATFORM_FEATURE_BUS_LOCK</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;irq_redirection&quot;</span><span class="p">,</span>	<span class="n">IA64_SAL_PLATFORM_FEATURE_IRQ_REDIR_HINT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;ipi_redirection&quot;</span><span class="p">,</span>	<span class="n">IA64_SAL_PLATFORM_FEATURE_IPI_REDIR_HINT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;itc_drift&quot;</span><span class="p">,</span>		<span class="n">IA64_SAL_PLATFORM_FEATURE_ITC_DRIFT</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define NR_SALINFO_ENTRIES ARRAY_SIZE(salinfo_entries)</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">salinfo_log_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;mca&quot;</span><span class="p">,</span>
	<span class="s">&quot;init&quot;</span><span class="p">,</span>
	<span class="s">&quot;cmc&quot;</span><span class="p">,</span>
	<span class="s">&quot;cpe&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">salinfo_proc_entries</span><span class="p">[</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_entries</span><span class="p">)</span> <span class="o">+</span>			<span class="cm">/* /proc/sal/bus_lock */</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">)</span> <span class="o">+</span>			<span class="cm">/* /proc/sal/{mca,...} */</span>
	<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">))</span> <span class="o">+</span>		<span class="cm">/* /proc/sal/mca/{event,data} */</span>
	<span class="mi">1</span><span class="p">];</span>						<span class="cm">/* /proc/sal */</span>

<span class="cm">/* Some records we get ourselves, some are accessed as saved data in buffers</span>
<span class="cm"> * that are owned by mca.c.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">salinfo_data_saved</span> <span class="p">{</span>
	<span class="n">u8</span><span class="o">*</span>			<span class="n">buffer</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">size</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cpu</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* State transitions.  Actions are :-</span>
<span class="cm"> *   Write &quot;read &lt;cpunum&gt;&quot; to the data file.</span>
<span class="cm"> *   Write &quot;clear &lt;cpunum&gt;&quot; to the data file.</span>
<span class="cm"> *   Write &quot;oemdata &lt;cpunum&gt; &lt;offset&gt; to the data file.</span>
<span class="cm"> *   Read from the data file.</span>
<span class="cm"> *   Close the data file.</span>
<span class="cm"> *</span>
<span class="cm"> * Start state is NO_DATA.</span>
<span class="cm"> *</span>
<span class="cm"> * NO_DATA</span>
<span class="cm"> *    write &quot;read &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;clear &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;oemdata &lt;cpunum&gt; &lt;offset&gt; -&gt; return -EINVAL.</span>
<span class="cm"> *    read data -&gt; return EOF.</span>
<span class="cm"> *    close -&gt; unchanged.  Free record areas.</span>
<span class="cm"> *</span>
<span class="cm"> * LOG_RECORD</span>
<span class="cm"> *    write &quot;read &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;clear &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;oemdata &lt;cpunum&gt; &lt;offset&gt; -&gt; format the oem data, goto OEMDATA.</span>
<span class="cm"> *    read data -&gt; return the INIT/MCA/CMC/CPE record.</span>
<span class="cm"> *    close -&gt; unchanged.  Keep record areas.</span>
<span class="cm"> *</span>
<span class="cm"> * OEMDATA</span>
<span class="cm"> *    write &quot;read &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;clear &lt;cpunum&gt;&quot; -&gt; NO_DATA or LOG_RECORD.</span>
<span class="cm"> *    write &quot;oemdata &lt;cpunum&gt; &lt;offset&gt; -&gt; format the oem data, goto OEMDATA.</span>
<span class="cm"> *    read data -&gt; return the formatted oemdata.</span>
<span class="cm"> *    close -&gt; unchanged.  Keep record areas.</span>
<span class="cm"> *</span>
<span class="cm"> * Closing the data file does not change the state.  This allows shell scripts</span>
<span class="cm"> * to manipulate salinfo data, each shell redirection opens the file, does one</span>
<span class="cm"> * action then closes it again.  The record areas are only freed at close when</span>
<span class="cm"> * the state is NO_DATA.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">salinfo_state</span> <span class="p">{</span>
	<span class="n">STATE_NO_DATA</span><span class="p">,</span>
	<span class="n">STATE_LOG_RECORD</span><span class="p">,</span>
	<span class="n">STATE_OEMDATA</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="p">{</span>
	<span class="n">cpumask_t</span>		<span class="n">cpu_event</span><span class="p">;</span>	<span class="cm">/* which cpus have outstanding events */</span>
	<span class="k">struct</span> <span class="n">semaphore</span>	<span class="n">mutex</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">log_buffer</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">log_size</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">oemdata</span><span class="p">;</span>	<span class="cm">/* decoded oem data */</span>
	<span class="n">u64</span>			<span class="n">oemdata_size</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">open</span><span class="p">;</span>		<span class="cm">/* single-open to prevent races */</span>
	<span class="n">u8</span>			<span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">saved_num</span><span class="p">;</span>	<span class="cm">/* using a saved record? */</span>
	<span class="k">enum</span> <span class="n">salinfo_state</span>	<span class="n">state</span> <span class="o">:</span><span class="mi">8</span><span class="p">;</span>	<span class="cm">/* processing state */</span>
	<span class="n">u8</span>			<span class="n">padding</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cpu_check</span><span class="p">;</span>	<span class="cm">/* next CPU to check */</span>
	<span class="k">struct</span> <span class="n">salinfo_data_saved</span> <span class="n">data_saved</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span><span class="cm">/* save last 5 records from mca.c, must be &lt; 255 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">salinfo_data</span> <span class="n">salinfo_data</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">)];</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">data_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">data_saved_lock</span><span class="p">);</span>

<span class="cm">/** salinfo_platform_oemdata - optional callback to decode oemdata from an error</span>
<span class="cm"> * record.</span>
<span class="cm"> * @sect_header: pointer to the start of the section to decode.</span>
<span class="cm"> * @oemdata: returns vmalloc area containing the decoded output.</span>
<span class="cm"> * @oemdata_size: returns length of decoded output (strlen).</span>
<span class="cm"> *</span>
<span class="cm"> * Description: If user space asks for oem data to be decoded by the kernel</span>
<span class="cm"> * and/or prom and the platform has set salinfo_platform_oemdata to the address</span>
<span class="cm"> * of a platform specific routine then call that routine.  salinfo_platform_oemdata</span>
<span class="cm"> * vmalloc&#39;s and formats its output area, returning the address of the text</span>
<span class="cm"> * and its strlen.  Returns 0 for success, -ve for error.  The callback is</span>
<span class="cm"> * invoked on the cpu that generated the error record.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">salinfo_platform_oemdata</span><span class="p">)(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sect_header</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">oemdata</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">oemdata_size</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">salinfo_platform_oemdata_parms</span> <span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">efi_guid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">oemdata</span><span class="p">;</span>
	<span class="n">u64</span> <span class="o">*</span><span class="n">oemdata_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Kick the mutex that tells user space that there is work to do.  Instead of</span>
<span class="cm"> * trying to track the state of the mutex across multiple cpus, in user</span>
<span class="cm"> * context, interrupt context, non-maskable interrupt context and hotplug cpu,</span>
<span class="cm"> * it is far easier just to grab the mutex if it is free then release it.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine must be called with data_saved_lock held, to make the down/up</span>
<span class="cm"> * operation atomic.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_work_to_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_platform_oemdata_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">salinfo_platform_oemdata_parms</span> <span class="o">*</span><span class="n">parms</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">parms</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="n">salinfo_platform_oemdata</span><span class="p">(</span><span class="n">parms</span><span class="o">-&gt;</span><span class="n">efi_guid</span><span class="p">,</span> <span class="n">parms</span><span class="o">-&gt;</span><span class="n">oemdata</span><span class="p">,</span> <span class="n">parms</span><span class="o">-&gt;</span><span class="n">oemdata_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">shift1_data_saved</span> <span class="p">(</span><span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="o">+</span><span class="n">shift</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="o">+</span><span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">shift</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span> <span class="o">+</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/* This routine is invoked in interrupt context.  Note: mca.c enables</span>
<span class="cm"> * interrupts before calling this code for CMC/CPE.  MCA and INIT events are</span>
<span class="cm"> * not irq safe, do not call any routines that use spinlocks, they may deadlock.</span>
<span class="cm"> * MCA and INIT records are recorded, a timer event will look for any</span>
<span class="cm"> * outstanding events and wake up the user space code.</span>
<span class="cm"> *</span>
<span class="cm"> * The buffer passed from mca.c points to the output from ia64_log_get. This is</span>
<span class="cm"> * a persistent buffer but its contents can change between the interrupt and</span>
<span class="cm"> * when user space processes the record.  Save the record id to identify</span>
<span class="cm"> * changes.  If the buffer is NULL then just update the bitmap.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">salinfo_log_wakeup</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irqsafe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">salinfo_data</span> <span class="o">+</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">salinfo_data_saved</span> <span class="o">*</span><span class="n">data_saved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsafe</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_saved</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">saved_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">data_saved</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">saved_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">shift1_data_saved</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">data_saved</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span> <span class="o">+</span> <span class="n">saved_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">data_saved</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_saved</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
			<span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cpu_set</span><span class="p">(</span><span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqsafe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">salinfo_work_to_do</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Check for outstanding MCA/INIT records every minute (arbitrary) */</span>
<span class="cp">#define SALINFO_TIMER_DELAY (60*HZ)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">salinfo_timer</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">ia64_mlogbuf_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_timeout_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpus_empty</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">salinfo_work_to_do</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_timeout</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ia64_mlogbuf_dump</span><span class="p">();</span>
	<span class="n">salinfo_timeout_check</span><span class="p">(</span><span class="n">salinfo_data</span> <span class="o">+</span> <span class="n">SAL_INFO_TYPE_MCA</span><span class="p">);</span>
	<span class="n">salinfo_timeout_check</span><span class="p">(</span><span class="n">salinfo_data</span> <span class="o">+</span> <span class="n">SAL_INFO_TYPE_INIT</span><span class="p">);</span>
	<span class="n">salinfo_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SALINFO_TIMER_DELAY</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">salinfo_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">salinfo_event_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">salinfo_event_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpus_empty</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_check</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_cpu_ids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpu_isset</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_online</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cpu_clear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cpu</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">n</span> <span class="o">==</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">ia64_mlogbuf_dump</span><span class="p">();</span>

	<span class="cm">/* for next read, start checking at next CPU */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_check</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_check</span> <span class="o">==</span> <span class="n">nr_cpu_ids</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="s">&quot;read %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">salinfo_event_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>  <span class="o">=</span> <span class="n">salinfo_event_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>  <span class="o">=</span> <span class="n">salinfo_event_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">salinfo_log_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_NO_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">ia64_sal_get_state_info_size</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">salinfo_log_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_NO_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_lock</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">call_on_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpumask_t</span> <span class="n">save_cpus_allowed</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">cpus_allowed</span><span class="p">;</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">cpumask_of</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>
	<span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">set_cpus_allowed_ptr</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_cpus_allowed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_log_read_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">ia64_sal_get_state_info</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">);</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">);</span>
	<span class="cm">/* Clear corrected errors as they are read from SAL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">severity</span> <span class="o">==</span> <span class="n">sal_log_severity_corrected</span><span class="p">)</span>
		<span class="n">ia64_sal_clear_state_info</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_log_new_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">salinfo_data_saved</span> <span class="o">*</span><span class="n">data_saved</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">);</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_saved</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">saved_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">data_saved</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span> <span class="o">=</span> <span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span><span class="p">);</span>
			<span class="n">barrier</span><span class="p">();</span>	<span class="cm">/* id check must not be moved */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* saved record changed by mca.c since interrupt, discard it */</span>
			<span class="n">shift1_data_saved</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span><span class="p">)</span>
		<span class="n">call_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">salinfo_log_read_cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_NO_DATA</span><span class="p">;</span>
		<span class="n">cpu_clear</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_LOG_RECORD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">salinfo_log_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bufsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_LOG_RECORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">;</span>
		<span class="n">bufsize</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_OEMDATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata</span><span class="p">;</span>
		<span class="n">bufsize</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">salinfo_log_clear_cpu</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">ia64_sal_clear_state_info</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">salinfo_log_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="n">rh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_NO_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_isset</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cpu_clear</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shift1_data_saved</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">saved_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="p">(</span><span class="n">sal_log_record_header_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span><span class="p">);</span>
	<span class="cm">/* Corrected errors have already been cleared from SAL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rh</span><span class="o">-&gt;</span><span class="n">severity</span> <span class="o">!=</span> <span class="n">sal_log_severity_corrected</span><span class="p">)</span>
		<span class="n">call_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">salinfo_log_clear_cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="cm">/* clearing a record may make a new record visible */</span>
	<span class="n">salinfo_log_new_read</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_LOG_RECORD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cpu_set</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
		<span class="n">salinfo_work_to_do</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">salinfo_log_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;read %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">salinfo_log_new_read</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;clear %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">salinfo_log_clear</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cpu</span><span class="p">)))</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;oemdata %d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_LOG_RECORD</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_OEMDATA</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">efi_guid_t</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_OEMDATA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">salinfo_platform_oemdata</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">salinfo_platform_oemdata_parms</span> <span class="n">parms</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">efi_guid</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">log_buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
				<span class="p">.</span><span class="n">oemdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata</span><span class="p">,</span>
				<span class="p">.</span><span class="n">oemdata_size</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata_size</span>
			<span class="p">};</span>
			<span class="n">call_on_cpu</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">salinfo_platform_oemdata_cpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parms</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parms</span><span class="p">.</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">parms</span><span class="p">.</span><span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">oemdata_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">salinfo_data_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">salinfo_log_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">salinfo_log_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">salinfo_log_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">salinfo_log_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span>
<span class="nf">salinfo_cpu_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
	<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">salinfo_data</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_data</span><span class="p">);</span>
		     <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpu_set</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
			<span class="n">salinfo_work_to_do</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">salinfo_data</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_data</span><span class="p">);</span>
		     <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">salinfo_data_saved</span> <span class="o">*</span><span class="n">data_saved</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data_saved</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">data_saved</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
			     <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="o">--</span><span class="n">j</span><span class="p">,</span> <span class="o">--</span><span class="n">data_saved</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">&amp;&amp;</span> <span class="n">data_saved</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">shift1_data_saved</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">cpu_clear</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_saved_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">salinfo_cpu_notifier</span> <span class="n">__cpuinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">salinfo_cpu_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">salinfo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">salinfo_dir</span><span class="p">;</span> <span class="cm">/* /proc/sal dir entry */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">**</span><span class="n">sdir</span> <span class="o">=</span> <span class="n">salinfo_proc_entries</span><span class="p">;</span> <span class="cm">/* keeps track of every entry */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">salinfo_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">salinfo_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;sal&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">salinfo_dir</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_SALINFO_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pass the feature bit in question as misc data */</span>
		<span class="o">*</span><span class="n">sdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span> <span class="p">(</span><span class="n">salinfo_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">salinfo_dir</span><span class="p">,</span>
						  <span class="n">salinfo_read</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">salinfo_entries</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">feature</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">salinfo_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">salinfo_log_name</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">salinfo_dir</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;event&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">salinfo_event_fops</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">salinfo_data_fops</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

		<span class="cm">/* we missed any events before now */</span>
		<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
			<span class="n">cpu_set</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cpu_event</span><span class="p">);</span>

		<span class="o">*</span><span class="n">sdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">sdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">salinfo_dir</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">salinfo_timer</span><span class="p">);</span>
	<span class="n">salinfo_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SALINFO_TIMER_DELAY</span><span class="p">;</span>
	<span class="n">salinfo_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">salinfo_timeout</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">salinfo_timer</span><span class="p">);</span>

	<span class="n">register_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">salinfo_cpu_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &#39;data&#39; contains an integer that corresponds to the feature we&#39;re</span>
<span class="cm"> * testing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">salinfo_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="n">sal_platform_features</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;1</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">:</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="o">+</span><span class="n">count</span><span class="p">)</span> <span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">len</span>   <span class="o">-=</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="n">count</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">salinfo_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
