<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › signal.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>signal.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Architecture-specific signal handling support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1999-2004 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from i386 and Alpha versions.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/tracehook.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/binfmts.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>

<span class="cp">#include &lt;asm/intrinsics.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/rse.h&gt;</span>
<span class="cp">#include &lt;asm/sigcontext.h&gt;</span>

<span class="cp">#include &quot;sigframe.h&quot;</span>

<span class="cp">#define DEBUG_SIG	0</span>
<span class="cp">#define STACK_ALIGN	16		</span><span class="cm">/* minimal alignment for stack pointer */</span><span class="cp"></span>

<span class="cp">#if _NSIG_WORDS &gt; 1</span>
<span class="cp"># define PUT_SIGSET(k,u)	__copy_to_user((u)-&gt;sig, (k)-&gt;sig, sizeof(sigset_t))</span>
<span class="cp"># define GET_SIGSET(k,u)	__copy_from_user((k)-&gt;sig, (u)-&gt;sig, sizeof(sigset_t))</span>
<span class="cp">#else</span>
<span class="cp"># define PUT_SIGSET(k,u)	__put_user((k)-&gt;sig[0], &amp;(u)-&gt;sig[0])</span>
<span class="cp"># define GET_SIGSET(k,u)	__get_user((k)-&gt;sig[0], &amp;(u)-&gt;sig[0])</span>
<span class="cp">#endif</span>

<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">sys_sigaltstack</span> <span class="p">(</span><span class="k">const</span> <span class="n">stack_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uss</span><span class="p">,</span> <span class="n">stack_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uoss</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg2</span><span class="p">,</span>
		 <span class="kt">long</span> <span class="n">arg3</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg4</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg5</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg6</span><span class="p">,</span> <span class="kt">long</span> <span class="n">arg7</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">do_sigaltstack</span><span class="p">(</span><span class="n">uss</span><span class="p">,</span> <span class="n">uoss</span><span class="p">,</span> <span class="n">regs</span><span class="p">.</span><span class="n">r12</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">restore_sigcontext</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">nat</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">rsc</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Always make any pending restarted system calls return -EINTR */</span>
	<span class="n">current_thread_info</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">restart_block</span><span class="p">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">do_no_restart_syscall</span><span class="p">;</span>

	<span class="cm">/* restore scratch that always needs gets updated during signal delivery: */</span>
	<span class="n">err</span>  <span class="o">=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_nat</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ip</span><span class="p">);</span>			<span class="cm">/* instruction pointer */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">cfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_cfm</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_um</span><span class="p">);</span>			<span class="cm">/* user mask */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">rsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_rsc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_unat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_unat</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_fpsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_fpsr</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_pfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_pfs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pr</span><span class="p">);</span>		<span class="cm">/* predicates */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>		<span class="cm">/* b0 (rp) */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>		<span class="cm">/* b6 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r1 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="mi">4</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r8-r11 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r12-r13 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r15 */</span>

	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="n">cfm</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">);</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_rsc</span> <span class="o">=</span> <span class="n">rsc</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* force PL3 */</span>

	<span class="cm">/* establish new instruction pointer: */</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3UL</span><span class="p">;</span>
	<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="n">ip</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ipsr</span> <span class="o">=</span> <span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IA64_PSR_UM</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">um</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_UM</span><span class="p">);</span>

	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">scratch_unat</span> <span class="o">=</span> <span class="n">ia64_put_scratch_nat_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span> <span class="n">nat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_SC_FLAG_IN_SYSCALL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Restore most scratch-state only when not in syscall. */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_ccv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_ccv</span><span class="p">);</span>		<span class="cm">/* ar.ccv */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>			<span class="cm">/* b7 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__get_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>			<span class="cm">/* r14 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_csd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar25</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* ar.csd &amp; ar.ssd */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r2-r3 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r16-r31 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_SC_FLAG_FPH_VALID</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ia64_psr</span> <span class="o">*</span><span class="n">psr</span> <span class="o">=</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_fr</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="mi">96</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
		<span class="n">psr</span><span class="o">-&gt;</span><span class="n">mfh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* drop signal handler&#39;s fph contents... */</span>
		<span class="n">preempt_disable</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psr</span><span class="o">-&gt;</span><span class="n">dfh</span><span class="p">)</span>
			<span class="n">ia64_drop_fpu</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We already own the local fph, otherwise psr-&gt;dfh wouldn&#39;t be 0.  */</span>
			<span class="n">__ia64_load_fpu</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">);</span>
			<span class="n">ia64_set_local_fpu_owner</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">preempt_enable</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">copy_siginfo_to_user</span> <span class="p">(</span><span class="n">siginfo_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">siginfo_t</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">siginfo_t</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If you change siginfo_t structure, please be sure this code is fixed</span>
<span class="cm">		 * accordingly.  It should never copy any pad contained in the structure</span>
<span class="cm">		 * to avoid security leaks, but must copy the generic 3 ints plus the</span>
<span class="cm">		 * relevant union member.</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_signo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_signo</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_errno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_errno</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_code</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_code</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		      <span class="k">case</span> <span class="n">__SI_FAULT</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_flags</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_isr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_isr</span><span class="p">);</span>
		      <span class="k">case</span> <span class="n">__SI_POLL</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_addr</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_imm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_imm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		      <span class="k">case</span> <span class="n">__SI_TIMER</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_tid</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_overrun</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_overrun</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		      <span class="k">case</span> <span class="n">__SI_RT</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:	<span class="cm">/* Not generated by the kernel as of now.  */</span>
		      <span class="k">case</span> <span class="n">__SI_MESGQ</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_uid</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_pid</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		      <span class="k">case</span> <span class="n">__SI_CHLD</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>:
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_utime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_utime</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_stime</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_stime</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_status</span><span class="p">);</span>
		      <span class="nl">default:</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_uid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_uid</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">si_pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">to</span><span class="o">-&gt;</span><span class="n">si_pid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">long</span>
<span class="nf">ia64_rt_sigreturn</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">ia64_strace_leave_kernel</span><span class="p">,</span> <span class="n">ia64_leave_kernel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">sigset_t</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span> <span class="o">+</span> <span class="mi">16</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When we return to the previously executing context, r8 and r10 have already</span>
<span class="cm">	 * been setup the way we want them.  Indeed, if the signal wasn&#39;t delivered while</span>
<span class="cm">	 * in a system call, we must not touch r8 or r10 as otherwise user-level state</span>
<span class="cm">	 * could be corrupted.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ia64_leave_kernel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SYSCALL_TRACE</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SYSCALL_AUDIT</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * strace expects to be notified after sigreturn returns even though the</span>
<span class="cm">		 * context to which we return may not be in the middle of a syscall.</span>
<span class="cm">		 * Thus, the return-value that strace displays for sigreturn is</span>
<span class="cm">		 * meaningless.</span>
<span class="cm">		 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ia64_strace_leave_kernel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_SIGSET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_mask</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>

	<span class="n">set_current_blocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restore_sigcontext</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">scr</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">give_sigsegv</span><span class="p">;</span>

<span class="cp">#if DEBUG_SIG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SIG return (%s:%d): sp=%lx ip=%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">,</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_iip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * It is more difficult to avoid calling this function than to</span>
<span class="cm">	 * call it and ignore errors.</span>
<span class="cm">	 */</span>
	<span class="n">do_sigaltstack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_stack</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

  <span class="nl">give_sigsegv:</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SI_KERNEL</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_pid</span> <span class="o">=</span> <span class="n">task_pid_vnr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_uid</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">();</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This does just the minimum required setup of sigcontext.</span>
<span class="cm"> * Specifically, it only installs data that is either not knowable at</span>
<span class="cm"> * the user-level or that gets modified before execution in the</span>
<span class="cm"> * trampoline starts.  Everything else is done at the user-level.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span>
<span class="nf">setup_sigcontext</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigcontext</span> <span class="n">__user</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">sigset_t</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ifs</span><span class="p">,</span> <span class="n">cfm</span><span class="p">,</span> <span class="n">nat</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ifs</span> <span class="o">=</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ifs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on_sig_stack</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sc</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_SC_FLAG_ONSTACK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ifs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* if cr_ifs doesn&#39;t have the valid bit set, we got here through a syscall */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_SC_FLAG_IN_SYSCALL</span><span class="p">;</span>
	<span class="n">cfm</span> <span class="o">=</span> <span class="n">ifs</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">38</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_THREAD_FPH_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">IA64_SC_FLAG_FPH_VALID</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_fr</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">current</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span><span class="p">,</span> <span class="mi">96</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nat</span> <span class="o">=</span> <span class="n">ia64_get_scratch_nat_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">scratch_unat</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">nat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_nat</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">PUT_SIGSET</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_mask</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">cfm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_cfm</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ipsr</span> <span class="o">&amp;</span> <span class="n">IA64_PSR_UM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_um</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_rsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_rsc</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_unat</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_unat</span><span class="p">);</span>		<span class="cm">/* ar.unat */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_fpsr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_fpsr</span><span class="p">);</span>		<span class="cm">/* ar.fpsr */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_pfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_pfs</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pr</span><span class="p">);</span>			<span class="cm">/* predicates */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>			<span class="cm">/* b0 (rp) */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>			<span class="cm">/* b6 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>		<span class="cm">/* r1 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r8</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>		<span class="cm">/* r8-r11 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r12-r13 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r15</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>		<span class="cm">/* r15 */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">+</span> <span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IA64_SC_FLAG_IN_SYSCALL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Copy scratch regs to sigcontext if the signal didn&#39;t interrupt a syscall. */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_ccv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar_ccv</span><span class="p">);</span>		<span class="cm">/* ar.ccv */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">b7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_br</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>			<span class="cm">/* b7 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r14</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>			<span class="cm">/* r14 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ar25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_csd</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* ar.csd &amp; ar.ssd */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r2</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>		<span class="cm">/* r2-r3 */</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_gr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r16</span><span class="p">,</span> <span class="mi">16</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>	<span class="cm">/* r16-r31 */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether the register-backing store is already on the signal stack.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">rbs_on_sig_stack</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bsp</span> <span class="o">-</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">&lt;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">force_sigsegv_info</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">siginfo</span> <span class="n">si</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="n">SIGSEGV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Acquiring siglock around the sa_handler-update is almost</span>
<span class="cm">		 * certainly overkill, but this isn&#39;t a</span>
<span class="cm">		 * performance-critical path and I&#39;d rather play it safe</span>
<span class="cm">		 * here than having to debug a nasty race if and when</span>
<span class="cm">		 * something changes in kernel/signal.c that would make it</span>
<span class="cm">		 * no longer safe to modify sa_handler without holding the</span>
<span class="cm">		 * lock.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">[</span><span class="n">sig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">SIG_DFL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sighand</span><span class="o">-&gt;</span><span class="n">siglock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_signo</span> <span class="o">=</span> <span class="n">SIGSEGV</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_errno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_code</span> <span class="o">=</span> <span class="n">SI_KERNEL</span><span class="p">;</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_pid</span> <span class="o">=</span> <span class="n">task_pid_vnr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_uid</span> <span class="o">=</span> <span class="n">current_uid</span><span class="p">();</span>
	<span class="n">si</span><span class="p">.</span><span class="n">si_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">force_sig_info</span><span class="p">(</span><span class="n">SIGSEGV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">setup_frame</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="n">k_sigaction</span> <span class="o">*</span><span class="n">ka</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">sigset_t</span> <span class="o">*</span><span class="n">set</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">__kernel_sigtramp</span><span class="p">[];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tramp_addr</span><span class="p">,</span> <span class="n">new_rbs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">new_sp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sigframe</span> <span class="n">__user</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">new_sp</span> <span class="o">=</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">;</span>
	<span class="n">tramp_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__kernel_sigtramp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_ONSTACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">onstack</span> <span class="o">=</span> <span class="n">sas_ss_flags</span><span class="p">(</span><span class="n">new_sp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">onstack</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_sp</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span> <span class="o">+</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * We need to check for the register stack being on the</span>
<span class="cm">			 * signal stack separately, because it&#39;s switched</span>
<span class="cm">			 * separately (memory stack is switched in the kernel,</span>
<span class="cm">			 * register stack is switched in the signal trampoline).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rbs_on_sig_stack</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_bspstore</span><span class="p">))</span>
				<span class="n">new_rbs</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">onstack</span> <span class="o">==</span> <span class="n">SS_ONSTACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">check_sp</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If we are on the alternate signal stack and would</span>
<span class="cm">			 * overflow it, don&#39;t. Return an always-bogus address</span>
<span class="cm">			 * instead so we will die with SIGSEGV.</span>
<span class="cm">			 */</span>
			<span class="n">check_sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_sp</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">STACK_ALIGN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">likely</span><span class="p">(</span><span class="n">on_sig_stack</span><span class="p">(</span><span class="n">check_sp</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">force_sigsegv_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
							  <span class="n">check_sp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">new_sp</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">STACK_ALIGN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">force_sigsegv_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

	<span class="n">err</span>  <span class="o">=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">arg0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">arg1</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">arg2</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">new_rbs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_rbs_base</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_loadrs</span><span class="p">);</span>	<span class="cm">/* initialize to zero */</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">ka</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">copy_siginfo_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_sp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_stack</span><span class="p">.</span><span class="n">ss_sp</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">sas_ss_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_stack</span><span class="p">.</span><span class="n">ss_size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">sas_ss_flags</span><span class="p">(</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_stack</span><span class="p">.</span><span class="n">ss_flags</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">|=</span> <span class="n">setup_sigcontext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">scr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">force_sigsegv_info</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">frame</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* new stack pointer */</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">ar_fpsr</span> <span class="o">=</span> <span class="n">FPSR_DEFAULT</span><span class="p">;</span>			<span class="cm">/* reset fpsr for signal handler */</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_iip</span> <span class="o">=</span> <span class="n">tramp_addr</span><span class="p">;</span>
	<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* start executing in first slot */</span>
	<span class="n">ia64_psr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">be</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* force little-endian byte-order */</span>
	<span class="cm">/*</span>
<span class="cm">	 * Force the interruption function mask to zero.  This has no effect when a</span>
<span class="cm">	 * system-call got interrupted by a signal (since, in that case, scr-&gt;pt_cr_ifs is</span>
<span class="cm">	 * ignored), but it has the desirable effect of making it possible to deliver a</span>
<span class="cm">	 * signal with an incomplete register frame (which happens when a mandatory RSE</span>
<span class="cm">	 * load faults).  Furthermore, it has no negative effect on the getting the user&#39;s</span>
<span class="cm">	 * dirty partition preserved, because that&#39;s governed by scr-&gt;pt.loadrs.</span>
<span class="cm">	 */</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">cr_ifs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: this affects only the NaT bits of the scratch regs (the ones saved in</span>
<span class="cm">	 * pt_regs), which is exactly what we want.</span>
<span class="cm">	 */</span>
	<span class="n">scr</span><span class="o">-&gt;</span><span class="n">scratch_unat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ensure NaT bits of r12 is clear */</span>

<span class="cp">#if DEBUG_SIG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SIG deliver (%s:%d): sig=%d sp=%lx ip=%lx handler=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r12</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">sc</span><span class="p">.</span><span class="n">sc_ip</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span>
<span class="nf">handle_signal</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sig</span><span class="p">,</span> <span class="k">struct</span> <span class="n">k_sigaction</span> <span class="o">*</span><span class="n">ka</span><span class="p">,</span> <span class="n">siginfo_t</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup_frame</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">sigmask_to_save</span><span class="p">(),</span> <span class="n">scr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">signal_delivered</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ka</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span>
				 <span class="n">test_thread_flag</span><span class="p">(</span><span class="n">TIF_SINGLESTEP</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Note that `init&#39; is a special process: it doesn&#39;t get signals it doesn&#39;t want to</span>
<span class="cm"> * handle.  Thus you cannot kill init even with a SIGKILL even by mistake.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ia64_do_signal</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sigscratch</span> <span class="o">*</span><span class="n">scr</span><span class="p">,</span> <span class="kt">long</span> <span class="n">in_syscall</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">k_sigaction</span> <span class="n">ka</span><span class="p">;</span>
	<span class="n">siginfo_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">restart</span> <span class="o">=</span> <span class="n">in_syscall</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">errno</span> <span class="o">=</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the ia64_leave_kernel code path, we want the common case to go fast, which</span>
<span class="cm">	 * is why we may in certain cases get here from kernel mode. Just return without</span>
<span class="cm">	 * doing anything if so.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">user_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This only loops in the rare cases of handle_signal() failing, in which case we</span>
<span class="cm">	 * need to push through a forced SIGSEGV.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">signr</span> <span class="o">=</span> <span class="n">get_signal_to_deliver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ka</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * get_signal_to_deliver() may have run a debugger (via notify_parent())</span>
<span class="cm">		 * and the debugger may have modified the state (e.g., to arrange for an</span>
<span class="cm">		 * inferior call), thus it&#39;s important to check for restarting _after_</span>
<span class="cm">		 * get_signal_to_deliver().</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r10</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * A system calls has to be restarted only if one of the error codes</span>
<span class="cm">			 * ERESTARTNOHAND, ERESTARTSYS, or ERESTARTNOINTR is returned.  If r10</span>
<span class="cm">			 * isn&#39;t -1 then r8 doesn&#39;t hold an error code and we don&#39;t need to</span>
<span class="cm">			 * restart the syscall, so we can clear the &quot;restart&quot; flag here.</span>
<span class="cm">			 */</span>
			<span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">restart</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
			      <span class="k">case</span> <span class="n">ERESTART_RESTARTBLOCK</span>:
			      <span class="k">case</span> <span class="n">ERESTARTNOHAND</span>:
				<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r8</span> <span class="o">=</span> <span class="n">EINTR</span><span class="p">;</span>
				<span class="cm">/* note: scr-&gt;pt.r10 is already -1 */</span>
				<span class="k">break</span><span class="p">;</span>

			      <span class="k">case</span> <span class="n">ERESTARTSYS</span>:
				<span class="k">if</span> <span class="p">((</span><span class="n">ka</span><span class="p">.</span><span class="n">sa</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">&amp;</span> <span class="n">SA_RESTART</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r8</span> <span class="o">=</span> <span class="n">EINTR</span><span class="p">;</span>
					<span class="cm">/* note: scr-&gt;pt.r10 is already -1 */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			      <span class="k">case</span> <span class="n">ERESTARTNOINTR</span>:
				<span class="n">ia64_decrement_ip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
				<span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* don&#39;t restart twice if handle_signal() fails... */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Whee!  Actually deliver the signal.  If the delivery failed, we need to</span>
<span class="cm">		 * continue to iterate in this loop so we can deliver the SIGSEGV...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">handle_signal</span><span class="p">(</span><span class="n">signr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ka</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">scr</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Did we come from a system call? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restart the system call - no handlers present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ERESTARTNOHAND</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ERESTARTSYS</span> <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ERESTARTNOINTR</span>
		    <span class="o">||</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note: the syscall number is in r15 which is saved in</span>
<span class="cm">			 * pt_regs so all we need to do here is adjust ip so that</span>
<span class="cm">			 * the &quot;break&quot; instruction gets re-executed.</span>
<span class="cm">			 */</span>
			<span class="n">ia64_decrement_ip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">ERESTART_RESTARTBLOCK</span><span class="p">)</span>
				<span class="n">scr</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">.</span><span class="n">r15</span> <span class="o">=</span> <span class="n">__NR_restart_syscall</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if there&#39;s no signal to deliver, we just put the saved sigmask</span>
<span class="cm">	 * back */</span>
	<span class="n">restore_saved_sigmask</span><span class="p">();</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
