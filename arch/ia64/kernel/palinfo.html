<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › palinfo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>palinfo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * palinfo.c</span>
<span class="cm"> *</span>
<span class="cm"> * Prints processor specific information reported by PAL.</span>
<span class="cm"> * This code is based on specification of PAL as of the</span>
<span class="cm"> * Intel IA-64 Architecture Software Developer&#39;s Manual v1.0.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000-2001, 2003 Hewlett-Packard Co</span>
<span class="cm"> *	Stephane Eranian &lt;eranian@hpl.hp.com&gt;</span>
<span class="cm"> * Copyright (C) 2004 Intel Corporation</span>
<span class="cm"> *  Ashok Raj &lt;ashok.raj@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 05/26/2000	S.Eranian	initial release</span>
<span class="cm"> * 08/21/2000	S.Eranian	updated to July 2000 PAL specs</span>
<span class="cm"> * 02/05/2001   S.Eranian	fixed module support</span>
<span class="cm"> * 10/23/2001	S.Eranian	updated pal_perf_mon_info bug fixes</span>
<span class="cm"> * 03/24/2004	Ashok Raj	updated to work with CPU Hotplug</span>
<span class="cm"> * 10/26/2006   Russ Anderson	updated processor features to rev 2.2 spec</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/efi.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/cpu.h&gt;</span>
<span class="cp">#include &lt;linux/cpumask.h&gt;</span>

<span class="cp">#include &lt;asm/pal.h&gt;</span>
<span class="cp">#include &lt;asm/sal.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;linux/smp.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stephane Eranian &lt;eranian@hpl.hp.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;/proc interface to IA-64 PAL&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define PALINFO_VERSION &quot;0.5&quot;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">palinfo_func_t</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* name of the proc entry */</span>
	<span class="n">palinfo_func_t</span>		<span class="n">proc_read</span><span class="p">;</span>	<span class="cm">/* function to call for reading */</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span>	<span class="o">*</span><span class="n">entry</span><span class="p">;</span>		<span class="cm">/* registered entry (removal) */</span>
<span class="p">}</span> <span class="n">palinfo_entry_t</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> *  A bunch of string array to get pretty printing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cache_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>			<span class="cm">/* not used */</span>
	<span class="s">&quot;Instruction&quot;</span><span class="p">,</span>
	<span class="s">&quot;Data&quot;</span><span class="p">,</span>
	<span class="s">&quot;Data/Instruction&quot;</span>	<span class="cm">/* unified */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cache_mattrib</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="s">&quot;WriteThrough&quot;</span><span class="p">,</span>
	<span class="s">&quot;WriteBack&quot;</span><span class="p">,</span>
	<span class="s">&quot;&quot;</span><span class="p">,</span>		<span class="cm">/* reserved */</span>
	<span class="s">&quot;&quot;</span>		<span class="cm">/* reserved */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cache_st_hints</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="s">&quot;Temporal, level 1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Non-temporal, all levels&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cache_ld_hints</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="s">&quot;Temporal, level 1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Non-temporal, level 1&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Non-temporal, all levels&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span><span class="p">,</span>
	<span class="s">&quot;Reserved&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rse_hints</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="s">&quot;enforced lazy&quot;</span><span class="p">,</span>
	<span class="s">&quot;eager stores&quot;</span><span class="p">,</span>
	<span class="s">&quot;eager loads&quot;</span><span class="p">,</span>
	<span class="s">&quot;eager loads and stores&quot;</span>
<span class="p">};</span>

<span class="cp">#define RSE_HINTS_COUNT ARRAY_SIZE(rse_hints)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem_attrib</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="s">&quot;WB&quot;</span><span class="p">,</span>		<span class="cm">/* 000 */</span>
	<span class="s">&quot;SW&quot;</span><span class="p">,</span>		<span class="cm">/* 001 */</span>
	<span class="s">&quot;010&quot;</span><span class="p">,</span>		<span class="cm">/* 010 */</span>
	<span class="s">&quot;011&quot;</span><span class="p">,</span>		<span class="cm">/* 011 */</span>
	<span class="s">&quot;UC&quot;</span><span class="p">,</span>		<span class="cm">/* 100 */</span>
	<span class="s">&quot;UCE&quot;</span><span class="p">,</span>		<span class="cm">/* 101 */</span>
	<span class="s">&quot;WC&quot;</span><span class="p">,</span>		<span class="cm">/* 110 */</span>
	<span class="s">&quot;NaTPage&quot;</span>	<span class="cm">/* 111 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Take a 64bit vector and produces a string such that</span>
<span class="cm"> * if bit n is set then 2^n in clear text is generated. The adjustment</span>
<span class="cm"> * to the right unit is also done.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	- a pointer to a buffer to hold the string</span>
<span class="cm"> *	- a 64-bit vector</span>
<span class="cm"> * Ouput:</span>
<span class="cm"> *	- a pointer to the end of the buffer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">bitvector_process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u64</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">units</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">,</span> <span class="s">&quot;M&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span> <span class="s">&quot;T&quot;</span> <span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d%s &quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">j</span><span class="o">*</span><span class="mi">10</span><span class="p">),</span> <span class="n">units</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">vector</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Take a 64bit vector and produces a string such that</span>
<span class="cm"> * if bit n is set then register n is present. The function</span>
<span class="cm"> * takes into account consecutive registers and prints out ranges.</span>
<span class="cm"> *</span>
<span class="cm"> * Input:</span>
<span class="cm"> *	- a pointer to a buffer to hold the string</span>
<span class="cm"> *	- a 64-bit vector</span>
<span class="cm"> * Ouput:</span>
<span class="cm"> *	- a pointer to the end of the buffer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">bitregister_process</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">reg_info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">value</span> <span class="o">=</span> <span class="n">reg_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">64</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*++</span><span class="n">reg_info</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">begin</span>  <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d-%d &quot;</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">skip</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">begin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">begin</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d-127&quot;</span><span class="p">,</span> <span class="n">begin</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;127&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">power_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">halt_info_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">pal_power_mgmt_info_u_t</span> <span class="o">*</span><span class="n">halt_info</span> <span class="o">=</span><span class="p">(</span><span class="n">pal_power_mgmt_info_u_t</span> <span class="o">*</span><span class="p">)</span><span class="n">halt_info_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_halt_info</span><span class="p">(</span><span class="n">halt_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">halt_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pal_power_mgmt_info_s</span><span class="p">.</span><span class="n">im</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>	<span class="s">&quot;Power level %d:</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">entry_latency       : %d cycles</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">exit_latency        : %d cycles</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">power consumption   : %d mW</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Cache+TLB coherency : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				     <span class="n">halt_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pal_power_mgmt_info_s</span><span class="p">.</span><span class="n">entry_latency</span><span class="p">,</span>
				     <span class="n">halt_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pal_power_mgmt_info_s</span><span class="p">.</span><span class="n">exit_latency</span><span class="p">,</span>
				     <span class="n">halt_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pal_power_mgmt_info_s</span><span class="p">.</span><span class="n">power_consumption</span><span class="p">,</span>
				     <span class="n">halt_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pal_power_mgmt_info_s</span><span class="p">.</span><span class="n">co</span> <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&quot;Power level %d: not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cache_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">unique_caches</span><span class="p">;</span>
	<span class="n">pal_cache_config_info_t</span> <span class="n">cci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_cache_summary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">levels</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unique_caches</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ia64_pal_cache_summary=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Cache levels  : %ld</span><span class="se">\n</span><span class="s">Unique caches : %ld</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">unique_caches</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">levels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* even without unification some level may not be present */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">=</span><span class="n">ia64_pal_cache_config_info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cci</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
				     <span class="s">&quot;%s Cache level %lu:</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Size           : %u bytes</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Attributes     : &quot;</span><span class="p">,</span>
				     <span class="n">cache_types</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_unified</span><span class="p">],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
				     <span class="n">cci</span><span class="p">.</span><span class="n">pcci_cache_size</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_unified</span><span class="p">)</span> <span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Unified &quot;</span><span class="p">);</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cache_mattrib</span><span class="p">[</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_cache_attr</span><span class="p">]);</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Associativity  : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Line size      : %d bytes</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Stride         : %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">cci</span><span class="p">.</span><span class="n">pcci_assoc</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_line_size</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_stride</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Store latency  : N/A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Store latency  : %d cycle(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">cci</span><span class="p">.</span><span class="n">pcci_st_latency</span><span class="p">);</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Load latency   : %d cycle(s)</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Store hints    : &quot;</span><span class="p">,</span> <span class="n">cci</span><span class="p">.</span><span class="n">pcci_ld_latency</span><span class="p">);</span>

			<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span> <span class="n">cci</span><span class="p">.</span><span class="n">pcci_st_hints</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">cache_st_hints</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
				<span class="n">cci</span><span class="p">.</span><span class="n">pcci_st_hints</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Load hints     : &quot;</span><span class="p">);</span>

			<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_ld_hints</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;[%s]&quot;</span><span class="p">,</span> <span class="n">cache_ld_hints</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
				<span class="n">cci</span><span class="p">.</span><span class="n">pcci_ld_hints</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
				     <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Alias boundary : %d byte(s)</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Tag LSB        : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Tag MSB        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_alias_boundary</span><span class="p">,</span> <span class="n">cci</span><span class="p">.</span><span class="n">pcci_tag_lsb</span><span class="p">,</span>
				     <span class="n">cci</span><span class="p">.</span><span class="n">pcci_tag_msb</span><span class="p">);</span>

			<span class="cm">/* when unified, data(j=2) is enough */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cci</span><span class="p">.</span><span class="n">pcci_unified</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vm_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tr_pages</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vw_pages</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tc_pages</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">attrib</span><span class="p">;</span>
	<span class="n">pal_vm_info_1_u_t</span> <span class="n">vm_info_1</span><span class="p">;</span>
	<span class="n">pal_vm_info_2_u_t</span> <span class="n">vm_info_2</span><span class="p">;</span>
	<span class="n">pal_tc_info_u_t</span>	<span class="n">tc_info</span><span class="p">;</span>
	<span class="n">ia64_ptce_info_t</span> <span class="n">ptce</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_vm_summary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_info_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm_info_2</span><span class="p">))</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ia64_pal_vm_summary=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;Physical Address Space         : %d bits</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Virtual Address Space          : %d bits</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Protection Key Registers(PKR)  : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Implemented bits in PKR.key    : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Hash Tag ID                    : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Size of RR.rid                 : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Max Purges                     : &quot;</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">phys_add_size</span><span class="p">,</span>
		     <span class="n">vm_info_2</span><span class="p">.</span><span class="n">pal_vm_info_2_s</span><span class="p">.</span><span class="n">impl_va_msb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_pkr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">key_size</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">hash_tag_id</span><span class="p">,</span>
		     <span class="n">vm_info_2</span><span class="p">.</span><span class="n">pal_vm_info_2_s</span><span class="p">.</span><span class="n">rid_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vm_info_2</span><span class="p">.</span><span class="n">pal_vm_info_2_s</span><span class="p">.</span><span class="n">max_purges</span> <span class="o">==</span> <span class="n">PAL_MAX_PURGES</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;unlimited</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     		<span class="n">vm_info_2</span><span class="p">.</span><span class="n">pal_vm_info_2_s</span><span class="p">.</span><span class="n">max_purges</span> <span class="o">?</span>
				<span class="n">vm_info_2</span><span class="p">.</span><span class="n">pal_vm_info_2_s</span><span class="p">.</span><span class="n">max_purges</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_mem_attrib</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrib</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Supported memory attributes    : &quot;</span><span class="p">);</span>
		<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrib</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">mem_attrib</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_vm_page_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vw_pages</span><span class="p">))</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ia64_pal_vm_page_size=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
			     <span class="s">&quot;</span><span class="se">\n</span><span class="s">TLB walker                     : %simplemented</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;Number of DTR                  : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;Number of ITR                  : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;TLB insertable page sizes      : &quot;</span><span class="p">,</span>
			     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">vw</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">,</span>
			     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_dtr_entry</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_itr_entry</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>


		<span class="n">p</span> <span class="o">=</span> <span class="n">bitvector_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tr_pages</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">TLB purgeable page sizes       : &quot;</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">bitvector_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vw_pages</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">=</span><span class="n">ia64_get_ptce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptce</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ia64_get_ptce=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;</span><span class="se">\n</span><span class="s">Purge base address             : 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Purge outer loop count         : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Purge inner loop count         : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Purge outer loop stride        : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Purge inner loop stride        : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ptce</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">ptce</span><span class="p">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptce</span><span class="p">.</span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		     <span class="n">ptce</span><span class="p">.</span><span class="n">stride</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptce</span><span class="p">.</span><span class="n">stride</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;TC Levels                      : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Unique TC(s)                   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">num_tc_levels</span><span class="p">,</span>
		     <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_unique_tcs</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">num_tc_levels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tc_pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just in case */</span>


				<span class="cm">/* even without unification, some levels may not be present */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="o">=</span><span class="n">ia64_pal_vm_info</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tc_pages</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
				     <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s Translation Cache Level %d:</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Hash sets           : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Associativity       : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Number of entries   : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				     <span class="s">&quot;</span><span class="se">\t</span><span class="s">Flags               : &quot;</span><span class="p">,</span>
				     <span class="n">cache_types</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">tc_info</span><span class="p">.</span><span class="n">tc_unified</span><span class="p">],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
				     <span class="n">tc_info</span><span class="p">.</span><span class="n">tc_num_sets</span><span class="p">,</span>
				     <span class="n">tc_info</span><span class="p">.</span><span class="n">tc_associativity</span><span class="p">,</span>
				     <span class="n">tc_info</span><span class="p">.</span><span class="n">tc_num_entries</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">tc_info</span><span class="p">.</span><span class="n">tc_pf</span><span class="p">)</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;PreferredPageSizeOptimized &quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tc_info</span><span class="p">.</span><span class="n">tc_unified</span><span class="p">)</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Unified &quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tc_info</span><span class="p">.</span><span class="n">tc_reduce_tr</span><span class="p">)</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;TCReduction&quot;</span><span class="p">);</span>

				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">Supported page sizes: &quot;</span><span class="p">);</span>

				<span class="n">p</span> <span class="o">=</span> <span class="n">bitvector_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tc_pages</span><span class="p">);</span>

				<span class="cm">/* when unified date (j=2) is enough */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tc_info</span><span class="p">.</span><span class="n">tc_unified</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">register_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">reg_info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">phys_stacked</span><span class="p">;</span>
	<span class="n">pal_hints_u_t</span> <span class="n">hints</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iregs</span><span class="p">,</span> <span class="n">dregs</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">info_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Implemented AR(s)&quot;</span><span class="p">,</span>
		<span class="s">&quot;AR(s) with read side-effects&quot;</span><span class="p">,</span>
		<span class="s">&quot;Implemented CR(s)&quot;</span><span class="p">,</span>
		<span class="s">&quot;CR(s) with read side-effects&quot;</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">for</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">info</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">info</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_register_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">reg_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%-32s : &quot;</span><span class="p">,</span> <span class="n">info_type</span><span class="p">[</span><span class="n">info</span><span class="p">]);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">bitregister_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg_info</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_rse_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phys_stacked</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;RSE stacked physical registers   : %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;RSE load/store hints             : %ld (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">phys_stacked</span><span class="p">,</span> <span class="n">hints</span><span class="p">.</span><span class="n">ph_data</span><span class="p">,</span>
		     <span class="n">hints</span><span class="p">.</span><span class="n">ph_data</span> <span class="o">&lt;</span> <span class="n">RSE_HINTS_COUNT</span> <span class="o">?</span> <span class="n">rse_hints</span><span class="p">[</span><span class="n">hints</span><span class="p">.</span><span class="n">ph_data</span><span class="p">]</span><span class="o">:</span> <span class="s">&quot;(??)&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_debug_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iregs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dregs</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;Instruction debug register pairs : %ld</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Data debug register pairs        : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iregs</span><span class="p">,</span> <span class="n">dregs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proc_features_0</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>		<span class="cm">/* Feature set 0 */</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;Unimplemented instruction address fault&quot;</span><span class="p">,</span>
	<span class="s">&quot;INIT, PMI, and LINT pins&quot;</span><span class="p">,</span>
	<span class="s">&quot;Simple unimplemented instr addresses&quot;</span><span class="p">,</span>
	<span class="s">&quot;Variable P-state performance&quot;</span><span class="p">,</span>
	<span class="s">&quot;Virtual machine features implemented&quot;</span><span class="p">,</span>
	<span class="s">&quot;XIP,XPSR,XFS implemented&quot;</span><span class="p">,</span>
	<span class="s">&quot;XR1-XR3 implemented&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable dynamic predicate prediction&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable processor physical number&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable dynamic data cache prefetch&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable dynamic inst cache prefetch&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable dynamic branch prediction&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;Disable P-states&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable MCA on Data Poisoning&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable vmsw instruction&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable extern environmental notification&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable BINIT on processor time-out&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable dynamic power management (DPM)&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable coherency&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable cache&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable CMCI promotion&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable MCA to BINIT promotion&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable MCA promotion&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable BERR promotion&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proc_features_16</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>		<span class="cm">/* Feature set 16 */</span>
	<span class="s">&quot;Disable ETM&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable ETM&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable MCA on half-way timer&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable snoop WC&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;Enable Fast Deferral&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable MCA on memory aliasing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable RSB&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;DP system processor&quot;</span><span class="p">,</span>
	<span class="s">&quot;Low Voltage&quot;</span><span class="p">,</span>
	<span class="s">&quot;HT supported&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">**</span><span class="n">proc_features</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="n">proc_features_0</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="n">proc_features_16</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">feature_set_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="n">u64</span> <span class="n">avail</span><span class="p">,</span> <span class="n">u64</span> <span class="n">status</span><span class="p">,</span> <span class="n">u64</span> <span class="n">control</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">vf</span><span class="p">,</span> <span class="o">**</span><span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vf</span> <span class="o">=</span> <span class="n">v</span> <span class="o">=</span> <span class="n">proc_features</span><span class="p">[</span><span class="n">set</span><span class="p">];</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">avail</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">control</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">control</span><span class="p">))</span>		<span class="cm">/* No remaining bits set */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>	<span class="cm">/* Print only bits that are available */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">vf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">v</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">v</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%-40s : %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span>
						<span class="s">&quot;On &quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span>
						<span class="s">&quot;Ctrl&quot;</span> <span class="o">:</span> <span class="s">&quot;NoCtrl&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Feature set %2ld bit %2d</span><span class="se">\t\t\t</span><span class="s">&quot;</span>
					<span class="s">&quot; : %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">set</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span>
						<span class="s">&quot;On &quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span>
						<span class="s">&quot;Ctrl&quot;</span> <span class="o">:</span> <span class="s">&quot;NoCtrl&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">processor_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">avail</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">feature_set</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ia64_pal_proc_get_features</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avail</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="p">,</span>
						<span class="n">feature_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">feature_set</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">feature_set_info</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">avail</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">feature_set</span><span class="p">);</span>

		<span class="n">feature_set</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bus_features</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;Request  Bus Parking&quot;</span><span class="p">,</span>
	<span class="s">&quot;Bus Lock Mask&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable Half Transfer&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="s">&quot;Enable Cache Line Repl. Shared&quot;</span><span class="p">,</span>
	<span class="s">&quot;Enable Cache Line Repl. Exclusive&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Transaction Queuing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Response Error Checking&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Error Checking&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Requester Internal Error Signalling&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Requester Error Signalling&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Initialization Event Checking&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Initialization Event Signalling&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Address Error Checking&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Address Error Signalling&quot;</span><span class="p">,</span>
	<span class="s">&quot;Disable Bus Data Error Checking&quot;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bus_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">v</span> <span class="o">=</span> <span class="n">bus_features</span><span class="p">;</span>
	<span class="n">pal_bus_features_u_t</span> <span class="n">av</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ct</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">avail</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span><span class="o">=</span><span class="n">ia64_pal_bus_get_features</span><span class="p">(</span><span class="o">&amp;</span><span class="n">av</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">avail</span>   <span class="o">=</span> <span class="n">av</span><span class="p">.</span><span class="n">pal_bus_features_val</span><span class="p">;</span>
	<span class="n">status</span>  <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">pal_bus_features_val</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">ct</span><span class="p">.</span><span class="n">pal_bus_features_val</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">v</span><span class="o">++</span><span class="p">,</span> <span class="n">avail</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">status</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">,</span> <span class="n">control</span> <span class="o">&gt;&gt;=</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="o">*</span><span class="n">v</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%-48s : %s%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;NotImpl&quot;</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">status</span>  <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">avail</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="o">?</span> <span class="s">&quot;Ctrl&quot;</span> <span class="o">:</span> <span class="s">&quot;NoCtrl&quot;</span><span class="p">)</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">version_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pal_version_u_t</span> <span class="n">min_ver</span><span class="p">,</span> <span class="n">cur_ver</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_version</span><span class="p">(</span><span class="o">&amp;</span><span class="n">min_ver</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_ver</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;PAL_vendor : 0x%02x (min=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;PAL_A      : %02x.%02x (min=%02x.%02x)</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;PAL_B      : %02x.%02x (min=%02x.%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">cur_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_vendor</span><span class="p">,</span>
		     <span class="n">min_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_vendor</span><span class="p">,</span>
		     <span class="n">cur_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_a_model</span><span class="p">,</span>
		     <span class="n">cur_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_a_rev</span><span class="p">,</span>
		     <span class="n">min_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_a_model</span><span class="p">,</span>
		     <span class="n">min_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_a_rev</span><span class="p">,</span>
		     <span class="n">cur_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_b_model</span><span class="p">,</span>
		     <span class="n">cur_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_b_rev</span><span class="p">,</span>
		     <span class="n">min_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_b_model</span><span class="p">,</span>
		     <span class="n">min_ver</span><span class="p">.</span><span class="n">pal_version_s</span><span class="p">.</span><span class="n">pv_pal_b_rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">perfmon_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">pm_buffer</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">pal_perf_mon_info_u_t</span> <span class="n">pm_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_perf_mon_info</span><span class="p">(</span><span class="n">pm_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pm_info</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;PMC/PMD pairs                 : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Counter width                 : %d bits</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Cycle event number            : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Retired event number          : %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Implemented PMC               : &quot;</span><span class="p">,</span>
		     <span class="n">pm_info</span><span class="p">.</span><span class="n">pal_perf_mon_info_s</span><span class="p">.</span><span class="n">generic</span><span class="p">,</span> <span class="n">pm_info</span><span class="p">.</span><span class="n">pal_perf_mon_info_s</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
		     <span class="n">pm_info</span><span class="p">.</span><span class="n">pal_perf_mon_info_s</span><span class="p">.</span><span class="n">cycles</span><span class="p">,</span> <span class="n">pm_info</span><span class="p">.</span><span class="n">pal_perf_mon_info_s</span><span class="p">.</span><span class="n">retired</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bitregister_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pm_buffer</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Implemented PMD               : &quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">bitregister_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pm_buffer</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Cycles count capable          : &quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">bitregister_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pm_buffer</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Retired bundles count capable : &quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ITANIUM</span>
	<span class="cm">/*</span>
<span class="cm">	 * PAL_PERF_MON_INFO reports that only PMC4 can be used to count CPU_CYCLES</span>
<span class="cm">	 * which is wrong, both PMC4 and PMD5 support it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="n">pm_buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">=</span><span class="mh">0x30</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">bitregister_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pm_buffer</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">frequency_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pal_freq_ratio</span> <span class="n">proc</span><span class="p">,</span> <span class="n">itc</span><span class="p">,</span> <span class="n">bus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_freq_base</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Output clock            : not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Output clock            : %ld ticks/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ia64_pal_freq_ratios</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
		     <span class="s">&quot;Processor/Clock ratio   : %d/%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Bus/Clock ratio         : %d/%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;ITC/Clock ratio         : %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">proc</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">proc</span><span class="p">.</span><span class="n">den</span><span class="p">,</span> <span class="n">bus</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">bus</span><span class="p">.</span><span class="n">den</span><span class="p">,</span> <span class="n">itc</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">itc</span><span class="p">.</span><span class="n">den</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">tr_info</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">pal_tr_valid_u_t</span> <span class="n">tr_valid</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tr_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">pal_vm_info_1_u_t</span> <span class="n">vm_info_1</span><span class="p">;</span>
	<span class="n">pal_vm_info_2_u_t</span> <span class="n">vm_info_2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">pgm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ifa_reg</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">valid</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ig</span><span class="o">:</span><span class="mi">11</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vpn</span><span class="o">:</span><span class="mi">52</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">ifa_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">itir_reg</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv1</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ps</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">key</span><span class="o">:</span><span class="mi">24</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv2</span><span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">itir_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gr_reg</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ma</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pl</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ar</span><span class="o">:</span><span class="mi">3</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ppn</span><span class="o">:</span><span class="mi">38</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv2</span><span class="o">:</span><span class="mi">2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ed</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ig</span><span class="o">:</span><span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">gr_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rid_reg</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ig1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ig2</span><span class="o">:</span><span class="mi">6</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rid</span><span class="o">:</span><span class="mi">24</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rv2</span><span class="o">:</span><span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">rid_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_vm_summary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vm_info_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vm_info_2</span><span class="p">))</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ia64_pal_vm_summary=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_itr_entry</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm_info_1</span><span class="p">.</span><span class="n">pal_vm_info_1_s</span><span class="p">.</span><span class="n">max_dtr_entry</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ia64_pal_tr_read</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr_valid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;palinfo: pal call failed on tr[%lu:%lu]=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ifa_reg</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ifa_reg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tr_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ifa_reg</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="n">gr_reg</span>   <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gr_reg</span> <span class="o">*</span><span class="p">)</span><span class="n">tr_buffer</span><span class="p">;</span>
		<span class="n">itir_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">itir_reg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tr_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">rid_reg</span>  <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rid_reg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tr_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="n">pgm</span>	 <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">itir_reg</span><span class="o">-&gt;</span><span class="n">ps</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
			     <span class="s">&quot;%cTR%lu: av=%d pv=%d dv=%d mv=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">ppn  : 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">vpn  : 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">ps   : &quot;</span><span class="p">,</span>
			     <span class="s">&quot;ID&quot;</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">j</span><span class="p">,</span>
			     <span class="n">tr_valid</span><span class="p">.</span><span class="n">pal_tr_valid_s</span><span class="p">.</span><span class="n">access_rights_valid</span><span class="p">,</span>
			     <span class="n">tr_valid</span><span class="p">.</span><span class="n">pal_tr_valid_s</span><span class="p">.</span><span class="n">priv_level_valid</span><span class="p">,</span>
			     <span class="n">tr_valid</span><span class="p">.</span><span class="n">pal_tr_valid_s</span><span class="p">.</span><span class="n">dirty_bit_valid</span><span class="p">,</span>
			     <span class="n">tr_valid</span><span class="p">.</span><span class="n">pal_tr_valid_s</span><span class="p">.</span><span class="n">mem_attr_valid</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">ppn</span> <span class="o">&amp;</span> <span class="n">pgm</span><span class="p">)</span><span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="n">ifa_reg</span><span class="o">-&gt;</span><span class="n">vpn</span> <span class="o">&amp;</span> <span class="n">pgm</span><span class="p">)</span><span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">bitvector_process</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span> <span class="n">itir_reg</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
			     <span class="s">&quot;</span><span class="se">\n\t</span><span class="s">pl   : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">ar   : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">rid  : %x</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">p    : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">ma   : %d</span><span class="se">\n</span><span class="s">&quot;</span>
			     <span class="s">&quot;</span><span class="se">\t</span><span class="s">d    : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">pl</span><span class="p">,</span> <span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">rid_reg</span><span class="o">-&gt;</span><span class="n">rid</span><span class="p">,</span> <span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">ma</span><span class="p">,</span>
			     <span class="n">gr_reg</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * List {name,function} pairs for every entry in /proc/palinfo/cpu*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">palinfo_entry_t</span> <span class="n">palinfo_entries</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;version_info&quot;</span><span class="p">,</span>	<span class="n">version_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vm_info&quot;</span><span class="p">,</span>		<span class="n">vm_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cache_info&quot;</span><span class="p">,</span>		<span class="n">cache_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;power_info&quot;</span><span class="p">,</span>		<span class="n">power_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;register_info&quot;</span><span class="p">,</span>	<span class="n">register_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;processor_info&quot;</span><span class="p">,</span>	<span class="n">processor_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;perfmon_info&quot;</span><span class="p">,</span>	<span class="n">perfmon_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;frequency_info&quot;</span><span class="p">,</span>	<span class="n">frequency_info</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;bus_info&quot;</span><span class="p">,</span>		<span class="n">bus_info</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;tr_info&quot;</span><span class="p">,</span>		<span class="n">tr_info</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NR_PALINFO_ENTRIES	(int) ARRAY_SIZE(palinfo_entries)</span>

<span class="cm">/*</span>
<span class="cm"> * this array is used to keep track of the proc entries we create. This is</span>
<span class="cm"> * required in the module mode when we need to remove all entries. The procfs code</span>
<span class="cm"> * does not do recursion of deletion</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *	- +1 accounts for the cpuN directory entry in /proc/pal</span>
<span class="cm"> */</span>
<span class="cp">#define NR_PALINFO_PROC_ENTRIES	(NR_CPUS*(NR_PALINFO_ENTRIES+1))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">palinfo_proc_entries</span><span class="p">[</span><span class="n">NR_PALINFO_PROC_ENTRIES</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">palinfo_dir</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This data structure is used to pass which cpu,function is being requested</span>
<span class="cm"> * It must fit in a 64bit quantity to be passed to the proc callback routine</span>
<span class="cm"> *</span>
<span class="cm"> * In SMP mode, when we get a request for another CPU, we must call that</span>
<span class="cm"> * other CPU using IPI and wait for the result before returning.</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span>	<span class="n">req_cpu</span><span class="o">:</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* for which CPU this info is */</span>
		<span class="kt">unsigned</span>	<span class="n">func_id</span><span class="o">:</span> <span class="mi">32</span><span class="p">;</span>	<span class="cm">/* which function is requested */</span>
	<span class="p">}</span> <span class="n">pal_func_cpu</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pal_func_cpu_u_t</span><span class="p">;</span>

<span class="cp">#define req_cpu	pal_func_cpu.req_cpu</span>
<span class="cp">#define func_id pal_func_cpu.func_id</span>

<span class="cp">#ifdef CONFIG_SMP</span>

<span class="cm">/*</span>
<span class="cm"> * used to hold information about final function to call</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">palinfo_func_t</span>	<span class="n">func</span><span class="p">;</span>	<span class="cm">/* pointer to function to call */</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">page</span><span class="p">;</span>	<span class="cm">/* buffer to store results */</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>	<span class="cm">/* return value from call */</span>
<span class="p">}</span> <span class="n">palinfo_smp_data_t</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * this function does the actual final call and he called</span>
<span class="cm"> * from the smp code, i.e., this is the palinfo callback routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">palinfo_smp_call</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">palinfo_smp_data_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">palinfo_smp_data_t</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * function called to trigger the IPI, we need to access a remote CPU</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	0 : error or nothing to output</span>
<span class="cm"> *	otherwise how many bytes in the &quot;page&quot; buffer were written</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">palinfo_handle_smp</span><span class="p">(</span><span class="n">pal_func_cpu_u_t</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">palinfo_smp_data_t</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ptr</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">palinfo_entries</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">].</span><span class="n">proc_read</span><span class="p">;</span>
	<span class="n">ptr</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">ptr</span><span class="p">.</span><span class="n">ret</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just in case */</span>


	<span class="cm">/* will send IPI to other CPU and wait for completion of remote call */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span><span class="o">=</span><span class="n">smp_call_function_single</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">,</span> <span class="n">palinfo_smp_call</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;palinfo: remote CPU call from %d to %d on function %d: &quot;</span>
		       <span class="s">&quot;error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smp_processor_id</span><span class="p">(),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">req_cpu</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">.</span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* ! CONFIG_SMP */</span><span class="cp"></span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">palinfo_handle_smp</span><span class="p">(</span><span class="n">pal_func_cpu_u_t</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;palinfo: should not be called with non SMP kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SMP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Entry point routine: all calls go through this function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">palinfo_read_entry</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">pal_func_cpu_u_t</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">pal_func_cpu_u_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * in SMP mode, we may need to call another CPU to get correct</span>
<span class="cm">	 * information. PAL, by definition, is processor specific</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">req_cpu</span> <span class="o">==</span> <span class="n">get_cpu</span><span class="p">())</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">palinfo_entries</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">].</span><span class="n">proc_read</span><span class="p">)(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">palinfo_handle_smp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="n">put_cpu</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="o">+</span><span class="n">count</span><span class="p">)</span> <span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">len</span>   <span class="o">-=</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;</span><span class="n">count</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__cpuinit</span>
<span class="nf">create_palinfo_proc_entries</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#	define CPUSTR	&quot;cpu%d&quot;</span>

	<span class="n">pal_func_cpu_u_t</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">**</span><span class="n">pdir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">cpu_dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cpustr</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CPUSTR</span><span class="p">)];</span>


	<span class="cm">/*</span>
<span class="cm">	 * we keep track of created entries in a depth-first order for</span>
<span class="cm">	 * cleanup purposes. Each entry is stored into palinfo_proc_entries</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">cpustr</span><span class="p">,</span><span class="n">CPUSTR</span><span class="p">,</span> <span class="n">cpu</span><span class="p">);</span>

	<span class="n">cpu_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">cpustr</span><span class="p">,</span> <span class="n">palinfo_dir</span><span class="p">);</span>

	<span class="n">f</span><span class="p">.</span><span class="n">req_cpu</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the location to store per cpu entries</span>
<span class="cm">	 * We dont store the top level entry in this list, but</span>
<span class="cm">	 * remove it finally after removing all cpu entries.</span>
<span class="cm">	 */</span>
	<span class="n">pdir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">palinfo_proc_entries</span><span class="p">[</span><span class="n">cpu</span><span class="o">*</span><span class="p">(</span><span class="n">NR_PALINFO_ENTRIES</span><span class="o">+</span><span class="mi">1</span><span class="p">)];</span>
	<span class="o">*</span><span class="n">pdir</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_dir</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NR_PALINFO_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="p">.</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pdir</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span>
				<span class="n">palinfo_entries</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cpu_dir</span><span class="p">,</span>
				<span class="n">palinfo_read_entry</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">f</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
		<span class="n">pdir</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">remove_palinfo_proc_entries</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">cpu_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">pdir</span><span class="p">;</span>

	<span class="n">pdir</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">palinfo_proc_entries</span><span class="p">[</span><span class="n">hcpu</span><span class="o">*</span><span class="p">(</span><span class="n">NR_PALINFO_ENTRIES</span><span class="o">+</span><span class="mi">1</span><span class="p">)];</span>
	<span class="n">cpu_dir</span> <span class="o">=</span> <span class="o">*</span><span class="n">pdir</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pdir</span><span class="o">++=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">NR_PALINFO_ENTRIES</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pdir</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">remove_proc_entry</span> <span class="p">((</span><span class="o">*</span><span class="n">pdir</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cpu_dir</span><span class="p">);</span>
			<span class="o">*</span><span class="n">pdir</span> <span class="o">++=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">cpu_dir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">palinfo_dir</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__cpuinit</span> <span class="nf">palinfo_cpu_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nfb</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hcpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hotcpu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hcpu</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU_ONLINE</span>:
	<span class="k">case</span> <span class="n">CPU_ONLINE_FROZEN</span>:
		<span class="n">create_palinfo_proc_entries</span><span class="p">(</span><span class="n">hotcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU_DEAD</span>:
	<span class="k">case</span> <span class="n">CPU_DEAD_FROZEN</span>:
		<span class="n">remove_palinfo_proc_entries</span><span class="p">(</span><span class="n">hotcpu</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">__refdata</span> <span class="n">palinfo_cpu_notifier</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">palinfo_cpu_callback</span><span class="p">,</span>
	<span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">palinfo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;PAL Information Facility v%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PALINFO_VERSION</span><span class="p">);</span>
	<span class="n">palinfo_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;pal&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Create palinfo dirs in /proc for all online cpus */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">create_palinfo_proc_entries</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register for future delivery via notify registration */</span>
	<span class="n">register_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palinfo_cpu_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">palinfo_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* remove all nodes: depth first pass. Could optimize this  */</span>
	<span class="n">for_each_online_cpu</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_palinfo_proc_entries</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove the top level entry finally</span>
<span class="cm">	 */</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">palinfo_dir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unregister from cpu notifier callbacks</span>
<span class="cm">	 */</span>
	<span class="n">unregister_hotcpu_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">palinfo_cpu_notifier</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">palinfo_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">palinfo_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
