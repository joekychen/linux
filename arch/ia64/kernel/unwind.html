<!DOCTYPE html>
<html><head><title>joekychen/linux » arch › ia64 › kernel › unwind.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>unwind.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 1999-2004 Hewlett-Packard Co</span>
<span class="cm"> *	David Mosberger-Tang &lt;davidm@hpl.hp.com&gt;</span>
<span class="cm"> * Copyright (C) 2003 Fenghua Yu &lt;fenghua.yu@intel.com&gt;</span>
<span class="cm"> * 	- Change pt_regs_off() to make it less dependent on pt_regs structure.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * This file implements call frame unwind support for the Linux</span>
<span class="cm"> * kernel.  Parsing and processing the unwind information is</span>
<span class="cm"> * time-consuming, so this implementation translates the unwind</span>
<span class="cm"> * descriptors into unwind scripts.  These scripts are very simple</span>
<span class="cm"> * (basically a sequence of assignments) and efficient to execute.</span>
<span class="cm"> * They are cached for later re-use.  Each script is specific for a</span>
<span class="cm"> * given instruction pointer address and the set of predicate values</span>
<span class="cm"> * that the script depends on (most unwind descriptors are</span>
<span class="cm"> * unconditional and scripts often do not depend on predicates at</span>
<span class="cm"> * all).  This code is based on the unwind conventions described in</span>
<span class="cm"> * the &quot;IA-64 Software Conventions and Runtime Architecture&quot; manual.</span>
<span class="cm"> *</span>
<span class="cm"> * SMP conventions:</span>
<span class="cm"> *	o updates to the global unwind data (in structure &quot;unw&quot;) are serialized</span>
<span class="cm"> *	  by the unw.lock spinlock</span>
<span class="cm"> *	o each unwind script has its own read-write lock; a thread must acquire</span>
<span class="cm"> *	  a read lock before executing a script and must acquire a write lock</span>
<span class="cm"> *	  before modifying a script</span>
<span class="cm"> *	o if both the unw.lock spinlock and a script&#39;s read-write lock must be</span>
<span class="cm"> *	  acquired, then the read-write lock must be acquired first.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bootmem.h&gt;</span>
<span class="cp">#include &lt;linux/elf.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/unwind.h&gt;</span>

<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace.h&gt;</span>
<span class="cp">#include &lt;asm/ptrace_offsets.h&gt;</span>
<span class="cp">#include &lt;asm/rse.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;entry.h&quot;</span>
<span class="cp">#include &quot;unwind_i.h&quot;</span>

<span class="cp">#define UNW_LOG_CACHE_SIZE	7	</span><span class="cm">/* each unw_script is ~256 bytes in size */</span><span class="cp"></span>
<span class="cp">#define UNW_CACHE_SIZE		(1 &lt;&lt; UNW_LOG_CACHE_SIZE)</span>

<span class="cp">#define UNW_LOG_HASH_SIZE	(UNW_LOG_CACHE_SIZE + 1)</span>
<span class="cp">#define UNW_HASH_SIZE		(1 &lt;&lt; UNW_LOG_HASH_SIZE)</span>

<span class="cp">#define UNW_STATS	0	</span><span class="cm">/* WARNING: this disabled interrupts for long time-spans!! */</span><span class="cp"></span>

<span class="cp">#ifdef UNW_DEBUG</span>
  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">unw_debug_level</span> <span class="o">=</span> <span class="n">UNW_DEBUG</span><span class="p">;</span>
<span class="cp">#  define UNW_DEBUG_ON(n)	unw_debug_level &gt;= n</span>
   <span class="cm">/* Do not code a printk level, not all debug lines end in newline */</span>
<span class="cp">#  define UNW_DPRINT(n, ...)  if (UNW_DEBUG_ON(n)) printk(__VA_ARGS__)</span>
<span class="cp">#  undef inline</span>
<span class="cp">#  define inline</span>
<span class="cp">#else </span><span class="cm">/* !UNW_DEBUG */</span><span class="cp"></span>
<span class="cp">#  define UNW_DEBUG_ON(n)  0</span>
<span class="cp">#  define UNW_DPRINT(n, ...)</span>
<span class="cp">#endif </span><span class="cm">/* UNW_DEBUG */</span><span class="cp"></span>

<span class="cp">#if UNW_STATS</span>
<span class="cp"># define STAT(x...)	x</span>
<span class="cp">#else</span>
<span class="cp"># define STAT(x...)</span>
<span class="cp">#endif</span>

<span class="cp">#define alloc_reg_state()	kmalloc(sizeof(struct unw_reg_state), GFP_ATOMIC)</span>
<span class="cp">#define free_reg_state(usr)	kfree(usr)</span>
<span class="cp">#define alloc_labeled_state()	kmalloc(sizeof(struct unw_labeled_state), GFP_ATOMIC)</span>
<span class="cp">#define free_labeled_state(usr)	kfree(usr)</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unw_word</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">unw_hash_index_t</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>			<span class="cm">/* spinlock for unwind data */</span>

	<span class="cm">/* list of unwind tables (one per load-module) */</span>
	<span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">tables</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r0</span><span class="p">;</span>			<span class="cm">/* constant 0 for r0 */</span>

	<span class="cm">/* table of registers that prologues can save (and order in which they&#39;re saved): */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">save_order</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* maps a preserved register index (preg_index) to corresponding switch_stack offset: */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sw_off</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lru_head</span><span class="p">;</span>		<span class="cm">/* index of lead-recently used script */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lru_tail</span><span class="p">;</span>		<span class="cm">/* index of most-recently used script */</span>

	<span class="cm">/* index into unw_frame_info for preserved register i */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_NUM_REGS</span><span class="p">];</span>

	<span class="kt">short</span> <span class="n">pt_regs_offsets</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* unwind table for the kernel: */</span>
	<span class="k">struct</span> <span class="n">unw_table</span> <span class="n">kernel_table</span><span class="p">;</span>

	<span class="cm">/* unwind table describing the gate page (kernel code that is mapped into user space): */</span>
	<span class="kt">size_t</span> <span class="n">gate_table_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">gate_table</span><span class="p">;</span>

	<span class="cm">/* hash table that maps instruction pointer to script index: */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hash</span><span class="p">[</span><span class="n">UNW_HASH_SIZE</span><span class="p">];</span>

	<span class="cm">/* script cache: */</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="n">cache</span><span class="p">[</span><span class="n">UNW_CACHE_SIZE</span><span class="p">];</span>

<span class="cp"># ifdef UNW_DEBUG</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">preg_name</span><span class="p">[</span><span class="n">UNW_NUM_REGS</span><span class="p">];</span>
<span class="cp"># endif</span>
<span class="cp"># if UNW_STATS</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">lookups</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">hinted_hits</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">normal_hits</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">collision_chain_traversals</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">cache</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">build_time</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">run_time</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parse_time</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">builds</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">news</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">collisions</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">runs</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">script</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init_time</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unwind_time</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">inits</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">unwinds</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">api</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">stat</span><span class="p">;</span>
<span class="cp"># endif</span>
<span class="p">}</span> <span class="n">unw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tables</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">kernel_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">),</span>
	<span class="p">.</span><span class="n">save_order</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">UNW_REG_RP</span><span class="p">,</span> <span class="n">UNW_REG_PFS</span><span class="p">,</span> <span class="n">UNW_REG_PSP</span><span class="p">,</span> <span class="n">UNW_REG_PR</span><span class="p">,</span>
		<span class="n">UNW_REG_UNAT</span><span class="p">,</span> <span class="n">UNW_REG_LC</span><span class="p">,</span> <span class="n">UNW_REG_FPSR</span><span class="p">,</span> <span class="n">UNW_REG_PRI_UNAT_GR</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">preg_index</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">pri_unat_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>	<span class="cm">/* PRI_UNAT_GR */</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">pri_unat_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>	<span class="cm">/* PRI_UNAT_MEM */</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">bsp_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">bspstore_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">pfs_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">rnat_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">psp</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">rp_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">r4</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">r5</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">r6</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">r7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">unat_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">pr_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">lc_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fpsr_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">b1_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">b2_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">b3_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">b4_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">b5_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">f2_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">f3_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">f4_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">f5_loc</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">17</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">18</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">19</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">20</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">21</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">22</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">23</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">24</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">25</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">26</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">27</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">28</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">29</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">30</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">fr_loc</span><span class="p">[</span><span class="mi">31</span> <span class="o">-</span> <span class="mi">16</span><span class="p">])</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">pt_regs_offsets</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span>  <span class="n">r1</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span>  <span class="n">r2</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span>  <span class="n">r3</span><span class="p">),</span>
		<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span>  <span class="n">r8</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span>  <span class="n">r9</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r10</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r11</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r12</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r13</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r14</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r15</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r16</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r17</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r18</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r19</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r20</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r21</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r22</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r23</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r24</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r25</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r26</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r27</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r28</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r29</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r30</span><span class="p">),</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">r31</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">hash</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">UNW_HASH_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
<span class="cp">#ifdef UNW_DEBUG</span>
	<span class="p">.</span><span class="n">preg_name</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;pri_unat_gr&quot;</span><span class="p">,</span> <span class="s">&quot;pri_unat_mem&quot;</span><span class="p">,</span> <span class="s">&quot;bsp&quot;</span><span class="p">,</span> <span class="s">&quot;bspstore&quot;</span><span class="p">,</span> <span class="s">&quot;ar.pfs&quot;</span><span class="p">,</span> <span class="s">&quot;ar.rnat&quot;</span><span class="p">,</span> <span class="s">&quot;psp&quot;</span><span class="p">,</span> <span class="s">&quot;rp&quot;</span><span class="p">,</span>
		<span class="s">&quot;r4&quot;</span><span class="p">,</span> <span class="s">&quot;r5&quot;</span><span class="p">,</span> <span class="s">&quot;r6&quot;</span><span class="p">,</span> <span class="s">&quot;r7&quot;</span><span class="p">,</span>
		<span class="s">&quot;ar.unat&quot;</span><span class="p">,</span> <span class="s">&quot;pr&quot;</span><span class="p">,</span> <span class="s">&quot;ar.lc&quot;</span><span class="p">,</span> <span class="s">&quot;ar.fpsr&quot;</span><span class="p">,</span>
		<span class="s">&quot;b1&quot;</span><span class="p">,</span> <span class="s">&quot;b2&quot;</span><span class="p">,</span> <span class="s">&quot;b3&quot;</span><span class="p">,</span> <span class="s">&quot;b4&quot;</span><span class="p">,</span> <span class="s">&quot;b5&quot;</span><span class="p">,</span>
		<span class="s">&quot;f2&quot;</span><span class="p">,</span> <span class="s">&quot;f3&quot;</span><span class="p">,</span> <span class="s">&quot;f4&quot;</span><span class="p">,</span> <span class="s">&quot;f5&quot;</span><span class="p">,</span>
		<span class="s">&quot;f16&quot;</span><span class="p">,</span> <span class="s">&quot;f17&quot;</span><span class="p">,</span> <span class="s">&quot;f18&quot;</span><span class="p">,</span> <span class="s">&quot;f19&quot;</span><span class="p">,</span> <span class="s">&quot;f20&quot;</span><span class="p">,</span> <span class="s">&quot;f21&quot;</span><span class="p">,</span> <span class="s">&quot;f22&quot;</span><span class="p">,</span> <span class="s">&quot;f23&quot;</span><span class="p">,</span>
		<span class="s">&quot;f24&quot;</span><span class="p">,</span> <span class="s">&quot;f25&quot;</span><span class="p">,</span> <span class="s">&quot;f26&quot;</span><span class="p">,</span> <span class="s">&quot;f27&quot;</span><span class="p">,</span> <span class="s">&quot;f28&quot;</span><span class="p">,</span> <span class="s">&quot;f29&quot;</span><span class="p">,</span> <span class="s">&quot;f30&quot;</span><span class="p">,</span> <span class="s">&quot;f31&quot;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">read_only</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">r0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">r0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns offset of rREG in struct pt_regs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">pt_regs_off</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">off</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">pt_regs_offsets</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">pt_regs_offsets</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: bad scratch reg r%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span>
<span class="nf">get_scratch_regs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This should not happen with valid unwind info.  */</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: bad unwind info: resetting info-&gt;pt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNW_FLAG_INTERRUPT_FRAME</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">((</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">psp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s: sp 0x%lx pt 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unwind accessors.  */</span>

<span class="kt">int</span>
<span class="nf">unw_access_gr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nat</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">nat_addr</span><span class="p">,</span> <span class="n">nat_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dummy_nat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_ireg</span> <span class="o">*</span><span class="n">ireg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">regnum</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* read r0 always returns 0 */</span>
			<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: trying to access non-existent r%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* access a preserved register */</span>
			<span class="n">ireg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">r4</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ireg</span><span class="o">-&gt;</span><span class="n">loc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nat_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">ireg</span><span class="o">-&gt;</span><span class="n">nat</span><span class="p">.</span><span class="n">off</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ireg</span><span class="o">-&gt;</span><span class="n">nat</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				      <span class="k">case</span> <span class="n">UNW_NAT_VAL</span>:
					<span class="cm">/* simulate getf.sig/setf.sig */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nat</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* write NaTVal and be done with it */</span>
							<span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1fffe</span><span class="p">;</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1003e</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1ffe</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* return NaT and be done with it */</span>
							<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
					<span class="cm">/* fall through */</span>
				      <span class="k">case</span> <span class="n">UNW_NAT_NONE</span>:
					<span class="n">dummy_nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">nat_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_nat</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>

				      <span class="k">case</span> <span class="n">UNW_NAT_MEMSTK</span>:
					<span class="n">nat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1f8</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>

				      <span class="k">case</span> <span class="n">UNW_NAT_REGSTK</span>:
					<span class="n">nat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span>
					    <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: %p outside of regstk &quot;</span>
							<span class="s">&quot;[0x%lx-0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span>
							<span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span>
							<span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nat_addr</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
						<span class="n">nat_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
					<span class="n">nat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">r4</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">nat_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_unat</span><span class="p">;</span>
				<span class="n">nat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1f8</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* access a scratch register */</span>
			<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pt</span> <span class="o">+</span> <span class="n">pt_regs_off</span><span class="p">(</span><span class="n">regnum</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span><span class="p">)</span>
				<span class="n">nat_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">nat_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">caller_unat</span><span class="p">;</span>
			<span class="n">nat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1f8</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* access a stacked register */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">ia64_rse_skip_regs</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">,</span> <span class="n">regnum</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">nat_addr</span> <span class="o">=</span> <span class="n">ia64_rse_rnat_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span>
		    <span class="o">||</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to access register outside &quot;</span>
				   <span class="s">&quot;of rbs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">nat_addr</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
			<span class="n">nat_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
		<span class="n">nat_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">ia64_rse_slot_num</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to write read-only location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nat</span><span class="p">)</span>
				<span class="o">*</span><span class="n">nat_addr</span> <span class="o">|=</span> <span class="n">nat_mask</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">nat_addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">nat_mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">nat_addr</span> <span class="o">&amp;</span> <span class="n">nat_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* if register is a NaT, *addr may contain kernel data! */</span>
			<span class="o">*</span><span class="n">nat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_access_gr</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">unw_access_br</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* scratch: */</span>
	      <span class="k">case</span> <span class="mi">0</span>: <span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mi">6</span>: <span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mi">7</span>: <span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">b7</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>

		<span class="cm">/* preserved: */</span>
	      <span class="k">case</span> <span class="mi">1</span>: <span class="k">case</span> <span class="mi">2</span>: <span class="k">case</span> <span class="mi">3</span>: <span class="k">case</span> <span class="mi">4</span>: <span class="k">case</span> <span class="mi">5</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">b1_loc</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">b1</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: trying to access non-existent b%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to write read-only location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_access_br</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">unw_access_fr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ia64_fpreg</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: trying to access non-existent f%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">f2_loc</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">f2</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">f6</span>  <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">f12</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fr_loc</span><span class="p">[</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">16</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">f16</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="n">ia64_sync_fph</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ia64_flush_fph</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">fph</span> <span class="o">+</span> <span class="p">(</span><span class="n">regnum</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to write read-only location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_access_fr</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">unw_access_ar</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">regnum</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">UNW_AR_BSP</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_BSPSTORE</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bspstore_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_PFS</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pfs_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_RNAT</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rnat_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_rnat</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_UNAT</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">unat_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">caller_unat</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_LC</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lc_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_lc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_EC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
			<span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">=</span>
				<span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3fUL</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">52</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">52</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_FPSR</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fpsr_loc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_fpsr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_RSC</span>:
		<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_rsc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_CCV</span>:
		<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ccv</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_CSD</span>:
		<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_csd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_AR_SSD</span>:
		<span class="n">pt</span> <span class="o">=</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">ar_ssd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: trying to access non-existent ar%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">regnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to write read-only location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_access_ar</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">unw_access_pr</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr_loc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_only</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to write read-only location</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_access_pr</span><span class="p">);</span>


<span class="cm">/* Routines to manipulate the state stack.  */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">push</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>

	<span class="n">rs</span> <span class="o">=</span> <span class="n">alloc_reg_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unwind: cannot stack reg state!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">rs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pop</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unwind: stack underflow!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rs</span><span class="p">));</span>
	<span class="n">free_reg_state</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Make a copy of the state stack.  Non-recursive to avoid stack overflows.  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span>
<span class="nf">dup_state_stack</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">copy</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copy</span> <span class="o">=</span> <span class="n">alloc_reg_state</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unwind.dup_state_stack: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">copy</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">first</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">first</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free all stacked register states (but not RS itself).  */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">free_state_stack</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_state</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_reg_state</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unwind decoder routines */</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">unw_register_index</span> <span class="n">__attribute_const__</span>
<span class="nf">decode_abreg</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">memory</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">abreg</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="mh">0x04</span> <span class="p">...</span> <span class="mh">0x07</span>: <span class="k">return</span> <span class="n">UNW_REG_R4</span> <span class="o">+</span> <span class="p">(</span><span class="n">abreg</span> <span class="o">-</span> <span class="mh">0x04</span><span class="p">);</span>
	      <span class="k">case</span> <span class="mh">0x22</span> <span class="p">...</span> <span class="mh">0x25</span>: <span class="k">return</span> <span class="n">UNW_REG_F2</span> <span class="o">+</span> <span class="p">(</span><span class="n">abreg</span> <span class="o">-</span> <span class="mh">0x22</span><span class="p">);</span>
	      <span class="k">case</span> <span class="mh">0x30</span> <span class="p">...</span> <span class="mh">0x3f</span>: <span class="k">return</span> <span class="n">UNW_REG_F16</span> <span class="o">+</span> <span class="p">(</span><span class="n">abreg</span> <span class="o">-</span> <span class="mh">0x30</span><span class="p">);</span>
	      <span class="k">case</span> <span class="mh">0x41</span> <span class="p">...</span> <span class="mh">0x45</span>: <span class="k">return</span> <span class="n">UNW_REG_B1</span> <span class="o">+</span> <span class="p">(</span><span class="n">abreg</span> <span class="o">-</span> <span class="mh">0x41</span><span class="p">);</span>
	      <span class="k">case</span> <span class="mh">0x60</span>: <span class="k">return</span> <span class="n">UNW_REG_PR</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x61</span>: <span class="k">return</span> <span class="n">UNW_REG_PSP</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x62</span>: <span class="k">return</span> <span class="n">memory</span> <span class="o">?</span> <span class="n">UNW_REG_PRI_UNAT_MEM</span> <span class="o">:</span> <span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x63</span>: <span class="k">return</span> <span class="n">UNW_REG_RP</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x64</span>: <span class="k">return</span> <span class="n">UNW_REG_BSP</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x65</span>: <span class="k">return</span> <span class="n">UNW_REG_BSPSTORE</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x66</span>: <span class="k">return</span> <span class="n">UNW_REG_RNAT</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x67</span>: <span class="k">return</span> <span class="n">UNW_REG_UNAT</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x68</span>: <span class="k">return</span> <span class="n">UNW_REG_FPSR</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x69</span>: <span class="k">return</span> <span class="n">UNW_REG_PFS</span><span class="p">;</span>
	      <span class="k">case</span> <span class="mh">0x6a</span>: <span class="k">return</span> <span class="n">UNW_REG_LC</span><span class="p">;</span>
	      <span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: bad abreg=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">abreg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">UNW_REG_LC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_reg</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="k">enum</span> <span class="n">unw_where</span> <span class="n">where</span><span class="p">,</span> <span class="kt">int</span> <span class="n">when</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">==</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">when</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">alloc_spill_area</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">offp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">regsize</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">lo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">hi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">lo</span><span class="p">;</span> <span class="o">--</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_PSPREL</span><span class="p">;</span>
			<span class="o">*</span><span class="n">offp</span> <span class="o">-=</span> <span class="n">regsize</span><span class="p">;</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">offp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">spill_next_when</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">**</span><span class="n">regp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">lim</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="o">*</span><span class="n">regp</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="n">lim</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: excess spill!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">finish_prologue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, resolve implicit register save locations (see Section &quot;11.4.2.3 Rules</span>
<span class="cm">	 * for Using Unwind Descriptors&quot;, rule 3):</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">save_order</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">unw</span><span class="p">.</span><span class="n">save_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_GR_SAVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_GR</span><span class="p">;</span>
			<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">gr_save_loc</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next, compute when the fp, general, and branch registers get</span>
<span class="cm">	 * saved.  This must come before alloc_spill_area() because</span>
<span class="cm">	 * we need to know which registers are spilled to their home</span>
<span class="cm">	 * locations.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">kind</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">limit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">UNW_REG_F31</span><span class="p">,</span> <span class="n">UNW_REG_R7</span><span class="p">,</span> <span class="n">UNW_REG_B5</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="p">(</span><span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_F2</span><span class="p">;</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R4</span><span class="p">;</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_B1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span><span class="p">;</span> <span class="o">++</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kind</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">spill_next_when</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="p">[</span><span class="n">kind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">limit</span><span class="p">[</span><span class="n">kind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
						<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">t</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Next, lay out the memory stack spill area:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">spill_offset</span><span class="p">;</span>
		<span class="n">alloc_spill_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">off</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_F2</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_F31</span><span class="p">);</span>
		<span class="n">alloc_spill_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">off</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_B1</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_B5</span><span class="p">);</span>
		<span class="n">alloc_spill_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">off</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R4</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R7</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Region header descriptors.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">desc_prologue</span> <span class="p">(</span><span class="kt">int</span> <span class="n">body</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">rlen</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">grsave</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">region_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">in_body</span> <span class="o">||</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">first_region</span><span class="p">))</span>
		<span class="n">finish_prologue</span><span class="p">(</span><span class="n">sr</span><span class="p">);</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">first_region</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check if we&#39;re done: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">when_target</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">region_start</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">epilogue_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">pop</span><span class="p">(</span><span class="n">sr</span><span class="p">);</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">epilogue_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">epilogue_start</span> <span class="o">=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">;</span>

	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">=</span> <span class="n">region_start</span><span class="p">;</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">=</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">in_body</span> <span class="o">=</span> <span class="n">body</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">body</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">push</span><span class="p">(</span><span class="n">sr</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
				<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">unw</span><span class="p">.</span><span class="n">save_order</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">UNW_WHERE_GR</span><span class="p">,</span>
					<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">grsave</span><span class="o">++</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">gr_save_loc</span> <span class="o">=</span> <span class="n">grsave</span><span class="p">;</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">spill_offset</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* default to psp+16 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prologue descriptors.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_abi</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abi</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">context</span> <span class="o">==</span> <span class="sc">&#39;i&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">UNW_FLAG_INTERRUPT_FRAME</span><span class="p">;</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s: interrupt frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind%s: ignoring unwabi(abi=0x%x,context=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">abi</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_br_gr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brmask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_B1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_GR</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">brmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_br_mem</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">brmask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_B1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">brmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_frgr_mem</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">grmask</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">frmask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">grmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">grmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">frmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">UNW_REG_F2</span> <span class="o">:</span> <span class="n">UNW_REG_F16</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_fr_mem</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">frmask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">frmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_F2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">frmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_gr_gr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">grmask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">gr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">grmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_GR</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gr</span><span class="o">++</span><span class="p">);</span>
		<span class="n">grmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_gr_mem</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">grmask</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">grmask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_R4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">UNW_WHERE_SPILL_HOME</span><span class="p">,</span>
				<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">any_spills</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">grmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_mem_stack_f</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">size</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_REG_PSP</span><span class="p">,</span> <span class="n">UNW_WHERE_NONE</span><span class="p">,</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_mem_stack_v</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">when</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_reg_gr</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">UNW_WHERE_GR</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dst</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_reg_psprel</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">pspoff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">UNW_WHERE_PSPREL</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="mh">0x10</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">pspoff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_reg_sprel</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">spoff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_reg</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">reg</span><span class="p">,</span> <span class="n">UNW_WHERE_SPREL</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
		<span class="mi">4</span><span class="o">*</span><span class="n">spoff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_rp_br</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dst</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">return_link_reg</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_reg_when</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">regnum</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">regnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_NONE</span><span class="p">)</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_GR_SAVE</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_spill_base</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">pspoff</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">spill_offset</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">pspoff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">desc_spill_mask</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">imaskp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">imaskp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">imaskp</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Body descriptors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_epilogue</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">ecount</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">epilogue_start</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">epilogue_count</span> <span class="o">=</span> <span class="n">ecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_copy_state</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_labeled_state</span> <span class="o">*</span><span class="n">ls</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ls</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">labeled_states</span><span class="p">;</span> <span class="n">ls</span><span class="p">;</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">==</span> <span class="n">label</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_state_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">));</span>
			<span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">dup_state_stack</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unwind: failed to find state labeled 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_label_state</span> <span class="p">(</span><span class="n">unw_word</span> <span class="n">label</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_labeled_state</span> <span class="o">*</span><span class="n">ls</span><span class="p">;</span>

	<span class="n">ls</span> <span class="o">=</span> <span class="n">alloc_labeled_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unwind.desc_label_state(): out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ls</span><span class="o">-&gt;</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">));</span>
	<span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">dup_state_stack</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/* insert into list of labeled states: */</span>
	<span class="n">ls</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">labeled_states</span><span class="p">;</span>
	<span class="n">sr</span><span class="o">-&gt;</span><span class="n">labeled_states</span> <span class="o">=</span> <span class="n">ls</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * General descriptors.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">desc_is_active</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qp</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">when_target</span> <span class="o">&lt;=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">pr_val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">qp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sr</span><span class="o">-&gt;</span><span class="n">pr_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">qp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_restore_p</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qp</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abreg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_is_active</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">decode_abreg</span><span class="p">(</span><span class="n">abreg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_NONE</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_spill_reg_p</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qp</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abreg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">x</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ytreg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">unw_where</span> <span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_GR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_is_active</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_BR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ytreg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_FR</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">decode_abreg</span><span class="p">(</span><span class="n">abreg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">where</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ytreg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_spill_psprel_p</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qp</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abreg</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">pspoff</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_is_active</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">decode_abreg</span><span class="p">(</span><span class="n">abreg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_PSPREL</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mh">0x10</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">pspoff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">desc_spill_sprel_p</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qp</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">t</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">abreg</span><span class="p">,</span> <span class="n">unw_word</span> <span class="n">spoff</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_is_active</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">decode_abreg</span><span class="p">(</span><span class="n">abreg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_SPREL</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_start</span> <span class="o">+</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">region_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">spoff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define UNW_DEC_BAD_CODE(code)			printk(KERN_ERR &quot;unwind: unknown code 0x%02x\n&quot;, \</span>
<span class="cp">						       code);</span>

<span class="cm">/*</span>
<span class="cm"> * region headers:</span>
<span class="cm"> */</span>
<span class="cp">#define UNW_DEC_PROLOGUE_GR(fmt,r,m,gr,arg)	desc_prologue(0,r,m,gr,arg)</span>
<span class="cp">#define UNW_DEC_PROLOGUE(fmt,b,r,arg)		desc_prologue(b,r,0,32,arg)</span>
<span class="cm">/*</span>
<span class="cm"> * prologue descriptors:</span>
<span class="cm"> */</span>
<span class="cp">#define UNW_DEC_ABI(fmt,a,c,arg)		desc_abi(a,c,arg)</span>
<span class="cp">#define UNW_DEC_BR_GR(fmt,b,g,arg)		desc_br_gr(b,g,arg)</span>
<span class="cp">#define UNW_DEC_BR_MEM(fmt,b,arg)		desc_br_mem(b,arg)</span>
<span class="cp">#define UNW_DEC_FRGR_MEM(fmt,g,f,arg)		desc_frgr_mem(g,f,arg)</span>
<span class="cp">#define UNW_DEC_FR_MEM(fmt,f,arg)		desc_fr_mem(f,arg)</span>
<span class="cp">#define UNW_DEC_GR_GR(fmt,m,g,arg)		desc_gr_gr(m,g,arg)</span>
<span class="cp">#define UNW_DEC_GR_MEM(fmt,m,arg)		desc_gr_mem(m,arg)</span>
<span class="cp">#define UNW_DEC_MEM_STACK_F(fmt,t,s,arg)	desc_mem_stack_f(t,s,arg)</span>
<span class="cp">#define UNW_DEC_MEM_STACK_V(fmt,t,arg)		desc_mem_stack_v(t,arg)</span>
<span class="cp">#define UNW_DEC_REG_GR(fmt,r,d,arg)		desc_reg_gr(r,d,arg)</span>
<span class="cp">#define UNW_DEC_REG_PSPREL(fmt,r,o,arg)		desc_reg_psprel(r,o,arg)</span>
<span class="cp">#define UNW_DEC_REG_SPREL(fmt,r,o,arg)		desc_reg_sprel(r,o,arg)</span>
<span class="cp">#define UNW_DEC_REG_WHEN(fmt,r,t,arg)		desc_reg_when(r,t,arg)</span>
<span class="cp">#define UNW_DEC_PRIUNAT_WHEN_GR(fmt,t,arg)	desc_reg_when(UNW_REG_PRI_UNAT_GR,t,arg)</span>
<span class="cp">#define UNW_DEC_PRIUNAT_WHEN_MEM(fmt,t,arg)	desc_reg_when(UNW_REG_PRI_UNAT_MEM,t,arg)</span>
<span class="cp">#define UNW_DEC_PRIUNAT_GR(fmt,r,arg)		desc_reg_gr(UNW_REG_PRI_UNAT_GR,r,arg)</span>
<span class="cp">#define UNW_DEC_PRIUNAT_PSPREL(fmt,o,arg)	desc_reg_psprel(UNW_REG_PRI_UNAT_MEM,o,arg)</span>
<span class="cp">#define UNW_DEC_PRIUNAT_SPREL(fmt,o,arg)	desc_reg_sprel(UNW_REG_PRI_UNAT_MEM,o,arg)</span>
<span class="cp">#define UNW_DEC_RP_BR(fmt,d,arg)		desc_rp_br(d,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_BASE(fmt,o,arg)		desc_spill_base(o,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_MASK(fmt,m,arg)		(m = desc_spill_mask(m,arg))</span>
<span class="cm">/*</span>
<span class="cm"> * body descriptors:</span>
<span class="cm"> */</span>
<span class="cp">#define UNW_DEC_EPILOGUE(fmt,t,c,arg)		desc_epilogue(t,c,arg)</span>
<span class="cp">#define UNW_DEC_COPY_STATE(fmt,l,arg)		desc_copy_state(l,arg)</span>
<span class="cp">#define UNW_DEC_LABEL_STATE(fmt,l,arg)		desc_label_state(l,arg)</span>
<span class="cm">/*</span>
<span class="cm"> * general unwind descriptors:</span>
<span class="cm"> */</span>
<span class="cp">#define UNW_DEC_SPILL_REG_P(f,p,t,a,x,y,arg)	desc_spill_reg_p(p,t,a,x,y,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_REG(f,t,a,x,y,arg)	desc_spill_reg_p(0,t,a,x,y,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_PSPREL_P(f,p,t,a,o,arg)	desc_spill_psprel_p(p,t,a,o,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_PSPREL(f,t,a,o,arg)	desc_spill_psprel_p(0,t,a,o,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_SPREL_P(f,p,t,a,o,arg)	desc_spill_sprel_p(p,t,a,o,arg)</span>
<span class="cp">#define UNW_DEC_SPILL_SPREL(f,t,a,o,arg)	desc_spill_sprel_p(0,t,a,o,arg)</span>
<span class="cp">#define UNW_DEC_RESTORE_P(f,p,t,a,arg)		desc_restore_p(p,t,a,arg)</span>
<span class="cp">#define UNW_DEC_RESTORE(f,t,a,arg)		desc_restore_p(0,t,a,arg)</span>

<span class="cp">#include &quot;unwind_decoder.c&quot;</span>


<span class="cm">/* Unwind scripts. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">unw_hash_index_t</span>
<span class="nf">hash</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* magic number = ((sqrt(5)-1)/2)*2^64 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hashmagic</span> <span class="o">=</span> <span class="mh">0x9e3779b97f4a7c16UL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">hashmagic</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">UNW_LOG_HASH_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">long</span>
<span class="nf">cache_match</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">==</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">pr</span> <span class="o">^</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">pr_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">pr_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* keep the read lock... */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span>
<span class="nf">script_lookup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hint</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNW_DEBUG_ON</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* Always regenerate scripts in debug mode */</span>

	<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">lookups</span><span class="p">);</span>

	<span class="n">ip</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
	<span class="n">pr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_match</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">hinted_hits</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">script</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">hash</span><span class="p">(</span><span class="n">ip</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">UNW_CACHE_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">script</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cache_match</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* update hint; no locking required as single-word writes are atomic */</span>
			<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">normal_hits</span><span class="p">);</span>
			<span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prev_script</span><span class="p">].</span><span class="n">hint</span> <span class="o">=</span> <span class="n">script</span> <span class="o">-</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">script</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">coll_chain</span> <span class="o">&gt;=</span> <span class="n">UNW_HASH_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">script</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">coll_chain</span><span class="p">;</span>
		<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">collision_chain_traversals</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On returning, a write lock for the SCRIPT is still being held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span>
<span class="nf">script_new</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">unw_hash_index_t</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">head</span><span class="p">;</span>

	<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">news</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t (easily) use cmpxchg() here because of ABA problem</span>
<span class="cm">	 * that is intrinsic in cmpxchg()...</span>
<span class="cm">	 */</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">lru_head</span><span class="p">;</span>
	<span class="n">script</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">lru_head</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">lru_chain</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;d deadlock here if we interrupted a thread that is holding a read lock on</span>
<span class="cm">	 * script-&gt;lock.  Thus, if the write_trylock() fails, we simply bail out.  The</span>
<span class="cm">	 * alternative would be to disable interrupts whenever we hold a read-lock, but</span>
<span class="cm">	 * that seems silly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* re-insert script at the tail of the LRU chain: */</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">lru_tail</span><span class="p">].</span><span class="n">lru_chain</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">lru_tail</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

	<span class="cm">/* remove the old script from the hash table (if it&#39;s there): */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">script</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
					<span class="n">prev</span><span class="o">-&gt;</span><span class="n">coll_chain</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">coll_chain</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">coll_chain</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">prev</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">coll_chain</span> <span class="o">&gt;=</span> <span class="n">UNW_CACHE_SIZE</span><span class="p">)</span>
			<span class="cm">/* old script wasn&#39;t in the hash-table */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">coll_chain</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* enter new script in the hash table */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">hash</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">coll_chain</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">script</span> <span class="o">-</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">;</span>

	<span class="n">script</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>	<span class="cm">/* set new IP while we&#39;re holding the locks */</span>

	<span class="n">STAT</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">coll_chain</span> <span class="o">&lt;</span> <span class="n">UNW_CACHE_SIZE</span><span class="p">)</span> <span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">collisions</span><span class="p">);</span>

	<span class="n">script</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">script</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">script_finalize</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">pr_mask</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">pr_mask</span><span class="p">;</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">pr_val</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">pr_val</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We could down-grade our write-lock on script-&gt;lock here but</span>
<span class="cm">	 * the rwlock API doesn&#39;t offer atomic lock downgrading, so</span>
<span class="cm">	 * we&#39;ll just keep the write-lock and release it later when</span>
<span class="cm">	 * we&#39;re done using the script.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">script_emit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_insn</span> <span class="n">insn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">UNW_MAX_SCRIPT_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: script exceeds maximum size of %u instructions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">UNW_MAX_SCRIPT_LEN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">script</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">[</span><span class="n">script</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">insn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">emit_nat_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">unw_insn_opcode</span> <span class="n">opc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_insn</span> <span class="n">insn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">UNW_WHERE_GR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* register got spilled to a stacked register */</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_SETNAT_TYPE</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">UNW_NAT_REGSTK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* register got spilled to a scratch register */</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_SETNAT_MEMSTK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_FR</span>:
		<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_SETNAT_TYPE</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">UNW_NAT_VAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_BR</span>:
		<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_SETNAT_TYPE</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">UNW_NAT_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_PSPREL</span>:
	      <span class="k">case</span> <span class="n">UNW_WHERE_SPREL</span>:
		<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_SETNAT_MEMSTK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: don&#39;t know how to emit nat info for where = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">opc</span> <span class="o">=</span> <span class="n">opc</span><span class="p">;</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">script_emit</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">compile_reg</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_state_record</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">unw_insn_opcode</span> <span class="n">opc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_insn</span> <span class="n">insn</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">need_nat_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_NONE</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">&gt;=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">when_target</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="n">need_nat_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">UNW_REG_R4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UNW_REG_R7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">)</span> <span class="p">{</span>
	      <span class="k">case</span> <span class="n">UNW_WHERE_GR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE_STACKED</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">rval</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">need_nat_info</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE2</span><span class="p">;</span>
				<span class="n">need_nat_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_R4</span> <span class="o">+</span> <span class="p">(</span><span class="n">rval</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE_CONST</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* register got spilled to a scratch register */</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE_SCRATCH</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">pt_regs_off</span><span class="p">(</span><span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_FR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_F2</span>  <span class="o">+</span> <span class="p">(</span><span class="n">rval</span> <span class="o">-</span>  <span class="mi">2</span><span class="p">)];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_F16</span> <span class="o">+</span> <span class="p">(</span><span class="n">rval</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)];</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE_SCRATCH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">f6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="o">*</span><span class="p">(</span><span class="n">rval</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: kernel may not touch f%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_BR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">rval</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_B1</span> <span class="o">+</span> <span class="p">(</span><span class="n">rval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_MOVE_SCRATCH</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">b0</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">b6</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">b7</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_SPREL</span>:
		<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_ADD_SP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="k">case</span> <span class="n">UNW_WHERE_PSPREL</span>:
		<span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_ADD_PSP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	      <span class="nl">default:</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind%s: register %u has unexpected `where&#39; value of %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">opc</span> <span class="o">=</span> <span class="n">opc</span><span class="p">;</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">insn</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">script_emit</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_nat_info</span><span class="p">)</span>
		<span class="n">emit_nat_info</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">script</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">UNW_REG_PSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * info-&gt;psp must contain the _value_ of the previous</span>
<span class="cm">		 * sp, not it&#39;s save location.  We get this by</span>
<span class="cm">		 * dereferencing the value we just stored in</span>
<span class="cm">		 * info-&gt;psp:</span>
<span class="cm">		 */</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_LOAD</span><span class="p">;</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">insn</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">];</span>
		<span class="n">script_emit</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span>
<span class="nf">lookup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rel_ip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">mid</span><span class="p">;</span>

	<span class="cm">/* do a binary search for right entry: */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">array</span><span class="p">[</span><span class="n">mid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rel_ip</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_offset</span><span class="p">)</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rel_ip</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="p">)</span>
			<span class="n">lo</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rel_ip</span> <span class="o">&lt;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_offset</span> <span class="o">||</span> <span class="n">rel_ip</span> <span class="o">&gt;=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build an unwind script that unwinds from state OLD_STATE to the</span>
<span class="cm"> * entrypoint of the function that called OLD_STATE.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span>
<span class="nf">build_script</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_labeled_state</span> <span class="o">*</span><span class="n">ls</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_state_record</span> <span class="n">sr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_reg_info</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_insn</span> <span class="n">insn</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dp</span><span class="p">,</span> <span class="o">*</span><span class="n">desc_end</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">STAT</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">parse_start</span><span class="p">;)</span>

	<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">builds</span><span class="p">;</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>

	<span class="cm">/* build state record */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_NUM_REGS</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">;</span>
	<span class="n">sr</span><span class="p">.</span><span class="n">pr_val</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>

	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ip 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="n">script</span> <span class="o">=</span> <span class="n">script_new</span><span class="p">(</span><span class="n">ip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">script</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to create unwind script</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">__func__</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">build_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prev_script</span><span class="p">].</span><span class="n">hint</span> <span class="o">=</span> <span class="n">script</span> <span class="o">-</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">;</span>

	<span class="cm">/* search the kernels and the modules&#39; unwind tables for IP: */</span>

	<span class="n">STAT</span><span class="p">(</span><span class="n">parse_start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">table</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="p">;</span> <span class="n">table</span><span class="p">;</span> <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&gt;=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span> <span class="o">&lt;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Leave the kernel unwind table at the very front,</span>
<span class="cm">			 * lest moving it breaks some assumption elsewhere.</span>
<span class="cm">			 * Otherwise, move the matching table to the second</span>
<span class="cm">			 * position in the list so that traversals can benefit</span>
<span class="cm">			 * from commonality in backtrace paths.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* unw is safe - we&#39;re already spinlocked */</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">ip</span> <span class="o">-</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no info, return default unwinder (leaf proc, no mem stack, no saved regs)  */</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s: no unwind info for ip=0x%lx (prev ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">prev_script</span><span class="p">].</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_BR</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">when</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">compile_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="n">UNW_REG_RP</span><span class="p">,</span> <span class="n">script</span><span class="p">);</span>
		<span class="n">script_finalize</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">parse_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">parse_start</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">build_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">script</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sr</span><span class="p">.</span><span class="n">when_target</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">((</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfUL</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_offset</span><span class="p">))</span><span class="o">/</span><span class="mi">16</span>
			  <span class="o">+</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="mh">0xfUL</span><span class="p">));</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">info_offset</span><span class="p">);</span>
	<span class="n">dp</span> <span class="o">=</span>   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>  <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">info_offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">desc_end</span> <span class="o">=</span> <span class="n">dp</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">UNW_LENGTH</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">sr</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">dp</span> <span class="o">&lt;</span> <span class="n">desc_end</span><span class="p">)</span>
		<span class="n">dp</span> <span class="o">=</span> <span class="n">unw_decode</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">in_body</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">when_target</span> <span class="o">&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">epilogue_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * sp has been restored and all values on the memory stack below</span>
<span class="cm">		 * psp also have been restored.</span>
<span class="cm">		 */</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_NONE</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">when</span> <span class="o">=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_NUM_REGS</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_PSPREL</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mh">0x10</span><span class="p">)</span>
			    <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_SPREL</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_NONE</span><span class="p">;</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">script</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If RP did&#39;t get saved, generate entry for the return link</span>
<span class="cm">	 * register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">when</span> <span class="o">&gt;=</span> <span class="n">sr</span><span class="p">.</span><span class="n">when_target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">where</span> <span class="o">=</span> <span class="n">UNW_WHERE_BR</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">when</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">return_link_reg</span><span class="p">;</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s: using default for rp at ip=0x%lx where=%d val=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">where</span><span class="p">,</span>
			   <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">].</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef UNW_DEBUG</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s: state record for func 0x%lx, t=%u:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">sr</span><span class="p">.</span><span class="n">when_target</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span> <span class="o">+</span> <span class="n">UNW_NUM_REGS</span><span class="p">;</span> <span class="o">++</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span> <span class="o">!=</span> <span class="n">UNW_WHERE_NONE</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span> <span class="o">!=</span> <span class="n">UNW_WHEN_NEVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;  %s &lt;- &quot;</span><span class="p">,</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_name</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">]);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">)</span> <span class="p">{</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_GR</span>:     <span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;r%lu&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_FR</span>:     <span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;f%lu&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_BR</span>:     <span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;b%lu&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_SPREL</span>:  <span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;[sp+0x%lx]&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_PSPREL</span>: <span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;[psp+0x%lx]&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			      <span class="k">case</span> <span class="n">UNW_WHERE_NONE</span>:
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s+0x%lx&quot;</span><span class="p">,</span> <span class="n">unw</span><span class="p">.</span><span class="n">preg_name</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">],</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			      <span class="nl">default:</span>
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;BADWHERE(%d)&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">when</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">parse_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">parse_start</span><span class="p">);</span>

	<span class="cm">/* translate state record into unwinder instructions: */</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, set psp if we&#39;re dealing with a fixed-size frame;</span>
<span class="cm">	 * subsequent instructions may depend on this value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">when_target</span> <span class="o">&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">when</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">where</span> <span class="o">==</span> <span class="n">UNW_WHERE_NONE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* new psp is sp plus frame size */</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">opc</span> <span class="o">=</span> <span class="n">UNW_INSN_ADD</span><span class="p">;</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span><span class="p">,</span> <span class="n">psp</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">insn</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PSP</span><span class="p">].</span><span class="n">val</span><span class="p">;</span>	<span class="cm">/* frame size */</span>
		<span class="n">script_emit</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">insn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* determine where the primary UNaT is: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">when_target</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">].</span><span class="n">when</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_PRI_UNAT_MEM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">when_target</span> <span class="o">&lt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PRI_UNAT_MEM</span><span class="p">].</span><span class="n">when</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PRI_UNAT_MEM</span><span class="p">].</span><span class="n">when</span> <span class="o">&gt;</span> <span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">.</span><span class="n">reg</span><span class="p">[</span><span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">].</span><span class="n">when</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_PRI_UNAT_MEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">;</span>

	<span class="n">compile_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">script</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_BSP</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UNW_NUM_REGS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">compile_reg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">script</span><span class="p">);</span>

	<span class="cm">/* free labeled register states &amp; stack: */</span>

	<span class="n">STAT</span><span class="p">(</span><span class="n">parse_start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ls</span> <span class="o">=</span> <span class="n">sr</span><span class="p">.</span><span class="n">labeled_states</span><span class="p">;</span> <span class="n">ls</span><span class="p">;</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ls</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">free_state_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ls</span><span class="o">-&gt;</span><span class="n">saved_state</span><span class="p">);</span>
		<span class="n">free_labeled_state</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_state_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sr</span><span class="p">.</span><span class="n">curr</span><span class="p">);</span>
	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">parse_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">parse_start</span><span class="p">);</span>

	<span class="n">script_finalize</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sr</span><span class="p">);</span>
	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">build_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">script</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Apply the unwinding actions represented by OPS and update SR to</span>
<span class="cm"> * reflect the state that existed upon entry to the function that this</span>
<span class="cm"> * unwinder represents.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">run_script</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">script</span><span class="p">,</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_insn</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="n">next_insn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">opc</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">STAT</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">;)</span>

	<span class="n">STAT</span><span class="p">(</span><span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">runs</span><span class="p">;</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">insn</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">insn</span> <span class="o">+</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">next_insn</span> <span class="o">=</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ip</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opc</span> <span class="o">=</span> <span class="n">next_insn</span><span class="p">.</span><span class="n">opc</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">next_insn</span><span class="p">.</span><span class="n">dst</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">next_insn</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="n">next_insn</span> <span class="o">=</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>

	  <span class="nl">redo:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">opc</span><span class="p">)</span> <span class="p">{</span>
		      <span class="k">case</span> <span class="n">UNW_INSN_ADD</span>:
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_MOVE2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">lazy_init</span><span class="p">;</span>
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_MOVE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">lazy_init</span><span class="p">;</span>
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_MOVE_SCRATCH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">get_scratch_regs</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">+</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: no state-&gt;pt, dst=%ld, val=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_MOVE_CONST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">r0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: UNW_INSN_MOVE_CONST bad val=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>


		      <span class="k">case</span> <span class="n">UNW_INSN_MOVE_STACKED</span>:
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ia64_rse_skip_regs</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">,</span>
								    <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_ADD_PSP</span>:
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">psp</span> <span class="o">+</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_ADD_SP</span>:
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">+</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_SETNAT_MEMSTK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">caller_unat</span><span class="p">;</span>
			<span class="cm">/* register off. is a multiple of 8, so the least 3 bits (type) are 0 */</span>
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span> <span class="o">-</span> <span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">])</span> <span class="o">|</span> <span class="n">UNW_NAT_MEMSTK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_SETNAT_TYPE</span>:
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		      <span class="k">case</span> <span class="n">UNW_INSN_LOAD</span>:
<span class="cp">#ifdef UNW_DEBUG</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">local_cpu_data</span><span class="o">-&gt;</span><span class="n">unimpl_va_mask</span> <span class="o">|</span> <span class="mh">0x7</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
			    <span class="o">||</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">TASK_SIZE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: rejecting bad psp=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">s</span><span class="p">[</span><span class="n">dst</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">script</span><span class="p">.</span><span class="n">run_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

  <span class="nl">lazy_init:</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
	<span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sw</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span><span class="p">,</span> <span class="n">r4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">&lt;=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span><span class="p">,</span> <span class="n">r7</span><span class="p">))</span>
		<span class="cm">/*</span>
<span class="cm">		 * We&#39;re initializing a general register: init NaT info, too.  Note that</span>
<span class="cm">		 * the offset is a multiple of 8 which gives us the 3 bits needed for</span>
<span class="cm">		 * the type field.</span>
<span class="cm">		 */</span>
		<span class="n">s</span><span class="p">[</span><span class="n">val</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span><span class="p">,</span> <span class="n">ar_unat</span><span class="p">)</span> <span class="o">-</span> <span class="n">off</span><span class="p">)</span> <span class="o">|</span> <span class="n">UNW_NAT_MEMSTK</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_save_locs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">have_write_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">scr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">local_cpu_data</span><span class="o">-&gt;</span><span class="n">unimpl_va_mask</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">TASK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t let obviously bad addresses pollute the cache */</span>
		<span class="cm">/* FIXME: should really be level 0 but it occurs too often. KAO */</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s: rejecting bad ip=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rp_loc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scr</span> <span class="o">=</span> <span class="n">script_lookup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">scr</span> <span class="o">=</span> <span class="n">build_script</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
				   <span class="s">&quot;unwind.%s: failed to locate/build unwind script for ip %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">have_write_lock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">hint</span> <span class="o">=</span> <span class="n">scr</span><span class="o">-&gt;</span><span class="n">hint</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">prev_script</span> <span class="o">=</span> <span class="n">scr</span> <span class="o">-</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">;</span>

	<span class="n">run_script</span><span class="p">(</span><span class="n">scr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_write_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">unw_valid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">loc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">||</span>
	       <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="n">loc</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">unw_unwind</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prev_ip</span><span class="p">,</span> <span class="n">prev_sp</span><span class="p">,</span> <span class="n">prev_bsp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="n">num_regs</span><span class="p">;</span>
	<span class="n">STAT</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">flags</span><span class="p">;)</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">STAT</span><span class="p">(</span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwinds</span><span class="p">;</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>

	<span class="n">prev_ip</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">;</span>
	<span class="n">prev_sp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">;</span>
	<span class="n">prev_bsp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">;</span>

	<span class="cm">/* validate the return IP pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unw_valid</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rp_loc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: should really be level 0 but it occurs too often. KAO */</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to locate return link (ip=0x%lx)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* restore the ip */</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rp_loc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">GATE_ADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;unwind.%s: reached user-space (ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* validate the previous stack frame pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unw_valid</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pfs_loc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to locate ar.pfs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* restore the cfm: */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pfs_loc</span><span class="p">;</span>

	<span class="cm">/* restore the bsp: */</span>
	<span class="n">pr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>
	<span class="n">num_regs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UNW_FLAG_INTERRUPT_FRAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_NON_SYSCALL</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">num_regs</span> <span class="o">=</span> <span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>		<span class="cm">/* size of frame */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pfs_loc</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt_regs</span><span class="p">,</span> <span class="n">ar_pfs</span><span class="p">));</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s: interrupt_frame pt 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">num_regs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* size of locals */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ia64_rse_skip_regs</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">,</span> <span class="o">-</span><span class="n">num_regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: bsp (0x%lx) out of range [0x%lx-0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* restore the sp: */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">psp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">top</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: sp (0x%lx) out of range [0x%lx-0x%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">==</span> <span class="n">prev_ip</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">==</span> <span class="n">prev_sp</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span> <span class="o">==</span> <span class="n">prev_bsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ip, sp, bsp unchanged; stopping here (ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
		<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* as we unwind, the saved ar.unat becomes the primary unat: */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pri_unat_loc</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">unat_loc</span><span class="p">;</span>

	<span class="cm">/* finally, restore the predicates: */</span>
	<span class="n">unw_get_pr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">find_save_locs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">unwind_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_unwind</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">unw_unwind_to_user</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">unw_get_sp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">long</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">+</span> <span class="n">IA64_STK_OFFSET</span> <span class="o">-</span> <span class="n">sp</span><span class="p">)</span>
		    <span class="o">&lt;</span> <span class="n">IA64_PT_REGS_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ran off the top of the kernel stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_is_intr_frame</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">PRED_USER_STACK</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw_get_pr</span> <span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unw_get_rp</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to read &quot;</span>
				   <span class="s">&quot;predicate register (ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unw_unwind</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">unw_get_ip</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to unwind to user-level (ip=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_unwind_to_user</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_frame_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stktop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rbslimit</span><span class="p">,</span> <span class="n">rbstop</span><span class="p">,</span> <span class="n">stklimit</span><span class="p">;</span>
	<span class="n">STAT</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">flags</span><span class="p">;)</span>

	<span class="n">STAT</span><span class="p">(</span><span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span> <span class="o">++</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">inits</span><span class="p">;</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ia64_get_itc</span><span class="p">());</span>

	<span class="cm">/*</span>
<span class="cm">	 * Subtle stuff here: we _could_ unwind through the switch_stack frame but we</span>
<span class="cm">	 * don&#39;t want to do that because it would be slow as each preserved register would</span>
<span class="cm">	 * have to be processed.  Instead, what we do here is zero out the frame info and</span>
<span class="cm">	 * start the unwind process at the function that created the switch_stack frame.</span>
<span class="cm">	 * When a preserved value in switch_stack needs to be accessed, run_script() will</span>
<span class="cm">	 * initialize the appropriate pointer on demand.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>

	<span class="n">rbslimit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="n">IA64_RBS_OFFSET</span><span class="p">;</span>
	<span class="n">stklimit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">t</span> <span class="o">+</span> <span class="n">IA64_STK_OFFSET</span><span class="p">;</span>

	<span class="n">rbstop</span>   <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_bspstore</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rbstop</span> <span class="o">&gt;</span> <span class="n">stklimit</span> <span class="o">||</span> <span class="n">rbstop</span> <span class="o">&lt;</span> <span class="n">rbslimit</span><span class="p">)</span>
		<span class="n">rbstop</span> <span class="o">=</span> <span class="n">rbslimit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stktop</span> <span class="o">&lt;=</span> <span class="n">rbstop</span><span class="p">)</span>
		<span class="n">stktop</span> <span class="o">=</span> <span class="n">rbstop</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stktop</span> <span class="o">&gt;</span> <span class="n">stklimit</span><span class="p">)</span>
		<span class="n">stktop</span> <span class="o">=</span> <span class="n">stklimit</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">rbslimit</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span>   <span class="o">=</span> <span class="n">rbstop</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">stklimit</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">memstk</span><span class="p">.</span><span class="n">top</span>   <span class="o">=</span> <span class="n">stktop</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">task</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span>  <span class="o">=</span> <span class="n">sw</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">psp</span> <span class="o">=</span> <span class="n">stktop</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">;</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s:</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  task   0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  rbs = [0x%lx-0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  stk = [0x%lx-0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  pr     0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  sw     0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  sp     0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">t</span><span class="p">,</span> <span class="n">rbslimit</span><span class="p">,</span> <span class="n">rbstop</span><span class="p">,</span> <span class="n">stktop</span><span class="p">,</span> <span class="n">stklimit</span><span class="p">,</span>
		   <span class="n">info</span><span class="o">-&gt;</span><span class="n">pr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sw</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">STAT</span><span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">stat</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">init_time</span> <span class="o">+=</span> <span class="n">ia64_get_itc</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">unw_init_frame_info</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sol</span><span class="p">;</span>

	<span class="n">init_frame_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">sw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sw</span><span class="o">-&gt;</span><span class="n">ar_pfs</span><span class="p">;</span>
	<span class="n">sol</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cfm_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">ia64_rse_skip_regs</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">regstk</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="o">-</span><span class="n">sol</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="n">sw</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">;</span>
	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;unwind.%s:</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  bsp    0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  sol    0x%lx</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;  ip     0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bsp</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
	<span class="n">find_save_locs</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_init_frame_info</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">unw_init_from_blocked_task</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_frame_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="n">sw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">switch_stack</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">ksp</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unwind.%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">unw_init_frame_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">sw</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unw_init_from_blocked_task</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_unwind_table</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">segment_base</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">table_start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">table_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">table_start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">table_end</span><span class="p">;</span>

	<span class="n">table</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">segment_base</span> <span class="o">=</span> <span class="n">segment_base</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">gp</span> <span class="o">=</span> <span class="n">gp</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">segment_base</span> <span class="o">+</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start_offset</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">segment_base</span> <span class="o">+</span> <span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">end_offset</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">array</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">table</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span>
<span class="nf">unw_add_unwind_table</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">segment_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gp</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">table_start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">table_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">table_start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">table_end</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to insert empty unwind table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">),</span> <span class="n">GFP_USER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_unwind_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">segment_base</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">table_start</span><span class="p">,</span> <span class="n">table_end</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="cm">/* keep kernel unwind table at the front (it&#39;s searched most commonly): */</span>
		<span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">unw_remove_unwind_table</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">unw_script</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: ignoring attempt to remove non-existent unwind table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">kernel_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: sorry, freeing the kernel&#39;s unwind table is a &quot;</span>
			   <span class="s">&quot;no-can-do!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="cm">/* first, delete the table: */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_table</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">tables</span><span class="p">;</span> <span class="n">prev</span><span class="p">;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">table</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">UNW_DPRINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;unwind.%s: failed to find unwind table %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">table</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* next, remove hash table entries for this table */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">UNW_HASH_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">cache</span> <span class="o">+</span> <span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">UNW_CACHE_SIZE</span>
		    <span class="o">||</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">||</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&gt;=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">write_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&gt;=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">&lt;</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">unw</span><span class="p">.</span><span class="n">hash</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">coll_chain</span><span class="p">;</span>
				<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">write_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">create_gate_table</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="n">segbase</span> <span class="o">=</span> <span class="n">GATE_ADDR</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">info_size</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">Elf64_Phdr</span> <span class="o">*</span><span class="n">punw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">phdr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Elf64_Phdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">GATE_ADDR</span> <span class="o">+</span> <span class="n">GATE_EHDR</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">GATE_EHDR</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">phdr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phdr</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">PT_IA_64_UNWIND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">punw</span> <span class="o">=</span> <span class="n">phdr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">punw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: failed to find gate DSO&#39;s unwind table!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">punw</span><span class="o">-&gt;</span><span class="n">p_vaddr</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">unw_table_entry</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span> <span class="o">+</span> <span class="n">punw</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">);</span>
	<span class="n">size</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">unw_add_unwind_table</span><span class="p">(</span><span class="s">&quot;linux-gate.so&quot;</span><span class="p">,</span> <span class="n">segbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">entry</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">UNW_LENGTH</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">segbase</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">info_offset</span><span class="p">));</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* reserve space for &quot;end of table&quot; marker */</span>

	<span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">gate_table_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to create unwind data for gate page!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">gate_table_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="o">++</span><span class="n">entry</span><span class="p">,</span> <span class="n">lp</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info_size</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">UNW_LENGTH</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">segbase</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">info_offset</span><span class="p">));</span>
		<span class="n">info</span> <span class="o">-=</span> <span class="n">info_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">segbase</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">info_offset</span><span class="p">,</span> <span class="n">info_size</span><span class="p">);</span>

		<span class="n">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">segbase</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">start_offset</span><span class="p">;</span>		<span class="cm">/* start */</span>
		<span class="n">lp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">segbase</span> <span class="o">+</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">end_offset</span><span class="p">;</span>		<span class="cm">/* end */</span>
		<span class="n">lp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span><span class="p">;</span>		<span class="cm">/* info */</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* end-of-table marker */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__initcall</span><span class="p">(</span><span class="n">create_gate_table</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">__init</span>
<span class="nf">unw_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">char</span> <span class="n">__gp</span><span class="p">[];</span>
	<span class="k">extern</span> <span class="kt">void</span> <span class="n">unw_hash_index_t_is_too_narrow</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">i</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">unw_hash_index_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">UNW_LOG_HASH_SIZE</span><span class="p">)</span>
		<span class="n">unw_hash_index_t_is_too_narrow</span><span class="p">();</span>

	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_PRI_UNAT_GR</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">CALLER_UNAT</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_BSPSTORE</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">AR_BSPSTORE</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_PFS</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">AR_PFS</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_RP</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">B0</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_UNAT</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">CALLER_UNAT</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_PR</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">PR</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_LC</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">AR_LC</span><span class="p">);</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">UNW_REG_FPSR</span><span class="p">]]</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">AR_FPSR</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_R4</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">R4</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UNW_REG_R7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">off</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_B1</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">B1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UNW_REG_B5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">off</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_F2</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">F2</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UNW_REG_F5</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">off</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">UNW_REG_F16</span><span class="p">,</span> <span class="n">off</span> <span class="o">=</span> <span class="n">SW</span><span class="p">(</span><span class="n">F16</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">UNW_REG_F31</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="n">off</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">sw_off</span><span class="p">[</span><span class="n">unw</span><span class="p">.</span><span class="n">preg_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">UNW_CACHE_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lru_chain</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">coll_chain</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">cache</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">lru_head</span> <span class="o">=</span> <span class="n">UNW_CACHE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">unw</span><span class="p">.</span><span class="n">lru_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">init_unwind_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unw</span><span class="p">.</span><span class="n">kernel_table</span><span class="p">,</span> <span class="s">&quot;kernel&quot;</span><span class="p">,</span> <span class="n">KERNEL_START</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">__gp</span><span class="p">,</span>
			  <span class="n">__start_unwind</span><span class="p">,</span> <span class="n">__end_unwind</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED</span>
<span class="cm"> *</span>
<span class="cm"> *	This system call has been deprecated.  The new and improved way to get</span>
<span class="cm"> *	at the kernel&#39;s unwind info is via the gate DSO.  The address of the</span>
<span class="cm"> *	ELF header for this DSO is passed to user-level via AT_SYSINFO_EHDR.</span>
<span class="cm"> *</span>
<span class="cm"> * DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED DEPRECATED</span>
<span class="cm"> *</span>
<span class="cm"> * This system call copies the unwind data into the buffer pointed to by BUF and returns</span>
<span class="cm"> * the size of the unwind data.  If BUF_SIZE is smaller than the size of the unwind data</span>
<span class="cm"> * or if BUF is NULL, nothing is copied, but the system call still returns the size of the</span>
<span class="cm"> * unwind data.</span>
<span class="cm"> *</span>
<span class="cm"> * The first portion of the unwind data contains an unwind table and rest contains the</span>
<span class="cm"> * associated unwind info (in no particular order).  The unwind table consists of a table</span>
<span class="cm"> * of entries of the form:</span>
<span class="cm"> *</span>
<span class="cm"> *	u64 start;	(64-bit address of start of function)</span>
<span class="cm"> *	u64 end;	(64-bit address of start of function)</span>
<span class="cm"> *	u64 info;	(BUF-relative offset to unwind info)</span>
<span class="cm"> *</span>
<span class="cm"> * The end of the unwind table is indicated by an entry with a START address of zero.</span>
<span class="cm"> *</span>
<span class="cm"> * Please see the IA-64 Software Conventions and Runtime Architecture manual for details</span>
<span class="cm"> * on the format of the unwind info.</span>
<span class="cm"> *</span>
<span class="cm"> * ERRORS</span>
<span class="cm"> *	EFAULT	BUF points outside your accessible address space.</span>
<span class="cm"> */</span>
<span class="n">asmlinkage</span> <span class="kt">long</span>
<span class="nf">sys_getunwind</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_size</span> <span class="o">&gt;=</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table_size</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table</span><span class="p">,</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table_size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">unw</span><span class="p">.</span><span class="n">gate_table_size</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
